<!DOCTYPE html>
<html>
<head>
    <title>密钥验证测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>密钥验证测试</h1>
    <p>测试密钥: <strong>1z9nt2czlsossgemphk1ca</strong></p>
    <button onclick="testKey()">开始测试</button>
    <div id="results"></div>

    <script>
        // 确定性校验和函数（与TWPK.html保持一致）
        function generateEnhancedChecksum(input) {
            let hash1 = 0;
            let hash2 = 0;
            
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash1 = ((hash1 << 5) - hash1) + char;
                hash1 = hash1 & hash1;
                hash2 = ((hash2 << 3) + hash2) ^ char;
                hash2 = hash2 & hash2;
            }
            
            const combinedHash = Math.abs(hash1) + Math.abs(hash2);
            let checksum = combinedHash.toString(36).substring(0, 6);
            
            if (checksum.length < 6) {
                const padding = '0123456789abcdefghijklmnopqrstuvwxyz';
                for (let i = checksum.length; i < 6; i++) {
                    checksum += padding[(combinedHash + i) % padding.length];
                }
            }
            
            return checksum.substring(0, 6);
        }

        function generateChecksum(data) {
            return generateEnhancedChecksum(data);
        }

        function testKey() {
            const key = '1z9nt2czlsossgemphk1ca';
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            function addResult(message, type = 'info') {
                const div = document.createElement('div');
                div.className = `result ${type}`;
                div.innerHTML = message;
                results.appendChild(div);
            }
            
            addResult(`开始测试密钥: ${key}`);
            addResult(`密钥长度: ${key.length}`);
            
            if (key.length !== 22) {
                addResult('❌ 密钥长度不正确，应为22位', 'error');
                return;
            }
            
            // 解析密钥各部分
            const identifier = key.slice(0, 4);
            const timestamp = key.slice(4, 10);
            const randomPart = key.slice(10, 16);
            const checksum = key.slice(16, 22);
            
            addResult(`标识符: ${identifier}`);
            addResult(`时间戳: ${timestamp}`);
            addResult(`随机部分: ${randomPart}`);
            addResult(`原始校验和: ${checksum}`);
            
            // 重新计算校验和
            const dataForChecksum = identifier + timestamp + randomPart;
            const calculatedChecksum = generateChecksum(dataForChecksum);
            
            addResult(`计算数据: ${dataForChecksum}`);
            addResult(`计算校验和: ${calculatedChecksum}`);
            
            if (checksum === calculatedChecksum) {
                addResult('✅ 校验和匹配！密钥格式正确', 'success');
            } else {
                addResult('❌ 校验和不匹配！密钥验证失败', 'error');
            }
            
            // 时间戳验证
            try {
                const timestampValue = parseInt(timestamp, 36);
                const currentTime = Math.floor(Date.now() / 1000);
                const timeDiff = Math.abs(currentTime - timestampValue);
                
                addResult(`时间戳数值: ${timestampValue}`);
                addResult(`当前时间: ${currentTime}`);
                addResult(`时间差: ${timeDiff} 秒`);
                
                if (currentTime > timestampValue) {
                    addResult('❌ 密钥已过期', 'error');
                } else {
                    addResult('✅ 密钥未过期', 'success');
                }
            } catch (e) {
                addResult(`时间戳解析错误: ${e.message}`, 'error');
            }
        }
    </script>