<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway API 连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Railway API 连接测试</h1>
        <p>测试 TWPK 网页与 Railway 云服务的连接状态</p>
        
        <div class="test-section">
            <h3>API 基础信息</h3>
            <p><strong>API 基础URL:</strong> <span id="apiBase">https://twpk.up.railway.app</span></p>
            <p><strong>测试时间:</strong> <span id="testTime"></span></p>
        </div>

        <div class="test-section">
            <h3>连接测试</h3>
            <button onclick="testHealth()">测试健康检查 (/api/health)</button>
            <button onclick="testTaiwanData()">测试台湾PK10数据 (/api/taiwan-pk10-data)</button>
            <button onclick="testTodayData()">测试今日数据 (/api/today-data)</button>
            <button onclick="testAllEndpoints()">测试所有端点</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://twpk.up.railway.app';
        
        document.getElementById('apiBase').textContent = API_BASE;
        document.getElementById('testTime').textContent = new Date().toLocaleString();

        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `
                <h4>${title}</h4>
                <pre>${content}</pre>
                <small>测试时间: ${new Date().toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testEndpoint(endpoint, description) {
            const url = `${API_BASE}${endpoint}`;
            const startTime = Date.now();
            
            try {
                console.log(`开始测试: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                let result = `URL: ${url}\n`;
                result += `状态码: ${response.status} ${response.statusText}\n`;
                result += `响应时间: ${duration}ms\n`;
                result += `Content-Type: ${response.headers.get('content-type')}\n`;
                result += `\n响应头信息:\n`;
                
                for (let [key, value] of response.headers.entries()) {
                    result += `  ${key}: ${value}\n`;
                }
                
                if (response.ok) {
                    try {
                        const text = await response.text();
                        result += `\n响应体长度: ${text.length} 字符\n`;
                        
                        if (text.trim()) {
                            try {
                                const data = JSON.parse(text);
                                result += `\n响应数据 (JSON):\n${JSON.stringify(data, null, 2)}`;
                                
                                if (Array.isArray(data)) {
                                    result += `\n\n数组长度: ${data.length}`;
                                    if (data.length > 0) {
                                        result += `\n第一项: ${JSON.stringify(data[0], null, 2)}`;
                                    }
                                }
                            } catch (jsonError) {
                                result += `\n响应数据 (文本):\n${text.substring(0, 500)}${text.length > 500 ? '...' : ''}`;
                            }
                        } else {
                            result += `\n⚠️ 响应体为空`;
                        }
                        
                        addResult(`✅ ${description}`, result, 'success');
                    } catch (textError) {
                        result += `\n❌ 读取响应体失败: ${textError.message}`;
                        addResult(`⚠️ ${description}`, result, 'error');
                    }
                } else {
                    result += `\n❌ HTTP错误: ${response.status} ${response.statusText}`;
                    addResult(`❌ ${description}`, result, 'error');
                }
                
            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                let result = `URL: ${url}\n`;
                result += `错误类型: ${error.name}\n`;
                result += `错误信息: ${error.message}\n`;
                result += `请求时间: ${duration}ms\n`;
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    result += `\n可能的原因:\n- 网络连接问题\n- CORS 策略限制\n- 服务器不可达`;
                }
                
                addResult(`❌ ${description}`, result, 'error');
            }
        }

        async function testHealth() {
            await testEndpoint('/api/health', '健康检查');
        }

        async function testTaiwanData() {
            await testEndpoint('/api/taiwan-pk10-data', '台湾PK10数据');
        }

        async function testTodayData() {
            await testEndpoint('/api/today-data', '今日数据');
        }

        async function testAllEndpoints() {
            document.getElementById('results').innerHTML = '';
            addResult('🚀 开始全面测试', '正在测试所有API端点...', 'info');
            
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1秒延迟
            
            await testTaiwanData();
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1秒延迟
            
            await testTodayData();
            
            addResult('✅ 测试完成', '所有API端点测试已完成', 'success');
        }

        // 页面加载时自动运行一次基础测试
        window.addEventListener('load', function() {
            setTimeout(() => {
                addResult('🔄 自动测试', '页面加载完成，开始自动测试...', 'info');
                testHealth();
            }, 1000);
        });
    </script>
</body>
</html>