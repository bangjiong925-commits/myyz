# 自动抓取调度系统说明

## 概述

自动抓取系统已配置为在每天的 **7:05 到 23:59** 时间范围内运行，每隔 **30-60秒** 随机间隔自动抓取一次数据。

## 主要功能

### 1. 时间控制
- **运行时间**: 每天 7:05 - 23:59
- **休息时间**: 每天 0:00 - 7:04（系统自动休眠）
- **跨日处理**: 超出运行时间的任务会自动安排到第二天7:05执行

### 2. 随机间隔抓取
- **间隔范围**: 30-60秒随机
- **目的**: 避免固定间隔被网站检测，提高抓取成功率
- **动态调整**: 每次执行后重新生成随机间隔

### 3. 智能调度模式
- **传统模式**: 固定随机间隔（30-60秒）
- **智能模式**: 基于开奖时间后140秒智能调度
- **时间限制**: 两种模式都遵循7:05-23:59的时间限制

## 使用方法

### 启动传统模式（推荐）
```bash
python3 auto_scraper.py --mode traditional
```

### 启动智能模式
```bash
python3 auto_scraper.py --mode smart
```

### 单次执行
```bash
python3 auto_scraper.py --mode single
```

## 日志信息

系统会显示以下关键信息：
- 当前运行模式和调度策略
- 时间范围检查结果
- 随机间隔设置
- 抓取成功/失败状态
- 下次执行时间安排

### 示例日志
```
[2025-09-03 19:38:56] 定时任务已设置: 每59秒执行一次（传统模式，运行时间：7:05-23:59）
[2025-09-03 19:38:56] 成功抓取今日完整数据，共 150 条记录
[2025-09-03 19:38:56] 获取到新数据 - 期号: 114049886, 开奖时间: 19:35
```

## 配置参数

### 时间设置
- `start_time`: 7:05（每日开始时间）
- `end_time`: 23:59（每日结束时间）

### 间隔设置
- `min_interval`: 30秒（最小间隔）
- `max_interval`: 60秒（最大间隔）

## 系统行为

### 在运行时间内
1. 正常执行抓取任务
2. 使用随机间隔安排下次抓取
3. 记录详细日志信息

### 在运行时间外
1. 跳过抓取任务执行
2. 显示时间范围提示
3. 自动安排到下一个运行时间段

### 启动时行为
- **在运行时间内**: 立即执行初始抓取
- **在运行时间外**: 等待到7:05开始执行

## 测试功能

可以使用测试脚本验证时间控制功能：
```bash
python3 test_time_control.py
```

测试内容包括：
- 当前时间检查
- 随机间隔生成
- 不同时间点的范围判断

## 注意事项

1. **系统时间**: 确保服务器时间准确
2. **网络连接**: 保持稳定的网络连接
3. **数据库连接**: 确保MongoDB服务正常运行
4. **日志监控**: 定期检查日志文件了解运行状态
5. **资源使用**: 随机间隔有助于减少服务器负载

## 故障排除

### 常见问题

1. **时间检查失败**
   - 检查系统时间是否正确
   - 确认时区设置

2. **抓取失败**
   - 检查网络连接
   - 查看详细错误日志
   - 确认目标网站可访问性

3. **调度异常**
   - 重启auto_scraper服务
   - 检查Python环境和依赖

### 日志位置
- 主日志: `logs/auto_scraper_YYYY-MM-DD.log`
- 抓取日志: `logs/scraper_YYYY-MM-DD_HH-MM-SS_*.log`

## 版本历史

- **v2.0**: 添加时间控制功能（7:05-23:59）
- **v2.1**: 添加随机间隔功能（30-60秒）
- **v2.2**: 优化跨日处理和智能调度