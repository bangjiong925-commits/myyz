# âœ… Vercelåœ¨çº¿çŠ¶æ€æ˜¾ç¤ºé—®é¢˜ - è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

**ç°è±¡**ï¼š
- âœ… é˜¿é‡Œäº‘æµ‹è¯•å¯ä»¥æ˜¾ç¤ºåœ¨çº¿
- âŒ Vercelæµ‹è¯•ä¸æ˜¾ç¤ºåœ¨çº¿

## ğŸ¯ é—®é¢˜æ ¹æº

### æ¶æ„åˆ†æ

```
é˜¿é‡Œäº‘ç¯å¢ƒï¼š
ç”¨æˆ· â†’ å¿ƒè·³API â†’ MongoDB â†’ å¯†é’¥åˆ—è¡¨API â†’ æ˜¾ç¤ºåœ¨çº¿ âœ…

Vercelç¯å¢ƒï¼ˆä¿®å¤å‰ï¼‰ï¼š
ç”¨æˆ· â†’ å¿ƒè·³APIä»£ç† â†’ é˜¿é‡Œäº‘MongoDB âœ…
     â†“
å¯†é’¥ç®¡ç†ç³»ç»Ÿ â†’ /api/keys â†’ 404é”™è¯¯ âŒ
```

### é—®é¢˜åŸå› 

1. **å¿ƒè·³æ•°æ®ä¿å­˜æˆåŠŸ**
   - `TWPK.html` é€šè¿‡ `/api/keys/heartbeat` å‘é€å¿ƒè·³
   - Vercel å°†è¯·æ±‚ä»£ç†åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
   - æ•°æ®æˆåŠŸä¿å­˜åˆ° MongoDB çš„ `lastHeartbeat` å­—æ®µ

2. **åœ¨çº¿çŠ¶æ€æŸ¥è¯¢å¤±è´¥**
   - å¯†é’¥ç®¡ç†ç³»ç»Ÿéœ€è¦è°ƒç”¨ `/api/keys` è·å–å¯†é’¥åˆ—è¡¨
   - ä½† Vercel ä¸Šåªæœ‰ `heartbeat.js`ï¼Œæ²¡æœ‰ `keys.js`
   - æŸ¥è¯¢è¿”å› 404 é”™è¯¯
   - æ— æ³•è·å– `lastHeartbeat` æ•°æ®
   - åœ¨çº¿æ•°é‡æ˜¾ç¤ºä¸º 0

## âœ¨ è§£å†³æ–¹æ¡ˆ

### åˆ›å»ºå®Œæ•´çš„APIä»£ç†å±‚

åœ¨ Vercel ä¸Šåˆ›å»ºä»¥ä¸‹APIä»£ç†æ–‡ä»¶ï¼š

```
api/
â”œâ”€â”€ keys.js                    â† æ–°å¢ï¼šå¯†é’¥åˆ—è¡¨API
â”œâ”€â”€ stats.js                   â† æ–°å¢ï¼šç»Ÿè®¡API
â””â”€â”€ keys/
    â”œâ”€â”€ heartbeat.js          â† å·²æœ‰ï¼šå¿ƒè·³API
    â”œâ”€â”€ validate-key.js       â† æ–°å¢ï¼šéªŒè¯API
    â””â”€â”€ check-usage.js        â† æ–°å¢ï¼šæ£€æŸ¥ä½¿ç”¨API
```

### å·¥ä½œåŸç†

```
ä¿®å¤åçš„ Vercel ç¯å¢ƒï¼š

ç”¨æˆ· â†’ /api/keys/heartbeat â†’ é˜¿é‡Œäº‘ â†’ MongoDB (ä¿å­˜lastHeartbeat) âœ…
                                â†“
å¯†é’¥ç®¡ç†ç³»ç»Ÿ â†’ /api/keys â†’ Vercelä»£ç† â†’ é˜¿é‡Œäº‘ â†’ è¿”å›æ•°æ® âœ…
                                â†“
            å‰ç«¯è®¡ç®—åœ¨çº¿çŠ¶æ€ (lastHeartbeat < 90ç§’) âœ…
                                â†“
                  æ˜¾ç¤ºåœ¨çº¿æ•°é‡å’Œåˆ—è¡¨ âœ…
```

## ğŸ“¦ å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. APIä»£ç†æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | ç”¨é€” |
|------|------|------|
| `api/keys.js` | å¯†é’¥åˆ—è¡¨API | è·å–æ‰€æœ‰å¯†é’¥ï¼ˆåŒ…å«lastHeartbeatï¼‰ |
| `api/stats.js` | ç»Ÿè®¡API | è·å–å¯†é’¥ç»Ÿè®¡æ•°æ® |
| `api/keys/validate-key.js` | éªŒè¯API | éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§ |
| `api/keys/check-usage.js` | ä½¿ç”¨æ£€æŸ¥API | æ£€æŸ¥å¯†é’¥æ˜¯å¦è¢«ä½¿ç”¨ |
| `api/keys/heartbeat.js` | å¿ƒè·³API | æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆå·²å­˜åœ¨ï¼‰|

### 2. é…ç½®æ–‡ä»¶

- `vercel.json` - ä¼˜åŒ–çš„Vercelé…ç½®
  - æ›´æ–°CORSå¤´
  - è®¾ç½®å‡½æ•°è¶…æ—¶æ—¶é—´
  - ç®€åŒ–è·¯ç”±è§„åˆ™

### 3. æµ‹è¯•å’Œæ–‡æ¡£

- `test-vercel-heartbeat.html` - ä¸“ç”¨æµ‹è¯•é¡µé¢
  - ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹
  - å¿ƒè·³å‘é€æµ‹è¯•
  - åœ¨çº¿çŠ¶æ€æŸ¥è¯¢
  - å®æ—¶æ—¥å¿—æ˜¾ç¤º

- `VERCEL_DEPLOY.md` - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
  - é—®é¢˜è¯´æ˜
  - éƒ¨ç½²æ­¥éª¤
  - æµ‹è¯•æ–¹æ³•
  - æ•…éšœæ’æŸ¥

- `deploy-vercel-fix.sh` - ä¸€é”®éƒ¨ç½²è„šæœ¬
  - è‡ªåŠ¨æ·»åŠ æ–‡ä»¶
  - åˆ›å»ºæäº¤
  - æ¨é€åˆ°Git

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•1ï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /Users/a1234/Documents/GitHub/myyz
./deploy-vercel-fix.sh
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. æ·»åŠ æ–‡ä»¶
git add api/ vercel.json test-vercel-heartbeat.html VERCEL_DEPLOY.md

# 2. æäº¤
git commit -m "ä¿®å¤Vercelå¿ƒè·³åŠŸèƒ½"

# 3. æ¨é€
git push origin main

# 4. ç­‰å¾…Vercelè‡ªåŠ¨éƒ¨ç½²ï¼ˆ1-2åˆ†é’Ÿï¼‰
```

## âœ… éªŒè¯æµ‹è¯•

### æµ‹è¯•1ï¼šä½¿ç”¨ä¸“ç”¨æµ‹è¯•é¡µé¢

1. è®¿é—®ï¼š`https://your-app.vercel.app/test-vercel-heartbeat.html`
2. è¾“å…¥æµ‹è¯•å¯†é’¥
3. ç‚¹å‡»"å¯åŠ¨å¿ƒè·³"
4. è§‚å¯Ÿæ—¥å¿—å’ŒçŠ¶æ€

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¿ƒè·³å‘é€æˆåŠŸ
- âœ… å‘é€æ¬¡æ•°å¢åŠ 
- âœ… çŠ¶æ€æ˜¾ç¤º"åœ¨çº¿"

### æµ‹è¯•2ï¼šæŸ¥è¯¢åœ¨çº¿çŠ¶æ€

åœ¨æµ‹è¯•é¡µé¢ç‚¹å‡»"æŸ¥è¯¢åœ¨çº¿å¯†é’¥"

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤ºåœ¨çº¿æ•°é‡
- âœ… åˆ—å‡ºåœ¨çº¿å¯†é’¥
- âœ… æ˜¾ç¤ºæœ€åå¿ƒè·³æ—¶é—´

### æµ‹è¯•3ï¼šå¯†é’¥ç®¡ç†ç³»ç»Ÿ

1. è®¿é—®ï¼š`https://your-app.vercel.app/key_management.html`
2. æŸ¥çœ‹é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
3. ç‚¹å‡»"å½“å‰åœ¨çº¿"å¡ç‰‡

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤ºåœ¨çº¿æ•°é‡ > 0
- âœ… å¼¹çª—æ˜¾ç¤ºåœ¨çº¿å¯†é’¥è¯¦æƒ…
- âœ… æ¯30ç§’è‡ªåŠ¨æ›´æ–°

## ğŸ“Š å¯¹æ¯”æµ‹è¯•

### åœ¨é˜¿é‡Œäº‘ç¯å¢ƒæµ‹è¯•

```bash
# 1. è®¿é—®æµ‹è¯•é¡µé¢
open http://47.242.214.89/test_heartbeat_directly.html

# 2. è¾“å…¥å¯†é’¥å¹¶å¯åŠ¨å¿ƒè·³

# 3. æ‰“å¼€å¯†é’¥ç®¡ç†
open http://47.242.214.89/key_management.html

# 4. æŸ¥çœ‹åœ¨çº¿çŠ¶æ€
```

### åœ¨Vercelç¯å¢ƒæµ‹è¯•

```bash
# 1. è®¿é—®æµ‹è¯•é¡µé¢
open https://your-app.vercel.app/test-vercel-heartbeat.html

# 2. è¾“å…¥å¯†é’¥å¹¶å¯åŠ¨å¿ƒè·³

# 3. æ‰“å¼€å¯†é’¥ç®¡ç†
open https://your-app.vercel.app/key_management.html

# 4. æŸ¥çœ‹åœ¨çº¿çŠ¶æ€
```

**ä¸¤ä¸ªç¯å¢ƒåº”è¯¥æ˜¾ç¤ºç›¸åŒçš„åœ¨çº¿æ•°é‡ï¼**

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šVercelä»ç„¶ä¸æ˜¾ç¤ºåœ¨çº¿

**æ£€æŸ¥æ¸…å•**ï¼š
```bash
# 1. ç¡®è®¤æ–‡ä»¶å·²æ¨é€
git log -1

# 2. ç¡®è®¤Vercelå·²éƒ¨ç½²
# è®¿é—® Vercel Dashboard æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

# 3. æµ‹è¯•APIæ˜¯å¦å¯ç”¨
curl https://your-app.vercel.app/api/keys?limit=1

# 4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
# F12 â†’ Console â†’ æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
```

### é—®é¢˜ï¼šAPIè¿”å›404

**å¯èƒ½åŸå› **ï¼š
- æ–‡ä»¶æœªæ­£ç¡®æ¨é€
- Verceléƒ¨ç½²æœªå®Œæˆ
- æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥æœ¬åœ°æ–‡ä»¶
ls -la api/
ls -la api/keys/

# ç¡®è®¤æ–‡ä»¶å­˜åœ¨ï¼š
# api/keys.js âœ“
# api/stats.js âœ“
# api/keys/heartbeat.js âœ“
# api/keys/validate-key.js âœ“
# api/keys/check-usage.js âœ“

# é‡æ–°æ¨é€
git push origin main --force
```

### é—®é¢˜ï¼šCORSé”™è¯¯

**æ£€æŸ¥**ï¼š
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
fetch('https://your-app.vercel.app/api/keys?limit=1')
  .then(r => r.json())
  .then(d => console.log(d))
```

**è§£å†³**ï¼š
- ç¡®è®¤ `vercel.json` å·²æ›´æ–°
- æ£€æŸ¥CORSå¤´è®¾ç½®

### é—®é¢˜ï¼šæ•°æ®å»¶è¿Ÿ

**æ­£å¸¸æƒ…å†µ**ï¼š
- å¿ƒè·³é—´éš”ï¼š30ç§’
- çŠ¶æ€æ›´æ–°ï¼š30ç§’
- æœ€å¤§å»¶è¿Ÿï¼š60ç§’

**å¦‚æœè¶…è¿‡60ç§’**ï¼š
- æ£€æŸ¥é˜¿é‡Œäº‘æœåŠ¡å™¨çŠ¶æ€
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹Vercelå‡½æ•°æ—¥å¿—

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†ï¼Ÿ

Vercelæ˜¯serverlessç¯å¢ƒï¼š
- âŒ æ— æ³•ç›´æ¥è¿è¡ŒæŒä¹…åŒ–æœåŠ¡
- âŒ æ— æ³•ç›´æ¥è¿æ¥ç§æœ‰MongoDB
- âœ… å¯ä»¥é€šè¿‡HTTPä»£ç†è®¿é—®å¤–éƒ¨API

### æ•°æ®æµå‘

```
TWPK.html (ç”¨æˆ·è®¾å¤‡)
    â†“ æ¯30ç§’
å¿ƒè·³è¯·æ±‚ â†’ Vercelä»£ç† â†’ é˜¿é‡Œäº‘ â†’ MongoDB (lastHeartbeat)
                              â†“
å¯†é’¥ç®¡ç†ç³»ç»Ÿ â†’ Vercelä»£ç† â†’ é˜¿é‡Œäº‘ â†’ æŸ¥è¯¢lastHeartbeat
    â†“
è®¡ç®—åœ¨çº¿çŠ¶æ€ (now - lastHeartbeat < 90ç§’)
    â†“
æ˜¾ç¤ºåœ¨çº¿æ•°é‡å’Œåˆ—è¡¨
```

### åœ¨çº¿åˆ¤æ–­é€»è¾‘

```javascript
const now = Date.now();
const ONLINE_THRESHOLD = 90 * 1000; // 90ç§’

const isOnline = (key) => {
  if (!key.lastHeartbeat) return false;
  const lastHeartbeat = new Date(key.lastHeartbeat).getTime();
  return (now - lastHeartbeat) < ONLINE_THRESHOLD;
};
```

## ğŸ‰ å®Œæˆåçš„æ•ˆæœ

### âœ… é˜¿é‡Œäº‘ç¯å¢ƒ
- å¿ƒè·³æ­£å¸¸å‘é€
- åœ¨çº¿çŠ¶æ€æ­£å¸¸æ˜¾ç¤º
- å¯†é’¥ç®¡ç†ç³»ç»Ÿå·¥ä½œæ­£å¸¸

### âœ… Vercelç¯å¢ƒ
- å¿ƒè·³æ­£å¸¸å‘é€ï¼ˆé€šè¿‡ä»£ç†ï¼‰
- åœ¨çº¿çŠ¶æ€æ­£å¸¸æ˜¾ç¤ºï¼ˆé€šè¿‡ä»£ç†ï¼‰
- å¯†é’¥ç®¡ç†ç³»ç»Ÿå·¥ä½œæ­£å¸¸
- å…¨çƒCDNåŠ é€Ÿ
- è‡ªåŠ¨HTTPS

### ğŸŒŸ é¢å¤–ä¼˜åŠ¿
- å•ä¸€æ•°æ®æºï¼ˆé˜¿é‡Œäº‘MongoDBï¼‰
- æ— éœ€åŒæ•°æ®åº“ç»´æŠ¤
- Vercelæä¾›å…è´¹æ‰˜ç®¡
- è‡ªåŠ¨æ‰©å±•å’Œé«˜å¯ç”¨

## ğŸ“ ç»´æŠ¤å»ºè®®

### å®šæœŸæ£€æŸ¥
```bash
# æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡åœ¨çº¿çŠ¶æ€
curl https://your-app.vercel.app/api/keys?limit=100 | jq

# æŸ¥çœ‹åœ¨çº¿æ•°é‡
curl https://your-app.vercel.app/api/stats | jq
```

### ç›‘æ§å»ºè®®
- è®¾ç½®Vercelå‡½æ•°ç›‘æ§
- é…ç½®é”™è¯¯å‘Šè­¦
- å®šæœŸæŸ¥çœ‹æ—¥å¿—

### å¤‡ä»½å»ºè®®
- å®šæœŸå¤‡ä»½MongoDBæ•°æ®
- ä¿å­˜å…³é”®é…ç½®æ–‡ä»¶
- è®°å½•APIç«¯ç‚¹

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `VERCEL_DEPLOY.md` - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
- `test-vercel-heartbeat.html` - æµ‹è¯•é¡µé¢
- `deploy-vercel-fix.sh` - éƒ¨ç½²è„šæœ¬
- `vercel.json` - Vercelé…ç½®

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ `VERCEL_DEPLOY.md` çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. ä½¿ç”¨ `test-vercel-heartbeat.html` è¿›è¡Œè¯Šæ–­
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
4. æŸ¥çœ‹Verceléƒ¨ç½²æ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025-10-15
**çŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³

