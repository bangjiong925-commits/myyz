<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç»‘å®šæµ‹è¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .warning-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            font-family: monospace;
            font-size: 14px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
        }
        .info-value {
            color: #333;
            word-break: break-all;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            color: #856404;
        }
        .input-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
        }
        button {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-2px); }
        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        .status-success {
            border-color: #10b981;
            background: #ecfdf5;
        }
        .status-error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .comparison-table th {
            background: #f3f4f6;
            font-weight: bold;
        }
        .same { color: #10b981; font-weight: bold; }
        .different { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è®¾å¤‡ç»‘å®šæµ‹è¯•å·¥å…·</h1>
        
        <div class="warning-box">
            <h3>âš ï¸ å…³äºè·¨åŸŸè®¾å¤‡ç»‘å®š</h3>
            <p>ç”±äºæµè§ˆå™¨çš„å®‰å…¨é™åˆ¶ï¼Œ<code>localStorage</code> æ˜¯åŸŸåéš”ç¦»çš„ï¼š</p>
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li><code>http://47.242.214.89</code> æœ‰ç‹¬ç«‹çš„ localStorage</li>
                <li><code>https://myyz.vercel.app</code> æœ‰ç‹¬ç«‹çš„ localStorage</li>
                <li>å³ä½¿æ˜¯åŒä¸€è®¾å¤‡ï¼Œå¯èƒ½ç”Ÿæˆ<strong>ä¸åŒçš„</strong> deviceId</li>
            </ul>
        </div>

        <!-- å½“å‰ç¯å¢ƒä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ“Š å½“å‰ç¯å¢ƒä¿¡æ¯</h2>
            <div class="info-grid">
                <div class="info-label">åŸŸåï¼š</div>
                <div class="info-value" id="hostname">-</div>
                
                <div class="info-label">åè®®ï¼š</div>
                <div class="info-value" id="protocol">-</div>
                
                <div class="info-label">å½“å‰DeviceIDï¼š</div>
                <div class="info-value highlight" id="currentDeviceId">-</div>
                
                <div class="info-label">æµè§ˆå™¨ï¼š</div>
                <div class="info-value" id="userAgent">-</div>
                
                <div class="info-label">å±å¹•åˆ†è¾¨ç‡ï¼š</div>
                <div class="info-value" id="screenResolution">-</div>
                
                <div class="info-label">è¯­è¨€ï¼š</div>
                <div class="info-value" id="language">-</div>
                
                <div class="info-label">æ—¶åŒºï¼š</div>
                <div class="info-value" id="timezone">-</div>
            </div>
        </div>

        <!-- æµ‹è¯•å¯†é’¥éªŒè¯ -->
        <div class="section">
            <h2>ğŸ§ª æµ‹è¯•å¯†é’¥éªŒè¯</h2>
            <div class="input-group">
                <label>è¾“å…¥æµ‹è¯•å¯†é’¥</label>
                <input type="text" id="keyInput" placeholder="è¯·è¾“å…¥å¯†é’¥">
            </div>
            <button onclick="testAliyun()">æµ‹è¯•é˜¿é‡Œäº‘ç¯å¢ƒ</button>
            <button onclick="testVercel()">æµ‹è¯•Vercelç¯å¢ƒ</button>
            <button onclick="testCurrent()">æµ‹è¯•å½“å‰ç¯å¢ƒ</button>
            <div id="testResult"></div>
        </div>

        <!-- è·¨åŸŸå¯¹æ¯” -->
        <div class="section">
            <h2>ğŸ”„ è·¨åŸŸDeviceIDå¯¹æ¯”</h2>
            <p style="color: #666; margin-bottom: 15px;">
                åœ¨ä¸¤ä¸ªç¯å¢ƒä¸­éªŒè¯ç›¸åŒå¯†é’¥ï¼Œå¯¹æ¯”deviceIdæ˜¯å¦ä¸€è‡´
            </p>
            <button onclick="openBothEnvironments()">åŒæ—¶æ‰“å¼€ä¸¤ä¸ªç¯å¢ƒ</button>
            <button onclick="clearAllDeviceIds()">æ¸…é™¤æ‰€æœ‰DeviceID</button>
            
            <table class="comparison-table" id="comparisonTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ç¯å¢ƒ</th>
                        <th>DeviceID</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody"></tbody>
            </table>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div id="logBox" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;"></div>
        </div>
    </div>

    <script>
        // ç”Ÿæˆè®¾å¤‡IDï¼ˆä¸TWPK.htmlç›¸åŒçš„é€»è¾‘ï¼‰
        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            
            if (!deviceId) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    canvas.toDataURL()
                ].join('|');
                
                let hash = 0;
                for (let i = 0; i < fingerprint.length; i++) {
                    const char = fingerprint.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                deviceId = Math.abs(hash).toString(36);
                localStorage.setItem('deviceId', deviceId);
            }
            
            return deviceId;
        }

        // æ—¥å¿—
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const colors = { info: '#666', success: '#10b981', error: '#ef4444', warning: '#f59e0b' };
            const entry = document.createElement('div');
            entry.style.color = colors[type];
            entry.style.margin = '5px 0';
            entry.textContent = `[${time}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvironmentInfo() {
            const deviceId = generateDeviceId();
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('currentDeviceId').textContent = deviceId;
            document.getElementById('userAgent').textContent = navigator.userAgent;
            document.getElementById('screenResolution').textContent = screen.width + 'x' + screen.height;
            document.getElementById('language').textContent = navigator.language;
            document.getElementById('timezone').textContent = `UTC${new Date().getTimezoneOffset() / -60}`;
            
            log(`å½“å‰ç¯å¢ƒ: ${window.location.hostname}`, 'info');
            log(`DeviceID: ${deviceId}`, 'info');
        }

        // æµ‹è¯•éªŒè¯
        async function testEnvironment(apiUrl, envName) {
            const key = document.getElementById('keyInput').value.trim();
            if (!key) {
                alert('è¯·è¾“å…¥å¯†é’¥');
                return;
            }

            const deviceId = generateDeviceId();
            log(`æµ‹è¯• ${envName} - DeviceID: ${deviceId}`, 'info');

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        key: key,
                        deviceId: deviceId,
                        clientTime: Date.now()
                    })
                });

                const result = await response.json();
                const resultBox = document.getElementById('testResult');
                
                if (result.success && result.valid) {
                    resultBox.innerHTML = `
                        <div class="result-box status-success">
                            <h3 style="color: #10b981; margin-bottom: 10px;">âœ… ${envName} éªŒè¯æˆåŠŸ</h3>
                            <div style="font-family: monospace; font-size: 13px;">
                                <div><strong>å¯†é’¥ï¼š</strong>${result.data.key}</div>
                                <div><strong>çŠ¶æ€ï¼š</strong>${result.data.status}</div>
                                <div><strong>è®¾å¤‡ç»‘å®šï¼š</strong>${result.data.deviceBound ? 'æ˜¯' : 'å¦'}</div>
                                ${result.data.deviceInfo ? `
                                    <div><strong>ç»‘å®šDeviceIDï¼š</strong>${result.data.deviceInfo.deviceId}</div>
                                    <div><strong>é¦–æ¬¡éªŒè¯ï¼š</strong>${new Date(result.data.deviceInfo.firstVerified).toLocaleString()}</div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    log(`âœ… ${envName} éªŒè¯æˆåŠŸ`, 'success');
                    
                    if (result.data.deviceBound) {
                        log(`âš ï¸ å¯†é’¥å·²ç»‘å®šåˆ° DeviceID: ${result.data.deviceInfo.deviceId}`, 'warning');
                        if (result.data.deviceInfo.deviceId !== deviceId) {
                            log(`ğŸ”´ æ³¨æ„ï¼šå½“å‰DeviceID (${deviceId}) ä¸ç»‘å®šçš„ä¸åŒï¼`, 'error');
                        } else {
                            log(`ğŸŸ¢ å½“å‰DeviceIDä¸ç»‘å®šçš„ä¸€è‡´`, 'success');
                        }
                    }
                } else {
                    resultBox.innerHTML = `
                        <div class="result-box status-error">
                            <h3 style="color: #ef4444; margin-bottom: 10px;">âŒ ${envName} éªŒè¯å¤±è´¥</h3>
                            <div><strong>åŸå› ï¼š</strong>${result.reason || result.error}</div>
                        </div>
                    `;
                    log(`âŒ ${envName} éªŒè¯å¤±è´¥: ${result.reason || result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testAliyun() {
            testEnvironment('http://47.242.214.89/api/keys/validate-key', 'é˜¿é‡Œäº‘');
        }

        function testVercel() {
            testEnvironment('https://myyz.vercel.app/api/keys/validate-key', 'Vercel');
        }

        function testCurrent() {
            const apiUrl = window.location.hostname.includes('vercel.app')
                ? '/api/keys/validate-key'
                : window.location.hostname === '47.242.214.89'
                    ? '/api/keys/validate-key'
                    : 'http://47.242.214.89/api/keys/validate-key';
            testEnvironment(apiUrl, 'å½“å‰ç¯å¢ƒ');
        }

        function openBothEnvironments() {
            window.open('http://47.242.214.89/test-device-binding.html', '_blank');
            window.open('https://myyz.vercel.app/test-device-binding.html', '_blank');
            log('å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä¸¤ä¸ªç¯å¢ƒ', 'info');
            log('è¯·åœ¨ä¸¤ä¸ªç¯å¢ƒä¸­æŸ¥çœ‹DeviceIDæ˜¯å¦ç›¸åŒ', 'warning');
        }

        function clearAllDeviceIds() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰åŸŸåçš„DeviceIDå—ï¼Ÿ')) {
                localStorage.removeItem('deviceId');
                log('å·²æ¸…é™¤å½“å‰DeviceIDï¼Œåˆ·æ–°é¡µé¢å°†ç”Ÿæˆæ–°çš„ID', 'warning');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // åˆå§‹åŒ–
        showEnvironmentInfo();
        log('æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
        log('ğŸ’¡ æç¤ºï¼šåœ¨ä¸åŒåŸŸåä¸‹ï¼ŒlocalStorageæ˜¯éš”ç¦»çš„', 'info');
    </script>
</body>
</html>

