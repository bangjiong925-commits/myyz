<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel å¿ƒè·³æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        .env-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }
        .env-info h3 {
            color: #0369a1;
            margin-bottom: 10px;
        }
        .env-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover { background: #059669; }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover { background: #dc2626; }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .status-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        .status-card.online h3 { color: #10b981; }
        .status-card.offline h3 { color: #ef4444; }
        .status-card p {
            color: #666;
            font-size: 14px;
        }
        .log-box {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            font-family: monospace;
            font-size: 13px;
            line-height: 1.8;
            margin: 3px 0;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .log-warning { color: #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ Vercel éƒ¨ç½²å¿ƒè·³æµ‹è¯•</h1>
        
        <!-- ç¯å¢ƒä¿¡æ¯ -->
        <div class="env-info">
            <h3>ğŸ“Š å½“å‰ç¯å¢ƒä¿¡æ¯</h3>
            <div class="env-item">
                <span>åŸŸåï¼š</span>
                <span id="hostname">-</span>
            </div>
            <div class="env-item">
                <span>ç¯å¢ƒï¼š</span>
                <span id="environment">-</span>
            </div>
            <div class="env-item">
                <span>APIåœ°å€ï¼š</span>
                <span id="apiBase">-</span>
            </div>
        </div>

        <!-- æµ‹è¯•1ï¼šå¿ƒè·³å‘é€ -->
        <div class="section">
            <h2>æµ‹è¯•1ï¼šå¿ƒè·³å‘é€</h2>
            <div class="input-group">
                <label>è¾“å…¥æµ‹è¯•å¯†é’¥</label>
                <input type="text" id="keyInput" placeholder="è¯·è¾“å…¥å¯†é’¥">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="startHeartbeat()">å¯åŠ¨å¿ƒè·³</button>
                <button class="btn-danger" onclick="stopHeartbeat()" disabled id="stopBtn">åœæ­¢å¿ƒè·³</button>
            </div>
            <div class="status-grid">
                <div class="status-card offline" id="heartbeatCard">
                    <h3 id="heartbeatStatus">ç¦»çº¿</h3>
                    <p>å¿ƒè·³çŠ¶æ€</p>
                </div>
                <div class="status-card">
                    <h3 id="heartbeatCount">0</h3>
                    <p>å‘é€æ¬¡æ•°</p>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•2ï¼šæŸ¥è¯¢åœ¨çº¿çŠ¶æ€ -->
        <div class="section">
            <h2>æµ‹è¯•2ï¼šæŸ¥è¯¢åœ¨çº¿çŠ¶æ€</h2>
            <div class="button-group">
                <button class="btn-success" onclick="checkOnlineStatus()">æŸ¥è¯¢åœ¨çº¿å¯†é’¥</button>
                <button class="btn-success" onclick="checkStats()">æŸ¥è¯¢ç»Ÿè®¡æ•°æ®</button>
            </div>
            <div class="status-grid">
                <div class="status-card">
                    <h3 id="onlineCount">-</h3>
                    <p>åœ¨çº¿æ•°é‡</p>
                </div>
                <div class="status-card">
                    <h3 id="totalKeys">-</h3>
                    <p>æ€»å¯†é’¥æ•°</p>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>å®æ—¶æ—¥å¿—</h2>
            <div class="log-box" id="logBox"></div>
        </div>
    </div>

    <script>
        // ç¯å¢ƒæ£€æµ‹
        const hostname = window.location.hostname;
        const isVercel = hostname.includes('vercel.app');
        const isAliyun = hostname === '47.242.214.89';
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1';

        let API_BASE;
        let environment;

        if (isVercel) {
            API_BASE = '/api';
            environment = 'Vercel ç”Ÿäº§ç¯å¢ƒ';
        } else if (isAliyun) {
            API_BASE = '/api';
            environment = 'é˜¿é‡Œäº‘æœåŠ¡å™¨';
        } else if (isLocal) {
            API_BASE = 'http://localhost:3002/api';
            environment = 'æœ¬åœ°å¼€å‘ç¯å¢ƒ';
        } else {
            API_BASE = '/api';
            environment = 'æœªçŸ¥ç¯å¢ƒ';
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        document.getElementById('hostname').textContent = hostname;
        document.getElementById('environment').textContent = environment;
        document.getElementById('apiBase').textContent = API_BASE;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${time}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // å¿ƒè·³ç›¸å…³
        let heartbeatTimer = null;
        let heartbeatCount = 0;
        let currentKey = null;

        async function sendHeartbeat() {
            if (!currentKey) return;

            try {
                log(`ğŸ’“ å‘é€å¿ƒè·³åˆ° ${API_BASE}/keys/heartbeat`, 'info');
                
                const response = await fetch(`${API_BASE}/keys/heartbeat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: currentKey })
                });

                const result = await response.json();
                log(`å“åº”çŠ¶æ€: ${response.status}`, 'info');
                log(`å“åº”æ•°æ®: ${JSON.stringify(result)}`, 'info');

                if (result.success) {
                    heartbeatCount++;
                    document.getElementById('heartbeatCount').textContent = heartbeatCount;
                    document.getElementById('heartbeatStatus').textContent = 'åœ¨çº¿';
                    document.getElementById('heartbeatCard').className = 'status-card online';
                    log(`âœ… å¿ƒè·³æˆåŠŸ (ç¬¬${heartbeatCount}æ¬¡)`, 'success');
                } else {
                    log(`âš ï¸ å¿ƒè·³å¤±è´¥: ${result.error}`, 'warning');
                }
            } catch (error) {
                log(`âŒ å¿ƒè·³é”™è¯¯: ${error.message}`, 'error');
                console.error('å¿ƒè·³é”™è¯¯è¯¦æƒ…:', error);
            }
        }

        function startHeartbeat() {
            const keyInput = document.getElementById('keyInput');
            const key = keyInput.value.trim();

            if (!key) {
                alert('è¯·è¾“å…¥å¯†é’¥');
                return;
            }

            currentKey = key;
            heartbeatCount = 0;
            document.getElementById('heartbeatCount').textContent = '0';

            log(`ğŸš€ å¯åŠ¨å¿ƒè·³æµ‹è¯• - å¯†é’¥: ${key.substring(0, 8)}...`, 'info');
            log(`ğŸ“¡ ç›®æ ‡API: ${API_BASE}/keys/heartbeat`, 'info');

            // ç«‹å³å‘é€ç¬¬ä¸€æ¬¡
            sendHeartbeat();

            // æ¯30ç§’å‘é€ä¸€æ¬¡
            heartbeatTimer = setInterval(sendHeartbeat, 30000);

            document.getElementById('stopBtn').disabled = false;
            keyInput.disabled = true;

            log('â±ï¸ å¿ƒè·³å®šæ—¶å™¨å·²å¯åŠ¨ï¼ˆæ¯30ç§’ï¼‰', 'info');
        }

        function stopHeartbeat() {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }

            document.getElementById('heartbeatStatus').textContent = 'ç¦»çº¿';
            document.getElementById('heartbeatCard').className = 'status-card offline';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('keyInput').disabled = false;

            log('â¹ï¸ å¿ƒè·³å·²åœæ­¢', 'warning');
        }

        async function checkOnlineStatus() {
            try {
                log(`ğŸ” æŸ¥è¯¢åœ¨çº¿çŠ¶æ€: ${API_BASE}/keys?limit=100`, 'info');

                const response = await fetch(`${API_BASE}/keys?limit=100`);
                const result = await response.json();

                log(`å“åº”çŠ¶æ€: ${response.status}`, 'info');

                if (result.success && result.data) {
                    const now = Date.now();
                    const THRESHOLD = 90 * 1000; // 90ç§’

                    const onlineKeys = result.data.filter(key => {
                        if (key.lastHeartbeat) {
                            const diff = now - new Date(key.lastHeartbeat).getTime();
                            return diff < THRESHOLD;
                        }
                        return false;
                    });

                    document.getElementById('onlineCount').textContent = onlineKeys.length;
                    document.getElementById('totalKeys').textContent = result.data.length;

                    log(`âœ… åœ¨çº¿å¯†é’¥æ•°: ${onlineKeys.length}`, 'success');
                    log(`ğŸ“Š æ€»å¯†é’¥æ•°: ${result.data.length}`, 'info');

                    if (onlineKeys.length > 0) {
                        onlineKeys.forEach(key => {
                            const lastHeartbeat = new Date(key.lastHeartbeat);
                            const secondsAgo = Math.floor((now - lastHeartbeat.getTime()) / 1000);
                            log(`  ğŸŸ¢ ${key.key.substring(0, 12)}... (${secondsAgo}ç§’å‰)`, 'success');
                        });
                    }
                } else {
                    log(`âŒ æŸ¥è¯¢å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                log(`âŒ æŸ¥è¯¢é”™è¯¯: ${error.message}`, 'error');
                console.error('æŸ¥è¯¢é”™è¯¯è¯¦æƒ…:', error);
            }
        }

        async function checkStats() {
            try {
                log(`ğŸ“Š æŸ¥è¯¢ç»Ÿè®¡æ•°æ®: ${API_BASE}/stats`, 'info');

                const response = await fetch(`${API_BASE}/stats`);
                const result = await response.json();

                log(`å“åº”çŠ¶æ€: ${response.status}`, 'info');

                if (result.success && result.stats) {
                    log(`âœ… ç»Ÿè®¡æ•°æ®è·å–æˆåŠŸ`, 'success');
                    log(`  æ€»æ•°: ${result.stats.total}`, 'info');
                    log(`  æ¿€æ´»: ${result.stats.active}`, 'info');
                    log(`  è¿‡æœŸ: ${result.stats.expired}`, 'info');
                    document.getElementById('totalKeys').textContent = result.stats.total;
                } else {
                    log(`âŒ è·å–ç»Ÿè®¡å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                log(`âŒ ç»Ÿè®¡é”™è¯¯: ${error.message}`, 'error');
                console.error('ç»Ÿè®¡é”™è¯¯è¯¦æƒ…:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('beforeunload', stopHeartbeat);
        
        log('âœ… æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
        log(`ğŸ“ å½“å‰ç¯å¢ƒ: ${environment}`, 'info');
        log(`ğŸ”— APIåœ°å€: ${API_BASE}`, 'info');
        log('ğŸ’¡ è¯·è¾“å…¥å¯†é’¥åç‚¹å‡»"å¯åŠ¨å¿ƒè·³"å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>







