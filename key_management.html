<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密钥管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* 数据库管理标签页样式 */
        .db-tab-content {
            display: none;
            padding: 20px 0;
        }

        .db-tab-content.active {
            display: block;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }

        .stat-card .description {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-inactive {
            background: #e2e3e5;
            color: #6c757d;
        }

        .key-display {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔑 密钥管理系统</h1>
            <p>安全、高效的API密钥管理解决方案</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">仪表板</button>
            <button class="nav-tab" onclick="showTab('create')">创建密钥</button>
            <button class="nav-tab" onclick="showTab('validate')">验证密钥</button>
            <button class="nav-tab" onclick="showTab('manage')">管理密钥</button>
            <button class="nav-tab" onclick="showTab('database')">数据库管理</button>
            <button class="nav-tab" onclick="showTab('sessions')">用户会话</button>
        </div>

        <!-- 仪表板 -->
        <div id="dashboard" class="tab-content active">
            <h2>📊 系统概览</h2>
            <div id="stats-container" class="loading">
                <div class="spinner"></div>
                <p>正在加载统计数据...</p>
            </div>
        </div>

        <!-- 创建密钥 -->
        <div id="create" class="tab-content">
            <h2>➕ 创建新密钥</h2>
            <div id="create-alert"></div>
            <form id="create-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="duration">有效期*</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="duration" class="form-control" min="1" value="24" required style="flex: 2;">
                            <select id="time-unit" class="form-control" style="flex: 1;">
                                <option value="minutes">分钟</option>
                                <option value="hours">小时</option>
                                <option value="days">天</option>
                                <option value="months">月</option>
                            </select>
                        </div>
                        <small style="color: #666; font-size: 12px;">最长：60分钟 / 720小时 / 30天 / 12个月</small>
                    </div>
                    <div class="form-group">
                        <label for="description">描述</label>
                        <input type="text" id="description" class="form-control" placeholder="密钥用途描述">
                    </div>
                </div>
                <div class="form-group">
                    <label for="custom-key">自定义密钥（可选）</label>
                    <input type="text" id="custom-key" class="form-control" placeholder="留空将自动生成">
                </div>
                <button type="submit" class="btn btn-primary">🔑 创建密钥</button>
            </form>
        </div>

        <!-- 验证密钥 -->
        <div id="validate" class="tab-content">
            <h2>🔍 验证密钥</h2>
            <div id="validate-alert"></div>
            <form id="validate-form">
                <div class="form-group">
                    <label for="validate-key">密钥*</label>
                    <input type="text" id="validate-key" class="form-control" placeholder="请输入要验证的密钥" required>
                </div>
                <button type="submit" class="btn btn-success">✅ 验证密钥</button>
            </form>
            <div id="validate-result"></div>
        </div>

        <!-- 管理密钥 -->
        <div id="manage" class="tab-content">
            <h2>🛠️ 密钥管理</h2>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="status-filter">状态筛选</label>
                    <select id="status-filter" class="form-control" onchange="loadKeys()">
                        <option value="">全部状态</option>
                        <option value="active">活跃</option>
                        <option value="expired">已过期</option>
                        <option value="inactive">未激活</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-warning" onclick="cleanupExpiredKeys()">🧹 清理过期密钥</button>
                </div>
            </div>
            <div id="manage-alert"></div>
            <div id="keys-container" class="loading">
                <div class="spinner"></div>
                <p>正在加载密钥列表...</p>
            </div>
        </div>

        <!-- 数据库管理 -->
        <div id="database" class="tab-content">
            <h2>🗄️ 数据库管理</h2>
            
            <!-- 数据库管理子导航 -->
            <div class="nav-tabs" style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button class="nav-tab active" onclick="showDatabaseTab('overview')">数据库概览</button>
                <button class="nav-tab" onclick="showDatabaseTab('pk10')">PK10数据管理</button>
                <button class="nav-tab" onclick="showDatabaseTab('backup')">备份与恢复</button>
                <button class="nav-tab" onclick="showDatabaseTab('maintenance')">维护工具</button>
            </div>

            <!-- 数据库概览 -->
            <div id="db-overview" class="db-tab-content active">
                <h3>📊 数据库概览</h3>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" onclick="loadDatabaseInfo()">🔄 刷新信息</button>
                    </div>
                </div>
                <div id="database-alert"></div>
                <div id="database-info-container" class="loading">
                    <div class="spinner"></div>
                    <p>正在加载数据库信息...</p>
                </div>
            </div>

            <!-- PK10数据管理 -->
            <div id="db-pk10" class="db-tab-content">
                <h3>🎲 PK10数据管理</h3>
                
                <!-- 搜索和过滤 -->
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="pk10-search-issue">期号搜索</label>
                        <input type="text" id="pk10-search-issue" class="form-control" placeholder="输入期号">
                    </div>
                    <div class="form-group">
                        <label for="pk10-search-date">日期</label>
                        <input type="date" id="pk10-search-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" onclick="searchPK10Data()">🔍 搜索</button>
                        <button type="button" class="btn btn-secondary" onclick="loadPK10Data()">📋 显示全部</button>
                    </div>
                </div>

                <!-- 提示信息 -->
                <div id="pk10-alert" style="margin-top: 20px;"></div>

                <!-- PK10统计信息 -->
                <div id="pk10-stats-container" class="loading">
                    <div class="spinner"></div>
                    <p>正在加载PK10统计信息...</p>
                </div>

                <!-- PK10数据列表 -->
                <div id="pk10-data-container" class="loading" style="margin-top: 20px;">
                    <div class="spinner"></div>
                    <p>正在加载PK10数据...</p>
                </div>

                <!-- 分页控件 -->
                <div id="pk10-pagination" class="pagination-container" style="margin-top: 20px;"></div>
            </div>

            <!-- 备份与恢复 -->
            <div id="db-backup" class="db-tab-content">
                <h3>💾 备份与恢复</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>数据库备份</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="backup-databases" class="form-control" multiple style="height: 80px;">
                                <option value="taiwan_pk10">taiwan_pk10 (PK10数据)</option>
                                <option value="myyz_db">myyz_db (密钥管理)</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="backupDatabase()">📥 创建备份</button>
                        </div>
                        <small style="color: #666; font-size: 12px;">按住Ctrl/Cmd选择多个数据库</small>
                    </div>
                </div>

                <div id="backup-alert" style="margin-top: 20px;"></div>
            </div>

            <!-- 维护工具 -->
            <div id="db-maintenance" class="db-tab-content">
                <h3>🔧 维护工具</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>清理旧数据</label>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label for="cleanup-database" style="font-size: 12px;">数据库</label>
                                <select id="cleanup-database" class="form-control">
                                    <option value="taiwan_pk10">taiwan_pk10</option>
                                    <option value="myyz_db">myyz_db</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label for="cleanup-collection" style="font-size: 12px;">集合</label>
                                <select id="cleanup-collection" class="form-control">
                                    <option value="pk10_results">pk10_results</option>
                                    <option value="api_keys">api_keys</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label for="cleanup-days" style="font-size: 12px;">保留天数</label>
                                <input type="number" id="cleanup-days" class="form-control" min="1" value="30">
                            </div>
                            <button type="button" class="btn btn-danger" onclick="cleanupDatabase()">🗑️ 清理</button>
                        </div>
                        <small style="color: #666; font-size: 12px;">将删除指定天数之前的数据，请谨慎操作</small>
                    </div>
                </div>

                <div id="maintenance-alert" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- 用户会话 -->
        <div id="sessions" class="tab-content">
            <h2>👥 活跃用户会话</h2>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-primary" onclick="loadActiveSessions()">🔄 刷新会话</button>
                </div>
            </div>
            <div id="sessions-alert"></div>
            <div id="sessions-container" class="loading">
                <div class="spinner"></div>
                <p>正在加载活跃用户会话...</p>
            </div>
        </div>
    </div>

    <script>
        // 自动检测API基础URL
        function getApiBase() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // 如果是本地开发环境
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3002/api';
            }
            
            // 如果是Vercel部署环境，使用相对路径的API
            if (hostname.includes('vercel.app')) {
                return '/api';
            }
            
            // 其他环境，使用当前域名的API
            return `${protocol}//${hostname}/api`;
        }
        
        const API_BASE = getApiBase();
        let currentPage = 1;
        const pageSize = 10;
        let isAuthenticated = true; // 移除登录功能后，直接设置为true

        // 显示标签页
        function showTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // 加载对应数据
            if (tabName === 'dashboard') {
                loadStats();
            } else if (tabName === 'manage') {
                loadKeys();
            } else if (tabName === 'database') {
                loadDatabaseInfo();
            } else if (tabName === 'sessions') {
                loadActiveSessions();
            }
        }

        // 显示提示信息
        function showAlert(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/keys?path=stats`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('stats-container').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>${stats.total}</h3>
                                <p>总密钥数</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.active}</h3>
                                <p>活跃密钥</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.expired}</h3>
                                <p>已过期</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.used}</h3>
                                <p>已使用</p>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            📅 最后更新: ${new Date(stats.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('stats-container').innerHTML = `
                    <div class="alert alert-danger">
                        ❌ 加载统计数据失败: ${error.message}
                    </div>
                `;
            }
        }

        // 复制到剪贴板功能
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('create-alert', '✅ 密钥已复制到剪贴板！', 'success');
            }).catch(() => {
                // 备用方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('create-alert', '✅ 密钥已复制到剪贴板！', 'success');
            });
        }

        // 时间单位验证
        function validateDuration(duration, unit) {
            const durationNum = parseInt(duration);
            
            if (unit === 'hours' && durationNum > 720) {
                return '小时数不能超过720小时';
            }
            if (unit === 'days' && durationNum > 30) {
                return '天数不能超过30天';
            }
            if (unit === 'months' && durationNum > 12) {
                return '月数不能超过12个月';
            }
            return null;
        }

        // 创建密钥
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const duration = document.getElementById('duration').value;
            const unit = document.getElementById('time-unit').value;
            const description = document.getElementById('description').value;
            const customKey = document.getElementById('custom-key').value;

            // 前端验证
            const validationError = validateDuration(duration, unit);
            if (validationError) {
                showAlert('create-alert', `❌ ${validationError}`, 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys?path=create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        duration: parseInt(duration),
                        unit,
                        description,
                        customKey: customKey || undefined
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('create-alert', `
                        ✅ 密钥创建成功！<br>
                        <div class="key-display" style="margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <strong>密钥:</strong> 
                                <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-family: monospace;">${result.data.key}</code>
                                <button onclick="copyToClipboard('${result.data.key}')" class="btn btn-sm" style="background: #28a745; color: white; padding: 4px 8px;">📋 复制</button>
                            </div>
                            有效期: ${result.data.totalDuration}<br>
                            到期时间: ${new Date(result.data.expiresAt).toLocaleString()}
                        </div>
                    `, 'success');
                    document.getElementById('create-form').reset();
                    document.getElementById('duration').value = '24';
                } else {
                    showAlert('create-alert', `❌ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('create-alert', `❌ 创建失败: ${error.message}`, 'danger');
            }
        });

        // 验证密钥
        document.getElementById('validate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const key = document.getElementById('validate-key').value.trim();

            try {
                const response = await fetch(`${API_BASE}/keys?path=validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ key })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    document.getElementById('validate-result').innerHTML = `
                        <div class="alert alert-success" style="margin-top: 20px;">
                            ✅ 密钥验证成功！<br>
                            <div class="key-display" style="margin-top: 10px;">
                                密钥: ${data.key}<br>
                                描述: ${data.description || '无'}<br>
                                状态: <span class="status-badge status-${data.status}">${data.status}</span><br>
                                创建时间: ${new Date(data.createdAt).toLocaleString()}<br>
                                激活时间: ${new Date(data.activatedAt).toLocaleString()}<br>
                                到期时间: ${new Date(data.expiresAt).toLocaleString()}<br>
                                总时长: ${data.totalDuration}<br>
                                剩余时间: ${data.remainingTime}<br>
                                使用次数: ${data.usageCount}
                            </div>
                        </div>
                    `;
                    showAlert('validate-alert', '✅ 密钥验证成功', 'success');
                } else {
                    document.getElementById('validate-result').innerHTML = `
                        <div class="alert alert-danger" style="margin-top: 20px;">
                            ❌ ${result.message}
                        </div>
                    `;
                    showAlert('validate-alert', `❌ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('validate-alert', `❌ 验证失败: ${error.message}`, 'danger');
                document.getElementById('validate-result').innerHTML = '';
            }
        });

        // 加载密钥列表
        async function loadKeys(page = 1) {
            currentPage = page;
            const status = document.getElementById('status-filter').value;
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: pageSize
                });
                
                if (status) params.append('status', status);

                const response = await fetch(`${API_BASE}/keys?path=list&${params}`);
                const result = await response.json();

                if (result.success) {
                    const keys = result.data;
                    const pagination = result.pagination;

                    let tableHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>密钥</th>
                                        <th>描述</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>剩余时间</th>
                                        <th>使用次数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    keys.forEach(key => {
                        const statusClass = key.isExpired ? 'expired' : key.status;
                        tableHTML += `
                            <tr>
                                <td><div class="key-display">${key.key.substring(0, 16)}...</div></td>
                                <td>${key.description || '无'}</td>
                                <td><span class="status-badge status-${statusClass}">${key.status}</span></td>
                                <td>${new Date(key.createdAt).toLocaleString()}</td>
                                <td>${key.remainingTime}</td>
                                <td>${key.usageCount || 0}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewKeyDetails('${key.key}')">详情</button>
                                    <button class="btn btn-sm btn-warning" onclick="extendKey('${key.key}')">延期</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteKey('${key.key}')">删除</button>
                                </td>
                            </tr>
                        `;
                    });

                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    // 添加分页
                    if (pagination.pages > 1) {
                        tableHTML += `
                            <div class="pagination">
                                <button onclick="loadKeys(${Math.max(1, pagination.page - 1)})" ${pagination.page === 1 ? 'disabled' : ''}>上一页</button>
                                <span>第 ${pagination.page} 页，共 ${pagination.pages} 页</span>
                                <button onclick="loadKeys(${Math.min(pagination.pages, pagination.page + 1)})" ${pagination.page === pagination.pages ? 'disabled' : ''}>下一页</button>
                            </div>
                        `;
                    }

                    document.getElementById('keys-container').innerHTML = tableHTML;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('keys-container').innerHTML = `
                    <div class="alert alert-danger">
                        ❌ 加载密钥列表失败: ${error.message}
                    </div>
                `;
            }
        }

        // 查看密钥详情
        async function viewKeyDetails(key) {
            try {
                const response = await fetch(`${API_BASE}/keys?path=details&key=${key}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    alert(`密钥详情:
密钥: ${data.key}
描述: ${data.description || '无'}
状态: ${data.status}
创建时间: ${new Date(data.createdAt).toLocaleString()}
激活时间: ${data.activatedAt ? new Date(data.activatedAt).toLocaleString() : '未激活'}
到期时间: ${new Date(data.expiresAt).toLocaleString()}
总时长: ${data.totalDuration}
剩余时间: ${data.remainingTime}
使用次数: ${data.usageCount || 0}
最后使用: ${data.lastUsed ? new Date(data.lastUsed).toLocaleString() : '从未使用'}`);
                } else {
                    alert(`获取详情失败: ${result.message}`);
                }
            } catch (error) {
                alert(`获取详情失败: ${error.message}`);
            }
        }

        // 延长密钥
        async function extendKey(key) {
            if (!isAuthenticated) {
                showAlert('manage-alert', '❌ 请先登录后再进行延期操作', 'danger');
                return;
            }

            // 创建一个更友好的延期对话框
            const extendDialog = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; margin: 20px auto;">
                    <h4 style="margin-bottom: 15px; color: #333;">🕒 延期密钥</h4>
                    <p style="margin-bottom: 15px; color: #666;">密钥: <code>${key}</code></p>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">延期时长:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="extend-duration" min="1" value="24" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="extend-unit" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="minutes">分钟</option>
                                <option value="hours" selected>小时</option>
                                <option value="days">天</option>
                                <option value="months">月</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeExtendDialog()" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">取消</button>
                        <button onclick="confirmExtend('${key}')" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">确认延期</button>
                    </div>
                </div>
            `;

            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.id = 'extend-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            overlay.innerHTML = extendDialog;
            document.body.appendChild(overlay);
        }

        // 关闭延期对话框
        function closeExtendDialog() {
            const overlay = document.getElementById('extend-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // 确认延期
        async function confirmExtend(key) {
            const duration = document.getElementById('extend-duration').value;
            const unit = document.getElementById('extend-unit').value;

            if (!duration || isNaN(duration) || duration <= 0) {
                alert('请输入有效的延期时长');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${key}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        duration: parseInt(duration),
                        unit: unit
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('manage-alert', `✅ 密钥延期成功！延长了 ${duration} ${unit === 'minutes' ? '分钟' : unit === 'hours' ? '小时' : unit === 'days' ? '天' : '月'}`, 'success');
                    loadKeys(currentPage);
                    closeExtendDialog();
                } else {
                    showAlert('manage-alert', `❌ 延期失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `❌ 延期失败: ${error.message}`, 'danger');
            }
        }

        // 删除密钥
        async function deleteKey(key) {
            if (!isAuthenticated) {
                showAlert('manage-alert', '❌ 请先登录后再进行删除操作', 'danger');
                return;
            }

            if (!confirm('确定要删除这个密钥吗？此操作不可恢复！')) return;

            try {
                const response = await fetch(`${API_BASE}/keys?path=delete&key=${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('manage-alert', '✅ 密钥删除成功', 'success');
                    loadKeys(currentPage);
                } else {
                    showAlert('manage-alert', `❌ 删除失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `❌ 删除失败: ${error.message}`, 'danger');
            }
        }

        // 清理过期密钥
        async function cleanupExpiredKeys() {
            const deleteExpired = confirm('是否同时删除过期超过7天的密钥？\n点击"确定"删除，点击"取消"仅更新状态');
            
            try {
                const response = await fetch(`${API_BASE}/keys/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deleteExpired: deleteExpired ? 7 : 0
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    showAlert('manage-alert', `✅ 清理完成！更新了 ${data.updatedExpired} 个过期密钥，删除了 ${data.deletedExpired} 个密钥`, 'success');
                    loadKeys(currentPage);
                    loadStats(); // 刷新统计数据
                } else {
                    showAlert('manage-alert', `❌ 清理失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `❌ 清理失败: ${error.message}`, 'danger');
            }
        }

        // 加载活跃用户会话
        async function loadActiveSessions() {
            if (!isAuthenticated) {
                showAlert('sessions-alert', '❌ 请先登录', 'danger');
                return;
            }

            try {
                const container = document.getElementById('sessions-container');
                container.innerHTML = '<div class="spinner"></div><p>正在加载活跃用户会话...</p>';
                container.className = 'loading';

                const response = await fetch(`${API_BASE}/sessions/active`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayActiveSessions(result.data);
                } else {
                    showAlert('sessions-alert', `❌ 加载失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `❌ 加载失败: ${error.message}`, 'danger');
            }
        }

        // 显示活跃用户会话
        function displayActiveSessions(sessions) {
            const container = document.getElementById('sessions-container');
            container.className = '';

            if (sessions.length === 0) {
                container.innerHTML = '<div class="no-data">📭 当前没有活跃用户会话</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>会话ID</th>
                                <th>使用的密钥</th>
                                <th>用户代理</th>
                                <th>IP地址</th>
                                <th>最后活动</th>
                                <th>会话时长</th>
                                <th>密钥状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sessions.forEach(session => {
                const lastActivity = new Date(session.lastActivity).toLocaleString('zh-CN');
                const duration = formatDuration(session.duration);
                const userAgent = session.userAgent.length > 50 ? 
                    session.userAgent.substring(0, 50) + '...' : session.userAgent;

                html += `
                    <tr>
                        <td><code>${session.sessionId.substring(0, 8)}...</code></td>
                        <td><code>${session.keyId}</code></td>
                        <td title="${session.userAgent}">${userAgent}</td>
                        <td>${session.clientIP}</td>
                        <td>${lastActivity}</td>
                        <td>${duration}</td>
                        <td>
                            <span class="badge badge-${getKeyStatusColor(session.keyDetails.status)}">
                                ${getKeyStatusText(session.keyDetails.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="extendUserKey('${session.keyId}')">
                                ⏰ 延期
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="disableUserKey('${session.keyId}')">
                                🚫 禁用
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // 格式化持续时间
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}小时${minutes % 60}分钟`;
            } else if (minutes > 0) {
                return `${minutes}分钟${seconds % 60}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

        // 延期用户密钥
        async function extendUserKey(keyId) {
            if (!isAuthenticated) {
                showAlert('sessions-alert', '❌ 请先登录', 'danger');
                return;
            }

            const hours = prompt('请输入要延期的小时数:', '24');
            if (!hours || isNaN(hours) || hours <= 0) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${keyId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ hours: parseInt(hours) })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('sessions-alert', `✅ 密钥 ${keyId} 已延期 ${hours} 小时`, 'success');
                    loadActiveSessions(); // 刷新会话列表
                } else {
                    showAlert('sessions-alert', `❌ 延期失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `❌ 延期失败: ${error.message}`, 'danger');
            }
        }

        // 禁用用户密钥
        async function disableUserKey(keyId) {
            if (!isAuthenticated) {
                showAlert('sessions-alert', '❌ 请先登录', 'danger');
                return;
            }

            if (!confirm(`确定要禁用密钥 ${keyId} 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${keyId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('sessions-alert', `✅ 密钥 ${keyId} 已被禁用`, 'success');
                    loadActiveSessions(); // 刷新会话列表
                } else {
                    showAlert('sessions-alert', `❌ 禁用失败: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `❌ 禁用失败: ${error.message}`, 'danger');
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载统计数据
            loadStats();
            
            // 时间单位选择事件监听器
            document.getElementById('time-unit').addEventListener('change', (e) => {
                const unit = e.target.value;
                const durationInput = document.getElementById('duration');
                
                switch(unit) {
                    case 'hours':
                        durationInput.max = 720;
                        durationInput.placeholder = '最多720小时';
                        break;
                    case 'days':
                        durationInput.max = 30;
                        durationInput.placeholder = '最多30天';
                        break;
                    case 'months':
                        durationInput.max = 12;
                        durationInput.placeholder = '最多12个月';
                        break;
                }
                
                // 如果当前值超过新的限制，重置为最大值
                if (parseInt(durationInput.value) > parseInt(durationInput.max)) {
                    durationInput.value = durationInput.max;
                }
            });
        });

        // 数据库管理相关函数
        let dbCurrentPage = 1;
        const dbPageSize = 20;

        // 显示数据库子标签页
        function showDbTab(tabName) {
            document.querySelectorAll('.db-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.db-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'db-overview') {
                loadDatabaseInfo();
            } else if (tabName === 'pk10-data') {
                loadPK10Stats();
                loadPK10Data();
            }
        }

        // 加载数据库信息
        async function loadDatabaseInfo() {
            try {
                const response = await fetch(`${API_BASE}/database/info`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('db-info-container');
                    container.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>数据库总数</h3>
                                <p class="stat-value">${result.data.databases.length}</p>
                            </div>
                            <div class="stat-card">
                                <h3>总集合数</h3>
                                <p class="stat-value">${result.data.totalCollections}</p>
                            </div>
                            <div class="stat-card">
                                <h3>总文档数</h3>
                                <p class="stat-value">${result.data.totalDocuments}</p>
                            </div>
                            <div class="stat-card">
                                <h3>数据库大小</h3>
                                <p class="stat-value">${(result.data.totalSize / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <div class="database-list">
                            <h3>数据库详情</h3>
                            ${result.data.databases.map(db => `
                                <div class="database-item">
                                    <h4>${db.name}</h4>
                                    <p>集合数: ${db.collections.length}</p>
                                    <p>文档数: ${db.totalDocuments}</p>
                                    <p>大小: ${(db.sizeOnDisk / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    showAlert('db-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('db-alert', '加载数据库信息失败: ' + error.message, 'error');
            }
        }

        // 加载PK10统计信息
        async function loadPK10Stats() {
            try {
                const response = await fetch(`${API_BASE}/database/pk10/stats`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-stats-container');
                    container.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>总记录数</h3>
                                <p class="stat-value">${result.data.totalRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>今日记录</h3>
                                <p class="stat-value">${result.data.todayRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>近7天记录</h3>
                                <p class="stat-value">${result.data.last7DaysRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>数据库大小</h3>
                                <p class="stat-value">${(result.data.dbSize / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <div class="date-range">
                            <p>数据范围: ${result.data.oldestRecord} 至 ${result.data.latestRecord}</p>
                        </div>
                    `;
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', '加载PK10统计信息失败: ' + error.message, 'error');
            }
        }

        // 加载PK10数据
        async function loadPK10Data(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/database/pk10/data?page=${page}&limit=${dbPageSize}`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-data-container');
                    container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>期号</th>
                                    <th>开奖时间</th>
                                    <th>开奖号码</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.data.map(item => `
                                    <tr>
                                        <td>${item.期号}</td>
                                        <td>${new Date(item.开奖时间).toLocaleString()}</td>
                                        <td>${item.开奖号码}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="deletePK10Record('${item._id}')">删除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // 更新分页
                    updatePK10Pagination(result.data.pagination);
                    dbCurrentPage = page;
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', '加载PK10数据失败: ' + error.message, 'error');
            }
        }

        // 更新PK10分页
        function updatePK10Pagination(pagination) {
            const container = document.getElementById('pk10-pagination');
            const { currentPage, totalPages, hasNext, hasPrev } = pagination;

            container.innerHTML = `
                <button class="pagination-btn" ${!hasPrev ? 'disabled' : ''} onclick="loadPK10Data(${currentPage - 1})">上一页</button>
                <span>第 ${currentPage} 页，共 ${totalPages} 页</span>
                <button class="pagination-btn" ${!hasNext ? 'disabled' : ''} onclick="loadPK10Data(${currentPage + 1})">下一页</button>
            `;
        }

        // 搜索PK10数据
        async function searchPK10Data() {
            const issueValue = document.getElementById('pk10-search-issue').value;
            const dateValue = document.getElementById('pk10-search-date').value;

            if (!issueValue.trim() && !dateValue.trim()) {
                showAlert('pk10-alert', '请输入期号或选择日期进行搜索', 'warning');
                return;
            }

            try {
                let url = `${API_BASE}/database/pk10/search?`;
                if (issueValue.trim()) {
                    url += `period=${encodeURIComponent(issueValue)}`;
                } else if (dateValue.trim()) {
                    url += `date=${encodeURIComponent(dateValue)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-data-container');
                    container.innerHTML = `
                        <div class="search-results">
                            <p>搜索结果: 共找到 ${result.data.length} 条记录</p>
                            <button class="btn btn-secondary" onclick="loadPK10Data()">返回全部数据</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>期号</th>
                                    <th>开奖时间</th>
                                    <th>开奖号码</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(item => `
                                    <tr>
                                        <td>${item.期号}</td>
                                        <td>${new Date(item.开奖时间).toLocaleString()}</td>
                                        <td>${item.开奖号码}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="deletePK10Record('${item._id}')">删除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // 隐藏分页
                    document.getElementById('pk10-pagination').innerHTML = '';
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', '搜索失败: ' + error.message, 'error');
            }
        }

        // 删除PK10记录
        async function deletePK10Record(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/database/pk10/data/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('pk10-alert', '记录删除成功', 'success');
                    loadPK10Data(dbCurrentPage);
                    loadPK10Stats();
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', '删除失败: ' + error.message, 'error');
            }
        }

        // 备份数据库
        async function backupDatabase() {
            const dbName = document.getElementById('backup-db').value;
            
            try {
                showAlert('backup-alert', '正在备份数据库，请稍候...', 'info');
                
                const response = await fetch(`${API_BASE}/database/backup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ database: dbName })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('backup-alert', `备份成功！文件保存在: ${result.data.backupPath}`, 'success');
                } else {
                    showAlert('backup-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('backup-alert', '备份失败: ' + error.message, 'error');
            }
        }

        // 清理数据库
        async function cleanupDatabase() {
            const dbName = document.getElementById('cleanup-database').value;
            const collection = document.getElementById('cleanup-collection').value;
            const days = document.getElementById('cleanup-days').value;

            if (!days || days < 1) {
                showAlert('maintenance-alert', '请输入有效的天数', 'warning');
                return;
            }

            if (!confirm(`确定要删除 ${days} 天前的数据吗？此操作不可恢复！`)) {
                return;
            }

            try {
                showAlert('maintenance-alert', '正在清理数据，请稍候...', 'info');
                
                const response = await fetch(`${API_BASE}/database/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        database: dbName,
                        collection: collection,
                        days: parseInt(days)
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('maintenance-alert', `清理完成！删除了 ${result.data.deletedCount} 条记录`, 'success');
                    if (dbName === 'taiwan_pk10') {
                        loadPK10Stats();
                        loadPK10Data();
                    }
                } else {
                    showAlert('maintenance-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('maintenance-alert', '清理失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>