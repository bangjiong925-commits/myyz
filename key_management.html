<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†é’¥ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* æ•°æ®åº“ç®¡ç†æ ‡ç­¾é¡µæ ·å¼ */
        .db-tab-content {
            display: none;
            padding: 20px 0;
        }

        .db-tab-content.active {
            display: block;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }

        .stat-card .description {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-inactive {
            background: #e2e3e5;
            color: #6c757d;
        }

        .key-display {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”‘ å¯†é’¥ç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®‰å…¨ã€é«˜æ•ˆçš„APIå¯†é’¥ç®¡ç†è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ä»ªè¡¨æ¿</button>
            <button class="nav-tab" onclick="showTab('create')">åˆ›å»ºå¯†é’¥</button>
            <button class="nav-tab" onclick="showTab('validate')">éªŒè¯å¯†é’¥</button>
            <button class="nav-tab" onclick="showTab('manage')">ç®¡ç†å¯†é’¥</button>
            <button class="nav-tab" onclick="showTab('database')">æ•°æ®åº“ç®¡ç†</button>
            <button class="nav-tab" onclick="showTab('sessions')">ç”¨æˆ·ä¼šè¯</button>
        </div>

        <!-- ä»ªè¡¨æ¿ -->
        <div id="dashboard" class="tab-content active">
            <h2>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
            <div id="stats-container" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</p>
            </div>
        </div>

        <!-- åˆ›å»ºå¯†é’¥ -->
        <div id="create" class="tab-content">
            <h2>â• åˆ›å»ºæ–°å¯†é’¥</h2>
            <div id="create-alert"></div>
            <form id="create-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="duration">æœ‰æ•ˆæœŸ*</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="duration" class="form-control" min="1" value="24" required style="flex: 2;">
                            <select id="time-unit" class="form-control" style="flex: 1;">
                                <option value="minutes">åˆ†é’Ÿ</option>
                                <option value="hours">å°æ—¶</option>
                                <option value="days">å¤©</option>
                                <option value="months">æœˆ</option>
                            </select>
                        </div>
                        <small style="color: #666; font-size: 12px;">æœ€é•¿ï¼š60åˆ†é’Ÿ / 720å°æ—¶ / 30å¤© / 12ä¸ªæœˆ</small>
                    </div>
                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <input type="text" id="description" class="form-control" placeholder="å¯†é’¥ç”¨é€”æè¿°">
                    </div>
                </div>
                <div class="form-group">
                    <label for="custom-key">è‡ªå®šä¹‰å¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="custom-key" class="form-control" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                </div>
                <button type="submit" class="btn btn-primary">ğŸ”‘ åˆ›å»ºå¯†é’¥</button>
            </form>
        </div>

        <!-- éªŒè¯å¯†é’¥ -->
        <div id="validate" class="tab-content">
            <h2>ğŸ” éªŒè¯å¯†é’¥</h2>
            <div id="validate-alert"></div>
            <form id="validate-form">
                <div class="form-group">
                    <label for="validate-key">å¯†é’¥*</label>
                    <input type="text" id="validate-key" class="form-control" placeholder="è¯·è¾“å…¥è¦éªŒè¯çš„å¯†é’¥" required>
                </div>
                <button type="submit" class="btn btn-success">âœ… éªŒè¯å¯†é’¥</button>
            </form>
            <div id="validate-result"></div>
        </div>

        <!-- ç®¡ç†å¯†é’¥ -->
        <div id="manage" class="tab-content">
            <h2>ğŸ› ï¸ å¯†é’¥ç®¡ç†</h2>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="status-filter">çŠ¶æ€ç­›é€‰</label>
                    <select id="status-filter" class="form-control" onchange="loadKeys()">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">æ´»è·ƒ</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                        <option value="inactive">æœªæ¿€æ´»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-warning" onclick="cleanupExpiredKeys()">ğŸ§¹ æ¸…ç†è¿‡æœŸå¯†é’¥</button>
                </div>
            </div>
            <div id="manage-alert"></div>
            <div id="keys-container" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½å¯†é’¥åˆ—è¡¨...</p>
            </div>
        </div>

        <!-- æ•°æ®åº“ç®¡ç† -->
        <div id="database" class="tab-content">
            <h2>ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†</h2>
            
            <!-- æ•°æ®åº“ç®¡ç†å­å¯¼èˆª -->
            <div class="nav-tabs" style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button class="nav-tab active" onclick="showDatabaseTab('overview')">æ•°æ®åº“æ¦‚è§ˆ</button>
                <button class="nav-tab" onclick="showDatabaseTab('pk10')">PK10æ•°æ®ç®¡ç†</button>
                <button class="nav-tab" onclick="showDatabaseTab('backup')">å¤‡ä»½ä¸æ¢å¤</button>
                <button class="nav-tab" onclick="showDatabaseTab('maintenance')">ç»´æŠ¤å·¥å…·</button>
            </div>

            <!-- æ•°æ®åº“æ¦‚è§ˆ -->
            <div id="db-overview" class="db-tab-content active">
                <h3>ğŸ“Š æ•°æ®åº“æ¦‚è§ˆ</h3>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" onclick="loadDatabaseInfo()">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
                    </div>
                </div>
                <div id="database-alert"></div>
                <div id="database-info-container" class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ•°æ®åº“ä¿¡æ¯...</p>
                </div>
            </div>

            <!-- PK10æ•°æ®ç®¡ç† -->
            <div id="db-pk10" class="db-tab-content">
                <h3>ğŸ² PK10æ•°æ®ç®¡ç†</h3>
                
                <!-- æœç´¢å’Œè¿‡æ»¤ -->
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="pk10-search-issue">æœŸå·æœç´¢</label>
                        <input type="text" id="pk10-search-issue" class="form-control" placeholder="è¾“å…¥æœŸå·">
                    </div>
                    <div class="form-group">
                        <label for="pk10-search-date">æ—¥æœŸ</label>
                        <input type="date" id="pk10-search-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" onclick="searchPK10Data()">ğŸ” æœç´¢</button>
                        <button type="button" class="btn btn-secondary" onclick="loadPK10Data()">ğŸ“‹ æ˜¾ç¤ºå…¨éƒ¨</button>
                    </div>
                </div>

                <!-- æç¤ºä¿¡æ¯ -->
                <div id="pk10-alert" style="margin-top: 20px;"></div>

                <!-- PK10ç»Ÿè®¡ä¿¡æ¯ -->
                <div id="pk10-stats-container" class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½PK10ç»Ÿè®¡ä¿¡æ¯...</p>
                </div>

                <!-- PK10æ•°æ®åˆ—è¡¨ -->
                <div id="pk10-data-container" class="loading" style="margin-top: 20px;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½PK10æ•°æ®...</p>
                </div>

                <!-- åˆ†é¡µæ§ä»¶ -->
                <div id="pk10-pagination" class="pagination-container" style="margin-top: 20px;"></div>
            </div>

            <!-- å¤‡ä»½ä¸æ¢å¤ -->
            <div id="db-backup" class="db-tab-content">
                <h3>ğŸ’¾ å¤‡ä»½ä¸æ¢å¤</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ•°æ®åº“å¤‡ä»½</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="backup-databases" class="form-control" multiple style="height: 80px;">
                                <option value="taiwan_pk10">taiwan_pk10 (PK10æ•°æ®)</option>
                                <option value="myyz_db">myyz_db (å¯†é’¥ç®¡ç†)</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="backupDatabase()">ğŸ“¥ åˆ›å»ºå¤‡ä»½</button>
                        </div>
                        <small style="color: #666; font-size: 12px;">æŒ‰ä½Ctrl/Cmdé€‰æ‹©å¤šä¸ªæ•°æ®åº“</small>
                    </div>
                </div>

                <div id="backup-alert" style="margin-top: 20px;"></div>
            </div>

            <!-- ç»´æŠ¤å·¥å…· -->
            <div id="db-maintenance" class="db-tab-content">
                <h3>ğŸ”§ ç»´æŠ¤å·¥å…·</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¸…ç†æ—§æ•°æ®</label>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label for="cleanup-database" style="font-size: 12px;">æ•°æ®åº“</label>
                                <select id="cleanup-database" class="form-control">
                                    <option value="taiwan_pk10">taiwan_pk10</option>
                                    <option value="myyz_db">myyz_db</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label for="cleanup-collection" style="font-size: 12px;">é›†åˆ</label>
                                <select id="cleanup-collection" class="form-control">
                                    <option value="pk10_results">pk10_results</option>
                                    <option value="api_keys">api_keys</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label for="cleanup-days" style="font-size: 12px;">ä¿ç•™å¤©æ•°</label>
                                <input type="number" id="cleanup-days" class="form-control" min="1" value="30">
                            </div>
                            <button type="button" class="btn btn-danger" onclick="cleanupDatabase()">ğŸ—‘ï¸ æ¸…ç†</button>
                        </div>
                        <small style="color: #666; font-size: 12px;">å°†åˆ é™¤æŒ‡å®šå¤©æ•°ä¹‹å‰çš„æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ</small>
                    </div>
                </div>

                <div id="maintenance-alert" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¼šè¯ -->
        <div id="sessions" class="tab-content">
            <h2>ğŸ‘¥ æ´»è·ƒç”¨æˆ·ä¼šè¯</h2>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-primary" onclick="loadActiveSessions()">ğŸ”„ åˆ·æ–°ä¼šè¯</button>
                </div>
            </div>
            <div id="sessions-alert"></div>
            <div id="sessions-container" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ´»è·ƒç”¨æˆ·ä¼šè¯...</p>
            </div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
        function getApiBase() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ç¯å¢ƒ
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3002/api';
            }
            
            // å¦‚æœæ˜¯Verceléƒ¨ç½²ç¯å¢ƒï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„çš„API
            if (hostname.includes('vercel.app')) {
                return '/api';
            }
            
            // å…¶ä»–ç¯å¢ƒï¼Œä½¿ç”¨å½“å‰åŸŸåçš„API
            return `${protocol}//${hostname}/api`;
        }
        
        const API_BASE = getApiBase();
        let currentPage = 1;
        const pageSize = 10;
        let isAuthenticated = true; // ç§»é™¤ç™»å½•åŠŸèƒ½åï¼Œç›´æ¥è®¾ç½®ä¸ºtrue

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'dashboard') {
                loadStats();
            } else if (tabName === 'manage') {
                loadKeys();
            } else if (tabName === 'database') {
                loadDatabaseInfo();
            } else if (tabName === 'sessions') {
                loadActiveSessions();
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/keys?path=stats`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('stats-container').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>${stats.total}</h3>
                                <p>æ€»å¯†é’¥æ•°</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.active}</h3>
                                <p>æ´»è·ƒå¯†é’¥</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.expired}</h3>
                                <p>å·²è¿‡æœŸ</p>
                            </div>
                            <div class="stat-card">
                                <h3>${stats.used}</h3>
                                <p>å·²ä½¿ç”¨</p>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            ğŸ“… æœ€åæ›´æ–°: ${new Date(stats.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('stats-container').innerHTML = `
                    <div class="alert alert-danger">
                        âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('create-alert', 'âœ… å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('create-alert', 'âœ… å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            });
        }

        // æ—¶é—´å•ä½éªŒè¯
        function validateDuration(duration, unit) {
            const durationNum = parseInt(duration);
            
            if (unit === 'hours' && durationNum > 720) {
                return 'å°æ—¶æ•°ä¸èƒ½è¶…è¿‡720å°æ—¶';
            }
            if (unit === 'days' && durationNum > 30) {
                return 'å¤©æ•°ä¸èƒ½è¶…è¿‡30å¤©';
            }
            if (unit === 'months' && durationNum > 12) {
                return 'æœˆæ•°ä¸èƒ½è¶…è¿‡12ä¸ªæœˆ';
            }
            return null;
        }

        // åˆ›å»ºå¯†é’¥
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const duration = document.getElementById('duration').value;
            const unit = document.getElementById('time-unit').value;
            const description = document.getElementById('description').value;
            const customKey = document.getElementById('custom-key').value;

            // å‰ç«¯éªŒè¯
            const validationError = validateDuration(duration, unit);
            if (validationError) {
                showAlert('create-alert', `âŒ ${validationError}`, 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys?path=create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        duration: parseInt(duration),
                        unit,
                        description,
                        customKey: customKey || undefined
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('create-alert', `
                        âœ… å¯†é’¥åˆ›å»ºæˆåŠŸï¼<br>
                        <div class="key-display" style="margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <strong>å¯†é’¥:</strong> 
                                <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-family: monospace;">${result.data.key}</code>
                                <button onclick="copyToClipboard('${result.data.key}')" class="btn btn-sm" style="background: #28a745; color: white; padding: 4px 8px;">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                            æœ‰æ•ˆæœŸ: ${result.data.totalDuration}<br>
                            åˆ°æœŸæ—¶é—´: ${new Date(result.data.expiresAt).toLocaleString()}
                        </div>
                    `, 'success');
                    document.getElementById('create-form').reset();
                    document.getElementById('duration').value = '24';
                } else {
                    showAlert('create-alert', `âŒ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('create-alert', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'danger');
            }
        });

        // éªŒè¯å¯†é’¥
        document.getElementById('validate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const key = document.getElementById('validate-key').value.trim();

            try {
                const response = await fetch(`${API_BASE}/keys?path=validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ key })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    document.getElementById('validate-result').innerHTML = `
                        <div class="alert alert-success" style="margin-top: 20px;">
                            âœ… å¯†é’¥éªŒè¯æˆåŠŸï¼<br>
                            <div class="key-display" style="margin-top: 10px;">
                                å¯†é’¥: ${data.key}<br>
                                æè¿°: ${data.description || 'æ— '}<br>
                                çŠ¶æ€: <span class="status-badge status-${data.status}">${data.status}</span><br>
                                åˆ›å»ºæ—¶é—´: ${new Date(data.createdAt).toLocaleString()}<br>
                                æ¿€æ´»æ—¶é—´: ${new Date(data.activatedAt).toLocaleString()}<br>
                                åˆ°æœŸæ—¶é—´: ${new Date(data.expiresAt).toLocaleString()}<br>
                                æ€»æ—¶é•¿: ${data.totalDuration}<br>
                                å‰©ä½™æ—¶é—´: ${data.remainingTime}<br>
                                ä½¿ç”¨æ¬¡æ•°: ${data.usageCount}
                            </div>
                        </div>
                    `;
                    showAlert('validate-alert', 'âœ… å¯†é’¥éªŒè¯æˆåŠŸ', 'success');
                } else {
                    document.getElementById('validate-result').innerHTML = `
                        <div class="alert alert-danger" style="margin-top: 20px;">
                            âŒ ${result.message}
                        </div>
                    `;
                    showAlert('validate-alert', `âŒ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('validate-alert', `âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'danger');
                document.getElementById('validate-result').innerHTML = '';
            }
        });

        // åŠ è½½å¯†é’¥åˆ—è¡¨
        async function loadKeys(page = 1) {
            currentPage = page;
            const status = document.getElementById('status-filter').value;
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: pageSize
                });
                
                if (status) params.append('status', status);

                const response = await fetch(`${API_BASE}/keys?path=list&${params}`);
                const result = await response.json();

                if (result.success) {
                    const keys = result.data;
                    const pagination = result.pagination;

                    let tableHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>å¯†é’¥</th>
                                        <th>æè¿°</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>å‰©ä½™æ—¶é—´</th>
                                        <th>ä½¿ç”¨æ¬¡æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    keys.forEach(key => {
                        const statusClass = key.isExpired ? 'expired' : key.status;
                        tableHTML += `
                            <tr>
                                <td><div class="key-display">${key.key.substring(0, 16)}...</div></td>
                                <td>${key.description || 'æ— '}</td>
                                <td><span class="status-badge status-${statusClass}">${key.status}</span></td>
                                <td>${new Date(key.createdAt).toLocaleString()}</td>
                                <td>${key.remainingTime}</td>
                                <td>${key.usageCount || 0}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewKeyDetails('${key.key}')">è¯¦æƒ…</button>
                                    <button class="btn btn-sm btn-warning" onclick="extendKey('${key.key}')">å»¶æœŸ</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteKey('${key.key}')">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                    });

                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    // æ·»åŠ åˆ†é¡µ
                    if (pagination.pages > 1) {
                        tableHTML += `
                            <div class="pagination">
                                <button onclick="loadKeys(${Math.max(1, pagination.page - 1)})" ${pagination.page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                                <span>ç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.pages} é¡µ</span>
                                <button onclick="loadKeys(${Math.min(pagination.pages, pagination.page + 1)})" ${pagination.page === pagination.pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                            </div>
                        `;
                    }

                    document.getElementById('keys-container').innerHTML = tableHTML;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('keys-container').innerHTML = `
                    <div class="alert alert-danger">
                        âŒ åŠ è½½å¯†é’¥åˆ—è¡¨å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æŸ¥çœ‹å¯†é’¥è¯¦æƒ…
        async function viewKeyDetails(key) {
            try {
                const response = await fetch(`${API_BASE}/keys?path=details&key=${key}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    alert(`å¯†é’¥è¯¦æƒ…:
å¯†é’¥: ${data.key}
æè¿°: ${data.description || 'æ— '}
çŠ¶æ€: ${data.status}
åˆ›å»ºæ—¶é—´: ${new Date(data.createdAt).toLocaleString()}
æ¿€æ´»æ—¶é—´: ${data.activatedAt ? new Date(data.activatedAt).toLocaleString() : 'æœªæ¿€æ´»'}
åˆ°æœŸæ—¶é—´: ${new Date(data.expiresAt).toLocaleString()}
æ€»æ—¶é•¿: ${data.totalDuration}
å‰©ä½™æ—¶é—´: ${data.remainingTime}
ä½¿ç”¨æ¬¡æ•°: ${data.usageCount || 0}
æœ€åä½¿ç”¨: ${data.lastUsed ? new Date(data.lastUsed).toLocaleString() : 'ä»æœªä½¿ç”¨'}`);
                } else {
                    alert(`è·å–è¯¦æƒ…å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                alert(`è·å–è¯¦æƒ…å¤±è´¥: ${error.message}`);
            }
        }

        // å»¶é•¿å¯†é’¥
        async function extendKey(key) {
            if (!isAuthenticated) {
                showAlert('manage-alert', 'âŒ è¯·å…ˆç™»å½•åå†è¿›è¡Œå»¶æœŸæ“ä½œ', 'danger');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæ›´å‹å¥½çš„å»¶æœŸå¯¹è¯æ¡†
            const extendDialog = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; margin: 20px auto;">
                    <h4 style="margin-bottom: 15px; color: #333;">ğŸ•’ å»¶æœŸå¯†é’¥</h4>
                    <p style="margin-bottom: 15px; color: #666;">å¯†é’¥: <code>${key}</code></p>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">å»¶æœŸæ—¶é•¿:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="extend-duration" min="1" value="24" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="extend-unit" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="minutes">åˆ†é’Ÿ</option>
                                <option value="hours" selected>å°æ—¶</option>
                                <option value="days">å¤©</option>
                                <option value="months">æœˆ</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeExtendDialog()" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="confirmExtend('${key}')" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">ç¡®è®¤å»¶æœŸ</button>
                    </div>
                </div>
            `;

            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.id = 'extend-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            overlay.innerHTML = extendDialog;
            document.body.appendChild(overlay);
        }

        // å…³é—­å»¶æœŸå¯¹è¯æ¡†
        function closeExtendDialog() {
            const overlay = document.getElementById('extend-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ç¡®è®¤å»¶æœŸ
        async function confirmExtend(key) {
            const duration = document.getElementById('extend-duration').value;
            const unit = document.getElementById('extend-unit').value;

            if (!duration || isNaN(duration) || duration <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å»¶æœŸæ—¶é•¿');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${key}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        duration: parseInt(duration),
                        unit: unit
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('manage-alert', `âœ… å¯†é’¥å»¶æœŸæˆåŠŸï¼å»¶é•¿äº† ${duration} ${unit === 'minutes' ? 'åˆ†é’Ÿ' : unit === 'hours' ? 'å°æ—¶' : unit === 'days' ? 'å¤©' : 'æœˆ'}`, 'success');
                    loadKeys(currentPage);
                    closeExtendDialog();
                } else {
                    showAlert('manage-alert', `âŒ å»¶æœŸå¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `âŒ å»¶æœŸå¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // åˆ é™¤å¯†é’¥
        async function deleteKey(key) {
            if (!isAuthenticated) {
                showAlert('manage-alert', 'âŒ è¯·å…ˆç™»å½•åå†è¿›è¡Œåˆ é™¤æ“ä½œ', 'danger');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const response = await fetch(`${API_BASE}/keys?path=delete&key=${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('manage-alert', 'âœ… å¯†é’¥åˆ é™¤æˆåŠŸ', 'success');
                    loadKeys(currentPage);
                } else {
                    showAlert('manage-alert', `âŒ åˆ é™¤å¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // æ¸…ç†è¿‡æœŸå¯†é’¥
        async function cleanupExpiredKeys() {
            const deleteExpired = confirm('æ˜¯å¦åŒæ—¶åˆ é™¤è¿‡æœŸè¶…è¿‡7å¤©çš„å¯†é’¥ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"åˆ é™¤ï¼Œç‚¹å‡»"å–æ¶ˆ"ä»…æ›´æ–°çŠ¶æ€');
            
            try {
                const response = await fetch(`${API_BASE}/keys/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deleteExpired: deleteExpired ? 7 : 0
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    showAlert('manage-alert', `âœ… æ¸…ç†å®Œæˆï¼æ›´æ–°äº† ${data.updatedExpired} ä¸ªè¿‡æœŸå¯†é’¥ï¼Œåˆ é™¤äº† ${data.deletedExpired} ä¸ªå¯†é’¥`, 'success');
                    loadKeys(currentPage);
                    loadStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                } else {
                    showAlert('manage-alert', `âŒ æ¸…ç†å¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('manage-alert', `âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // åŠ è½½æ´»è·ƒç”¨æˆ·ä¼šè¯
        async function loadActiveSessions() {
            if (!isAuthenticated) {
                showAlert('sessions-alert', 'âŒ è¯·å…ˆç™»å½•', 'danger');
                return;
            }

            try {
                const container = document.getElementById('sessions-container');
                container.innerHTML = '<div class="spinner"></div><p>æ­£åœ¨åŠ è½½æ´»è·ƒç”¨æˆ·ä¼šè¯...</p>';
                container.className = 'loading';

                const response = await fetch(`${API_BASE}/sessions/active`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayActiveSessions(result.data);
                } else {
                    showAlert('sessions-alert', `âŒ åŠ è½½å¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // æ˜¾ç¤ºæ´»è·ƒç”¨æˆ·ä¼šè¯
        function displayActiveSessions(sessions) {
            const container = document.getElementById('sessions-container');
            container.className = '';

            if (sessions.length === 0) {
                container.innerHTML = '<div class="no-data">ğŸ“­ å½“å‰æ²¡æœ‰æ´»è·ƒç”¨æˆ·ä¼šè¯</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ä¼šè¯ID</th>
                                <th>ä½¿ç”¨çš„å¯†é’¥</th>
                                <th>ç”¨æˆ·ä»£ç†</th>
                                <th>IPåœ°å€</th>
                                <th>æœ€åæ´»åŠ¨</th>
                                <th>ä¼šè¯æ—¶é•¿</th>
                                <th>å¯†é’¥çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sessions.forEach(session => {
                const lastActivity = new Date(session.lastActivity).toLocaleString('zh-CN');
                const duration = formatDuration(session.duration);
                const userAgent = session.userAgent.length > 50 ? 
                    session.userAgent.substring(0, 50) + '...' : session.userAgent;

                html += `
                    <tr>
                        <td><code>${session.sessionId.substring(0, 8)}...</code></td>
                        <td><code>${session.keyId}</code></td>
                        <td title="${session.userAgent}">${userAgent}</td>
                        <td>${session.clientIP}</td>
                        <td>${lastActivity}</td>
                        <td>${duration}</td>
                        <td>
                            <span class="badge badge-${getKeyStatusColor(session.keyDetails.status)}">
                                ${getKeyStatusText(session.keyDetails.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="extendUserKey('${session.keyId}')">
                                â° å»¶æœŸ
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="disableUserKey('${session.keyId}')">
                                ğŸš« ç¦ç”¨
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†é’Ÿ${seconds % 60}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        // å»¶æœŸç”¨æˆ·å¯†é’¥
        async function extendUserKey(keyId) {
            if (!isAuthenticated) {
                showAlert('sessions-alert', 'âŒ è¯·å…ˆç™»å½•', 'danger');
                return;
            }

            const hours = prompt('è¯·è¾“å…¥è¦å»¶æœŸçš„å°æ—¶æ•°:', '24');
            if (!hours || isNaN(hours) || hours <= 0) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${keyId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ hours: parseInt(hours) })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('sessions-alert', `âœ… å¯†é’¥ ${keyId} å·²å»¶æœŸ ${hours} å°æ—¶`, 'success');
                    loadActiveSessions(); // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                } else {
                    showAlert('sessions-alert', `âŒ å»¶æœŸå¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `âŒ å»¶æœŸå¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // ç¦ç”¨ç”¨æˆ·å¯†é’¥
        async function disableUserKey(keyId) {
            if (!isAuthenticated) {
                showAlert('sessions-alert', 'âŒ è¯·å…ˆç™»å½•', 'danger');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ç¦ç”¨å¯†é’¥ ${keyId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${keyId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('sessions-alert', `âœ… å¯†é’¥ ${keyId} å·²è¢«ç¦ç”¨`, 'success');
                    loadActiveSessions(); // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                } else {
                    showAlert('sessions-alert', `âŒ ç¦ç”¨å¤±è´¥: ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert('sessions-alert', `âŒ ç¦ç”¨å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            loadStats();
            
            // æ—¶é—´å•ä½é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('time-unit').addEventListener('change', (e) => {
                const unit = e.target.value;
                const durationInput = document.getElementById('duration');
                
                switch(unit) {
                    case 'hours':
                        durationInput.max = 720;
                        durationInput.placeholder = 'æœ€å¤š720å°æ—¶';
                        break;
                    case 'days':
                        durationInput.max = 30;
                        durationInput.placeholder = 'æœ€å¤š30å¤©';
                        break;
                    case 'months':
                        durationInput.max = 12;
                        durationInput.placeholder = 'æœ€å¤š12ä¸ªæœˆ';
                        break;
                }
                
                // å¦‚æœå½“å‰å€¼è¶…è¿‡æ–°çš„é™åˆ¶ï¼Œé‡ç½®ä¸ºæœ€å¤§å€¼
                if (parseInt(durationInput.value) > parseInt(durationInput.max)) {
                    durationInput.value = durationInput.max;
                }
            });
        });

        // æ•°æ®åº“ç®¡ç†ç›¸å…³å‡½æ•°
        let dbCurrentPage = 1;
        const dbPageSize = 20;

        // æ˜¾ç¤ºæ•°æ®åº“å­æ ‡ç­¾é¡µ
        function showDbTab(tabName) {
            document.querySelectorAll('.db-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.db-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'db-overview') {
                loadDatabaseInfo();
            } else if (tabName === 'pk10-data') {
                loadPK10Stats();
                loadPK10Data();
            }
        }

        // åŠ è½½æ•°æ®åº“ä¿¡æ¯
        async function loadDatabaseInfo() {
            try {
                const response = await fetch(`${API_BASE}/database/info`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('db-info-container');
                    container.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>æ•°æ®åº“æ€»æ•°</h3>
                                <p class="stat-value">${result.data.databases.length}</p>
                            </div>
                            <div class="stat-card">
                                <h3>æ€»é›†åˆæ•°</h3>
                                <p class="stat-value">${result.data.totalCollections}</p>
                            </div>
                            <div class="stat-card">
                                <h3>æ€»æ–‡æ¡£æ•°</h3>
                                <p class="stat-value">${result.data.totalDocuments}</p>
                            </div>
                            <div class="stat-card">
                                <h3>æ•°æ®åº“å¤§å°</h3>
                                <p class="stat-value">${(result.data.totalSize / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <div class="database-list">
                            <h3>æ•°æ®åº“è¯¦æƒ…</h3>
                            ${result.data.databases.map(db => `
                                <div class="database-item">
                                    <h4>${db.name}</h4>
                                    <p>é›†åˆæ•°: ${db.collections.length}</p>
                                    <p>æ–‡æ¡£æ•°: ${db.totalDocuments}</p>
                                    <p>å¤§å°: ${(db.sizeOnDisk / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    showAlert('db-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('db-alert', 'åŠ è½½æ•°æ®åº“ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½PK10ç»Ÿè®¡ä¿¡æ¯
        async function loadPK10Stats() {
            try {
                const response = await fetch(`${API_BASE}/database/pk10/stats`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-stats-container');
                    container.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>æ€»è®°å½•æ•°</h3>
                                <p class="stat-value">${result.data.totalRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>ä»Šæ—¥è®°å½•</h3>
                                <p class="stat-value">${result.data.todayRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>è¿‘7å¤©è®°å½•</h3>
                                <p class="stat-value">${result.data.last7DaysRecords}</p>
                            </div>
                            <div class="stat-card">
                                <h3>æ•°æ®åº“å¤§å°</h3>
                                <p class="stat-value">${(result.data.dbSize / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <div class="date-range">
                            <p>æ•°æ®èŒƒå›´: ${result.data.oldestRecord} è‡³ ${result.data.latestRecord}</p>
                        </div>
                    `;
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', 'åŠ è½½PK10ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½PK10æ•°æ®
        async function loadPK10Data(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/database/pk10/data?page=${page}&limit=${dbPageSize}`);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-data-container');
                    container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æœŸå·</th>
                                    <th>å¼€å¥–æ—¶é—´</th>
                                    <th>å¼€å¥–å·ç </th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.data.map(item => `
                                    <tr>
                                        <td>${item.æœŸå·}</td>
                                        <td>${new Date(item.å¼€å¥–æ—¶é—´).toLocaleString()}</td>
                                        <td>${item.å¼€å¥–å·ç }</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="deletePK10Record('${item._id}')">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // æ›´æ–°åˆ†é¡µ
                    updatePK10Pagination(result.data.pagination);
                    dbCurrentPage = page;
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', 'åŠ è½½PK10æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°PK10åˆ†é¡µ
        function updatePK10Pagination(pagination) {
            const container = document.getElementById('pk10-pagination');
            const { currentPage, totalPages, hasNext, hasPrev } = pagination;

            container.innerHTML = `
                <button class="pagination-btn" ${!hasPrev ? 'disabled' : ''} onclick="loadPK10Data(${currentPage - 1})">ä¸Šä¸€é¡µ</button>
                <span>ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>
                <button class="pagination-btn" ${!hasNext ? 'disabled' : ''} onclick="loadPK10Data(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>
            `;
        }

        // æœç´¢PK10æ•°æ®
        async function searchPK10Data() {
            const issueValue = document.getElementById('pk10-search-issue').value;
            const dateValue = document.getElementById('pk10-search-date').value;

            if (!issueValue.trim() && !dateValue.trim()) {
                showAlert('pk10-alert', 'è¯·è¾“å…¥æœŸå·æˆ–é€‰æ‹©æ—¥æœŸè¿›è¡Œæœç´¢', 'warning');
                return;
            }

            try {
                let url = `${API_BASE}/database/pk10/search?`;
                if (issueValue.trim()) {
                    url += `period=${encodeURIComponent(issueValue)}`;
                } else if (dateValue.trim()) {
                    url += `date=${encodeURIComponent(dateValue)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const container = document.getElementById('pk10-data-container');
                    container.innerHTML = `
                        <div class="search-results">
                            <p>æœç´¢ç»“æœ: å…±æ‰¾åˆ° ${result.data.length} æ¡è®°å½•</p>
                            <button class="btn btn-secondary" onclick="loadPK10Data()">è¿”å›å…¨éƒ¨æ•°æ®</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æœŸå·</th>
                                    <th>å¼€å¥–æ—¶é—´</th>
                                    <th>å¼€å¥–å·ç </th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(item => `
                                    <tr>
                                        <td>${item.æœŸå·}</td>
                                        <td>${new Date(item.å¼€å¥–æ—¶é—´).toLocaleString()}</td>
                                        <td>${item.å¼€å¥–å·ç }</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="deletePK10Record('${item._id}')">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // éšè—åˆ†é¡µ
                    document.getElementById('pk10-pagination').innerHTML = '';
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', 'æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤PK10è®°å½•
        async function deletePK10Record(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/database/pk10/data/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('pk10-alert', 'è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                    loadPK10Data(dbCurrentPage);
                    loadPK10Stats();
                } else {
                    showAlert('pk10-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('pk10-alert', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤‡ä»½æ•°æ®åº“
        async function backupDatabase() {
            const dbName = document.getElementById('backup-db').value;
            
            try {
                showAlert('backup-alert', 'æ­£åœ¨å¤‡ä»½æ•°æ®åº“ï¼Œè¯·ç¨å€™...', 'info');
                
                const response = await fetch(`${API_BASE}/database/backup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ database: dbName })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('backup-alert', `å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶ä¿å­˜åœ¨: ${result.data.backupPath}`, 'success');
                } else {
                    showAlert('backup-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('backup-alert', 'å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç†æ•°æ®åº“
        async function cleanupDatabase() {
            const dbName = document.getElementById('cleanup-database').value;
            const collection = document.getElementById('cleanup-collection').value;
            const days = document.getElementById('cleanup-days').value;

            if (!days || days < 1) {
                showAlert('maintenance-alert', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°', 'warning');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${days} å¤©å‰çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                showAlert('maintenance-alert', 'æ­£åœ¨æ¸…ç†æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
                
                const response = await fetch(`${API_BASE}/database/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        database: dbName,
                        collection: collection,
                        days: parseInt(days)
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('maintenance-alert', `æ¸…ç†å®Œæˆï¼åˆ é™¤äº† ${result.data.deletedCount} æ¡è®°å½•`, 'success');
                    if (dbName === 'taiwan_pk10') {
                        loadPK10Stats();
                        loadPK10Data();
                    }
                } else {
                    showAlert('maintenance-alert', result.message, 'error');
                }
            } catch (error) {
                showAlert('maintenance-alert', 'æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>