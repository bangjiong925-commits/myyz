<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台湾PK五星做号模块</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #3b82f6;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      min-height: 100vh;
      color: var(--gray-800);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .header p {
      color: var(--gray-600);
      font-size: 1.1rem;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .control-group {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .control-group h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .button-group button {
      padding: 8px 16px;
      border: 2px solid var(--gray-200);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--gray-700);
    }
    
    .button-group button:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }
    
    .button-group button.btn-active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .input-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .input-section h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
      transform: translateY(-1px);
    }
    
    .output {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .output h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    #output {
      font-family: 'Courier New', monospace;
      background: var(--gray-50);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
      min-height: 100px;
      white-space: pre-wrap;
      color: var(--gray-700);
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .table-header {
      background: var(--primary);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .table-header h3 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }
    
    .table-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .table-controls label {
      color: white;
      font-weight: 500;
    }
    
    .table-controls select {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: white;
      color: var(--gray-700);
      font-weight: 500;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th, td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
    }
    
    th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-700);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:hover {
      background: var(--gray-50);
    }
    
    .hit-0 { background-color: #fee2e2; color: #991b1b; }
    .hit-1 { background-color: #fef3c7; color: #92400e; }
    .hit-2 { background-color: #d1fae5; color: #065f46; }
    .hit-3 { background-color: #dbeafe; color: #1e40af; }
    .hit-4 { background-color: #e0e7ff; color: #3730a3; }
    .hit-5 { background-color: #f3e8ff; color: #581c87; }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .file-input-wrapper:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .status-info {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .status-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 150px;
    }
    
    .status-card h4 {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .status-card .value {
      color: var(--primary);
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    
    .theme-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }
    
    .help-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--warning);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    
    .help-btn:hover {
      background: #d97706;
      transform: scale(1.1);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      margin: 20px;
    }
    
    .modal-content h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .modal-content p {
      margin-bottom: 15px;
      line-height: 1.6;
      color: var(--gray-700);
    }
    
    .modal-content ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }
    
    .modal-content li {
      margin-bottom: 8px;
      color: var(--gray-700);
    }
    
    .close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
      margin-top: -10px;
    }
    
    .close-btn:hover {
      color: var(--gray-700);
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .table-controls {
        justify-content: center;
      }
      
      .status-info {
        flex-direction: column;
      }
    }
    
    /* 深色主题 */
    .dark-theme {
      --gray-50: #1f2937;
      --gray-100: #374151;
      --gray-200: #4b5563;
      --gray-300: #6b7280;
      --gray-400: #9ca3af;
      --gray-500: #d1d5db;
      --gray-600: #e5e7eb;
      --gray-700: #f3f4f6;
      --gray-800: #f9fafb;
      --gray-900: #ffffff;
    }
    
    .dark-theme body {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: var(--gray-800);
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" title="切换主题">🌙</button>
  <button class="help-btn" onclick="showHelp()" title="帮助">❓</button>
  
  <!-- 密钥倒计时通知栏 -->
  <div id="keyCountdown" class="fixed top-0 left-0 right-0 bg-primary text-white text-center py-2 z-40 hidden">
    <span>密钥有效期剩余: <strong id="timeRemaining">0天 0小时 0分钟 0秒</strong></span>
  </div>

  <div class="container">
    <div class="header">
      <h1>🎯 台湾PK五星做号模块</h1>
      <p>智能分析历史数据，精准预测中奖号码</p>
    </div>
    
    <div class="status-info">
      <div class="status-card">
        <h4>已录入期数</h4>
        <div class="value" id="periodCount">0</div>
      </div>
      <div class="status-card">
        <h4>当前期数</h4>
        <div class="value" id="currentPeriod">-</div>
      </div>
      <div class="status-card">
        <h4>自动获取</h4>
        <div class="value" id="autoStatus">关闭</div>
      </div>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <h3>🎲 胆码数量选择</h3>
        <div class="button-group" id="numButtons"></div>
      </div>
      
      <div class="control-group">
        <h3>🎯 中出筛选</h3>
        <div class="button-group" id="hitButtons"></div>
      </div>
    </div>
    
    <div class="input-section">
      <h3>📝 数据录入</h3>
      <textarea id="numbersInput" placeholder="请输入历史开奖数据，格式：期数 号码1 号码2 ... 号码10\n例如：\n20240101 01 02 03 04 05 06 07 08 09 10\n20240102 02 03 04 05 06 07 08 09 10 11"></textarea>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="manualCalc()">📊 手动计算</button>
        <button class="btn btn-success" onclick="startAutoFetch()">🔄 开始自动获取</button>
        <button class="btn btn-warning" onclick="stopAutoFetch()">⏹️ 停止自动获取</button>
        <div class="file-input-wrapper">
          📁 选择文件
          <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileSelect(event)">
        </div>
        <button class="btn btn-warning" onclick="clearData()">🗑️ 清空数据</button>
      </div>
    </div>
    
    <div class="output">
      <h3>📋 操作结果</h3>
      <div id="output">等待数据输入...</div>
    </div>
    
    <div class="table-container" id="tableContainer">
      <div class="table-header">
        <h3>📈 分析结果</h3>
        <div class="table-controls">
          <label for="periodSelect">显示期数:</label>
          <select id="periodSelect" onchange="updateDisplayPeriods()">
            <option value="10">最近10期</option>
            <option value="20">最近20期</option>
            <option value="30" selected>最近30期</option>
            <option value="50">最近50期</option>
            <option value="100">最近100期</option>
            <option value="all">全部</option>
          </select>
          
          <label for="sortSelect">排序方式:</label>
          <select id="sortSelect" onchange="updateSortMethod()">
            <option value="hit" selected>按连中次数</option>
            <option value="miss">按遗漏次数</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="resultTable">
          <thead>
            <tr>
              <th>号码</th>
              <th>连中次数</th>
              <th>遗漏次数</th>
              <th>出现频率</th>
              <th>推荐指数</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- 帮助模态框 -->
  <div id="helpModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" onclick="hideHelp()">&times;</button>
      <h3>📖 使用说明</h3>
      
      <p><strong>🎯 功能介绍：</strong></p>
      <p>台湾PK五星做号模块是一个专业的彩票分析工具，通过分析历史开奖数据，为您提供科学的号码推荐。</p>
      
      <p><strong>📝 数据录入方式：</strong></p>
      <ul>
        <li><strong>手动录入：</strong>在文本框中输入历史开奖数据</li>
        <li><strong>文件导入：</strong>支持导入.txt或.csv格式的数据文件</li>
        <li><strong>自动获取：</strong>自动从数据源获取最新开奖信息</li>
      </ul>
      
      <p><strong>📊 分析功能：</strong></p>
      <ul>
        <li><strong>胆码分析：</strong>选择1-10个胆码进行重点分析</li>
        <li><strong>中出筛选：</strong>根据历史中奖情况筛选号码</li>
        <li><strong>频率统计：</strong>统计各号码的出现频率和遗漏情况</li>
        <li><strong>智能推荐：</strong>基于多维度分析给出推荐指数</li>
      </ul>
      
      <p><strong>🎨 界面功能：</strong></p>
      <ul>
        <li><strong>主题切换：</strong>支持明暗两种主题模式</li>
        <li><strong>数据筛选：</strong>可选择显示不同期数的分析结果</li>
        <li><strong>排序功能：</strong>支持按连中次数或遗漏次数排序</li>
      </ul>
      
      <p><strong>⚠️ 重要提示：</strong></p>
      <p>本工具仅供娱乐和学习使用，不构成任何投资建议。彩票具有随机性，请理性参与，量力而行。</p>
    </div>
  </div>
  
  <!-- 密钥验证模态框 -->
  <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">请输入访问密钥</h3>
        <p class="text-gray-600">该功能需要有效的访问密钥才能使用</p>
        <p class="text-sm text-gray-500 mt-2">请联系管理员获取有效密钥</p>
      </div>
      
      <div class="mb-4">
        <input type="text" id="keyInput" placeholder="请输入32位访问密钥" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
      </div>
      
      <div class="flex gap-3">
        <button id="verifyKeyBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md font-medium hover:bg-primary/80 transition-colors">验证密钥</button>
        <!-- 移除取消按钮 -->
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let history = [];
    let period = 1;
    let autoFetchTimer = null;
    let fileHandle = null;
    let seenPeriods = new Set();
    let latestCheckedPeriod = null;
    let fileReaderTimer = null;
    let sortByHit = true; // true=按连中次数排序, false=按遗漏次数排序
    let displayPeriods = 30; // 默认显示30期数据

// 密钥验证相关变量
let isKeyValid = false;
const KEY_STORAGE_KEY = 'pk4_access_key';
const KEY_MODAL = document.getElementById('keyModal');
const KEY_INPUT = document.getElementById('keyInput');

// DOM元素
    const outputEl = document.getElementById('output');
    const tableContainer = document.getElementById('tableContainer');
    const horizontalThumb = document.getElementById('horizontalThumb');
    const horizontalFill = document.getElementById('horizontalFill');
    const verticalSlider = document.getElementById('verticalSlider');
    const verticalThumb = document.getElementById('verticalThumb');
    const verticalFill = document.getElementById('verticalFill');
    
    // 初始化胆码数按钮
    const numButtons = document.getElementById('numButtons');
    for(let i=1; i<=10; i++){
      const b = document.createElement('button');
      b.className = 'px-3 py-1 rounded-md bg-gray-200 btn-hover';
      b.dataset.num = i;
      b.textContent = i;
      numButtons.appendChild(b);
    }
    
    // 初始化中出按钮
    const hitButtons = document.getElementById('hitButtons');
    [0, 1, 2, 3, 4, 5].forEach(h => {
      const b = document.createElement('button');
      b.className = 'px-3 py-1 rounded-md bg-gray-200 btn-hover';
      b.dataset.hit = h;
      b.textContent = h + '胆';
      hitButtons.appendChild(b);
    });
    
    // 单选按钮组
    function singleSelect(btns) {
      btns.forEach(b => b.addEventListener('click', () => {
        btns.forEach(x => x.classList.remove('btn-active'));
        b.classList.add('btn-active');
        renderTable();
      }));
    }
    
    // 多选按钮组
    function multiToggle(btns) {
      btns.forEach(b => b.addEventListener('click', () => {
        b.classList.toggle('btn-active');
        renderTable();
      }));
    }
    
    // 设置默认选中 - 胆码数默认改为5
    document.querySelector('#numButtons button[data-num="5"]').classList.add('btn-active');
    document.querySelector('#hitButtons button[data-hit="2"]').classList.add('btn-active');
    
    // 初始化按钮事件
singleSelect(Array.from(numButtons.children));
multiToggle(Array.from(hitButtons.children));

// 密钥倒计时更新函数
let countdownInterval = null;

function updateKeyCountdown(expirationTimestamp) {
    const countdownEl = document.getElementById('keyCountdown');
    const timeEl = document.getElementById('timeRemaining');
    
    // 清除之前的定时器
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    function updateDisplay() {
        const now = new Date();
        const expirationDate = new Date(expirationTimestamp * 1000);
        const timeDiff = expirationDate - now;
        
        if (timeDiff <= 0) {
            // 密钥已过期
            timeEl.textContent = '已过期';
            countdownEl.classList.remove('bg-primary', 'bg-amber-500');
            countdownEl.classList.add('bg-red-500');
            clearInterval(countdownInterval);
            
            // 清除本地存储的密钥信息
            const fileId = generateFileIdentifier();
            localStorage.removeItem(`validKey_${fileId}`);
            localStorage.removeItem(`keyExpiry_${fileId}`);
            isKeyValid = false;
            
            // 3秒后自动刷新页面
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
            return;
        }
        
        // 计算剩余时间
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        // 更新显示
        timeEl.textContent = `${days}天 ${hours}小时 ${minutes}分钟 ${seconds}秒`;
        
        // 设置样式（根据剩余时间改变背景色）
        const totalHours = days * 24 + hours;
        if (totalHours <= 24) {
            countdownEl.classList.remove('bg-primary', 'bg-amber-500');
            countdownEl.classList.add('bg-red-500');
        } else if (totalHours <= 72) {
            countdownEl.classList.remove('bg-primary', 'bg-red-500');
            countdownEl.classList.add('bg-amber-500');
        } else {
            countdownEl.classList.remove('bg-amber-500', 'bg-red-500');
            countdownEl.classList.add('bg-primary');
        }
    }
    
    // 立即更新一次
    updateDisplay();
    countdownEl.classList.remove('hidden');
    
    // 每秒更新一次
    countdownInterval = setInterval(updateDisplay, 1000);
}

// 添加设备指纹生成函数（从密钥生成器复制）
function generateDeviceFingerprint() {
    const userAgent = navigator.userAgent;
    const screenResolution = screen.width + 'x' + screen.height;
    const timezoneOffset = new Date().getTimezoneOffset();
    const language = navigator.language;
    
    const fingerprintRaw = userAgent + screenResolution + timezoneOffset + language;
    let hash = 0;
    for (let i = 0; i < fingerprintRaw.length; i++) {
        const char = fingerprintRaw.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 转换为32位整数
    }
    return Math.abs(hash).toString(36);
}

/*
跨平台密钥一次性验证实现说明：

当前实现：
- 使用localStorage作为本地存储，确保在同一浏览器中密钥只能使用一次
- 包含云端API调用框架，但目前使用httpbin.org作为演示

真正的跨平台实现需要：
1. 部署专门的后端服务（如Node.js + MongoDB/Redis）
2. 创建API端点：
   - GET /api/nonce/check/{nonce} - 检查nonce是否已使用
   - POST /api/nonce/mark - 标记nonce为已使用
3. 在后端维护全局的已使用nonce数据库
4. 可选：添加nonce过期清理机制

部署建议：
- 使用免费的云服务如Vercel、Netlify Functions、Railway等
- 数据库可使用MongoDB Atlas、Redis Cloud等免费方案
- 确保API具有适当的速率限制和安全措施
*/

// 跨平台nonce验证API函数
async function checkNonceUsed(nonce) {
    try {
        // 首先检查本地记录
        const localNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
        if (localNonces.includes(nonce)) {
            return { used: true, source: 'local' };
        }
        
        // 检查云端记录（演示用httpbin.org，实际应替换为真实API）
        const response = await fetch(`https://httpbin.org/get?nonce=${nonce}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            // 这里应该根据实际API返回格式判断nonce是否已使用
            // 目前使用httpbin.org作为演示，总是返回未使用
            console.log('云端nonce检查结果:', data);
            return { used: false, source: 'cloud' };
        } else {
            console.warn('云端nonce检查失败，使用本地记录');
            return { used: false, source: 'local_fallback' };
        }
    } catch (error) {
        console.warn('云端nonce检查失败，使用本地记录:', error);
        return { used: false, source: 'local_fallback' };
    }
}

// 标记nonce为已使用
async function markNonceAsUsed(nonce) {
    try {
        // 尝试在云端记录（演示用httpbin.org，实际应替换为真实API）
        const response = await fetch('https://httpbin.org/post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nonce: nonce, action: 'mark_used' })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('云端nonce记录成功:', data);
            return { success: true };
        } else {
            console.warn('云端记录失败，使用本地记录');
        }
    } catch (error) {
        console.warn('云端记录失败，使用本地记录:', error);
    }
    
    // 云端记录失败时，使用本地记录作为备份
    const localNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
    if (!localNonces.includes(nonce)) {
        localNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(localNonces));
        console.log('本地记录nonce:', nonce);
    }
    return { success: true };
}

// 密钥验证按钮事件
const verifyKeyBtn = document.getElementById('verifyKeyBtn');
verifyKeyBtn.addEventListener('click', async function() {
    const key = KEY_INPUT.value.trim();
    if (!key) {
        alert('请输入密钥');
        return;
    }
    
    // 显示验证中状态
    this.disabled = true;
    this.textContent = '验证中...';
    
    try {
        const result = await verifyKey(key);
        if (result.valid) {
            // 记录已使用的nonce到云端
            await markNonceAsUsed(result.data.nonce);
            
            // 使用文件唯一标识存储密钥
            const fileId = generateFileIdentifier();
            localStorage.setItem(`validKey_${fileId}`, key);
            localStorage.setItem(`keyExpiry_${fileId}`, result.data.expiry);
            
            // 确保模态框隐藏
            KEY_MODAL.classList.add('hidden');
            KEY_MODAL.style.display = 'none';
            
            // 更新密钥状态和倒计时
            isKeyValid = true;
            updateKeyCountdown(result.data.expiry);
        } else {
            alert('密钥验证失败: ' + result.reason);
        }
    } catch (e) {
        console.error('密钥验证过程出错:', e);
        alert('验证过程中发生错误: ' + e.message);
    } finally {
        // 恢复按钮状态
        this.disabled = false;
        this.textContent = '验证密钥';
    }
});


// 页面加载时检查保存的密钥
window.addEventListener('load', function() {
    try {
        const fileId = generateFileIdentifier();
        const validKey = localStorage.getItem(`validKey_${fileId}`);
        const keyExpiry = localStorage.getItem(`keyExpiry_${fileId}`);
        
        if (validKey && keyExpiry) {
            const currentTime = Math.floor(new Date().getTime() / 1000);
            const expiryTime = parseInt(keyExpiry);
            
            if (currentTime < expiryTime) {
                // 密钥有效，直接更新倒计时
                isKeyValid = true;
                updateKeyCountdown(expiryTime);
                KEY_MODAL.classList.add('hidden');
                KEY_MODAL.style.display = 'none';
            } else {
                // 密钥已过期，清除本地存储并显示过期提示
                localStorage.removeItem(`validKey_${fileId}`);
                localStorage.removeItem(`keyExpiry_${fileId}`);
                alert('您的密钥已过期，请重新验证新的密钥');
                KEY_MODAL.classList.remove('hidden');
                KEY_MODAL.style.display = 'flex';
            }
        } else {
            // 密钥不存在，显示验证模态框
            KEY_MODAL.classList.remove('hidden');
            KEY_MODAL.style.display = 'flex';
        }
    } catch (e) {
        console.error('页面加载时密钥检查出错:', e);
        KEY_MODAL.classList.remove('hidden');
        KEY_MODAL.style.display = 'flex';
    }
});

// 解析输入数据
function parseInput(line) {
      // 处理文件行数据，支持多种分隔符
      let parts;
      if (line.includes('\t')) {
        parts = line.trim().split(/\t+/);
      } else if (line.includes(' ')) {
        parts = line.trim().split(/\s+/);
      } else {
        return null;
      }
      
      if (parts.length < 2) return null;
      
      const period = parts[0].trim();
      
      // 尝试多种可能的数字分隔符
      let nums;
      if (parts[1].includes(',')) {
        nums = parts[1].split(',').map(n => parseInt(n.trim(), 10));
      } else if (parts[1].includes(' ')) {
        nums = parts[1].split(' ').map(n => parseInt(n.trim(), 10));
      } else {
        return null;
      }
      
      if (nums.length !== 10 || nums.some(isNaN)) return null;
      
      return { period, data: nums };
    }

// 密钥验证函数
async function verifyKey(key) {
    try {
        // 分步解码并添加错误捕获
        const decodedB64 = atob(key);
        const jsonStr = decodeURIComponent(escape(decodedB64));
        const keyData = JSON.parse(jsonStr);
        
        // 验证必要字段存在
        if (!keyData.expiry || !keyData.nonce || !keyData.deviceFingerprint) {
            return { valid: false, reason: '密钥缺少必要字段' };
        }

        const currentTime = new Date().getTime();
        
        // 修改时间比较逻辑，将当前时间转换为秒级时间戳
        if (Math.floor(currentTime / 1000) > keyData.expiry) {
            return { valid: false, reason: '密钥已过期' };
        }

        // 2. 设备指纹验证（新增）
        const currentFingerprint = generateDeviceFingerprint();
        if (keyData.deviceFingerprint !== currentFingerprint) {
            return { valid: false, reason: '此密钥不可在当前设备使用' };
        }

        // 检查密钥是否已被使用（跨平台验证）
        const nonceCheckResult = await checkNonceUsed(keyData.nonce);
        if (nonceCheckResult.used) {
            return { valid: false, reason: '密钥已被使用，每个密钥只能使用一次' };
        }
        
        return { valid: true, data: keyData };
    } catch (e) {
        // 详细错误类型判断
        if (e instanceof DOMException && e.name === 'InvalidCharacterError') {
            return { valid: false, reason: '密钥Base64解码失败' };
        } else if (e instanceof SyntaxError) {
            return { valid: false, reason: '密钥JSON格式无效' };
        } else {
            return { valid: false, reason: '验证过程异常: ' + e.message };
        }
    }
}

// 手动录入
function manualCalc() {
    if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('请先验证有效的密钥');
        return;
    }
  const lines = document.getElementById('numbersInput').value.trim().split(/\n+/).filter(Boolean);
  if (!lines.length) {
    outputEl.textContent = '请输入数据';
    return;
  }
      
      let addedCount = 0;
      for (const l of lines) {
        const parsed = parseInput(l);
        if (!parsed) {
          outputEl.textContent = '格式错误：请输入正确的数据格式';
          return;
        }
        
        const { period, data } = parsed;
        const fmt = data.join(',');
        
        // 检查是否已存在相同期数或相同数据
        if (seenPeriods.has(period) || (history.length && history[history.length-1].input === fmt)) continue;
        
        history.push({ period, data, input: fmt });
        seenPeriods.add(period);
        addedCount++;
      }
      
      document.getElementById('numbersInput').value = '';
      outputEl.textContent = addedCount > 0 ? `成功添加 ${addedCount} 期数据` : '没有新数据添加';
      document.getElementById('periodCount').textContent = history.length;
      
      if (history.length > 0) {
        document.getElementById('currentPeriod').textContent = history[history.length-1].period;
        renderTable();
      }
    }
    
    // 文件选择处理
    function handleFileSelect(event) {
        if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('请先验证有效的密钥');
        return;
    }
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('numbersInput').value = content;
        outputEl.textContent = `文件 "${file.name}" 加载完成，请点击手动计算处理数据`;
      };
      reader.readAsText(file);
    }
    
    // 自动获取开始
    function startAutoFetch() {
        if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('请先验证有效的密钥');
        return;
    }
      if (autoFetchTimer) {
        outputEl.textContent = '自动获取已在运行中';
        return;
      }
      
      // 模拟自动获取逻辑
      autoFetchTimer = setInterval(() => {
        // 这里应该是实际的数据获取逻辑
        // 目前只是模拟
        const mockPeriod = `2024${String(Math.floor(Math.random() * 365) + 1).padStart(3, '0')}`;
        const mockData = Array.from({length: 10}, () => Math.floor(Math.random() * 80) + 1).sort((a,b) => a-b);
        
        if (!seenPeriods.has(mockPeriod)) {
          history.push({ period: mockPeriod, data: mockData, input: mockData.join(',') });
          seenPeriods.add(mockPeriod);
          
          document.getElementById('periodCount').textContent = history.length;
          document.getElementById('currentPeriod').textContent = mockPeriod;
          outputEl.textContent = `自动获取: ${mockPeriod} - ${mockData.join(' ')}`;
          renderTable();
        }
      }, 5000); // 每5秒获取一次
      
      document.getElementById('autoStatus').textContent = '运行中';
      outputEl.textContent = '自动获取已启动，每5秒检查一次新数据';
    }
    
    // 停止自动获取
    function stopAutoFetch() {
      if (autoFetchTimer) {
        clearInterval(autoFetchTimer);
        autoFetchTimer = null;
        document.getElementById('autoStatus').textContent = '关闭';
        outputEl.textContent = '自动获取已停止';
      } else {
        outputEl.textContent = '自动获取未在运行';
      }
    }
    
    // 清空数据
    function clearData() {
      history = [];
      seenPeriods.clear();
      document.getElementById('periodCount').textContent = '0';
      document.getElementById('currentPeriod').textContent = '-';
      document.getElementById('numbersInput').value = '';
      outputEl.textContent = '数据已清空';
      renderTable();
    }
    
    // 更新显示期数
    function updateDisplayPeriods() {
      const select = document.getElementById('periodSelect');
      displayPeriods = select.value === 'all' ? history.length : parseInt(select.value);
      renderTable();
    }
    
    // 更新排序方式
    function updateSortMethod() {
      const select = document.getElementById('sortSelect');
      sortByHit = select.value === 'hit';
      renderTable();
    }
    
    // 生成文件唯一标识
    function generateFileIdentifier() {
      // 使用当前页面URL和用户代理生成唯一标识
      const identifier = window.location.href + navigator.userAgent;
      let hash = 0;
      for (let i = 0; i < identifier.length; i++) {
        const char = identifier.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(36);
    }
    
    // 渲染分析表格
    function renderTable() {
      if (history.length === 0) {
        document.querySelector('#resultTable tbody').innerHTML = '<tr><td colspan="5">暂无数据</td></tr>';
        return;
      }
      
      const selectedNum = parseInt(document.querySelector('#numButtons .btn-active')?.dataset.num || '5');
      const selectedHits = Array.from(document.querySelectorAll('#hitButtons .btn-active')).map(b => parseInt(b.dataset.hit));
      
      // 获取要分析的期数
      const periodsToAnalyze = Math.min(displayPeriods, history.length);
      const recentHistory = history.slice(-periodsToAnalyze);
      
      // 统计每个号码的出现情况
      const stats = {};
      for (let num = 1; num <= 80; num++) {
        stats[num] = {
          hits: 0,
          misses: 0,
          frequency: 0,
          lastAppear: -1,
          consecutiveHits: 0,
          consecutiveMisses: 0
        };
      }
      
      // 分析历史数据
      recentHistory.forEach((entry, index) => {
        entry.data.forEach(num => {
          stats[num].hits++;
          stats[num].lastAppear = index;
        });
        
        // 计算遗漏
        for (let num = 1; num <= 80; num++) {
          if (!entry.data.includes(num)) {
            stats[num].misses++;
          }
        }
      });
      
      // 计算频率和连续情况
      Object.keys(stats).forEach(num => {
        const stat = stats[num];
        stat.frequency = (stat.hits / periodsToAnalyze * 100).toFixed(1);
        stat.consecutiveMisses = periodsToAnalyze - 1 - stat.lastAppear;
        
        // 计算连续中出次数
        let consecutive = 0;
        for (let i = recentHistory.length - 1; i >= 0; i--) {
          if (recentHistory[i].data.includes(parseInt(num))) {
            consecutive++;
          } else {
            break;
          }
        }
        stat.consecutiveHits = consecutive;
      });
      
      // 转换为数组并排序
      let sortedStats = Object.entries(stats).map(([num, stat]) => ({
        num: parseInt(num),
        ...stat,
        score: calculateScore(stat, periodsToAnalyze)
      }));
      
      // 根据选择的排序方式排序
      if (sortByHit) {
        sortedStats.sort((a, b) => b.consecutiveHits - a.consecutiveHits || b.hits - a.hits);
      } else {
        sortedStats.sort((a, b) => b.consecutiveMisses - a.consecutiveMisses || a.hits - b.hits);
      }
      
      // 筛选符合条件的号码
      let filteredStats = sortedStats;
      if (selectedHits.length > 0) {
        filteredStats = sortedStats.filter(stat => selectedHits.includes(stat.consecutiveHits));
      }
      
      // 取前N个号码
      const topStats = filteredStats.slice(0, selectedNum);
      
      // 渲染表格
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = topStats.map(stat => {
        const hitClass = `hit-${Math.min(stat.consecutiveHits, 5)}`;
        return `
          <tr class="${hitClass}">
            <td><strong>${stat.num.toString().padStart(2, '0')}</strong></td>
            <td>${stat.consecutiveHits}</td>
            <td>${stat.consecutiveMisses}</td>
            <td>${stat.frequency}%</td>
            <td>${stat.score.toFixed(1)}</td>
          </tr>
        `;
      }).join('');
      
      // 更新输出信息
      const selectedNumbers = topStats.map(s => s.num.toString().padStart(2, '0')).join(' ');
      outputEl.textContent = `推荐号码 (${selectedNum}胆): ${selectedNumbers}\n分析期数: ${periodsToAnalyze}期\n排序方式: ${sortByHit ? '连中次数' : '遗漏次数'}`;
    }
    
    // 计算推荐分数
    function calculateScore(stat, totalPeriods) {
      const hitRate = stat.hits / totalPeriods;
      const missRate = stat.consecutiveMisses / totalPeriods;
      const hitBonus = stat.consecutiveHits * 2;
      
      // 综合评分：命中率 + 遗漏加分 + 连中加分
      return (hitRate * 50) + (missRate * 30) + hitBonus;
    }
    
    // 主题切换
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const isDark = document.body.classList.contains('dark-theme');
      document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // 显示帮助
    function showHelp() {
      document.getElementById('helpModal').classList.remove('hidden');
    }
    
    // 隐藏帮助
    function hideHelp() {
      document.getElementById('helpModal').classList.add('hidden');
    }
    
    // 页面加载时恢复主题
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        document.querySelector('.theme-toggle').textContent = '☀️';
      }
    });
    
    // 点击模态框外部关闭
    document.getElementById('helpModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideHelp();
      }
    });
    
    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideHelp();
      }
    });
  </script>
</body>
</html>