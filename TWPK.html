<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>台湾PK数据分析工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981'
          }
        }
      }
    }
  </script>
  
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .sticky-col {
    position: sticky;
    z-index: 50;
  }
  .header-title {
    transition: transform 0.3s ease, opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    overflow: hidden;
  }
  .header-title.hidden-on-scroll {
    transform: translateY(-100%);
    opacity: 0;
    height: 0;
    padding: 0;
    pointer-events: none;
  }
  .toolbar-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    transition: all 0.3s ease;
  }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .hit-cell {
        @apply bg-primary/20 text-primary font-bold;
      }
      .miss-cell {
        @apply text-gray-400;
      }
      .btn-active {
        @apply bg-primary text-white;
      }
      .btn-hover {
        @apply hover:bg-primary/80 hover:text-white transition-colors duration-200;
      }
      
      /* 按钮悬停变色为FF7373 - 仅在支持hover的设备上生效，但排除特殊按钮 */
      @media (hover: hover) {
        button:hover:not(.position-btn):not(.hit-number-btn):not(.dama-btn):not(.btn-active) {
          background-color: #FF7373 !important;
          transition: background-color 0.2s ease;
        }
      }
      
      /* 移动端触摸反馈 - 避免保持hover状态，但排除特殊按钮 */
      @media (hover: none) {
        button:active:not(.position-btn):not(.hit-number-btn):not(.dama-btn):not(.btn-active) {
          background-color: #FF7373 !important;
          transition: background-color 0.1s ease;
        }
      }
      
      /* 防止移动端双击放大和意外缩放 */
      * {
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      /* 允许输入框和文本区域选择文本 */
      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      
      /* 胆码按钮特殊处理 - 确保触摸反馈正常 */
      .dama-btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* 胆码按钮未选中状态 - 覆盖全局hover样式 */
      @media (hover: hover) {
        .dama-btn:not(.bg-primary):hover {
          background-color: #e5e7eb !important; /* gray-200 */
          color: #374151 !important; /* gray-700 */
        }
      }
      
      /* 胆码按钮选中状态保持红色 */
      .dama-btn.bg-primary {
        background-color: #d62828 !important;
        color: white !important;
      }
      
      @media (hover: hover) {
        .dama-btn.bg-primary:hover {
          background-color: #b91c1c !important; /* 稍深的红色 */
          color: white !important;
        }
      }
      
      /* 位置选择按钮样式 */
      .position-btn {
        cursor: pointer !important;
        pointer-events: auto !important;
        user-select: none !important;
        transition: all 0.2s ease !important;
      }
      
      .position-btn:not(.btn-active) {
        background-color: #e5e7eb !important; /* gray-200 */
        color: #374151 !important; /* gray-700 */
      }
      
      .position-btn.btn-active,
      .position-btn.bg-primary {
        background-color: #3b82f6 !important; /* blue-500 */
        color: white !important;
      }
      
      @media (hover: hover) {
        .position-btn:not(.btn-active):hover {
          background-color: #d1d5db !important; /* gray-300 */
          color: #374151 !important;
        }
        
        .position-btn.btn-active:hover,
        .position-btn.bg-primary:hover {
          background-color: #2563eb !important; /* blue-600 */
          color: white !important;
        }
      }
      
      /* 移动端位置按钮触摸反馈 */
      @media (hover: none) {
        .position-btn:active {
          transform: scale(0.95) !important;
          transition: transform 0.1s ease !important;
        }
      }
      
      /* 命中数字按钮样式 */
      .hit-number-btn.bg-primary {
        background-color: #10b981 !important; /* emerald-500 */
        color: white !important;
      }
      
      @media (hover: hover) {
        .hit-number-btn.bg-primary:hover {
          background-color: #059669 !important; /* emerald-600 */
          color: white !important;
        }
      }
      
      /* 防止页面缩放 */
      html {
        -ms-touch-action: manipulation;
        touch-action: manipulation;
      }
      .number-row {
        @apply flex justify-center space-x-1 mb-1;
      }
      
      /* 手机端五星做号页面优化 */
      @media (max-width: 768px) {
        /* 移除主容器的左右边距 */
        #fiveStarPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除模块容器的边距和圆角 */
        #fiveStarPage .bg-white {
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 移除模块间距 */
        #modules-container {
          gap: 8px !important;
          padding: 0 !important;
        }
        
        /* 移除模块边框和圆角 */
        .five-star-module {
          border: none !important;
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 优化数字按钮尺寸 - 确保一行放10个 */
        .number-btn {
          width: calc(10% - 2px) !important;
          height: 32px !important;
          min-width: 28px !important;
          font-size: 13px !important;
          padding: 0 !important;
          margin: 1px !important;
          flex-shrink: 0 !important; /* 防止按钮收缩 */
        }
        
        /* 优化数字按钮容器 - 确保不换行 */
        .number-buttons {
          gap: 0 !important;
          margin-bottom: 8px !important;
          flex-wrap: nowrap !important; /* 强制不换行 */
          overflow-x: auto !important; /* 如果内容过宽则允许横向滚动 */
        }
        
        /* 优化胆码按钮 */
        .dama-btn {
          font-size: 13px !important;
          padding: 4px 8px !important;
          margin: 1px !important;
        }
        
        /* 优化胆码按钮容器 */
        .dama-buttons {
          gap: 2px !important;
          margin-bottom: 8px !important;
        }
        
        /* 优化筛选组间距 */
        .filter-group {
          margin-bottom: 8px !important;
          padding-bottom: 8px !important;
        }
        
        /* 优化模块总容错区域 */
        .module-tolerance {
          margin-bottom: 8px !important;
          padding: 8px !important;
        }
      }
      
      /* 手机端黄金切割页面优化 */
      @media (max-width: 768px) {
        /* 移除黄金切割页面主容器的左右边距 */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除主模块的边距和圆角 */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          padding: 12px !important;
          margin: 0 !important;
          box-shadow: none !important;
        }
        
        /* 优化模式选择按钮 */
        #goldenRatioPage .flex.justify-center.gap-3 {
          gap: 8px !important;
        }
        
        #goldenRatioPage button[data-mode] {
          padding: 8px 16px !important;
          font-size: 14px !important;
        }
        
        /* 优化输入区域 */
        #goldenInputData {
          padding: 8px !important;
          font-size: 14px !important;
        }
        
        /* 优化操作按钮 */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 {
          gap: 6px !important;
          flex-wrap: wrap !important;
        }
        
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          flex: 1 !important;
          min-width: 80px !important;
        }
        
        /* 优化结果显示区域 */
        #goldenRatioPage .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-5 {
          grid-template-columns: 1fr 1fr !important;
          gap: 4px !important;
        }
        
        /* 优化验证结果区域 */
        #validationResults {
          padding: 8px !important;
          margin-top: 12px !important;
        }
        
        /* 优化标题和摘要 */
        #goldenRatioPage h3 {
          font-size: 16px !important;
        }
        
        #goldenRatioPage .text-sm {
          font-size: 12px !important;
        }
      }
      
      /* 手机端黄金切割页面优化 */
      @media (max-width: 768px) {
        /* 移除黄金切割页面主容器的左右边距 */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除主模块的边框、圆角和阴影 */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          box-shadow: none !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 优化模式选择按钮 */
        #goldenRatioPage .flex.justify-center.gap-3 button {
          padding: 8px 16px !important;
          font-size: 14px !important;
          margin: 2px !important;
        }
        
        /* 优化输入区域 */
        #goldenRatioPage textarea {
          padding: 8px !important;
          font-size: 14px !important;
          border-radius: 4px !important;
        }
        
        /* 优化操作按钮 */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          margin: 2px !important;
        }
        
        /* 优化结果显示区域 */
        #goldenRatioPage .grid.gap-2 {
          gap: 4px !important;
        }
        
        /* 优化验证结果区域 */
        #goldenRatioPage #validationResults {
          padding: 8px !important;
          margin-top: 8px !important;
          border-radius: 4px !important;
        }
        
        /* 减少各区域的边距 */
        #goldenRatioPage .mb-6 {
          margin-bottom: 12px !important;
        }
        
        #goldenRatioPage .mb-4 {
          margin-bottom: 8px !important;
        }
        
        #goldenRatioPage .mb-2 {
          margin-bottom: 4px !important;
        }
      }
      .fixed-width-period {
        width: 120px;
        transition: opacity 0.3s ease;
      }
      .fixed-width-data {
        width: 150px;
        transition: left 0.3s ease;
      }
      .table-header-sticky {
        position: sticky;
        top: 0;
        z-index: 1002;
        background-color: #f9fafb;
      }
      .sticky-bg-white {
        background-color: white !important;
      }
      .sticky-bg-gray-100 {
        background-color: #f3f4f6 !important;
      }
      
      /* 自定义滚动条样式 */
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 3px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb:hover {
        background-color: #9ca3af;
      }
      
      .scrollbar-track-gray-100::-webkit-scrollbar-track {
        background-color: #f3f4f6;
        border-radius: 3px;
      }
      
      /* 黄金切割结果容器样式 */
      #goldenResults {
        scroll-behavior: smooth;
      }
      
      #goldenResults::-webkit-scrollbar {
        height: 8px;
      }
      
      #goldenResults::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      /* 模式切换按钮样式 */
      .active-mode {
        background-color: #3b82f6 !important;
        color: white !important;
      }
      
      .inactive-mode {
        background-color: #d1d5db !important;
        color: #374151 !important;
      }
      .sticky-bg-gray-50 {
        background-color: #f9fafb !important;
      }
      .slider-container {
        @apply relative h-6 mt-2 mb-4;
      }
      .slider-track {
        @apply absolute h-2 w-full bg-gray-200 rounded-full;
      }
      .slider-thumb {
        @apply absolute w-5 h-5 bg-primary rounded-full cursor-pointer -mt-1.5 -ml-2.5;
      }
      .slider-fill {
        @apply absolute h-2 bg-primary rounded-full;
      }
      .vertical-slider-container {
        @apply absolute right-0 top-0 h-full w-4 flex items-center justify-center z-10;
      }
      .vertical-slider-track {
        @apply absolute h-full w-1 bg-gray-200 rounded-full;
      }
      .vertical-slider-thumb {
        @apply absolute w-4 h-6 bg-primary rounded-md cursor-pointer -ml-1.5;
      }
      .vertical-slider-fill {
        @apply absolute w-1 bg-primary rounded-full;
      }
      /* 限制表格容器高度，最多显示50行 */
      .table-container {
        max-height: calc(100vh - 400px); /* 页面一屏高度减去其他元素高度 */
        overflow-y: auto;
        position: relative;
      }
      
      /* 手机端全屏模式样式 */
      @media (max-width: 768px) {
        /* 全屏模式下的工具栏样式 */
        .fullscreen-toolbar {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 1000 !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* 全屏模式下隐藏的元素 */
        .fullscreen-hidden {
          transform: translateY(-100%) !important;
          transition: transform 0.3s ease-in-out !important;
        }
        
        /* 全屏模式下主内容区域的调整 */
        .fullscreen-main {
          padding-top: 50px !important;
          transition: padding-top 0.3s ease-in-out !important;
        }
        
        /* 优化手机端滚动性能 */
        body {
          -webkit-overflow-scrolling: touch;
        }
        
        /* 全屏模式下的工具栏按钮优化 */
        .fullscreen-toolbar .container {
          padding-left: 1rem !important;
          padding-right: 1rem !important;
        }
        
        .fullscreen-toolbar button {
          font-size: 14px !important;
          padding: 0.5rem 1rem !important;
        }
        
        /* 防止全屏切换时的闪烁 */
        header * {
          backface-visibility: hidden;
          -webkit-backface-visibility: hidden;
        }
        
        /* 全屏模式下的阴影效果 */
        .fullscreen-toolbar::after {
          content: '';
          position: absolute;
          bottom: -8px;
          left: 0;
          right: 0;
          height: 8px;
          background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
          pointer-events: none;
        }
      }
    }
  </style>
  
  <script>
    // 滚动时隐藏标题，保留工具栏
    let lastScrollTop = 0;
    let isScrolling = false;
    let isPageSwitching = false; // 页面切换标志
    let scrollTimeout = null; // 滚动防抖定时器
    
    function handleScroll() {
      if (isScrolling || isPageSwitching) return;
      
      // 清除之前的定时器
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      
      isScrolling = true;
      
      // 添加防抖延迟，避免频繁触发
      scrollTimeout = setTimeout(() => {
        requestAnimationFrame(() => {
          const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          const headerTitle = document.querySelector('.header-title');
          const keyCountdown = document.getElementById('keyCountdown');
          const scrollDirection = currentScroll > lastScrollTop ? 'down' : 'up';
          
          // 增加滚动阈值和方向检测，减少闪动
          if (currentScroll > 80 && scrollDirection === 'down') {
            // 向下滚动超过80px时隐藏标题
            headerTitle.classList.add('hidden-on-scroll');
            // 同时隐藏密钥倒计时栏（完全隐藏并释放空间）
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = '0';
              keyCountdown.style.opacity = '0';
              keyCountdown.style.paddingTop = '0';
              keyCountdown.style.paddingBottom = '0';
              keyCountdown.style.overflow = 'hidden';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          } else if (currentScroll < 40 && scrollDirection === 'up') {
            // 向上滚动到40px以下时显示标题
            headerTitle.classList.remove('hidden-on-scroll');
            // 同时显示密钥倒计时栏（恢复原始高度和样式）
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = 'auto';
              keyCountdown.style.opacity = '1';
              keyCountdown.style.paddingTop = '0.5rem';
              keyCountdown.style.paddingBottom = '0.5rem';
              keyCountdown.style.overflow = 'visible';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          }
          
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
          isScrolling = false;
        });
      }, 50); // 50ms防抖延迟
    }
    
    // 页面切换时禁用滚动监听
    function disableScrollListener() {
      isPageSwitching = true;
      setTimeout(() => {
        isPageSwitching = false;
      }, 300); // 300ms后重新启用
    }
    
    // 页面加载完成后添加滚动监听
    document.addEventListener('DOMContentLoaded', function() {
      window.addEventListener('scroll', handleScroll, { passive: true });
    });
  </script>
</head>
<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
  <!-- 密钥倒计时通知栏 -->
  <div id="keyCountdown" class="bg-primary text-white py-2 px-4 text-center hidden">
    <span>密钥有效期剩余: <strong id="timeRemaining">0天 0小时 0分钟 0秒</strong></span>
  </div>
  
  <!-- 顶部导航 -->
  <!-- 标题区域 - 独立模块 -->
  <div class="header-title bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
        <h1 class="text-xl md:text-2xl font-bold text-primary flex items-center">
          <i class="fa fa-line-chart mr-2"></i>台湾PK数据分析工具
        </h1>

      </div>
  </div>
    
  <!-- 工具栏区域 - 独立粘性模块 -->
  <nav class="bg-gray-800 text-white py-2 sticky-header toolbar-sticky" style="top: 0; z-index: 100;">
    <div class="container mx-auto px-4">
      <div class="flex space-x-4">
        <button id="dataAnalysisBtn" class="px-4 py-1 rounded bg-primary text-white font-medium">数据分析</button>
        <button id="fiveStarBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">五星做号</button>
        <button id="goldenRatioBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">黄金切割</button>
      </div>
    </div>
  </nav>

  <!-- 主要内容 -->
  <main class="flex-1 container mx-auto px-4 py-6">
    <!-- 数据分析页面 -->
    <div id="dataAnalysisPage">
      <!-- 数据输入区域 -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4">
          <div class="flex-1">
            <label for="numbersInput" class="block text-sm font-medium text-gray-700 mb-1">手动输入数据（支持格式：期数 数据，如：202504181232 02,05,01,04,07,10,09,03,06,08 ）</label>
            <textarea id="numbersInput" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="202504181232 02,05,01,04,07,10,09,03,06,08"></textarea>
          </div>
          <div class="flex flex-col gap-3 w-full md:w-auto">
            <button id="calcBtn" class="px-4 py-2 bg-primary text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-calculator mr-2"></i>计算分析
            </button>
            <button id="autoFetchBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md flex items-center justify-center btn-hover" style="display: none;">
              <i class="fa fa-play mr-2"></i>开始自动获取
            </button>
            <button id="fetchApiBtn" class="px-4 py-2 bg-green-600 text-white rounded-md flex items-center justify-center btn-hover" style="display: none;">
        <i class="fa fa-download mr-2"></i>获取最新数据
    </button>
            <button id="uploadDataBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-upload mr-2"></i>上传数据文件
            </button>
          </div>
        </div>
        <div id="output" class="mt-3 text-sm text-primary"></div>
      </section>

      <!-- 筛选和统计控制区域 -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <div class="grid grid-cols-1 gap-4">
          <!-- 自定义组合 -->
          <div>
            <label for="customCombos" class="block text-sm font-medium text-gray-700 mb-1">自定义组合（用空格分隔不同组合，每个组合内的数字用逗号分隔）：</label>
            <div class="flex gap-3 items-start">
              <textarea id="customCombos" rows="2" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="1,2,3 1,2,4"></textarea>
              <div class="flex flex-col gap-2">
                <button id="statBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-bar-chart mr-2"></i>加入统计
                </button>
                <button id="clearBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-trash mr-2"></i>清空数据
                </button>
              </div>
            </div>
          </div>
          
          <!-- 筛选模块 -->
          <div class="flex flex-wrap items-start gap-4">
            <!-- 胆码数筛选 -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">选择码数</label>
              <select id="numSelect" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                <option value="1">1码</option>
                <option value="2">2码</option>
                <option value="3" selected>3码</option>
                <option value="4">4码</option>
                <option value="5">5码</option>
                <option value="6">6码</option>
                <option value="7">7码</option>
                <option value="8">8码</option>
                <option value="9">9码</option>
                <option value="10">10码</option>
              </select>
            </div>
            
            <!-- 位置选择 -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">位置选择：</label>
              <div id="positionButtons" class="flex flex-wrap gap-2">
                <button class="position-btn px-3 py-1 rounded-md" data-position="1">1名</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="2">2名</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="3">3名</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="4">4名</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="5">5名</button>
              </div>
            </div>
            
            <!-- 中出筛选 -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">命中码数：</label>
              <div id="hitButtons" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- 命中数字选择 -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">命中数字：</label>
              <div id="hitNumberButtons" class="flex flex-wrap gap-2">
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="1">1</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="2">2</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="3">3</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="4">4</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="5">5</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="6">6</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="7">7</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="8">8</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="9">9</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="10">10</button>
              </div>
            </div>
            
            <!-- 确认按钮 -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <button id="confirmFilterBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200 font-medium">
                确认筛选
              </button>
            </div>
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex flex-wrap gap-3 mt-5">
          <button id="sortToggle" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover hidden">
            <i class="fa fa-sort mr-2"></i><span id="sortText">按连中次数排序</span>
          </button>
        </div>
      </section>

      <!-- 结果表格 -->
      <section class="bg-white rounded-lg shadow-md p-5 overflow-x-auto relative">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold">数据分析结果</h2>
            <!-- 统一的按钮组 -->
            <div class="flex gap-1">
              <!-- 当前遗漏/当前连中切换 -->
              <div class="flex rounded-md overflow-hidden border border-gray-300">
                <button id="currentMissBtn" class="px-3 py-1 bg-blue-600 text-white btn-hover text-sm btn-active">当前遗漏</button>
                <button id="currentHitBtn" class="px-3 py-1 bg-gray-200 text-gray-700 btn-hover text-sm">当前连中</button>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover btn-active" data-period="15">15期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="30">30期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="50">50期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="100">100期</button>
            <div class="flex items-center gap-1">
              <input type="number" id="customPeriod" min="1" max="10000" value="15" class="w-16 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
              <button id="customPeriodBtn" class="px-3 py-1 rounded-md bg-gray-200 btn-hover">自定义</button>
            </div>
          </div>
          <div class="text-sm text-gray-500">
            <span id="periodCount">0</span> 期数据
          </div>
        </div>
        
        <!-- 水平滑块 -->
        <div class="slider-container">
          <div class="slider-track"></div>
          <div class="slider-fill" id="horizontalFill"></div>
          <div class="slider-thumb" id="horizontalThumb"></div>
        </div>
        
        <div class="relative">
          <div class="overflow-x-auto table-container scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="tableContainer">
            <table id="resultTable" class="min-w-full divide-y divide-gray-200">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- 垂直滑块 -->
          <div class="vertical-slider-container" id="verticalSlider">
            <div class="vertical-slider-track"></div>
            <div class="vertical-slider-fill" id="verticalFill"></div>
            <div class="vertical-slider-thumb" id="verticalThumb"></div>
          </div>
        </div>
        
        <!-- 统计摘要 -->
        <div id="summary" class="mt-4 p-3 bg-gray-50 rounded-md text-sm font-medium"></div>
      </section>
    </div>
    
    <!-- 五星做号页面（按图片布局） -->
    <div id="fiveStarPage" class="hidden">
      <div class="container mx-auto py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
           <!-- 下方添加区域 - 所有模块统一容器 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="modules-container">
            <!-- 左侧卡片 - 模块1 (5组筛选条件) -->
        <div id="module1" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- 模块总容错设置 -->
          <div class="module-tolerance mb-4 p-3 bg-gray-50 rounded border">
            <div class="flex items-center text-sm">
              <span class="text-gray-700 font-medium mr-3">模块总容错：</span>
              <span class="text-gray-600 mr-2">允许</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="ml-2 text-gray-600">个条件不成立</span>
            </div>
          </div>
          
          <!-- 第1组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件1容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件1容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="1">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="1">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="1">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="1">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="1">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="1">5胆</button>
            </div>
          </div>
          
          <!-- 第2组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件2容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件2容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="2">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="2">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="2">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="2">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="2">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="2">5胆</button>
            </div>
          </div>
          
          <!-- 第3组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件3容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件3容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="3">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="3">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="3">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="3">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="3">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="3">5胆</button>
            </div>
          </div>
          
          <!-- 第4组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件4容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件4容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="4">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="4">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="4">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="4">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="4">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="4">5胆</button>
            </div>
          </div>
          
          <!-- 第5组筛选条件 -->
          <div class="filter-group mb-2 pb-2">
            <!-- 条件5容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件5容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="5">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="5">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="5">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="5">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="5">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="5">5胆</button>
            </div>
          </div>
          
          <!-- 输入区域 -->
          <div class="flex mb-2">
            <input type="text" placeholder="输入结果" class="result-input flex-1 border border-gray-300 rounded-l px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="1">
            <button class="clear-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm" data-module="1">清</button>
            <button class="reverse-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm rounded-r" data-module="1">反</button>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="1">共0注</div>
          
          <!-- 操作按钮区域 -->
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">做号</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">复制</button>
            <button onclick="addModule(1)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="1">+</button>
            <button onclick="removeModule(1)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="1">-</button>
          </div>
        </div>
            
            <!-- 右侧卡片 - 模块2 (结构与模块1相同，data-module="2") -->
        <div id="module2" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- 模块总容错设置 -->
          <div class="module-tolerance mb-4 p-3 bg-gray-50 rounded border">
            <div class="flex items-center text-sm">
              <span class="text-gray-700 font-medium mr-3">模块总容错：</span>
              <span class="text-gray-600 mr-2">允许</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="ml-2 text-gray-600">个条件不成立</span>
            </div>
          </div>
          
          <!-- 第1组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件1容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件1容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="1">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="1">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="1">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="1">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="1">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="1">5胆</button>
            </div>
          </div>
          
          <!-- 第2组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件2容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件2容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="2">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="2">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="2">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="2">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="2">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="2">5胆</button>
            </div>
          </div>
          
          <!-- 第3组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件3容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件3容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="3">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="3">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="3">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="3">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="3">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="3">5胆</button>
            </div>
          </div>
          
          <!-- 第4组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件4容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件4容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="4">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="4">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="4">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="4">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="4">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="4">5胆</button>
            </div>
          </div>
          
          <!-- 第5组筛选条件 -->
          <div class="filter-group mb-2 pb-0">
            <!-- 条件5容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件5容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="5">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="5">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="5">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="5">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="5">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="5">5胆</button>
            </div>
          </div>
          
          <!-- module2 输入区域和操作按钮区域与module1相同 -->
          <div class="flex mb-2">
            <input type="text" placeholder="输入结果" class="result-input flex-1 border border-gray-300 rounded-l px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="2">
            <button class="clear-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm" data-module="2">清</button>
            <button class="reverse-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm rounded-r" data-module="2">反</button>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="2">共0注</div>
          
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">做号</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">复制</button>
            <button onclick="addModule(2)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="2">+</button>
            <button onclick="removeModule(2)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="2">-</button>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 黄金分割页面 -->
    <div id="goldenRatioPage" class="hidden">
      <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <!-- 切割模式选择 -->
          <div class="mb-6">
            <div class="flex justify-center gap-3 mb-4">
              <button 
                id="modeUniformBtn" 
                class="px-6 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600 transition-colors active-mode"
                data-mode="uniform"
              >均匀</button>
              <button 
                id="modeStableBtn" 
                class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-md hover:bg-gray-400 transition-colors"
                data-mode="stable"
              >稳定</button>
            </div>
            <div class="text-center text-sm text-gray-600 mb-4">
              <span id="modeDescription">均匀模式：一次性分完就用，不保持历史分组</span>
            </div>
          </div>
          
          <!-- 输入区域 -->
          <div class="mb-6">
            <label for="goldenInputData" class="block text-sm font-medium text-gray-700 mb-2">请输入数据 <span id="goldenInputCount" class="text-red-500 text-sm font-medium hidden">共 0 项</span></label>
            <textarea 
              id="goldenInputData" 
              rows="6" 
              placeholder="示例：01,02,03,04,05,06,07,08,09,10" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none overflow-auto whitespace-pre-wrap"
            ></textarea>
          </div>
          
          <!-- 操作按钮 -->
          <div class="flex justify-center gap-3 mb-6">
            <button 
              id="goldenSplitBtn" 
              class="px-6 py-2 bg-primary text-white font-medium rounded-md hover:bg-primary/80 transition-colors"
            >开始分割</button>
            <button 
              id="goldenPasteBtn" 
              class="px-6 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600 transition-colors"
            >粘贴数据</button>
            <button 
              id="goldenClearBtn" 
              class="px-6 py-2 bg-gray-500 text-white font-medium rounded-md hover:bg-gray-600 transition-colors"
            >清空</button>
          </div>
          
          <!-- 结果显示区域 -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-800">分割结果</h3>
              <div class="text-sm text-gray-500" id="resultSummary"></div>
            </div>
            
            <!-- 5个紧凑排列的框 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
              <div id="goldenResults" class="col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                <!-- 5个分组结果将在这里动态生成 -->
              </div>
            </div>
          </div>
          
          <!-- 验证结果显示 -->
          <div id="validationResults" class="mt-6 p-4 bg-gray-50 rounded-md hidden">
            <h3 class="text-lg font-semibold mb-2">5in4验证结果</h3>
            <div id="validationContent"></div>
          </div>
        </div>
      </div>
    </div>


  </main>
  
  

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>台湾PK数据分析工具 © 2025，联系✈️@suibian925</p>
    </div>
  </footer>



  <!-- 密钥验证模态框 -->
  <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center" style="z-index: 9999;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">请输入访问密钥</h3>
        <p class="text-gray-600">该功能需要有效的访问密钥才能使用</p>
      </div>
      
      <div class="mb-4">
        <input type="text" id="keyInput" placeholder="请输入32位访问密钥" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
      </div>
      
      <div class="flex gap-3">
        <button id="verifyKeyBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md font-medium hover:bg-primary/80 transition-colors">验证密钥</button>
        <!-- 移除取消按钮 -->
      </div>
    </div>
  </div>

  

<script>
// 全局模块状态存储
window.moduleStates = {};

// 添加模块功能
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // 检查模块数量上限（最多14个）
  if (moduleElements.length >= 14) {
    alert('最多只能添加14个模块');
    return;
  }

  // 获取最后一个模块ID并递增
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // 克隆当前模块
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // 克隆当前模块后添加以下代码
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // 直接添加到模块容器末尾
  modulesContainer.appendChild(newModule);

  // 初始化新模块
  initFiveStarModule(newModuleId);
}

// 移除单个模块 - 确保最少保留2个
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);

  // 确保至少保留2个模块
  if (moduleElements.length <= 2) {
    alert('至少保留2个模块');
    return;
  }

  // 移除模块
  moduleToRemove.remove();
}

// 重置模块状态的辅助函数
function resetModuleState(module) {
  // 清除克隆模块的选中状态和结果
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = '共0注';
}

// 生成排列组合的函数 - 迭代版本避免栈溢出
function permute(arr, k) {
  if (k === 0) return [[]];
  if (k === 1) return arr.map(x => [x]);
  
  const result = [];
  const stack = [{ current: [], remaining: arr, depth: 0 }];
  
  while (stack.length > 0) {
    const { current, remaining, depth } = stack.pop();
    
    if (depth === k) {
      result.push([...current]);
      continue;
    }
    
    for (let i = 0; i < remaining.length; i++) {
      const newCurrent = [...current, remaining[i]];
      const newRemaining = remaining.slice(0, i).concat(remaining.slice(i + 1));
      stack.push({ current: newCurrent, remaining: newRemaining, depth: depth + 1 });
    }
  }
  
  return result;
}

// 生成数组的所有排列
function generatePermutations(arr) {
  if (arr.length <= 1) return [arr];
  
  const result = [];
  for (let i = 0; i < arr.length; i++) {
    const current = arr[i];
    const remaining = arr.slice(0, i).concat(arr.slice(i + 1));
    const perms = generatePermutations(remaining);
    
    for (const perm of perms) {
      result.push([current, ...perm]);
    }
  }
  
  return result;
}

// 初始化五星模块
function initFiveStarModule(moduleId) {
  // 防止重复初始化
  if (window.moduleStates && window.moduleStates[moduleId]) {
    console.log(`模块${moduleId}已经初始化过，跳过重复初始化`);
    return;
  }
  
  // 确保全局状态对象存在
  if (!window.moduleStates) {
    window.moduleStates = {};
  }
  
  // 模块状态存储 - 修改为按组存储条件，每个条件组有独立的容错设置
  const moduleState = window.moduleStates[moduleId] = {
    groups: [
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组1
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组2
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组3
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组4
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }  // 组5
    ],
    // 模块总容错设置
    moduleToleranceMin: 0,  // 允许最少多少个条件不成立
    moduleToleranceMax: 0,  // 允许最多多少个条件不成立
    results: [],         // 当前显示结果
    allPermutations: [], // 所有排列组合
    originalResults: [], // 原始筛选结果
    isReversed: false    // 是否显示反向结果
  };

  // 获取模块元素
  const module = document.getElementById(`module${moduleId}`);
  const numberButtons = module.querySelectorAll('.number-btn');
  const damaButtons = module.querySelectorAll('.dama-btn');
  const generateBtn = module.querySelector('.generate-btn');
  const copyBtn = module.querySelector('.copy-btn');
  const clearBtn = module.querySelector('.clear-btn');
  const reverseBtn = module.querySelector('.reverse-btn');
  const resultInput = module.querySelector('.result-input');
  const resultCount = module.querySelector('.result-count');
  const conditionToleranceMinSelects = module.querySelectorAll('.condition-tolerance-min');
  const conditionToleranceMaxSelects = module.querySelectorAll('.condition-tolerance-max');
  const moduleToleranceMinSelect = module.querySelector('.module-tolerance-min');
  const moduleToleranceMaxSelect = module.querySelector('.module-tolerance-max');

  // 数字按钮点击事件
  numberButtons.forEach(button => {
      button.addEventListener('click', function() {
          const number = parseInt(this.dataset.number);
          const groupIndex = parseInt(this.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedNumbers.indexOf(number);
          
          if (index === -1) {
              groupState.selectedNumbers.push(number);
              this.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedNumbers.splice(index, 1);
              this.classList.remove('bg-primary', 'text-white');
          }
      });
  });

  // 命中数字按钮点击事件已在DOMContentLoaded中统一处理

  // 胆码按钮点击事件
  damaButtons.forEach(button => {
      // 处理胆码按钮状态切换的函数
      function toggleDamaButton() {
          const dama = parseInt(button.dataset.dama);
          const groupIndex = parseInt(button.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedDamas.indexOf(dama);
          
          if (index === -1) {
              groupState.selectedDamas.push(dama);
              button.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedDamas.splice(index, 1);
              button.classList.remove('bg-primary', 'text-white');
          }
      }
      
      // 移动端触摸事件处理变量
      let touchStartTime = 0;
      let touchMoved = false;
      let touchHandled = false;
      
      // 添加点击事件（仅在非触摸设备上生效）
      button.addEventListener('click', function(e) {
          // 如果触摸事件已处理，则跳过click事件
          if (touchHandled) {
              touchHandled = false;
              return;
          }
          toggleDamaButton();
      });
      
      // 添加移动端触摸事件处理
      button.addEventListener('touchstart', function(e) {
          touchStartTime = Date.now();
          touchMoved = false;
          touchHandled = false;
          // 添加触摸开始的视觉反馈
          this.style.opacity = '0.7';
      }, { passive: true });
      
      button.addEventListener('touchmove', function(e) {
          touchMoved = true;
          // 移除视觉反馈
          this.style.opacity = '';
      }, { passive: true });
      
      button.addEventListener('touchend', function(e) {
          const touchDuration = Date.now() - touchStartTime;
          // 恢复视觉反馈
          this.style.opacity = '';
          
          // 如果是快速点击且没有移动，则触发状态切换
          if (!touchMoved && touchDuration < 500) {
              touchHandled = true;
              toggleDamaButton();
              // 延迟重置标志，确保click事件被跳过
              setTimeout(() => {
                  touchHandled = false;
              }, 100);
          }
      }, { passive: true });
      
      button.addEventListener('touchcancel', function(e) {
           // 恢复视觉反馈
           this.style.opacity = '';
       }, { passive: true });
   });

  // 条件容错选择事件
  conditionToleranceMinSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMin = parseInt(this.value);
    });
  });

  conditionToleranceMaxSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMax = parseInt(this.value);
    });
  });

  // 模块总容错选择事件
  if (moduleToleranceMinSelect) {
    moduleToleranceMinSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMin = parseInt(this.value);
    });
  }

  if (moduleToleranceMaxSelect) {
    moduleToleranceMaxSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMax = parseInt(this.value);
    });
  }

  /***** 核心：按"命中个数"判定（不看位置） *****/
  
  /** 求与开奖号码（前五）相交的命中个数 */
  function countHits(picks, openTop5) {
    const set = new Set(openTop5.map(String));
    let c = 0;
    for (const x of picks) if (set.has(String(x))) c++;
    return c;
  }
  
  /** 条件判定：命中个数在 [minHits, maxHits] 内即通过 */
  function evalHitCondition(picks, openTop5, minHits, maxHits) {
    const k = picks.length;
    // 规范化边界
    const lo = Math.max(0, Math.min(minHits, maxHits));
    const hi = Math.min(k, Math.max(minHits, maxHits));
    const hits = countHits(picks, openTop5);
    const ok = hits >= lo && hits <= hi;
    return { ok, hits, minHits: lo, maxHits: hi, size: k };
  }
  
  /** 组合判定：5 个条件互不干扰，最终必须全部通过 */
  function evalAllConditions(conditions, openTop5) {
    const details = conditions.map(c =>
      evalHitCondition(c.picks, openTop5, c.minHits, c.maxHits)
    );
    return { ok: details.every(d => d.ok), details };
  }
  
  /***** 便捷映射：不同写法统一成命中区间 *****/
  
  /** n胆：mode='atLeast' 表示"至少 n 中"；mode='exact' 表示"恰好 n 中" */
  function mapDanToRange(nDan, picksLen, mode = 'atLeast') {
    if (mode === 'exact') return { minHits: nDan, maxHits: nDan };
    // 默认"至少 n 中"
    return { minHits: nDan, maxHits: picksLen };
  }
  
  /** "错区间"写法（比如 '1-1', '0-2'），转成命中区间
   *  约定：'a-b' 表示"允许错 a 到 b 个"
   *  则命中范围 = [picksLen - b, picksLen - a]
   */
  function mapMissRangeToHits(missRangeStr, picksLen) {
    const [a, b] = missRangeStr.split('-').map(x => parseInt(x, 10));
    const minHits = Math.max(0, picksLen - Math.max(a, b));
    const maxHits = Math.min(picksLen, picksLen - Math.min(a, b));
    return { minHits, maxHits };
  }
  
  // 基于条件数据生成组合的函数
  function generateFromConditions(activeConditions) {
    const results = [];
    const conditionCount = activeConditions.length;
    const minFailures = moduleState.moduleToleranceMin;
    const maxFailures = moduleState.moduleToleranceMax;
    
    // 计算需要满足的条件数量范围
    const minSatisfied = Math.max(0, conditionCount - maxFailures);
    const maxSatisfied = Math.max(0, conditionCount - minFailures);
    
    console.log(`条件总数: ${conditionCount}, 容错范围: ${minFailures}-${maxFailures}`);
    console.log(`需要满足的条件数: ${minSatisfied}-${maxSatisfied}`);
    
    // 生成所有可能的条件组合
    for (let satisfiedCount = minSatisfied; satisfiedCount <= maxSatisfied; satisfiedCount++) {
      if (satisfiedCount === 0 && conditionCount > 0) continue; // 当有条件时，至少要满足一个条件
      
      // 获取所有可能的条件组合
      const conditionCombinations = getCombinations(activeConditions, satisfiedCount);
      
      for (const conditionCombo of conditionCombinations) {
        // 从选中的条件中生成数字组合
        const numberCombinations = generateNumberCombinations(conditionCombo);
        results.push(...numberCombinations);
      }
    }
    
    // 去重并限制结果数量
    const uniqueResults = [...new Set(results.map(r => r.join(',')))];
    console.log(`生成组合数: ${uniqueResults.length}`);
    
    return uniqueResults.slice(0, 10000).map(r => r.split(',').map(Number)); // 限制最多10000个结果
  }
  
  // 获取数组的所有组合
  function getCombinations(arr, count) {
    if (count === 0) return [[]];
    if (count > arr.length) return [];
    if (count === arr.length) return [arr];
    
    const result = [];
    for (let i = 0; i <= arr.length - count; i++) {
      const head = arr[i];
      const tailCombos = getCombinations(arr.slice(i + 1), count - 1);
      for (const tail of tailCombos) {
        result.push([head, ...tail]);
      }
    }
    return result;
  }
  
  // 从条件组合中生成数字组合
  function generateNumberCombinations(conditions) {
    const results = [];
    
    // 收集所有条件的数字
    const allConditionNumbers = conditions.map(condition => {
      return condition.selectedNumbers.length > 0 ? condition.selectedNumbers : [1,2,3,4,5,6,7,8,9,10];
    });
    
    // 生成笛卡尔积
    function cartesianProduct(arrays) {
      if (arrays.length === 0) return [[]];
      if (arrays.length === 1) return arrays[0].map(x => [x]);
      
      const result = [];
      const firstArray = arrays[0];
      const restProduct = cartesianProduct(arrays.slice(1));
      
      for (const first of firstArray) {
        for (const rest of restProduct) {
          const combination = [first, ...rest];
          if (combination.length === 5 && new Set(combination).size === 5) {
            // 确保是5个不重复的数字
            result.push(combination.sort((a, b) => a - b));
          }
        }
      }
      return result;
    }
    
    // 如果条件数少于5个，需要补充其他数字
    if (conditions.length < 5) {
      const usedNumbers = new Set();
      conditions.forEach(condition => {
        condition.selectedNumbers.forEach(num => usedNumbers.add(num));
      });
      
      const remainingNumbers = [1,2,3,4,5,6,7,8,9,10].filter(num => !usedNumbers.has(num));
      const needMore = 5 - conditions.length;
      
      // 从剩余数字中选择需要的数量
      const additionalCombos = getCombinations(remainingNumbers, needMore);
      
      for (const condition of conditions) {
        for (const num of condition.selectedNumbers) {
          for (const additional of additionalCombos) {
            const combination = [num, ...additional].sort((a, b) => a - b);
            if (combination.length === 5 && new Set(combination).size === 5) {
              results.push(combination);
            }
          }
        }
      }
    } else {
      // 如果条件数>=5，直接从每个条件中选一个数字
      const cartesianResults = cartesianProduct(allConditionNumbers);
      results.push(...cartesianResults);
    }
    
    return results;
  }
  
  // 条件评估函数（适配现有接口）
  function evaluateCondition(condition, resultNums) {
    // 如果条件为空，应该不参与评估
    if (condition.selectedNumbers.length === 0 && condition.selectedDamas.length === 0) {
      return { ok: true, errors: 0 };
    }
    
    const picks = condition.selectedNumbers;
    const picksLen = picks.length;
    
    // 计算实际命中个数
    const actualHitCount = countHits(picks, resultNums);
    
    if (condition.selectedDamas.length === 0) {
      // 未选择命中胆码数：如果选择了胆码数字但没有选择命中胆码数，则不通过筛选
      // 这种情况下用户需要明确指定命中几个胆码才能进行筛选
      return {
        ok: false,
        errors: picksLen - actualHitCount,
        hitCount: actualHitCount
      };
    }
    
    // 已选择命中胆码数：检查实际命中数是否在选中的胆码数范围内
    // 胆码逻辑：选择1234作为胆码，命中胆码数选3-4时，筛选包含1234中任意3个或4个的号码
    
    // 检查实际命中数是否在选中的胆码数列表中
    const isValidHitCount = condition.selectedDamas.includes(actualHitCount);
    
    if (!isValidHitCount) {
      // 如果命中数不在选中的胆码数中，检查容错
      // 容错X-Y表示：允许X到Y个胆码数条件不成立
      const toleranceMin = condition.toleranceMin;
      const toleranceMax = condition.toleranceMax;
      
      // 计算不成立的条件数（这里是1，因为实际命中数不在选中范围内）
      const unsatisfiedCount = 1;
      
      // 判断是否在容错范围内
      const isValid = unsatisfiedCount >= toleranceMin && unsatisfiedCount <= toleranceMax;
      
      return {
        ok: isValid,
        errors: picksLen - actualHitCount,
        hitCount: actualHitCount
      };
    }
    
    // 命中数在选中的胆码数中，条件成立
    const isValid = true;
    
    return {
      ok: isValid,
      errors: picksLen - actualHitCount,
      hitCount: actualHitCount
    };
  }  
  // 评估所有条件（适配现有接口）
  function evaluateAll(conditions, resultNums) {
    // 只评估有设置的条件（选择了数字或胆码的条件）
    const activeConditions = conditions.filter(c => 
      c.selectedNumbers.length > 0 || c.selectedDamas.length > 0
    );
    
    // 如果没有任何活跃条件，返回true（通过筛选，生成所有组合）
    if (activeConditions.length === 0) {
      return { ok: true, details: [], failedCount: 0, moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax] };
    }
    
    const details = activeConditions.map(c => evaluateCondition(c, resultNums));
    
    // 应用模块总容错逻辑
    // 统计不成立的条件数量
    const failedConditionsCount = details.filter(d => !d.ok).length;
    
    // 检查失败的条件数是否在允许的容错范围内
    const moduleToleranceOk = failedConditionsCount >= moduleState.moduleToleranceMin && 
                             failedConditionsCount <= moduleState.moduleToleranceMax;
    
    return { 
      ok: moduleToleranceOk, 
      details,
      failedCount: failedConditionsCount,
      moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax]
    };
  }

  // 做号按钮点击事件
  generateBtn.addEventListener('click', function() {
    // 获取有数据的条件
    const activeConditions = moduleState.groups.filter(g => 
      g.selectedNumbers.length > 0 || g.selectedDamas.length > 0
    );
    
    let filteredResults = [];
    
    // 如果没有活跃条件，生成所有可能的排列
    if (activeConditions.length === 0) {
      console.log('没有活跃条件，生成所有排列');
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, 5);
      console.log(`生成排列数: ${permutations.length}`);
      filteredResults = permutations;
    }
    // 有活跃条件时，使用筛选逻辑
    else {
      console.log('有活跃条件，使用筛选逻辑');
      console.log('活跃条件:', activeConditions);
      
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, 5);
      
      // 存储所有排列组合
      moduleState.allPermutations = permutations;
      
      // 根据选中的数字、胆码和容错筛选结果
      filteredResults = permutations.filter(comb => {
          // 使用容错评估逻辑
          const evaluation = evaluateAll(moduleState.groups, comb);
          
          // 调试信息：输出前几个组合的评估结果
          if (permutations.indexOf(comb) < 5) {
            console.log(`组合 ${comb.join(',')} 评估结果:`, {
              ok: evaluation.ok,
              failedCount: evaluation.failedCount,
              moduleToleranceRange: evaluation.moduleToleranceRange,
              details: evaluation.details.map(d => ({ ok: d.ok, hitCount: d.hitCount }))
            });
          }
          
          return evaluation.ok;
      });
    }
    
    // 调试信息：输出筛选统计
    console.log(`模块总容错设置: ${moduleState.moduleToleranceMin}-${moduleState.moduleToleranceMax}`);
    console.log(`活跃条件数: ${moduleState.groups.filter(g => g.selectedNumbers.length > 0 || g.selectedDamas.length > 0).length}`);
    console.log(`筛选结果: ${filteredResults.length}`);
    
    // 调试信息：输出最终结果
    console.log(`最终筛选结果数量: ${filteredResults.length}`);
    
    // 首次生成时就按照格式化逻辑处理并存储为字符串
    const formattedResults = filteredResults.map(comb => 
        comb.map(num => num.toString().padStart(2, '0')).join(' ')
    );
    
    console.log(`格式化后结果数量: ${formattedResults.length}`);
    

    
    moduleState.results = formattedResults;
    moduleState.originalResults = [...formattedResults]; // 保存原始结果
    moduleState.isReversed = false;
    
    updateResultDisplay();
  });

  // 复制按钮点击事件
  copyBtn.addEventListener('click', function() {
    if (moduleState.results.length === 0) {
      // 修改无结果提示为文本显示
      resultCount.innerHTML = '<span style="color: red;">没有可复制的结果</span>';
      setTimeout(() => {
        resultCount.textContent = `共${moduleState.results.length}注`;
      }, 2000);
      return;
    }
    
    // 复制存储的筛选结果 - 组内空格，组间逗号
    // moduleState.results中每个元素已经是格式化的字符串（如"01 02 03 04 05"）
    // 直接用逗号连接即可得到正确格式
    let textToCopy = '';
    for (let i = 0; i < moduleState.results.length; i++) {
      if (i > 0) textToCopy += ',';
      textToCopy += moduleState.results[i];
    }

    // 复制到剪贴板
    navigator.clipboard.writeText(textToCopy).then(() => {
      // 复制成功后显示红色的已复制提示
      resultCount.innerHTML = `共${moduleState.results.length}注 <span style="color: red;">已复制${moduleState.results.length}注</span>`;
    }).catch(err => {
      console.error('复制失败:', err);
      // 错误提示：显示红色错误文本
      resultCount.innerHTML = '<span style="color: red;">复制失败，请手动复制</span>';
      setTimeout(() => {
        resultCount.textContent = `共${moduleState.results.length}注`;
      }, 2000);
    });
  });

  // 清除按钮点击事件
  clearBtn.addEventListener('click', function() {
    // 修复：按组清除选中状态
    moduleState.groups.forEach(group => {
        group.selectedNumbers = [];
        group.selectedDamas = [];
    });
    moduleState.results = [];
    moduleState.originalResults = [];
    moduleState.isReversed = false;
    
    // 清除所有按钮选中状态
    numberButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    damaButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    
    // 清除结果显示
    resultInput.value = '';
    resultCount.textContent = '共0注';
  });

  // 反向按钮点击事件 - 修改为显示筛选结果的补集
  reverseBtn.addEventListener('click', function() {
    // 检查是否已生成结果
    if (moduleState.allPermutations.length === 0 || moduleState.originalResults.length === 0) {
      alert('请先点击"做号"生成结果');
      return;
    }

    // 切换反向状态
    if (!moduleState.isReversed) {
      // 生成原始结果的补集（所有组合中排除原始结果）
      // 创建原始结果的字符串表示集合用于快速查找
      const originalSet = new Set(moduleState.originalResults);
      // 筛选出不在原始结果中的所有组合，并格式化
      const complementResults = moduleState.allPermutations
        .filter(comb => {
          const formattedComb = comb.map(num => num.toString().padStart(2, '0')).join(' ');
          return !originalSet.has(formattedComb);
        })
        .map(comb => comb.map(num => num.toString().padStart(2, '0')).join(' '));
      moduleState.results = complementResults;
      moduleState.isReversed = true;
    } else {
      // 恢复显示原始结果
      moduleState.results = moduleState.originalResults;
      moduleState.isReversed = false;
    }

    updateResultDisplay();
  });



  // 更新结果显示 - 版本2024.12.19
  function updateResultDisplay() {
    const totalCount = moduleState.results.length;
    const displayResults = totalCount > 200 ? moduleState.results.slice(0, 200) : moduleState.results;
    // 结果已经是格式化的字符串，直接用逗号连接（逗号后不加空格）
    let displayText = '';
    for (let i = 0; i < displayResults.length; i++) {
      if (i > 0) displayText += ',';
      displayText += displayResults[i];
    }
    
    // 立即设置结果
    resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    resultCount.textContent = `共${totalCount}注`;
    
    // 延迟再次确保格式正确（防止被其他代码覆盖）
    setTimeout(() => {
      resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    }, 10);
    

  }
}

// 页面加载时初始化现有模块
document.addEventListener('DOMContentLoaded', function() {
  // 初始化模块1和模块2
  if (!window.moduleStates || !window.moduleStates[1]) {
    initFiveStarModule(1);
  }
  if (!window.moduleStates || !window.moduleStates[2]) {
    initFiveStarModule(2);
  }
});


// 旧的模块初始化函数已被新的 initFiveStarModule 函数替代

// 添加模块功能
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // 检查模块数量上限（最多14个）
  if (moduleElements.length >= 14) {
    alert('最多只能添加14个模块');
    return;
  }

  // 获取最后一个模块ID并递增
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // 克隆当前模块
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // 克隆当前模块后添加以下代码
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // 添加到容器
  modulesContainer.appendChild(newModule);
  
  // 初始化新模块
  initFiveStarModule(newModuleId);
}

// 移除模块功能
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);
  
  if (moduleElements.length <= 2) {
    alert('至少保留2个模块');
    return;
  }
  
  moduleToRemove.remove();
}

// 重置模块状态
function resetModuleState(module) {
  // 重置按钮状态
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  
  // 重置输入和显示
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = '共0注';
  
  // 重置模块总容错为默认值0-0
  const toleranceMinSelect = module.querySelector('.module-tolerance-min');
  const toleranceMaxSelect = module.querySelector('.module-tolerance-max');
  if (toleranceMinSelect) toleranceMinSelect.value = '0';
  if (toleranceMaxSelect) toleranceMaxSelect.value = '0';
}

// 重复的permute函数已删除，使用上面的迭代版本

// Tailwind配置
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#d62828',
        secondary: '#f77f00',
        neutral: '#f5f5f5',
        dark: '#333333'
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif']
      }
    }
  }
};

// 页面切换功能
document.addEventListener('DOMContentLoaded', function() {
  // 云端数据库功能已禁用
  
  // 页面加载时自动从MongoDB数据库加载数据 - 已禁用云端数据库功能
  async function fetchLatestData() {
    // 云端数据库功能已禁用
    console.log('云端数据库功能已禁用');
    const currentTime = new Date().toLocaleTimeString();
    if (v) {
      v.textContent = `云端数据库功能已禁用，请手动输入数据 (${currentTime})`;
    }
    
    // 清空现有数据
    r = [];
    d.clear();
    
    // 更新页面显示
    document.getElementById("periodCount").textContent = 0;
    
    // 重新渲染表格 - 移除立即筛选，等待确认按钮点击
    // if (typeof L === 'function') {
    //   L();
    // }
  }

  
  // 云端数据库功能已禁用 - 不再自动获取数据
  // fetchLatestData(); // 已禁用
  
  // 云端数据库功能已禁用 - 不再设置定时器
  // setInterval(() => {
  //   console.log('定时刷新数据...');
  //   fetchLatestData();
  // }, 5000); // 已禁用
  
  console.log('云端数据库功能已禁用，请手动输入数据');
  
  const dataAnalysisBtn = document.getElementById('dataAnalysisBtn');
  const fiveStarBtn = document.getElementById('fiveStarBtn');
  const goldenRatioBtn = document.getElementById('goldenRatioBtn');
  const dataAnalysisPage = document.getElementById('dataAnalysisPage');
  const fiveStarPage = document.getElementById('fiveStarPage');
  const goldenRatioPage = document.getElementById('goldenRatioPage');
  
  // 滚动位置保存和恢复功能
  const scrollPositions = {
    dataAnalysis: 0,
    fiveStar: 0,
    goldenRatio: 0
  };
  
  // 保存当前页面的滚动位置
  function saveScrollPosition(pageType) {
    scrollPositions[pageType] = window.pageYOffset || document.documentElement.scrollTop;
  }
  
  // 恢复指定页面的滚动位置
  function restoreScrollPosition(pageType) {
    // 使用requestAnimationFrame确保在下一帧渲染时恢复滚动位置，避免卡顿
    requestAnimationFrame(() => {
      window.scrollTo({
        top: scrollPositions[pageType],
        behavior: 'instant' // 使用instant避免滚动动画
      });
    });
  }
  
  // 获取当前显示的页面类型
  function getCurrentPageType() {
    if (!dataAnalysisPage.classList.contains('hidden')) return 'dataAnalysis';
    if (!fiveStarPage.classList.contains('hidden')) return 'fiveStar';
    if (!goldenRatioPage.classList.contains('hidden')) return 'goldenRatio';
    return 'dataAnalysis'; // 默认
  }

  if (dataAnalysisBtn && fiveStarBtn && goldenRatioBtn && dataAnalysisPage && fiveStarPage && goldenRatioPage) {
    dataAnalysisBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.remove('hidden');
      fiveStarPage.classList.add('hidden');
      goldenRatioPage.classList.add('hidden');
      dataAnalysisBtn.classList.add('bg-primary');
      dataAnalysisBtn.classList.remove('bg-gray-600');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      
      // 恢复数据分析页面的滚动位置
      restoreScrollPosition('dataAnalysis');
    });
    
    fiveStarBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.remove('hidden');
      goldenRatioPage.classList.add('hidden');
      fiveStarBtn.classList.add('bg-primary');
      fiveStarBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      
      // 恢复五星做号页面的滚动位置
      restoreScrollPosition('fiveStar');
    });
    
    goldenRatioBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.add('hidden');
      goldenRatioPage.classList.remove('hidden');
      goldenRatioBtn.classList.add('bg-primary');
      goldenRatioBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      
      // 恢复黄金切割页面的滚动位置
      restoreScrollPosition('goldenRatio');
    });
  } else {
    console.error('页面切换所需元素未找到');
  }
  
  // 手机端上滑全屏功能
  let lastScrollY = 0;
  let isFullscreen = false;
  let scrollTimeout = null;
  
  // 检测是否为手机端
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // 切换全屏模式
  function toggleFullscreen(enable) {
    if (!isMobile()) return;
    
    const header = document.querySelector('header');
    const titleArea = header.querySelector('.container');
    const toolbarArea = header.querySelector('.bg-gray-800');
    const keyCountdown = document.getElementById('keyCountdown');
    
    if (enable && !isFullscreen) {
      // 进入全屏模式
      isFullscreen = true;
      
      // 隐藏标题区域
      if (titleArea) {
        titleArea.style.transform = 'translateY(-100%)';
        titleArea.style.transition = 'transform 0.3s ease-in-out';
      }
      
      // 隐藏密钥倒计时栏（完全隐藏并释放空间）
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = '0';
        keyCountdown.style.opacity = '0';
        keyCountdown.style.paddingTop = '0';
        keyCountdown.style.paddingBottom = '0';
        keyCountdown.style.overflow = 'hidden';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 调整工具栏位置到顶部
      if (toolbarArea) {
        toolbarArea.style.position = 'fixed';
        toolbarArea.style.top = '0';
        toolbarArea.style.left = '0';
        toolbarArea.style.right = '0';
        toolbarArea.style.zIndex = '1000';
        toolbarArea.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 调整主内容区域的上边距
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '50px'; // 工具栏高度
        main.style.transition = 'padding-top 0.3s ease-in-out';
      }
      
    } else if (!enable && isFullscreen) {
      // 退出全屏模式
      isFullscreen = false;
      
      // 显示标题区域
      if (titleArea) {
        titleArea.style.transform = 'translateY(0)';
      }
      
      // 显示密钥倒计时栏（恢复原始高度和样式）
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = 'auto';
        keyCountdown.style.opacity = '1';
        keyCountdown.style.paddingTop = '0.5rem';
        keyCountdown.style.paddingBottom = '0.5rem';
        keyCountdown.style.overflow = 'visible';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 恢复工具栏位置
      if (toolbarArea) {
        toolbarArea.style.position = '';
        toolbarArea.style.top = '';
        toolbarArea.style.left = '';
        toolbarArea.style.right = '';
        toolbarArea.style.zIndex = '';
      }
      
      // 恢复主内容区域的上边距
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '';
      }
    }
  }
  
  // 滚动事件监听
  function handleScroll() {
    if (!isMobile()) return;
    
    const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
    const scrollDelta = currentScrollY - lastScrollY;
    
    // 清除之前的定时器
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    // 设置新的定时器，延迟执行以避免频繁切换
    scrollTimeout = setTimeout(() => {
      // 向上滑动且滑动距离超过50px时进入全屏
      if (scrollDelta < -50 && currentScrollY > 100) {
        toggleFullscreen(true);
      }
      // 向下滑动且滑动距离超过30px时退出全屏
      // 或者滚动到页面顶部附近时也退出全屏
      else if (scrollDelta > 30 || currentScrollY < 50) {
        toggleFullscreen(false);
      }
    }, 150); // 增加延迟时间，减少误触发
    
    lastScrollY = currentScrollY;
  }
  
  // 添加滚动事件监听器
  window.addEventListener('scroll', handleScroll, { passive: true });
  
  // 为工具栏按钮添加点击事件监听，防止误触发全屏
  const toolbarButtons = document.querySelectorAll('.bg-gray-800 button');
  toolbarButtons.forEach(button => {
    button.addEventListener('click', () => {
      // 点击按钮时暂时禁用滚动检测
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      // 短暂延迟后重新启用滚动检测
      setTimeout(() => {
        lastScrollY = window.pageYOffset || document.documentElement.scrollTop;
      }, 300);
    });
  });
  
  // 窗口大小改变时重置全屏状态
  window.addEventListener('resize', () => {
    if (!isMobile() && isFullscreen) {
      toggleFullscreen(false);
    }
  });
});

// 重复的初始化代码已移除
let r=[],i=1,a=null,s=null,d=new Set,u=null,l=null,m=!1,f=15,y=!1,currentPage=1,pageSize=50,totalPages=1;

// 多重加密验证状态系统
let _0x1a2b3c = false;
let _0x4d5e6f = null;
let _0x7g8h9i = [];
let _0x0j1k2l = new Date().getTime();
let _0x3m4n5o = 'aGVsbG93b3JsZA==';
let _0x9p8q7r = Math.random().toString(36).substring(2);
let _0x5s6t7u = btoa(window.location.href).slice(-10);

// 验证令牌生成和检查系统
function _0xVerifyToken() {
    const _0xTime = new Date().getTime();
    const _0xDiff = _0xTime - _0x0j1k2l;
    if (_0xDiff > 3600000) return false; // 1小时过期
    
    const _0xHash = btoa(String.fromCharCode(..._0x7g8h9i));
    const _0xCheck = _0x4d5e6f && _0x1a2b3c && _0xHash.length > 0;
    
    // 额外的完整性检查
    const _0xIntegrity = _0x9p8q7r.length > 5 && _0x5s6t7u.length > 5;
    
    return _0xCheck && _0xIntegrity;
}

// 设置验证状态
function _0xSetAuth(_0xToken) {
    _0x1a2b3c = true;
    _0x4d5e6f = _0xToken;
    _0x7g8h9i = Array.from(_0xToken).map(c => c.charCodeAt(0));
    _0x0j1k2l = new Date().getTime();
    _0x9p8q7r = btoa(_0xToken).slice(0, 10);
    _0xStartTimer(); // 启动定时验证
}

// 验证检查包装器
function _0xAuthCheck() {
    if (!_0xIntegrityCheck()) return false;
    if (!_0xAntiDebug()) {
        _0x1a2b3c = 0;
        return false;
    }
    if (!_0xVerifyToken()) {
        return false;
    }
    return true;
}

// 假的验证逻辑 - 陷阱代码
let fakeAuth = false;
function enableFakeAuth() { fakeAuth = true; }
function checkFakeAuth() { return fakeAuth; }
function validateLicense() { return Math.random() > 0.5; }
function isValidUser() { return localStorage.getItem('user') === 'valid'; }

// 反调试检查
function _0xAntiDebug() {
    const start = performance.now();
    debugger;
    const end = performance.now();
    return (end - start) < 100;
}

// 动态验证码生成
function _0xDynamicCode() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000000);
    return btoa(timestamp + ':' + random + ':' + _0x1a2b3c);
}

// 定时验证检查
// 定时验证机制 - 只有在用户已验证后才启动
let _0xTimerStarted = false;
function _0xStartTimer() {
    if (_0xTimerStarted) return;
    _0xTimerStarted = true;
    setInterval(() => {
        if (_0x1a2b3c && !_0xAuthCheck()) {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">验证失效，请重新加载页面</div>';
            setTimeout(() => location.reload(), 2000);
        }
    }, 30000); // 每30秒检查一次
}

// 代码完整性检查
function _0xIntegrityCheck() {
    const _0xFuncs = [_0xVerifyToken, _0xSetAuth, _0xAuthCheck];
    for (let _0xFunc of _0xFuncs) {
        if (typeof _0xFunc !== 'function') {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">系统检测到异常，请刷新页面</div>';
            return false;
        }
    }
    return true;
}

// 兼容性变量（保持原有功能）
// 兼容性变量（保持原有功能）
let b = false;
const h = "pk4_access_key";
const g = document.getElementById("keyModal");
const p = document.getElementById("keyInput");
const v = document.getElementById("output");
const x = document.getElementById("tableContainer");
const w = document.getElementById("horizontalThumb");
const k = document.getElementById("horizontalFill");
const $ = document.getElementById("verticalSlider");
const B = document.getElementById("verticalThumb");
const I = document.getElementById("verticalFill");
const M = document.getElementById("numButtons");

function N(t) {
    t.forEach(e => e.addEventListener("click", () => {
        t.forEach(t => t.classList.remove("btn-active"));
        e.classList.add("btn-active");
        console.log('位置选择已更改，等待确认按钮点击');
    }));
}

function C(t) {
    t.forEach(t => {
        // 设置初始样式
        t.style.backgroundColor = '#e5e7eb'; // gray-200
        t.style.color = '#374151'; // gray-700
        t.style.cursor = 'pointer';
        t.style.transition = 'all 0.2s ease';
        
        t.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('*** 命中码数按钮点击事件触发 ***', t.textContent, t.dataset.hit);
            
            // 切换选中状态
            if (t.classList.contains("btn-active")) {
                // 取消选中
                console.log('*** 移除选中状态 ***');
                t.classList.remove("btn-active");
                t.style.backgroundColor = '#e5e7eb'; // gray-200
                t.style.color = '#374151'; // gray-700
            } else {
                // 选中
                console.log('*** 添加选中状态 ***');
                t.classList.add("btn-active");
                t.style.backgroundColor = '#3b82f6'; // blue-500
                t.style.color = 'white';
            }
            
            console.log('*** 当前按钮类名 ***', t.className);
            console.log('命中码数选择已更改，等待确认按钮点击');
        });
    });
}
// 立即输出调试信息
console.log('*** 脚本开始执行 ***');
console.log('*** 当前时间戳:', Date.now(), '***');

// 初始化命中码数按钮
document.addEventListener('DOMContentLoaded', function() {
    console.log('*** DOMContentLoaded事件触发 ***');
    const S = document.getElementById("hitButtons");
    if (!S) {
        console.error('hitButtons元素未找到');
        return;
    }
    console.log('*** hitButtons元素找到，开始初始化 ***');
    
    [0,1,2,3,4,5].forEach(t=>{const e=document.createElement("button");e.className="px-3 py-1 rounded-md bg-gray-200 btn-hover",e.dataset.hit=t,e.textContent=t+"胆",S.appendChild(e)});
    
    // 移除默认选中状态 - 页面加载时命中码数都不选中
    // document.querySelector('#hitButtons button[data-hit="2"]').classList.add("btn-active");
    // document.querySelector('#hitButtons button[data-hit="3"]').classList.add("btn-active");
    
    // 移除默认选中状态 - 页面加载时命中数字都不选中
    // const defaultHitNumbers = [1, 2, 3, 4, 5, 6];
    // defaultHitNumbers.forEach(num => {
    //     const button = document.querySelector(`.hit-number-btn[data-number="${num}"]`);
    //     if (button) {
    //         button.classList.add('btn-active', 'bg-primary', 'text-white');
    //         button.classList.remove('border-gray-300');
    //     }
    // });
    
    C(Array.from(S.children));
    
    // 位置选择按钮事件处理 - 全新实现
    console.log('=== 开始初始化位置选择按钮 ===');
    
    // 等待DOM完全加载
    setTimeout(() => {
        const positionButtons = document.querySelectorAll('.position-btn');
        console.log('找到位置选择按钮数量:', positionButtons.length);
        
        if (positionButtons.length === 0) {
            console.error('未找到位置选择按钮！');
            return;
        }
        
        // 为每个按钮添加点击事件
        positionButtons.forEach((button, index) => {
            // 设置初始样式
            button.style.backgroundColor = '#e5e7eb'; // gray-200
            button.style.color = '#374151'; // gray-700
            button.style.cursor = 'pointer';
            button.style.transition = 'all 0.2s ease';
            
            // 位置按钮状态切换函数
            function togglePositionButton() {
                console.log('位置按钮点击:', button.textContent, button.dataset.position);
                
                // 切换选中状态
                if (button.classList.contains('btn-active')) {
                    // 取消选中
                    button.classList.remove('btn-active');
                    button.style.backgroundColor = '#e5e7eb'; // gray-200
                    button.style.color = '#374151'; // gray-700
                    console.log('取消选中:', button.textContent);
                } else {
                    // 选中
                    button.classList.add('btn-active');
                    button.style.backgroundColor = '#3b82f6'; // blue-500
                    button.style.color = 'white';
                    console.log('选中:', button.textContent);
                }
                
                // 输出当前选中状态
                const selectedPositions = Array.from(document.querySelectorAll('.position-btn.btn-active'))
                    .map(btn => btn.dataset.position);
                console.log('当前选中位置:', selectedPositions);
                
                // 移除立即筛选，等待确认按钮点击
                console.log('位置选择已更改，等待确认按钮点击');
            }
            
            // 移动端触摸事件处理变量
            let touchStartTime = 0;
            let touchMoved = false;
            let touchHandled = false;
            
            // 添加点击事件（仅在非触摸设备上生效）
            button.addEventListener('click', function(e) {
                // 如果触摸事件已处理，则跳过click事件
                if (touchHandled) {
                    touchHandled = false;
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                togglePositionButton();
            });
            
            // 添加移动端触摸事件处理
            button.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchMoved = false;
                touchHandled = false;
                // 添加触摸开始的视觉反馈
                this.style.opacity = '0.7';
            }, { passive: true });
            
            button.addEventListener('touchmove', function(e) {
                touchMoved = true;
                // 移除视觉反馈
                this.style.opacity = '';
            }, { passive: true });
            
            button.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                // 恢复视觉反馈
                this.style.opacity = '';
                
                // 如果是快速点击且没有移动，则触发状态切换
                if (!touchMoved && touchDuration < 500) {
                    touchHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    togglePositionButton();
                    // 延迟重置标志，确保click事件被跳过
                    setTimeout(() => {
                        touchHandled = false;
                    }, 100);
                }
            }, { passive: true });
            
            button.addEventListener('touchcancel', function(e) {
                // 恢复视觉反馈
                this.style.opacity = '';
                touchHandled = false;
            }, { passive: true });
            
            console.log(`位置按钮 ${index + 1} (${button.textContent}) 初始化完成`);
        });
        
        // 添加测试函数
        window.testPositionButton = function() {
            console.log('=== 测试位置选择按钮 ===');
            const buttons = document.querySelectorAll('.position-btn');
            if (buttons.length > 0) {
                console.log('模拟点击第一个按钮:', buttons[0].textContent);
                buttons[0].click();
            } else {
                console.error('未找到位置按钮！');
            }
        };
        
        console.log('=== 位置选择按钮初始化完成 ===');
    }, 100);
    
    console.log('*** 位置选择按钮事件绑定完成 ***');
    
    console.log('*** 按钮创建完成，开始调试输出 ***');
    
    // 调试：输出初始选择状态
    setTimeout(() => {
        console.log('=== 初始化完成，当前选择状态 ===');
        console.log('前五码数:', document.getElementById('numSelect').value);
        console.log('命中数字:', Array.from(document.querySelectorAll('.hit-number-btn.btn-active')).map(btn => btn.dataset.number));
        console.log('命中码数:', Array.from(document.querySelectorAll('#hitButtons .btn-active')).map(btn => btn.dataset.hit));
        console.log('=== 初始化状态输出完成 ===');
        
        // 移除自动筛选，等待用户点击确认按钮
        console.log('页面初始化完成，等待用户点击确认按钮进行筛选');
    }, 100);
});

// 前五码数下拉选择框事件监听 - 移除立即筛选
const numSelect = document.getElementById('numSelect');
if (numSelect) {
    numSelect.addEventListener('change', function() {
        console.log('前五码数选择已更改:', this.value);
        // 移除立即筛选，等待确认按钮点击
    });
}

// 位置选择按钮事件处理将在DOMContentLoaded中进行

let T=null;function D(t){const e=document.getElementById("keyCountdown"),n=document.getElementById("timeRemaining");function o(){const o=new Date,c=new Date(1e3*t)-o;if(c<=0){n.textContent="已过期",e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500"),clearInterval(T);const t=Y();return localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,void setTimeout(()=>{window.location.reload()},3e3)}const r=Math.floor(c/864e5),i=Math.floor(c%864e5/36e5),a=Math.floor(c%36e5/6e4),s=Math.floor(c%6e4/1e3);n.textContent=`${r}天 ${i}小时 ${a}分钟 ${s}秒`;const d=24*r+i;d<=24?(e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500")):d<=72?(e.classList.remove("bg-primary","bg-red-500"),e.classList.add("bg-amber-500")):(e.classList.remove("bg-amber-500","bg-red-500"),e.classList.add("bg-primary"))}T&&clearInterval(T),o(),e.classList.remove("hidden"),T=setInterval(o,1e3);}function generateDeviceFingerprint(){
  // 使用固定的通用指纹，允许密钥在任何设备上使用
  // 这样可以确保密钥的跨设备兼容性
    return 'universal_device_2024';
 }

// 生成校验和函数
function generateChecksum(data) {
    // 使用与密钥生成器相同的增强校验和算法
    return generateEnhancedChecksum(data);
}

// 生成确定性校验和（6个字符）- 验证时必须确定性
function generateEnhancedChecksum(input) {
    // 使用多重哈希算法但保持确定性
    let hash1 = 0;
    let hash2 = 0;
    
    for (let i = 0; i < input.length; i++) {
        const char = input.charCodeAt(i);
        // 第一个哈希
        hash1 = ((hash1 << 5) - hash1) + char;
        hash1 = hash1 & hash1;
        
        // 第二个哈希（不同的算法）
        hash2 = ((hash2 << 3) + hash2) ^ char;
        hash2 = hash2 & hash2;
    }
    
    // 组合两个哈希值（移除时间戳微扰动以保持确定性）
    const combinedHash = Math.abs(hash1) + Math.abs(hash2);
    
    // 生成6位校验和
    let checksum = combinedHash.toString(36).substring(0, 6);
    if (checksum.length < 6) {
        // 如果不足6位，用确定性字符补充
        const padding = '0123456789abcdefghijklmnopqrstuvwxyz';
        for (let i = checksum.length; i < 6; i++) {
            checksum += padding[(combinedHash + i) % padding.length];
        }
    }
    
    return checksum.substring(0, 6);
}

// 生成安全随机字符串（与密钥生成器保持一致）
function generateSecureRandomString(length) {
    const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
    
    // 检查是否支持crypto API
    if (window.crypto && window.crypto.getRandomValues) {
        const array = new Uint8Array(length);
        window.crypto.getRandomValues(array);
        
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[array[i] % chars.length];
        }
        return result;
    } else {
        // 降级到Math.random()（兼容性处理）
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
        }
        return result;
    }
}

// 纯本地记录密钥使用信息
function recordKeyUsage(keyData) {
    try {
        const deviceId = generateDeviceFingerprint();
        const localRecord = {
            keyId: keyData.nonce,
            deviceId: deviceId,
            deviceInfo: navigator.userAgent,
            usedAt: new Date().toISOString(),
            expiresAt: new Date(keyData.expiry * 1000).toISOString(),
            savedLocally: true
        };
        
        // 保存到本地存储
        localStorage.setItem(`keyRecord_${keyData.nonce}`, JSON.stringify(localRecord));
        console.log('密钥使用记录已保存到本地:', localRecord);
        
        return { success: true, data: localRecord, localBackup: true };
    } catch (error) {
        console.error('记录密钥使用信息失败:', error);
        return { success: false, error: error.message };
    }
}

// 纯本地密钥使用状态检查
function O(t){console.log("使用本地验证检查密钥:",t);return{used:JSON.parse(localStorage.getItem("usedNonces")||"[]").includes(t)}}// 纯本地密钥标记为已使用
function K(t){console.log("本地标记密钥为已使用:",t);const e=JSON.parse(localStorage.getItem("usedNonces")||"[]");return e.includes(t)||(e.push(t),localStorage.setItem("usedNonces",JSON.stringify(e)),console.log("本地记录nonce:",t)),{success:!0}}
const P=document.getElementById("verifyKeyBtn");function E(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return null;e=t.trim().split(/\s+/)}if(e.length<2)return null;const n=e[0].trim();let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return null;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}return 10!==o.length||o.some(isNaN)?null:{period:n,data:o}}async function A(t){try{// 支持新的短密钥格式（约22个字符）
if(t.length <= 25) {
// 短密钥格式：前4位标识符 + 6位时间戳 + 6位随机填充 + 6位校验和 = 22位
if(t.length < 20 || t.length > 25) return {valid: false, reason: "密钥格式无效"};

const identifier = t.substring(0, 4);
const timestampPart = t.substring(4, 10);
const randomPadding = t.substring(10, 16);
const checksum = t.substring(16, 22);

// 解析有效期（新的随机标识符格式）
// 标识符现在是完全随机的，不再用于识别有效期
// 时间戳部分直接包含过期时间戳
const expiry = parseInt(timestampPart, 36);

// 验证时间戳是否有效（基本范围检查）
if (isNaN(expiry) || expiry <= 0) {
    return {valid: false, reason: "密钥时间戳无效"};
}

// 检查是否过期
const currentTime = Math.floor(Date.now() / 1000);
if(currentTime > expiry) {
return {valid: false, reason: "密钥已过期"};
}

// 验证校验和
const expectedChecksum = generateChecksum(identifier + timestampPart + randomPadding);
if(checksum !== expectedChecksum) {
return {valid: false, reason: "密钥校验失败"};
}

// 纯本地验证（短密钥）
        const nonce = t; // 使用整个短密钥作为nonce
        
        console.log('使用纯本地验证短密钥:', nonce);
        
        // 检查是否已被使用
        const usedNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
        if (usedNonces.includes(nonce)) {
            return {valid: false, reason: "密钥已被使用，每个密钥只能使用一次"};
        }
        
        // 本地标记为已使用
        usedNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(usedNonces));
        console.log('本地标记短密钥为已使用:', nonce);
        
        return {valid: true, data: {nonce: nonce, expiry: expiry, deviceFingerprint: "universal"}};
}

// 纯本地长密钥格式验证 - 长密钥已全部失效
const e=atob(t),n=decodeURIComponent(escape(e)),o=JSON.parse(n);if(!o.expiry||!o.nonce||!o.deviceFingerprint)return{valid:!1,reason:"密钥缺少必要字段"};const c=(new Date).getTime();if(Math.floor(c/1e3)>o.expiry)return{valid:!1,reason:"密钥已过期"};const r=generateDeviceFingerprint();if(o.deviceFingerprint!==r)return{valid:!1,reason:"此密钥不可在当前设备使用"};console.log('检测到长密钥，已失效:',o.nonce);return{valid:!1,reason:"长密钥已失效，请使用新的短密钥"}}catch(t){return t instanceof DOMException&&"InvalidCharacterError"===t.name?{valid:!1,reason:"密钥Base64解码失败"}:t instanceof SyntaxError?{valid:!1,reason:"密钥JSON格式无效"}:{valid:!1,reason:"验证过程异常: "+t.message}}}

// 纯本地检查密钥是否已被使用
function checkKeyOnlineUsage(nonce) {
    console.log('使用纯本地验证检查密钥:', nonce);
    return { used: JSON.parse(localStorage.getItem('usedNonces') || '[]').includes(nonce) };
}

// 纯本地标记密钥为已使用
function markKeyAsUsedOnline(nonce) {
    console.log('使用纯本地标记密钥为已使用:', nonce);
    const usedNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
    if (!usedNonces.includes(nonce)) {
        usedNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(usedNonces));
        console.log('本地标记nonce:', nonce);
    }
    return { success: true };
}

    // 纯本地记录密钥使用信息（备用函数）
    function recordKeyUsageBackup(keyData) {
      try {
        const localRecord = {
            keyId: keyData.nonce,
            deviceInfo: navigator.userAgent,
            usedAt: new Date().toISOString(),
            expiryTime: new Date(keyData.expiry * 1000).toISOString(),
            createdTime: new Date().toISOString(),
            savedLocally: true
        };
        
        localStorage.setItem(`keyRecordBackup_${keyData.nonce}`, JSON.stringify(localRecord));
        console.log('密钥使用记录已保存到本地（备用）:', localRecord);
        return { success: true, data: localRecord, localBackup: true };
      } catch (error) {
        console.error('记录密钥使用信息失败:', error);
        // 网络失败时的本地备用方案
        const localRecord = {
          keyId: keyData.nonce,
          deviceInfo: navigator.userAgent,
          usedAt: new Date().toISOString(),
          savedLocally: true
        };
        localStorage.setItem(`keyRecord_${keyData.nonce}`, JSON.stringify(localRecord));
        return { success: false, error: error.message, localBackup: true };
      }
    }

function F(){const t=document.getElementById("numbersInput").value.trim().split(/\n+/).filter(Boolean);if(!t.length)return void(v.textContent="请输入数据");let e=0;for(const n of t){const t=E(n);if(!t)return void(v.textContent="格式错误：请输入正确的数据格式");const{period:o,data:c}=t,i=c.join(",");d.has(o)||r.length&&r[r.length-1].input===i||(r.push({period:o,data:c,input:i}),d.add(o),e++)}document.getElementById("numbersInput").value="",v.textContent=e>0?`成功添加 ${e} 期数据`:"没有新数据添加";console.log(`F()函数: 添加 ${e} 期新数据后，数据数组长度为 ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`F()函数: 期数统计已更新为 ${r.length}`);r.sort((t,e)=>{const n=t.period.toString();const o=e.period.toString();return o.localeCompare(n)}); 
    // 调用表格渲染函数显示数据
    L();
    console.log('F()函数: 已调用L()函数渲染表格');
}
// 云端数据库功能已禁用 - J函数中的API调用代码已移除
// 替代函数：禁用云端数据获取功能
function J(){
    v.textContent="云端数据库功能已禁用，请手动输入数据";
    console.log('云端数据库功能已禁用');
}
function R(t,e){const n=[];return function o(c,r){if(r.length!==e)for(let e=c;e<t.length;e++)r.push(t[e]),o(e+1,r),r.pop();else n.push(r.slice())}(0,[]),n}

/**
 * 黄金切割（必须 5 中 4）：任意注数 → 5 组
 * 思路：为每条注单指定唯一"缺席组"omitted = 0..4
 * 第 g 组收集所有 omitted !== g 的注单
 * 结论：任意 4 组合并 = 全集（严格保证）
 * 
 * assign: 'roundrobin' 更均匀；'hash' 更稳定（同一注单长期落同一缺席组）
 */
function goldenSplit5in4(data, assign = 'roundrobin') {
  const G = 5;
  const groups = Array.from({ length: G }, () => []);

  // 缺席组索引（每注唯一）
  const omittedIdx = new Array(data.length);

  if (assign === 'hash') {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = hash5(data[i]); // 0..4
    }
  } else {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = i % G; // 轮转
    }
  }

  // 构建 5 组：每注出现在 4 个组
  for (let i = 0; i < data.length; i++) {
    const omit = omittedIdx[i];
    for (let g = 0; g < G; g++) {
      if (g !== omit) groups[g].push(data[i]);
    }
  }
  return groups;

  function hash5(str) {
    let h = 2166136261 >>> 0;
    for (let j = 0; j < str.length; j++) {
      h ^= str.charCodeAt(j);
      h = Math.imul(h, 16777619);
    }
    return h % 5;
  }
}

/** 校验：任意四组合并是否等于全集（严格 5 中 4） */
function validate5in4(groups, original) {
  const uniq = (arr) => Array.from(new Set(arr));
  const origSet = new Set(uniq(original));
  const G = groups.length;

  for (let miss = 0; miss < G; miss++) {
    const merged = new Set();
    for (let g = 0; g < G; g++) {
      if (g === miss) continue;
      for (const x of groups[g]) merged.add(x);
    }
    if (merged.size !== origSet.size) return false;
    // 也可逐条核对
    for (const x of origSet) if (!merged.has(x)) return false;
  }
  return true;
}

/** 解析输入：支持换行/逗号分隔；自动去重；保持原顺序的唯一化 */
function parseInput(raw) {
  const parts = raw
    .split(/[\n,]+/g)
    .map(s => s.trim())
    .filter(Boolean);
  const seen = new Set();
  const out = [];
  for (const p of parts) {
    if (!seen.has(p)) { seen.add(p); out.push(p); }
  }
  return out;
}

// 验证任意4组组合后是否为全集
function validate_5in4(groups) {
    if (!groups || groups.length < 4) {
        return {
            valid: false,
            results: {},
            all_valid: false,
            total_data_size: 0
        };
    }
    
    // 获取所有数据的并集
    const all_set = new Set();
    groups.forEach(group => {
        group.forEach(item => all_set.add(item));
    });
    
    const results = {};
    const total_data_size = all_set.size;
    
    // 生成所有4组的组合
    const combinations = [];
    for (let i = 0; i < groups.length; i++) {
        for (let j = i + 1; j < groups.length; j++) {
            for (let k = j + 1; k < groups.length; k++) {
                for (let l = k + 1; l < groups.length; l++) {
                    combinations.push([i, j, k, l]);
                }
            }
        }
    }
    
    // 验证每个4组组合
    combinations.forEach(combo => {
        const merged = new Set();
        combo.forEach(i => {
            groups[i].forEach(item => merged.add(item));
        });
        
        const is_complete = merged.size === total_data_size;
        results[combo.join(',')] = {
            combo: combo,
            size: merged.size,
            is_complete: is_complete,
            coverage: total_data_size > 0 ? (merged.size / total_data_size) : 0
        };
    });
    
    // 检查是否所有组合都完整
    const all_valid = Object.values(results).every(r => r.is_complete);
    
    return {
        valid: all_valid,
        results: results,
        all_valid: all_valid,
        total_data_size: total_data_size,
        combinations_count: combinations.length
    };
}

// 渲染黄金切割结果 - 5个紧凑框布局
function renderGoldenResults(groups, originalItems = [], isValid = false) {
    const resultsContainer = document.getElementById('goldenResults');
    const resultSummary = document.getElementById('resultSummary');
    const validationResults = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    resultsContainer.innerHTML = '';
    
    if (!groups || groups.length === 0) {
        resultsContainer.innerHTML = '<div class="col-span-5 text-center text-gray-500 py-8">暂无分割结果</div>';
        resultSummary.textContent = '';
        validationResults.classList.add('hidden');
        return;
    }
    
    // 更新摘要信息
    const totalItems = groups.reduce((sum, group) => sum + group.length, 0);
    const avgGroupSize = Math.round(totalItems / groups.length);
    resultSummary.innerHTML = `共${groups.length}组，总计${totalItems}项，平均每组${avgGroupSize}项 | 验证结果：${isValid ? '<span class="text-green-600 font-semibold">✅ 通过</span>' : '<span class="text-red-600 font-semibold">❌ 失败</span>'}`;
    
    // 显示验证结果
    if (originalItems.length > 0) {
        validationContent.innerHTML = `
            <div class="text-sm text-gray-600">
                <p class="mb-2">原始数据：${originalItems.length} 注</p>
                <p class="mb-2">分组结果：${groups.length} 组</p>
                <p class="mb-2">5中4验证：${isValid ? '<span class="text-green-600 font-semibold">通过 - 任意4组合并等于全集</span>' : '<span class="text-red-600 font-semibold">失败 - 不满足5中4条件</span>'}</p>
            </div>
        `;
        validationResults.classList.remove('hidden');
    } else {
        validationResults.classList.add('hidden');
    }
    
    // 确保显示5个框，不足的用空框填充
    const displayGroups = [...groups];
    while (displayGroups.length < 5) {
        displayGroups.push([]);
    }
    
    // 生成5个紧凑的分组框
    displayGroups.slice(0, 5).forEach((group, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'bg-white border border-gray-200 rounded-lg p-3';
        
        if (group.length === 0) {
            // 空框
            groupDiv.innerHTML = `
                <div class="text-center text-gray-400 py-4">
                    <div class="text-sm font-medium mb-1">组 ${index + 1}</div>
                    <div class="text-xs">暂无数据</div>
                </div>
            `;
        } else {
            // 有数据的框
            groupDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-800 text-sm">组 ${index + 1}</h4>
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">${group.length}项</span>
                        <button 
                            onclick="copyGroupData(${index})" 
                            class="px-1 py-0.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                            title="复制本组数据"
                        >
                            复制
                        </button>
                    </div>
                </div>
                <div class="max-h-32 overflow-y-auto">
                    <div class="text-xs space-y-1" id="group-${index}-data" data-full-data="${group.join(',')}">
                        ${group.slice(0, 200).map(item => `<div class="p-1 bg-gray-50 rounded text-center hover:bg-gray-100 transition-colors">${item}</div>`).join('')}
                        ${group.length > 200 ? '<div class="p-1 text-center text-gray-400 text-xs">...还有' + (group.length - 200) + '项</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        resultsContainer.appendChild(groupDiv);
    });
}

// 复制组数据功能
function copyGroupData(groupIndex) {
    const groupDataDiv = document.getElementById(`group-${groupIndex}-data`);
    if (!groupDataDiv) {
        alert('未找到数据');
        return;
    }
    
    // 从data-full-data属性获取完整数据，确保复制全部数据而不受显示限制影响
    const dataText = groupDataDiv.getAttribute('data-full-data') || '';
    
    if (!dataText) {
        alert('没有可复制的数据');
        return;
    }
    
    // 复制到剪贴板
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(dataText).then(() => {
            // 显示复制成功提示
            showCopySuccess(groupIndex);
        }).catch(err => {
            console.error('复制失败:', err);
            fallbackCopyTextToClipboard(dataText, groupIndex);
        });
    } else {
        fallbackCopyTextToClipboard(dataText, groupIndex);
    }
}

// 备用复制方法
function fallbackCopyTextToClipboard(text, groupIndex) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    textArea.style.opacity = '0';
    textArea.style.pointerEvents = 'none';
    // 防止移动端弹出输入法
    textArea.readOnly = true;
    textArea.setAttribute('readonly', 'readonly');
    textArea.setAttribute('inputmode', 'none');
    document.body.appendChild(textArea);
    
    // 在移动端避免使用focus，直接选择文本
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobile) {
        textArea.focus();
    }
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(groupIndex);
        } else {
            alert('复制失败，请手动选择复制');
        }
    } catch (err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动选择复制');
    }
    
    document.body.removeChild(textArea);
}

// 重置所有复制按钮状态（仅在重新切割时调用）
function resetAllCopyButtons() {
    const allCopyButtons = document.querySelectorAll('button[onclick^="copyGroupData("]');
    allCopyButtons.forEach(btn => {
        btn.innerHTML = '复制';
        btn.classList.remove('bg-green-500');
        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    });
}

// 显示复制成功提示
function showCopySuccess(groupIndex) {
    // 设置当前按钮为已复制状态（持久显示）
    const button = document.querySelector(`button[onclick="copyGroupData(${groupIndex})"]`);
    if (button) {
        button.innerHTML = '<i class="fa fa-check"></i> 已复制';
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        button.classList.add('bg-green-500');
    }
}

// 渲染验证结果
function renderValidationResults(validation) {
    const validationContainer = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    if (!validation || !validation.results) {
        validationContainer.classList.add('hidden');
        return;
    }
    
    validationContainer.classList.remove('hidden');
    
    let html = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                总数据量: ${validation.total_data_size} 注 | 
                验证组合数: ${validation.combinations_count} 个 | 
                整体验证: ${validation.all_valid ? '<span class="text-green-600 font-semibold">✅ 通过</span>' : '<span class="text-red-600 font-semibold">❌ 失败</span>'}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;
    
    Object.entries(validation.results).forEach(([comboKey, result]) => {
        const comboText = result.combo.map(i => `组${i + 1}`).join(' + ');
        const statusClass = result.is_complete ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const statusIcon = result.is_complete ? '✅' : '❌';
        
        html += `
            <div class="${statusClass} border rounded-lg p-3">
                <div class="font-medium text-sm">${comboText}</div>
                <div class="text-xs text-gray-600 mt-1">
                    ${result.size}注 (${(result.coverage * 100).toFixed(1)}%) ${statusIcon}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    validationContent.innerHTML = html;
}function H(t,e){const n={};return e.forEach(e=>{let o=0,c=0,r=0,i=0;t.forEach(t=>{t.cells[e].hit?(r++,i=0,r>o&&(o=r)):(i++,r=0,i>c&&(c=i))}),n[e]={maxHit:o,maxMiss:c}}),n}function U(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&t[n].cells[e].hit;n++)o++;n[e]=o}),n}function z(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&!t[n].cells[e].hit;n++)o++;n[e]=o}),n}function L(){const t=document.querySelector("#resultTable thead"),e=document.querySelector("#resultTable tbody");t.innerHTML="",e.innerHTML="";console.log('筛选函数L()开始执行，数据长度:', r.length);if(!r.length){const t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=100,n.className="py-4 text-center text-gray-500",n.textContent="暂无数据，请先输入或获取数据",t.appendChild(n),e.appendChild(t),void j()}console.log('数据存在，开始处理表格渲染');// 从下拉选择框获取前五码数
const numSelect = document.getElementById('numSelect');
const selectedNums = numSelect && numSelect.value ? [parseInt(numSelect.value)] : [];

// 从按钮获取位置选择
const selectedPositions = Array.from(document.querySelectorAll('.position-btn.btn-active')).map(btn => parseInt(btn.dataset.position));

// 从按钮获取命中数字选择
const selectedHitNumbers = Array.from(document.querySelectorAll('.hit-number-btn.btn-active')).map(btn => parseInt(btn.dataset.number));

const c=Array.from(document.querySelectorAll("#hitButtons .btn-active")).map(t=>+t.dataset.hit),i=[...Array(10)].map((t,e)=>e+1);

// 使用完整的数据数组，不进行截取
const n = r.slice(); // 使用完整数据
console.log('L()函数: 使用完整数据数组，长度为', n.length, '期数限制f为', f);

// 生成筛选后的组合
let filteredCombos = [];
// 获取前五码数选择
const numToSelect = selectedNums.length > 0 ? selectedNums[0] : (numSelect && numSelect.value ? parseInt(numSelect.value) : 3);

// 检查是否有选择条件，如果都没有选择则使用默认逻辑
if (selectedHitNumbers.length > 0 && c.length > 0) {
  // 根据前五码数、命中码数、命中数字进行筛选
  
  if ((numToSelect === 3 || numToSelect === 5) && selectedHitNumbers.length === 6 && 
      selectedHitNumbers.every(num => num >= 1 && num <= 6) &&
      selectedHitNumbers.includes(1) && selectedHitNumbers.includes(2) && 
      selectedHitNumbers.includes(3) && selectedHitNumbers.includes(4) && 
      selectedHitNumbers.includes(5) && selectedHitNumbers.includes(6) &&
      c.includes(2) && c.includes(3)) {
      
    if (numToSelect === 3) {
      // 特殊情况：3码，命中数字1-6，命中码数2和3
      // 从1-10中选3个数字，包含1-6中的2个或3个数字
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const hitNumbers = [1, 2, 3, 4, 5, 6]; // 1-6
      const nonHitNumbers = [7, 8, 9, 10]; // 7-10
      
      // 包含1-6中2个数字的情况：C(6,2) * C(4,1) * A(3,3) = 15 * 4 * 6 = 360
      const hit2Combos = R(hitNumbers, 2); // C(6,2) = 15种组合
      hit2Combos.forEach(hit2 => {
        nonHitNumbers.forEach(nonHit => {
          const combo = [...hit2, nonHit]; // 3个数字的组合
          // 生成所有排列 A(3,3) = 6种排列
          const perms = generatePermutations(combo);
          filteredCombos.push(...perms);
        });
      });
      
      // 包含1-6中3个数字的情况：C(6,3) * A(3,3) = 20 * 6 = 120
      const hit3Combos = R(hitNumbers, 3); // C(6,3) = 20种组合
      hit3Combos.forEach(hit3 => {
        // 生成所有排列 A(3,3) = 6种排列
        const perms = generatePermutations(hit3);
        filteredCombos.push(...perms);
      });
      
      // 总计：360 + 120 = 480注
    } else if (numToSelect === 5) {
      // 特殊情况：5码，命中数字1-6，命中码数2和3
      // 从1-10中选5个数字，包含1-6中的2个或3个数字
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const hitNumbers = [1, 2, 3, 4, 5, 6]; // 1-6
      const nonHitNumbers = [7, 8, 9, 10]; // 7-10
      
      // 包含1-6中2个数字的情况：C(6,2) * C(4,3) * A(5,5) = 15 * 4 * 120 = 7200
      const hit2Combos = R(hitNumbers, 2); // C(6,2) = 15种组合
      const nonHit3Combos = R(nonHitNumbers, 3); // C(4,3) = 4种组合
      hit2Combos.forEach(hit2 => {
        nonHit3Combos.forEach(nonHit3 => {
          const combo = [...hit2, ...nonHit3]; // 5个数字的组合
          // 生成所有排列 A(5,5) = 120种排列
          const perms = generatePermutations(combo);
          filteredCombos.push(...perms);
        });
      });
      
      // 包含1-6中3个数字的情况：C(6,3) * C(4,2) * A(5,5) = 20 * 6 * 120 = 14400
      const hit3Combos = R(hitNumbers, 3); // C(6,3) = 20种组合
      const nonHit2Combos = R(nonHitNumbers, 2); // C(4,2) = 6种组合
      hit3Combos.forEach(hit3 => {
        nonHit2Combos.forEach(nonHit2 => {
          const combo = [...hit3, ...nonHit2]; // 5个数字的组合
          // 生成所有排列 A(5,5) = 120种排列
          const perms = generatePermutations(combo);
          filteredCombos.push(...perms);
        });
      });
      
      // 总计：7200 + 14400 = 21600注
    }
  } else {
    // 原有逻辑
    const allCombos = R(i, numToSelect); // 生成所有可能的组合
    
    const validCombos = allCombos.filter(combo => {
      // 检查组合中包含的命中数字个数
      const hitCount = combo.filter(num => selectedHitNumbers.includes(num)).length;
      return c.includes(hitCount); // 命中个数必须在选中的命中码数范围内
    });
    
    // 对每个有效组合进行展开：将每个数字轮流置为第1位
    filteredCombos = [];
    validCombos.forEach(combo => {
      combo.forEach(firstNum => {
        const remainingNums = combo.filter(num => num !== firstNum).sort((a, b) => a - b);
        const expandedCombo = [firstNum, ...remainingNums];
        filteredCombos.push(expandedCombo);
      });
    });
  }
} else {
  // 当没有选择命中数字或命中码数时的默认逻辑
  if (selectedNums.length > 0) {
    filteredCombos = selectedNums.flatMap(o=>o>0&&o<=10?R(i,o):[]);
  } else {
    // 如果前五码数也没有选择，使用默认的3码组合
    filteredCombos = R(i, numToSelect);
  }
}

// 合并筛选组合和自定义组合
let allCombos = [...filteredCombos,...document.getElementById("customCombos").value.trim().split(/\s+/).filter(Boolean).map(t=>t.split(",").map(t=>+t).filter(t=>!isNaN(t)))].filter(t=>t.length>0);

// 对相同数字组合进行去重处理
const uniqueCombos = new Map();
allCombos.forEach(combo => {
    // 将数字组合排序后作为唯一标识
    const sortedKey = combo.slice().sort((a,b)=>a-b).join(',');
    if (!uniqueCombos.has(sortedKey)) {
        uniqueCombos.set(sortedKey, combo.join(','));
    }
});

// 获取去重后的组合数组
const a = Array.from(uniqueCombos.values());
// 根据期数限制截取数据用于显示，但确保不超过实际数据长度
const actualLimit = Math.min(n.length, f);
const displayData = n.slice(0, actualLimit);
const s=displayData.map(t=>({rec:t,cells:{}}));
// 修复分页计算：确保totalPages基于实际显示的数据行数
totalPages=Math.max(1, Math.ceil(s.length/pageSize));
console.log('原始组合数量:', allCombos.length);
console.log('去重后组合数量:', a.length);
console.log('完整数据长度:', n.length, '期数限制:', f, '实际限制:', actualLimit);
console.log('显示数据长度:', displayData.length);
console.log('处理的数据行数:', s.length);
console.log('总页数计算:', totalPages, '= Math.max(1, Math.ceil(' + s.length + '/' + pageSize + '))');
console.log('当前页面:', currentPage, '是否超出范围:', currentPage > totalPages);
// 如果当前页面超出范围，重置到第一页
if (currentPage > totalPages) {
    currentPage = 1;
    console.log('当前页面超出范围，重置到第一页');
}a.forEach(t=>{let e=0;for(let n=s.length-1;n>=0;n--){const o=s[n].rec,frontFive=o.data.slice(0,5);let r=0;if(selectedPositions.length>0){selectedPositions.forEach(pos=>{if(pos>=1&&pos<=5&&t.split(",").map(t=>+t).includes(frontFive[pos-1])){r++}});}else{// 修改筛选逻辑：数字相同但顺序不同算作同一个结果
const comboNumbers = t.split(",").map(t=>+t).sort((a,b)=>a-b);
const frontFiveSorted = frontFive.slice().sort((a,b)=>a-b);
r = comboNumbers.filter(num => frontFiveSorted.includes(num)).length;}// 修复筛选逻辑：当没有选择命中码数时，显示所有组合
const shouldHit = c.length === 0 || c.includes(r);
if(shouldHit){
  s[n].cells[t]={txt:t,hit:!0};
  e=0;
}else{
  e++;
  s[n].cells[t]={txt:e,hit:!1};
}
console.log(`组合${t}在第${s[n].rec.period}期: 命中数=${r}, 是否命中=${shouldHit}, 选择的命中码数=${c.join(',')}`);}});console.log('表格数据处理完成，开始渲染');console.log(`L()函数: 当前数据数组长度 ${r.length}，期数统计显示 ${document.getElementById('periodCount').textContent}`);if(r.length.toString() !== document.getElementById('periodCount').textContent){console.warn('数据不一致：数据数组长度与期数统计不匹配！');}const d=H(s,a),u=U(s,a),l=z(s,a),b=a.slice().sort((t,e)=>{if(y){// 当前模式：按当前遗漏值或当前连中值排序
return m?u[e]-u[t]||l[t]-l[e]:l[e]-l[t]||u[t]-u[e]}// 历史模式：按历史最大值排序
const{maxHit:n,maxMiss:o}=d[t],{maxHit:c,maxMiss:r}=d[e];return m?c-n||o-r:o-r||c-n});

// 保存处理后的数据到全局变量，供updateTablePage函数使用
window.lastProcessedData = s;
window.lastSortedCombinations = b;
console.log('已保存处理后的数据到全局变量');document.getElementById("sortText").textContent=m?"按遗漏次数排序":"按连中次数排序";const startIndex=(currentPage-1)*pageSize,endIndex=Math.min(startIndex+pageSize,s.length),pageData=s.slice(startIndex,endIndex);document.getElementById("summary").innerHTML=`\n        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">\n          <div>共 ${b.length} 注分析组合</div>\n          <div>当前显示: ${displayData.length} 期 / 总计: ${r.length} 期</div>\n          <div>筛选条件: ${selectedNums.length>0?selectedNums.join("/"):"全部"}码组合，命中${c.length>0?c.join("/"):"全部"}胆${selectedPositions.length>0?`，位置${selectedPositions.join("/")}名`:""}${selectedHitNumbers.length>0?`，命中数字${selectedHitNumbers.join("/")}`:""}</div>\n          <div>第 ${currentPage}/${totalPages} 页 (${pageData.length}/${s.length} 行)</div>\n        </div>\n        <div class="flex justify-center items-center mt-4 space-x-2">\n          <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage<=1?'disabled':''}>上一页</button>\n          <span class="text-sm text-gray-600">第 ${currentPage} 页，共 ${totalPages} 页</span>\n          <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage>=totalPages?'disabled':''}>下一页</button>\n        </div>`;const h=document.createElement("tr");h.className="bg-gray-50 table-header-sticky",h.innerHTML='<th class="px-3 py-2 text-center sticky-col left-0 border-r border-gray-200 fixed-width-period sticky-bg-white" style="position: sticky; top: 0; z-index: 1001;">期数</th><th class="px-3 py-2 text-center sticky-col left-[120px] border-r border-gray-200 fixed-width-data sticky-bg-white" style="position: sticky; top: 0; z-index: 1001;">数据</th>';b.forEach(t=>{const{maxHit:e,maxMiss:n}=d[t],o=document.createElement("th");o.className="px-3 py-2 text-center border-r border-gray-200",o.innerHTML=y?m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">连:${u[t]} 漏${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">漏:${l[t]} 史:${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">连:${u[t]} 史:${e} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">漏:${l[t]} 史:${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `,h.appendChild(o)}),t.appendChild(h),pageData.forEach((t,n)=>{const o=document.createElement("tr");o.className=0===n?"bg-gray-100":1===n?"bg-gray-50":"",o.innerHTML=`\n          <td class="px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium fixed-width-period ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">${t.rec.period}</td>\n          <td class="px-3 py-2 text-left sticky-col left-[120px] border-r border-gray-200 fixed-width-data ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">\n            <div class="number-row">${t.rec.data.slice(0,5).join(",")}</div>\n            <div class="number-row">${t.rec.data.slice(5).join(",")}</div>\n          </td>\n        `,b.forEach(e=>{const n=t.cells[e],c=document.createElement("td");c.className="px-3 py-2 text-center border-r border-gray-200 "+(n.hit?"hit-cell":"miss-cell"),c.textContent=n.txt,o.appendChild(c)}),e.appendChild(o)}),setTimeout(()=>{const t=document.getElementById("prevPage"),e=document.getElementById("nextPage");t&&t.addEventListener("click",(event)=>{event.preventDefault();if(currentPage>1){currentPage--;updateTablePage();}}),e&&e.addEventListener("click",(event)=>{event.preventDefault();if(currentPage<totalPages){currentPage++;updateTablePage();}});},100);

// 获取筛选后的数据
function getFilteredData() {
    let filteredData = r.slice();
    
    // 应用筛选条件
    if (selectedNums.length > 0) {
        filteredData = filteredData.filter(item => {
            const combinations = getCombinations();
            return combinations.some(combo => {
                const nums = combo.split(",").map(n => parseInt(n));
                return selectedNums.every(selectedNum => nums.includes(selectedNum));
            });
        });
    }
    
    if (selectedPositions.length > 0) {
        filteredData = filteredData.filter(item => {
            return selectedPositions.some(pos => {
                const index = parseInt(pos) - 1;
                return index >= 0 && index < item.data.length;
            });
        });
    }
    
    if (selectedHitNumbers.length > 0) {
        filteredData = filteredData.filter(item => {
            return selectedHitNumbers.some(hitNum => item.data.includes(hitNum));
        });
    }
    
    return filteredData;
}

// 获取组合列表
function getCombinations() {
    const combinations = [];
    
    // 根据当前选择的码数生成组合
    for (let i = 1; i <= 10; i++) {
        for (let j = i + 1; j <= 10; j++) {
            if (selectedNums.length === 0 || (selectedNums.includes(i) && selectedNums.includes(j))) {
                combinations.push(`${i},${j}`);
            }
        }
    }
    
    // 如果没有选择特定码数，生成所有可能的组合
    if (combinations.length === 0) {
        for (let i = 1; i <= 10; i++) {
            for (let j = i + 1; j <= 10; j++) {
                combinations.push(`${i},${j}`);
            }
        }
    }
    
    return combinations;
}

// 新增函数：只更新表格页面内容，不重新渲染整个表格
function updateTablePage() {
    console.log('updateTablePage被调用，当前页面:', currentPage);
    
    const tbody = document.querySelector("#resultTable tbody");
    if (!tbody) {
        console.warn('表格tbody未找到，调用L()函数重新渲染');
        L();
        return;
    }
    
    // 获取当前已处理的数据（从全局变量中获取）
    if (!window.lastProcessedData || !window.lastSortedCombinations) {
        console.warn('缺少已处理的数据，调用L()函数重新渲染');
        L();
        return;
    }
    
    const s = window.lastProcessedData;
    const b = window.lastSortedCombinations;
    
    // 计算当前页的数据
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, s.length);
    const pageData = s.slice(startIndex, endIndex);
    
    console.log('只更新表格内容，当前页数据行数:', pageData.length);
    
    // 清空并重新生成tbody内容
    tbody.innerHTML = '';
    
    pageData.forEach((t, n) => {
        const o = document.createElement("tr");
        o.className = 0 === n ? "bg-gray-100" : 1 === n ? "bg-gray-50" : "";
        o.innerHTML = `
            <td class="px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium fixed-width-period ${0 === n ? "sticky-bg-gray-100" : 1 === n ? "sticky-bg-gray-50" : "sticky-bg-white"}">${t.rec.period}</td>
            <td class="px-3 py-2 text-left sticky-col left-[120px] border-r border-gray-200 fixed-width-data ${0 === n ? "sticky-bg-gray-100" : 1 === n ? "sticky-bg-gray-50" : "sticky-bg-white"}">
                <div class="number-row">${t.rec.data.slice(0,5).join(",")}</div>
                <div class="number-row">${t.rec.data.slice(5).join(",")}</div>
            </td>
        `;
        
        b.forEach(e => {
            const n = t.cells[e];
            const c = document.createElement("td");
            c.className = "px-3 py-2 text-center border-r border-gray-200 " + (n.hit ? "hit-cell" : "miss-cell");
            c.textContent = n.txt;
            o.appendChild(c);
        });
        
        tbody.appendChild(o);
    });
    
    // 更新分页信息
    const summaryDiv = document.getElementById("summary");
    if (summaryDiv) {
        const summaryHTML = summaryDiv.innerHTML;
        const updatedSummary = summaryHTML.replace(
            /第 \d+\/\d+ 页 \(\d+\/\d+ 行\)/,
            `第 ${currentPage}/${totalPages} 页 (${pageData.length}/${s.length} 行)`
        ).replace(
            /<div class="flex justify-center[\s\S]*?<\/div>\s*$/,
            `<div class="flex justify-center items-center mt-4 space-x-2">
                <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage <= 1 ? 'disabled' : ''}>上一页</button>
                <span class="text-sm text-gray-600">第 ${currentPage} 页，共 ${totalPages} 页</span>
                <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage >= totalPages ? 'disabled' : ''}>下一页</button>
            </div>`
        );
        summaryDiv.innerHTML = updatedSummary;
    }
    
    // 重新绑定翻页按钮事件
    setTimeout(() => {
        const prevBtn = document.getElementById("prevPage");
        const nextBtn = document.getElementById("nextPage");
        
        if (prevBtn) {
            prevBtn.addEventListener("click", (event) => {
                event.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    updateTablePage();
                }
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener("click", (event) => {
                event.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTablePage();
                }
            });
        }
    }, 10);
}j();}function j(){const t=document.getElementById("resultTable"),e=document.getElementById("tableContainer"),n=t.offsetWidth,o=e.offsetWidth;if(n>o){document.querySelector(".slider-container").style.display="block";const u=o/n,l=Math.max(20,u*o);k.style.width=e.scrollLeft/(n-o)*100+"%",w.style.left=e.scrollLeft/(n-o)*(o-l)+"px",w.style.width=`${l}px`,k.style.width=e.scrollLeft/(n-o)*100+"%";let m=!1;function c(t){if(!m)return;const c=e.getBoundingClientRect(),r=t.clientX-c.left-l/2,i=o-l,a=Math.max(0,Math.min(r,i)),s=a/i,d=s*(n-o);e.scrollLeft=d,w.style.left=`${a}px`,k.style.width=100*s+"%"}function r(){m=!1,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",r)}w.addEventListener("mousedown",t=>{m=!0,document.addEventListener("mousemove",c),document.addEventListener("mouseup",r),t.preventDefault()}),document.querySelector(".slider-track").addEventListener("click",t=>{const c=e.getBoundingClientRect(),r=t.clientX-c.left-l/2,i=o-l,a=Math.max(0,Math.min(r,i)),s=a/i,d=s*(n-o);e.scrollLeft=d,w.style.left=`${a}px`,k.style.width=100*s+"%"})}else document.querySelector(".slider-container").style.display="none";const i=t.offsetHeight,a=e.offsetHeight;if(i>a){$.style.display="none";const f=a/i,y=Math.max(20,f*a);I.style.height=e.scrollTop/(i-a)*100+"%",B.style.top=e.scrollTop/(i-a)*(a-y)+"px",B.style.height=`${y}px`,I.style.height=e.scrollTop/(i-a)*100+"%";let b=!1;function s(t){if(!b)return;const n=e.getBoundingClientRect(),o=t.clientY-n.top-y/2,c=a-y,r=Math.max(0,Math.min(o,c)),s=r/c,d=s*(i-a);e.scrollTop=d,B.style.top=`${r}px`,I.style.height=100*s+"%"}function d(){b=!1,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)}B.addEventListener("mousedown",t=>{b=!0,document.addEventListener("mousemove",s),document.addEventListener("mouseup",d),t.preventDefault()}),document.querySelector(".vertical-slider-track").addEventListener("click",t=>{const n=e.getBoundingClientRect(),o=t.clientY-n.top-y/2,c=a-y,r=Math.max(0,Math.min(o,c)),s=r/c,d=s*(i-a);e.scrollTop=d,B.style.top=`${r}px`,I.style.height=100*s+"%"})}else $.style.display="none";e.addEventListener("scroll",()=>{if(n>o){const t=e.scrollLeft/(n-o);w.style.left=t*(o-parseInt(getComputedStyle(w).width))+"px",k.style.width=100*t+"%";const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");if(e.scrollLeft>10){periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")}else{periodCols.forEach(col=>col.style.opacity="1");dataCols.forEach(col=>col.style.left="120px")}}if(i>a){const t=e.scrollTop/(i-a);const thumbHeight=Math.max(20,f*a);B.style.top=Math.min(t*(a-thumbHeight),a-thumbHeight)+"px",I.style.height=Math.min(100*t,100)+"%"}})}async function V(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n").filter(Boolean);console.log(`V()函数: 从文件读取到 ${e.length} 行数据`);for(const t of e)q(t);r.sort((t,e)=>{const n=t.period.toString();return e.period.toString().localeCompare(n)});console.log(`V()函数: 处理后数据数组长度为 ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`V()函数: 期数统计已更新为 ${r.length}`);L(); /* 自动渲染表格 */}catch(t){v.textContent=`读取文件错误: ${t.message}`}}async function W(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n")[0],n=e.trim().split(/\t+/);if(2!==n.length)return;const o=n[0].trim();if(o===u)return;u=o,q(e);console.log(`W()函数: 新增数据后，数据数组长度为 ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`W()函数: 期数统计已更新为 ${r.length}`); /* 移除立即筛选，等待确认按钮点击 */}catch(t){}}function q(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return;e=t.trim().split(/\s+/)}if(e.length<2)return;const n=e[0].trim();if(d.has(n))return;let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}10!==o.length||o.some(isNaN)||(d.add(n),r.unshift({period:n,data:o,input:o.join(",")}))}// Y函数定义 - 生成文件标识符
function Y(){try{const t=document.documentElement.outerHTML.substring(0,1e3)+window.location.href.split("/").slice(-2).join("/");let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;return"file_"+Math.abs(e).toString(36)}catch(t){return console.error("Failed to generate file identifier:",t),"fallback_"+Date.now()}}

// 添加防重复点击和防抖机制
let isVerifying = false;
let verifyTimeout = null;

P.addEventListener("click",async function(){const t=p.value.trim();if(t){// 防重复点击检查
if(isVerifying){console.warn("验证正在进行中，请勿重复点击");return;}

// 清除之前的防抖定时器
if(verifyTimeout){clearTimeout(verifyTimeout);verifyTimeout=null;}

// 设置验证状态
isVerifying=true;
this.disabled=true;
this.textContent="验证中...";
this.style.opacity="0.6";
this.style.cursor="not-allowed";

// 添加加载动画效果
const originalText=this.textContent;

let dots=0;
const loadingInterval=setInterval(()=>{dots=(dots+1)%4;this.textContent="验证中"+".".repeat(dots);},500);

// 清理可能的状态缓存
const deviceId=Y();
const existingKey=localStorage.getItem(`validKey_${deviceId}`);
if(existingKey){console.log("清理现有密钥缓存");localStorage.removeItem(`validKey_${deviceId}`);localStorage.removeItem(`keyExpiry_${deviceId}`);}

try{const e=await A(t);if(e.valid){// 标记密钥为已使用
// 记录密钥使用信息到本地
recordKeyUsage(e.data);
const n=Y();localStorage.setItem(`validKey_${n}`,t);localStorage.setItem(`keyExpiry_${n}`,e.data.expiry);g.classList.add("hidden");g.style.display="none";
// 设置新的加密验证状态
_0xSetAuth(t);
b=!0;
D(e.data.expiry)}else alert("密钥验证失败: "+e.reason)}catch(t){console.error("密钥验证过程出错:",t);alert("验证过程中发生错误: "+t.message)}finally{// 重置验证状态（添加延迟防抖）
if(loadingInterval){clearInterval(loadingInterval);}
verifyTimeout=setTimeout(()=>{isVerifying=false;this.disabled=false;this.textContent="验证密钥";this.style.opacity="1";this.style.cursor="pointer";},1000);}}else alert("请输入密钥")});

window.addEventListener("load",async function(){try{const t=Y(),e=localStorage.getItem(`validKey_${t}`),n=localStorage.getItem(`keyExpiry_${t}`),o=Math.floor((new Date).getTime()/1e3);if(e&&n){const r=parseInt(n);if(o<r){// 检查是否为长密钥格式（长密钥已失效）
if(e.length > 25) {console.log('检测到长密钥，已失效，清理缓存');localStorage.removeItem(`validKey_${t}`);localStorage.removeItem(`keyExpiry_${t}`);b=!1;alert("长密钥已失效，请使用新的短密钥");g.classList.remove("hidden");g.style.display="flex";return;}// 短密钥验证逻辑
try{const keyData=JSON.parse(atob(e.split('.')[1]));const checkResult=checkKeyOnlineUsage(keyData.nonce);if(checkResult.used){localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,alert("密钥已被使用，请重新验证密钥"),g.classList.remove("hidden"),g.style.display="flex"}else{_0xSetAuth(e);b=!0,D(r),g.classList.add("hidden"),g.style.display="none"}}catch(err){console.error("本地验证失败:",err);_0xSetAuth(e);b=!0,D(r),g.classList.add("hidden"),g.style.display="none"}}else{localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,alert("您的访问密钥已过期，请重新验证密钥"),g.classList.remove("hidden"),g.style.display="flex"}}else b=!1,g.classList.remove("hidden"),g.style.display="flex"}catch(t){console.error("页面加载时密钥检查出错:",t),b=!1,g.classList.remove("hidden"),g.style.display="flex"}}),document.getElementById("calcBtn").addEventListener("click",F),document.getElementById("numbersInput").addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),F())});

// 自动抓取相关变量
let autoScrapeInterval = null;
let countdownInterval = null;
let lastPeriodNumber = null;
let isInActiveTimeRange = false;

// 检查是否在活跃时间段内 (23:55-07:05)
function isInActiveTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    // 23:55 = 1435分钟, 07:05 = 425分钟
    const startTime = 23 * 60 + 55; // 1435
    const endTime = 7 * 60 + 5;     // 425
    
    // 跨越午夜的时间段
    return currentTime >= startTime || currentTime <= endTime;
}

// 云端数据库功能已禁用 - 远程API基础URL已移除

// 云端数据库功能已禁用 - runPythonScraper函数已移除

// 启动自动抓取功能 - 每2秒获取一次数据
function startAutoScrape() {
    if (autoScrapeInterval) {
        clearInterval(autoScrapeInterval);
    }
    
    console.log('启动自动获取数据功能，每2秒获取一次');
    isInActiveTimeRange = true;
    
    // 立即获取一次数据
    fetchApiData();
    
    // 设置定时器每2秒获取一次
    autoScrapeInterval = setInterval(async () => {
        try {
            await fetchApiData();
        } catch (error) {
            console.error('自动获取数据失败:', error);
        }
    }, 2000); // 2秒间隔
    
    // 更新按钮状态
    const autoFetchBtn = document.getElementById('autoFetchBtn');
    if (autoFetchBtn) {
        autoFetchBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>停止自动获取';
        autoFetchBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        autoFetchBtn.classList.add('bg-red-500', 'hover:bg-red-600');
    }
    
    showNotification('已启动自动获取数据功能，每2秒获取一次', 'success');
}

// 停止自动抓取功能
function stopAutoScrape() {
    if (autoScrapeInterval) {
        clearInterval(autoScrapeInterval);
        autoScrapeInterval = null;
    }
    
    console.log('停止自动获取数据功能');
    isInActiveTimeRange = false;
    
    // 更新按钮状态
    const autoFetchBtn = document.getElementById('autoFetchBtn');
    if (autoFetchBtn) {
        autoFetchBtn.innerHTML = '<i class="fa fa-play mr-2"></i>开始自动获取';
        autoFetchBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        autoFetchBtn.classList.add('bg-green-500', 'hover:bg-green-600');
    }
    
    showNotification('已停止自动获取数据功能', 'info');
}

// 页面加载时自动开始每5秒刷新
window.addEventListener('load', function() {
    // 云端数据库功能已禁用 - 不再自动加载数据
    // fetchTodayDataFromDatabase(); // 已禁用
    
    // 云端数据库功能已禁用 - 不再启动自动刷新
    // setTimeout(() => {
    //     console.log('页面加载完成，启动每5秒自动刷新功能');
    //     startAutoRefresh();
    // }, 3000); // 已禁用
    
    console.log('页面加载完成，云端数据库功能已禁用，请手动输入数据');
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// 添加命中数字按钮的事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 命中数字按钮多选功能
    const hitNumberButtons = document.querySelectorAll('.hit-number-btn');
    hitNumberButtons.forEach(button => {
        // 设置初始样式
        button.style.backgroundColor = '#e5e7eb'; // gray-200
        button.style.color = '#374151'; // gray-700
        button.style.cursor = 'pointer';
        button.style.transition = 'all 0.2s ease';
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('命中数字按钮点击:', this.textContent, this.dataset.number);
            
            // 切换选中状态
            if (this.classList.contains('btn-active')) {
                // 取消选中
                this.classList.remove('btn-active');
                this.style.backgroundColor = '#e5e7eb'; // gray-200
                this.style.color = '#374151'; // gray-700
                console.log('取消选中:', this.textContent);
            } else {
                // 选中
                this.classList.add('btn-active');
                this.style.backgroundColor = '#3b82f6'; // blue-500
                this.style.color = 'white';
                console.log('选中:', this.textContent);
            }
            
            // 输出当前选中状态
            const selectedNumbers = Array.from(document.querySelectorAll('.hit-number-btn.btn-active'))
                .map(btn => btn.dataset.number);
            console.log('当前选中数字:', selectedNumbers);
            
            // 移除立即筛选，等待确认按钮点击
            console.log('命中数字选择已更改，等待确认按钮点击');
        });
    });
    
    // 命中码数按钮事件处理已在DOMContentLoaded中通过C函数处理，无需重复绑定
    
    // 确认按钮事件处理
    const confirmFilterBtn = document.getElementById('confirmFilterBtn');
    if (confirmFilterBtn) {
        confirmFilterBtn.addEventListener('click', function() {
            console.log('确认按钮被点击，开始执行筛选');
            // 执行筛选函数
            L();
        });
    }
});

document.getElementById("autoFetchBtn").addEventListener("click",()=>{if(isInActiveTimeRange){stopAutoScrape()}else{startAutoScrape()}});

// 获取最新数据按钮事件监听
document.getElementById("fetchApiBtn").addEventListener("click", async ()=>{
    const btn = document.getElementById("fetchApiBtn");
    const originalText = btn.innerHTML;
    
    // 显示加载状态
    btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>获取中...';
    btn.disabled = true;
    
    try {
        await fetchApiData();
    } finally {
        // 恢复按钮状态
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});document.getElementById("sortToggle").addEventListener("click",()=>{m=!m; /* 移除立即筛选，等待确认按钮点击 */});// 当前遗漏按钮事件
document.getElementById("currentMissBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0;m=!1; // 设置为当前模式和遗漏模式
document.getElementById("currentMissBtn").classList.add("btn-active","bg-blue-600","text-white");document.getElementById("currentMissBtn").classList.remove("bg-gray-200","text-gray-700");document.getElementById("currentHitBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentHitBtn").classList.add("bg-gray-200","text-gray-700"); console.log('当前遗漏按钮被点击，开始刷新数据'); L(); /* 添加数据刷新功能 */ if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}});

// 当前连中按钮事件
document.getElementById("currentHitBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0;m=!0; // 设置为当前模式和连中模式
document.getElementById("currentHitBtn").classList.add("btn-active","bg-blue-600","text-white");document.getElementById("currentHitBtn").classList.remove("bg-gray-200","text-gray-700");document.getElementById("currentMissBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentMissBtn").classList.add("bg-gray-200","text-gray-700"); console.log('当前连中按钮被点击，开始刷新数据'); L(); /* 添加数据刷新功能 */ if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}}); document.getElementById("statBtn").addEventListener("click",() => { /* 移除立即筛选，等待确认按钮点击 */ });document.getElementById("clearBtn").addEventListener("click",()=>{confirm("确定要清空所有数据吗？此操作不可恢复。")&&(r=[],i=1,d.clear(),document.getElementById("periodCount").textContent="0",document.getElementById("summary").textContent="", /* 移除立即筛选，等待确认按钮点击 */ v.textContent="数据已清空")});document.addEventListener("DOMContentLoaded",()=>{document.getElementById("uploadDataBtn").addEventListener("click",async()=>{try{[s]=await window.showOpenFilePicker();d.clear();u=null;r=[];i=1;await V();l&&clearInterval(l);l=setInterval(W,3e3);v.textContent=`已加载文件: ${s.name}`}catch(t){v.textContent=`文件选择错误: ${t.message}`}})});const X=document.querySelectorAll(".period-btn");X.forEach(t=>{t.addEventListener("click",()=>{X.forEach(t=>t.classList.remove("btn-active"));t.classList.add("btn-active");f=parseInt(t.dataset.period);document.getElementById("customPeriod").value=f;currentPage=1;console.log(`期数按钮被点击，设置期数为: ${f}`);L(); /* 添加表格刷新功能 */})});document.getElementById("customPeriodBtn").addEventListener("click",()=>{const t=parseInt(document.getElementById("customPeriod").value);!isNaN(t)&&t>=1&&t<=1e4?(f=t,X.forEach(t=>t.classList.remove("btn-active")),currentPage=1,console.log(`自定义期数被设置为: ${f}`),L() /* 添加表格刷新功能 */):alert("请输入1-10000之间的数字")});window.addEventListener("resize",j);



// 全局自动刷新变量
let autoRefreshTimer = null;
let lastUpdateTime = null;

// 页面加载时从数据库获取今天的数据
// 云端数据库功能已禁用 - fetchTodayDataFromDatabase函数已移除

// 云端数据库功能已禁用 - autoRefreshLatestData函数已移除

// 生成模拟期号
function generateMockPeriod() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hour = now.getHours().toString().padStart(2, '0');
    const minute = now.getMinutes().toString().padStart(2, '0');
    return `${year}${month}${day}${hour}${minute}`;
}

// 生成模拟开奖号码
function generateMockNumbers() {
    const numbers = [];
    for (let i = 0; i < 10; i++) {
        numbers.push(Math.floor(Math.random() * 10));
    }
    return numbers.join(',');
}

// API数据获取功能 - 直接从原始API获取
async function fetchApiData() {
    try {
        console.log('步骤1: 开始从API获取数据...');
        
        // 直接调用原始API
        const apiUrl = 'https://api.api68.com/pks/getLotteryPksInfo.do?lotCode=10057';
        
        let response;
        try {
            // 尝试正常fetch
            response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
        } catch (corsError) {
            console.log('CORS错误，尝试no-cors模式:', corsError);
            // 如果CORS失败，尝试no-cors模式
            response = await fetch(apiUrl, {
                method: 'GET',
                mode: 'no-cors',
                headers: {
                    'Accept': 'application/json'
                }
            });
        }
        
        if (!response.ok) {
            throw new Error(`HTTP错误! 状态: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('步骤2: API返回数据:', data);
        
        // 检查API返回的错误码
        if (data.errorCode !== 0) {
            throw new Error(data.message || 'API返回错误');
        }
        
        // 解析API数据
        let period, numbersStr, drawTime;
        
        if (data && data.result && data.result.data) {
            const apiData = data.result.data;
            period = apiData.preDrawIssue;
            numbersStr = apiData.preDrawCode;
            drawTime = apiData.preDrawTime;
        } else {
            throw new Error('API返回数据格式不正确');
        }
        
        console.log('步骤3: 解析数据:', { period, numbersStr, drawTime });
        
        // 检查是否已存在该期数据
        if (d.has(period)) {
            console.log('步骤4: 数据已存在，跳过添加');
            return { period, numbersStr, drawTime, skipped: true };
        }
        
        // 直接添加到数据数组r中
        const numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
        if (numbers.length === 10 && !numbers.some(isNaN)) {
            d.add(period);
            r.unshift({
                period: period,
                data: numbers,
                input: numbersStr
            });
            
            console.log('步骤4: 数据已添加到数组，当前数组长度:', r.length);
            
            // 更新期数统计
            document.getElementById('periodCount').textContent = r.length;
            
            // 调用L()函数更新表格
            console.log('步骤5: 开始更新表格显示');
            L();
            
            console.log('步骤6: 数据处理完成');
        } else {
            throw new Error('数据格式不正确');
        }
        
        return { period, numbersStr, drawTime };
    } catch (error) {
        console.error('获取API数据失败:', error);
        console.log('获取数据失败: ' + error.message);
        return null;
    }
}

// 历史数据获取功能 - 获取指定日期的历史开奖数据
async function fetchHistoryData() {
    try {
        console.log('步骤1: 开始获取历史数据（今天和昨天）...');
        
        // 计算今天和昨天的日期
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const todayStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
        
        const yesterdayStr = yesterday.getFullYear() + '-' + 
                            String(yesterday.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(yesterday.getDate()).padStart(2, '0');
        
        console.log('步骤2: 准备获取两天数据:', { today: todayStr, yesterday: yesterdayStr });
        
        // 获取两天的数据
        const dates = [todayStr, yesterdayStr];
        let allHistoryItems = [];
        
        for (const dateStr of dates) {
            const historyApiUrl = `https://api.api68.com/pks/getPksHistoryList.do?lotCode=10057&date=${dateStr}`;
            console.log(`步骤2.${dates.indexOf(dateStr) + 1}: 请求URL:`, historyApiUrl);
        
            let response;
            try {
                // 尝试正常fetch
                response = await fetch(historyApiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
            } catch (corsError) {
                console.log(`CORS错误，尝试no-cors模式 (${dateStr}):`, corsError);
                // 如果CORS失败，尝试no-cors模式
                response = await fetch(historyApiUrl, {
                    method: 'GET',
                    mode: 'no-cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
            }
            
            if (!response.ok) {
                console.warn(`HTTP错误 (${dateStr})! 状态: ${response.status}`);
                continue; // 跳过这个日期，继续下一个
            }
            
            const data = await response.json();
            console.log(`步骤3.${dates.indexOf(dateStr) + 1}: ${dateStr} 历史数据API返回:`, data);
            
            // 检查API返回的错误码
            if (data.errorCode !== 0) {
                console.warn(`API返回错误 (${dateStr}):`, data.message || '未知错误');
                continue; // 跳过这个日期，继续下一个
            }
            
            // 解析历史数据
            if (data && data.result && data.result.data && Array.isArray(data.result.data)) {
                const historyItems = data.result.data;
                console.log(`步骤4.${dates.indexOf(dateStr) + 1}: ${dateStr} 获取到 ${historyItems.length} 条历史数据`);
                allHistoryItems.push(...historyItems);
            } else {
                console.warn(`${dateStr} 历史数据API返回格式不正确`);
            }
        }
        
        console.log(`步骤3: 总共获取到 ${allHistoryItems.length} 条历史数据`);
        
        if (allHistoryItems.length > 0) {
            let addedCount = 0;
            
            // 按时间倒序排列历史数据（最新的在前）
            allHistoryItems.sort((a, b) => {
                const timeA = new Date(a.preDrawTime);
                const timeB = new Date(b.preDrawTime);
                return timeB.getTime() - timeA.getTime(); // 倒序排列
            });
            
            // 收集新数据，然后一次性添加到数组开头
            const newDataItems = [];
            for (const item of allHistoryItems) {
                const period = item.preDrawIssue;
                const numbersStr = item.preDrawCode;
                const drawTime = item.preDrawTime;
                
                // 检查是否已存在该期数据
                if (!d.has(period)) {
                    // 解析号码
                    const numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
                    if (numbers.length === 10 && !numbers.some(isNaN)) {
                        d.add(period);
                        newDataItems.push({
                            period: period,
                            data: numbers,
                            input: numbersStr
                        });
                        addedCount++;
                    }
                }
            }
            
            // 将新数据添加到数组开头（保持最新数据在前的顺序）
            r.unshift(...newDataItems);
            
            if (addedCount > 0) {
                console.log(`步骤5: 新增 ${addedCount} 条数据到表格`);
                
                // 更新期数统计
                document.getElementById('periodCount').textContent = r.length;
                
                // 调用L()函数更新表格
                console.log('步骤6: 更新表格显示');
                L();
                
                console.log('步骤7: 历史数据处理完成');
            } else {
                console.log('步骤5: 没有新数据需要添加');
            }
            
            return { success: true, total: historyItems.length, added: addedCount };
        } else {
            throw new Error('历史数据API返回格式不正确');
        }
        
    } catch (error) {
        console.error('获取历史数据失败:', error);
        return { success: false, error: error.message };
    }
}

// 历史数据自动获取定时器
let historyDataTimer = null;

// 启动历史数据自动获取
function startHistoryDataFetch() {
    if (historyDataTimer) {
        clearInterval(historyDataTimer);
    }
    
    console.log('启动历史数据自动获取，每2秒刷新一次');
    
    // 立即执行一次
    fetchHistoryData();
    
    // 设置定时器，每2秒执行一次
    historyDataTimer = setInterval(() => {
        fetchHistoryData();
    }, 2000);
}

// 停止历史数据自动获取
function stopHistoryDataFetch() {
    if (historyDataTimer) {
        clearInterval(historyDataTimer);
        historyDataTimer = null;
        console.log('历史数据自动获取已停止');
    }
}

// 显示通知消息
function showNotification(message, type = 'info') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-white font-medium transition-all duration-300 transform translate-x-full`;
    
    // 根据类型设置颜色
    switch(type) {
        case 'success':
            notification.classList.add('bg-green-500');
            break;
        case 'error':
            notification.classList.add('bg-red-500');
            break;
        case 'warning':
            notification.classList.add('bg-yellow-500');
            break;
        default:
            notification.classList.add('bg-blue-500');
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // 显示动画
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // 3秒后隐藏
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// 启动每分钟自动刷新 - 已禁用云端数据库功能
function startAutoRefresh() {
    // 云端数据库功能已禁用，不启动自动刷新
    console.log('云端数据库功能已禁用，自动刷新功能已停用');
}

// 停止自动刷新 - 已禁用云端数据库功能
function stopAutoRefresh() {
    // 云端数据库功能已禁用，清除任何现有定时器
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
    console.log('云端数据库功能已禁用，自动刷新功能已停用');
}

// 基于最新开奖时间的140秒倒计时功能
function startCountdownFromTime(timeStr) {
    try {
        // 解析时间字符串 (格式: "2024-01-15 14:30:25")
        const lastDrawTime = new Date(timeStr);
        if (isNaN(lastDrawTime.getTime())) {
            console.error('无效的时间格式:', timeStr);
            // 如果时间格式无效，使用默认140秒倒计时
            startCountdown(140);
            return;
        }
        
        // 计算下次开奖时间 (当前开奖时间 + 140秒)
        const nextDrawTime = new Date(lastDrawTime.getTime() + 140 * 1000);
        const now = new Date();
        const timeDiff = nextDrawTime.getTime() - now.getTime();
        
        if (timeDiff <= 0) {
            // 如果计算出的时间已经过去，立即刷新数据
            console.log('开奖时间已过，云端数据库功能已禁用');
            // autoRefreshLatestData(); // 已禁用云端数据库功能
            return;
        }
        
        // 计算剩余秒数并启动倒计时
        const remainingSeconds = Math.floor(timeDiff / 1000);
        console.log(`根据开奖时间 ${timeStr}，${remainingSeconds} 秒后自动刷新数据`);
        startCountdown(remainingSeconds);
        
    } catch (error) {
        console.error('倒计时启动失败:', error);
        // 出错时使用默认140秒倒计时
        startCountdown(140);
    }
}

// 黄金切割页面事件处理
document.addEventListener('DOMContentLoaded', function() {
    // 输入数据计数
    const goldenInputData = document.getElementById('goldenInputData');
    const goldenInputCount = document.getElementById('goldenInputCount');
    
    if (goldenInputData && goldenInputCount) {
        goldenInputData.addEventListener('input', function() {
            const data = this.value.trim();
            if (!data) {
                goldenInputCount.classList.add('hidden');
                return;
            }
            
            // 解析输入数据
            const items = data.split(/[\n,;，]+/).map(s => s.trim()).filter(s => s);
            goldenInputCount.textContent = `共 ${items.length} 项`;
            goldenInputCount.classList.remove('hidden');
        });
    }
    
    // 模式切换按钮
    const modeUniformBtn = document.getElementById('modeUniformBtn');
    const modeStableBtn = document.getElementById('modeStableBtn');
    const modeDescription = document.getElementById('modeDescription');
    
    let currentMode = 'uniform'; // 默认均匀模式
    
    if (modeUniformBtn && modeStableBtn) {
        modeUniformBtn.addEventListener('click', function() {
            currentMode = 'uniform';
            modeUniformBtn.classList.add('active-mode');
            modeUniformBtn.classList.remove('inactive-mode');
            modeStableBtn.classList.add('inactive-mode');
            modeStableBtn.classList.remove('active-mode');
            modeDescription.textContent = '均匀模式：一次性分完就用，不保持历史分组';
        });
        
        modeStableBtn.addEventListener('click', function() {
            currentMode = 'stable';
            modeStableBtn.classList.add('active-mode');
            modeStableBtn.classList.remove('inactive-mode');
            modeUniformBtn.classList.add('inactive-mode');
            modeUniformBtn.classList.remove('active-mode');
            modeDescription.textContent = '稳定模式：维护长期分组，不想每次重新切割';
        });
    }
    
    // 分割按钮
    const goldenSplitBtn = document.getElementById('goldenSplitBtn');
    if (goldenSplitBtn) {
        goldenSplitBtn.addEventListener('click', function() {
            const inputData = document.getElementById('goldenInputData').value.trim();
            
            if (!inputData) {
                alert('请输入要分割的数据');
                return;
            }
            
            // 解析输入数据
            const items = parseInput(inputData);
            
            if (items.length === 0) {
                alert('没有有效的数据');
                return;
            }
            
            // 根据当前模式执行黄金切割
            const assignMode = currentMode === 'uniform' ? 'roundrobin' : 'hash';
            const groups = goldenSplit5in4(items, assignMode);
            
            // 验证结果
            const isValid = validate5in4(groups, items);
            
            // 重置所有复制按钮状态（新的切割开始）
            resetAllCopyButtons();
            
            // 渲染结果
            renderGoldenResults(groups, items, isValid);
            
            console.log('分割完成:', groups, '验证结果:', isValid);
        });
    }
    
    // 粘贴数据按钮
    const goldenPasteBtn = document.getElementById('goldenPasteBtn');
    if (goldenPasteBtn) {
        goldenPasteBtn.addEventListener('click', async function() {
            try {
                // 检查剪贴板API是否可用
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    // 降级到传统方法
                    const textarea = document.createElement('textarea');
                    document.body.appendChild(textarea);
                    textarea.focus();
                    document.execCommand('paste');
                    const text = textarea.value;
                    document.body.removeChild(textarea);
                    
                    if (text.trim()) {
                        document.getElementById('goldenInputData').value = text.trim();
                        // 触发输入事件以更新计数
                        const inputEvent = new Event('input', { bubbles: true });
                        document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                    }
                    return;
                }
                
                // 尝试从剪贴板读取数据
                const text = await navigator.clipboard.readText();
                if (text.trim()) {
                    document.getElementById('goldenInputData').value = text.trim();
                    
                    // 触发输入事件以更新计数
                    const inputEvent = new Event('input', { bubbles: true });
                    document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                } else {
                    alert('剪贴板为空');
                }
            } catch (err) {
                console.error('无法访问剪贴板:', err);
                // 提示用户使用快捷键粘贴
                alert('请使用 Ctrl+V (Windows) 或 Cmd+V (Mac) 手动粘贴数据到输入框');
            }
        });
    }
    
    // 清空按钮
    const goldenClearBtn = document.getElementById('goldenClearBtn');
    if (goldenClearBtn) {
        goldenClearBtn.addEventListener('click', function() {
            // 清空输入
            document.getElementById('goldenInputData').value = '';
            document.getElementById('goldenInputCount').classList.add('hidden');
            
            // 清空结果
            document.getElementById('goldenResults').innerHTML = '';
            document.getElementById('validationResults').classList.add('hidden');
            
            console.log('已清空所有数据');
        });
    }
    
    // 页面加载完成后自动启动历史数据获取
    console.log('页面加载完成，启动历史数据获取功能...');
        startHistoryDataFetch();
});


</script>
</body>
</html>
