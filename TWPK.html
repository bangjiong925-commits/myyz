<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>å°æ¹¾PKæ•°æ®åˆ†æå·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- å®‰å…¨é˜²æŠ¤è„šæœ¬ -->
  <script>
    // ğŸ¯ ç‰ˆæœ¬ä¿¡æ¯
    const APP_VERSION = 'v1.0.0.26';
    const BUILD_TIME = '2025-10-19 22:30:00';
    console.log('%cğŸš€ å°æ¹¾PKæ•°æ®åˆ†æå·¥å…· ' + APP_VERSION, 'color: #3b82f6; font-size: 18px; font-weight: bold; padding: 10px;');
    console.log('%cğŸ“… æ„å»ºæ—¶é—´: ' + BUILD_TIME, 'color: #10b981; font-size: 14px;');
    console.log('%cğŸ”§ å¦‚çœ‹åˆ°æ­¤ç‰ˆæœ¬å·è¯´æ˜é¡µé¢å·²æ›´æ–°', 'color: #f59e0b; font-size: 12px;');
    
    (function() {
      'use strict';
      
      // åŸŸåå’Œåè®®æ£€æµ‹
      function checkDomainAndProtocol() {
        const currentDomain = window.location.hostname;
        const currentProtocol = window.location.protocol;
        
        // å…è®¸çš„åŸŸååˆ—è¡¨ï¼ˆæ ¹æ®å®é™…éƒ¨ç½²åŸŸåä¿®æ”¹ï¼‰
        const allowedDomains = [
          'localhost',
          '127.0.0.1',
          '47.242.214.89',
          'myyz-git-main-a1234s-projects.vercel.app',
          'myyz.vercel.app',
          // æ·»åŠ å…¶ä»–å…è®¸çš„åŸŸå
        ];
        
        // æ£€æŸ¥åè®®ï¼ˆå…è®¸httpsã€httpå’Œfileåè®®ï¼‰
        if (currentProtocol !== 'https:' && currentProtocol !== 'http:' && currentProtocol !== 'file:') {
          console.error('éæ³•åè®®è®¿é—®:', currentProtocol);
          document.body.innerHTML = '<div style="text-align:center;margin-top:50px;font-size:24px;color:red;">è®¿é—®åè®®ä¸æ­£ç¡®</div>';
          return false;
        }
        
        // æ£€æŸ¥åŸŸåï¼ˆfileåè®®å…è®¸ç©ºhostnameï¼‰
        const isDomainAllowed = currentProtocol === 'file:' || allowedDomains.some(domain => 
          currentDomain === domain || currentDomain.endsWith('.' + domain)
        );
        
        if (!isDomainAllowed) {
          console.error('éæ³•åŸŸåè®¿é—®:', currentDomain);
          document.body.innerHTML = '<div style="text-align:center;margin-top:50px;font-size:24px;color:red;">åŸŸåè®¿é—®å—é™</div>';
          return false;
        }
        
        return true;
      }
      
      // ç¯å¢ƒæ£€æµ‹
      function checkEnvironment() {
        // æ£€æŸ¥æ˜¯å¦ä¸ºfileåè®®ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰
        if (window.location.protocol === 'file:') {
          console.log('æœ¬åœ°æ–‡ä»¶è®¿é—®æ¨¡å¼ - å¼€å‘æµ‹è¯•ç¯å¢ƒ');
          // åœ¨å¼€å‘ç¯å¢ƒä¸­å…è®¸æœ¬åœ°æ–‡ä»¶è®¿é—®
          return true;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºlocalhostï¼ˆæœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼‰
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('æœ¬åœ°å¼€å‘æœåŠ¡å™¨æ¨¡å¼ - è·³è¿‡å¯†é’¥éªŒè¯');
          // æœ¬åœ°å¼€å‘ç¯å¢ƒè·³è¿‡å¯†é’¥éªŒè¯
          return true;
        }
        
        // æ£€æŸ¥Refererï¼ˆé˜²æ­¢ç›´æ¥è®¿é—®ï¼‰
        if (document.referrer === '' && window.location.search === '') {
          // å…è®¸ç›´æ¥è®¿é—®ï¼Œä½†è®°å½•æ—¥å¿—
          console.log('ç›´æ¥è®¿é—®æ£€æµ‹');
        }
        
        return true;
      }
      
      // æ—¶é—´æˆ³éªŒè¯
      function checkTimestamp() {
        const now = new Date();
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        // æœ¬åœ°å¼€å‘ç¯å¢ƒä¸æç¤ºç‰ˆæœ¬è¿‡æ—§
        if (isLocal) return true;
        const buildTime = new Date('2025-07-01T00:00:00Z'); // æ„å»ºæ—¶é—´æˆ³ï¼ˆæ›´æ–°ï¼‰
        const maxAge = 180 * 24 * 60 * 60 * 1000; // 180å¤©æœ‰æ•ˆæœŸï¼ˆæ”¾å®½ï¼‰
        
        if (now.getTime() - buildTime.getTime() > maxAge) {
          console.warn('é¡µé¢ç‰ˆæœ¬è¾ƒæ—§ï¼Œå»ºè®®åˆ·æ–°è·å–æœ€æ–°ç‰ˆæœ¬');
          // ä¸å†é˜»æ­¢è®¿é—®ï¼Œåªæ˜¾ç¤ºè­¦å‘Š
          const warningDiv = document.createElement('div');
          warningDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#fbbf24;color:#92400e;text-align:center;padding:8px;z-index:9999;font-size:14px;';
          warningDiv.innerHTML = 'é¡µé¢ç‰ˆæœ¬è¾ƒæ—§ï¼Œå»ºè®®åˆ·æ–°è·å–æœ€æ–°ç‰ˆæœ¬ <button onclick="location.reload()" style="margin-left:10px;padding:2px 8px;background:#92400e;color:white;border:none;border-radius:3px;cursor:pointer;">åˆ·æ–°</button>';
          document.body.insertBefore(warningDiv, document.body.firstChild);
          // 5ç§’åè‡ªåŠ¨éšè—è­¦å‘Š
          setTimeout(() => {
            if (warningDiv.parentNode) {
              warningDiv.parentNode.removeChild(warningDiv);
            }
          }, 5000);
        }
        
        return true;
      }
      

      
      // é¡µé¢è®¿é—®é¢‘ç‡é™åˆ¶
      function checkAccessFrequency() {
        const storageKey = 'page_access_log';
        const now = Date.now();
        const timeWindow = 60 * 1000; // 1åˆ†é’Ÿæ—¶é—´çª—å£
        const maxAccess = 30; // æœ€å¤§è®¿é—®æ¬¡æ•°ï¼ˆæ”¾å®½é™åˆ¶ï¼‰
        
        try {
          let accessLog = JSON.parse(localStorage.getItem(storageKey) || '[]');
          
          // æ¸…ç†è¿‡æœŸè®°å½•
          accessLog = accessLog.filter(time => now - time < timeWindow);
          
          // æ£€æŸ¥è®¿é—®é¢‘ç‡
          if (accessLog.length >= maxAccess) {
            console.warn('è®¿é—®é¢‘ç‡è¾ƒé«˜ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º');
            // ä¸é˜»æ­¢è®¿é—®ï¼Œåªæ˜¾ç¤ºå‹å¥½æç¤º
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = 'position:fixed;top:60px;left:0;right:0;background:#f59e0b;color:white;text-align:center;padding:8px;z-index:9997;font-size:14px;';
            warningDiv.innerHTML = 'è®¿é—®é¢‘ç‡è¾ƒé«˜ï¼Œå»ºè®®é€‚å½“ä¼‘æ¯ <button onclick="this.parentNode.remove()" style="margin-left:10px;padding:2px 8px;background:white;color:#f59e0b;border:none;border-radius:3px;cursor:pointer;">çŸ¥é“äº†</button>';
            document.body.insertBefore(warningDiv, document.body.firstChild);
            // 8ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
              if (warningDiv.parentNode) {
                warningDiv.parentNode.removeChild(warningDiv);
              }
            }, 8000);
            
            // æ¸…ç†éƒ¨åˆ†è®¿é—®è®°å½•ï¼Œé¿å…æŒç»­æç¤º
            accessLog = accessLog.slice(-Math.floor(maxAccess * 0.7));
            localStorage.setItem(storageKey, JSON.stringify(accessLog));
          }
          
          // è®°å½•æœ¬æ¬¡è®¿é—®
          accessLog.push(now);
          localStorage.setItem(storageKey, JSON.stringify(accessLog));
          
        } catch (error) {
          console.warn('è®¿é—®é¢‘ç‡æ£€æŸ¥å¤±è´¥:', error);
        }
        
        return true;
      }
      
      // æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
      function performSecurityChecks() {
        if (!checkEnvironment()) return;
        if (!checkDomainAndProtocol()) return;
        if (!checkTimestamp()) return;
        if (!checkAccessFrequency()) return;
        
        console.log('å®‰å…¨æ£€æŸ¥é€šè¿‡');
      }
      
      // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æŸ¥
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', performSecurityChecks);
      } else {
        performSecurityChecks();
      }
      
      // å¼€å‘è€…å·¥å…·æ£€æµ‹
      function detectDevTools() {
        let devtools = {
          open: false,
          orientation: null
        };
        
        const threshold = 160;
        
        setInterval(function() {
          if (window.outerHeight - window.innerHeight > threshold || 
              window.outerWidth - window.innerWidth > threshold) {
            if (!devtools.open) {
              devtools.open = true;
              console.clear();
              console.log('%cè­¦å‘Šï¼šæ£€æµ‹åˆ°å¼€å‘è€…å·¥å…·', 'color: red; font-size: 30px; font-weight: bold;');
              console.log('%cæ­¤é¡µé¢å—åˆ°ä¿æŠ¤ï¼Œè¯·å…³é—­å¼€å‘è€…å·¥å…·', 'color: red; font-size: 16px;');
              
              // å¯é€‰ï¼šé˜»æ­¢é¡µé¢åŠŸèƒ½
              // document.body.style.display = 'none';
              // alert('è¯·å…³é—­å¼€å‘è€…å·¥å…·ååˆ·æ–°é¡µé¢');
            }
          } else {
            devtools.open = false;
          }
        }, 500);
        
        // æ£€æµ‹å³é”®èœå•
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          console.log('å³é”®èœå•å·²ç¦ç”¨');
          return false;
        });
        
        // æ£€æµ‹å¸¸ç”¨å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
          // F12
          if (e.keyCode === 123) {
            e.preventDefault();
            return false;
          }
          // Ctrl+Shift+I
          if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
            e.preventDefault();
            return false;
          }
          // Ctrl+Shift+C
          if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
            e.preventDefault();
            return false;
          }
          // Ctrl+U
          if (e.ctrlKey && e.keyCode === 85) {
            e.preventDefault();
            return false;
          }
        });
      }
      
      // åè°ƒè¯•ä¿æŠ¤
      function antiDebug() {
        // æ£€æµ‹è°ƒè¯•å™¨
        let start = new Date();
        debugger;
        let end = new Date();
        if (end - start > 100) {
          console.log('æ£€æµ‹åˆ°è°ƒè¯•å™¨');
          // å¯é€‰æ‹©çš„ååº”
          // window.location.href = 'about:blank';
        }
        
        // å®šæœŸæ‰§è¡Œåè°ƒè¯•æ£€æŸ¥
        setTimeout(antiDebug, 1000);
      }
      
      // ä»£ç å®Œæ•´æ€§æ£€æŸ¥
      function checkCodeIntegrity() {
        // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦è¢«ä¿®æ”¹
        const originalFetch = window.fetch.toString();
        const originalXHR = window.XMLHttpRequest.prototype.open.toString();
        
        setInterval(function() {
          if (window.fetch.toString() !== originalFetch) {
            console.error('æ£€æµ‹åˆ°fetchå‡½æ•°è¢«ä¿®æ”¹');
            // å¯é€‰æ‹©é‡æ–°åŠ è½½é¡µé¢
            // window.location.reload();
          }
          if (window.XMLHttpRequest.prototype.open.toString() !== originalXHR) {
            console.error('æ£€æµ‹åˆ°XMLHttpRequestè¢«ä¿®æ”¹');
            // å¯é€‰æ‹©é‡æ–°åŠ è½½é¡µé¢
            // window.location.reload();
          }
        }, 3000);
      }
      
      // å®šæœŸæ£€æŸ¥ï¼ˆé˜²æ­¢è¿è¡Œæ—¶ä¿®æ”¹ï¼‰
      setInterval(function() {
        if (!checkDomainAndProtocol()) {
          window.location.href = 'about:blank';
        }
      }, 5000);
      
      // å¯åŠ¨æ‰€æœ‰ä¿æŠ¤åŠŸèƒ½
      detectDevTools();
      setTimeout(antiDebug, 1000);
      checkCodeIntegrity();
      
    })();
  </script>
  
  <!-- Tailwindé…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981'
          }
        }
      }
    }
  </script>
  
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .sticky-col {
    position: sticky;
    top: 20px;
    z-index: 50;
  }
  .header-title {
    transition: transform 0.3s ease, opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    overflow: hidden;
  }
  .header-title.hidden-on-scroll {
    transform: translateY(-100%);
    opacity: 0;
    height: 0;
    padding: 0;
    pointer-events: none;
  }
  .toolbar-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    transition: all 0.3s ease;
  }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .hit-cell {
        @apply bg-primary/20 text-primary font-bold;
      }
      .miss-cell {
        @apply text-gray-400;
      }
      .btn-active {
        @apply bg-primary text-white;
      }
      .btn-hover {
        @apply hover:bg-primary/80 hover:text-white transition-colors duration-200;
      }
      
      /* æŒ‰é’®æ‚¬åœå˜è‰²ä¸ºFF7373 - ä»…åœ¨æ”¯æŒhoverçš„è®¾å¤‡ä¸Šç”Ÿæ•ˆï¼Œä½†æ’é™¤ç‰¹æ®ŠæŒ‰é’® */
      @media (hover: hover) {
        button:hover:not(.position-btn):not(.hit-number-btn):not(.dama-btn):not(.btn-active) {
          background-color: #FF7373 !important;
          transition: background-color 0.2s ease;
        }
      }
      
      /* ç§»åŠ¨ç«¯è§¦æ‘¸åé¦ˆ - é¿å…ä¿æŒhoverçŠ¶æ€ï¼Œä½†æ’é™¤ç‰¹æ®ŠæŒ‰é’® */
      @media (hover: none) {
        button:active:not(.position-btn):not(.hit-number-btn):not(.dama-btn):not(.btn-active) {
          background-color: #FF7373 !important;
          transition: background-color 0.1s ease;
        }
      }
      
      /* é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»æ”¾å¤§å’Œæ„å¤–ç¼©æ”¾ */
      * {
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      /* å…è®¸è¾“å…¥æ¡†å’Œæ–‡æœ¬åŒºåŸŸé€‰æ‹©æ–‡æœ¬ */
      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      
      /* èƒ†ç æŒ‰é’®ç‰¹æ®Šå¤„ç† - ç¡®ä¿è§¦æ‘¸åé¦ˆæ­£å¸¸ */
      .dama-btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* èƒ†ç æŒ‰é’®æœªé€‰ä¸­çŠ¶æ€ - è¦†ç›–å…¨å±€hoveræ ·å¼ */
      @media (hover: hover) {
        .dama-btn:not(.bg-primary):hover {
          background-color: #e5e7eb !important; /* gray-200 */
          color: #374151 !important; /* gray-700 */
        }
      }
      
      /* èƒ†ç æŒ‰é’®é€‰ä¸­çŠ¶æ€ä¿æŒçº¢è‰² */
      .dama-btn.bg-primary {
        background-color: #d62828 !important;
        color: white !important;
      }
      
      @media (hover: hover) {
        .dama-btn.bg-primary:hover {
          background-color: #b91c1c !important; /* ç¨æ·±çš„çº¢è‰² */
          color: white !important;
        }
      }
      
      /* ä½ç½®é€‰æ‹©æŒ‰é’®æ ·å¼ */
      .position-btn {
        cursor: pointer !important;
        pointer-events: auto !important;
        user-select: none !important;
        transition: all 0.2s ease !important;
      }
      
      .position-btn:not(.btn-active) {
        background-color: #e5e7eb !important; /* gray-200 */
        color: #374151 !important; /* gray-700 */
      }
      
      .position-btn.btn-active,
      .position-btn.bg-primary {
        background-color: #3b82f6 !important; /* blue-500 */
        color: white !important;
      }
      
      @media (hover: hover) {
        .position-btn:not(.btn-active):hover {
          background-color: #d1d5db !important; /* gray-300 */
          color: #374151 !important;
        }
        
        .position-btn.btn-active:hover,
        .position-btn.bg-primary:hover {
          background-color: #2563eb !important; /* blue-600 */
          color: white !important;
        }
      }
      
      /* ç§»åŠ¨ç«¯ä½ç½®æŒ‰é’®è§¦æ‘¸åé¦ˆ */
      @media (hover: none) {
        .position-btn:active {
          transform: scale(0.95) !important;
          transition: transform 0.1s ease !important;
        }
      }
      
      /* å‘½ä¸­æ•°å­—æŒ‰é’®æ ·å¼ */
      .hit-number-btn.bg-primary {
        background-color: #10b981 !important; /* emerald-500 */
        color: white !important;
      }
      
      @media (hover: hover) {
        .hit-number-btn.bg-primary:hover {
          background-color: #059669 !important; /* emerald-600 */
          color: white !important;
        }
      }
      
      /* é˜²æ­¢é¡µé¢ç¼©æ”¾ */
      html {
        -ms-touch-action: manipulation;
        touch-action: manipulation;
      }
      .number-row {
        @apply flex justify-center space-x-1 mb-1;
      }
      
      /* æ‰‹æœºç«¯äº”æ˜Ÿåšå·é¡µé¢ä¼˜åŒ– */
      @media (max-width: 768px) {
        /* ç§»é™¤ä¸»å®¹å™¨çš„å·¦å³è¾¹è· */
        #fiveStarPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* ç§»é™¤æ¨¡å—å®¹å™¨çš„è¾¹è·å’Œåœ†è§’ */
        #fiveStarPage .bg-white {
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* ç§»é™¤æ¨¡å—é—´è· */
        #modules-container {
          gap: 8px !important;
          padding: 0 !important;
        }
        
        /* ç§»é™¤æ¨¡å—è¾¹æ¡†å’Œåœ†è§’ */
        .five-star-module {
          border: none !important;
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* ä¼˜åŒ–æ•°å­—æŒ‰é’®å°ºå¯¸ - ç¡®ä¿ä¸€è¡Œæ”¾10ä¸ª */
        .number-btn {
          width: calc(10% - 2px) !important;
          height: 32px !important;
          min-width: 28px !important;
          font-size: 13px !important;
          padding: 0 !important;
          margin: 1px !important;
          flex-shrink: 0 !important; /* é˜²æ­¢æŒ‰é’®æ”¶ç¼© */
        }
      }
      
      /* äº¤é›†æ‹¼æ¥é¡µé¢ä¸“ç”¨æ ·å¼ */
      .intersection-page-title {
        @apply text-2xl font-bold text-gray-800 text-center mb-6;
      }
      
      .function-switch-area {
        @apply flex justify-center mb-6;
      }
      
      .function-switch-btn {
        @apply px-6 py-2 mx-2 rounded-md font-medium transition-colors duration-200;
      }
      
      .function-switch-btn.active {
        @apply bg-blue-500 text-white;
      }
      
      .function-switch-btn:not(.active) {
        @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
      }
      
      /* æ‹¼æ¥ç±»å‹æŒ‰é’®æ ·å¼ */
      .concat-type-btn {
        @apply px-6 py-2 mx-2 rounded-md font-medium transition-colors duration-200;
      }
      
      .concat-type-btn.active {
        @apply bg-blue-500 text-white;
      }
      
      .concat-type-btn:not(.active) {
        @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
      }
      
      .management-functions {
        @apply flex justify-center gap-4 mb-6;
      }
      
      .management-btn {
        @apply px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors;
      }
      
      .main-input-area {
        @apply bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6;
      }
      
      .main-input-title {
        @apply text-lg font-medium text-gray-800 mb-3;
      }
      
      .main-input-textarea {
        @apply w-full h-24 px-3 py-2 border border-gray-300 rounded-md resize-none text-sm bg-white;
      }
      
      .main-input-actions {
        @apply flex justify-end gap-2 mt-3;
      }
      
      .input-action-btn {
        @apply px-4 py-2 rounded-md text-white font-medium transition-colors;
      }
      
      .input-action-btn.copy {
        @apply bg-green-500 hover:bg-green-600;
      }
      
      .input-action-btn.clear {
        @apply bg-red-500 hover:bg-red-600;
      }
      
      .input-action-btn.paste {
        @apply bg-blue-500 hover:bg-blue-600;
      }
      
      .input-modules-area {
        @apply mb-6;
      }
      
      .input-modules-title {
        @apply text-lg font-medium text-gray-800 mb-4;
      }
      
      .modules-grid {
        @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4;
      }
      
      .input-module {
        @apply bg-white border border-gray-200 rounded-lg p-4 shadow-sm;
      }
      
      .module-header {
        @apply flex items-center justify-between mb-3;
      }
      
      .module-title {
        @apply text-base font-medium text-gray-800;
      }
      
      .module-actions {
        @apply flex gap-2;
      }
      
      .module-btn {
        @apply px-3 py-1 text-sm rounded transition-colors;
      }
      
      .module-btn.paste {
        @apply bg-blue-500 text-white hover:bg-blue-600;
      }
      
      .module-btn.clear {
        @apply bg-gray-500 text-white hover:bg-gray-600;
      }
      
      .module-textarea {
        @apply w-full px-3 py-2 border border-gray-300 rounded-md resize-none text-sm bg-white;
      }

      /* å·ç äº¤é›†åŠŸèƒ½ä¸“ç”¨æ ·å¼ */
      .tolerance-btn {
        @apply px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors font-medium min-w-[40px] text-center;
      }

      .tolerance-btn.active {
        @apply bg-blue-500 text-white hover:bg-blue-600;
      }

      .modules-container {
        @apply border border-gray-200 rounded-lg bg-gray-50;
      }

      .modules-container::-webkit-scrollbar {
        width: 8px;
      }

      .modules-container::-webkit-scrollbar-track {
        @apply bg-gray-100 rounded;
      }

      .modules-container::-webkit-scrollbar-thumb {
        @apply bg-gray-300 rounded hover:bg-gray-400;
      }

      .module-count {
        @apply text-xs text-gray-500 ml-2;
      }

      .clear-btn {
        @apply bg-red-500 text-white hover:bg-red-600;
      }

      .paste-btn {
        @apply bg-blue-500 text-white hover:bg-blue-600;
      }
      
      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        .intersection-page-title {
          @apply text-xl mb-4;
        }
        
        .function-switch-btn {
          @apply px-4 py-2 mx-1 text-sm;
        }
        
        .management-functions {
          @apply flex-wrap gap-2 mb-4;
        }
        
        .management-btn {
          @apply px-3 py-1 text-sm;
        }
        
        .main-input-area {
          @apply p-3 mb-4;
        }
        
        .main-input-title {
          @apply text-base mb-2;
        }
        
        .main-input-textarea {
          @apply h-20 text-sm;
        }
        
        .input-modules-title {
          @apply text-base mb-3;
        }
        
        .modules-grid {
          @apply grid-cols-1 gap-3;
        }
        
        .input-module {
          @apply p-3;
        }
        
        .module-title {
          @apply text-sm;
        }
        
        .module-btn {
          @apply px-2 py-1 text-xs;
        }
        
        .module-textarea {
          @apply text-sm;
        }
        
        /* ä¼˜åŒ–æ•°å­—æŒ‰é’®å®¹å™¨ - ç¡®ä¿ä¸æ¢è¡Œ */
        .number-buttons {
          gap: 0 !important;
          margin-bottom: 8px !important;
          flex-wrap: nowrap !important; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
          overflow-x: auto !important; /* å¦‚æœå†…å®¹è¿‡å®½åˆ™å…è®¸æ¨ªå‘æ»šåŠ¨ */
        }
        
        /* ä¼˜åŒ–èƒ†ç æŒ‰é’® */
        .dama-btn {
          font-size: 13px !important;
          padding: 4px 8px !important;
          margin: 1px !important;
        }
        
        /* ä¼˜åŒ–èƒ†ç æŒ‰é’®å®¹å™¨ */
        .dama-buttons {
          gap: 2px !important;
          margin-bottom: 8px !important;
        }
        
        /* ä¼˜åŒ–ç­›é€‰ç»„é—´è· */
        .filter-group {
          margin-bottom: 8px !important;
          padding-bottom: 8px !important;
        }
        
        /* ä¼˜åŒ–æ¨¡å—æ€»å®¹é”™åŒºåŸŸ */
        .module-tolerance {
          margin-bottom: 8px !important;
          padding: 8px !important;
        }
      }
      
      /* æ€å½¢æ€æ ·å¼ */
      .kill-pattern-container {
        position: relative;
      }
      
      .kill-pattern-dropdown {
        position: relative;
        display: inline-block;
      }

      /* é¢å¤–ç­›é€‰ï¼ˆæ€è·¨åº¦/æ€å’Œå°¾ï¼‰ä¸‹æ‹‰å®¹å™¨ï¼Œå®šä½ä¸å½¢æ€ä¸‹æ‹‰ä¸€è‡´ */
      .kill-extra-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .kill-pattern-trigger {
        min-width: 120px;
        padding: 4px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      /* æ€è·¨åº¦å’Œæ€å’Œå°¾ä¸“ç”¨æ ·å¼ - æ›´å°çš„ä¸‹æ‹‰æ¡† */
      .kill-extra-dropdown .kill-pattern-trigger {
        min-width: 60px;
        max-width: 80px;
        padding: 2px 6px;
        font-size: 11px;
      }
      
      .kill-extra-dropdown .kill-pattern-menu {
        min-width: 60px;
        max-width: 120px;
      }

      /* ç¡®ä¿è§¦å‘å™¨å†…çš„ç©ºæ ¼å ä½å¯è§ï¼ˆæœªé€‰ä½ç½®æ˜¾ç¤ºç©ºæ ¼ï¼‰ */
      .kill-pattern-display {
        white-space: pre; /* ä¿ç•™è¿ç»­ç©ºæ ¼ */
      }
      
      .kill-pattern-trigger:hover {
        border-color: #9ca3af;
        background-color: #f9fafb;
      }
      
      .kill-pattern-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 8px;
        margin-top: 4px;
        min-width: 200px;
      }
      
      .kill-pattern-menu.active {
        display: block;
      }
      
      .kill-pattern-row {
        display: flex;
        gap: 4px;
        margin-bottom: 6px;
      }
      
      .kill-pattern-cell {
        flex: 1;
        min-width: 30px;
        height: 30px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        background-color: white;
      }
      
      .kill-pattern-btn {
        flex: 1;
        min-width: 30px;
        height: 30px;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        background-color: #f3f4f6;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .kill-pattern-btn:hover {
        background-color: #e5e7eb;
        border-color: #9ca3af;
      }
      
      .kill-pattern-btn.active {
        background-color: #3b82f6;
        color: white;
        border-color: #2563eb;
      }
      
      .kill-pattern-clear-btn {
        padding: 4px 12px;
        font-size: 12px;
        background-color: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .kill-pattern-clear-btn:hover {
        background-color: #dc2626;
      }
      
      /* æ‰‹æœºç«¯é»„é‡‘åˆ‡å‰²é¡µé¢ä¼˜åŒ– */
      @media (max-width: 768px) {
        /* ç§»é™¤é»„é‡‘åˆ‡å‰²é¡µé¢ä¸»å®¹å™¨çš„å·¦å³è¾¹è· */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* ç§»é™¤ä¸»æ¨¡å—çš„è¾¹è·å’Œåœ†è§’ */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          padding: 12px !important;
          margin: 0 !important;
          box-shadow: none !important;
        }
        
        /* ä¼˜åŒ–æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        #goldenRatioPage .flex.justify-center.gap-3 {
          gap: 8px !important;
        }
        
        #goldenRatioPage button[data-mode] {
          padding: 8px 16px !important;
          font-size: 14px !important;
        }
        
        /* ä¼˜åŒ–è¾“å…¥åŒºåŸŸ */
        #goldenInputData {
          padding: 8px !important;
          font-size: 14px !important;
        }
        
        /* ä¼˜åŒ–æ“ä½œæŒ‰é’® */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 {
          gap: 6px !important;
          flex-wrap: wrap !important;
        }
        
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          flex: 1 !important;
          min-width: 80px !important;
        }
        
        /* ä¼˜åŒ–ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        #goldenRatioPage .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-5 {
          grid-template-columns: 1fr 1fr !important;
          gap: 4px !important;
        }
        
        /* ä¼˜åŒ–éªŒè¯ç»“æœåŒºåŸŸ */
        #validationResults {
          padding: 8px !important;
          margin-top: 12px !important;
        }
        
        /* ä¼˜åŒ–æ ‡é¢˜å’Œæ‘˜è¦ */
        #goldenRatioPage h3 {
          font-size: 16px !important;
        }
        
        #goldenRatioPage .text-sm {
          font-size: 12px !important;
        }
      }
      
      /* æ‰‹æœºç«¯é»„é‡‘åˆ‡å‰²é¡µé¢ä¼˜åŒ– */
      @media (max-width: 768px) {
        /* ç§»é™¤é»„é‡‘åˆ‡å‰²é¡µé¢ä¸»å®¹å™¨çš„å·¦å³è¾¹è· */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* ç§»é™¤ä¸»æ¨¡å—çš„è¾¹æ¡†ã€åœ†è§’å’Œé˜´å½± */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          box-shadow: none !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* ä¼˜åŒ–æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        #goldenRatioPage .flex.justify-center.gap-3 button {
          padding: 8px 16px !important;
          font-size: 14px !important;
          margin: 2px !important;
        }
        
        /* ä¼˜åŒ–è¾“å…¥åŒºåŸŸ */
        #goldenRatioPage textarea {
          padding: 8px !important;
          font-size: 14px !important;
          border-radius: 4px !important;
        }
        
        /* ä¼˜åŒ–æ“ä½œæŒ‰é’® */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          margin: 2px !important;
        }
        
        /* ä¼˜åŒ–ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        #goldenRatioPage .grid.gap-2 {
          gap: 4px !important;
        }
        
        /* ä¼˜åŒ–éªŒè¯ç»“æœåŒºåŸŸ */
        #goldenRatioPage #validationResults {
          padding: 8px !important;
          margin-top: 8px !important;
          border-radius: 4px !important;
        }
        
        /* å‡å°‘å„åŒºåŸŸçš„è¾¹è· */
        #goldenRatioPage .mb-6 {
          margin-bottom: 12px !important;
        }
        
        #goldenRatioPage .mb-4 {
          margin-bottom: 8px !important;
        }
        
        #goldenRatioPage .mb-2 {
          margin-bottom: 4px !important;
        }
      }
      .fixed-width-period {
        width: 120px;
        /* ç§»é™¤transitionæ•ˆæœï¼Œè®©æœŸæ•°åˆ—æ˜¾ç¤º/éšè—æ›´åŠ å³æ—¶ */
      }

      .fixed-width-data {
        width: 150px;
        /* ç§»é™¤transitionæ•ˆæœï¼Œè®©ä½ç½®å˜åŒ–æ›´åŠ å³æ—¶ */
      }
      .table-header-sticky {
        position: sticky;
        top: 20px;
        z-index: 1002;
        background-color: #f9fafb;
      }
      .sticky-bg-white {
        background-color: white !important;
      }
      .sticky-bg-gray-100 {
        background-color: #f3f4f6 !important;
      }
      
      /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 3px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb:hover {
        background-color: #9ca3af;
      }
      
      .scrollbar-track-gray-100::-webkit-scrollbar-track {
        background-color: #f3f4f6;
        border-radius: 3px;
      }
      
      /* é»„é‡‘åˆ‡å‰²ç»“æœå®¹å™¨æ ·å¼ */
      #goldenResults {
        scroll-behavior: smooth;
      }
      
      #goldenResults::-webkit-scrollbar {
        height: 8px;
      }
      
      #goldenResults::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      /* æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
      .active-mode {
        background-color: #3b82f6 !important;
        color: white !important;
      }
      
      .inactive-mode {
        background-color: #d1d5db !important;
        color: #374151 !important;
      }
      .sticky-bg-gray-50 {
        background-color: #f9fafb !important;
      }
      .sticky-bg-blue-50 {
        background-color: #eff6ff !important;
      }
      .sequence-row {
        height: 20px !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 1004 !important;
        background-color: #eff6ff !important;
      }
      .sequence-row td {
        padding: 2px 4px !important;
        font-size: 12px !important;
        line-height: 1 !important;
        background-color: #eff6ff !important;
      }
      .sequence-row .sticky-col {
        position: sticky !important;
        top: 0 !important;
        z-index: 1005 !important;
        background-color: #eff6ff !important;
      }


      /* é™åˆ¶è¡¨æ ¼å®¹å™¨é«˜åº¦ï¼Œæœ€å¤šæ˜¾ç¤º50è¡Œ */
      .table-container {
        max-height: calc(100vh - 400px); /* é¡µé¢ä¸€å±é«˜åº¦å‡å»å…¶ä»–å…ƒç´ é«˜åº¦ */
        overflow-y: auto;
        position: relative;
      }
      
      /* æ‰‹æœºç«¯å…¨å±æ¨¡å¼æ ·å¼ */
      @media (max-width: 768px) {
        /* å…¨å±æ¨¡å¼ä¸‹çš„å·¥å…·æ æ ·å¼ */
        .fullscreen-toolbar {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 1000 !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹éšè—çš„å…ƒç´  */
        .fullscreen-hidden {
          transform: translateY(-100%) !important;
          transition: transform 0.3s ease-in-out !important;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹ä¸»å†…å®¹åŒºåŸŸçš„è°ƒæ•´ */
        .fullscreen-main {
          padding-top: 50px !important;
          transition: padding-top 0.3s ease-in-out !important;
        }
        
        /* ä¼˜åŒ–æ‰‹æœºç«¯æ»šåŠ¨æ€§èƒ½ */
        body {
          -webkit-overflow-scrolling: touch;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„å·¥å…·æ æŒ‰é’®ä¼˜åŒ– */
        .fullscreen-toolbar .container {
          padding-left: 1rem !important;
          padding-right: 1rem !important;
        }
        
        .fullscreen-toolbar button {
          font-size: 14px !important;
          padding: 0.5rem 1rem !important;
        }
        
        /* é˜²æ­¢å…¨å±åˆ‡æ¢æ—¶çš„é—ªçƒ */
        header * {
          backface-visibility: hidden;
          -webkit-backface-visibility: hidden;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„é˜´å½±æ•ˆæœ */
        .fullscreen-toolbar::after {
          content: '';
          position: absolute;
          bottom: -8px;
          left: 0;
          right: 0;
          height: 8px;
          background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
          pointer-events: none;
        }
      }
    }
  </style>
  
  <script>
    // æ»šåŠ¨æ—¶éšè—æ ‡é¢˜ï¼Œä¿ç•™å·¥å…·æ 
    let lastScrollTop = 0;
    let isScrolling = false;
    let isPageSwitching = false; // é¡µé¢åˆ‡æ¢æ ‡å¿—
    let scrollTimeout = null; // æ»šåŠ¨é˜²æŠ–å®šæ—¶å™¨
    
    function handleScroll() {
      if (isScrolling || isPageSwitching) return;
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      
      isScrolling = true;
      
      // æ·»åŠ é˜²æŠ–å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
      scrollTimeout = setTimeout(() => {
        requestAnimationFrame(() => {
          const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          const headerTitle = document.querySelector('.header-title');
          const keyCountdown = document.getElementById('keyCountdown');
          const scrollDirection = currentScroll > lastScrollTop ? 'down' : 'up';
          
          // å¢åŠ æ»šåŠ¨é˜ˆå€¼å’Œæ–¹å‘æ£€æµ‹ï¼Œå‡å°‘é—ªåŠ¨
          if (currentScroll > 80 && scrollDirection === 'down') {
            // å‘ä¸‹æ»šåŠ¨è¶…è¿‡80pxæ—¶éšè—æ ‡é¢˜
            headerTitle.classList.add('hidden-on-scroll');
            // åŒæ—¶éšè—å¯†é’¥å€’è®¡æ—¶æ ï¼ˆå®Œå…¨éšè—å¹¶é‡Šæ”¾ç©ºé—´ï¼‰
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = '0';
              keyCountdown.style.opacity = '0';
              keyCountdown.style.paddingTop = '0';
              keyCountdown.style.paddingBottom = '0';
              keyCountdown.style.overflow = 'hidden';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          } else if (currentScroll < 40 && scrollDirection === 'up') {
            // å‘ä¸Šæ»šåŠ¨åˆ°40pxä»¥ä¸‹æ—¶æ˜¾ç¤ºæ ‡é¢˜
            headerTitle.classList.remove('hidden-on-scroll');
            // åŒæ—¶æ˜¾ç¤ºå¯†é’¥å€’è®¡æ—¶æ ï¼ˆæ¢å¤åŸå§‹é«˜åº¦å’Œæ ·å¼ï¼‰
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = 'auto';
              keyCountdown.style.opacity = '1';
              keyCountdown.style.paddingTop = '0.5rem';
              keyCountdown.style.paddingBottom = '0.5rem';
              keyCountdown.style.overflow = 'visible';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          }
          
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
          isScrolling = false;
        });
      }, 50); // 50msé˜²æŠ–å»¶è¿Ÿ
    }
    
    // é¡µé¢åˆ‡æ¢æ—¶ç¦ç”¨æ»šåŠ¨ç›‘å¬
    function disableScrollListener() {
      isPageSwitching = true;
      setTimeout(() => {
        isPageSwitching = false;
      }, 300); // 300msåé‡æ–°å¯ç”¨
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ æ»šåŠ¨ç›‘å¬
    document.addEventListener('DOMContentLoaded', function() {
      window.addEventListener('scroll', handleScroll, { passive: true });
    });
  </script>
</head>
<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
  <!-- å¯†é’¥å€’è®¡æ—¶é€šçŸ¥æ  -->
  <div id="keyCountdown" class="bg-primary text-white py-2 px-4 text-center hidden">
    <span>å¯†é’¥æœ‰æ•ˆæœŸå‰©ä½™: <strong id="timeRemaining">0å¤© 0å°æ—¶ 0åˆ†é’Ÿ 0ç§’</strong></span>
  </div>
  
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <!-- æ ‡é¢˜åŒºåŸŸ - ç‹¬ç«‹æ¨¡å— -->
  <div class="header-title bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
        <h1 class="text-xl md:text-2xl font-bold text-primary flex items-center">
          <i class="fa fa-line-chart mr-2"></i>å°æ¹¾PKæ•°æ®åˆ†æå·¥å…·
        </h1>

      </div>
  </div>
    
  <!-- å·¥å…·æ åŒºåŸŸ - ç‹¬ç«‹ç²˜æ€§æ¨¡å— -->
  <nav class="bg-gray-800 text-white py-2 sticky-header toolbar-sticky" style="top: 0; z-index: 100;">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center">
        <div class="flex space-x-4">
          <button id="dataAnalysisBtn" class="px-4 py-1 rounded bg-primary text-white font-medium">æ•°æ®åˆ†æ</button>
          <button id="fiveStarBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">åšå·æ‹¼æ¥</button>
          <button id="verifyPlanBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">éªŒè¯è®¡åˆ’</button>
          <button id="goldenRatioBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">é»„é‡‘åˆ‡å‰²</button>
          <button id="intersectionCutBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">å·ç äº¤é›†</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»è¦å†…å®¹ -->
  <main class="flex-1 container mx-auto px-4 py-6">
    <!-- æ•°æ®åˆ†æé¡µé¢ -->
    <div id="dataAnalysisPage">
      <!-- æ•°æ®è¾“å…¥åŒºåŸŸ -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <!-- å½©ç§é€‰æ‹©åŒºåŸŸ -->
        <div class="mb-4 pb-4 border-b border-gray-200">
          <div class="flex items-center gap-4">
            <label for="lotteryType" class="text-sm font-medium text-gray-700">å½©ç§é€‰æ‹©:</label>
            <select id="lotteryType" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 bg-white">
              <option value="bscbh3fpk10">å¸å®‰3åˆ†PK10</option>
              <option value="bscbh5fpk10">å¸å®‰5åˆ†PK10</option>
              <option value="tronbh3fpk10">æ³¢åœº3åˆ†PK10</option>
              <option value="twpk10" selected>å°æ¹¾PK10</option>
            </select>
            <span id="currentLotteryStatus" class="text-sm text-gray-500">å½“å‰: å°æ¹¾PK10</span>
          </div>
        </div>
        
        <div class="flex flex-col md:flex-row md:items-center gap-4">
          <div class="flex-1">
            <label for="numbersInput" class="block text-sm font-medium text-gray-700 mb-1">æ‰‹åŠ¨è¾“å…¥æ•°æ®ï¼ˆæ”¯æŒæ ¼å¼ï¼šæœŸæ•° æ•°æ®ï¼Œå¦‚ï¼š202504181232 02,05,01,04,07,10,09,03,06,08 ï¼‰</label>
            <textarea id="numbersInput" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="202504181232 02,05,01,04,07,10,09,03,06,08"></textarea>
          </div>
          <div class="flex flex-col gap-3 w-full md:w-auto">
            <button id="calcBtn" class="px-4 py-2 bg-primary text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-calculator mr-2"></i>è®¡ç®—åˆ†æ
            </button>
            <button id="autoFetchBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md flex items-center justify-center btn-hover" style="display: none;">
              <i class="fa fa-play mr-2"></i>å¼€å§‹è‡ªåŠ¨è·å–
            </button>
            <button id="fetchApiBtn" class="px-4 py-2 bg-green-600 text-white rounded-md flex items-center justify-center btn-hover" style="display: none;">
        <i class="fa fa-download mr-2"></i>è·å–æœ€æ–°æ•°æ®
    </button>
            <button id="uploadDataBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-upload mr-2"></i>ä¸Šä¼ æ•°æ®æ–‡ä»¶
            </button>
          </div>
        </div>
        <div id="output" class="mt-3 text-sm text-primary"></div>
      </section>

      <!-- ç­›é€‰å’Œç»Ÿè®¡æ§åˆ¶åŒºåŸŸ -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <div class="grid grid-cols-1 gap-4">
          <!-- è‡ªå®šä¹‰ç»„åˆ -->
          <div>
            <label for="customCombos" class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šä¹‰ç»„åˆï¼ˆç”¨ç©ºæ ¼åˆ†éš”ä¸åŒç»„åˆï¼Œæ¯ä¸ªç»„åˆå†…çš„æ•°å­—ç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
            <div class="flex gap-3 items-start">
              <textarea id="customCombos" rows="2" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="1,2,3 1,2,4"></textarea>
              <div class="flex flex-col gap-2">
                <button id="statBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-bar-chart mr-2"></i>åŠ å…¥ç»Ÿè®¡
                </button>
                <button id="clearBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-trash mr-2"></i>æ¸…ç©ºæ•°æ®
                </button>
              </div>
            </div>
          </div>
          
          <!-- ç­›é€‰æ¨¡å— -->
          <div class="flex flex-wrap items-start gap-4">
            <!-- èƒ†ç æ•°ç­›é€‰ -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç æ•°</label>
              <select id="numSelect" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                <option value="1">1ç </option>
                <option value="2">2ç </option>
                <option value="3" selected>3ç </option>
                <option value="4">4ç </option>
                <option value="5">5ç </option>
                <option value="6">6ç </option>
                <option value="7">7ç </option>
                <option value="8">8ç </option>
                <option value="9">9ç </option>
                <option value="10">10ç </option>
              </select>
            </div>
            
            <!-- ä½ç½®é€‰æ‹© -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">ä½ç½®é€‰æ‹©ï¼š</label>
              <div id="positionButtons" class="flex flex-wrap gap-2">
                <button class="position-btn px-3 py-1 rounded-md" data-position="1">1å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="2">2å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="3">3å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="4">4å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="5">5å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="6">6å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="7">7å</button>
                <button class="position-btn px-3 py-1 rounded-md" data-position="8">8å</button>
              </div>
            </div>
            
            <!-- ä¸­å‡ºç­›é€‰ -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">å‘½ä¸­ç æ•°ï¼š</label>
              <div id="hitButtons" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- å‘½ä¸­æ•°å­—é€‰æ‹© -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <label class="block text-sm font-medium text-gray-700 mb-2">å‘½ä¸­æ•°å­—ï¼š</label>
              <div id="hitNumberButtons" class="flex flex-wrap gap-2">
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="1">1</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="2">2</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="3">3</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="4">4</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="5">5</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="6">6</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="7">7</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="8">8</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="9">9</button>
                <button class="hit-number-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-number="10">10</button>
              </div>
            </div>
            
            <!-- ç¡®è®¤æŒ‰é’® -->
            <div class="flex-shrink-0 bg-blue-50 p-3 rounded-lg border border-blue-100">
              <button id="confirmFilterBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200 font-medium">
                ç¡®è®¤ç­›é€‰
              </button>
            </div>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex flex-wrap gap-3 mt-5">
          <button id="sortToggle" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover hidden">
            <i class="fa fa-sort mr-2"></i><span id="sortText">æŒ‰è¿ä¸­æ¬¡æ•°æ’åº</span>
          </button>
        </div>
      </section>

      <!-- ç»“æœè¡¨æ ¼ -->
      <section class="bg-white rounded-lg shadow-md p-5 overflow-x-auto relative">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold">æ•°æ®åˆ†æç»“æœ</h2>
            <!-- ç»Ÿä¸€çš„æŒ‰é’®ç»„ -->
            <div class="flex gap-1">
              <!-- å½“å‰é—æ¼/å½“å‰è¿ä¸­åˆ‡æ¢ -->
              <div class="flex rounded-md overflow-hidden border border-gray-300">
                <button id="currentMissBtn" class="px-3 py-1 bg-blue-600 text-white btn-hover text-sm btn-active">å½“å‰é—æ¼</button>
                <button id="currentHitBtn" class="px-3 py-1 bg-gray-200 text-gray-700 btn-hover text-sm">å½“å‰è¿ä¸­</button>
              </div>
              <!-- å‘½ä¸­ç‡æ’åºæŒ‰é’® -->
              <div class="flex rounded-md overflow-hidden border border-gray-300">
                <button id="hitRateSortBtn" class="px-3 py-1 bg-gray-200 text-gray-700 btn-hover text-sm">å‘½ä¸­ç‡æ’åº</button>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover btn-active" data-period="15">15æœŸ</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="30">30æœŸ</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="50">50æœŸ</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="100">100æœŸ</button>
            <div class="flex items-center gap-1">
              <input type="number" id="customPeriod" min="1" max="10000" value="15" class="w-16 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
              <button id="customPeriodBtn" class="px-3 py-1 rounded-md bg-gray-200 btn-hover">è‡ªå®šä¹‰</button>
            </div>
          </div>
          <div class="text-sm text-gray-500">
            <span id="periodCount">0</span> æœŸæ•°æ®
          </div>
        </div>
        
        <div class="relative">
          <div class="overflow-x-auto table-container scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="tableContainer">
            <table id="resultTable" class="min-w-full divide-y divide-gray-200">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          

        </div>
        
        <!-- ç»Ÿè®¡æ‘˜è¦ -->
        <div id="summary" class="mt-4 p-3 bg-gray-50 rounded-md text-sm font-medium"></div>
      </section>
    </div>
    
    <!-- äº”æ˜Ÿåšå·é¡µé¢ï¼ˆæŒ‰å›¾ç‰‡å¸ƒå±€ï¼‰ -->
    <div id="fiveStarPage" class="hidden">
      <div class="container mx-auto py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
          <!-- æ¨¡å¼åˆ‡æ¢åŒºåŸŸ -->
          <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
            <div class="flex gap-3">
              <button id="concatModeBtn" class="flex-1 px-4 py-3 rounded-lg border-2 border-blue-500 bg-blue-500 text-white font-semibold transition-all hover:shadow-lg flex items-center justify-center gap-2 mode-btn-active">
                <span class="text-xl">ğŸ”—</span>
                <span>æ‹¼æ¥æ¨¡å¼</span>
              </button>
              <button id="intersectionModeBtn" class="flex-1 px-4 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-700 font-semibold transition-all hover:border-purple-500 hover:text-purple-600 flex items-center justify-center gap-2">
                <span class="text-xl">âš¡</span>
                <span>äº¤é›†æ¨¡å¼</span>
              </button>
            </div>
          </div>
          
          <!-- ç»Ÿä¸€æ“ä½œé¢æ¿ -->
          <div class="mb-6 border border-gray-200 rounded-lg p-4 bg-gray-50">
            <!-- æ“ä½œåŒºåŸŸ -->
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-3">
                <!-- æ‹¼æ¥æ˜Ÿçº§ï¼ˆæ‹¼æ¥æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <span id="concatLabel" class="text-sm font-semibold text-gray-800">æ‹¼æ¥æ˜Ÿçº§ï¼š</span>
                <div id="starSelector" class="flex space-x-2">
                  <button id="star3Btn" class="star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-blue-100 transition-colors text-sm" data-star="3">3æ˜Ÿ</button>
                  <button id="star4Btn" class="star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-blue-100 transition-colors text-sm" data-star="4">4æ˜Ÿ</button>
                  <button id="star5Btn" class="star-btn px-3 py-1 rounded border-2 border-green-500 bg-green-500 text-white active text-sm" data-star="5">5æ˜Ÿ</button>
                </div>
                
                <!-- å®¹é”™è®¾ç½®ï¼ˆäº¤é›†æ¨¡å¼æ˜¾ç¤ºï¼Œé»˜è®¤éšè—ï¼‰ -->
                <span id="toleranceLabel" class="text-sm font-semibold text-gray-800 hidden">å®¹é”™è®¾ç½®ï¼š</span>
                <div id="toleranceSelector" class="hidden flex-wrap gap-2">
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="0">0</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="1">1</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="2">2</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="3">3</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="4">4</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="5">5</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="6">6</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="7">7</button>
                  <button class="tolerance-btn px-3 py-1 rounded border-2 border-gray-300 bg-white text-gray-700 text-sm font-medium transition-all hover:border-blue-400" data-tolerance="8">8</button>
              </div>
              </div>
              
              <div class="flex space-x-2">
                <button id="actionBtn" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">æ‹¼æ¥</button>
                <button id="copyBtn" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">å¤åˆ¶</button>
                <button id="verifyBtn" class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors">éªŒè¯</button>
              </div>
            </div>
            
            <div class="bg-white border rounded p-3 min-h-[120px] max-h-[200px] overflow-y-auto text-sm font-mono" id="numberDisplay">
              <div class="text-gray-500 text-center py-8">è¯·å…ˆç”Ÿæˆå·ç </div>
            </div>
            <div id="numberCount" class="text-xs text-gray-500 mt-2">å…± 0 æ³¨</div>
          </div>
           <!-- ä¸‹æ–¹æ·»åŠ åŒºåŸŸ - æ‰€æœ‰æ¨¡å—ç»Ÿä¸€å®¹å™¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="modules-container">
            <!-- å·¦ä¾§å¡ç‰‡ - æ¨¡å—1 (5ç»„ç­›é€‰æ¡ä»¶) -->
        <div id="module1" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- åšå·æ˜Ÿçº§é€‰æ‹©å™¨ -->
          <div class="module-star-selector mb-4 p-3 bg-green-50 rounded border border-green-200">
            <div class="flex items-center space-x-3 mb-3">
              <span class="text-sm font-semibold text-green-800">åšå·æ˜Ÿçº§ï¼š</span>
              <div class="flex space-x-1">
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="2" data-module="1">2æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="3" data-module="1">3æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="4" data-module="1">4æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border-2 border-green-500 bg-green-500 text-white active text-sm" data-star="5" data-module="1">5æ˜Ÿ</button>
              </div>
              <span class="text-sm font-semibold text-green-800 ml-6">æ‹¼æ¥ä½ç½®ï¼š</span>
              <div class="flex gap-1">
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="1" data-module="1">1å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="2" data-module="1">2å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="3" data-module="1">3å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="4" data-module="1">4å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="5" data-module="1">5å</button>
              </div>
            </div>
          </div>
          
          <!-- æ¨¡å—æ€»å®¹é”™è®¾ç½® -->
          <div class="module-tolerance mb-2 p-2 bg-gray-50 rounded border">
            <!-- ç»Ÿä¸€çš„ç­›é€‰æ¡ä»¶å¸ƒå±€ -->
            <div class="flex flex-wrap items-center gap-3 text-sm">
              <!-- æ€»å®¹é”™ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€»å®¹é”™</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
                <span>-</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
              
              <!-- æ€å½¢æ€ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€å½¢æ€</span>
                <!-- ç¬¬1ç»„ï¼šå•åŒé€‰æ‹©å™¨ -->
                <div class="kill-pattern-dropdown" data-module="1" data-type="odd-even">
                  <div class="kill-pattern-trigger">
                    <span class="kill-pattern-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <!-- ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ -->
                    <div class="kill-pattern-row kill-pattern-result-row"></div>
                    <!-- ç¬¬2æ’ï¼šå• -->
                    <div class="kill-pattern-row kill-pattern-odd-row"></div>
                    <!-- ç¬¬3æ’ï¼šåŒ -->
                    <div class="kill-pattern-row kill-pattern-even-row"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn" data-module="1" data-type="odd-even">æ¸…</button>
                
                <!-- ç¬¬2ç»„ï¼šå¤§å°é€‰æ‹©å™¨ -->
                <div class="kill-pattern-dropdown" data-module="1" data-type="big-small">
                  <div class="kill-pattern-trigger">
                    <span class="kill-pattern-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <!-- ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ -->
                    <div class="kill-pattern-row kill-pattern-result-row"></div>
                    <!-- ç¬¬2æ’ï¼šå¤§ -->
                    <div class="kill-pattern-row kill-pattern-big-row"></div>
                    <!-- ç¬¬3æ’ï¼šå° -->
                    <div class="kill-pattern-row kill-pattern-small-row"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn" data-module="1" data-type="big-small">æ¸…</button>
              </div>
              
              <!-- æ€è·¨åº¦ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€è·¨åº¦</span>
                <div class="kill-extra-dropdown inline-block" data-module="1" data-type="span">
                  <div class="kill-pattern-trigger">
                    <span class="kill-extra-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <div class="kill-extra-options"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn kill-extra-clear-btn" data-module="1" data-type="span">æ¸…</button>
              </div>

              <!-- æ€å’Œå°¾ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€å’Œå°¾</span>
                <div class="kill-extra-dropdown inline-block" data-module="1" data-type="sumtail">
                  <div class="kill-pattern-trigger">
                    <span class="kill-extra-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <div class="kill-extra-options"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn kill-extra-clear-btn" data-module="1" data-type="sumtail">æ¸…</button>
              </div>
            </div>
          </div>
          
          <!-- ç¬¬1ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶1å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶1å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="1">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="1">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="1">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="1">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="1">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="1">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬2ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶2å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶2å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="2">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="2">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="2">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="2">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="2">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="2">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬3ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶3å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶3å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="3">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="3">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="3">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="3">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="3">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="3">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬4ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶4å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶4å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="4">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="4">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="4">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="4">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="4">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="4">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬5ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2">
            <!-- æ¡ä»¶5å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶5å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="5">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="5">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="5">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="5">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="5">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="5">5èƒ†</button>
            </div>
          </div>
          
          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="mb-2 flex gap-2">
            <textarea placeholder="è¾“å…¥ç»“æœ" class="result-input flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="1" rows="3"></textarea>
            <div class="flex flex-col gap-1">
              <button class="clear-btn px-3 py-1 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-sm rounded" data-module="1">æ¸…</button>
              <button class="reverse-btn px-3 py-1 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-sm rounded" data-module="1">å</button>
            </div>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="1">å…±0æ³¨</div>
          
          <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">åšå·</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">å¤åˆ¶</button>
            <button class="verify-btn flex-1 bg-orange-600 text-white py-2 rounded hover:bg-orange-700" data-module="1">éªŒè¯</button>
            <button onclick="addModule(1)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="1">+</button>
            <button onclick="removeModule(1)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="1">-</button>
          </div>
        </div>
            
            <!-- å³ä¾§å¡ç‰‡ - æ¨¡å—2 (ç»“æ„ä¸æ¨¡å—1ç›¸åŒï¼Œdata-module="2") -->
        <div id="module2" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- åšå·æ˜Ÿçº§é€‰æ‹©å™¨ -->
          <div class="module-star-selector mb-4 p-3 bg-green-50 rounded border border-green-200">
            <div class="flex items-center space-x-3 mb-3">
              <span class="text-sm font-semibold text-green-800">åšå·æ˜Ÿçº§ï¼š</span>
              <div class="flex space-x-1">
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="2" data-module="2">2æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="3" data-module="2">3æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border border-gray-200 text-gray-600 hover:bg-green-100 transition-colors text-sm" data-star="4" data-module="2">4æ˜Ÿ</button>
                <button class="module-star-btn px-3 py-1 rounded border-2 border-green-500 bg-green-500 text-white active text-sm" data-star="5" data-module="2">5æ˜Ÿ</button>
              </div>
              <span class="text-sm font-semibold text-green-800 ml-6">æ‹¼æ¥ä½ç½®ï¼š</span>
              <div class="flex gap-1">
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="1" data-module="2">1å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="2" data-module="2">2å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="3" data-module="2">3å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="4" data-module="2">4å</button>
                <button class="position-btn px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-100" data-position="5" data-module="2">5å</button>
              </div>
            </div>
          </div>
          
          <!-- æ¨¡å—æ€»å®¹é”™è®¾ç½® -->
          <div class="module-tolerance mb-2 p-2 bg-gray-50 rounded border">
            <!-- ç»Ÿä¸€çš„ç­›é€‰æ¡ä»¶å¸ƒå±€ -->
            <div class="flex flex-wrap items-center gap-3 text-sm">
              <!-- æ€»å®¹é”™ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€»å®¹é”™</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
                <span>-</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
              
              <!-- æ€å½¢æ€ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€å½¢æ€</span>
                <!-- ç¬¬1ç»„ï¼šå•åŒé€‰æ‹©å™¨ -->
                <div class="kill-pattern-dropdown" data-module="2" data-type="odd-even">
                  <div class="kill-pattern-trigger">
                    <span class="kill-pattern-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <!-- ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ -->
                    <div class="kill-pattern-row kill-pattern-result-row"></div>
                    <!-- ç¬¬2æ’ï¼šå• -->
                    <div class="kill-pattern-row kill-pattern-odd-row"></div>
                    <!-- ç¬¬3æ’ï¼šåŒ -->
                    <div class="kill-pattern-row kill-pattern-even-row"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn" data-module="2" data-type="odd-even">æ¸…</button>
                
                <!-- ç¬¬2ç»„ï¼šå¤§å°é€‰æ‹©å™¨ -->
                <div class="kill-pattern-dropdown" data-module="2" data-type="big-small">
                  <div class="kill-pattern-trigger">
                    <span class="kill-pattern-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <!-- ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ -->
                    <div class="kill-pattern-row kill-pattern-result-row"></div>
                    <!-- ç¬¬2æ’ï¼šå¤§ -->
                    <div class="kill-pattern-row kill-pattern-big-row"></div>
                    <!-- ç¬¬3æ’ï¼šå° -->
                    <div class="kill-pattern-row kill-pattern-small-row"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn" data-module="2" data-type="big-small">æ¸…</button>
              </div>
              
              <!-- æ€è·¨åº¦ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€è·¨åº¦</span>
                <div class="kill-extra-dropdown inline-block" data-module="2" data-type="span">
                  <div class="kill-pattern-trigger">
                    <span class="kill-extra-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <div class="kill-extra-options"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn kill-extra-clear-btn" data-module="2" data-type="span">æ¸…</button>
              </div>

              <!-- æ€å’Œå°¾ -->
              <div class="flex items-center gap-2">
                <span class="text-gray-700 font-medium">æ€å’Œå°¾</span>
                <div class="kill-extra-dropdown inline-block" data-module="2" data-type="sumtail">
                  <div class="kill-pattern-trigger">
                    <span class="kill-extra-display"></span>
                    <span>â–¼</span>
                  </div>
                  <div class="kill-pattern-menu">
                    <div class="kill-extra-options"></div>
                  </div>
                </div>
                <button class="kill-pattern-clear-btn kill-extra-clear-btn" data-module="2" data-type="sumtail">æ¸…</button>
              </div>
            </div>
          </div>
          
          <!-- ç¬¬1ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶1å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶1å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="1">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="1">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="1">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="1">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="1">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="1">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬2ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶2å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶2å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="2">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="2">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="2">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="2">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="2">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="2">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬3ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶3å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶3å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="3">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="3">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="3">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="3">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="3">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="3">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬4ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- æ¡ä»¶4å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶4å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="4">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="4">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="4">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="4">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="4">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="4">5èƒ†</button>
            </div>
          </div>
          
          <!-- ç¬¬5ç»„ç­›é€‰æ¡ä»¶ -->
          <div class="filter-group mb-2 pb-0">
            <!-- æ¡ä»¶5å®¹é”™é€‰æ‹©å™¨ -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">æ¡ä»¶5å®¹é”™</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">è‡³</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="5">0èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="5">1èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="5">2èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="5">3èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="5">4èƒ†</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="5">5èƒ†</button>
            </div>
          </div>
          
          <!-- module2 è¾“å…¥åŒºåŸŸå’Œæ“ä½œæŒ‰é’®åŒºåŸŸä¸module1ç›¸åŒ -->
          <div class="mb-2 flex gap-2">
            <textarea placeholder="è¾“å…¥ç»“æœ" class="result-input flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="2" rows="3"></textarea>
            <div class="flex flex-col gap-1">
              <button class="clear-btn px-3 py-1 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-sm rounded" data-module="2">æ¸…</button>
              <button class="reverse-btn px-3 py-1 border border-gray-300 bg-gray-100 hover:bg-gray-200 text-sm rounded" data-module="2">å</button>
            </div>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="2">å…±0æ³¨</div>
          
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">åšå·</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">å¤åˆ¶</button>
            <button class="verify-btn flex-1 bg-orange-600 text-white py-2 rounded hover:bg-orange-700" data-module="2">éªŒè¯</button>
            <button onclick="addModule(2)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="2">+</button>
            <button onclick="removeModule(2)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="2">-</button>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é»„é‡‘åˆ†å‰²é¡µé¢ -->
    <div id="goldenRatioPage" class="hidden">
      <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <!-- åˆ‡å‰²æ¨¡å¼é€‰æ‹© -->
          <div class="mb-6">
            <div class="flex justify-center gap-3 mb-4">
              <button 
                id="modeUniformBtn" 
                class="px-6 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600 transition-colors active-mode"
                data-mode="uniform"
              >å‡åŒ€</button>
              <button 
                id="modeStableBtn" 
                class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-md hover:bg-gray-400 transition-colors"
                data-mode="stable"
              >ç¨³å®š</button>
            </div>
            <div class="text-center text-sm text-gray-600 mb-4">
              <span id="modeDescription">å‡åŒ€æ¨¡å¼ï¼šä¸€æ¬¡æ€§åˆ†å®Œå°±ç”¨ï¼Œä¸ä¿æŒå†å²åˆ†ç»„</span>
            </div>
          </div>
          
          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="mb-6">
            <label for="goldenInputData" class="block text-sm font-medium text-gray-700 mb-2">è¯·è¾“å…¥æ•°æ® <span id="goldenInputCount" class="text-red-500 text-sm font-medium hidden">å…± 0 é¡¹</span></label>
            <textarea 
              id="goldenInputData" 
              rows="6" 
              placeholder="ç¤ºä¾‹ï¼š01,02,03,04,05,06,07,08,09,10" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none overflow-auto whitespace-pre-wrap"
            ></textarea>
          </div>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <div class="flex justify-center gap-3 mb-6">
            <button 
              id="goldenSplitBtn" 
              class="px-6 py-2 bg-primary text-white font-medium rounded-md hover:bg-primary/80 transition-colors"
            >å¼€å§‹åˆ†å‰²</button>
            <button 
              id="goldenPasteBtn" 
              class="px-6 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600 transition-colors"
            >ç²˜è´´æ•°æ®</button>
            <button 
              id="goldenClearBtn" 
              class="px-6 py-2 bg-gray-500 text-white font-medium rounded-md hover:bg-gray-600 transition-colors"
            >æ¸…ç©º</button>
          </div>
          
          <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-800">åˆ†å‰²ç»“æœ</h3>
              <div class="text-sm text-gray-500" id="resultSummary"></div>
            </div>
            
            <!-- 5ä¸ªç´§å‡‘æ’åˆ—çš„æ¡† -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
              <div id="goldenResults" class="col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                <!-- 5ä¸ªåˆ†ç»„ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>
          
          <!-- éªŒè¯ç»“æœæ˜¾ç¤º -->
          <div id="validationResults" class="mt-6 p-4 bg-gray-50 rounded-md hidden">
            <h3 class="text-lg font-semibold mb-2">5in4éªŒè¯ç»“æœ</h3>
            <div id="validationContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- äº¤é›†æ‹¼æ¥é¡µé¢ -->
    <div id="intersectionCutPage" class="hidden">
      <div class="container mx-auto px-4 py-6 max-w-6xl">




        <!-- å·ç äº¤é›†åŠŸèƒ½åŒºåŸŸ -->
        <div id="intersectionContent" class="intersection-content">
          <!-- å®¹é”™åŠŸèƒ½åŒºåŸŸ -->
          <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <h3 class="text-lg font-medium text-gray-800 mb-3">å®¹é”™è®¾ç½®</h3>
            <div class="flex flex-wrap gap-2">
              <button class="tolerance-btn" data-tolerance="1">1</button>
              <button class="tolerance-btn" data-tolerance="2">2</button>
              <button class="tolerance-btn" data-tolerance="3">3</button>
              <button class="tolerance-btn" data-tolerance="4">4</button>
              <button class="tolerance-btn" data-tolerance="5">5</button>
              <button class="tolerance-btn" data-tolerance="6">6</button>
              <button class="tolerance-btn" data-tolerance="7">7</button>
              <button class="tolerance-btn" data-tolerance="8">8</button>
            </div>
          </div>

          <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
          <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <h3 class="text-lg font-medium text-gray-800 mb-3">ç»“æœæ˜¾ç¤º</h3>
            <div class="flex gap-3 items-start">
              <div class="flex-1">
                <textarea id="resultDisplay" rows="4" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                  placeholder="äº¤é›†ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
              </div>
              <div class="flex flex-col gap-2">
                <button id="generateIntersectionBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors font-medium">
                  åšå·
                </button>
                <button id="copyResultBtn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors font-medium">
                  å¤åˆ¶
                </button>
              </div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
              <span id="resultCount">å…±0æ³¨</span>
            </div>
          </div>

          <!-- è¾“å…¥æ¨¡å—åŒºåŸŸ -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <h3 class="text-lg font-medium text-gray-800 mb-3">è¾“å…¥æ¨¡å—</h3>
            
            <!-- 8ä¸ªè¾“å…¥æ¨¡å—çš„å¯æ»šåŠ¨å®¹å™¨ -->
            <div class="modules-container max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4">
              <div class="modules-grid grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- æ¨¡å—1 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—1</h4>
                      <span class="module-count" data-module="1">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="1">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="1">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="1"></textarea>
                </div>

                <!-- æ¨¡å—2 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—2</h4>
                      <span class="module-count" data-module="2">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="2">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="2">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="2"></textarea>
                </div>

                <!-- æ¨¡å—3 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—3</h4>
                      <span class="module-count" data-module="3">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="3">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="3">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="3"></textarea>
                </div>

                <!-- æ¨¡å—4 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—4</h4>
                      <span class="module-count" data-module="4">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="4">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="4">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="4"></textarea>
                </div>

                <!-- æ¨¡å—5 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—5</h4>
                      <span class="module-count" data-module="5">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="5">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="5">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="5"></textarea>
                </div>

                <!-- æ¨¡å—6 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—6</h4>
                      <span class="module-count" data-module="6">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="6">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="6">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="6"></textarea>
                </div>

                <!-- æ¨¡å—7 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—7</h4>
                      <span class="module-count" data-module="7">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="7">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="7">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="7"></textarea>
                </div>

                <!-- æ¨¡å—8 -->
                <div class="input-module">
                  <div class="module-header">
                    <div class="module-info">
                      <h4 class="module-title">æ¨¡å—8</h4>
                      <span class="module-count" data-module="8">0æ³¨</span>
                    </div>
                    <div class="module-actions">
                      <button class="module-btn paste-btn" data-module="8">
                        ç²˜è´´
                      </button>
                      <button class="module-btn clear-btn" data-module="8">
                        æ¸…é™¤
                      </button>
                    </div>
                  </div>
                  <textarea class="module-textarea" 
                    rows="3" placeholder="è¯·è¾“å…¥å¤šç»„å·ç ï¼Œæ¯è¡Œä¸€ç»„ï¼Œå¦‚ï¼š01,02,03" data-module="8"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>

    <!-- éªŒè¯è®¡åˆ’é¡µé¢ -->
    <div id="verifyPlanPage" class="hidden">
      <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">éªŒè¯è®¡åˆ’</h2>
          

          
          <!-- éªŒè¯æ¨¡å¼åˆ‡æ¢æŒ‰é’®ç»„ -->
          <div class="mb-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <span class="text-sm font-medium text-gray-700">éªŒè¯æ¨¡å¼:</span>
                <div class="flex bg-white rounded-lg border border-gray-300 overflow-hidden">
                  <button id="multiPeriodModeBtn" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium transition-colors hover:bg-gray-200">
                    å¤šæœŸéªŒè¯
                  </button>
                  <button id="singlePeriodModeBtn" class="px-4 py-2 bg-blue-500 text-white text-sm font-medium transition-colors hover:bg-blue-600">
                              å•æœŸéªŒè¯
                  </button>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button id="pasteAndVerifyBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                  ç²˜è´´å¹¶éªŒè¯
                </button>
                <div class="text-sm text-gray-500">
                  <span id="verifyDataCount">å…± 0 æ¡è®°å½•</span>
                </div>
              </div>
            </div>
          </div>

          <!-- è®¡åˆ’éªŒè¯å†å²ç®¡ç† -->
          <div id="planHistoryControls" class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200" style="display: none;">
            <div class="flex flex-wrap items-center gap-4 justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-blue-700">è®¡åˆ’éªŒè¯å†å²:</span>
                <span id="historyCount" class="text-sm text-blue-600">å·²ä¿å­˜ 0 æ¡è®°å½•</span>
              </div>
              <div class="flex items-center gap-2">
                <button id="exportHistoryBtn" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors">
                  å¯¼å‡ºå†å²
                </button>
                <button id="importHistoryBtn" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                  å¯¼å…¥å†å²
                </button>
                <button id="clearHistoryBtn" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors">
                  æ¸…ç©ºå†å²
                </button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
              </div>
            </div>
          </div>

          <!-- æœŸæ•°é€‰æ‹©æ§ä»¶ -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex flex-wrap items-center gap-4 justify-between">
              <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm font-medium text-gray-700">æ˜¾ç¤ºæœŸæ•°:</span>
                <div class="flex gap-2">
                  <button id="periods15Btn" class="periods-btn px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors" data-periods="15" onclick="selectPeriods(15)">
                    15æœŸ
                  </button>
                  <button id="periods30Btn" class="periods-btn px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400 transition-colors" data-periods="30" onclick="selectPeriods(30)">
                    30æœŸ
                  </button>
                  <button id="periods50Btn" class="periods-btn px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400 transition-colors" data-periods="50" onclick="selectPeriods(50)">
                    50æœŸ
                  </button>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-600">è‡ªå®šä¹‰:</span>
                  <input type="number" id="customPeriodsInput" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" max="200" placeholder="æœŸæ•°">
                  <button id="customPeriodsBtn" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors" onclick="setCustomPeriods()">
                    ç¡®å®š
                  </button>
                </div>
              </div>
              <div class="text-sm text-gray-500" id="verifyLastUpdate">
                æœ€åæ›´æ–°: --
              </div>
            </div>
          </div>

          <!-- éªŒè¯è®¡åˆ’è¡¨æ ¼ -->
          <div class="overflow-x-auto">
            <!-- å¤šæœŸéªŒè¯æ¨¡å¼è¡¨æ ¼ -->
            <div id="multiPeriodTable" class="table-container hidden" style="max-height: 600px; overflow-y: auto; border: 1px solid #e5e7eb;">
              <table id="verifyPlanTable" class="w-full border-collapse">
                <thead>
                  <!-- è¡¨å¤´å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </thead>
                <tbody id="verifyPlanTableBody">
                  <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                  <tr>
                    <td colspan="100" class="py-4 text-center text-gray-500">
                      æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- ä¸‹ä¸€æœŸéªŒè¯æ¨¡å¼è¡¨æ ¼ -->
            <div id="singlePeriodTable" class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #e5e7eb;">
              <table id="singlePeriodVerifyTable" class="w-full border-collapse">
                <thead id="singlePeriodTableHead">
                  <tr class="bg-gray-50">
                    <th class="border border-gray-300 px-2 py-2 text-center text-sm font-medium text-gray-700" style="width: 130px;">æœŸå·</th>
                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700" style="width: 260px;">å¼€å¥–å·ç </th>
                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700" style="width: 104px;">æ³¨æ•°</th>
                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700" style="width: 80px;">çŠ¶æ€</th>
                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700">è®¡åˆ’è§„åˆ™</th>
                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium text-gray-700" style="width: 104px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="singlePeriodTableBody">
                  <tr>
                    <td colspan="6" class="py-4 text-center text-gray-500">
                      æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>



        </div>
      </div>
    </div>

  </main>

  <!-- é¡µè„š -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>å°æ¹¾PKæ•°æ®åˆ†æå·¥å…· Â© 2025ï¼Œè”ç³»âœˆï¸@suibian925 | <span style="color: #3b82f6; font-weight: bold;">v1.0.0.30</span></p>
    </div>
  </footer>



  <!-- å¯†é’¥éªŒè¯æ¨¡æ€æ¡† -->
  <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center" style="z-index: 9999;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">è¯·è¾“å…¥è®¿é—®å¯†é’¥</h3>
        <p class="text-gray-600">è¯¥åŠŸèƒ½éœ€è¦æœ‰æ•ˆçš„è®¿é—®å¯†é’¥æ‰èƒ½ä½¿ç”¨</p>
      </div>
      
      <div class="mb-4">
        <input type="text" id="keyInput" placeholder="è¯·è¾“å…¥32ä½è®¿é—®å¯†é’¥" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
      </div>
      
      <div class="flex gap-3">
        <button id="verifyKeyBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md font-medium hover:bg-primary/80 transition-colors">éªŒè¯å¯†é’¥</button>
        <!-- ç§»é™¤å–æ¶ˆæŒ‰é’® -->
      </div>
    </div>
  </div>

  

<script>
// å…¨å±€æ¨¡å—çŠ¶æ€å­˜å‚¨
window.moduleStates = {};

// æ·»åŠ æ¨¡å—åŠŸèƒ½
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // æ£€æŸ¥æ¨¡å—æ•°é‡ä¸Šé™ï¼ˆæœ€å¤š14ä¸ªï¼‰
  if (moduleElements.length >= 14) {
    alert('æœ€å¤šåªèƒ½æ·»åŠ 14ä¸ªæ¨¡å—');
    return;
  }

  // è·å–æœ€åä¸€ä¸ªæ¨¡å—IDå¹¶é€’å¢
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // å…‹éš†å½“å‰æ¨¡å—
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // å…‹éš†å½“å‰æ¨¡å—åæ·»åŠ ä»¥ä¸‹ä»£ç 
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // ç›´æ¥æ·»åŠ åˆ°æ¨¡å—å®¹å™¨æœ«å°¾
  modulesContainer.appendChild(newModule);

  // åˆå§‹åŒ–æ–°æ¨¡å—
  initFiveStarModule(newModuleId);
}

// ç§»é™¤å•ä¸ªæ¨¡å— - ç¡®ä¿æœ€å°‘ä¿ç•™2ä¸ª
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);

  // ç¡®ä¿è‡³å°‘ä¿ç•™2ä¸ªæ¨¡å—
  if (moduleElements.length <= 2) {
    alert('è‡³å°‘ä¿ç•™2ä¸ªæ¨¡å—');
    return;
  }

  // ç§»é™¤æ¨¡å—
  moduleToRemove.remove();
}

// é‡ç½®æ¨¡å—çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
function resetModuleState(module) {
  // æ¸…é™¤å…‹éš†æ¨¡å—çš„é€‰ä¸­çŠ¶æ€å’Œç»“æœ
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = 'å…±0æ³¨';
}

// ç”Ÿæˆæ’åˆ—ç»„åˆçš„å‡½æ•° - è¿­ä»£ç‰ˆæœ¬é¿å…æ ˆæº¢å‡º
function permute(arr, k) {
  if (k === 0) return [[]];
  if (k === 1) return arr.map(x => [x]);
  
  const result = [];
  const stack = [{ current: [], remaining: arr, depth: 0 }];
  
  while (stack.length > 0) {
    const { current, remaining, depth } = stack.pop();
    
    if (depth === k) {
      result.push([...current]);
      continue;
    }
    
    for (let i = 0; i < remaining.length; i++) {
      const newCurrent = [...current, remaining[i]];
      const newRemaining = remaining.slice(0, i).concat(remaining.slice(i + 1));
      stack.push({ current: newCurrent, remaining: newRemaining, depth: depth + 1 });
    }
  }
  
  return result;
}

// ç”Ÿæˆæ•°ç»„çš„æ‰€æœ‰æ’åˆ—
function generatePermutations(arr) {
  if (arr.length <= 1) return [arr];
  
  const result = [];
  for (let i = 0; i < arr.length; i++) {
    const current = arr[i];
    const remaining = arr.slice(0, i).concat(arr.slice(i + 1));
    const perms = generatePermutations(remaining);
    
    for (const perm of perms) {
      result.push([current, ...perm]);
    }
  }
  
  return result;
}

// ç”ŸæˆæŒ‡å®šé•¿åº¦çš„æ’åˆ—
function generatePermutationsWithLength(arr, length) {
  if (length === 0) return [[]];
  if (length > arr.length) return [];
  if (length === 1) return arr.map(item => [item]);
  
  const result = [];
  for (let i = 0; i < arr.length; i++) {
    const current = arr[i];
    const remaining = arr.slice(0, i).concat(arr.slice(i + 1));
    const perms = generatePermutationsWithLength(remaining, length - 1);
    
    for (const perm of perms) {
      result.push([current, ...perm]);
    }
  }
  
  return result;
}

// åˆå§‹åŒ–äº”æ˜Ÿæ¨¡å—
function initFiveStarModule(moduleId) {
  // é˜²æ­¢é‡å¤åˆå§‹åŒ–
  if (window.moduleStates && window.moduleStates[moduleId]) {
    console.log(`æ¨¡å—${moduleId}å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–`);
    return;
  }
  
  // ç¡®ä¿å…¨å±€çŠ¶æ€å¯¹è±¡å­˜åœ¨
  if (!window.moduleStates) {
    window.moduleStates = {};
  }
  
  // æ¨¡å—çŠ¶æ€å­˜å‚¨ - ä¿®æ”¹ä¸ºæŒ‰ç»„å­˜å‚¨æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶ç»„æœ‰ç‹¬ç«‹çš„å®¹é”™è®¾ç½®
  const moduleState = window.moduleStates[moduleId] = {
    groups: [
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // ç»„1
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // ç»„2
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // ç»„3
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // ç»„4
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }  // ç»„5
    ],
    // æ¨¡å—æ€»å®¹é”™è®¾ç½®
    moduleToleranceMin: 0,  // å…è®¸æœ€å°‘å¤šå°‘ä¸ªæ¡ä»¶ä¸æˆç«‹
    moduleToleranceMax: 0,  // å…è®¸æœ€å¤šå¤šå°‘ä¸ªæ¡ä»¶ä¸æˆç«‹
    starLevel: 5,        // å½“å‰é€‰æ‹©çš„æ˜Ÿçº§ï¼Œé»˜è®¤5æ˜Ÿ
    selectedPositions: [], // é€‰ä¸­çš„ä½ç½®ï¼ˆ1å-5åï¼‰
    results: [],         // å½“å‰æ˜¾ç¤ºç»“æœ
    allPermutations: [], // æ‰€æœ‰æ’åˆ—ç»„åˆ
    originalResults: [], // åŸå§‹ç­›é€‰ç»“æœ
    isReversed: false,   // æ˜¯å¦æ˜¾ç¤ºåå‘ç»“æœ
    // æ€å½¢æ€è®¾ç½®
    killPatterns: {
      oddEven: [],      // å•åŒæ€å½¢æ€ï¼Œä¾‹å¦‚ï¼š['å•', '', 'åŒ', '', ''] è¡¨ç¤º1åæ€å•ï¼Œ3åæ€åŒ
      bigSmall: []      // å¤§å°æ€å½¢æ€ï¼Œä¾‹å¦‚ï¼š['å¤§', '', '', 'å°', ''] è¡¨ç¤º1åæ€å¤§ï¼Œ4åæ€å°
    },
    // é¢å¤–ç­›é€‰ï¼šæ€è·¨åº¦ã€æ€å’Œå°¾
    killSpanValues: [],     // é€‰æ‹©çš„è·¨åº¦å€¼ï¼ˆ1-9ï¼‰
    killSumTailValues: []   // é€‰æ‹©çš„å’Œå°¾å€¼ï¼ˆ0-9ï¼‰
  };

  // è·å–æ¨¡å—å…ƒç´ 
  const module = document.getElementById(`module${moduleId}`);
  const numberButtons = module.querySelectorAll('.number-btn');
  const damaButtons = module.querySelectorAll('.dama-btn');
  const generateBtn = module.querySelector('.generate-btn');
  const copyBtn = module.querySelector('.copy-btn');
  const verifyBtn = module.querySelector('.verify-btn');
  const clearBtn = module.querySelector('.clear-btn');
  const reverseBtn = module.querySelector('.reverse-btn');
  const resultInput = module.querySelector('.result-input');
  const resultCount = module.querySelector('.result-count');
  const conditionToleranceMinSelects = module.querySelectorAll('.condition-tolerance-min');
  const conditionToleranceMaxSelects = module.querySelectorAll('.condition-tolerance-max');
  const moduleToleranceMinSelect = module.querySelector('.module-tolerance-min');
  const moduleToleranceMaxSelect = module.querySelector('.module-tolerance-max');
  const moduleStarButtons = module.querySelectorAll('.module-star-btn');
  const moduleStarDescription = module.querySelector(`#moduleStarDescription${moduleId}`);
  const killSpanSelect = module.querySelector('.kill-span-select');
  const killSumTailSelect = module.querySelector('.kill-sumtail-select');

  // ç»‘å®šæ€è·¨åº¦ã€æ€å’Œå°¾å¤šé€‰å˜æ›´äº‹ä»¶
  function getMultiSelectValues(selectEl) {
    if (!selectEl) return [];
    return Array.from(selectEl.selectedOptions).map(o => parseInt(o.value));
  }
  if (killSpanSelect) {
    killSpanSelect.addEventListener('change', () => {
      moduleState.killSpanValues = getMultiSelectValues(killSpanSelect);
    });
  }
  if (killSumTailSelect) {
    killSumTailSelect.addEventListener('change', () => {
      moduleState.killSumTailValues = getMultiSelectValues(killSumTailSelect);
    });
  }

  // åšå·æ˜Ÿçº§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  moduleStarButtons.forEach(button => {
    button.addEventListener('click', function() {
      const selectedStar = parseInt(this.dataset.star);
      
      // æ›´æ–°å½“å‰æ¨¡å—å†…æ‰€æœ‰æ˜Ÿçº§æŒ‰é’®çš„æ ·å¼
      moduleStarButtons.forEach(btn => {
        btn.classList.remove('bg-green-500', 'text-white', 'active', 'border-green-500');
        btn.classList.add('border-gray-200', 'text-gray-600');
      });
      
      // è®¾ç½®å½“å‰é€‰ä¸­æŒ‰é’®çš„æ ·å¼
      this.classList.remove('border-gray-200', 'text-gray-600');
      this.classList.add('bg-green-500', 'text-white', 'active', 'border-green-500');
      
      // æ›´æ–°æ¨¡å—çŠ¶æ€
      moduleState.starLevel = selectedStar;
      
      // æ›´æ–°æ˜Ÿçº§æè¿°
      if (moduleStarDescription) {
        moduleStarDescription.textContent = `å½“å‰ï¼š${selectedStar}æ˜Ÿ - ä»10ä¸ªå·ç ä¸­é€‰æ‹©${selectedStar}ä¸ªå·ç ç»„æˆä¸€æ³¨`;
      }
      
      console.log(`æ¨¡å—${moduleId}æ˜Ÿçº§å·²åˆ‡æ¢åˆ°: ${selectedStar}æ˜Ÿ`);
    });
  });

  // æ•°å­—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  numberButtons.forEach(button => {
      button.addEventListener('click', function() {
          const number = parseInt(this.dataset.number);
          const groupIndex = parseInt(this.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedNumbers.indexOf(number);
          
          if (index === -1) {
              groupState.selectedNumbers.push(number);
              this.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedNumbers.splice(index, 1);
              this.classList.remove('bg-primary', 'text-white');
          }
      });
  });

  // å‘½ä¸­æ•°å­—æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²åœ¨DOMContentLoadedä¸­ç»Ÿä¸€å¤„ç†

  // èƒ†ç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  damaButtons.forEach(button => {
      // å¤„ç†èƒ†ç æŒ‰é’®çŠ¶æ€åˆ‡æ¢çš„å‡½æ•°
      function toggleDamaButton() {
          const dama = parseInt(button.dataset.dama);
          const groupIndex = parseInt(button.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedDamas.indexOf(dama);
          
          if (index === -1) {
              groupState.selectedDamas.push(dama);
              button.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedDamas.splice(index, 1);
              button.classList.remove('bg-primary', 'text-white');
          }
      }
      
      // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†å˜é‡
      let touchStartTime = 0;
      let touchMoved = false;
      let touchHandled = false;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨éè§¦æ‘¸è®¾å¤‡ä¸Šç”Ÿæ•ˆï¼‰
      button.addEventListener('click', function(e) {
          // å¦‚æœè§¦æ‘¸äº‹ä»¶å·²å¤„ç†ï¼Œåˆ™è·³è¿‡clickäº‹ä»¶
          if (touchHandled) {
              touchHandled = false;
              return;
          }
          toggleDamaButton();
      });
      
      // æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†
      button.addEventListener('touchstart', function(e) {
          touchStartTime = Date.now();
          touchMoved = false;
          touchHandled = false;
          // æ·»åŠ è§¦æ‘¸å¼€å§‹çš„è§†è§‰åé¦ˆ
          this.style.opacity = '0.7';
      }, { passive: true });
      
      button.addEventListener('touchmove', function(e) {
          touchMoved = true;
          // ç§»é™¤è§†è§‰åé¦ˆ
          this.style.opacity = '';
      }, { passive: true });
      
      button.addEventListener('touchend', function(e) {
          const touchDuration = Date.now() - touchStartTime;
          // æ¢å¤è§†è§‰åé¦ˆ
          this.style.opacity = '';
          
          // å¦‚æœæ˜¯å¿«é€Ÿç‚¹å‡»ä¸”æ²¡æœ‰ç§»åŠ¨ï¼Œåˆ™è§¦å‘çŠ¶æ€åˆ‡æ¢
          if (!touchMoved && touchDuration < 500) {
              touchHandled = true;
              toggleDamaButton();
              // å»¶è¿Ÿé‡ç½®æ ‡å¿—ï¼Œç¡®ä¿clickäº‹ä»¶è¢«è·³è¿‡
              setTimeout(() => {
                  touchHandled = false;
              }, 100);
          }
      }, { passive: true });
      
      button.addEventListener('touchcancel', function(e) {
           // æ¢å¤è§†è§‰åé¦ˆ
           this.style.opacity = '';
       }, { passive: true });
   });

  // æ¡ä»¶å®¹é”™é€‰æ‹©äº‹ä»¶
  conditionToleranceMinSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMin = parseInt(this.value);
    });
  });

  conditionToleranceMaxSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMax = parseInt(this.value);
    });
  });

  // æ¨¡å—æ€»å®¹é”™é€‰æ‹©äº‹ä»¶
  if (moduleToleranceMinSelect) {
    moduleToleranceMinSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMin = parseInt(this.value);
    });
  }

  if (moduleToleranceMaxSelect) {
    moduleToleranceMaxSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMax = parseInt(this.value);
    });
  }

  // ============ æ€å½¢æ€åŠŸèƒ½åˆå§‹åŒ– ============
  
  // åˆå§‹åŒ–æ€å½¢æ€ä¸‹æ‹‰æ¡†
  function initKillPatternDropdowns() {
    const starLevel = moduleState.starLevel || 5;
    
    // åˆå§‹åŒ–æ€å½¢æ€æ•°ç»„
    moduleState.killPatterns.oddEven = new Array(starLevel).fill('');
    moduleState.killPatterns.bigSmall = new Array(starLevel).fill('');
    
    // åˆå§‹åŒ–å•åŒé€‰æ‹©å™¨
    const oddEvenDropdown = module.querySelector('.kill-pattern-dropdown[data-type="odd-even"]');
    if (oddEvenDropdown) {
      const menu = oddEvenDropdown.querySelector('.kill-pattern-menu');
      const resultRow = menu.querySelector('.kill-pattern-result-row');
      const oddRow = menu.querySelector('.kill-pattern-odd-row');
      const evenRow = menu.querySelector('.kill-pattern-even-row');
      const trigger = oddEvenDropdown.querySelector('.kill-pattern-trigger .kill-pattern-display');
      
      // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆ
      resultRow.innerHTML = '';
      oddRow.innerHTML = '';
      evenRow.innerHTML = '';
      
      for (let i = 0; i < starLevel; i++) {
        // ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ
        const resultCell = document.createElement('div');
        resultCell.className = 'kill-pattern-cell';
        resultCell.dataset.position = i;
        // æœªé€‰æ‹©ä½ç½®æ˜¾ç¤º '-' å ä½
        resultCell.textContent = '-';
        resultRow.appendChild(resultCell);
        
        // ç¬¬2æ’ï¼šå•
        const oddBtn = document.createElement('button');
        oddBtn.className = 'kill-pattern-btn';
        oddBtn.textContent = 'å•';
        oddBtn.dataset.position = i;
        oddBtn.dataset.value = 'å•';
        oddBtn.addEventListener('click', () => handleKillPatternClick(moduleId, 'oddEven', i, 'å•', oddBtn));
        oddRow.appendChild(oddBtn);
        
        // ç¬¬3æ’ï¼šåŒ
        const evenBtn = document.createElement('button');
        evenBtn.className = 'kill-pattern-btn';
        evenBtn.textContent = 'åŒ';
        evenBtn.dataset.position = i;
        evenBtn.dataset.value = 'åŒ';
        evenBtn.addEventListener('click', () => handleKillPatternClick(moduleId, 'oddEven', i, 'åŒ', evenBtn));
        evenRow.appendChild(evenBtn);
      }

      // åˆå§‹åŒ–è§¦å‘å™¨æ˜¾ç¤ºï¼ˆæ ¹æ®å½“å‰å½¢æ€çŠ¶æ€æ¸²æŸ“ä¸º é€—å·åˆ†éš”ï¼Œæœªé€‰ä¸º '-'ï¼‰
      updateKillPatternDisplay(moduleId, 'oddEven');
      // ç¡®ä¿æ¸…é™¤ä»»ä½•æ®‹ç•™çš„é€‰ä¸­æ ·å¼
      menu.querySelectorAll('.kill-pattern-btn.active').forEach(btn => btn.classList.remove('active'));
      // å…³é—­å·²å±•å¼€çš„èœå•
      menu.classList.remove('active');
    }
    
    // åˆå§‹åŒ–å¤§å°é€‰æ‹©å™¨
    const bigSmallDropdown = module.querySelector('.kill-pattern-dropdown[data-type="big-small"]');
    if (bigSmallDropdown) {
      const menu = bigSmallDropdown.querySelector('.kill-pattern-menu');
      const resultRow = menu.querySelector('.kill-pattern-result-row');
      const bigRow = menu.querySelector('.kill-pattern-big-row');
      const smallRow = menu.querySelector('.kill-pattern-small-row');
      const trigger = bigSmallDropdown.querySelector('.kill-pattern-trigger .kill-pattern-display');
      
      // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆ
      resultRow.innerHTML = '';
      bigRow.innerHTML = '';
      smallRow.innerHTML = '';
      
      for (let i = 0; i < starLevel; i++) {
        // ç¬¬1æ’ï¼šæ˜¾ç¤ºç»“æœ
        const resultCell = document.createElement('div');
        resultCell.className = 'kill-pattern-cell';
        resultCell.dataset.position = i;
        // æœªé€‰æ‹©ä½ç½®æ˜¾ç¤º '-' å ä½
        resultCell.textContent = '-';
        resultRow.appendChild(resultCell);
        
        // ç¬¬2æ’ï¼šå¤§
        const bigBtn = document.createElement('button');
        bigBtn.className = 'kill-pattern-btn';
        bigBtn.textContent = 'å¤§';
        bigBtn.dataset.position = i;
        bigBtn.dataset.value = 'å¤§';
        bigBtn.addEventListener('click', () => handleKillPatternClick(moduleId, 'bigSmall', i, 'å¤§', bigBtn));
        bigRow.appendChild(bigBtn);
        
        // ç¬¬3æ’ï¼šå°
        const smallBtn = document.createElement('button');
        smallBtn.className = 'kill-pattern-btn';
        smallBtn.textContent = 'å°';
        smallBtn.dataset.position = i;
        smallBtn.dataset.value = 'å°';
        smallBtn.addEventListener('click', () => handleKillPatternClick(moduleId, 'bigSmall', i, 'å°', smallBtn));
        smallRow.appendChild(smallBtn);
      }

      // åˆå§‹åŒ–è§¦å‘å™¨æ˜¾ç¤ºï¼ˆæ ¹æ®å½“å‰å½¢æ€çŠ¶æ€æ¸²æŸ“ä¸º é€—å·åˆ†éš”ï¼Œæœªé€‰ä¸º '-'ï¼‰
      updateKillPatternDisplay(moduleId, 'bigSmall');
      // ç¡®ä¿æ¸…é™¤ä»»ä½•æ®‹ç•™çš„é€‰ä¸­æ ·å¼
      menu.querySelectorAll('.kill-pattern-btn.active').forEach(btn => btn.classList.remove('active'));
      // å…³é—­å·²å±•å¼€çš„èœå•
      menu.classList.remove('active');
    }
  }
  
  // å¤„ç†æ€å½¢æ€ç‚¹å‡»
  function handleKillPatternClick(moduleId, type, position, value, button) {
    const moduleState = window.moduleStates[moduleId];
    const module = document.getElementById(`module${moduleId}`);
    const dropdown = module.querySelector(`.kill-pattern-dropdown[data-type="${type === 'oddEven' ? 'odd-even' : 'big-small'}"]`);
    const menu = dropdown.querySelector('.kill-pattern-menu');
    const resultRow = menu.querySelector('.kill-pattern-result-row');
    const resultCell = resultRow.children[position];
    const trigger = dropdown.querySelector('.kill-pattern-trigger');
    const display = trigger.querySelector('.kill-pattern-display');
    
    // è·å–åŒä¸€åˆ—çš„æ‰€æœ‰æŒ‰é’®
    const allButtons = menu.querySelectorAll(`button[data-position="${position}"]`);
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„æŒ‰é’®ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
    if (button.classList.contains('active')) {
      button.classList.remove('active');
      moduleState.killPatterns[type][position] = '';
      // æœªé€‰æ‹©ä½ç½®æ˜¾ç¤º '-' å ä½
      resultCell.textContent = '-';
    } else {
      // å–æ¶ˆåŒä¸€åˆ—å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
      allButtons.forEach(btn => btn.classList.remove('active'));
      
      // é€‰ä¸­å½“å‰æŒ‰é’®
      button.classList.add('active');
      moduleState.killPatterns[type][position] = value;
      resultCell.textContent = value;
    }
    
    // æ›´æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤ºæ–‡æœ¬
    updateKillPatternDisplay(moduleId, type);
    
    console.log(`æ€å½¢æ€è®¾ç½® - ${type}:`, moduleState.killPatterns[type]);
  }
  
  // æ›´æ–°æ€å½¢æ€æ˜¾ç¤ºæ–‡æœ¬
  function updateKillPatternDisplay(moduleId, type) {
    const moduleState = window.moduleStates[moduleId];
    const module = document.getElementById(`module${moduleId}`);
    const dropdown = module.querySelector(`.kill-pattern-dropdown[data-type="${type === 'oddEven' ? 'odd-even' : 'big-small'}"]`);
    const trigger = dropdown.querySelector('.kill-pattern-trigger');
    const display = trigger.querySelector('.kill-pattern-display');
    
    const patterns = moduleState.killPatterns[type] || [];
    const star = moduleState.starLevel || 5;
    const normalized = [];
    for (let i = 0; i < star; i++) {
      normalized.push(patterns[i] && patterns[i].trim() ? patterns[i] : '-');
    }
    display.textContent = normalized.join(',');
  }
  
  // ä¸‹æ‹‰æ¡†æ˜¾ç¤º/éšè—
  const killPatternDropdowns = module.querySelectorAll('.kill-pattern-dropdown');
  killPatternDropdowns.forEach(dropdown => {
    const trigger = dropdown.querySelector('.kill-pattern-trigger');
    const menu = dropdown.querySelector('.kill-pattern-menu');
    
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      
      // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
      document.querySelectorAll('.kill-pattern-menu.active').forEach(m => {
        if (m !== menu) m.classList.remove('active');
      });
      
      // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†
      menu.classList.toggle('active');
    });
    
    // ç‚¹å‡»èœå•å†…éƒ¨ä¸å…³é—­ä¸‹æ‹‰æ¡†
    menu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  });
  
  // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
  document.addEventListener('click', (e) => {
    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æ€å½¢æ€ç›¸å…³å…ƒç´ 
    if (!e.target.closest('.kill-pattern-container')) {
      module.querySelectorAll('.kill-pattern-menu.active').forEach(menu => {
        menu.classList.remove('active');
      });
    }
  });
  
  // æ¸…é™¤æŒ‰é’®
  const killPatternClearBtns = module.querySelectorAll('.kill-pattern-clear-btn');
  killPatternClearBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type === 'odd-even' ? 'oddEven' : 'bigSmall';
      const dropdown = module.querySelector(`.kill-pattern-dropdown[data-type="${btn.dataset.type}"]`);
      const menu = dropdown.querySelector('.kill-pattern-menu');
      
      // æ¸…ç©ºçŠ¶æ€
      moduleState.killPatterns[type] = new Array(moduleState.starLevel || 5).fill('');
      
      // æ¸…ç©ºUIï¼ˆæ˜¾ç¤º '-' å ä½ï¼‰
      const resultCells = menu.querySelectorAll('.kill-pattern-result-row .kill-pattern-cell');
      resultCells.forEach(cell => cell.textContent = '-');
      
      const buttons = menu.querySelectorAll('.kill-pattern-btn.active');
      buttons.forEach(button => button.classList.remove('active'));
      
      // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
      updateKillPatternDisplay(moduleId, type);
      
      console.log(`å·²æ¸…é™¤${type}æ€å½¢æ€`);
    });
  });
  
  // åˆå§‹åŒ–æ€å½¢æ€
  initKillPatternDropdowns();
  
  // æ˜Ÿçº§å˜åŒ–æ—¶æ¸…ç©ºæ€å½¢æ€å¹¶é‡æ–°åˆå§‹åŒ–
  const moduleStarButtonsForKillPattern = module.querySelectorAll('.module-star-btn');
  moduleStarButtonsForKillPattern.forEach(btn => {
    btn.addEventListener('click', () => {
      setTimeout(() => {
        // æ¸…ç©ºçŠ¶æ€
        moduleState.killPatterns.oddEven = new Array(moduleState.starLevel || 5).fill('');
        moduleState.killPatterns.bigSmall = new Array(moduleState.starLevel || 5).fill('');
        moduleState.killSpanValues = [];
        moduleState.killSumTailValues = [];
        
        // é‡ç½®æ˜¾ç¤ºæ–‡æœ¬
        const oddEvenDropdown = module.querySelector('.kill-pattern-dropdown[data-type="odd-even"]');
        if (oddEvenDropdown) {
          const display = oddEvenDropdown.querySelector('.kill-pattern-trigger .kill-pattern-display');
          if (display) display.textContent = '';
        }
        const bigSmallDropdown = module.querySelector('.kill-pattern-dropdown[data-type="big-small"]');
        if (bigSmallDropdown) {
          const display = bigSmallDropdown.querySelector('.kill-pattern-trigger .kill-pattern-display');
          if (display) display.textContent = '';
        }
        // é‡ç½® æ€è·¨åº¦/æ€å’Œå°¾ é€‰æ‹©
        const spanSelect = module.querySelector('.kill-span-select');
        if (spanSelect) Array.from(spanSelect.options).forEach(o => (o.selected = false));
        const sumTailSelect = module.querySelector('.kill-sumtail-select');
        if (sumTailSelect) Array.from(sumTailSelect.options).forEach(o => (o.selected = false));
        
        // é‡æ–°åˆå§‹åŒ–UI
        initKillPatternDropdowns();
        // åŒæ­¥é‡ç½®è‡ªå®šä¹‰ä¸‹æ‹‰ï¼ˆæ¸…é™¤é€‰ä¸­ä¸æ˜¾ç¤ºï¼‰
        const extraDDSpan = module.querySelector('.kill-extra-dropdown[data-type="span"]');
        if (extraDDSpan) {
          extraDDSpan.querySelectorAll('.kill-pattern-btn.active').forEach(b => b.classList.remove('active'));
          const display = extraDDSpan.querySelector('.kill-extra-display');
          if (display) display.textContent = '';
        }
        const extraDDSum = module.querySelector('.kill-extra-dropdown[data-type="sumtail"]');
        if (extraDDSum) {
          extraDDSum.querySelectorAll('.kill-pattern-btn.active').forEach(b => b.classList.remove('active'));
          const display = extraDDSum.querySelector('.kill-extra-display');
          if (display) display.textContent = '';
        }
      }, 100);
    });
  });
  
  // ============ æ€å½¢æ€åŠŸèƒ½åˆå§‹åŒ–ç»“æŸ ============

  // ============ æ€è·¨åº¦/æ€å’Œå°¾ ä¸‹æ‹‰ ============
  function updateKillExtraDisplay(moduleId, type) {
    const module = document.getElementById(`module${moduleId}`);
    const dropdown = module.querySelector(`.kill-extra-dropdown[data-type="${type}"]`);
    if (!dropdown) return;
    const display = dropdown.querySelector('.kill-extra-display');
    const arr = type === 'span' ? (window.moduleStates[moduleId].killSpanValues || [])
                                : (window.moduleStates[moduleId].killSumTailValues || []);
    display.textContent = (arr && arr.length) ? arr.sort((a,b)=>a-b).join(',') : '';
  }

  function initKillExtraDropdowns() {
    const module = document.getElementById(`module${moduleId}`);
    const spanDropdown = module.querySelector('.kill-extra-dropdown[data-type="span"]');
    const sumTailDropdown = module.querySelector('.kill-extra-dropdown[data-type="sumtail"]');

    // é€šç”¨ï¼šæ¸²æŸ“é€‰é¡¹
    function renderOptions(dropdown, values, stateArrayName) {
      if (!dropdown) return;
      const menu = dropdown.querySelector('.kill-pattern-menu');
      const optionsRow = dropdown.querySelector('.kill-extra-options');
      if (!optionsRow) return;
      optionsRow.innerHTML = '';
      values.forEach(v => {
        const btn = document.createElement('button');
        btn.className = 'kill-pattern-btn';
        btn.textContent = String(v);
        btn.dataset.value = String(v);
        // åˆå§‹é€‰ä¸­æ€
        const arr = moduleState[stateArrayName] || [];
        if (arr.includes(v)) btn.classList.add('active');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const list = moduleState[stateArrayName];
          const idx = list.indexOf(v);
          if (idx >= 0) {
            list.splice(idx, 1);
            btn.classList.remove('active');
          } else {
            list.push(v);
            btn.classList.add('active');
          }
          updateKillExtraDisplay(moduleId, stateArrayName === 'killSpanValues' ? 'span' : 'sumtail');
        });
        optionsRow.appendChild(btn);
      });

      // è§¦å‘å™¨å¼€åˆ
      const trigger = dropdown.querySelector('.kill-pattern-trigger');
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // å…³é—­å…¶å®ƒå·²å±•å¼€èœå•ï¼ˆåŒ…å«å½¢æ€ä¸é¢å¤–ç­›é€‰ï¼‰
        document.querySelectorAll('.kill-pattern-menu.active').forEach(m => {
          if (m !== menu) m.classList.remove('active');
        });
        menu.classList.toggle('active');
      });
      // å†…éƒ¨ç‚¹å‡»ä¸å†’æ³¡
      menu.addEventListener('click', (e) => e.stopPropagation());
      // ç‚¹å‡»é¡µé¢å…¶å®ƒåœ°æ–¹å…³é—­
      document.addEventListener('click', () => menu.classList.remove('active'));
    }

    // æ¸²æŸ“è·¨åº¦(1-9)ä¸å’Œå°¾(0-9)
    renderOptions(spanDropdown, [1,2,3,4,5,6,7,8,9], 'killSpanValues');
    renderOptions(sumTailDropdown, [0,1,2,3,4,5,6,7,8,9], 'killSumTailValues');

    // æ¸…æŒ‰é’®
    const extraClearBtns = module.querySelectorAll('.kill-extra-clear-btn');
    extraClearBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type; // 'span' | 'sumtail'
        if (type === 'span') moduleState.killSpanValues = [];
        else moduleState.killSumTailValues = [];
        // æ¸…UIé€‰ä¸­
        const dd = module.querySelector(`.kill-extra-dropdown[data-type="${type}"]`);
        if (dd) {
          dd.querySelectorAll('.kill-pattern-btn.active').forEach(b => b.classList.remove('active'));
          updateKillExtraDisplay(moduleId, type);
          // å…³é—­é¢æ¿
          const menu = dd.querySelector('.kill-pattern-menu');
          if (menu) menu.classList.remove('active');
        }
      });
    });

    // åˆå§‹åŒ–æ˜¾ç¤º
    updateKillExtraDisplay(moduleId, 'span');
    updateKillExtraDisplay(moduleId, 'sumtail');
  }

  // åˆå§‹åŒ–é¢å¤–ç­›é€‰ä¸‹æ‹‰
  initKillExtraDropdowns();
  // ============ æ€è·¨åº¦/æ€å’Œå°¾ ä¸‹æ‹‰ç»“æŸ ============

  // ä½ç½®é€‰æ‹©æŒ‰é’®äº‹ä»¶å¤„ç†
  const positionButtons = module.querySelectorAll('.position-btn');
  positionButtons.forEach(button => {
    button.addEventListener('click', function() {
      const position = parseInt(this.dataset.position);
      
      // åˆ‡æ¢æŒ‰é’®é€‰ä¸­çŠ¶æ€
      if (this.classList.contains('bg-green-500')) {
        // å–æ¶ˆé€‰ä¸­
        this.classList.remove('bg-green-500', 'text-white');
        this.classList.add('bg-gray-200', 'text-gray-700');
        
        // ä»æ¨¡å—çŠ¶æ€ä¸­ç§»é™¤è¯¥ä½ç½®
        const index = moduleState.selectedPositions.indexOf(position);
        if (index > -1) {
          moduleState.selectedPositions.splice(index, 1);
        }
      } else {
        // é€‰ä¸­
        this.classList.remove('bg-gray-200', 'text-gray-700');
        this.classList.add('bg-green-500', 'text-white');
        
        // æ·»åŠ åˆ°æ¨¡å—çŠ¶æ€ä¸­
        if (!moduleState.selectedPositions.includes(position)) {
          moduleState.selectedPositions.push(position);
        }
      }
      
      // æ’åºä½ç½®æ•°ç»„
      moduleState.selectedPositions.sort((a, b) => a - b);
      
      console.log(`æ¨¡å—${moduleId}é€‰ä¸­çš„ä½ç½®:`, moduleState.selectedPositions);
    });
  });

  /***** æ ¸å¿ƒï¼šæŒ‰"å‘½ä¸­ä¸ªæ•°"åˆ¤å®šï¼ˆä¸çœ‹ä½ç½®ï¼‰ *****/
  
  /** æ±‚ä¸å¼€å¥–å·ç ï¼ˆå‰äº”ï¼‰ç›¸äº¤çš„å‘½ä¸­ä¸ªæ•° */
  function countHits(picks, openTop5) {
    const set = new Set(openTop5.map(String));
    let c = 0;
    for (const x of picks) if (set.has(String(x))) c++;
    return c;
  }
  
  /** æ¡ä»¶åˆ¤å®šï¼šå‘½ä¸­ä¸ªæ•°åœ¨ [minHits, maxHits] å†…å³é€šè¿‡ */
  function evalHitCondition(picks, openTop5, minHits, maxHits) {
    const k = picks.length;
    // è§„èŒƒåŒ–è¾¹ç•Œ
    const lo = Math.max(0, Math.min(minHits, maxHits));
    const hi = Math.min(k, Math.max(minHits, maxHits));
    const hits = countHits(picks, openTop5);
    const ok = hits >= lo && hits <= hi;
    return { ok, hits, minHits: lo, maxHits: hi, size: k };
  }
  
  /** ç»„åˆåˆ¤å®šï¼š5 ä¸ªæ¡ä»¶äº’ä¸å¹²æ‰°ï¼Œæœ€ç»ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ */
  function evalAllConditions(conditions, openTop5) {
    const details = conditions.map(c =>
      evalHitCondition(c.picks, openTop5, c.minHits, c.maxHits)
    );
    return { ok: details.every(d => d.ok), details };
  }
  
  /***** ä¾¿æ·æ˜ å°„ï¼šä¸åŒå†™æ³•ç»Ÿä¸€æˆå‘½ä¸­åŒºé—´ *****/
  
  /** nèƒ†ï¼šmode='atLeast' è¡¨ç¤º"è‡³å°‘ n ä¸­"ï¼›mode='exact' è¡¨ç¤º"æ°å¥½ n ä¸­" */
  function mapDanToRange(nDan, picksLen, mode = 'atLeast') {
    if (mode === 'exact') return { minHits: nDan, maxHits: nDan };
    // é»˜è®¤"è‡³å°‘ n ä¸­"
    return { minHits: nDan, maxHits: picksLen };
  }
  
  /** "é”™åŒºé—´"å†™æ³•ï¼ˆæ¯”å¦‚ '1-1', '0-2'ï¼‰ï¼Œè½¬æˆå‘½ä¸­åŒºé—´
   *  çº¦å®šï¼š'a-b' è¡¨ç¤º"å…è®¸é”™ a åˆ° b ä¸ª"
   *  åˆ™å‘½ä¸­èŒƒå›´ = [picksLen - b, picksLen - a]
   */
  function mapMissRangeToHits(missRangeStr, picksLen) {
    const [a, b] = missRangeStr.split('-').map(x => parseInt(x, 10));
    const minHits = Math.max(0, picksLen - Math.max(a, b));
    const maxHits = Math.min(picksLen, picksLen - Math.min(a, b));
    return { minHits, maxHits };
  }
  
  // åŸºäºæ¡ä»¶æ•°æ®ç”Ÿæˆç»„åˆçš„å‡½æ•°
  function generateFromConditions(activeConditions) {
    const results = [];
    const conditionCount = activeConditions.length;
    const minFailures = moduleState.moduleToleranceMin;
    const maxFailures = moduleState.moduleToleranceMax;
    
    // è®¡ç®—éœ€è¦æ»¡è¶³çš„æ¡ä»¶æ•°é‡èŒƒå›´
    const minSatisfied = Math.max(0, conditionCount - maxFailures);
    const maxSatisfied = Math.max(0, conditionCount - minFailures);
    
    console.log(`æ¡ä»¶æ€»æ•°: ${conditionCount}, å®¹é”™èŒƒå›´: ${minFailures}-${maxFailures}`);
    console.log(`éœ€è¦æ»¡è¶³çš„æ¡ä»¶æ•°: ${minSatisfied}-${maxSatisfied}`);
    
    // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ¡ä»¶ç»„åˆ
    for (let satisfiedCount = minSatisfied; satisfiedCount <= maxSatisfied; satisfiedCount++) {
      if (satisfiedCount === 0 && conditionCount > 0) continue; // å½“æœ‰æ¡ä»¶æ—¶ï¼Œè‡³å°‘è¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶
      
      // è·å–æ‰€æœ‰å¯èƒ½çš„æ¡ä»¶ç»„åˆ
      const conditionCombinations = getCombinations(activeConditions, satisfiedCount);
      
      for (const conditionCombo of conditionCombinations) {
        // ä»é€‰ä¸­çš„æ¡ä»¶ä¸­ç”Ÿæˆæ•°å­—ç»„åˆ
        const numberCombinations = generateNumberCombinations(conditionCombo);
        results.push(...numberCombinations);
      }
    }
    
    // å»é‡å¹¶é™åˆ¶ç»“æœæ•°é‡
    const uniqueResults = [...new Set(results.map(r => r.join(',')))];
    console.log(`ç”Ÿæˆç»„åˆæ•°: ${uniqueResults.length}`);
    
    return uniqueResults.slice(0, 10000).map(r => r.split(',').map(Number)); // é™åˆ¶æœ€å¤š10000ä¸ªç»“æœ
  }
  
  // è·å–æ•°ç»„çš„æ‰€æœ‰ç»„åˆ
  function getCombinations(arr, count) {
    if (count === 0) return [[]];
    if (count > arr.length) return [];
    if (count === arr.length) return [arr];
    
    const result = [];
    for (let i = 0; i <= arr.length - count; i++) {
      const head = arr[i];
      const tailCombos = getCombinations(arr.slice(i + 1), count - 1);
      for (const tail of tailCombos) {
        result.push([head, ...tail]);
      }
    }
    return result;
  }
  
  // ä»æ¡ä»¶ç»„åˆä¸­ç”Ÿæˆæ•°å­—ç»„åˆ
  function generateNumberCombinations(conditions) {
    const results = [];
    
    // æ”¶é›†æ‰€æœ‰æ¡ä»¶çš„æ•°å­—
    const allConditionNumbers = conditions.map(condition => {
      return condition.selectedNumbers.length > 0 ? condition.selectedNumbers : [1,2,3,4,5,6,7,8,9,10];
    });
    
    // ç”Ÿæˆç¬›å¡å°”ç§¯
    function cartesianProduct(arrays) {
      if (arrays.length === 0) return [[]];
      if (arrays.length === 1) return arrays[0].map(x => [x]);
      
      const result = [];
      const firstArray = arrays[0];
      const restProduct = cartesianProduct(arrays.slice(1));
      
      for (const first of firstArray) {
        for (const rest of restProduct) {
          const combination = [first, ...rest];
          if (combination.length === 5 && new Set(combination).size === 5) {
            // ç¡®ä¿æ˜¯5ä¸ªä¸é‡å¤çš„æ•°å­—
            result.push(combination.sort((a, b) => a - b));
          }
        }
      }
      return result;
    }
    
    // å¦‚æœæ¡ä»¶æ•°å°‘äº5ä¸ªï¼Œéœ€è¦è¡¥å……å…¶ä»–æ•°å­—
    if (conditions.length < 5) {
      const usedNumbers = new Set();
      conditions.forEach(condition => {
        condition.selectedNumbers.forEach(num => usedNumbers.add(num));
      });
      
      const remainingNumbers = [1,2,3,4,5,6,7,8,9,10].filter(num => !usedNumbers.has(num));
      const needMore = 5 - conditions.length;
      
      // ä»å‰©ä½™æ•°å­—ä¸­é€‰æ‹©éœ€è¦çš„æ•°é‡
      const additionalCombos = getCombinations(remainingNumbers, needMore);
      
      for (const condition of conditions) {
        for (const num of condition.selectedNumbers) {
          for (const additional of additionalCombos) {
            const combination = [num, ...additional].sort((a, b) => a - b);
            if (combination.length === 5 && new Set(combination).size === 5) {
              results.push(combination);
            }
          }
        }
      }
    } else {
      // å¦‚æœæ¡ä»¶æ•°>=5ï¼Œç›´æ¥ä»æ¯ä¸ªæ¡ä»¶ä¸­é€‰ä¸€ä¸ªæ•°å­—
      const cartesianResults = cartesianProduct(allConditionNumbers);
      results.push(...cartesianResults);
    }
    
    return results;
  }
  
  // æ¡ä»¶è¯„ä¼°å‡½æ•°ï¼ˆé€‚é…ç°æœ‰æ¥å£ï¼‰
  function evaluateCondition(condition, resultNums) {
    // å¦‚æœæ¡ä»¶ä¸ºç©ºï¼Œåº”è¯¥ä¸å‚ä¸è¯„ä¼°
    if (condition.selectedNumbers.length === 0 && condition.selectedDamas.length === 0) {
      return { ok: true, errors: 0 };
    }
    
    const picks = condition.selectedNumbers;
    const picksLen = picks.length;
    
    // è®¡ç®—å®é™…å‘½ä¸­ä¸ªæ•°
    const actualHitCount = countHits(picks, resultNums);
    
    if (condition.selectedDamas.length === 0) {
      // æœªé€‰æ‹©å‘½ä¸­èƒ†ç æ•°ï¼šå¦‚æœé€‰æ‹©äº†èƒ†ç æ•°å­—ä½†æ²¡æœ‰é€‰æ‹©å‘½ä¸­èƒ†ç æ•°ï¼Œåˆ™ä¸é€šè¿‡ç­›é€‰
      // è¿™ç§æƒ…å†µä¸‹ç”¨æˆ·éœ€è¦æ˜ç¡®æŒ‡å®šå‘½ä¸­å‡ ä¸ªèƒ†ç æ‰èƒ½è¿›è¡Œç­›é€‰
      return {
        ok: false,
        errors: picksLen - actualHitCount,
        hitCount: actualHitCount
      };
    }
    
    // å·²é€‰æ‹©å‘½ä¸­èƒ†ç æ•°ï¼šæ£€æŸ¥å®é™…å‘½ä¸­æ•°æ˜¯å¦åœ¨é€‰ä¸­çš„èƒ†ç æ•°èŒƒå›´å†…
    // èƒ†ç é€»è¾‘ï¼šé€‰æ‹©1234ä½œä¸ºèƒ†ç ï¼Œå‘½ä¸­èƒ†ç æ•°é€‰3-4æ—¶ï¼Œç­›é€‰åŒ…å«1234ä¸­ä»»æ„3ä¸ªæˆ–4ä¸ªçš„å·ç 
    
    // åŸºäºæ•°å­¦å…¬å¼çš„æ¡ä»¶é›†Kå®¹é”™é€»è¾‘
    // æ¡ä»¶é›†K = {é€‰ä¸­çš„èƒ†ç æ•°}ï¼Œå®é™…å‘½ä¸­æ•°kï¼Œå®¹é”™å‚æ•°r
    // r=0: å¹¶é›†é€»è¾‘ Sr=0(K) = âˆ‘N(k) for kâˆˆK (åˆ†åˆ«æ»¡è¶³)
    // r=1: è¡¥é›†é€»è¾‘ Sr=1(K) = âˆ‘N(k) for kâˆ‰K (ä¸æ»¡è¶³)
    // r(0-1): è”åˆé€»è¾‘ Sr(0-1)(K) = Sr=0(K) + Sr=1(K) = P(10,n) (å…¨é›†)
    
    const toleranceMin = condition.toleranceMin;
    const toleranceMax = condition.toleranceMax;
    const selectedDamasSet = new Set(condition.selectedDamas);
    
    let isValid = false;
    
    if (toleranceMin === 0 && toleranceMax === 0) {
      // r=0: å¹¶é›†é€»è¾‘ - å®é™…å‘½ä¸­æ•°å¿…é¡»åœ¨æ¡ä»¶é›†Kä¸­
      isValid = selectedDamasSet.has(actualHitCount);
    } else if (toleranceMin === 1 && toleranceMax === 1) {
      // r=1: è¡¥é›†é€»è¾‘ - å®é™…å‘½ä¸­æ•°å¿…é¡»ä¸åœ¨æ¡ä»¶é›†Kä¸­
      isValid = !selectedDamasSet.has(actualHitCount);
    } else if (toleranceMin === 0 && toleranceMax === 1) {
      // r(0-1): è”åˆé€»è¾‘ - å®é™…å‘½ä¸­æ•°å¯ä»¥åœ¨Kä¸­æˆ–ä¸åœ¨Kä¸­ï¼ˆå…¨é›†ï¼‰
      isValid = true; // ä»»ä½•å‘½ä¸­æ•°éƒ½æ»¡è¶³
    } else {
      // æ‰©å±•å®¹é”™é€»è¾‘ï¼šåŸºäºæ¡ä»¶é›†Kçš„åŒ…å«å…³ç³»
      // è®¡ç®—æ¡ä»¶é›†Kä¸­æ»¡è¶³çš„èƒ†ç æ•°é‡
      const satisfiedInK = selectedDamasSet.has(actualHitCount) ? 1 : 0;
      const unsatisfiedInK = selectedDamasSet.has(actualHitCount) ? 0 : 1;
      
      // æ£€æŸ¥æ»¡è¶³æ¡ä»¶çš„æ•°é‡æ˜¯å¦åœ¨å®¹é”™èŒƒå›´å†…
      if (toleranceMin <= toleranceMax) {
        // æ ‡å‡†èŒƒå›´å®¹é”™ï¼šå…è®¸unsatisfiedInKåœ¨[toleranceMin, toleranceMax]èŒƒå›´å†…
        isValid = unsatisfiedInK >= toleranceMin && unsatisfiedInK <= toleranceMax;
      } else {
        // ç‰¹æ®Šæƒ…å†µå¤„ç†
        isValid = false;
      }
    }
    
    return {
      ok: isValid,
      errors: picksLen - actualHitCount,
      hitCount: actualHitCount,
      conditionSetK: Array.from(selectedDamasSet),
      toleranceApplied: `r(${toleranceMin}-${toleranceMax})`
    };
  }  
  // è¯„ä¼°æ‰€æœ‰æ¡ä»¶ï¼ˆé€‚é…ç°æœ‰æ¥å£ï¼‰
  function evaluateAll(conditions, resultNums) {
    // åªè¯„ä¼°æœ‰è®¾ç½®çš„æ¡ä»¶ï¼ˆé€‰æ‹©äº†æ•°å­—æˆ–èƒ†ç çš„æ¡ä»¶ï¼‰
    const activeConditions = conditions.filter(c => 
      c.selectedNumbers.length > 0 || c.selectedDamas.length > 0
    );
    
    // å¦‚æœæ²¡æœ‰ä»»ä½•æ´»è·ƒæ¡ä»¶ï¼Œè¿”å›trueï¼ˆé€šè¿‡ç­›é€‰ï¼Œç”Ÿæˆæ‰€æœ‰ç»„åˆï¼‰
    if (activeConditions.length === 0) {
      return { ok: true, details: [], failedCount: 0, moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax] };
    }
    
    const details = activeConditions.map(c => evaluateCondition(c, resultNums));
    
    // åº”ç”¨æ¨¡å—æ€»å®¹é”™é€»è¾‘
    // ç»Ÿè®¡ä¸æˆç«‹çš„æ¡ä»¶æ•°é‡
    const failedConditionsCount = details.filter(d => !d.ok).length;
    
    // æ£€æŸ¥å¤±è´¥çš„æ¡ä»¶æ•°æ˜¯å¦åœ¨å…è®¸çš„å®¹é”™èŒƒå›´å†…
    const moduleToleranceOk = failedConditionsCount >= moduleState.moduleToleranceMin && 
                             failedConditionsCount <= moduleState.moduleToleranceMax;
    
    return { 
      ok: moduleToleranceOk, 
      details,
      failedCount: failedConditionsCount,
      moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax]
    };
  }

  // åšå·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  generateBtn.addEventListener('click', function() {
    // è·å–æœ‰æ•°æ®çš„æ¡ä»¶
    const activeConditions = moduleState.groups.filter(g => 
      g.selectedNumbers.length > 0 || g.selectedDamas.length > 0
    );
    
    let filteredResults = [];
    
    // è·å–å½“å‰é€‰æ‹©çš„æ˜Ÿçº§
    const currentStarLevel = moduleState.starLevel || 5;
    
    // å¦‚æœæ²¡æœ‰æ´»è·ƒæ¡ä»¶ï¼Œç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ’åˆ—
    if (activeConditions.length === 0) {
      console.log(`æ²¡æœ‰æ´»è·ƒæ¡ä»¶ï¼Œç”Ÿæˆæ‰€æœ‰${currentStarLevel}æ˜Ÿæ’åˆ—`);
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, currentStarLevel);
      console.log(`ç”Ÿæˆ${currentStarLevel}æ˜Ÿæ’åˆ—æ•°: ${permutations.length}`);
      filteredResults = permutations;
    }
    // æœ‰æ´»è·ƒæ¡ä»¶æ—¶ï¼Œä½¿ç”¨ç­›é€‰é€»è¾‘
    else {
      console.log(`æœ‰æ´»è·ƒæ¡ä»¶ï¼Œä½¿ç”¨${currentStarLevel}æ˜Ÿç­›é€‰é€»è¾‘`);
      console.log('æ´»è·ƒæ¡ä»¶:', activeConditions);
      
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, currentStarLevel);
      
      // å­˜å‚¨æ‰€æœ‰æ’åˆ—ç»„åˆ
      moduleState.allPermutations = permutations;
      
      // æ ¹æ®é€‰ä¸­çš„æ•°å­—ã€èƒ†ç å’Œå®¹é”™ç­›é€‰ç»“æœ
      filteredResults = permutations.filter(comb => {
          // ä½¿ç”¨å®¹é”™è¯„ä¼°é€»è¾‘
          const evaluation = evaluateAll(moduleState.groups, comb);
          
          // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå‰å‡ ä¸ªç»„åˆçš„è¯„ä¼°ç»“æœ
          if (permutations.indexOf(comb) < 5) {
            console.log(`ç»„åˆ ${comb.join(',')} è¯„ä¼°ç»“æœ:`, {
              ok: evaluation.ok,
              failedCount: evaluation.failedCount,
              moduleToleranceRange: evaluation.moduleToleranceRange,
              details: evaluation.details.map(d => ({ ok: d.ok, hitCount: d.hitCount }))
            });
          }
          
          return evaluation.ok;
      });
    }
    
    // ============ åº”ç”¨æ€å½¢æ€è¿‡æ»¤ ============
    if (moduleState.killPatterns && (moduleState.killPatterns.oddEven.some(v => v) || moduleState.killPatterns.bigSmall.some(v => v))) {
      const beforeKillFilter = filteredResults.length;
      
      filteredResults = filteredResults.filter(comb => {
        // æ£€æŸ¥å•åŒæ€å½¢æ€
        for (let i = 0; i < moduleState.killPatterns.oddEven.length; i++) {
          const killValue = moduleState.killPatterns.oddEven[i];
          if (killValue) {
            const num = comb[i];
            const isOdd = num % 2 === 1;
            
            // å¦‚æœè®¾ç½®äº†æ€å•ï¼Œä½†å·ç æ˜¯å•ï¼Œåˆ™è¿‡æ»¤æ‰
            if (killValue === 'å•' && isOdd) return false;
            // å¦‚æœè®¾ç½®äº†æ€åŒï¼Œä½†å·ç æ˜¯åŒï¼Œåˆ™è¿‡æ»¤æ‰
            if (killValue === 'åŒ' && !isOdd) return false;
          }
        }
        
        // æ£€æŸ¥å¤§å°æ€å½¢æ€ (6-10ä¸ºå¤§ï¼Œ1-5ä¸ºå°)
        for (let i = 0; i < moduleState.killPatterns.bigSmall.length; i++) {
          const killValue = moduleState.killPatterns.bigSmall[i];
          if (killValue) {
            const num = comb[i];
            const isBig = num >= 6;
            
            // å¦‚æœè®¾ç½®äº†æ€å¤§ï¼Œä½†å·ç æ˜¯å¤§ï¼Œåˆ™è¿‡æ»¤æ‰
            if (killValue === 'å¤§' && isBig) return false;
            // å¦‚æœè®¾ç½®äº†æ€å°ï¼Œä½†å·ç æ˜¯å°ï¼Œåˆ™è¿‡æ»¤æ‰
            if (killValue === 'å°' && !isBig) return false;
          }
        }
        
        return true;
      });
      
      console.log(`æ€å½¢æ€è¿‡æ»¤: ${beforeKillFilter} â†’ ${filteredResults.length} (æ€æ‰${beforeKillFilter - filteredResults.length}æ³¨)`);
      console.log('æ€å½¢æ€è®¾ç½®:', {
        oddEven: moduleState.killPatterns.oddEven,
        bigSmall: moduleState.killPatterns.bigSmall
      });
    }
    // ============ æ€å½¢æ€è¿‡æ»¤ç»“æŸ ============

    // ============ æ€è·¨åº¦/æ€å’Œå°¾è¿‡æ»¤ ============
    if ((moduleState.killSpanValues && moduleState.killSpanValues.length > 0) ||
        (moduleState.killSumTailValues && moduleState.killSumTailValues.length > 0)) {
      const beforeExtraKill = filteredResults.length;

      filteredResults = filteredResults.filter(comb => {
        // æ€è·¨åº¦ï¼šæœ€å¤§å€¼ä¸æœ€å°å€¼ä¹‹å·®
        if (moduleState.killSpanValues && moduleState.killSpanValues.length > 0) {
          const max = Math.max(...comb);
          const min = Math.min(...comb);
          const span = max - min;
          if (moduleState.killSpanValues.includes(span)) return false;
        }
        // æ€å’Œå°¾ï¼šæ‰€æœ‰ä½æ•°å­—ä¹‹å’Œçš„ä¸ªä½æ•°
        if (moduleState.killSumTailValues && moduleState.killSumTailValues.length > 0) {
          const sum = comb.reduce((a, b) => a + b, 0);
          const tail = sum % 10;
          if (moduleState.killSumTailValues.includes(tail)) return false;
        }
        return true;
      });

      console.log(`è·¨åº¦/å’Œå°¾è¿‡æ»¤: ${beforeExtraKill} â†’ ${filteredResults.length} (æ€æ‰${beforeExtraKill - filteredResults.length}æ³¨)`);
      console.log('æ€è·¨åº¦/æ€å’Œå°¾è®¾ç½®:', {
        span: moduleState.killSpanValues,
        sumTail: moduleState.killSumTailValues
      });
    }
    // ============ æ€è·¨åº¦/æ€å’Œå°¾è¿‡æ»¤ç»“æŸ ============
    
    // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºç­›é€‰ç»Ÿè®¡
    console.log(`æ¨¡å—æ€»å®¹é”™è®¾ç½®: ${moduleState.moduleToleranceMin}-${moduleState.moduleToleranceMax}`);
    console.log(`æ´»è·ƒæ¡ä»¶æ•°: ${moduleState.groups.filter(g => g.selectedNumbers.length > 0 || g.selectedDamas.length > 0).length}`);
    console.log(`ç­›é€‰ç»“æœ: ${filteredResults.length}`);
    
    // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºæœ€ç»ˆç»“æœ
    console.log(`æœ€ç»ˆç­›é€‰ç»“æœæ•°é‡: ${filteredResults.length}`);
    
    // é¦–æ¬¡ç”Ÿæˆæ—¶å°±æŒ‰ç…§æ ¼å¼åŒ–é€»è¾‘å¤„ç†å¹¶å­˜å‚¨ä¸ºå­—ç¬¦ä¸²
    const formattedResults = filteredResults.map(comb => 
        comb.map(num => num.toString().padStart(2, '0')).join(' ')
    );
    
    console.log(`æ ¼å¼åŒ–åç»“æœæ•°é‡: ${formattedResults.length}`);
    

    
    moduleState.results = formattedResults;
    moduleState.originalResults = [...formattedResults]; // ä¿å­˜åŸå§‹ç»“æœ
    moduleState.isReversed = false;
    
    updateResultDisplay();
  });

  // å¤åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  copyBtn.addEventListener('click', function() {
    if (moduleState.results.length === 0) {
      // ä¿®æ”¹æ— ç»“æœæç¤ºä¸ºæ–‡æœ¬æ˜¾ç¤º
      resultCount.innerHTML = '<span style="color: red;">æ²¡æœ‰å¯å¤åˆ¶çš„ç»“æœ</span>';
      setTimeout(() => {
        resultCount.textContent = `å…±${moduleState.results.length}æ³¨`;
      }, 1000);
      return;
    }
    
    // å¤åˆ¶å­˜å‚¨çš„ç­›é€‰ç»“æœ - ç»„å†…ç©ºæ ¼ï¼Œç»„é—´é€—å·
    // moduleState.resultsä¸­æ¯ä¸ªå…ƒç´ å·²ç»æ˜¯æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼ˆå¦‚"01 02 03 04 05"ï¼‰
    // ç›´æ¥ç”¨é€—å·è¿æ¥å³å¯å¾—åˆ°æ­£ç¡®æ ¼å¼
    let textToCopy = '';
    for (let i = 0; i < moduleState.results.length; i++) {
      if (i > 0) textToCopy += ',';
      textToCopy += moduleState.results[i];
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(textToCopy).then(() => {
      // å¤åˆ¶æˆåŠŸåæ˜¾ç¤ºçº¢è‰²çš„å·²å¤åˆ¶æç¤º
      resultCount.innerHTML = `å…±${moduleState.results.length}æ³¨ <span style="color: red;">å·²å¤åˆ¶${moduleState.results.length}æ³¨</span>`;
    }).catch(err => {
      console.error('å¤åˆ¶å¤±è´¥:', err);
      // é”™è¯¯æç¤ºï¼šæ˜¾ç¤ºçº¢è‰²é”™è¯¯æ–‡æœ¬
      resultCount.innerHTML = '<span style="color: red;">å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶</span>';
      setTimeout(() => {
        resultCount.textContent = `å…±${moduleState.results.length}æ³¨`;
      }, 2000);
    });
  });

  // éªŒè¯é€»è¾‘å‡½æ•° - æå–éªŒè¯é€»è¾‘é¿å…é€’å½’è°ƒç”¨
  // éªŒè¯ä»»åŠ¡ç®¡ç†å™¨
  const VerificationTaskManager = {
    currentTask: null,
    isRunning: false,
    dataUpdateTimer: null,
    lastProcessedPeriod: null,
    currentModuleId: null, // æ·»åŠ å½“å‰æ¨¡å—ID
    
    // å¯åŠ¨æŒç»­éªŒè¯ä»»åŠ¡
    startContinuousVerification(moduleId) {
      console.log(`ğŸš€ å¯åŠ¨æ¨¡å—${moduleId}çš„æŒç»­éªŒè¯ä»»åŠ¡`);
      
      // åœæ­¢ä¹‹å‰çš„ä»»åŠ¡
      this.stopCurrentTask();
      
      // æ ‡è®°ä¸ºè¿è¡ŒçŠ¶æ€
      this.isRunning = true;
      this.currentModuleId = moduleId;
      
      // æ‰§è¡Œé¦–æ¬¡éªŒè¯
      this.performSingleVerification();
      
      // å¯åŠ¨æ•°æ®ç›‘å¬
      this.startDataMonitoring();
    },
    
    // åœæ­¢å½“å‰éªŒè¯ä»»åŠ¡
    stopCurrentTask() {
      console.log('ğŸ›‘ åœæ­¢å½“å‰éªŒè¯ä»»åŠ¡');
      
      this.isRunning = false;
      
      // æ¸…é™¤æ•°æ®ç›‘å¬å®šæ—¶å™¨
      if (this.dataUpdateTimer) {
        clearInterval(this.dataUpdateTimer);
        this.dataUpdateTimer = null;
      }
      
      // é‡ç½®çŠ¶æ€
      this.lastProcessedPeriod = null;
      
      console.log('âœ… éªŒè¯ä»»åŠ¡å·²åœæ­¢');
    },
    
    // å¯åŠ¨æ•°æ®æ›´æ–°ç›‘å¬
    startDataMonitoring() {
      console.log('ğŸ‘ï¸ å¯åŠ¨æ•°æ®æ›´æ–°ç›‘å¬');
      
      // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ•°æ®æ›´æ–°
      this.dataUpdateTimer = setInterval(() => {
        if (!this.isRunning) {
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
        if (r && r.length > 0) {
          const latestPeriod = r[0].period;
          
          // å¦‚æœå‘ç°æ–°æœŸæ•°æ®ï¼Œè§¦å‘éªŒè¯
          if (this.lastProcessedPeriod !== latestPeriod) {
            console.log(`ğŸ”” æ£€æµ‹åˆ°æ–°æœŸæ•°æ®: ${latestPeriod}ï¼Œè§¦å‘éªŒè¯`);
            this.performSingleVerification();
          }
        }
      }, 3000);
    },
    
    // æ‰§è¡Œå•æ¬¡éªŒè¯
    performSingleVerification() {
      if (!this.isRunning) {
        console.log('âš ï¸ éªŒè¯ä»»åŠ¡å·²åœæ­¢ï¼Œè·³è¿‡éªŒè¯');
        return;
      }
      
      console.log(`ğŸ” æ‰§è¡Œæ¨¡å—${this.currentModuleId}çš„æŒç»­éªŒè¯ - å…¨æœŸéªŒè¯æ¨¡å¼`);
      
      // åœ¨æŒç»­éªŒè¯æ¨¡å¼ä¸‹ï¼Œè§¦å‘å…¨æœŸéªŒè¯æ›´æ–°
      if (window.PlanDataUpdateListener && typeof window.PlanDataUpdateListener.updateAllPlansWithFullVerification === 'function') {
        window.PlanDataUpdateListener.updateAllPlansWithFullVerification();
      } else {
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œæ‰§è¡Œå•æ¬¡éªŒè¯
        performVerification(this.currentModuleId, false, true); // ä¼ é€’æ¨¡å—IDï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯æŒç»­éªŒè¯æ¨¡å¼
      }
      
      // æ›´æ–°æœ€åå¤„ç†çš„æœŸæ•°
      if (window.r && window.r.length > 0) {
        this.lastProcessedPeriod = window.r[0].period;
      }
    }
  };
  
  // å°†ç®¡ç†å™¨æš´éœ²åˆ°å…¨å±€
  window.VerificationTaskManager = VerificationTaskManager;
  
  // ç”Ÿæˆè®¡åˆ’å”¯ä¸€å“ˆå¸Œå‡½æ•°
  function generatePlanHash(planNumbers, moduleState) {
    try {
      // æ„å»ºå®Œæ•´çš„åšå·æ¡ä»¶ä¿¡æ¯
      const conditions = {
        numbers: Array.isArray(planNumbers) ? [...planNumbers].sort() : [], // æ’åºç¡®ä¿ä¸€è‡´æ€§
        selectedNumbers: (moduleState.selectedNumbers || []).sort(),
        betMultiple: moduleState.betMultiple || 1,
        periods: moduleState.periods || 1,
        moduleType: `${moduleState.starLevel || 5}æ˜Ÿåšå·`,
        moduleToleranceMin: moduleState.moduleToleranceMin || 0,
        moduleToleranceMax: moduleState.moduleToleranceMax || 0,
        // åŒ…å«æ¯ä¸ªä½ç½®çš„è¯¦ç»†æ¡ä»¶
        groups: (moduleState.groups || []).map(g => ({
          selectedNumbers: (g.selectedNumbers || []).sort(),
          selectedDamas: (g.selectedDamas || []).sort(),
          toleranceMin: g.toleranceMin || 0,
          toleranceMax: g.toleranceMax || 0
        }))
      };
      
      // ç”ŸæˆåŸºäºå®Œæ•´æ¡ä»¶çš„å“ˆå¸Œå­—ç¬¦ä¸²
      const hashString = JSON.stringify(conditions);
      let hash = 0;
      for (let i = 0; i < hashString.length; i++) {
        const char = hashString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
      }
      return Math.abs(hash).toString(36);
    } catch (error) {
      console.error('ç”Ÿæˆè®¡åˆ’å“ˆå¸Œæ—¶å‡ºé”™:', error);
      // è¿”å›ä¸€ä¸ªåŸºäºæ—¶é—´æˆ³çš„ç®€å•å“ˆå¸Œ
      return `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
  }
  
  // æ£€æŸ¥è®¡åˆ’æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜²é‡å¤ï¼‰
  function isPlanDuplicate(planHash) {
    if (!window.verifyPlanData || !planHash) return false;
    
    return window.verifyPlanData.some(plan => 
      plan.planHash === planHash || 
      (plan.generationConditions && plan.generationConditions.planHash === planHash)
    );
  }
  
  // è®¡åˆ’å­˜å‚¨ç®¡ç†å™¨
  window.PlanStorageManager = {
    // å­˜å‚¨è®¡åˆ’
    storePlan: function(verifyRecord, isVerified = true) {
      // åªä¿å­˜å·²éªŒè¯çš„è®¡åˆ’
      if (!isVerified) {
        console.log('â¸ï¸ è®¡åˆ’æœªéªŒè¯ï¼Œè·³è¿‡ä¿å­˜:', verifyRecord.planHash);
        return false;
      }
      
      // ç¡®ä¿å…¨å±€å˜é‡å­˜åœ¨
      if (typeof window.verifyPlanData === 'undefined') {
        window.verifyPlanData = [];
      }
      
      // å¦‚æœæ£€æµ‹åˆ°é‡å¤ï¼Œåˆ™æ›´æ–°å·²å­˜åœ¨çš„è®°å½•å¹¶ç½®é¡¶æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯æ‹¦æˆª
      const idx = window.verifyPlanData.findIndex(plan => 
        plan.planHash === verifyRecord.planHash || 
        (plan.generationConditions && plan.generationConditions.planHash === verifyRecord.planHash)
      );
      if (idx >= 0) {
        // ç”¨æœ€æ–°è®°å½•æ›¿æ¢æ—§è®°å½•ï¼Œå¹¶ç§»åŠ¨åˆ°æ•°ç»„æœ€å‰
        window.verifyPlanData.splice(idx, 1);
        window.verifyPlanData.unshift(verifyRecord);
        console.log('ğŸ”„ æ£€æµ‹åˆ°é‡å¤è®¡åˆ’ï¼Œå·²æ›´æ–°å¹¶ç½®é¡¶:', verifyRecord.planHash);
        
        // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.saveToLocalStorage();
        
        return true;
      }
      
      // æ–°è®¡åˆ’ï¼Œç›´æ¥æ’å…¥åˆ°æœ€å‰
      window.verifyPlanData.unshift(verifyRecord);
      console.log('âœ… è®¡åˆ’å·²å­˜å‚¨ï¼Œå½“å‰æ€»æ•°:', window.verifyPlanData.length);
      
      // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      this.saveToLocalStorage();
      
      // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
      if (typeof window.updateSinglePeriodTable === 'function') {
        window.updateSinglePeriodTable();
      }
      
      return true;
    },
    
    // åˆ é™¤è®¡åˆ’
    deletePlan: function(planId) {
      if (!window.verifyPlanData) return false;
      
      const originalLength = window.verifyPlanData.length;
      window.verifyPlanData = window.verifyPlanData.filter(plan => plan.planId !== planId);
      
      const deleted = originalLength > window.verifyPlanData.length;
      if (deleted) {
        console.log('ğŸ—‘ï¸ è®¡åˆ’å·²åˆ é™¤:', planId);
      }
      return deleted;
    },
    
    // è·å–æ‰€æœ‰è®¡åˆ’
    getAllPlans: function() {
      return window.verifyPlanData || [];
    },
    
    // æ ¹æ®å“ˆå¸ŒæŸ¥æ‰¾è®¡åˆ’
    findPlanByHash: function(planHash) {
      if (!window.verifyPlanData) return null;
      return window.verifyPlanData.find(plan => plan.planHash === planHash);
    },
    
    // æ¸…ç©ºæ‰€æœ‰è®¡åˆ’
    clearAllPlans: function() {
      window.verifyPlanData = [];
      console.log('ğŸ§¹ æ‰€æœ‰è®¡åˆ’å·²æ¸…ç©º');
      // åŒæ—¶æ¸…ç©ºæœ¬åœ°å­˜å‚¨
      this.saveToLocalStorage();
    },

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveToLocalStorage: function() {
      try {
        const dataToSave = {
          verifyPlanData: window.verifyPlanData || [],
          timestamp: new Date().toISOString(),
          version: '1.0'
        };
        localStorage.setItem('twpk_verify_plan_data', JSON.stringify(dataToSave));
        console.log('ğŸ’¾ è®¡åˆ’éªŒè¯å†å²å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå…±', dataToSave.verifyPlanData.length, 'æ¡è®°å½•');
        return true;
      } catch (error) {
        console.error('âŒ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
        return false;
      }
    },

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    loadFromLocalStorage: function(skipVerification = false, batchSize = 50) {
      try {
        const savedData = localStorage.getItem('twpk_verify_plan_data');
        if (!savedData) {
          console.log('ğŸ“‚ æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰æ‰¾åˆ°è®¡åˆ’éªŒè¯å†å²');
          return false;
        }

        const parsedData = JSON.parse(savedData);
        if (parsedData && Array.isArray(parsedData.verifyPlanData)) {
          const totalPlans = parsedData.verifyPlanData.length;
          
          // å¦‚æœè®¡åˆ’æ•°é‡è¾ƒå°‘ï¼Œç›´æ¥åŠ è½½
          if (totalPlans <= batchSize) {
            window.verifyPlanData = parsedData.verifyPlanData;
            console.log('ğŸ“‚ ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¡åˆ’éªŒè¯å†å²æˆåŠŸï¼Œå…±', totalPlans, 'æ¡è®°å½•');
            console.log('ğŸ“… æ•°æ®ä¿å­˜æ—¶é—´:', parsedData.timestamp);
            
            // å¦‚æœä¸è·³è¿‡éªŒè¯ï¼Œåˆ™æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
            if (!skipVerification && typeof window.updateSinglePeriodTable === 'function') {
              // å»¶è¿Ÿæ‰§è¡ŒéªŒè¯ï¼Œé¿å…é¡µé¢åˆ·æ–°æ—¶ç«‹å³å¡é¡¿
              setTimeout(() => {
                console.log('ğŸ”„ å»¶è¿Ÿæ‰§è¡ŒéªŒè¯é€»è¾‘ï¼Œé¿å…é¡µé¢åˆ·æ–°å¡é¡¿');
                window.updateSinglePeriodTable();
              }, 500); // å»¶è¿Ÿ500ms
            } else if (skipVerification) {
              console.log('â­ï¸ è·³è¿‡éªŒè¯é€»è¾‘ï¼Œä»…åŠ è½½æ•°æ®');
            }
            
            return true;
          }
          
          // å¤§é‡æ•°æ®æ—¶ä½¿ç”¨æ‰¹é‡åŠ è½½
          console.log('ğŸ“Š æ£€æµ‹åˆ°å¤§é‡è®¡åˆ’æ•°æ®(' + totalPlans + 'æ¡)ï¼Œå¯ç”¨æ‰¹é‡åŠ è½½ä¼˜åŒ–');
          
          // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
          window.verifyPlanData = [];
          
          // åˆ†æ‰¹åŠ è½½æ•°æ®
          this.loadDataInBatches(parsedData.verifyPlanData, batchSize, skipVerification);
          
          console.log('ğŸ“‚ æ‰¹é‡åŠ è½½å·²å¯åŠ¨ï¼Œæ•°æ®ä¿å­˜æ—¶é—´:', parsedData.timestamp);
          return true;
        } else {
          console.warn('âš ï¸ æœ¬åœ°å­˜å‚¨æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          return false;
        }
      } catch (error) {
        console.error('âŒ ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', error);
        return false;
      }
    },

    // æ‰¹é‡åŠ è½½æ•°æ®çš„è¾…åŠ©å‡½æ•°
    loadDataInBatches: function(allData, batchSize, skipVerification) {
      let currentIndex = 0;
      const totalBatches = Math.ceil(allData.length / batchSize);
      
      const loadNextBatch = () => {
        const endIndex = Math.min(currentIndex + batchSize, allData.length);
        const batch = allData.slice(currentIndex, endIndex);
        
        // å°†æ‰¹æ¬¡æ•°æ®æ·»åŠ åˆ°å…¨å±€æ•°ç»„
        window.verifyPlanData.push(...batch);
        
        const currentBatch = Math.floor(currentIndex / batchSize) + 1;
        console.log(`ğŸ“¦ æ‰¹æ¬¡ ${currentBatch}/${totalBatches} åŠ è½½å®Œæˆ (${batch.length}æ¡è®°å½•)`);
        
        currentIndex = endIndex;
        
        // å¦‚æœè¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œç»§ç»­åŠ è½½ä¸‹ä¸€æ‰¹
        if (currentIndex < allData.length) {
          // ä½¿ç”¨ requestAnimationFrame æ¥é¿å…é˜»å¡UI
          requestAnimationFrame(() => {
            setTimeout(loadNextBatch, 10); // å°å»¶è¿Ÿé¿å…å¡é¡¿
          });
        } else {
          // æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ
          console.log('âœ… æ‰€æœ‰æ•°æ®æ‰¹é‡åŠ è½½å®Œæˆï¼Œå…±', window.verifyPlanData.length, 'æ¡è®°å½•');
          
          // å¦‚æœä¸è·³è¿‡éªŒè¯ï¼Œåˆ™æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
          if (!skipVerification && typeof window.updateSinglePeriodTable === 'function') {
            setTimeout(() => {
              console.log('ğŸ”„ æ‰¹é‡åŠ è½½å®Œæˆåæ‰§è¡ŒéªŒè¯é€»è¾‘');
              window.updateSinglePeriodTable();
            }, 100);
          }
        }
      };
      
      // å¼€å§‹åŠ è½½ç¬¬ä¸€æ‰¹
      loadNextBatch();
    },

    // å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶
    exportToFile: function() {
      try {
        const dataToExport = {
          verifyPlanData: window.verifyPlanData || [],
          exportTime: new Date().toISOString(),
          version: '1.0'
        };
        
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `twpk_verify_plan_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('ğŸ“¤ è®¡åˆ’éªŒè¯å†å²å·²å¯¼å‡ºåˆ°æ–‡ä»¶ï¼Œå…±', dataToExport.verifyPlanData.length, 'æ¡è®°å½•');
        return true;
      } catch (error) {
        console.error('âŒ å¯¼å‡ºåˆ°æ–‡ä»¶å¤±è´¥:', error);
        return false;
      }
    },

    // ä»æ–‡ä»¶å¯¼å…¥æ•°æ®
    importFromFile: function(file) {
      return new Promise((resolve, reject) => {
        if (!file) {
          reject(new Error('æœªé€‰æ‹©æ–‡ä»¶'));
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData && Array.isArray(importedData.verifyPlanData)) {
              // åˆå¹¶æ•°æ®ï¼Œé¿å…é‡å¤
              const existingHashes = new Set((window.verifyPlanData || []).map(plan => plan.planHash));
              const newPlans = importedData.verifyPlanData.filter(plan => !existingHashes.has(plan.planHash));
              
              if (!window.verifyPlanData) {
                window.verifyPlanData = [];
              }
              
              // å°†æ–°è®¡åˆ’æ·»åŠ åˆ°ç°æœ‰æ•°æ®å‰é¢
              window.verifyPlanData = [...newPlans, ...window.verifyPlanData];
              
              // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
              this.saveToLocalStorage();
              
              // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
              if (typeof window.updateSinglePeriodTable === 'function') {
                window.updateSinglePeriodTable();
              }
              
              console.log('ğŸ“¥ ä»æ–‡ä»¶å¯¼å…¥è®¡åˆ’éªŒè¯å†å²æˆåŠŸ');
              console.log('ğŸ“Š å¯¼å…¥', newPlans.length, 'æ¡æ–°è®°å½•ï¼Œæ€»è®¡', window.verifyPlanData.length, 'æ¡è®°å½•');
              console.log('ğŸ“… å¯¼å…¥æ•°æ®æ—¶é—´:', importedData.exportTime);
              
              resolve({
                imported: newPlans.length,
                total: window.verifyPlanData.length,
                skipped: importedData.verifyPlanData.length - newPlans.length
              });
            } else {
              reject(new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'));
            }
          } catch (error) {
            reject(new Error('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message));
          }
        };
        
        reader.onerror = () => {
          reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
        };
        
        reader.readAsText(file);
      });
    },
    
    // è‡ªåŠ¨éªŒè¯æ‰€æœ‰è®¡åˆ’çš„ä¸­æŒ‚æƒ…å†µ
    autoVerifyAllPlans: function(newPeriodData) {
      if (!window.verifyPlanData || window.verifyPlanData.length === 0) {
        return { updated: 0, results: [] };
      }
      
      console.log('ğŸ”„ å¼€å§‹è‡ªåŠ¨éªŒè¯æ‰€æœ‰è®¡åˆ’ï¼Œæ–°æœŸæ•°æ®:', newPeriodData);
      
      let updatedCount = 0;
      const results = [];
      
      // è·å–æ‰€æœ‰å¯ç”¨çš„å†å²æ•°æ®æº
      const allHistoryData = window.r || window.historyData || [];
      console.log('ğŸ“Š å¯ç”¨å†å²æ•°æ®:', allHistoryData.length, 'æœŸ');
      
      window.verifyPlanData.forEach(plan => {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦éªŒè¯è¿™ä¸ªè®¡åˆ’
        if (!plan.planNumbers || !plan.period) {
          return;
        }
        
        // åœ¨æ‰€æœ‰å†å²æ•°æ®ä¸­æŸ¥æ‰¾åŒ¹é…çš„æœŸæ•°
        let matchedData = null;
        
        // é¦–å…ˆæ£€æŸ¥æ–°ä¼ å…¥çš„æ•°æ®
        if (newPeriodData && newPeriodData.data && plan.period === newPeriodData.period) {
          matchedData = newPeriodData;
          console.log(`ğŸ“ è®¡åˆ’ ${plan.planId} åŒ¹é…æ–°æ•°æ®æœŸæ•°: ${newPeriodData.period}`);
        }
        
        // å¦‚æœæ–°æ•°æ®æ²¡æœ‰åŒ¹é…ï¼Œåœ¨å†å²æ•°æ®ä¸­æŸ¥æ‰¾
        if (!matchedData && allHistoryData.length > 0) {
          const historyMatch = allHistoryData.find(item => item.period === plan.period);
          if (historyMatch) {
            matchedData = historyMatch;
            console.log(`ğŸ“ è®¡åˆ’ ${plan.planId} åŒ¹é…å†å²æ•°æ®æœŸæ•°: ${historyMatch.period}`);
          }
        }
        
        // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„æ•°æ®ï¼Œè¿›è¡ŒéªŒè¯
        if (matchedData && matchedData.data) {
          const drawNumbers = matchedData.data;
          let isWin = false;
          
          // éªŒè¯äº”æ˜Ÿå·ç 
          for (const numberSet of plan.planNumbers) {
            if (numberSet && numberSet.length === 5) {
              // æ£€æŸ¥å‰äº”ä½æ˜¯å¦å®Œå…¨åŒ¹é…
              const match = numberSet.every((num, index) => 
                drawNumbers[index] && drawNumbers[index].toString() === num.toString()
              );
              if (match) {
                isWin = true;
                console.log(`ğŸ¯ è®¡åˆ’ ${plan.planId} ä¸­å¥–å·ç : ${numberSet.join('')} åŒ¹é…å¼€å¥–: ${drawNumbers.slice(0, 5).join('')}`);
                break;
              }
            }
          }
          
          const newResult = isWin ? 'ä¸­' : 'æŒ‚';
          const oldResult = plan.result;
          
          // æ›´æ–°éªŒè¯ç»“æœ
          plan.result = newResult;
          plan.latestData = drawNumbers;
          plan.winningNumber = drawNumbers.slice(0, 5).join('');
          plan.autoVerifiedAt = new Date().toISOString();
          plan.verifiedPeriod = matchedData.period;
          
          if (oldResult !== newResult) {
            updatedCount++;
            results.push({
              planId: plan.planId,
              period: plan.period,
              oldResult: oldResult,
              newResult: newResult,
              betCount: plan.betCount,
              verifiedPeriod: matchedData.period
            });
            
            console.log(`ğŸ“Š è®¡åˆ’ ${plan.planId} éªŒè¯ç»“æœæ›´æ–°: ${oldResult} -> ${newResult} (æœŸæ•°: ${matchedData.period})`);
          } else if (!oldResult) {
            // é¦–æ¬¡éªŒè¯
            updatedCount++;
            results.push({
              planId: plan.planId,
              period: plan.period,
              oldResult: 'æœªéªŒè¯',
              newResult: newResult,
              betCount: plan.betCount,
              verifiedPeriod: matchedData.period
            });
            
            console.log(`ğŸ“Š è®¡åˆ’ ${plan.planId} é¦–æ¬¡éªŒè¯ç»“æœ: ${newResult} (æœŸæ•°: ${matchedData.period})`);
          }
        } else {
          console.log(`âš ï¸ è®¡åˆ’ ${plan.planId} æœªæ‰¾åˆ°åŒ¹é…çš„æœŸæ•°æ•°æ®: ${plan.period}`);
        }
      });
      
      if (updatedCount > 0) {
        console.log(`âœ… è‡ªåŠ¨éªŒè¯å®Œæˆï¼Œæ›´æ–°äº† ${updatedCount} ä¸ªè®¡åˆ’çš„ç»“æœ`);
        
        // è§¦å‘è¡¨æ ¼æ›´æ–°
        if (typeof window.updateVerifyPlanTable === 'function') {
          window.updateVerifyPlanTable();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        if (typeof updateStatistics === 'function') {
          updateStatistics();
        }
      }
      
      return { updated: updatedCount, results: results };
    },
    
    // å¯¹æ‰€æœ‰è®¡åˆ’è¿›è¡Œå†å²æ•°æ®å…¨é‡éªŒè¯ - æ¯ä¸ªè®¡åˆ’éªŒè¯æ‰€æœ‰å†å²æœŸæ•°
    verifyAllPlansAgainstHistory: function() {
      if (!window.verifyPlanData || window.verifyPlanData.length === 0) {
        console.log('ğŸ“ æ²¡æœ‰è®¡åˆ’éœ€è¦éªŒè¯');
        return { updated: 0, results: [] };
      }
      
      // è·å–æ‰€æœ‰å¯ç”¨çš„å†å²æ•°æ®æº
      const allHistoryData = window.r || window.historyData || [];
      if (!allHistoryData || allHistoryData.length === 0) {
        console.log('ğŸ“Š æ²¡æœ‰å†å²æ•°æ®å¯ç”¨äºéªŒè¯');
        return { updated: 0, results: [] };
      }
      
      console.log(`ğŸ” å¼€å§‹å¯¹ ${window.verifyPlanData.length} ä¸ªè®¡åˆ’è¿›è¡Œå…¨å†å²æœŸæ•°éªŒè¯`);
      console.log(`ğŸ“Š å¯ç”¨å†å²æ•°æ®: ${allHistoryData.length} æœŸ`);
      
      let updatedCount = 0;
      const results = [];
      
      window.verifyPlanData.forEach(plan => {
        // æ£€æŸ¥è®¡åˆ’æ˜¯å¦æœ‰æ•ˆ
        if (!plan.planNumbers || plan.planNumbers.length === 0) {
          console.log(`âš ï¸ è·³è¿‡æ— æ•ˆè®¡åˆ’: ${plan.planId}`);
          return;
        }
        
        // è·³è¿‡å·²å®ŒæˆéªŒè¯çš„è®¡åˆ’
        if (plan.isCompleted) {
          console.log(`âœ… è·³è¿‡å·²å®ŒæˆéªŒè¯çš„è®¡åˆ’: ${plan.planId} (ç»“æœ: ${plan.result})`);
          return;
        }
        
        console.log(`ğŸ” éªŒè¯è®¡åˆ’ ${plan.planId} å¯¹æ‰€æœ‰ ${allHistoryData.length} æœŸå†å²æ•°æ®`);
        
        // åˆå§‹åŒ–è®¡åˆ’çš„éªŒè¯ç»“æœç»Ÿè®¡
        let totalWins = 0;
        let totalPeriods = 0;
        let winningPeriods = [];
        let winningNumbers = [];
        
        // éå†æ‰€æœ‰å†å²æœŸæ•°è¿›è¡ŒéªŒè¯
        allHistoryData.forEach(periodData => {
          if (!periodData || !periodData.data || !periodData.period) {
            return;
          }
          
          const drawNumbers = periodData.data.slice(0, 5); // å–å‰äº”ä½
          let periodWin = false;
          let winningNumber = null;
          
          // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
          for (const numberStr of plan.planNumbers) {
            let numbers;
            
            // å¤„ç†ä¸åŒæ ¼å¼çš„å·ç 
            if (typeof numberStr === 'string') {
              // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒæŒ‰ç©ºæ ¼åˆ†å‰²
              numbers = numberStr.split(' ').map(n => parseInt(n.trim()));
            } else if (Array.isArray(numberStr)) {
              // å¦‚æœå·²ç»æ˜¯æ•°ç»„
              numbers = numberStr.map(n => parseInt(n));
            } else {
              continue;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„äº”æ˜Ÿå·ç 
            if (numbers.length === 5 && numbers.every(n => !isNaN(n))) {
              // æ£€æŸ¥å‰äº”ä½æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆé¡ºåºä¸€è‡´ï¼‰
              const exactMatch = numbers.every((n, idx) => drawNumbers[idx] && drawNumbers[idx].toString() === n.toString());
              
              if (exactMatch) {
                periodWin = true;
                winningNumber = numbers.join(' ');
                console.log(`ğŸ‰ è®¡åˆ’ ${plan.planId} åœ¨æœŸæ•° ${periodData.period} ä¸­å¥–ï¼å·ç : ${winningNumber}, å¼€å¥–å‰äº”: ${drawNumbers.join(',')}`);
                break; // åªè¦æœ‰ä¸€æ³¨å‘½ä¸­å°±åœæ­¢æ£€æŸ¥è¯¥æœŸ
              }
            }
          }
          
          totalPeriods++;
          if (periodWin) {
            totalWins++;
            winningPeriods.push({
              period: periodData.period,
              winningNumber: winningNumber,
              drawNumbers: drawNumbers.join('')
            });
          }
        });
        
        // æ›´æ–°è®¡åˆ’çš„éªŒè¯ç»“æœ
        const oldResult = plan.result;
        const newResult = totalWins > 0 ? `ä¸­${totalWins}æœŸ` : 'å…¨æŒ‚';
        
        // æ›´æ–°è®¡åˆ’ä¿¡æ¯
        plan.result = newResult;
        plan.isCompleted = true; // æ ‡è®°ä¸ºå·²å®ŒæˆéªŒè¯
        plan.totalWins = totalWins;
        plan.totalPeriods = totalPeriods;
        plan.winningPeriods = winningPeriods;
        plan.winRate = totalPeriods > 0 ? ((totalWins / totalPeriods) * 100).toFixed(2) + '%' : '0%';
        plan.autoVerifiedAt = new Date().toISOString();
        plan.historyVerified = true;
        plan.verificationDetails = {
          totalPeriods: totalPeriods,
          totalWins: totalWins,
          winRate: plan.winRate,
          winningPeriods: winningPeriods
        };
        
        if (oldResult !== newResult || !oldResult) {
          updatedCount++;
          results.push({
            planId: plan.planId,
            period: plan.period || 'å¤šæœŸ',
            oldResult: oldResult || 'æœªéªŒè¯',
            newResult: newResult,
            betCount: plan.betCount,
            totalWins: totalWins,
            totalPeriods: totalPeriods,
            winRate: plan.winRate,
            isHistoryVerification: true,
            winningPeriods: winningPeriods
          });
          
          console.log(`ğŸ“Š è®¡åˆ’ ${plan.planId} å…¨å†å²éªŒè¯ç»“æœ: ${oldResult || 'æœªéªŒè¯'} -> ${newResult} (${totalWins}/${totalPeriods}æœŸä¸­å¥–ï¼Œèƒœç‡${plan.winRate})`);
        }
      });
      
      if (updatedCount > 0) {
        console.log(`âœ… å…¨å†å²æœŸæ•°éªŒè¯å®Œæˆï¼Œæ›´æ–°äº† ${updatedCount} ä¸ªè®¡åˆ’çš„ç»“æœ`);
        
        // ä¿å­˜æ›´æ–°åçš„è®¡åˆ’æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        if (typeof window.PlanStorageManager !== 'undefined' && window.PlanStorageManager.saveToLocalStorage) {
          window.PlanStorageManager.saveToLocalStorage();
          console.log('ğŸ’¾ å·²ä¿å­˜æ›´æ–°åçš„è®¡åˆ’éªŒè¯çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨');
        }
        
        // è§¦å‘è¡¨æ ¼æ›´æ–°
        if (typeof window.updateVerifyPlanTable === 'function') {
          window.updateVerifyPlanTable();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        if (typeof updateStatistics === 'function') {
          updateStatistics();
        }
      } else {
        console.log('ğŸ“Š å…¨å†å²æœŸæ•°éªŒè¯å®Œæˆï¼Œæ²¡æœ‰ç»“æœéœ€è¦æ›´æ–°');
      }
      
      return { updated: updatedCount, results: results };
    }
  };
  
  // æ•°æ®æ›´æ–°ç›‘å¬å™¨
  window.PlanDataUpdateListener = {
    // ç›‘å¬å†å²æ•°æ®æ›´æ–°
    onHistoryDataUpdate: function(newData) {
      if (!newData || newData.length === 0) return;
      
      console.log('ğŸ“¡ æ£€æµ‹åˆ°å†å²æ•°æ®æ›´æ–°ï¼Œå¼€å§‹å…¨æœŸéªŒè¯è®¡åˆ’æ›´æ–°');
      
      // å¯¹æ‰€æœ‰è®¡åˆ’è¿›è¡Œå…¨æœŸé‡æ–°éªŒè¯
      this.updateAllPlansWithFullVerification();
      
      // å¦‚æœå½“å‰åœ¨å•æœŸéªŒè¯æ¨¡å¼ï¼Œæ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
      const singlePeriodTable = document.getElementById('singlePeriodTable');
      if (singlePeriodTable && !singlePeriodTable.classList.contains('hidden')) {
        console.log('ğŸ“¡ å¤šæœŸéªŒè¯æ•°æ®æ›´æ–°ï¼ŒåŒæ­¥æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼');
        window.updateSinglePeriodTable();
        console.log('ğŸ“¡ å•æœŸéªŒè¯è¡¨æ ¼åŒæ­¥æ›´æ–°å®Œæˆ');
      } else {
        console.log('ğŸ“¡ å½“å‰ä¸åœ¨å•æœŸéªŒè¯æ¨¡å¼ï¼Œè·³è¿‡å•æœŸéªŒè¯è¡¨æ ¼æ›´æ–°');
      }
    },
    
    // å¯¹æ‰€æœ‰è®¡åˆ’è¿›è¡Œå…¨æœŸé‡æ–°éªŒè¯
    updateAllPlansWithFullVerification: function() {
      if (!window.verifyPlanData || window.verifyPlanData.length === 0) {
        console.log('ğŸ“Š æ²¡æœ‰éªŒè¯è®¡åˆ’éœ€è¦æ›´æ–°');
        return;
      }
      
      // è·å–å½“å‰å†å²æ•°æ®
      const dataSource = window.r || window.historyData;
      if (!dataSource || dataSource.length === 0) {
        console.log('ğŸ“Š æ²¡æœ‰å†å²æ•°æ®ï¼Œæ— æ³•è¿›è¡Œå…¨æœŸéªŒè¯');
        return;
      }
      
      console.log(`ğŸ“Š å¼€å§‹å¯¹ ${window.verifyPlanData.length} ä¸ªè®¡åˆ’è¿›è¡Œå…¨æœŸé‡æ–°éªŒè¯`);
      let updatedCount = 0;
      
      window.verifyPlanData.forEach(plan => {
        if (!plan.planNumbers || plan.planNumbers.length === 0) return;
        
        // å¯¹è¯¥è®¡åˆ’è¿›è¡Œå…¨æœŸéªŒè¯
        let totalWins = 0;
        let totalPeriods = 0;
        let winningPeriods = [];
        
        dataSource.forEach(periodData => {
          if (!periodData || !periodData.data || !periodData.period) return;
          
          const drawNumbers = periodData.data.slice(0, 5); // å–å‰äº”ä½
          let periodWin = false;
          let winningNumber = null;
          
          // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
          for (const numberStr of plan.planNumbers) {
            const numbers = numberStr.split(' ').map(n => parseInt(n.trim()));
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„äº”æ˜Ÿå·ç 
        if (numbers.length === 5 && numbers.every(n => !isNaN(n))) {
          // ä¸¥æ ¼åˆ¤å®šï¼šå‰äº”ä½é¡ºåºå®Œå…¨ä¸€è‡´æ‰ç®—ä¸­
          const exactMatch = numbers.every((num, idx) => num === drawNumbers.slice(0, 5)[idx]);
          
          if (exactMatch) {
            periodWin = true;
            winningNumber = numberStr;
            break; // åªè¦æœ‰ä¸€æ³¨å‘½ä¸­å°±åœæ­¢æ£€æŸ¥è¯¥æœŸ
          }
        }
          }
          
          totalPeriods++;
          if (periodWin) {
            totalWins++;
            winningPeriods.push({
              period: periodData.period,
              winningNumber: winningNumber,
              drawNumbers: drawNumbers.join('')
            });
          }
        });
        
        // æ›´æ–°è®¡åˆ’çš„éªŒè¯ç»“æœ
        const oldResult = plan.result;
        const oldTotalWins = plan.totalWins || 0;
        
        plan.result = totalWins > 0 ? `ä¸­${totalWins}æœŸ` : 'å…¨æŒ‚';
        plan.totalWins = totalWins;
        plan.totalPeriods = totalPeriods;
        plan.winRate = totalPeriods > 0 ? ((totalWins / totalPeriods) * 100).toFixed(2) + '%' : '0%';
        plan.winningPeriods = winningPeriods;
        plan.winningNumber = winningPeriods.length > 0 ? winningPeriods[0].winningNumber : null;
        
        // æ›´æ–°éªŒè¯è¯¦æƒ…
        plan.verificationDetails = {
          totalPeriods: totalPeriods,
          totalWins: totalWins,
          winRate: plan.winRate,
          winningPeriods: winningPeriods
        };
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if (oldResult !== plan.result || oldTotalWins !== totalWins) {
          updatedCount++;
          console.log(`ğŸ“Š è®¡åˆ’ ${plan.planId} éªŒè¯ç»“æœæ›´æ–°: ${oldResult} -> ${plan.result}`);
        }
      });
      
      if (updatedCount > 0) {
        console.log(`âœ… å…¨æœŸéªŒè¯æ›´æ–°å®Œæˆï¼Œæ›´æ–°äº† ${updatedCount} ä¸ªè®¡åˆ’çš„ç»“æœ`);
        
        // ä¿å­˜æ›´æ–°åçš„è®¡åˆ’æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        if (typeof window.PlanStorageManager !== 'undefined' && window.PlanStorageManager.saveToLocalStorage) {
          window.PlanStorageManager.saveToLocalStorage();
          console.log('ğŸ’¾ å·²ä¿å­˜æ›´æ–°åçš„è®¡åˆ’éªŒè¯çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨');
        }
        
        // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼
        if (typeof window.updateVerifyPlanTable === 'function') {
          window.updateVerifyPlanTable();
        }
        
        // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
        this.showUpdateNotification({ updated: updatedCount, totalWins: window.verifyPlanData.reduce((sum, p) => sum + (p.totalWins || 0), 0) });
      } else {
        console.log('ğŸ“Š å…¨æœŸéªŒè¯å®Œæˆï¼Œæ²¡æœ‰æ–°çš„ç»“æœéœ€è¦æ›´æ–°');
      }
    },
    
    // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
    showUpdateNotification: function(verifyResult) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        background: #2196F3;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 350px;
      `;
      
      // ç»Ÿè®¡å…¨æœŸéªŒè¯ç»“æœ
      const totalPlans = window.verifyPlanData ? window.verifyPlanData.length : 0;
      const winningPlans = window.verifyPlanData ? window.verifyPlanData.filter(p => (p.totalWins || 0) > 0).length : 0;
      const losingPlans = totalPlans - winningPlans;
      const totalWins = verifyResult.totalWins || 0;
      
      notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“Š å…¨æœŸéªŒè¯æ›´æ–°å®Œæˆ</div>
        <div>æ›´æ–°äº† ${verifyResult.updated} ä¸ªè®¡åˆ’</div>
        <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
          æœ‰ä¸­å¥–: ${winningPlans} ä¸ª | å…¨æŒ‚: ${losingPlans} ä¸ª
        </div>
        <div style="font-size: 12px; margin-top: 3px; opacity: 0.9;">
          æ€»ä¸­å¥–æœŸæ•°: ${totalWins} æœŸ
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 6000);
    }
  };

  // è·å–å½“å‰æ¨¡å—IDçš„å‡½æ•°
  function getCurrentModuleId() {
    // æ–¹æ³•1ï¼šæŸ¥æ‰¾æ‰€æœ‰å­˜åœ¨çš„æ¨¡å—
    const allModules = document.querySelectorAll('[id^="module"]');
    
    // æ–¹æ³•2ï¼šå¦‚æœæ— æ³•é€šè¿‡äº‹ä»¶ç¡®å®šï¼Œåˆ™æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯è§çš„æ¨¡å—
    for (const module of allModules) {
      if (module.style.display !== 'none' && !module.hidden) {
        return module.id.replace('module', '');
      }
    }
    
    // é»˜è®¤è¿”å›æ¨¡å—1
    return '1';
  }

  function performVerification(moduleId = null, isRetry = false, isContinuous = false) {
    console.log('=== è‡ªåŠ¨éªŒè¯å¼€å§‹ ===');
    
    // è·å–å½“å‰æ¨¡å—æ ‡è¯†
    const currentModuleId = moduleId || getCurrentModuleId();
    console.log('å½“å‰æ¨¡å—ID:', currentModuleId);
    
    // è·å–æŒ‡å®šæ¨¡å—çš„çŠ¶æ€
    const targetModuleState = window.moduleStates[currentModuleId];
    if (!targetModuleState) {
      console.error(`æ¨¡å—${currentModuleId}çš„çŠ¶æ€ä¸å­˜åœ¨`);
      return;
    }
    
    // è·å–æŒ‡å®šæ¨¡å—çš„DOMå…ƒç´ 
    const targetModule = document.getElementById(`module${currentModuleId}`);
    if (!targetModule) {
      console.error(`æ¨¡å—${currentModuleId}çš„DOMå…ƒç´ ä¸å­˜åœ¨`);
      return;
    }
    
    const targetResultCount = targetModule.querySelector('.result-count');
    
    console.log('å½“å‰æ¨¡å—çŠ¶æ€results:', targetModuleState.results);
    console.log('å½“å‰ræ•°ç»„:', r);
    console.log('ræ•°ç»„é•¿åº¦:', r ? r.length : 'ræœªå®šä¹‰');
    console.log('æ˜¯å¦ä¸ºé‡è¯•:', isRetry);
    console.log('æ˜¯å¦ä¸ºæŒç»­éªŒè¯æ¨¡å¼:', isContinuous);
    
    if (targetModuleState.results.length === 0) {
      if (targetResultCount) {
        targetResultCount.innerHTML = '<span style="color: red;">æ²¡æœ‰å¯éªŒè¯çš„ç»“æœ</span>';
        setTimeout(() => {
          targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
        }, 2000);
      }
      return;
    }
    
    // æ˜¾ç¤ºéªŒè¯è¿›åº¦
    if (targetResultCount) {
      targetResultCount.innerHTML = '<span style="color: blue;">ğŸ”„ æ­£åœ¨è‡ªåŠ¨éªŒè¯...</span>';
    }
    
    // è·å–æœ€æ–°æœŸæ•°æ®
    if (!r || r.length === 0) {
      if (isRetry) {
        // å¦‚æœæ˜¯é‡è¯•ä¸”ä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œåˆ™åœæ­¢é€’å½’
        console.log('é‡è¯•åä»æ— æ•°æ®ï¼Œåœæ­¢éªŒè¯');
        if (targetResultCount) {
          targetResultCount.innerHTML = '<span style="color: red;">æ— æ³•è·å–å†å²æ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®</span>';
          setTimeout(() => {
            targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
          }, 3000);
        }
        return;
      }
      
      console.log('éªŒè¯å¤±è´¥ï¼šræ•°ç»„ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œå°è¯•é‡æ–°è·å–å†å²æ•°æ®');
      if (targetResultCount) {
        targetResultCount.innerHTML = '<span style="color: orange;">æ­£åœ¨è·å–å†å²æ•°æ®ï¼Œè¯·ç¨å€™...</span>';
      }
      
      // å°è¯•é‡æ–°è·å–å†å²æ•°æ®
      if (typeof fetchHistoryData === 'function') {
        fetchHistoryData().then(() => {
          console.log('å†å²æ•°æ®é‡æ–°è·å–å®Œæˆï¼Œræ•°ç»„é•¿åº¦:', r ? r.length : 0);
          if (r && r.length > 0) {
            // æ•°æ®è·å–æˆåŠŸï¼Œé‡æ–°æ‰§è¡ŒéªŒè¯é€»è¾‘ï¼ˆæ ‡è®°ä¸ºé‡è¯•ï¼‰
            setTimeout(() => {
              performVerification(currentModuleId, true); // ä¼ é€’æ¨¡å—IDï¼Œæ ‡è®°ä¸ºé‡è¯•ï¼Œé˜²æ­¢æ— é™é€’å½’
            }, 500);
          } else {
            if (targetResultCount) {
              targetResultCount.innerHTML = '<span style="color: red;">æ— æ³•è·å–å†å²æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</span>';
              setTimeout(() => {
                targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
              }, 3000);
            }
          }
        }).catch(err => {
          console.error('é‡æ–°è·å–å†å²æ•°æ®å¤±è´¥:', err);
          if (targetResultCount) {
            targetResultCount.innerHTML = '<span style="color: red;">è·å–å†å²æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>';
            setTimeout(() => {
              targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
            }, 3000);
          }
        });
      } else {
        if (targetResultCount) {
          targetResultCount.innerHTML = '<span style="color: red;">æ²¡æœ‰æ•°æ®åˆ†ææ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®</span>';
          setTimeout(() => {
            targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
          }, 3000);
        }
      }
      return;
    }
    
    // è·å–è®¡åˆ’å·ç 
    const planNumbers = targetModuleState.results;
    console.log('è®¡åˆ’å·ç :', planNumbers);
    console.log(`å¼€å§‹éªŒè¯è®¡åˆ’å¯¹æ‰€æœ‰ ${r.length} æœŸå†å²æ•°æ®`);
    
    // éªŒè¯æ‰€æœ‰å†å²æœŸæ•°
    let totalWins = 0;
    let totalPeriods = 0;
    let winningPeriods = [];
    let latestPeriod = r[0]; // ä¿ç•™æœ€æ–°æœŸç”¨äºè®°å½•
    
    r.forEach(periodData => {
      if (!periodData || !periodData.data || !periodData.period) {
        return;
      }
      
      const drawNumbers = periodData.data.slice(0, 5); // å–å‰äº”ä½ä½œä¸ºå¼€å¥–å·ç 
      let periodWin = false;
      let winningNumber = null;
      
      // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
      for (const numberStr of planNumbers) {
        const numbers = numberStr.split(' ').map(n => parseInt(n.trim())); // äº”æ˜Ÿåšå·æ ¼å¼æ˜¯ç©ºæ ¼åˆ†éš”
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„äº”æ˜Ÿå·ç 
        if (numbers.length === 5 && numbers.every(n => !isNaN(n))) {
          // ä¸¥æ ¼åˆ¤å®šï¼šå‰äº”ä½é¡ºåºå®Œå…¨ä¸€è‡´æ‰ç®—ä¸­
          const exactMatch = numbers.every((num, idx) => num === drawNumbers.slice(0, 5)[idx]);
          
          if (exactMatch) {
            periodWin = true;
            winningNumber = numberStr;
            console.log(`ğŸ‰ æœŸæ•° ${periodData.period} å‘½ä¸­ï¼ˆé¡ºåºå®Œå…¨ä¸€è‡´ï¼‰ï¼å·ç : ${winningNumber}, å¼€å¥–å‰äº”: ${drawNumbers.slice(0, 5).join(',')}`);
            break; // åªè¦æœ‰ä¸€æ³¨å‘½ä¸­å°±åœæ­¢æ£€æŸ¥è¯¥æœŸ
          }
        }
      }
      
      totalPeriods++;
      if (periodWin) {
        totalWins++;
        winningPeriods.push({
          period: periodData.period,
          winningNumber: winningNumber,
          drawNumbers: drawNumbers.join(',')
        });
      }
    });
    
    console.log(`éªŒè¯å®Œæˆï¼š${totalWins}/${totalPeriods}æœŸä¸­å¥–`);
    console.log('ä¸­å¥–æœŸæ•°è¯¦æƒ…:', winningPeriods);
    
    // è·å–å½“å‰æ¨¡å—çš„ç”Ÿæˆæ¡ä»¶
    const moduleState = window.moduleStates[currentModuleId];
    const groups = (moduleState && Array.isArray(moduleState.groups)) ? moduleState.groups.map(g => ({
      selectedNumbers: Array.isArray(g.selectedNumbers) ? [...g.selectedNumbers] : [],
      selectedDamas: Array.isArray(g.selectedDamas) ? [...g.selectedDamas] : [],
      toleranceMin: typeof g.toleranceMin === 'number' ? g.toleranceMin : 0,
      toleranceMax: typeof g.toleranceMax === 'number' ? g.toleranceMax : 0,
    })) : [];
    const flatSelectedNumbers = groups.reduce((acc, g) => acc.concat(g.selectedNumbers || []), []);
    const generationConditions = {
      selectedNumbers: flatSelectedNumbers,
      betMultiple: (moduleState && typeof moduleState.betMultiple !== 'undefined') ? moduleState.betMultiple : 1,
      periods: (moduleState && typeof moduleState.periods !== 'undefined') ? moduleState.periods : 1,
      moduleType: `${moduleState.starLevel || 5}æ˜Ÿåšå·`,
      moduleId: currentModuleId,
      moduleToleranceMin: moduleState && typeof moduleState.moduleToleranceMin === 'number' ? moduleState.moduleToleranceMin : 0,
      moduleToleranceMax: moduleState && typeof moduleState.moduleToleranceMax === 'number' ? moduleState.moduleToleranceMax : 0,
      groups: groups,
      generatedAt: new Date().toISOString(),
      planHash: generatePlanHash(planNumbers, moduleState) // ç”Ÿæˆè®¡åˆ’å”¯ä¸€å“ˆå¸Œ
    };
    
    // åˆ›å»ºéªŒè¯è®¡åˆ’è®°å½• - ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯
    const verifyRecord = {
      period: latestPeriod.period, // æœ€æ–°æœŸæ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
      planNumbers: planNumbers,
      betCount: planNumbers.length,
      result: totalWins > 0 ? `ä¸­${totalWins}æœŸ` : 'å…¨æŒ‚', // æ˜¾ç¤ºä¸­å¥–æœŸæ•°
      isCompleted: true, // æ ‡è®°ä¸ºå·²å®ŒæˆéªŒè¯
      totalWins: totalWins,
      totalPeriods: totalPeriods,
      winRate: totalPeriods > 0 ? ((totalWins / totalPeriods) * 100).toFixed(2) + '%' : '0%',
      // åªä¿ç•™æœ€é‡è¦çš„ä¸­å¥–æœŸæ•°ä¿¡æ¯ï¼ˆæœ€å¤šä¿ç•™3æœŸï¼‰
      winningPeriods: winningPeriods.slice(0, 3),
      latestData: latestPeriod.data,
      winningNumber: winningPeriods.length > 0 ? winningPeriods[0].winningNumber : null,
      timestamp: new Date().toLocaleString(),
      moduleId: currentModuleId, // ä¿ç•™æ¨¡å—æ ‡è¯†ç”¨äºå†…éƒ¨é€»è¾‘
      planId: `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // æ·»åŠ å”¯ä¸€è®¡åˆ’ID
      // ç®€åŒ–ç”Ÿæˆæ¡ä»¶ï¼Œåªä¿ç•™æ ¸å¿ƒä¿¡æ¯
      generationConditions: {
        planHash: generationConditions.planHash,
        moduleId: generationConditions.moduleId,
        timestamp: generationConditions.timestamp
      },
      planHash: generationConditions.planHash // è®¡åˆ’å”¯ä¸€æ ‡è¯†
    };
    console.log('åˆ›å»ºçš„éªŒè¯è®°å½•:', verifyRecord);
    
    // å¦‚æœæ˜¯æŒç»­éªŒè¯æ¨¡å¼ï¼Œæ›´æ–°ç®¡ç†å™¨çš„æœ€åå¤„ç†æœŸæ•°
    if (isContinuous && window.VerificationTaskManager) {
      window.VerificationTaskManager.lastProcessedPeriod = latestPeriod.period;
      console.log('ğŸ”„ æŒç»­éªŒè¯æ¨¡å¼ï¼šå·²æ›´æ–°æœ€åå¤„ç†æœŸæ•°ä¸º', latestPeriod.period);
    }
    
    // ä½¿ç”¨è®¡åˆ’å­˜å‚¨ç®¡ç†å™¨å­˜å‚¨è®¡åˆ’ï¼ˆå·²éªŒè¯ï¼‰
    const isStored = window.PlanStorageManager.storePlan(verifyRecord, true);
    
    if (!isStored) {
      // ç†è®ºä¸Šä¸ä¼šè¿›å…¥è¿™é‡Œï¼ŒstorePlan å¯¹é‡å¤è®¡åˆ’ä¼šæ›´æ–°å¹¶è¿”å› true
      console.log('âš ï¸ è®¡åˆ’å­˜å‚¨æœªæˆåŠŸ');
      if (targetResultCount) {
        targetResultCount.innerHTML = '<span style="color: orange;">âš ï¸ è®¡åˆ’å­˜å‚¨æœªæˆåŠŸ</span>';
      }
      setTimeout(() => {
        if (targetResultCount) {
          targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
        }
      }, 3000);
      // ä¸ returnï¼Œç»§ç»­åç»­æ¸²æŸ“
    }
    
    console.log('éªŒè¯è®¡åˆ’æ•°æ®å·²æ›´æ–°:', window.verifyPlanData);
    
    // ç«‹å³å¯¹æ–°æäº¤çš„è®¡åˆ’è¿›è¡Œå†å²æ•°æ®å…¨é‡éªŒè¯
    console.log('ğŸ” å¼€å§‹å¯¹æ–°æäº¤çš„è®¡åˆ’è¿›è¡Œå†å²æ•°æ®éªŒè¯...');
    if (window.PlanDataUpdateListener && typeof window.PlanDataUpdateListener.verifyAllPlansAgainstHistory === 'function') {
      const historyVerifyResult = window.PlanDataUpdateListener.verifyAllPlansAgainstHistory();
      console.log('ğŸ“Š å†å²æ•°æ®éªŒè¯ç»“æœ:', historyVerifyResult);
      
      if (historyVerifyResult.updated > 0) {
        console.log(`âœ… å†å²æ•°æ®éªŒè¯å®Œæˆï¼Œæ›´æ–°äº† ${historyVerifyResult.updated} ä¸ªè®¡åˆ’çš„ç»“æœ`);
        
        // æ˜¾ç¤ºå†å²éªŒè¯ç»“æœæç¤º
        if (targetResultCount) {
          const historyResults = historyVerifyResult.results.filter(r => r.isHistoryVerification);
          if (historyResults.length > 0) {
            const winCount = historyResults.filter(r => r.newResult === 'ä¸­').length;
            const loseCount = historyResults.filter(r => r.newResult === 'æŒ‚').length;
            const pendingCount = historyResults.filter(r => r.newResult === 'å¾…å¼€å¥–').length;
            
            let historyMessage = 'ğŸ“Š å†å²éªŒè¯: ';
            if (winCount > 0) historyMessage += `${winCount}ä¸­ `;
            if (loseCount > 0) historyMessage += `${loseCount}æŒ‚ `;
            if (pendingCount > 0) historyMessage += `${pendingCount}å¾…å¼€å¥–`;
            
            targetResultCount.innerHTML += `<br><span style="color: blue; font-size: 12px;">${historyMessage}</span>`;
          }
        }
      } else {
        console.log('ğŸ“Š å†å²æ•°æ®éªŒè¯å®Œæˆï¼Œæ²¡æœ‰æ–°çš„ç»“æœéœ€è¦æ›´æ–°');
      }
    } else {
      console.warn('âš ï¸ å†å²æ•°æ®éªŒè¯åŠŸèƒ½ä¸å¯ç”¨');
    }
    
    // è‡ªåŠ¨è¾“å‡ºéªŒè¯ç»“æœåˆ°æ§åˆ¶å°å’Œé¡µé¢
    const resultOutput = generateVerifyResultOutput(verifyRecord);
    console.log('\n=== è‡ªåŠ¨éªŒè¯ç»“æœè¾“å‡º ===');
    console.log(resultOutput.console);
    
    // æ˜¾ç¤ºéªŒè¯ç»“æœ - å…¨æœŸéªŒè¯ç»“æœ
    if (targetResultCount) {
      if (totalWins > 0) {
        targetResultCount.innerHTML = `<span style="color: green;">âœ… éªŒè¯å®Œæˆï¼${totalWins}/${totalPeriods}æœŸä¸­å¥– (${verifyRecord.winRate})</span>`;
      } else {
        targetResultCount.innerHTML = `<span style="color: red;">âŒ éªŒè¯å®Œæˆï¼Œå…¨éƒ¨${totalPeriods}æœŸæœªä¸­å¥–</span>`;
      }
    }
    
    // æ ¹æ®éªŒè¯æ¨¡å¼å†³å®šæ˜¯å¦åˆ‡æ¢é¡µé¢
    if (!isContinuous) {
      // å•æ¬¡éªŒè¯æ¨¡å¼ï¼šæ™ºèƒ½å¤„ç†é¡µé¢åˆ‡æ¢å’Œæ•°æ®æ›´æ–°
      
      // æ£€æŸ¥éªŒè¯è®¡åˆ’æ•°æ®è·å–æœåŠ¡æ˜¯å¦å·²ç»åœ¨è¿è¡Œ
      const isVerifyPlanServiceRunning = window.verifyPlanDataTimer || window.verifyPlanUpdateInterval;
      
      if (isVerifyPlanServiceRunning) {
        // å¦‚æœéªŒè¯è®¡åˆ’æœåŠ¡å·²ç»åœ¨è¿è¡Œï¼Œåªæ›´æ–°æ•°æ®ï¼Œä¸åˆ‡æ¢é¡µé¢
        console.log('éªŒè¯è®¡åˆ’æœåŠ¡å·²è¿è¡Œï¼Œç›´æ¥æ›´æ–°æ•°æ®ï¼Œæ— éœ€åˆ‡æ¢é¡µé¢');
        
        // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼
        if (typeof window.updateVerifyPlanTable === 'function') {
          window.updateVerifyPlanTable();
        }
        
        // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
        if (typeof window.updateSinglePeriodTable === 'function') {
          window.updateSinglePeriodTable();
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        if (targetResultCount) {
          targetResultCount.innerHTML = `<span style="color: green;">âœ… è®¡åˆ’å·²æ·»åŠ åˆ°éªŒè¯åˆ—è¡¨</span>`;
        }
      } else {
        // å¦‚æœéªŒè¯è®¡åˆ’æœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡ä½†ä¸åˆ‡æ¢é¡µé¢
        console.log('é¦–æ¬¡éªŒè¯ï¼Œå¯åŠ¨éªŒè¯è®¡åˆ’æœåŠ¡ä½†ä¿æŒåœ¨å½“å‰é¡µé¢');
        
        // å¯åŠ¨éªŒè¯è®¡åˆ’é¡µé¢çš„æ•°æ®è·å–æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
        if (typeof startVerifyPlanDataFetch === 'function') {
          startVerifyPlanDataFetch();
        }
        
        // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼æ•°æ®ï¼ˆåå°æ›´æ–°ï¼‰
        if (typeof window.updateVerifyPlanTable === 'function') {
          window.updateVerifyPlanTable();
        }
        
        // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
        if (typeof window.updateSinglePeriodTable === 'function') {
          window.updateSinglePeriodTable();
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œä¸è·³è½¬é¡µé¢
        if (targetResultCount) {
          targetResultCount.innerHTML = `<span style="color: green;">âœ… éªŒè¯å®Œæˆï¼è®¡åˆ’å·²æ·»åŠ åˆ°éªŒè¯åˆ—è¡¨</span>`;
        }
      }
    } else {
      // æŒç»­éªŒè¯æ¨¡å¼ï¼šåªæ›´æ–°æ•°æ®ï¼Œä¸åˆ‡æ¢é¡µé¢
      console.log('æŒç»­éªŒè¯æ¨¡å¼ï¼šæ›´æ–°æ•°æ®ä½†ä¸åˆ‡æ¢é¡µé¢');
      
      // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼ï¼ˆå¦‚æœå½“å‰åœ¨éªŒè¯è®¡åˆ’é¡µé¢ï¼‰
      if (typeof window.updateVerifyPlanTable === 'function') {
        window.updateVerifyPlanTable();
      }
      
      // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
      if (typeof window.updateSinglePeriodTable === 'function') {
        window.updateSinglePeriodTable();
      }
    }
    
    // æ¢å¤åŸå§‹æ˜¾ç¤º
    setTimeout(() => {
      if (targetResultCount) {
        targetResultCount.textContent = `å…±${targetModuleState.results.length}æ³¨`;
      }
    }, 5000);
  }



  // æ¸…ç†éå½“å‰ç”¨æˆ·è®¡åˆ’çš„å‡½æ•°
  function cleanupNonUserPlans() {
    if (!window.verifyPlanData || window.verifyPlanData.length === 0) {
      return;
    }
    
    // è·å–å½“å‰æ—¶é—´æˆ³ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰ä¼šè¯çš„è®¡åˆ’
    const currentTime = new Date().getTime();
    const sessionStartTime = window.sessionStartTime || currentTime;
    
    // å¦‚æœæ²¡æœ‰è®¾ç½®ä¼šè¯å¼€å§‹æ—¶é—´ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´
    if (!window.sessionStartTime) {
      window.sessionStartTime = currentTime;
    }
    
    // è¿‡æ»¤æ‰éå½“å‰ä¼šè¯çš„è®¡åˆ’ï¼ˆä¿ç•™æœ€è¿‘1å°æ—¶å†…åˆ›å»ºçš„è®¡åˆ’ï¼‰
    const oneHourAgo = currentTime - (60 * 60 * 1000);
    const originalCount = window.verifyPlanData.length;
    
    window.verifyPlanData = window.verifyPlanData.filter(plan => {
      // æ£€æŸ¥è®¡åˆ’çš„ç”Ÿæˆæ—¶é—´
      if (plan.generationConditions && plan.generationConditions.generatedAt) {
        const planTime = new Date(plan.generationConditions.generatedAt).getTime();
        return planTime > oneHourAgo;
      }
      
      // æ£€æŸ¥è®¡åˆ’çš„æ—¶é—´æˆ³
      if (plan.timestamp) {
        const planTime = new Date(plan.timestamp).getTime();
        return planTime > oneHourAgo;
      }
      
      // å¦‚æœæ²¡æœ‰æ—¶é—´ä¿¡æ¯ï¼Œä¿ç•™è®¡åˆ’
      return true;
    });
    
    const cleanedCount = originalCount - window.verifyPlanData.length;
    if (cleanedCount > 0) {
      console.log(`ğŸ§¹ æ¸…ç†äº† ${cleanedCount} ä¸ªæ—§è®¡åˆ’ï¼Œå½“å‰å‰©ä½™ ${window.verifyPlanData.length} ä¸ªè®¡åˆ’`);
      
      // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
      if (typeof updateSinglePeriodTable === 'function') {
        updateSinglePeriodTable();
      }
    }
  }

  // ç›´æ¥æäº¤åˆ°å•æœŸéªŒè¯çš„å‡½æ•°
  function submitToSinglePeriodVerification(moduleId, moduleState, onComplete) {
    console.log('=== æäº¤åˆ°å•æœŸéªŒè¯å¼€å§‹ ===');
    
    try {
    
    // æ¸…ç†éå½“å‰ç”¨æˆ·çš„æ—§è®¡åˆ’
    cleanupNonUserPlans();
    
    // è·å–è®¡åˆ’å·ç 
    const planNumbers = moduleState.results;
    console.log('è®¡åˆ’å·ç :', planNumbers);
    
    // è·å–å½“å‰æ¨¡å—çš„ç”Ÿæˆæ¡ä»¶
    const groups = (moduleState && Array.isArray(moduleState.groups)) ? moduleState.groups.map(g => ({
      selectedNumbers: Array.isArray(g.selectedNumbers) ? [...g.selectedNumbers] : [],
      selectedDamas: Array.isArray(g.selectedDamas) ? [...g.selectedDamas] : [],
      toleranceMin: typeof g.toleranceMin === 'number' ? g.toleranceMin : 0,
      toleranceMax: typeof g.toleranceMax === 'number' ? g.toleranceMax : 0,
    })) : [];
    
    const flatSelectedNumbers = groups.reduce((acc, g) => acc.concat(g.selectedNumbers || []), []);
    const generationConditions = {
      selectedNumbers: flatSelectedNumbers,
      betMultiple: (moduleState && typeof moduleState.betMultiple !== 'undefined') ? moduleState.betMultiple : 1,
      periods: (moduleState && typeof moduleState.periods !== 'undefined') ? moduleState.periods : 1,
      moduleType: `${moduleState.starLevel || 5}æ˜Ÿåšå·`,
      moduleId: moduleId,
      moduleToleranceMin: moduleState && typeof moduleState.moduleToleranceMin === 'number' ? moduleState.moduleToleranceMin : 0,
      moduleToleranceMax: moduleState && typeof moduleState.moduleToleranceMax === 'number' ? moduleState.moduleToleranceMax : 0,
      groups: groups,
      generatedAt: new Date().toISOString(),
      planHash: generatePlanHash(planNumbers, moduleState) // ç”Ÿæˆè®¡åˆ’å”¯ä¸€å“ˆå¸Œ
    };
    
    // æ„å»ºæ¡ä»¶æ˜¾ç¤ºæ–‡æœ¬
    const allSelectedNumbers = [];
    const allSelectedDamas = [];
    
    groups.forEach(g => {
      const numbers = Array.isArray(g.selectedNumbers) ? g.selectedNumbers : [];
      const damas = Array.isArray(g.selectedDamas) ? g.selectedDamas : [];
      
      // æ”¶é›†æ‰€æœ‰é€‰æ‹©çš„æ•°å­—ï¼ˆå»é‡ï¼‰
      numbers.forEach(num => {
        if (!allSelectedNumbers.includes(num)) {
          allSelectedNumbers.push(num);
        }
      });
      
      // æ”¶é›†æ‰€æœ‰èƒ†ç ï¼ˆå»é‡ï¼‰
      damas.forEach(dama => {
        if (!allSelectedDamas.includes(dama)) {
          allSelectedDamas.push(dama);
        }
      });
    });
    
    // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
    const parts = [];
    if (allSelectedNumbers.length > 0) {
      allSelectedNumbers.sort((a, b) => parseInt(a) - parseInt(b));
      parts.push(allSelectedNumbers.join(','));
    }
    if (allSelectedDamas.length > 0) {
      allSelectedDamas.sort((a, b) => parseInt(a) - parseInt(b));
      parts.push(`ä¸­${allSelectedDamas.join(',')}èƒ†`);
    }
    
    // æ·»åŠ æ€»å®¹é”™ä¿¡æ¯
    const moduleToleranceMin = generationConditions.moduleToleranceMin || 0;
    const moduleToleranceMax = generationConditions.moduleToleranceMax || 0;
    if (moduleToleranceMin !== 0 || moduleToleranceMax !== 0) {
      if (moduleToleranceMin === moduleToleranceMax) {
        parts.push(`æ€»å®¹é”™${moduleToleranceMin}`);
      } else {
        parts.push(`æ€»å®¹é”™${moduleToleranceMin}-${moduleToleranceMax}`);
      }
    }
    
    const displayName = parts.join(' ') || `æ¨¡å—${moduleId}è®¡åˆ’`;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è®¡åˆ’
    const existingPlan = window.verifyPlanData && window.verifyPlanData.find(plan => 
      plan.planHash === generationConditions.planHash
    );
    
    if (existingPlan) {
      console.log('âš ï¸ æ£€æµ‹åˆ°é‡å¤è®¡åˆ’:', displayName);
      
      // æ˜¾ç¤ºé‡å¤æç¤º
      const targetModule = document.getElementById(`module${moduleId}`);
      const targetResultCount = targetModule ? targetModule.querySelector('.result-count') : null;
      if (targetResultCount) {
        targetResultCount.innerHTML = `<span style="color: orange;">âš ï¸ é‡å¤è®¡åˆ’ï¼Œå·²å­˜åœ¨ç›¸åŒæ¡ä»¶çš„éªŒè¯</span>`;
        setTimeout(() => {
          targetResultCount.textContent = `å…±${moduleState.results.length}æ³¨`;
        }, 3000);
      }
      return;
    }
    
    // åˆ›å»ºéªŒè¯è®¡åˆ’è®°å½•
    // è®¡ç®—æäº¤æ—¶çš„åŸºå‡†æœŸå·ä¸ç›®æ ‡æœŸï¼ˆä¸‹ä¸€æœŸï¼‰
    let dataSource = (window.r && window.r.length > 0) ? window.r : ((window.historyData && window.historyData.length > 0) ? window.historyData : []);
    let latestPeriod = '';
    if (Array.isArray(dataSource) && dataSource.length > 0) {
      const sorted = dataSource.slice().sort((a, b) => parseInt(b.period) - parseInt(a.period));
      latestPeriod = sorted[0] && sorted[0].period ? sorted[0].period.toString() : '';
    }
    const nextPeriod = latestPeriod ? calculateNextPeriod(latestPeriod) : '';
    const verifyRecord = {
      period: latestPeriod || '',
      targetPeriod: nextPeriod || '',
      planNumbers: planNumbers,
      betCount: planNumbers.length,
      result: 'å¾…éªŒè¯',
      totalWins: 0,
      totalPeriods: 0,
      winRate: '0%',
      winningPeriods: [],
      latestData: null,
      winningNumber: null,
      timestamp: new Date().toLocaleString(),
      moduleId: moduleId,
      planId: `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      generationConditions: generationConditions,
      planHash: generationConditions.planHash,
      displayName: displayName,
      isCompleted: false, // æ·»åŠ æ ‡å¿—ä½è®°å½•æ˜¯å¦å·²å®ŒæˆéªŒè¯
      verificationDetails: {
        totalPeriods: 0,
        totalWins: 0,
        winRate: '0%',
        winningPeriods: []
      }
    };
    
    // æ·»åŠ åˆ°éªŒè¯è®¡åˆ’æ•°æ®
    if (!window.verifyPlanData) {
      window.verifyPlanData = [];
    }
    
    window.verifyPlanData.unshift(verifyRecord);
    console.log('âœ… è®¡åˆ’å·²æäº¤åˆ°å•æœŸéªŒè¯:', displayName);
    console.log('å½“å‰éªŒè¯è®¡åˆ’æ•°é‡:', window.verifyPlanData.length);
    
    // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    if (window.PlanStorageManager && typeof window.PlanStorageManager.storePlan === 'function') {
      try {
        window.PlanStorageManager.storePlan(verifyRecord, true);
        console.log('âœ… è®¡åˆ’å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
      } catch (saveError) {
        console.error('ä¿å­˜è®¡åˆ’åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', saveError);
      }
    } else {
      console.warn('âš ï¸ PlanStorageManager ä¸å¯ç”¨ï¼Œæ— æ³•è‡ªåŠ¨ä¿å­˜');
    }
    
    console.log('ğŸ”„ è®¡åˆ’å·²æäº¤åˆ°å•æœŸéªŒè¯ï¼Œå°†åœ¨ä¸‹ä¸€æœŸè¿›è¡ŒéªŒè¯');
    
    // é‡ç½®å•æœŸéªŒè¯çŠ¶æ€ï¼Œç¡®ä¿æ¯æ¬¡æäº¤éƒ½æ˜¯æ–°çš„éªŒè¯å‘¨æœŸ
    resetSinglePeriodVerification();
    
    // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
    if (typeof updateSinglePeriodTable === 'function') {
      updateSinglePeriodTable();
    }
    
    console.log('=== æäº¤åˆ°å•æœŸéªŒè¯å®Œæˆ ===');
    
    // è°ƒç”¨å®Œæˆå›è°ƒ
    if (typeof onComplete === 'function') {
      onComplete(true, 'æäº¤æˆåŠŸ');
    }
    
    } catch (error) {
      console.error('æäº¤åˆ°å•æœŸéªŒè¯æ—¶å‡ºé”™:', error);
      
      // è°ƒç”¨å®Œæˆå›è°ƒï¼Œä¼ é€’é”™è¯¯ä¿¡æ¯
      if (typeof onComplete === 'function') {
        onComplete(false, error.message || 'æäº¤å¤±è´¥');
      }
    }
  }

  // éªŒè¯æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ - ç›´æ¥æäº¤åˆ°å•æœŸéªŒè¯
  verifyBtn.addEventListener('click', function() {
    // è·å–å½“å‰æ¨¡å—çš„çŠ¶æ€å’ŒDOMå…ƒç´ 
    const currentModuleState = window.moduleStates[moduleId];
    const currentResultCount = module.querySelector('.result-count');
    
    if (!currentModuleState || !currentResultCount) {
      console.error(`æ¨¡å—${moduleId}çŠ¶æ€æˆ–DOMå…ƒç´ ä¸å­˜åœ¨`);
      return;
    }
    
    if (currentModuleState.results.length === 0) {
      currentResultCount.innerHTML = '<span style="color: red;">æ²¡æœ‰å¯éªŒè¯çš„ç»“æœ</span>';
      setTimeout(() => {
        currentResultCount.textContent = `å…±${currentModuleState.results.length}æ³¨`;
      }, 2000);
      return;
    }
    
    console.log(`ğŸ¯ ç”¨æˆ·ç‚¹å‡»éªŒè¯æŒ‰é’®ï¼Œç›´æ¥æäº¤æ¨¡å—${moduleId}åˆ°å•æœŸéªŒè¯`);
    
    // æ˜¾ç¤ºæ­£åœ¨æäº¤çŠ¶æ€
    currentResultCount.innerHTML = '<span style="color: blue;">ğŸ”„ æ­£åœ¨æäº¤éªŒè¯...</span>';
    
    // ç›´æ¥æäº¤åˆ°å•æœŸéªŒè¯ï¼Œä½¿ç”¨å›è°ƒå¤„ç†ç»“æœ
    submitToSinglePeriodVerification(moduleId, currentModuleState, function(success, message) {
      const currentCount = currentModuleState.results.length;
      
      if (success) {
        // æ˜¾ç¤ºæäº¤æˆåŠŸçŠ¶æ€
        currentResultCount.innerHTML = `å…±${currentCount}æ³¨ <span style="color: green;">å·²æäº¤åˆ°å•æœŸéªŒè¯</span>`;
        
        // 3ç§’åç§»é™¤éªŒè¯æç¤ºï¼Œåªä¿ç•™æ³¨æ•°
        setTimeout(() => {
          currentResultCount.textContent = `å…±${currentModuleState.results.length}æ³¨`;
        }, 3000);
      } else {
        // æ˜¾ç¤ºæäº¤å¤±è´¥çŠ¶æ€
        currentResultCount.innerHTML = `<span style="color: red;">æäº¤å¤±è´¥: ${message}</span>`;
        
        // 3ç§’åæ¢å¤æ³¨æ•°æ˜¾ç¤º
        setTimeout(() => {
          currentResultCount.textContent = `å…±${currentModuleState.results.length}æ³¨`;
        }, 3000);
      }
    });
  });
  
  // ç”ŸæˆéªŒè¯ç»“æœè¾“å‡º
  function generateVerifyResultOutput(record) {
    const separator = '='.repeat(50);
    const timestamp = record.timestamp || new Date().toLocaleString();
    
    const consoleOutput = `
${separator}
ğŸ¯ è‡ªåŠ¨éªŒè¯ç»“æœæŠ¥å‘Š
${separator}
ğŸ“… éªŒè¯æ—¶é—´: ${timestamp}
ğŸ² å¼€å¥–æœŸæ•°: ${record.period}
ğŸ”¢ å¼€å¥–å·ç : ${record.latestData.join(' ')}
ğŸ“Š è®¡åˆ’æ³¨æ•°: ${record.betCount}æ³¨
ğŸ¯ éªŒè¯ç»“æœ: ${record.result}
${record.winningNumber ? `ğŸ† ä¸­å¥–å·ç : ${record.winningNumber}` : ''}

ğŸ“‹ è®¡åˆ’å·ç :
${record.planNumbers.map((num, index) => `  ${index + 1}. ${num}`).join('\n')}

ğŸ’¡ éªŒè¯è¯´æ˜: ${record.generationConditions?.moduleType || '5æ˜Ÿåšå·'}ç©æ³•éœ€è¦ç›¸åº”ä½ç½®å®Œå…¨åŒ¹é…å¼€å¥–å·ç å‰å‡ ä½
${separator}
    `;
    
    return {
      console: consoleOutput,
      summary: `æœŸæ•°:${record.period} | ç»“æœ:${record.result} | æ³¨æ•°:${record.betCount}`
    };
  }
  


  // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  clearBtn.addEventListener('click', function() {
    // ä¿®å¤ï¼šæŒ‰ç»„æ¸…é™¤é€‰ä¸­çŠ¶æ€
    moduleState.groups.forEach(group => {
        group.selectedNumbers = [];
        group.selectedDamas = [];
    });
    moduleState.results = [];
    moduleState.originalResults = [];
    moduleState.isReversed = false;
    
    // æ¸…é™¤æ‰€æœ‰æŒ‰é’®é€‰ä¸­çŠ¶æ€
    numberButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    damaButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    
    // æ¸…é™¤ç»“æœæ˜¾ç¤º
    resultInput.value = '';
    resultCount.textContent = 'å…±0æ³¨';
  });

  // åå‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä¿®æ”¹ä¸ºæ˜¾ç¤ºç­›é€‰ç»“æœçš„è¡¥é›†
  reverseBtn.addEventListener('click', function() {
    // æ£€æŸ¥æ˜¯å¦å·²ç”Ÿæˆç»“æœ
    if (moduleState.allPermutations.length === 0 || moduleState.originalResults.length === 0) {
      alert('è¯·å…ˆç‚¹å‡»"åšå·"ç”Ÿæˆç»“æœ');
      return;
    }

    // åˆ‡æ¢åå‘çŠ¶æ€
    if (!moduleState.isReversed) {
      // ç”ŸæˆåŸå§‹ç»“æœçš„è¡¥é›†ï¼ˆæ‰€æœ‰ç»„åˆä¸­æ’é™¤åŸå§‹ç»“æœï¼‰
      // åˆ›å»ºåŸå§‹ç»“æœçš„å­—ç¬¦ä¸²è¡¨ç¤ºé›†åˆç”¨äºå¿«é€ŸæŸ¥æ‰¾
      const originalSet = new Set(moduleState.originalResults);
      // ç­›é€‰å‡ºä¸åœ¨åŸå§‹ç»“æœä¸­çš„æ‰€æœ‰ç»„åˆï¼Œå¹¶æ ¼å¼åŒ–
      const complementResults = moduleState.allPermutations
        .filter(comb => {
          const formattedComb = comb.map(num => num.toString().padStart(2, '0')).join(' ');
          return !originalSet.has(formattedComb);
        })
        .map(comb => comb.map(num => num.toString().padStart(2, '0')).join(' '));
      moduleState.results = complementResults;
      moduleState.isReversed = true;
    } else {
      // æ¢å¤æ˜¾ç¤ºåŸå§‹ç»“æœ
      moduleState.results = moduleState.originalResults;
      moduleState.isReversed = false;
    }

    updateResultDisplay();
  });



  // æ›´æ–°ç»“æœæ˜¾ç¤º - ç‰ˆæœ¬2024.12.19
  function updateResultDisplay() {
    const totalCount = moduleState.results.length;
    const displayResults = totalCount > 200 ? moduleState.results.slice(0, 200) : moduleState.results;
    // ç»“æœå·²ç»æ˜¯æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼Œç›´æ¥ç”¨é€—å·è¿æ¥ï¼ˆé€—å·åä¸åŠ ç©ºæ ¼ï¼‰
    let displayText = '';
    for (let i = 0; i < displayResults.length; i++) {
      if (i > 0) displayText += ',';
      displayText += displayResults[i];
    }
    
    // ç«‹å³è®¾ç½®ç»“æœ
    resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    resultCount.textContent = `å…±${totalCount}æ³¨`;
    
    // å»¶è¿Ÿå†æ¬¡ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼ˆé˜²æ­¢è¢«å…¶ä»–ä»£ç è¦†ç›–ï¼‰
    setTimeout(() => {
      resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    }, 10);
    

  }

  // åšå·æ˜Ÿçº§é€‰æ‹©å™¨äº‹ä»¶å¤„ç†
  if (moduleStarButtons && moduleStarButtons.length > 0) {
    // æ˜Ÿçº§æè¿°æ˜ å°„
    const starDescriptions = {
      2: 'å½“å‰ï¼š2æ˜Ÿ - ä»10ä¸ªå·ç ä¸­é€‰æ‹©2ä¸ªå·ç ç»„æˆä¸€æ³¨',
      3: 'å½“å‰ï¼š3æ˜Ÿ - ä»10ä¸ªå·ç ä¸­é€‰æ‹©3ä¸ªå·ç ç»„æˆä¸€æ³¨',
      4: 'å½“å‰ï¼š4æ˜Ÿ - ä»10ä¸ªå·ç ä¸­é€‰æ‹©4ä¸ªå·ç ç»„æˆä¸€æ³¨',
      5: 'å½“å‰ï¼š5æ˜Ÿ - ä»10ä¸ªå·ç ä¸­é€‰æ‹©5ä¸ªå·ç ç»„æˆä¸€æ³¨'
    };

    moduleStarButtons.forEach(button => {
      button.addEventListener('click', function() {
        const selectedStar = parseInt(this.dataset.star);
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        moduleStarButtons.forEach(btn => {
          btn.classList.remove('bg-green-500', 'text-white', 'active', 'border-green-500');
          btn.classList.add('border-gray-200', 'text-gray-600');
          btn.style.borderWidth = '1px';
        });
        
        this.classList.remove('border-gray-200', 'text-gray-600');
        this.classList.add('bg-green-500', 'text-white', 'active', 'border-green-500');
        this.style.borderWidth = '2px';
        
        // æ›´æ–°æ¨¡å—çš„æ˜Ÿçº§è®¾ç½®
        moduleState.starLevel = selectedStar;
        
        // æ›´æ–°æè¿°
        if (moduleStarDescription) {
          moduleStarDescription.textContent = starDescriptions[selectedStar];
        }
        
        console.log(`æ¨¡å—${moduleId}æ˜Ÿçº§å·²åˆ‡æ¢åˆ°: ${selectedStar}æ˜Ÿ`);
      });
    });
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç°æœ‰æ¨¡å—
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–å…¨å±€æ˜Ÿçº§å˜é‡
  window.globalStarLevel = 5;
  
  // åˆå§‹åŒ–æ¨¡å—1å’Œæ¨¡å—2
  if (!window.moduleStates || !window.moduleStates[1]) {
    initFiveStarModule(1);
  }
  if (!window.moduleStates || !window.moduleStates[2]) {
    initFiveStarModule(2);
  }
  
  // åˆå§‹åŒ–æ˜Ÿçº§é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬å™¨
  initStarSelector();
  
  // åˆå§‹åŒ–æ¨¡å¼åˆ‡æ¢å™¨
  initModeSwitcher();
});

// æ˜Ÿçº§é€‰æ‹©å™¨åˆå§‹åŒ–å‡½æ•°
function initStarSelector() {
  const starButtons = document.querySelectorAll('.star-btn');
  
  starButtons.forEach(button => {
    button.addEventListener('click', function() {
      const selectedStar = parseInt(this.dataset.star);
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      starButtons.forEach(btn => {
        btn.classList.remove('bg-green-500', 'text-white', 'active', 'border-green-500');
        btn.classList.add('border-gray-200', 'text-gray-600');
        btn.style.borderWidth = '1px';
      });
      
      this.classList.remove('border-gray-200', 'text-gray-600');
      this.classList.add('bg-green-500', 'text-white', 'active', 'border-green-500');
      this.style.borderWidth = '2px';
      
      // æ›´æ–°å…¨å±€æ˜Ÿçº§è®¾ç½®ï¼ˆä¸è¦†ç›–æ¨¡å—çš„ç‹¬ç«‹è®¾ç½®ï¼‰
      if (window.globalStarLevel !== undefined) {
        window.globalStarLevel = selectedStar;
      }
      
      console.log(`æ‹¼æ¥åšå·æ˜Ÿçº§å·²åˆ‡æ¢åˆ°: ${selectedStar}æ˜Ÿ`);
    });
  });
  
  // åˆå§‹åŒ–å·ç æ˜¾ç¤ºåŒºåŸŸçš„æŒ‰é’®äº‹ä»¶
  initNumberDisplayButtons();
}

// åˆå§‹åŒ–å·ç æ˜¾ç¤ºåŒºåŸŸçš„æŒ‰é’®åŠŸèƒ½
function initNumberDisplayButtons() {
  // å…¨å±€å·ç å­˜å‚¨
  window.allGeneratedNumbers = [];
  
  // å¤åˆ¶æŒ‰é’®åŠŸèƒ½ï¼ˆæ ¹æ®æ¨¡å¼åˆ¤æ–­ï¼‰
  const copyBtn = document.getElementById('copyBtn');
  if (copyBtn) {
    copyBtn.addEventListener('click', function() {
      if (currentFiveStarMode === 'intersection') {
        // äº¤é›†æ¨¡å¼ï¼šå¤åˆ¶äº¤é›†ç»“æœ
        copyIntersectionNumbers();
      } else {
        // æ‹¼æ¥æ¨¡å¼ï¼šå¤åˆ¶æ‹¼æ¥ç»“æœ
        copyAllNumbers();
      }
    });
  }
  
  // éªŒè¯æŒ‰é’®åŠŸèƒ½ï¼ˆæ ¹æ®æ¨¡å¼åˆ¤æ–­ï¼‰
  const verifyBtn = document.getElementById('verifyBtn');
  if (verifyBtn) {
    verifyBtn.addEventListener('click', function() {
      if (currentFiveStarMode === 'intersection') {
        // äº¤é›†æ¨¡å¼ï¼šéªŒè¯äº¤é›†ç»“æœ
        verifyIntersectionNumbers();
      } else {
        // æ‹¼æ¥æ¨¡å¼ï¼šéªŒè¯æ‹¼æ¥ç»“æœ
        verifyNumbers();
      }
    });
  }
}

// ==================== äº¤é›†æ¨¡å¼åŠŸèƒ½ ====================

// å…¨å±€å˜é‡ï¼šå½“å‰æ¨¡å¼ ('concat' | 'intersection')
let currentFiveStarMode = 'concat';

// æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
function initModeSwitcher() {
  const concatModeBtn = document.getElementById('concatModeBtn');
  const intersectionModeBtn = document.getElementById('intersectionModeBtn');
  const concatLabel = document.getElementById('concatLabel');
  const starSelector = document.getElementById('starSelector');
  const toleranceLabel = document.getElementById('toleranceLabel');
  const toleranceSelector = document.getElementById('toleranceSelector');
  const actionBtn = document.getElementById('actionBtn');
  const numberDisplay = document.getElementById('numberDisplay');
  const numberCount = document.getElementById('numberCount');
  
  if (!concatModeBtn || !intersectionModeBtn) return;
  
  // æ‹¼æ¥æ¨¡å¼æŒ‰é’®
  concatModeBtn.addEventListener('click', function() {
    currentFiveStarMode = 'concat';
    
    // æ›´æ–°æ¨¡å¼æŒ‰é’®æ ·å¼
    concatModeBtn.classList.add('border-blue-500', 'bg-blue-500', 'text-white');
    concatModeBtn.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
    intersectionModeBtn.classList.remove('border-purple-500', 'bg-purple-500', 'text-white');
    intersectionModeBtn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
    
    // æ˜¾ç¤ºæ‹¼æ¥ç›¸å…³å…ƒç´ 
    if (concatLabel) concatLabel.classList.remove('hidden');
    if (starSelector) starSelector.classList.remove('hidden');
    
    // éšè—äº¤é›†ç›¸å…³å…ƒç´ 
    if (toleranceLabel) toleranceLabel.classList.add('hidden');
    if (toleranceSelector) toleranceSelector.classList.add('hidden');
    
    // ä¿®æ”¹æŒ‰é’®æ–‡å­—
    if (actionBtn) actionBtn.textContent = 'æ‹¼æ¥';
  });
  
  // äº¤é›†æ¨¡å¼æŒ‰é’®
  intersectionModeBtn.addEventListener('click', function() {
    currentFiveStarMode = 'intersection';
    
    // æ›´æ–°æ¨¡å¼æŒ‰é’®æ ·å¼
    intersectionModeBtn.classList.add('border-purple-500', 'bg-purple-500', 'text-white');
    intersectionModeBtn.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
    concatModeBtn.classList.remove('border-blue-500', 'bg-blue-500', 'text-white');
    concatModeBtn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
    
    // éšè—æ‹¼æ¥ç›¸å…³å…ƒç´ 
    if (concatLabel) concatLabel.classList.add('hidden');
    if (starSelector) starSelector.classList.add('hidden');
    
    // æ˜¾ç¤ºäº¤é›†ç›¸å…³å…ƒç´ 
    if (toleranceLabel) toleranceLabel.classList.remove('hidden');
    if (toleranceSelector) {
      toleranceSelector.classList.remove('hidden');
      toleranceSelector.classList.add('flex'); // ç¡®ä¿flexå¸ƒå±€
    }
    
    // ä¿®æ”¹æŒ‰é’®æ–‡å­—
    if (actionBtn) actionBtn.textContent = 'äº¤é›†';
    
    // æ¸…ç©ºæ˜¾ç¤ºåŒºåŸŸ
    if (numberDisplay) {
      numberDisplay.innerHTML = '<div class="text-gray-500 text-center py-8">è¯·é€‰æ‹©å®¹é”™å€¼å¹¶ç‚¹å‡»"äº¤é›†"</div>';
    }
    if (numberCount) {
      numberCount.textContent = 'å…± 0 æ³¨';
    }
    
    // æ¸…ç©ºäº¤é›†ç»“æœ
    window.intersectionResults = '';
  });
  
  // å®¹é”™æŒ‰é’®äº‹ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼Œç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€ï¼‰
  const toleranceBtns = document.querySelectorAll('.tolerance-btn');
  toleranceBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      if (this.classList.contains('border-blue-500')) {
        // å–æ¶ˆé€‰ä¸­
        this.classList.remove('border-blue-500', 'bg-blue-500', 'text-white');
        this.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
      } else {
        // é€‰ä¸­
        this.classList.add('border-blue-500', 'bg-blue-500', 'text-white');
        this.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
      }
    });
  });
  
  // ä¸»æ“ä½œæŒ‰é’®ï¼ˆæ‹¼æ¥/äº¤é›†ï¼‰
  if (actionBtn) {
    actionBtn.addEventListener('click', function() {
      if (currentFiveStarMode === 'intersection') {
        executeAutoIntersection();
      } else {
        // æ‹¼æ¥æ¨¡å¼
      const activeStarBtn = document.querySelector('.star-btn.active');
      const selectedStar = activeStarBtn ? parseInt(activeStarBtn.dataset.star) : 5;
      generateStarConcatenation(selectedStar);
      }
    });
  }
}

// æ‰«ææ‰€æœ‰æ¨¡å—ï¼ˆå®Œå…¨æŒ‰ç…§å·ç äº¤é›†é¡µé¢çš„é€»è¾‘ï¼‰
function scanAllModules() {
  const modules = [];
  
  // æ‰«æ8ä¸ªè¾“å…¥æ¨¡å—ï¼ˆä½¿ç”¨åšå·æ‹¼æ¥é¡µé¢çš„textareaé€‰æ‹©å™¨ï¼‰
  for (let i = 1; i <= 8; i++) {
    const textarea = document.querySelector(`textarea.result-input[data-module="${i}"]`);
    if (!textarea) {
      console.log(`æ¨¡å—${i}æœªæ‰¾åˆ°`);
      continue;
    }
    
    const content = textarea.value.trim();
    if (!content) {
      console.log(`æ¨¡å—${i}ä¸ºç©º`);
      continue;
    }
    
    // æŒ‰é€—å·åˆ†éš”ï¼Œç„¶åå»é™¤ç©ºæ ¼å’Œç©ºé¡¹ï¼ˆå®Œå…¨æŒ‰ç…§å·ç äº¤é›†é¡µé¢çš„é€»è¾‘ï¼‰
    const combinations = content.split(',').map(s => s.trim()).filter(Boolean);
    
    if (combinations.length === 0) {
      console.log(`æ¨¡å—${i}è§£æåä¸ºç©º`);
      continue;
    }
    
    console.log(`æ¨¡å—${i}è§£æç»“æœ: ${combinations.length}ä¸ªå·ç ç»„åˆï¼Œå‰3ä¸ª:`, combinations.slice(0, 3));
    
    modules.push(combinations);
  }
  
  console.log(`æ‰«æåˆ°${modules.length}ä¸ªæœ‰æ•ˆæ¨¡å—`);
  return modules;
}


// å¤šæ¨¡å—äº¤é›†ï¼ˆå®Œå…¨æŒ‰ç…§å·ç äº¤é›†é¡µé¢çš„é€»è¾‘ï¼‰
function performModuleIntersection(modules, tolerance) {
  if (modules.length === 0) return [];
  if (modules.length === 1) {
    console.log('åªæœ‰1ä¸ªæ¨¡å—ï¼Œç›´æ¥è¿”å›åŸæ•°æ®');
    return modules[0];
  }
  
  let result = [];
  
  if (tolerance === 0) {
    // ä¸¥æ ¼äº¤é›†ï¼šå·ç ç»„åˆå­—ç¬¦ä¸²å¿…é¡»åœ¨æ‰€æœ‰æ¨¡å—ä¸­éƒ½å‡ºç°
    // ç­‰åŒäºï¼šconst intersection = groupA.filter(x => groupB.includes(x));
    result = modules[0];
    for (let i = 1; i < modules.length; i++) {
      result = result.filter(x => modules[i].includes(x));
      console.log(`ä¸æ¨¡å—${i+1}ä¸¥æ ¼äº¤é›†: â†’ ${result.length}æ³¨`);
    }
  } else {
    // å®¹é”™äº¤é›†ï¼šå…è®¸åœ¨æŒ‡å®šæ•°é‡çš„æ¨¡å—ä¸­ç¼ºå¤±
    const allCombinations = [...new Set(modules.flat())];
    
    allCombinations.forEach(combination => {
      let appearCount = 0;
      modules.forEach(module => {
        if (module.includes(combination)) {
          appearCount++;
        }
      });
      
      // å¦‚æœç¼ºå¤±çš„æ¨¡å—æ•°é‡ä¸è¶…è¿‡å®¹é”™å€¼ï¼Œåˆ™åŒ…å«è¯¥å·ç ç»„åˆ
      const missingCount = modules.length - appearCount;
      if (missingCount <= tolerance) {
        result.push(combination);
      }
    });
    
    console.log(`å®¹é”™${tolerance}äº¤é›†: ${result.length}æ³¨ï¼ˆå…±${modules.length}ä¸ªæ¨¡å—ï¼‰`);
  }
  
  return result;
}

// æ‰§è¡Œè‡ªåŠ¨äº¤é›†
function executeAutoIntersection() {
  // è·å–æ‰€æœ‰é€‰ä¸­çš„å®¹é”™å€¼
  const selectedToleranceBtns = document.querySelectorAll('.tolerance-btn.bg-blue-500');
  const tolerances = Array.from(selectedToleranceBtns).map(btn => parseInt(btn.dataset.tolerance));
  
  // å¦‚æœæ²¡æœ‰é€‰æ‹©å®¹é”™å€¼ï¼Œä½¿ç”¨ç²¾ç¡®äº¤é›†ï¼ˆå®¹é”™0ï¼‰
  if (tolerances.length === 0) {
    tolerances.push(0);
    console.log('æœªé€‰æ‹©å®¹é”™å€¼ï¼Œä½¿ç”¨ç²¾ç¡®äº¤é›†ï¼ˆå®¹é”™0ï¼‰');
  }
  
  console.log(`å¼€å§‹æ‰§è¡Œè‡ªåŠ¨äº¤é›†ï¼Œå®¹é”™å€¼: ${tolerances.join(', ')}`);
  
  // æ‰«ææ‰€æœ‰æ¨¡å—ï¼ˆä¸åŒºåˆ†æ˜Ÿçº§ï¼‰
  const modules = scanAllModules();
  
  console.log('æ‰«æåˆ°çš„æ¨¡å—æ•°æ®:', modules);
  console.log('æ¨¡å—æ•°é‡:', modules.length);
  modules.forEach((mod, idx) => {
    console.log(`æ¨¡å—${idx+1}å·ç æ•°é‡:`, mod.length, 'å‰10ä¸ª:', mod.slice(0, 10));
  });
  
  if (modules.length === 0) {
    alert('âŒ æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ¨¡å—æ•°æ®\n\nè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¨¡å—ä¸­ç²˜è´´å·ç åå†è¯•');
    return;
  }
  
  if (modules.length === 1) {
    // åªæœ‰ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºè¯¥æ¨¡å—çš„æ•°æ®
    console.log('åªæœ‰1ä¸ªæ¨¡å—ï¼Œç›´æ¥æ˜¾ç¤º');
    const resultText = modules[0].join(',');
    const numberDisplay = document.getElementById('numberDisplay');
    const numberCount = document.getElementById('numberCount');
    
    if (numberDisplay) {
      numberDisplay.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm">${resultText}</pre>`;
    }
    if (numberCount) {
      numberCount.textContent = `å…± ${modules[0].length} æ³¨`;
    }
    window.intersectionResults = resultText;
    return;
  }
  
  console.log(`\nå¼€å§‹å¤„ç†äº¤é›†ï¼Œå…±${modules.length}ä¸ªæ¨¡å—`);
  
  // å¯¹æ¯ä¸ªå®¹é”™å€¼æ‰§è¡Œäº¤é›†
  let allCombinations = [];
  tolerances.forEach(tolerance => {
    const intersectionResult = performModuleIntersection(modules, tolerance);
    if (intersectionResult.length > 0) {
      allCombinations.push(...intersectionResult);
      console.log(`  å®¹é”™${tolerance}: ${intersectionResult.length}æ³¨`);
    }
  });
  
  // å»é‡
  const allResults = [...new Set(allCombinations)];
  
  // æ˜¾ç¤ºç»“æœ
  if (allResults.length === 0) {
    alert('âŒ äº¤é›†ç»“æœä¸ºç©º\n\nå¯èƒ½åŸå› ï¼š\n1. å„æ¨¡å—å·ç ç»„åˆå®Œå…¨ä¸åŒ\n2. å®¹é”™å€¼è®¾ç½®è¿‡å°\n\nå»ºè®®ï¼šå¢åŠ å®¹é”™å€¼å†è¯•');
    return;
  }
  
  // æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆå®Œå…¨æŒ‰ç…§å·ç äº¤é›†é¡µé¢ï¼šç”¨é€—å·åˆ†éš”ï¼‰
  const resultText = allResults.join(',');
  const numberDisplay = document.getElementById('numberDisplay');
  const numberCount = document.getElementById('numberCount');
  
  if (numberDisplay) {
    // åªæ˜¾ç¤ºå‰500æ³¨
    const displayCombinations = allResults.slice(0, 500);
    const displayText = displayCombinations.join(',');
    
    // å¦‚æœè¶…è¿‡500æ³¨ï¼Œæ·»åŠ çœç•¥æç¤º
    if (allResults.length > 500) {
      numberDisplay.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm">${displayText}...ï¼ˆæ˜¾ç¤ºå‰500æ³¨ï¼Œå…±${allResults.length}æ³¨ï¼Œç‚¹å‡»å¤åˆ¶å¯å¤åˆ¶å…¨éƒ¨ï¼‰</pre>`;
    } else {
      numberDisplay.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm">${displayText}</pre>`;
    }
  }
  
  if (numberCount) {
    numberCount.textContent = `å…± ${allResults.length} æ³¨`;
  }
  
  // ä¿å­˜å®Œæ•´ç»“æœåˆ°å…¨å±€å˜é‡ä¾›å¤åˆ¶ä½¿ç”¨
  window.intersectionResults = resultText;
  
  console.log(`âœ… äº¤é›†å®Œæˆ: ${allResults.length}æ³¨`);
  // ä¸å†å¼¹çª—ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨æ–¹æ¡†ä¸­
}

// å¤åˆ¶äº¤é›†ç»“æœ
function copyIntersectionNumbers() {
  if (!window.intersectionResults || window.intersectionResults.trim() === '') {
    alert('âŒ æš‚æ— äº¤é›†ç»“æœ\n\nè¯·å…ˆç‚¹å‡»"äº¤é›†"æŒ‰é’®ç”Ÿæˆäº¤é›†ç»“æœ');
    return;
  }
  
  // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
  const textarea = document.createElement('textarea');
  textarea.value = window.intersectionResults;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  
  // é€‰æ‹©å¹¶å¤åˆ¶
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  
  try {
    document.execCommand('copy');
    alert('âœ… å¤åˆ¶æˆåŠŸï¼\n\nå·²å°†äº¤é›†ç»“æœå¤åˆ¶åˆ°å‰ªè´´æ¿');
  } catch (err) {
    alert('âŒ å¤åˆ¶å¤±è´¥\n\nè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶');
  }
  
  // ç§»é™¤ä¸´æ—¶å…ƒç´ 
  document.body.removeChild(textarea);
}

// éªŒè¯äº¤é›†ç»“æœ
function verifyIntersectionNumbers() {
  if (!window.intersectionResults || window.intersectionResults.trim() === '') {
    alert('âŒ æš‚æ— äº¤é›†ç»“æœ\n\nè¯·å…ˆç‚¹å‡»"äº¤é›†"æŒ‰é’®ç”Ÿæˆäº¤é›†ç»“æœ');
    return;
  }
  
  const lines = window.intersectionResults.trim().split('\n');
  const totalCount = lines.length;
  
  // æŒ‰æ˜Ÿçº§ç»Ÿè®¡
  const starCounts = {};
  lines.forEach(line => {
    const numbers = line.split(',').filter(n => n.trim());
    const star = numbers.length;
    starCounts[star] = (starCounts[star] || 0) + 1;
  });
  
  // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
  let message = 'âœ… äº¤é›†ç»“æœéªŒè¯\n\n';
  message += `æ€»è®¡: ${totalCount}æ³¨\n\n`;
  message += 'æŒ‰æ˜Ÿçº§ç»Ÿè®¡ï¼š\n';
  Object.keys(starCounts).sort((a, b) => b - a).forEach(star => {
    message += `${star}æ˜Ÿ: ${starCounts[star]}æ³¨\n`;
  });
  
  alert(message);
}

// äº”æ˜Ÿåšå·é¡µé¢çš„æ‹¼æ¥åŠŸèƒ½ï¼ˆä½¿ç”¨äº¤é›†æ‹¼æ¥é€»è¾‘ï¼‰
function generateFiveStarConcatenation() {
    const selectedType = 5; // äº”æ˜Ÿåšå·å›ºå®šä¸º5æ˜Ÿ
    
    // æ£€æŸ¥æ˜¯å¦æœ‰åšå·æ¨¡å—ç»“æœ
    if (!window.moduleStates || Object.keys(window.moduleStates).length === 0) {
        alert('è¯·å…ˆè¿›è¡Œåšå·ï¼Œç„¶åå†è¿›è¡Œæ‹¼æ¥');
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„åšå·æ¨¡å—ï¼ˆè·³è¿‡1æ˜Ÿå’Œ5æ˜Ÿåšå·ï¼‰
    const validModules = [];
    Object.keys(window.moduleStates).forEach(key => {
        const ms = window.moduleStates[key];
        if (ms && Array.isArray(ms.results) && ms.results.length > 0) {
            // è·³è¿‡5æ˜Ÿå’Œ1æ˜Ÿåšå·æ¨¡å—
            if (ms.starLevel === 5 || ms.starLevel === 1) {
                console.log(`è·³è¿‡${ms.starLevel}æ˜Ÿåšå·æ¨¡å—: ${key}`);
                return;
            }
            
            // è·å–æ¨¡å—çš„ä½ç½®ä¿¡æ¯
            let positions = Array.isArray(ms.selectedPositions) && ms.selectedPositions.length > 0
                ? ms.selectedPositions.slice()
                : Array.from({ length: ms.starLevel || 0 }, (_, i) => i + 1);
            
            // è§£ææ¨¡å—ç»“æœ
            const moduleResults = [];
            for (const line of ms.results) {
                if (typeof line !== 'string') continue;
                const parts = line.split(/\s+/).map(s => s.trim()).filter(Boolean);
                if (parts.length >= positions.length) {
                    const result = {};
                    for (let idx = 0; idx < positions.length; idx++) {
                        const pos = positions[idx];
                        const num = (parts[idx] || '').padStart(2, '0');
                        if (/^\d+$/.test(num)) {
                            result[pos] = num;
                        }
                    }
                    if (Object.keys(result).length === positions.length) {
                        moduleResults.push(result);
                    }
                }
            }
            
            if (moduleResults.length > 0) {
                validModules.push({
                    positions: positions,
                    results: moduleResults,
                    starLevel: ms.starLevel
                });
            }
        }
    });
    
    if (validModules.length === 0) {
        alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åšå·æ¨¡å—ç»“æœ');
        return;
    }
    
    // ç”Ÿæˆäº¤é›†æ‹¼æ¥ç»“æœ
    const combinations = generateIntersectionCombinations(validModules, selectedType);
    
    // æ›´æ–°äº”æ˜Ÿåšå·é¡µé¢çš„æ˜¾ç¤º
    window.allGeneratedNumbers = combinations;
    updateNumberDisplay();
}

// é€šç”¨çš„æ˜Ÿçº§æ‹¼æ¥å‡½æ•°
function generateStarConcatenation(targetStarLevel) {
    // æ£€æŸ¥æ˜¯å¦æœ‰åšå·æ¨¡å—ç»“æœ
    if (!window.moduleStates || Object.keys(window.moduleStates).length === 0) {
        alert('è¯·å…ˆè¿›è¡Œåšå·ï¼Œç„¶åå†è¿›è¡Œæ‹¼æ¥');
        return;
    }
    
    // å®šä¹‰æ‹¼æ¥æ˜Ÿçº§é™åˆ¶è§„åˆ™
    const starLevelRules = {
        3: [2],           // 3æ˜Ÿæ‹¼æ¥åªèƒ½ä½¿ç”¨2æ˜Ÿåšå·
        4: [2, 3],        // 4æ˜Ÿæ‹¼æ¥åªèƒ½ä½¿ç”¨2æ˜Ÿæˆ–3æ˜Ÿåšå·
        5: [2, 3, 4]      // 5æ˜Ÿæ‹¼æ¥åªèƒ½ä½¿ç”¨2æ˜Ÿã€3æ˜Ÿæˆ–4æ˜Ÿåšå·
    };
    
    // æ£€æŸ¥ç›®æ ‡æ˜Ÿçº§æ˜¯å¦æ”¯æŒæ‹¼æ¥
    if (!starLevelRules[targetStarLevel]) {
        alert(`ä¸æ”¯æŒ ${targetStarLevel} æ˜Ÿæ‹¼æ¥åŠŸèƒ½`);
        return;
    }
    
    const allowedStarLevels = starLevelRules[targetStarLevel];
    
    // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„åšå·æ¨¡å—
    const validModules = [];
    
    Object.keys(window.moduleStates).forEach(key => {
        const ms = window.moduleStates[key];
        if (ms && Array.isArray(ms.results) && ms.results.length > 0) {
            const moduleStarLevel = ms.starLevel || 0;
            
            // æ£€æŸ¥åšå·æ˜Ÿçº§æ˜¯å¦ç¬¦åˆæ‹¼æ¥è§„åˆ™
            if (!allowedStarLevels.includes(moduleStarLevel)) {
                // è®°å½•è·³è¿‡çš„æ¨¡å—ï¼ˆ1æ˜Ÿã€5æ˜Ÿåšå·ç­‰ï¼‰ï¼Œä½†ä¸é˜»æ­¢æ‹¼æ¥
                console.log(`è·³è¿‡${moduleStarLevel}æ˜Ÿåšå·æ¨¡å—: ${key}`);
                return; // è·³è¿‡ä¸ç¬¦åˆè§„åˆ™çš„æ¨¡å—
            }
            
            // è·å–æ¨¡å—çš„ä½ç½®ä¿¡æ¯
            let positions = Array.isArray(ms.selectedPositions) && ms.selectedPositions.length > 0
                ? ms.selectedPositions.slice()
                : Array.from({ length: ms.starLevel || 0 }, (_, i) => i + 1);
            
            // è§£ææ¨¡å—ç»“æœ
            const moduleResults = [];
            for (const line of ms.results) {
                if (typeof line !== 'string') continue;
                const parts = line.split(/\s+/).map(s => s.trim()).filter(Boolean);
                if (parts.length >= positions.length) {
                    const result = {};
                    for (let idx = 0; idx < positions.length; idx++) {
                        const pos = positions[idx];
                        const num = (parts[idx] || '').padStart(2, '0');
                        if (/^\d+$/.test(num)) {
                            result[pos] = num;
                        }
                    }
                    if (Object.keys(result).length === positions.length) {
                        moduleResults.push(result);
                    }
                }
            }
            
            if (moduleResults.length > 0) {
                validModules.push({
                    positions: positions,
                    results: moduleResults,
                    starLevel: ms.starLevel
                });
            }
        }
    });
    
    // ä¸å†æ£€æŸ¥ä¸ç¬¦åˆè§„åˆ™çš„æ¨¡å—ï¼Œç›´æ¥è·³è¿‡å³å¯
    
    if (validModules.length === 0) {
        const allowedStarLevelsStr = allowedStarLevels.join('æ˜Ÿã€') + 'æ˜Ÿ';
        alert(`æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆ${targetStarLevel}æ˜Ÿæ‹¼æ¥è¦æ±‚çš„åšå·æ¨¡å—ç»“æœã€‚\nè¯·å…ˆè¿›è¡Œ${allowedStarLevelsStr}åšå·ï¼Œç„¶åå†è¿›è¡Œæ‹¼æ¥ã€‚`);
        return;
    }
    
    // ç”Ÿæˆäº¤é›†æ‹¼æ¥ç»“æœ
    const combinations = generateIntersectionCombinations(validModules, targetStarLevel);
    
    // æ›´æ–°æ˜¾ç¤º
    window.allGeneratedNumbers = combinations;
    updateNumberDisplay();
    
    console.log(`å·²ç”Ÿæˆ ${targetStarLevel} æ˜Ÿæ‹¼æ¥ç»“æœï¼Œå…± ${combinations.length} æ³¨`);
}

// æ”¶é›†æ‰€æœ‰æ¨¡å—çš„å·ç ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ä½œä¸ºå¤‡ç”¨ï¼‰
function collectAllNumbers() {
  window.allGeneratedNumbers = [];
  
  // éå†æ‰€æœ‰æ¨¡å—ï¼Œæ”¶é›†ç”Ÿæˆçš„å·ç 
  if (window.moduleStates) {
    Object.keys(window.moduleStates).forEach(moduleId => {
      const moduleState = window.moduleStates[moduleId];
      if (moduleState && moduleState.results && moduleState.results.length > 0) {
        window.allGeneratedNumbers = window.allGeneratedNumbers.concat(moduleState.results);
      }
    });
  }
  
  updateNumberDisplay();
}

// æ›´æ–°å·ç æ˜¾ç¤ºåŒºåŸŸ
function updateNumberDisplay() {
  const numberDisplay = document.getElementById('numberDisplay');
  const numberCount = document.getElementById('numberCount');
  
  if (!numberDisplay || !numberCount) return;
  
  const totalCount = window.allGeneratedNumbers.length;
  
  if (totalCount === 0) {
    numberDisplay.innerHTML = '<div class="text-gray-500 text-center py-8">æš‚æ— ç”Ÿæˆçš„å·ç </div>';
    numberCount.textContent = 'å…± 0 æ³¨';
    return;
  }
  
  // æ˜¾ç¤ºå‰200æ³¨ï¼Œå‰©ä½™çš„çœç•¥
  const displayCount = Math.min(200, totalCount);
  const displayNumbers = window.allGeneratedNumbers.slice(0, displayCount);
  
  let html = displayNumbers.join(',');
  
  if (totalCount > 200) {
    html += `<div class="text-gray-400 text-center mt-3 py-2 border-t">... è¿˜æœ‰ ${totalCount - 200} æ³¨å·ç æœªæ˜¾ç¤º</div>`;
  }
  
  numberDisplay.innerHTML = html;
  numberCount.textContent = `å…± ${totalCount} æ³¨`;
}

// å¤åˆ¶æ‰€æœ‰å·ç åˆ°å‰ªè´´æ¿
function copyAllNumbers() {
  if (!window.allGeneratedNumbers || window.allGeneratedNumbers.length === 0) {
    alert('æš‚æ— å·ç å¯å¤åˆ¶');
    return;
  }
  
  const numbersText = window.allGeneratedNumbers.join(',');
  
  // ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(numbersText).then(() => {
      alert(`å·²å¤åˆ¶ ${window.allGeneratedNumbers.length} æ³¨å·ç åˆ°å‰ªè´´æ¿`);
    }).catch(err => {
      console.error('å¤åˆ¶å¤±è´¥:', err);
      fallbackCopyTextToClipboard(numbersText);
    });
  } else {
    // é™çº§æ–¹æ¡ˆ
    fallbackCopyTextToClipboard(numbersText);
  }
}

// é™çº§å¤åˆ¶æ–¹æ¡ˆ
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";
  
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert(`å·²å¤åˆ¶ ${window.allGeneratedNumbers.length} æ³¨å·ç åˆ°å‰ªè´´æ¿`);
    } else {
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    }
  } catch (err) {
    console.error('é™çº§å¤åˆ¶ä¹Ÿå¤±è´¥:', err);
    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
  }
  
  document.body.removeChild(textArea);
}

// éªŒè¯å·ç åŠŸèƒ½ - ç›´æ¥æäº¤åˆ°éªŒè¯è®¡åˆ’
function verifyNumbers() {
  if (!window.allGeneratedNumbers || window.allGeneratedNumbers.length === 0) {
    // æ›´æ–°é¡µé¢æ˜¾ç¤ºçŠ¶æ€ï¼Œä¸ä½¿ç”¨å¼¹çª—
    const numberCount = document.getElementById('numberCount');
    if (numberCount) {
      numberCount.innerHTML = '<span style="color: red;">æš‚æ— å·ç å¯éªŒè¯</span>';
      setTimeout(() => {
        numberCount.textContent = 'å…± 0 æ³¨';
      }, 3000);
    }
    return;
  }
  
  // ç›´æ¥æäº¤åˆ°éªŒè¯è®¡åˆ’ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
  submitAllNumbersToVerification();
}

// ç»Ÿä¸€çš„éªŒè¯æäº¤å‡½æ•° - å¤„ç†åšå·æ‹¼æ¥é¡µé¢çš„æ‰€æœ‰å·ç 
function submitAllNumbersToVerification() {
  const numberCount = document.getElementById('numberCount');
  
  if (!window.allGeneratedNumbers || window.allGeneratedNumbers.length === 0) {
    if (numberCount) {
      numberCount.innerHTML = '<span style="color: red;">æ²¡æœ‰å¯éªŒè¯çš„å·ç </span>';
      setTimeout(() => {
        numberCount.textContent = 'å…± 0 æ³¨';
      }, 3000);
    }
    return;
  }
  
  // æ˜¾ç¤ºæ­£åœ¨æäº¤çŠ¶æ€
  if (numberCount) {
    numberCount.innerHTML = `<span style="color: blue;">ğŸ”„ æ­£åœ¨æäº¤ ${window.allGeneratedNumbers.length} æ³¨åˆ°éªŒè¯è®¡åˆ’...</span>`;
  }
  
  try {
    // åˆ›å»ºéªŒè¯è®¡åˆ’æ•°æ®
    const planData = {
      planId: `æ‹¼æ¥éªŒè¯_${Date.now()}`,
      displayName: `åšå·æ‹¼æ¥éªŒè¯ (${window.allGeneratedNumbers.length}æ³¨)`,
      planNumbers: [...window.allGeneratedNumbers],
      betCount: window.allGeneratedNumbers.length,
      generationConditions: {
        moduleType: 'åšå·æ‹¼æ¥',
        timestamp: new Date().toLocaleString(),
        source: 'åšå·æ‹¼æ¥é¡µé¢'
      },
      planHash: `concat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    };
    
    // ç¡®ä¿éªŒè¯è®¡åˆ’æ•°æ®æ•°ç»„å·²åˆå§‹åŒ–
    if (!window.verifyPlanData) {
      window.verifyPlanData = [];
    }
    
    // æ·»åŠ åˆ°éªŒè¯è®¡åˆ’æ•°æ®
    window.verifyPlanData.push(planData);
    
    console.log('âœ… åšå·æ‹¼æ¥éªŒè¯è®¡åˆ’å·²æäº¤:', planData.displayName);
    console.log('å½“å‰éªŒè¯è®¡åˆ’æ•°é‡:', window.verifyPlanData.length);
    
    // å¯åŠ¨éªŒè¯è®¡åˆ’æœåŠ¡ï¼ˆå¦‚æœå°šæœªå¯åŠ¨ï¼‰
    if (typeof startVerifyPlanDataFetching === 'function') {
      startVerifyPlanDataFetching();
    }
    
    // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼ï¼ˆå¦‚æœå½“å‰åœ¨éªŒè¯è®¡åˆ’é¡µé¢ï¼‰
    if (typeof updateVerifyPlanTable === 'function') {
      updateVerifyPlanTable();
    }
    
    // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
    if (typeof updateSinglePeriodVerificationTable === 'function') {
      updateSinglePeriodVerificationTable();
    }
    
    // æ˜¾ç¤ºæäº¤æˆåŠŸçŠ¶æ€
    if (numberCount) {
      numberCount.innerHTML = `å…± ${window.allGeneratedNumbers.length} æ³¨ <span style="color: green;">å·²æäº¤åˆ°éªŒè¯è®¡åˆ’</span>`;
      
      // 3ç§’åæ¢å¤æ­£å¸¸æ˜¾ç¤º
      setTimeout(() => {
        numberCount.textContent = `å…± ${window.allGeneratedNumbers.length} æ³¨`;
      }, 3000);
    }
    
    console.log('=== åšå·æ‹¼æ¥éªŒè¯æäº¤å®Œæˆ ===');
    
  } catch (error) {
    console.error('æäº¤åšå·æ‹¼æ¥éªŒè¯æ—¶å‡ºé”™:', error);
    
    // æ˜¾ç¤ºæäº¤å¤±è´¥çŠ¶æ€
    if (numberCount) {
      numberCount.innerHTML = `<span style="color: red;">æäº¤å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}</span>`;
      
      // 3ç§’åæ¢å¤æ­£å¸¸æ˜¾ç¤º
      setTimeout(() => {
        numberCount.textContent = `å…± ${window.allGeneratedNumbers.length} æ³¨`;
      }, 3000);
    }
  }
}


// æ—§çš„æ¨¡å—åˆå§‹åŒ–å‡½æ•°å·²è¢«æ–°çš„ initFiveStarModule å‡½æ•°æ›¿ä»£

// æ·»åŠ æ¨¡å—åŠŸèƒ½
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // æ£€æŸ¥æ¨¡å—æ•°é‡ä¸Šé™ï¼ˆæœ€å¤š14ä¸ªï¼‰
  if (moduleElements.length >= 14) {
    alert('æœ€å¤šåªèƒ½æ·»åŠ 14ä¸ªæ¨¡å—');
    return;
  }

  // è·å–æœ€åä¸€ä¸ªæ¨¡å—IDå¹¶é€’å¢
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // å…‹éš†å½“å‰æ¨¡å—
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // å…‹éš†å½“å‰æ¨¡å—åæ·»åŠ ä»¥ä¸‹ä»£ç 
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // æ·»åŠ åˆ°å®¹å™¨
  modulesContainer.appendChild(newModule);
  
  // åˆå§‹åŒ–æ–°æ¨¡å—
  initFiveStarModule(newModuleId);
}

// ç§»é™¤æ¨¡å—åŠŸèƒ½
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);
  
  if (moduleElements.length <= 2) {
    alert('è‡³å°‘ä¿ç•™2ä¸ªæ¨¡å—');
    return;
  }
  
  moduleToRemove.remove();
}

// é‡ç½®æ¨¡å—çŠ¶æ€
function resetModuleState(module) {
  // é‡ç½®æŒ‰é’®çŠ¶æ€
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  
  // é‡ç½®è¾“å…¥å’Œæ˜¾ç¤º
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = 'å…±0æ³¨';
  
  // é‡ç½®æ¨¡å—æ€»å®¹é”™ä¸ºé»˜è®¤å€¼0-0
  const toleranceMinSelect = module.querySelector('.module-tolerance-min');
  const toleranceMaxSelect = module.querySelector('.module-tolerance-max');
  if (toleranceMinSelect) toleranceMinSelect.value = '0';
  if (toleranceMaxSelect) toleranceMaxSelect.value = '0';
}

// é‡å¤çš„permuteå‡½æ•°å·²åˆ é™¤ï¼Œä½¿ç”¨ä¸Šé¢çš„è¿­ä»£ç‰ˆæœ¬

// Tailwindé…ç½®
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#d62828',
        secondary: '#f77f00',
        neutral: '#f5f5f5',
        dark: '#333333'
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif']
      }
    }
  }
};

// å°æ¹¾PK10æ•°æ®è½¬æ¢é€»è¾‘å‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
/** 
 * æ ¸å¿ƒå¼€å¥–è®¡ç®—ï¼š 
 * - è¾“å…¥ï¼šé•¿åº¦ä¸º 20 çš„æ•°ç»„ nums 
 * - è§„åˆ™ï¼šS_i = nums[i] + nums[19 - i] (i = 0..9) 
 * - æ’åºï¼šæŒ‰å’Œå€¼ä»å¤§åˆ°å°ï¼›è‹¥å’Œå€¼ç›¸åŒï¼Œåºå·è¾ƒå¤§(i+1)è€…ä¼˜å…ˆ 
 * - è¾“å‡ºï¼šé•¿åº¦ä¸º 10 çš„ç´¢å¼•åºåˆ—ï¼ˆ1..10ï¼‰ 
 */ 
/** 
 * è¾“å…¥ï¼šé•¿åº¦ä¸º20çš„æ•°ç»„ nums 
 * è§„åˆ™ï¼š 
 *  1) S_i = nums[i] + nums[19 - i] (i = 0..9) 
 *  2) æ’åºä¼˜å…ˆçº§ï¼š 
 *     a. å’Œå€¼ S_i é™åº 
 *     b. è‹¥å’Œå€¼ç›¸åŒï¼Œæ¯”è¾ƒå·¦ä¾§ nums[i] é™åºï¼ˆå·¦ä¾§å¤§çš„ä¼˜å…ˆï¼‰ 
 *     c. è‹¥ä»ç›¸åŒï¼Œæ¯”è¾ƒå³ä¾§ nums[19 - i] é™åº 
 *     d. è‹¥è¿˜ç›¸åŒï¼Œç´¢å¼•å°è€…ä¼˜å…ˆï¼ˆç¨³å®šï¼‰ 
 * è¾“å‡ºï¼š10ä½ç´¢å¼•ï¼ˆ1..10ï¼‰ 
 */ 
function calcResult(nums) { 
  if (!Array.isArray(nums) || nums.length !== 20) { 
    throw new Error("å¿…é¡»è¾“å…¥é•¿åº¦ä¸º 20 çš„æ•°å­—æ•°ç»„"); 
  } 
  const pairs = Array.from({ length: 10 }, (_, i) => { 
    const L = nums[i], R = nums[19 - i]; 
    return { idx: i + 1, sum: L + R, L, R }; 
  }); 
  pairs.sort((a, b) => { 
    if (b.sum !== a.sum) return b.sum - a.sum;   // â‘  å’Œå€¼é™åº 
    if (b.L   !== a.L)   return b.L   - a.L;     // â‘¡ å·¦ä¾§é™åº 
    if (b.R   !== a.R)   return b.R   - a.R;     // â‘¢ å³ä¾§é™åº 
    return a.idx - b.idx;                        // â‘£ ç´¢å¼•å°è€…ä¼˜å…ˆ 
  }); 
  return pairs.map(p => p.idx); 
}

// å…¨å±€å˜é‡å­˜å‚¨å½“å‰å½©ç§ç±»å‹
let currentLotteryType = 'twpk10'; // é»˜è®¤ä¸ºå°æ¹¾PK10

// ä¸ºä¸åŒå½©ç¥¨ç±»å‹åˆ›å»ºç‹¬ç«‹çš„æ•°æ®å­˜å‚¨
const lotteryDataStorage = {
    bscbh3fpk10: {
        data: [],
        periodSet: new Set()
    },
    bscbh5fpk10: {
        data: [],
        periodSet: new Set()
    },
    tronbh3fpk10: {
        data: [],
        periodSet: new Set()
    },
    xyft: {
        data: [],
        periodSet: new Set()
    },
    jsft: {
        data: [],
        periodSet: new Set()
    },
    twpk10: {
        data: [],
        periodSet: new Set()
    }
};

// è·å–å½“å‰å½©ç¥¨ç±»å‹çš„æ•°æ®
function getCurrentLotteryData() {
    if (!currentLotteryType || !lotteryDataStorage[currentLotteryType]) {
        console.warn('currentLotteryTypeæœªæ­£ç¡®è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼twpk10');
        return lotteryDataStorage['twpk10'];
    }
    return lotteryDataStorage[currentLotteryType];
}

// è®¾ç½®å½©ç¥¨ç±»å‹çš„æ•°æ®ï¼ˆå¯ä»¥æŒ‡å®šç±»å‹ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä½¿ç”¨å½“å‰ç±»å‹ï¼‰
function setCurrentLotteryData(data, targetType = null) {
    const type = targetType || currentLotteryType || 'twpk10';
    
    // é™åˆ¶æ•°æ®é‡ï¼Œç¡®ä¿ä¸è¶…è¿‡200æœŸ
    const maxDataCount = 200;
    if (Array.isArray(data) && data.length > maxDataCount) {
        data = data.slice(0, maxDataCount);
        console.log(`è®¾ç½®æ•°æ®æ—¶å‘ç°æ•°æ®é‡è¶…è¿‡${maxDataCount}æœŸï¼Œå·²è‡ªåŠ¨æˆªå–æœ€æ–°${maxDataCount}æœŸæ•°æ®`);
    }
    
    if (!lotteryDataStorage[type]) {
        console.warn('å½©ç¥¨ç±»å‹ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼twpk10');
        lotteryDataStorage['twpk10'].data = data;
    } else {
        lotteryDataStorage[type].data = data;
    }
    
    // åªæœ‰å½“è®¾ç½®çš„æ˜¯å½“å‰æ˜¾ç¤ºå½©ç§çš„æ•°æ®æ—¶ï¼Œæ‰åŒæ­¥åˆ°å…¨å±€å˜é‡
    if (type === currentLotteryType) {
        r = data;
        window.r = data;
        console.log(`âœ… [${type}] å·²åŒæ­¥åˆ°å…¨å±€å˜é‡rï¼Œå…±${data.length}æœŸ`);
    } else {
        console.log(`âš ï¸ [${type}] æ•°æ®å·²å­˜å‚¨ä½†æœªåŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆå½“å‰å½©ç§ï¼š${currentLotteryType}ï¼‰`);
    }
}

// æ·»åŠ æ•°æ®åˆ°æŒ‡å®šå½©ç¥¨ç±»å‹ï¼ˆå¦‚æœä¸æŒ‡å®šåˆ™ä½¿ç”¨å½“å‰ç±»å‹ï¼‰
function addToCurrentLotteryData(newData, targetType = null) {
    const type = targetType || currentLotteryType || 'twpk10';
    const storage = lotteryDataStorage[type] || getCurrentLotteryData();
    
    if (Array.isArray(newData)) {
        storage.data.unshift(...newData);
    } else {
        storage.data.unshift(newData);
    }
    
    // é™åˆ¶æ•°æ®é‡ï¼Œç¡®ä¿ä¸è¶…è¿‡200æœŸ
    const maxDataCount = 200;
    if (storage.data.length > maxDataCount) {
        storage.data = storage.data.slice(0, maxDataCount);
        console.log(`æ•°æ®é‡è¶…è¿‡${maxDataCount}æœŸï¼Œå·²è‡ªåŠ¨æˆªå–æœ€æ–°${maxDataCount}æœŸæ•°æ®`);
    }
    
    // åªæœ‰å½“æ·»åŠ çš„æ˜¯å½“å‰æ˜¾ç¤ºå½©ç§çš„æ•°æ®æ—¶ï¼Œæ‰åŒæ­¥åˆ°å…¨å±€å˜é‡
    if (type === currentLotteryType) {
        r = storage.data;
        window.r = storage.data;
        console.log(`âœ… [${type}] å·²æ·»åŠ æ•°æ®å¹¶åŒæ­¥åˆ°å…¨å±€å˜é‡rï¼Œå½“å‰å…±${storage.data.length}æœŸ`);
    } else {
        console.log(`âš ï¸ [${type}] å·²æ·»åŠ æ•°æ®ä½†æœªåŒæ­¥åˆ°å…¨å±€å˜é‡ï¼ˆå½“å‰å½©ç§ï¼š${currentLotteryType}ï¼‰`);
    }
}

// æ£€æŸ¥æœŸå·æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¯ä»¥æŒ‡å®šå½©ç§ç±»å‹ï¼‰
function isPeriodExists(period, targetType = null) {
    const type = targetType || currentLotteryType || 'xyft';
    if (!lotteryDataStorage[type]) {
        console.warn('å½©ç¥¨ç±»å‹ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼xyft');
        return lotteryDataStorage['xyft'].periodSet.has(period);
    }
    return lotteryDataStorage[type].periodSet.has(period);
}

// æ·»åŠ æœŸå·åˆ°é›†åˆï¼ˆå¯ä»¥æŒ‡å®šå½©ç§ç±»å‹ï¼‰
function addPeriodToSet(period, targetType = null) {
    const type = targetType || currentLotteryType || 'xyft';
    if (!lotteryDataStorage[type]) {
        console.warn('å½©ç¥¨ç±»å‹ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼xyft');
        lotteryDataStorage['xyft'].periodSet.add(period);
    } else {
        lotteryDataStorage[type].periodSet.add(period);
    }
}

// é¡µé¢åˆ‡æ¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨
  
  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ä»MongoDBæ•°æ®åº“åŠ è½½æ•°æ® - å·²ç¦ç”¨äº‘ç«¯æ•°æ®åº“åŠŸèƒ½
  async function fetchLatestData() {
    // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨
    console.log('äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨');
    const currentTime = new Date().toLocaleTimeString();
    if (v) {
      v.textContent = `äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ® (${currentTime})`;
    }
    
    // æ¸…ç©ºç°æœ‰æ•°æ®
    r = [];
    d.clear();
    
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    document.getElementById("periodCount").textContent = 0;
    
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ - ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»
    // if (typeof L === 'function') {
    //   L();
    // }
  }

  
  // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - ä¸å†è‡ªåŠ¨è·å–æ•°æ®
  // fetchLatestData(); // å·²ç¦ç”¨
  
  // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - ä¸å†è®¾ç½®å®šæ—¶å™¨
  // setInterval(() => {
  //   console.log('å®šæ—¶åˆ·æ–°æ•°æ®...');
  //   fetchLatestData();
  // }, 5000); // å·²ç¦ç”¨
  
  console.log('äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ®');
  
  const dataAnalysisBtn = document.getElementById('dataAnalysisBtn');
  const fiveStarBtn = document.getElementById('fiveStarBtn');
  const verifyPlanBtn = document.getElementById('verifyPlanBtn');
  const goldenRatioBtn = document.getElementById('goldenRatioBtn');
  const intersectionCutBtn = document.getElementById('intersectionCutBtn');
  const dataAnalysisPage = document.getElementById('dataAnalysisPage');
  const fiveStarPage = document.getElementById('fiveStarPage');
  const verifyPlanPage = document.getElementById('verifyPlanPage');
  const goldenRatioPage = document.getElementById('goldenRatioPage');
  const intersectionCutPage = document.getElementById('intersectionCutPage');
  
  // æ»šåŠ¨ä½ç½®ä¿å­˜å’Œæ¢å¤åŠŸèƒ½
  const scrollPositions = {
    dataAnalysis: 0,
    fiveStar: 0,
    verifyPlan: 0,
    goldenRatio: 0,
    intersectionCut: 0
  };
  
  // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
  function saveScrollPosition(pageType) {
    scrollPositions[pageType] = window.pageYOffset || document.documentElement.scrollTop;
  }
  
  // æ¢å¤æŒ‡å®šé¡µé¢çš„æ»šåŠ¨ä½ç½®
  function restoreScrollPosition(pageType) {
    // ä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“æ—¶æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œé¿å…å¡é¡¿
    requestAnimationFrame(() => {
      window.scrollTo({
        top: scrollPositions[pageType],
        behavior: 'instant' // ä½¿ç”¨instanté¿å…æ»šåŠ¨åŠ¨ç”»
      });
    });
  }
  
  // è·å–å½“å‰æ˜¾ç¤ºçš„é¡µé¢ç±»å‹
  function getCurrentPageType() {
    if (!dataAnalysisPage.classList.contains('hidden')) return 'dataAnalysis';
    if (!fiveStarPage.classList.contains('hidden')) return 'fiveStar';
    if (!verifyPlanPage.classList.contains('hidden')) return 'verifyPlan';
    if (!goldenRatioPage.classList.contains('hidden')) return 'goldenRatio';
    if (!intersectionCutPage.classList.contains('hidden')) return 'intersectionCut';
    return 'dataAnalysis'; // é»˜è®¤
  }

  if (dataAnalysisBtn && fiveStarBtn && verifyPlanBtn && goldenRatioBtn && intersectionCutBtn && dataAnalysisPage && fiveStarPage && verifyPlanPage && goldenRatioPage && intersectionCutPage) {
    dataAnalysisBtn.addEventListener('click', function() {
      // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
      disableScrollListener();
      
      // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // ç§»é™¤å•æœŸéªŒè¯è½®è¯¢è°ƒç”¨
      
      // ä¸å†åœæ­¢éªŒè¯è®¡åˆ’é¡µé¢çš„æ•°æ®è·å–ï¼Œè®©éªŒè¯æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œ
      // stopVerifyPlanDataFetch(); // å·²æ³¨é‡Šï¼Œä¿æŒéªŒè¯æœåŠ¡è¿è¡Œ
      
      // åˆ‡æ¢é¡µé¢
      dataAnalysisPage.classList.remove('hidden');
      fiveStarPage.classList.add('hidden');
      verifyPlanPage.classList.add('hidden');
      goldenRatioPage.classList.add('hidden');
      intersectionCutPage.classList.add('hidden');
      dataAnalysisBtn.classList.add('bg-primary');
      dataAnalysisBtn.classList.remove('bg-gray-600');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      verifyPlanBtn.classList.add('bg-gray-600');
      verifyPlanBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      intersectionCutBtn.classList.add('bg-gray-600');
      intersectionCutBtn.classList.remove('bg-primary');
      
      // æ¢å¤æ•°æ®åˆ†æé¡µé¢çš„æ»šåŠ¨ä½ç½®
      restoreScrollPosition('dataAnalysis');
    });
    
    fiveStarBtn.addEventListener('click', function() {
      // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
      disableScrollListener();
      
      // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // ç§»é™¤å•æœŸéªŒè¯è½®è¯¢è°ƒç”¨
      
      // ä¸å†åœæ­¢éªŒè¯è®¡åˆ’é¡µé¢çš„æ•°æ®è·å–ï¼Œè®©éªŒè¯æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œ
      // stopVerifyPlanDataFetch(); // å·²æ³¨é‡Šï¼Œä¿æŒéªŒè¯æœåŠ¡è¿è¡Œ
      
      // åˆ‡æ¢é¡µé¢
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.remove('hidden');
      verifyPlanPage.classList.add('hidden');
      goldenRatioPage.classList.add('hidden');
      intersectionCutPage.classList.add('hidden');
      fiveStarBtn.classList.add('bg-primary');
      fiveStarBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      verifyPlanBtn.classList.add('bg-gray-600');
      verifyPlanBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      intersectionCutBtn.classList.add('bg-gray-600');
      intersectionCutBtn.classList.remove('bg-primary');
      
      // æ¢å¤äº”æ˜Ÿåšå·é¡µé¢çš„æ»šåŠ¨ä½ç½®
      restoreScrollPosition('fiveStar');
    });
    
    verifyPlanBtn.addEventListener('click', function() {
      // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
      disableScrollListener();
      
      // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // åˆ‡æ¢é¡µé¢
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.add('hidden');
      verifyPlanPage.classList.remove('hidden');
      goldenRatioPage.classList.add('hidden');
      intersectionCutPage.classList.add('hidden');
      verifyPlanBtn.classList.add('bg-primary');
      verifyPlanBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      intersectionCutBtn.classList.add('bg-gray-600');
      intersectionCutBtn.classList.remove('bg-primary');
      
      // å¯åŠ¨éªŒè¯è®¡åˆ’é¡µé¢çš„æ•°æ®åŠ è½½å’Œè‡ªåŠ¨æ›´æ–°
      startVerifyPlanDataFetch();
      
      // æ¢å¤éªŒè¯è®¡åˆ’é¡µé¢çš„æ»šåŠ¨ä½ç½®
      restoreScrollPosition('verifyPlan');
    });
    
    goldenRatioBtn.addEventListener('click', function() {
      // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
      disableScrollListener();
      
      // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // ç§»é™¤å•æœŸéªŒè¯è½®è¯¢è°ƒç”¨
      
      // ä¸å†åœæ­¢éªŒè¯è®¡åˆ’é¡µé¢çš„æ•°æ®è·å–ï¼Œè®©éªŒè¯æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œ
      // stopVerifyPlanDataFetch(); // å·²æ³¨é‡Šï¼Œä¿æŒéªŒè¯æœåŠ¡è¿è¡Œ
      
      // åˆ‡æ¢é¡µé¢
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.add('hidden');
      verifyPlanPage.classList.add('hidden');
      goldenRatioPage.classList.remove('hidden');
      intersectionCutPage.classList.add('hidden');
      goldenRatioBtn.classList.add('bg-primary');
      goldenRatioBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      verifyPlanBtn.classList.add('bg-gray-600');
      verifyPlanBtn.classList.remove('bg-primary');
      intersectionCutBtn.classList.add('bg-gray-600');
      intersectionCutBtn.classList.remove('bg-primary');
      
      // æ¢å¤é»„é‡‘åˆ‡å‰²é¡µé¢çš„æ»šåŠ¨ä½ç½®
      restoreScrollPosition('goldenRatio');
    });

    // äº¤é›†æ‹¼æ¥æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    intersectionCutBtn.addEventListener('click', function() {
      // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
      disableScrollListener();
      
      // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // ç§»é™¤å•æœŸéªŒè¯è½®è¯¢è°ƒç”¨
      
      // åˆ‡æ¢é¡µé¢
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.add('hidden');
      verifyPlanPage.classList.add('hidden');
      goldenRatioPage.classList.add('hidden');
      intersectionCutPage.classList.remove('hidden');
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      intersectionCutBtn.classList.add('bg-primary');
      intersectionCutBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      verifyPlanBtn.classList.add('bg-gray-600');
      verifyPlanBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      
      // æ¢å¤äº¤é›†æ‹¼æ¥é¡µé¢çš„æ»šåŠ¨ä½ç½®
      restoreScrollPosition('intersectionCut');
    });

  } else {
    console.error('é¡µé¢åˆ‡æ¢æ‰€éœ€å…ƒç´ æœªæ‰¾åˆ°');
  }
  
  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„é¡µé¢ï¼Œå¯åŠ¨ç›¸åº”çš„æ•°æ®è·å–
  const currentPageType = getCurrentPageType();
  if (currentPageType === 'verifyPlan') {
    // å¦‚æœå½“å‰æ˜¾ç¤ºéªŒè¯è®¡åˆ’é¡µé¢ï¼Œå¯åŠ¨æ•°æ®è·å–
    startVerifyPlanDataFetch();
  }
  
  // æ‰‹æœºç«¯ä¸Šæ»‘å…¨å±åŠŸèƒ½
  let lastScrollY = 0;
  let isFullscreen = false;
  let scrollTimeout = null;
  
  // æ£€æµ‹æ˜¯å¦ä¸ºæ‰‹æœºç«¯
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // åˆ‡æ¢å…¨å±æ¨¡å¼
  function toggleFullscreen(enable) {
    if (!isMobile()) return;
    
    const header = document.querySelector('header');
    const titleArea = header.querySelector('.container');
    const toolbarArea = header.querySelector('.bg-gray-800');
    const keyCountdown = document.getElementById('keyCountdown');
    
    if (enable && !isFullscreen) {
      // è¿›å…¥å…¨å±æ¨¡å¼
      isFullscreen = true;
      
      // éšè—æ ‡é¢˜åŒºåŸŸ
      if (titleArea) {
        titleArea.style.transform = 'translateY(-100%)';
        titleArea.style.transition = 'transform 0.3s ease-in-out';
      }
      
      // éšè—å¯†é’¥å€’è®¡æ—¶æ ï¼ˆå®Œå…¨éšè—å¹¶é‡Šæ”¾ç©ºé—´ï¼‰
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = '0';
        keyCountdown.style.opacity = '0';
        keyCountdown.style.paddingTop = '0';
        keyCountdown.style.paddingBottom = '0';
        keyCountdown.style.overflow = 'hidden';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // è°ƒæ•´å·¥å…·æ ä½ç½®åˆ°é¡¶éƒ¨
      if (toolbarArea) {
        toolbarArea.style.position = 'fixed';
        toolbarArea.style.top = '0';
        toolbarArea.style.left = '0';
        toolbarArea.style.right = '0';
        toolbarArea.style.zIndex = '1000';
        toolbarArea.style.transition = 'all 0.3s ease-in-out';
      }
      
      // è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸçš„ä¸Šè¾¹è·
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '50px'; // å·¥å…·æ é«˜åº¦
        main.style.transition = 'padding-top 0.3s ease-in-out';
      }
      
    } else if (!enable && isFullscreen) {
      // é€€å‡ºå…¨å±æ¨¡å¼
      isFullscreen = false;
      
      // æ˜¾ç¤ºæ ‡é¢˜åŒºåŸŸ
      if (titleArea) {
        titleArea.style.transform = 'translateY(0)';
      }
      
      // æ˜¾ç¤ºå¯†é’¥å€’è®¡æ—¶æ ï¼ˆæ¢å¤åŸå§‹é«˜åº¦å’Œæ ·å¼ï¼‰
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = 'auto';
        keyCountdown.style.opacity = '1';
        keyCountdown.style.paddingTop = '0.5rem';
        keyCountdown.style.paddingBottom = '0.5rem';
        keyCountdown.style.overflow = 'visible';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // æ¢å¤å·¥å…·æ ä½ç½®
      if (toolbarArea) {
        toolbarArea.style.position = '';
        toolbarArea.style.top = '';
        toolbarArea.style.left = '';
        toolbarArea.style.right = '';
        toolbarArea.style.zIndex = '';
      }
      
      // æ¢å¤ä¸»å†…å®¹åŒºåŸŸçš„ä¸Šè¾¹è·
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '';
      }
    }
  }
  
  // æ»šåŠ¨äº‹ä»¶ç›‘å¬
  function handleScroll() {
    if (!isMobile()) return;
    
    const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
    const scrollDelta = currentScrollY - lastScrollY;
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå»¶è¿Ÿæ‰§è¡Œä»¥é¿å…é¢‘ç¹åˆ‡æ¢
    scrollTimeout = setTimeout(() => {
      // å‘ä¸Šæ»‘åŠ¨ä¸”æ»‘åŠ¨è·ç¦»è¶…è¿‡50pxæ—¶è¿›å…¥å…¨å±
      if (scrollDelta < -50 && currentScrollY > 100) {
        toggleFullscreen(true);
      }
      // å‘ä¸‹æ»‘åŠ¨ä¸”æ»‘åŠ¨è·ç¦»è¶…è¿‡30pxæ—¶é€€å‡ºå…¨å±
      // æˆ–è€…æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨é™„è¿‘æ—¶ä¹Ÿé€€å‡ºå…¨å±
      else if (scrollDelta > 30 || currentScrollY < 50) {
        toggleFullscreen(false);
      }
    }, 150); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œå‡å°‘è¯¯è§¦å‘
    
    lastScrollY = currentScrollY;
  }
  
  // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
  window.addEventListener('scroll', handleScroll, { passive: true });
  
  // ä¸ºå·¥å…·æ æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼Œé˜²æ­¢è¯¯è§¦å‘å…¨å±
  const toolbarButtons = document.querySelectorAll('.bg-gray-800 button');
  toolbarButtons.forEach(button => {
    button.addEventListener('click', () => {
      // ç‚¹å‡»æŒ‰é’®æ—¶æš‚æ—¶ç¦ç”¨æ»šåŠ¨æ£€æµ‹
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¯ç”¨æ»šåŠ¨æ£€æµ‹
      setTimeout(() => {
        lastScrollY = window.pageYOffset || document.documentElement.scrollTop;
      }, 300);
    });
  });
  
  // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®å…¨å±çŠ¶æ€
  window.addEventListener('resize', () => {
    if (!isMobile() && isFullscreen) {
      toggleFullscreen(false);
    }
  });
});

// é‡å¤çš„åˆå§‹åŒ–ä»£ç å·²ç§»é™¤
let r=[],i=1,a=null,s=null,d=new Set,u=null,l=null,m=!1,f=15,y=!1,hitRateSort=!1,currentPage=1,pageSize=50,totalPages=1;

// å¤šé‡åŠ å¯†éªŒè¯çŠ¶æ€ç³»ç»Ÿ
let _0x1a2b3c = false;
let _0x4d5e6f = null;
let _0x7g8h9i = [];
let _0x0j1k2l = new Date().getTime();
let _0x3m4n5o = 'aGVsbG93b3JsZA==';
let _0x9p8q7r = Math.random().toString(36).substring(2);
let _0x5s6t7u = btoa(window.location.href).slice(-10);

// éªŒè¯ä»¤ç‰Œç”Ÿæˆå’Œæ£€æŸ¥ç³»ç»Ÿ
function _0xVerifyToken() {
    const _0xTime = new Date().getTime();
    const _0xDiff = _0xTime - _0x0j1k2l;
    if (_0xDiff > 28800000) return false; // 8å°æ—¶è¿‡æœŸ
    
    const _0xHash = btoa(String.fromCharCode(..._0x7g8h9i));
    const _0xCheck = _0x4d5e6f && _0x1a2b3c && _0xHash.length > 0;
    
    // é¢å¤–çš„å®Œæ•´æ€§æ£€æŸ¥
    const _0xIntegrity = _0x9p8q7r.length > 5 && _0x5s6t7u.length > 5;
    
    return _0xCheck && _0xIntegrity;
}

// è®¾ç½®éªŒè¯çŠ¶æ€
function _0xSetAuth(_0xToken) {
    _0x1a2b3c = true;
    _0x4d5e6f = _0xToken;
    _0x7g8h9i = Array.from(_0xToken).map(c => c.charCodeAt(0));
    _0x0j1k2l = new Date().getTime();
    _0x9p8q7r = btoa(_0xToken).slice(0, 10);
    _0xStartTimer(); // å¯åŠ¨å®šæ—¶éªŒè¯
}

// éªŒè¯æ£€æŸ¥åŒ…è£…å™¨
function _0xAuthCheck() {
    if (!_0xIntegrityCheck()) return false;
    if (!_0xAntiDebug()) {
        _0x1a2b3c = 0;
        return false;
    }
    if (!_0xVerifyToken()) {
        return false;
    }
    return true;
}

// å‡çš„éªŒè¯é€»è¾‘ - é™·é˜±ä»£ç 
let fakeAuth = false;
function enableFakeAuth() { fakeAuth = true; }
function checkFakeAuth() { return fakeAuth; }
function validateLicense() { return Math.random() > 0.5; }
function isValidUser() { return localStorage.getItem('user') === 'valid'; }

// åè°ƒè¯•æ£€æŸ¥
function _0xAntiDebug() {
    const start = performance.now();
    debugger;
    const end = performance.now();
    return (end - start) < 100;
}

// åŠ¨æ€éªŒè¯ç ç”Ÿæˆ
function _0xDynamicCode() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000000);
    return btoa(timestamp + ':' + random + ':' + _0x1a2b3c);
}

// å®šæ—¶éªŒè¯æ£€æŸ¥
// å®šæ—¶éªŒè¯æœºåˆ¶ - åªæœ‰åœ¨ç”¨æˆ·å·²éªŒè¯åæ‰å¯åŠ¨
let _0xTimerStarted = false;
let _0xCurrentKey = null; // ä¿å­˜å½“å‰ä½¿ç”¨çš„å¯†é’¥

// æ—§çš„æœåŠ¡å™¨éªŒè¯å‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨æ–°çš„ validate-key API

function _0xStartTimer() {
    if (_0xTimerStarted) return;
    _0xTimerStarted = true;
    
    // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å®Œæ•´éªŒè¯
    setInterval(async () => {
        // 1. æœ¬åœ°éªŒè¯
        if (_0x1a2b3c && !_0xAuthCheck()) {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">éªŒè¯å¤±æ•ˆï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢</div>';
            setTimeout(() => location.reload(), 2000);
            return;
        }
        
        // 2. æœåŠ¡å™¨éªŒè¯ï¼ˆæ£€æŸ¥å¯†é’¥æ˜¯å¦è¢«åˆ é™¤ï¼‰
        if (_0xCurrentKey) {
            try {
                // æ ¹æ®ç¯å¢ƒé€‰æ‹©APIåœ°å€
                const serverCheckUrl = '/api/keys/validate-key';
                
                // ç”Ÿæˆè®¾å¤‡ID
                const deviceId = generateDeviceId();
                
                const serverResponse = await fetch(serverCheckUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        key: _0xCurrentKey,
                        deviceId: deviceId,
                        clientTime: Date.now()
                    })
                });
                
                const serverResult = await parseServerJson(serverResponse, 'å®šæ—¶å¯†é’¥éªŒè¯æœåŠ¡');
                
                // å¦‚æœæœåŠ¡å™¨éªŒè¯å¤±è´¥
                if (!serverResult.success || !serverResult.valid) {
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    const deviceId = Y();
                    localStorage.removeItem(`validKey_${deviceId}`);
                    localStorage.removeItem(`keyExpiry_${deviceId}`);
                    
                    // æ˜¾ç¤ºæç¤ºå¹¶é‡æ–°åŠ è½½
                    document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;font-size:20px;">âŒ æ‚¨çš„å¯†é’¥å·²è¢«ç®¡ç†å‘˜æ’¤é”€<br><br>é¡µé¢å°†åœ¨3ç§’åé‡æ–°åŠ è½½</div>';
                    setTimeout(() => location.reload(), 3000);
                }
            } catch (error) {
                console.warn('âš ï¸ å®šæœŸéªŒè¯å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰ï¼Œæš‚æ—¶å…è®¸è®¿é—®:', error);
                // ç½‘ç»œé”™è¯¯æ—¶å®¹é”™ï¼Œä¸å¼ºåˆ¶é€€å‡º
            }
        }
    }, 300000); // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    // é¢å¤–ï¼šæ¯1åˆ†é’Ÿå¿«é€Ÿæ£€æŸ¥æœ¬åœ°è¿‡æœŸæ—¶é—´
    setInterval(() => {
        if (_0x1a2b3c && !_0xAuthCheck()) {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">éªŒè¯å¤±æ•ˆï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢</div>';
            setTimeout(() => location.reload(), 2000);
        }
    }, 60000); // æ¯1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
}

// ä»£ç å®Œæ•´æ€§æ£€æŸ¥
function _0xIntegrityCheck() {
    const _0xFuncs = [_0xVerifyToken, _0xSetAuth, _0xAuthCheck];
    for (let _0xFunc of _0xFuncs) {
        if (typeof _0xFunc !== 'function') {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">ç³»ç»Ÿæ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
            return false;
        }
    }
    return true;
}

// å…¼å®¹æ€§å˜é‡ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
// å…¼å®¹æ€§å˜é‡ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
let b = false;
const h = "pk4_access_key";
const g = document.getElementById("keyModal");
const p = document.getElementById("keyInput");
const v = document.getElementById("output");
const x = document.getElementById("tableContainer");
const w = document.getElementById("horizontalThumb");
const k = document.getElementById("horizontalFill");
const $ = document.getElementById("verticalSlider");
const B = document.getElementById("verticalThumb");
const I = document.getElementById("verticalFill");
const M = document.getElementById("numButtons");

function N(t) {
    t.forEach(e => e.addEventListener("click", () => {
        t.forEach(t => t.classList.remove("btn-active"));
        e.classList.add("btn-active");
        console.log('ä½ç½®é€‰æ‹©å·²æ›´æ”¹ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»');
    }));
}

function C(t) {
    t.forEach(t => {
        // è®¾ç½®åˆå§‹æ ·å¼
        t.style.backgroundColor = '#e5e7eb'; // gray-200
        t.style.color = '#374151'; // gray-700
        t.style.cursor = 'pointer';
        t.style.transition = 'all 0.2s ease';
        
        t.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('*** å‘½ä¸­ç æ•°æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘ ***', t.textContent, t.dataset.hit);
            
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            if (t.classList.contains("btn-active")) {
                // å–æ¶ˆé€‰ä¸­
                console.log('*** ç§»é™¤é€‰ä¸­çŠ¶æ€ ***');
                t.classList.remove("btn-active");
                t.style.backgroundColor = '#e5e7eb'; // gray-200
                t.style.color = '#374151'; // gray-700
            } else {
                // é€‰ä¸­
                console.log('*** æ·»åŠ é€‰ä¸­çŠ¶æ€ ***');
                t.classList.add("btn-active");
                t.style.backgroundColor = '#3b82f6'; // blue-500
                t.style.color = 'white';
            }
            
            console.log('*** å½“å‰æŒ‰é’®ç±»å ***', t.className);
            console.log('å‘½ä¸­ç æ•°é€‰æ‹©å·²æ›´æ”¹ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»');
        });
    });
}
// ç«‹å³è¾“å‡ºè°ƒè¯•ä¿¡æ¯
console.log('*** è„šæœ¬å¼€å§‹æ‰§è¡Œ ***');
console.log('*** å½“å‰æ—¶é—´æˆ³:', Date.now(), '***');

// åˆå§‹åŒ–å‘½ä¸­ç æ•°æŒ‰é’®
document.addEventListener('DOMContentLoaded', function() {
    console.log('*** DOMContentLoadedäº‹ä»¶è§¦å‘ ***');
    
    // åˆå§‹åŒ–å½©ç§åˆ‡æ¢åŠŸèƒ½
    const lotteryTypeSelect = document.getElementById('lotteryType');
    const currentLotteryStatus = document.getElementById('currentLotteryStatus');
    
    // ç¡®ä¿currentLotteryTypeæ­£ç¡®åˆå§‹åŒ–
    if (lotteryTypeSelect) {
        currentLotteryType = lotteryTypeSelect.value || 'xyft';
        console.log('åˆå§‹åŒ–currentLotteryTypeä¸º:', currentLotteryType);
        
        // é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨å¯åŠ¨å¯¹åº”å½©ç§çš„æ•°æ®è·å–
        setTimeout(() => {
            if (currentLotteryType === 'twpk10') {
                console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šè‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–...');
                
                // æ£€æŸ¥ç¼“å­˜æ•°æ®
                const cachedData = localStorage.getItem('twpk10Data');
                const cacheTimestamp = localStorage.getItem('twpk10DataTimestamp');
                const now = Date.now();
                const cacheAge = now - (cacheTimestamp ? parseInt(cacheTimestamp) : 0);
                const cacheValid = cacheAge < 5 * 60 * 1000; // 5åˆ†é’Ÿå†…æœ‰æ•ˆ
                
                if (cachedData && cacheValid) {
                    console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„å°æ¹¾PK10æ•°æ®');
                    try {
                        const data = JSON.parse(cachedData);
                        if (data && data.length > 0) {
                            window.twpk10Data = data;
                            // L(); // ç§»é™¤è‡ªåŠ¨è¡¨æ ¼åˆ·æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ç­›é€‰
                            console.log('âœ… ç¼“å­˜æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', data.length, 'æ¡è®°å½•ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ç­›é€‰');
                        }
                    } catch (error) {
                        console.error('âŒ è§£æç¼“å­˜æ•°æ®å¤±è´¥:', error);
                    }
                }
                
                // æ— è®ºæ˜¯å¦æœ‰ç¼“å­˜ï¼Œéƒ½å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                setTimeout(() => {
                    if (typeof startAutoScrape === 'function') {
                        startAutoScrape(false); // ç¦ç”¨æç¤ºæ˜¾ç¤º
                        // console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå·²è‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–åŠŸèƒ½');
                    }
                }, 1000);
                
            } else if (currentLotteryType.startsWith('bscbh') || currentLotteryType.startsWith('tronbh')) {
                const lotteryName = currentLotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                                   (currentLotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
                console.log(`ğŸ”„ é¡µé¢åˆå§‹åŒ–ï¼šè‡ªåŠ¨è·å–${lotteryName}å†å²æ•°æ®...`);
                if (typeof fetchHistoryData === 'function') {
                    fetchHistoryData().then(result => {
                        if (result && result.totalCount > 0) {
                            console.log(`âœ… é¡µé¢åˆå§‹åŒ–ï¼šæˆåŠŸåŠ è½½${lotteryName}å†å²æ•°æ®ï¼Œå…±`, result.totalCount, 'æ¡è®°å½•');
                        } else {
                            console.log(`âš ï¸ é¡µé¢åˆå§‹åŒ–ï¼šæœªè·å–åˆ°${lotteryName}å†å²æ•°æ®`);
                            L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        }
                        
                        // å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log(`ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå·²å¯åŠ¨${lotteryName}è‡ªåŠ¨è·å–åŠŸèƒ½`);
                            }
                        }, 1000);
                    }).catch(error => {
                        console.error(`âŒ è·å–${lotteryName}å†å²æ•°æ®å¤±è´¥:`, error);
                        L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        
                        // å³ä½¿å†å²æ•°æ®è·å–å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log(`ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå·²å¯åŠ¨${lotteryName}è‡ªåŠ¨è·å–åŠŸèƒ½ï¼ˆå†å²æ•°æ®è·å–å¤±è´¥ï¼‰`);
                            }
                        }, 1000);
                    });
                } else {
                    console.error('âŒ fetchHistoryData å‡½æ•°æœªå®šä¹‰');
                    L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                    
                    // å³ä½¿å‡½æ•°æœªå®šä¹‰ï¼Œä¹Ÿå°è¯•å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                    setTimeout(() => {
                        if (typeof startAutoScrape === 'function') {
                            startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                            console.log(`ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå·²å¯åŠ¨${lotteryName}è‡ªåŠ¨è·å–åŠŸèƒ½ï¼ˆfetchHistoryDataæœªå®šä¹‰ï¼‰`);
                        }
                    }, 1000);
                }
            } else if (currentLotteryType === 'xyft') {
                console.log('ğŸ”„ é¡µé¢åˆå§‹åŒ–ï¼šè‡ªåŠ¨è·å–å¹¸è¿é£è‰‡å†å²æ•°æ®...');
                if (typeof fetchHistoryData === 'function') {
                    fetchHistoryData().then(result => {
                        if (result && result.totalCount > 0) {
                            console.log('âœ… é¡µé¢åˆå§‹åŒ–ï¼šæˆåŠŸåŠ è½½å¹¸è¿é£è‰‡å†å²æ•°æ®ï¼Œå…±', result.totalCount, 'æ¡è®°å½•');
                        } else {
                            console.log('â„¹ï¸ é¡µé¢åˆå§‹åŒ–ï¼šæœªè·å–åˆ°å¹¸è¿é£è‰‡å†å²æ•°æ®ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼');
                            // L(); // ç§»é™¤ä¸å¿…è¦çš„è¡¨æ ¼æ¸²æŸ“è°ƒç”¨
                        }
                    }).catch(error => {
                        console.error('âŒ é¡µé¢åˆå§‹åŒ–ï¼šè·å–å¹¸è¿é£è‰‡å†å²æ•°æ®å¤±è´¥:', error);
                        // L(); // ç§»é™¤ä¸å¿…è¦çš„è¡¨æ ¼æ¸²æŸ“è°ƒç”¨
                    });
                }
            } else if (currentLotteryType === 'jsft') {
                console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå‡†å¤‡å¯åŠ¨æ€¥é€Ÿé£è‰‡æ•°æ®è·å–...');
                
                // ç¡®ä¿æ€¥é€Ÿé£è‰‡çš„æ•°æ®å­˜å‚¨å·²åˆå§‹åŒ–
                const currentData = getCurrentLotteryData();
                r = currentData.data;
                window.r = currentData.data;
                d = currentData.periodSet;
                
                // æ¸…ç©ºæœŸå·é›†åˆï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™æ•°æ®
                currentData.periodSet.clear();
                console.log('âœ… é¡µé¢åˆå§‹åŒ–ï¼šå·²æ¸…ç©ºæ€¥é€Ÿé£è‰‡æœŸå·é›†åˆ');
                
                // å»¶è¿Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½ï¼Œé¿å…ç«‹å³è·å–æ•°æ®
                setTimeout(() => {
                    if (typeof startAutoScrape === 'function') {
                        startAutoScrape(false, null, false); // ä¸ç«‹å³è·å–æ•°æ®
                        console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–ï¼šå·²å¯åŠ¨æ€¥é€Ÿé£è‰‡è‡ªåŠ¨è·å–åŠŸèƒ½');
                    } else {
                        console.log('âš ï¸ é¡µé¢åˆå§‹åŒ–ï¼šstartAutoScrapeå‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•å¯åŠ¨æ€¥é€Ÿé£è‰‡è‡ªåŠ¨è·å–');
                    }
                }, 1000);
            }
        }, 500); // å»¶è¿Ÿ500msç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    }
    
    if (lotteryTypeSelect && currentLotteryStatus) {
        // å½©ç§åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        lotteryTypeSelect.addEventListener('change', function() {
            currentLotteryType = this.value;
            const lotteryName = this.value === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                               (this.value === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' :
                               (this.value === 'tronbh3fpk10' ? 'æ³¢åœº3åˆ†PK10' :
                               (this.value === 'xyft' ? 'å¹¸è¿é£è‰‡' : 
                               (this.value === 'jsft' ? 'æ€¥é€Ÿé£è‰‡' : 'å°æ¹¾PK10'))));
            currentLotteryStatus.textContent = `å½“å‰: ${lotteryName}`;
            console.log(`å½©ç§åˆ‡æ¢ä¸º: ${lotteryName} (${this.value})`);
            
            // å…ˆåœæ­¢å½“å‰çš„è‡ªåŠ¨è·å–åŠŸèƒ½
            if (typeof stopAutoScrape === 'function') {
                stopAutoScrape(false); // ä¸æ˜¾ç¤ºåœæ­¢é€šçŸ¥ï¼Œé¿å…ç”¨æˆ·è¯¯è§£
                console.log('ğŸ›‘ å·²åœæ­¢ä¹‹å‰çš„è‡ªåŠ¨è·å–åŠŸèƒ½');
            }
            
            // å½©ç§åˆ‡æ¢é€šçŸ¥å·²ç§»é™¤
            
            // ğŸ”’ ç«‹å³æ¸…ç©ºè¡¨æ ¼DOMï¼Œé¿å…æ˜¾ç¤ºæ—§æ•°æ®
            console.log('ğŸ§¹ æ¸…ç©ºæ—§å½©ç§è¡¨æ ¼æ•°æ®...');
            const tbody = document.querySelector("#resultTable tbody");
            const thead = document.querySelector("#resultTable thead");
            const summary = document.getElementById("summary");
            
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">æ­£åœ¨åˆ‡æ¢å½©ç§...</td></tr>';
            }
            if (thead) {
                thead.innerHTML = '';
            }
            if (summary) {
                summary.innerHTML = '';
            }
            
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°åå†åŠ è½½æ–°æ•°æ®
            requestAnimationFrame(() => {
                // åˆ‡æ¢åˆ°æ–°å½©ç§çš„æ•°æ®å­˜å‚¨
                console.log('ğŸ”„ åˆ‡æ¢å½©ç§ï¼ŒåŠ è½½æ–°å½©ç§æ•°æ®...');
                const currentData = getCurrentLotteryData();
                r = currentData.data;
                window.r = currentData.data;
                d = currentData.periodSet;
                document.getElementById("periodCount").textContent = currentData.data.length;
                
                console.log(`âœ… å·²åˆ‡æ¢åˆ°${lotteryName}æ•°æ®ï¼Œå½“å‰æ•°æ®é‡: ${currentData.data.length}æœŸ`);
                
                // å†æ¬¡ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æ•°æ®åˆ‡æ¢å®Œæˆåå†æ¸²æŸ“
                requestAnimationFrame(() => {
                    if (currentData.data.length > 0) {
                        console.log('ğŸ”„ æ¸²æŸ“å½“å‰å½©ç§çš„æ•°æ®åˆ°è¡¨æ ¼');
                        L(); // æ¸²æŸ“è¡¨æ ¼
                    } else {
                        console.log('ğŸ“‹ å½“å‰å½©ç§æš‚æ— æ•°æ®ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼');
                        const tbodyFinal = document.querySelector("#resultTable tbody");
                        if (tbodyFinal) {
                            tbodyFinal.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                        }
                    }
                });
            });
            
            // æ›´æ–°æ•°æ®æºæ˜¾ç¤º
            const dataSourceElement = document.querySelector('.data-source');
            if (dataSourceElement) {
                if (this.value === 'twpk10') {
                    dataSourceElement.textContent = 'æ•°æ®æº: å°æ¹¾PK10';
                } else if (this.value === 'jsft') {
                    dataSourceElement.textContent = 'æ•°æ®æº: æ€¥é€Ÿé£è‰‡';
                } else {
                    dataSourceElement.textContent = 'æ•°æ®æº: å¹¸è¿é£è‰‡ (æ‰‹åŠ¨è¾“å…¥)';
                }
            }
            
            // è‡ªåŠ¨è·å–å¯¹åº”å½©ç§çš„æ•°æ®å¹¶å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
            if (this.value === 'twpk10') {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å°æ¹¾PK10çš„ç¼“å­˜æ•°æ®
                const cachedData = localStorage.getItem('twpk10_cached_data');
                const cacheTime = localStorage.getItem('twpk10_cache_time');
                const currentTime = Date.now();
                const cacheExpiry = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜è¿‡æœŸæ—¶é—´
                
                if (cachedData && cacheTime && (currentTime - parseInt(cacheTime)) < cacheExpiry) {
                    console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„å°æ¹¾PK10æ•°æ®...');
                    try {
                        const parsedData = JSON.parse(cachedData);
                        if (parsedData && parsedData.length > 0) {
                            // å°†ç¼“å­˜æ•°æ®è®¾ç½®åˆ°å°æ¹¾PK10çš„ç‹¬ç«‹å­˜å‚¨ä¸­
                            setCurrentLotteryData(parsedData);
                            document.getElementById("periodCount").textContent = parsedData.length;
                            // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºç¼“å­˜æ•°æ®
                            L(); // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                            console.log('âœ… æˆåŠŸåŠ è½½ç¼“å­˜æ•°æ®ï¼Œå…±', parsedData.length, 'æ¡è®°å½•ï¼Œè¡¨æ ¼å·²åˆ·æ–°');
                            
                            // å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                            setTimeout(() => {
                                if (typeof startAutoScrape === 'function') {
                                    startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                    // console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–åŠŸèƒ½');
                                }
                            }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨ï¼Œç¡®ä¿ç¼“å­˜æ•°æ®åŠ è½½å®Œæˆ
                            return;
                        }
                    } catch (e) {
                        console.warn('âš ï¸ ç¼“å­˜æ•°æ®è§£æå¤±è´¥ï¼Œå°†é‡æ–°è·å–:', e);
                        localStorage.removeItem('twpk10_cached_data');
                        localStorage.removeItem('twpk10_cache_time');
                    }
                }
                
                console.log('ğŸ”„ è‡ªåŠ¨è·å–å°æ¹¾PK10æ•°æ®å¹¶å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½...');
                // è‡ªåŠ¨è§¦å‘å°æ¹¾PK10æ•°æ®è·å–
                if (typeof fetchApiData === 'function') {
                    fetchApiData().then(() => {
                        // æ•°æ®è·å–å®Œæˆåå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                // console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–åŠŸèƒ½');
                            }
                        }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨
                    }).catch(error => {
                        console.error('âŒ åˆå§‹æ•°æ®è·å–å¤±è´¥:', error);
                        // å³ä½¿åˆå§‹è·å–å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                // console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–åŠŸèƒ½ï¼ˆåˆå§‹è·å–å¤±è´¥ï¼‰');
                            }
                        }, 1000);
                    });
                } else {
                    console.error('âŒ fetchApiData å‡½æ•°æœªå®šä¹‰');
                    // å³ä½¿å‡½æ•°æœªå®šä¹‰ï¼Œä¹Ÿå°è¯•å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                    setTimeout(() => {
                        if (typeof startAutoScrape === 'function') {
                            startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                            // console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å°æ¹¾PK10æ•°æ®è·å–åŠŸèƒ½ï¼ˆfetchApiDataæœªå®šä¹‰ï¼‰');
                        }
                    }, 1000);
                }
            } else if (this.value.startsWith('bscbh') || this.value.startsWith('tronbh')) {
                const lotteryName = this.value === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                                   (this.value === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
                console.log(`ğŸ”„ è‡ªåŠ¨è·å–${lotteryName}å†å²æ•°æ®...`);
                // å¯¹äºå¸å®‰ç³»åˆ—ï¼Œè‡ªåŠ¨è·å–å†å²æ•°æ®å¹¶å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                if (typeof fetchHistoryData === 'function') {
                    fetchHistoryData().then(result => {
                        if (result && result.totalCount > 0) {
                            console.log(`âœ… æˆåŠŸåŠ è½½${lotteryName}å†å²æ•°æ®ï¼Œå…±`, result.totalCount, 'æ¡è®°å½•');
                        } else {
                            console.log(`â„¹ï¸ æœªè·å–åˆ°${lotteryName}å†å²æ•°æ®ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼`);
                            L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        }
                        
                        // å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log(`ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨${lotteryName}æ•°æ®è·å–åŠŸèƒ½`);
                            }
                        }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨ï¼Œç¡®ä¿å†å²æ•°æ®åŠ è½½å®Œæˆ
                    }).catch(error => {
                        console.error(`âŒ è·å–${lotteryName}å†å²æ•°æ®å¤±è´¥:`, error);
                        L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        
                        // å³ä½¿å†å²æ•°æ®è·å–å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log(`ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨${lotteryName}æ•°æ®è·å–åŠŸèƒ½ï¼ˆå†å²æ•°æ®è·å–å¤±è´¥ï¼‰`);
                            }
                        }, 1000);
                    });
                } else {
                    console.error('âŒ fetchHistoryData å‡½æ•°æœªå®šä¹‰');
                    L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                    
                    // å³ä½¿å‡½æ•°æœªå®šä¹‰ï¼Œä¹Ÿå°è¯•å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                    setTimeout(() => {
                        if (typeof startAutoScrape === 'function') {
                            startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                            console.log(`ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨${lotteryName}æ•°æ®è·å–åŠŸèƒ½ï¼ˆfetchHistoryDataæœªå®šä¹‰ï¼‰`);
                        }
                    }, 1000);
                }
            } else if (this.value === 'xyft') {
                console.log('ğŸ”„ è‡ªåŠ¨è·å–å¹¸è¿é£è‰‡å†å²æ•°æ®...');
                // å¯¹äºå¹¸è¿é£è‰‡ï¼Œè‡ªåŠ¨è·å–å†å²æ•°æ®å¹¶å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                if (typeof fetchHistoryData === 'function') {
                    fetchHistoryData().then(result => {
                        if (result && result.totalCount > 0) {
                            console.log('âœ… æˆåŠŸåŠ è½½å¹¸è¿é£è‰‡å†å²æ•°æ®ï¼Œå…±', result.totalCount, 'æ¡è®°å½•');
                        } else {
                            console.log('â„¹ï¸ æœªè·å–åˆ°å¹¸è¿é£è‰‡å†å²æ•°æ®ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼');
                            L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        }
                        
                        // å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å¹¸è¿é£è‰‡æ•°æ®è·å–åŠŸèƒ½');
                            }
                        }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨ï¼Œç¡®ä¿å†å²æ•°æ®åŠ è½½å®Œæˆ
                    }).catch(error => {
                        console.error('âŒ è·å–å¹¸è¿é£è‰‡å†å²æ•°æ®å¤±è´¥:', error);
                        L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        
                        // å³ä½¿å†å²æ•°æ®è·å–å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                                console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å¹¸è¿é£è‰‡æ•°æ®è·å–åŠŸèƒ½ï¼ˆå†å²æ•°æ®è·å–å¤±è´¥ï¼‰');
                            }
                        }, 1000);
                    });
                } else {
                    console.error('âŒ fetchHistoryData å‡½æ•°æœªå®šä¹‰');
                    L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                    
                    // å³ä½¿å‡½æ•°æœªå®šä¹‰ï¼Œä¹Ÿå°è¯•å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                    setTimeout(() => {
                        if (typeof startAutoScrape === 'function') {
                            startAutoScrape(false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤º
                            console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨å¹¸è¿é£è‰‡æ•°æ®è·å–åŠŸèƒ½ï¼ˆfetchHistoryDataæœªå®šä¹‰ï¼‰');
                        }
                    }, 1000);
                }
            } else if (this.value === 'jsft') {
                console.log('ğŸ”„ è‡ªåŠ¨è·å–æ€¥é€Ÿé£è‰‡å†å²æ•°æ®...');
                // å¯¹äºæ€¥é€Ÿé£è‰‡ï¼Œè‡ªåŠ¨è·å–å†å²æ•°æ®å¹¶å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                if (typeof fetchHistoryData === 'function') {
                    fetchHistoryData().then(result => {
                        if (result && result.totalCount > 0) {
                            console.log('âœ… æˆåŠŸåŠ è½½æ€¥é€Ÿé£è‰‡å†å²æ•°æ®ï¼Œå…±', result.totalCount, 'æ¡è®°å½•');
                        } else {
                            console.log('â„¹ï¸ æœªè·å–åˆ°æ€¥é€Ÿé£è‰‡å†å²æ•°æ®ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼');
                            L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        }
                        
                        // å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false, null, false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤ºï¼Œä¸ç«‹å³è·å–æ•°æ®
                                console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨æ€¥é€Ÿé£è‰‡æ•°æ®è·å–åŠŸèƒ½');
                            }
                        }, 1000); // å»¶è¿Ÿ1ç§’å¯åŠ¨ï¼Œç¡®ä¿å†å²æ•°æ®åŠ è½½å®Œæˆ
                    }).catch(error => {
                        console.error('âŒ è·å–æ€¥é€Ÿé£è‰‡å†å²æ•°æ®å¤±è´¥:', error);
                        L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                        
                        // å³ä½¿å†å²æ•°æ®è·å–å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                        setTimeout(() => {
                            if (typeof startAutoScrape === 'function') {
                                startAutoScrape(false, null, false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤ºï¼Œä¸ç«‹å³è·å–æ•°æ®
                                console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨æ€¥é€Ÿé£è‰‡æ•°æ®è·å–åŠŸèƒ½ï¼ˆå†å²æ•°æ®è·å–å¤±è´¥ï¼‰');
                            }
                        }, 1000);
                    });
                } else {
                    console.error('âŒ fetchHistoryData å‡½æ•°æœªå®šä¹‰');
                    L(); // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºç©ºè¡¨æ ¼
                    
                    // å³ä½¿å‡½æ•°æœªå®šä¹‰ï¼Œä¹Ÿå°è¯•å¯åŠ¨è‡ªåŠ¨è·å–åŠŸèƒ½
                    setTimeout(() => {
                        if (typeof startAutoScrape === 'function') {
                            startAutoScrape(false, null, false); // ä¸æ˜¾ç¤ºå¯åŠ¨æç¤ºï¼Œä¸ç«‹å³è·å–æ•°æ®
                            console.log('ğŸš€ å·²è‡ªåŠ¨å¯åŠ¨æ€¥é€Ÿé£è‰‡æ•°æ®è·å–åŠŸèƒ½ï¼ˆfetchHistoryDataæœªå®šä¹‰ï¼‰');
                        }
                    }, 1000);
                }
            }
        });
    }
    
    // è‡ªåŠ¨åŠ è½½è®¡åˆ’éªŒè¯å†å²ï¼ˆä½†ä¸è§¦å‘éªŒè¯è¡¨æ ¼æ›´æ–°ï¼‰
    if (window.PlanStorageManager && typeof window.PlanStorageManager.loadFromLocalStorage === 'function') {
        setTimeout(() => {
            window.PlanStorageManager.loadFromLocalStorage(true); // skipVerification = trueï¼Œä»…åŠ è½½æ•°æ®ä¸æ›´æ–°è¡¨æ ¼
        }, 100); // å»¶è¿Ÿ100msç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    }
    
    // åˆå§‹åŒ–éªŒè¯æ¨¡å¼ä¸ºå•æœŸéªŒè¯ï¼Œç¡®ä¿å†å²ç®¡ç†æ§ä»¶æ˜¾ç¤º
    setTimeout(() => {
        if (typeof window.switchVerifyMode === 'function') {
            const planHistoryControls = document.getElementById('planHistoryControls');
            if (planHistoryControls) {
                window.switchVerifyMode('single', true);
                console.log('âœ… é¡µé¢åŠ è½½æ—¶éªŒè¯æ¨¡å¼åˆå§‹åŒ–æˆåŠŸï¼Œå†å²ç®¡ç†æ§ä»¶å·²æ˜¾ç¤º');
            }
        }
    }, 200);
    
    const S = document.getElementById("hitButtons");
    if (!S) {
        console.error('hitButtonså…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    console.log('*** hitButtonså…ƒç´ æ‰¾åˆ°ï¼Œå¼€å§‹åˆå§‹åŒ– ***');
    
    [0,1,2,3,4,5].forEach(t=>{const e=document.createElement("button");e.className="px-3 py-1 rounded-md bg-gray-200 btn-hover",e.dataset.hit=t,e.textContent=t+"èƒ†",S.appendChild(e)});
    
    // ç§»é™¤é»˜è®¤é€‰ä¸­çŠ¶æ€ - é¡µé¢åŠ è½½æ—¶å‘½ä¸­ç æ•°éƒ½ä¸é€‰ä¸­
    // document.querySelector('#hitButtons button[data-hit="2"]').classList.add("btn-active");
    // document.querySelector('#hitButtons button[data-hit="3"]').classList.add("btn-active");
    
    // ç§»é™¤é»˜è®¤é€‰ä¸­çŠ¶æ€ - é¡µé¢åŠ è½½æ—¶å‘½ä¸­æ•°å­—éƒ½ä¸é€‰ä¸­
    // const defaultHitNumbers = [1, 2, 3, 4, 5, 6];
    // defaultHitNumbers.forEach(num => {
    //     const button = document.querySelector(`.hit-number-btn[data-number="${num}"]`);
    //     if (button) {
    //         button.classList.add('btn-active', 'bg-primary', 'text-white');
    //         button.classList.remove('border-gray-300');
    //     }
    // });
    
    C(Array.from(S.children));
    
    // ä½ç½®é€‰æ‹©æŒ‰é’®äº‹ä»¶å¤„ç† - å…¨æ–°å®ç°
    console.log('=== å¼€å§‹åˆå§‹åŒ–ä½ç½®é€‰æ‹©æŒ‰é’® ===');
    
    // ç­‰å¾…DOMå®Œå…¨åŠ è½½
    setTimeout(() => {
        const positionButtons = document.querySelectorAll('.position-btn');
        console.log('æ‰¾åˆ°ä½ç½®é€‰æ‹©æŒ‰é’®æ•°é‡:', positionButtons.length);
        
        if (positionButtons.length === 0) {
            console.error('æœªæ‰¾åˆ°ä½ç½®é€‰æ‹©æŒ‰é’®ï¼');
            return;
        }
        
        // ä¸ºæ¯ä¸ªæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        positionButtons.forEach((button, index) => {
            // è®¾ç½®åˆå§‹æ ·å¼
            button.style.backgroundColor = '#e5e7eb'; // gray-200
            button.style.color = '#374151'; // gray-700
            button.style.cursor = 'pointer';
            button.style.transition = 'all 0.2s ease';
            
            // ä½ç½®æŒ‰é’®çŠ¶æ€åˆ‡æ¢å‡½æ•°
            function togglePositionButton() {
                console.log('ä½ç½®æŒ‰é’®ç‚¹å‡»:', button.textContent, button.dataset.position);
                
                // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                if (button.classList.contains('btn-active')) {
                    // å–æ¶ˆé€‰ä¸­
                    button.classList.remove('btn-active');
                    button.style.backgroundColor = '#e5e7eb'; // gray-200
                    button.style.color = '#374151'; // gray-700
                    console.log('å–æ¶ˆé€‰ä¸­:', button.textContent);
                } else {
                    // é€‰ä¸­
                    button.classList.add('btn-active');
                    button.style.backgroundColor = '#3b82f6'; // blue-500
                    button.style.color = 'white';
                    console.log('é€‰ä¸­:', button.textContent);
                }
                
                // è¾“å‡ºå½“å‰é€‰ä¸­çŠ¶æ€
                const selectedPositions = Array.from(document.querySelectorAll('.position-btn.btn-active'))
                    .map(btn => btn.dataset.position);
                console.log('å½“å‰é€‰ä¸­ä½ç½®:', selectedPositions);
                
                // ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»
                console.log('ä½ç½®é€‰æ‹©å·²æ›´æ”¹ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»');
            }
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†å˜é‡
            let touchStartTime = 0;
            let touchMoved = false;
            let touchHandled = false;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨éè§¦æ‘¸è®¾å¤‡ä¸Šç”Ÿæ•ˆï¼‰
            button.addEventListener('click', function(e) {
                // å¦‚æœè§¦æ‘¸äº‹ä»¶å·²å¤„ç†ï¼Œåˆ™è·³è¿‡clickäº‹ä»¶
                if (touchHandled) {
                    touchHandled = false;
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                togglePositionButton();
            });
            
            // æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†
            button.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchMoved = false;
                touchHandled = false;
                // æ·»åŠ è§¦æ‘¸å¼€å§‹çš„è§†è§‰åé¦ˆ
                this.style.opacity = '0.7';
            }, { passive: true });
            
            button.addEventListener('touchmove', function(e) {
                touchMoved = true;
                // ç§»é™¤è§†è§‰åé¦ˆ
                this.style.opacity = '';
            }, { passive: true });
            
            button.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                // æ¢å¤è§†è§‰åé¦ˆ
                this.style.opacity = '';
                
                // å¦‚æœæ˜¯å¿«é€Ÿç‚¹å‡»ä¸”æ²¡æœ‰ç§»åŠ¨ï¼Œåˆ™è§¦å‘çŠ¶æ€åˆ‡æ¢
                if (!touchMoved && touchDuration < 500) {
                    touchHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    togglePositionButton();
                    // å»¶è¿Ÿé‡ç½®æ ‡å¿—ï¼Œç¡®ä¿clickäº‹ä»¶è¢«è·³è¿‡
                    setTimeout(() => {
                        touchHandled = false;
                    }, 100);
                }
            }, { passive: true });
            
            button.addEventListener('touchcancel', function(e) {
                // æ¢å¤è§†è§‰åé¦ˆ
                this.style.opacity = '';
                touchHandled = false;
            }, { passive: true });
            
            console.log(`ä½ç½®æŒ‰é’® ${index + 1} (${button.textContent}) åˆå§‹åŒ–å®Œæˆ`);
        });
        
        // æ·»åŠ æµ‹è¯•å‡½æ•°
        window.testPositionButton = function() {
            console.log('=== æµ‹è¯•ä½ç½®é€‰æ‹©æŒ‰é’® ===');
            const buttons = document.querySelectorAll('.position-btn');
            if (buttons.length > 0) {
                console.log('æ¨¡æ‹Ÿç‚¹å‡»ç¬¬ä¸€ä¸ªæŒ‰é’®:', buttons[0].textContent);
                buttons[0].click();
            } else {
                console.error('æœªæ‰¾åˆ°ä½ç½®æŒ‰é’®ï¼');
            }
        };
        
        console.log('=== ä½ç½®é€‰æ‹©æŒ‰é’®åˆå§‹åŒ–å®Œæˆ ===');
    }, 100);
    
    console.log('*** ä½ç½®é€‰æ‹©æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ ***');
    
    console.log('*** æŒ‰é’®åˆ›å»ºå®Œæˆï¼Œå¼€å§‹è°ƒè¯•è¾“å‡º ***');
    
    // è°ƒè¯•ï¼šè¾“å‡ºåˆå§‹é€‰æ‹©çŠ¶æ€
    setTimeout(() => {
        console.log('=== åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰é€‰æ‹©çŠ¶æ€ ===');
        console.log('å‰äº”ç æ•°:', document.getElementById('numSelect').value);
        console.log('å‘½ä¸­æ•°å­—:', Array.from(document.querySelectorAll('.hit-number-btn.btn-active')).map(btn => btn.dataset.number));
        console.log('å‘½ä¸­ç æ•°:', Array.from(document.querySelectorAll('#hitButtons .btn-active')).map(btn => btn.dataset.hit));
        console.log('=== åˆå§‹åŒ–çŠ¶æ€è¾“å‡ºå®Œæˆ ===');
        
        // ç§»é™¤è‡ªåŠ¨ç­›é€‰ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æŒ‰é’®
        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æŒ‰é’®è¿›è¡Œç­›é€‰');
    }, 100);
});

// å‰äº”ç æ•°ä¸‹æ‹‰é€‰æ‹©æ¡†äº‹ä»¶ç›‘å¬ - ç§»é™¤ç«‹å³ç­›é€‰
const numSelect = document.getElementById('numSelect');
if (numSelect) {
    numSelect.addEventListener('change', function() {
        console.log('å‰äº”ç æ•°é€‰æ‹©å·²æ›´æ”¹:', this.value);
        // ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»
    });
}

// ä½ç½®é€‰æ‹©æŒ‰é’®äº‹ä»¶å¤„ç†å°†åœ¨DOMContentLoadedä¸­è¿›è¡Œ

let T=null;function D(t){const e=document.getElementById("keyCountdown"),n=document.getElementById("timeRemaining");function o(){const o=new Date,c=new Date(1e3*t)-o;if(c<=0){n.textContent="å·²è¿‡æœŸ",e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500"),clearInterval(T);const deviceId=Y();
// å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰å¯†é’¥ç›¸å…³æ•°æ®
localStorage.removeItem(`validKey_${deviceId}`);
localStorage.removeItem(`keyExpiry_${deviceId}`);
// æ¸…é™¤è®¤è¯çŠ¶æ€
b=!1;
// é™é»˜æ˜¾ç¤ºå¯†é’¥è¾“å…¥ç•Œé¢ï¼Œä¸æ˜¾ç¤ºä»»ä½•å¯¹è¯æ¡†
const keyModal=document.getElementById('keyModal');
if(keyModal){keyModal.classList.remove("hidden");keyModal.style.display="flex";}
// éšè—å€’è®¡æ—¶æ˜¾ç¤º
e.classList.add("hidden");
return;}const r=Math.floor(c/864e5),i=Math.floor(c%864e5/36e5),a=Math.floor(c%36e5/6e4),s=Math.floor(c%6e4/1e3);n.textContent=`${r}å¤© ${i}å°æ—¶ ${a}åˆ†é’Ÿ ${s}ç§’`;const d=24*r+i;d<=24?(e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500")):d<=72?(e.classList.remove("bg-primary","bg-red-500"),e.classList.add("bg-amber-500")):(e.classList.remove("bg-amber-500","bg-red-500"),e.classList.add("bg-primary"))}T&&clearInterval(T),o(),e.classList.remove("hidden"),T=setInterval(o,1e3);}

// æ˜¾ç¤ºå¯†é’¥è¿‡æœŸå¯¹è¯æ¡†
function showKeyExpiredDialog() {
    // åˆ›å»ºè¿‡æœŸæç¤ºå¯¹è¯æ¡†
    const expiredDialog = document.createElement('div');
    expiredDialog.id = 'keyExpiredDialog';
    expiredDialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    expiredDialog.innerHTML = `
        <div style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        ">
            <div style="color: #ef4444; font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
            <h2 style="color: #1f2937; margin-bottom: 15px; font-size: 24px;">å¯†é’¥å·²è¿‡æœŸ</h2>
            <p style="color: #6b7280; margin-bottom: 25px; line-height: 1.5;">
                æ‚¨çš„è®¿é—®å¯†é’¥å·²è¿‡æœŸï¼Œä¸ºäº†ç»§ç»­ä½¿ç”¨ï¼Œè¯·è¾“å…¥æ–°çš„æœ‰æ•ˆå¯†é’¥è¿›è¡ŒéªŒè¯ã€‚
            </p>
            <button onclick="forceReAuthentication()" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                width: 100%;
                transition: background 0.2s;
            " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                é‡æ–°éªŒè¯å¯†é’¥
            </button>
        </div>
    `;
    
    document.body.appendChild(expiredDialog);
}

// å¼ºåˆ¶é‡æ–°è®¤è¯
function forceReAuthentication() {
    // ç§»é™¤è¿‡æœŸå¯¹è¯æ¡†
    const expiredDialog = document.getElementById('keyExpiredDialog');
    if (expiredDialog) {
        expiredDialog.remove();
    }
    
    // æ¸…é™¤æ‰€æœ‰è®¤è¯ç›¸å…³æ•°æ®
    const deviceId = Y();
    localStorage.removeItem(`validKey_${deviceId}`);
    localStorage.removeItem(`keyExpiry_${deviceId}`);
    
    // é‡ç½®è®¤è¯çŠ¶æ€
    b = false;
    
    // æ˜¾ç¤ºå¯†é’¥è¾“å…¥ç•Œé¢
    const keyModal = document.getElementById('keyModal');
    if (keyModal) {
        keyModal.classList.remove("hidden");
        keyModal.style.display = "flex";
    }
    
    // æ¸…ç©ºå¯†é’¥è¾“å…¥æ¡†
    const keyInput = document.getElementById('keyInput');
    if (keyInput) {
        keyInput.value = '';
        keyInput.focus();
    }
    
    // éšè—å€’è®¡æ—¶æ˜¾ç¤º
    const keyCountdown = document.getElementById("keyCountdown");
    if (keyCountdown) {
        keyCountdown.classList.add("hidden");
    }
}function generateDeviceFingerprint(){
  // ä½¿ç”¨å›ºå®šçš„é€šç”¨æŒ‡çº¹ï¼Œå…è®¸å¯†é’¥åœ¨ä»»ä½•è®¾å¤‡ä¸Šä½¿ç”¨
  // è¿™æ ·å¯ä»¥ç¡®ä¿å¯†é’¥çš„è·¨è®¾å¤‡å…¼å®¹æ€§
    return 'universal_device_2024';
 }

// ç”Ÿæˆæ ¡éªŒå’Œå‡½æ•°
function generateChecksum(data) {
    // ä½¿ç”¨ä¸å¯†é’¥ç”Ÿæˆå™¨ç›¸åŒçš„å¢å¼ºæ ¡éªŒå’Œç®—æ³•
    return generateEnhancedChecksum(data);
}

// ç”Ÿæˆç¡®å®šæ€§æ ¡éªŒå’Œï¼ˆ6ä¸ªå­—ç¬¦ï¼‰- éªŒè¯æ—¶å¿…é¡»ç¡®å®šæ€§
function generateEnhancedChecksum(input) {
    // ä½¿ç”¨å¤šé‡å“ˆå¸Œç®—æ³•ä½†ä¿æŒç¡®å®šæ€§
    let hash1 = 0;
    let hash2 = 0;
    
    for (let i = 0; i < input.length; i++) {
        const char = input.charCodeAt(i);
        // ç¬¬ä¸€ä¸ªå“ˆå¸Œ
        hash1 = ((hash1 << 5) - hash1) + char;
        hash1 = hash1 & hash1;
        
        // ç¬¬äºŒä¸ªå“ˆå¸Œï¼ˆä¸åŒçš„ç®—æ³•ï¼‰
        hash2 = ((hash2 << 3) + hash2) ^ char;
        hash2 = hash2 & hash2;
    }
    
    // ç»„åˆä¸¤ä¸ªå“ˆå¸Œå€¼ï¼ˆç§»é™¤æ—¶é—´æˆ³å¾®æ‰°åŠ¨ä»¥ä¿æŒç¡®å®šæ€§ï¼‰
    const combinedHash = Math.abs(hash1) + Math.abs(hash2);
    
    // ç”Ÿæˆ6ä½æ ¡éªŒå’Œ
    let checksum = combinedHash.toString(36).substring(0, 6);
    if (checksum.length < 6) {
        // å¦‚æœä¸è¶³6ä½ï¼Œç”¨ç¡®å®šæ€§å­—ç¬¦è¡¥å……
        const padding = '0123456789abcdefghijklmnopqrstuvwxyz';
        for (let i = checksum.length; i < 6; i++) {
            checksum += padding[(combinedHash + i) % padding.length];
        }
    }
    
    return checksum.substring(0, 6);
}

// ç”Ÿæˆå®‰å…¨éšæœºå­—ç¬¦ä¸²ï¼ˆä¸å¯†é’¥ç”Ÿæˆå™¨ä¿æŒä¸€è‡´ï¼‰
function generateSecureRandomString(length) {
    const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
    
    // æ£€æŸ¥æ˜¯å¦æ”¯æŒcrypto API
    if (window.crypto && window.crypto.getRandomValues) {
        const array = new Uint8Array(length);
        window.crypto.getRandomValues(array);
        
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[array[i] % chars.length];
        }
        return result;
    } else {
        // é™çº§åˆ°Math.random()ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
        }
        return result;
    }
}

// çº¯æœ¬åœ°è®°å½•å¯†é’¥ä½¿ç”¨ä¿¡æ¯
function recordKeyUsage(keyData) {
    try {
        const deviceId = generateDeviceFingerprint();
        const localRecord = {
            keyId: keyData.nonce,
            deviceId: deviceId,
            deviceInfo: navigator.userAgent,
            usedAt: new Date().toISOString(),
            expiresAt: new Date(keyData.expiry * 1000).toISOString(),
            savedLocally: true
        };
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem(`keyRecord_${keyData.nonce}`, JSON.stringify(localRecord));
        console.log('å¯†é’¥ä½¿ç”¨è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°:', localRecord);
        
        return { success: true, data: localRecord, localBackup: true };
    } catch (error) {
        console.error('è®°å½•å¯†é’¥ä½¿ç”¨ä¿¡æ¯å¤±è´¥:', error);
        return { success: false, error: error.message };
    }
}

// çº¯æœ¬åœ°å¯†é’¥ä½¿ç”¨çŠ¶æ€æ£€æŸ¥
function O(t){console.log("ä½¿ç”¨æœ¬åœ°éªŒè¯æ£€æŸ¥å¯†é’¥:",t);return{used:JSON.parse(localStorage.getItem("usedNonces")||"[]").includes(t)}}// çº¯æœ¬åœ°å¯†é’¥æ ‡è®°ä¸ºå·²ä½¿ç”¨
function K(t){console.log("æœ¬åœ°æ ‡è®°å¯†é’¥ä¸ºå·²ä½¿ç”¨:",t);const e=JSON.parse(localStorage.getItem("usedNonces")||"[]");return e.includes(t)||(e.push(t),localStorage.setItem("usedNonces",JSON.stringify(e)),console.log("æœ¬åœ°è®°å½•nonce:",t)),{success:!0}}
const P=document.getElementById("verifyKeyBtn");function E(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return null;e=t.trim().split(/\s+/)}if(e.length<2)return null;const n=e[0].trim();let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return null;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}return 10!==o.length||o.some(isNaN)?null:{period:n,data:o}}async function A(t){try{// æ”¯æŒæ–°çš„çŸ­å¯†é’¥æ ¼å¼ï¼ˆçº¦22ä¸ªå­—ç¬¦ï¼‰
if(t.length <= 25) {
// çŸ­å¯†é’¥æ ¼å¼ï¼šå‰4ä½æ ‡è¯†ç¬¦ + 6ä½æ—¶é—´æˆ³ + 6ä½éšæœºå¡«å…… + 6ä½æ ¡éªŒå’Œ = 22ä½
if(t.length < 20 || t.length > 25) return {valid: false, reason: "å¯†é’¥æ ¼å¼æ— æ•ˆ"};

const identifier = t.substring(0, 4);
const timestampPart = t.substring(4, 10);
const randomPadding = t.substring(10, 16);
const checksum = t.substring(16, 22);

// è§£ææœ‰æ•ˆæœŸï¼ˆæ–°çš„éšæœºæ ‡è¯†ç¬¦æ ¼å¼ï¼‰
// æ ‡è¯†ç¬¦ç°åœ¨æ˜¯å®Œå…¨éšæœºçš„ï¼Œä¸å†ç”¨äºè¯†åˆ«æœ‰æ•ˆæœŸ
// æ—¶é—´æˆ³éƒ¨åˆ†ç›´æ¥åŒ…å«è¿‡æœŸæ—¶é—´æˆ³
const expiry = parseInt(timestampPart, 36);

// éªŒè¯æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆï¼ˆåŸºæœ¬èŒƒå›´æ£€æŸ¥ï¼‰
if (isNaN(expiry) || expiry <= 0) {
    return {valid: false, reason: "å¯†é’¥æ—¶é—´æˆ³æ— æ•ˆ"};
}

// æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
const currentTime = Math.floor(Date.now() / 1000);
if(currentTime > expiry) {
return {valid: false, reason: "å¯†é’¥å·²è¿‡æœŸ"};
}

// éªŒè¯æ ¡éªŒå’Œ
const expectedChecksum = generateChecksum(identifier + timestampPart + randomPadding);
if(checksum !== expectedChecksum) {
return {valid: false, reason: "å¯†é’¥æ ¡éªŒå¤±è´¥"};
}

// ğŸ”’ ç¬¬ä¸€æ­¥ï¼šå…ˆå‘æœåŠ¡å™¨éªŒè¯ï¼ˆå¯†é’¥åº“æ£€æŸ¥ï¼‰
        const nonce = t; // ä½¿ç”¨æ•´ä¸ªçŸ­å¯†é’¥ä½œä¸ºnonce
        console.log('ğŸ”’ æ­¥éª¤1: å‘æœåŠ¡å™¨éªŒè¯å¯†é’¥:', nonce);
        
        try {
            // æ ¹æ®ç¯å¢ƒé€‰æ‹©APIåœ°å€
            const serverCheckUrl = '/api/keys/check-usage';
            
            const serverResponse = await fetch(serverCheckUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: nonce })
            });
            
            const serverResult = await parseServerJson(serverResponse, 'çŸ­å¯†é’¥æ£€æŸ¥æœåŠ¡');
            console.log('æœåŠ¡å™¨éªŒè¯ç»“æœ:', serverResult);
            
            // å¦‚æœå¯†é’¥å·²è¢«ä½¿ç”¨ï¼Œåˆ™æ‹’ç»
            if (serverResult.success && serverResult.used) {
                return {valid: false, reason: "âŒ å¯†é’¥å·²è¢«ä½¿ç”¨"};
            }
            
            console.log('âœ… æœåŠ¡å™¨éªŒè¯é€šè¿‡ï¼ˆå¯†é’¥ä¸åœ¨åº“ä¸­æˆ–å·²è¿‡æœŸï¼‰');
        } catch (serverError) {
            console.warn('âš ï¸ æœåŠ¡å™¨éªŒè¯å¤±è´¥ï¼Œç»§ç»­æœ¬åœ°éªŒè¯:', serverError);
            // æœåŠ¡å™¨ä¸å¯ç”¨æ—¶ï¼Œç»§ç»­æœ¬åœ°éªŒè¯ï¼ˆå®¹é”™æœºåˆ¶ï¼‰
        }
        
        // ğŸ”’ ç¬¬äºŒæ­¥ï¼šæœ¬åœ°éªŒè¯ï¼ˆlocalStorageæ£€æŸ¥ï¼‰
        console.log('ğŸ”’ æ­¥éª¤2: æœ¬åœ°éªŒè¯å¯†é’¥');
        
        // æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²è¢«ä½¿ç”¨
        const usedNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
        if (usedNonces.includes(nonce)) {
            return {valid: false, reason: "å¯†é’¥å·²è¢«ä½¿ç”¨ï¼Œæ¯ä¸ªå¯†é’¥åªèƒ½ä½¿ç”¨ä¸€æ¬¡"};
        }
        
        // æœ¬åœ°æ ‡è®°ä¸ºå·²ä½¿ç”¨
        usedNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(usedNonces));
        console.log('âœ… æœ¬åœ°æ ‡è®°çŸ­å¯†é’¥ä¸ºå·²ä½¿ç”¨:', nonce);
        
        // ğŸ”’ ç¬¬ä¸‰æ­¥ï¼šå‘æœåŠ¡å™¨æ³¨å†Œå¯†é’¥ï¼ˆè®°å½•ä½¿ç”¨ï¼‰
        try {
            // æ ¹æ®ç¯å¢ƒé€‰æ‹©APIåœ°å€
            const registerUrl = '/api/keys/validate-and-register';
            
            await fetch(registerUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    key: nonce,
                    validDays: Math.ceil((expiry - currentTime) / 86400)
                })
            });
            console.log('âœ… å¯†é’¥å·²æ³¨å†Œåˆ°æœåŠ¡å™¨');
        } catch (registerError) {
            console.warn('âš ï¸ å‘æœåŠ¡å™¨æ³¨å†Œå¯†é’¥å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰:', registerError);
        }
        
        // ğŸ”’ ä¿å­˜å½“å‰å¯†é’¥ä»¥ä¾¿å®šæœŸéªŒè¯
        _0xCurrentKey = nonce;
        console.log('âœ… å¯†é’¥å·²ä¿å­˜ï¼Œå°†å®šæœŸå‘æœåŠ¡å™¨éªŒè¯æœ‰æ•ˆæ€§');
        
        return {valid: true, data: {nonce: nonce, expiry: expiry, deviceFingerprint: "universal"}};
}

// çº¯æœ¬åœ°é•¿å¯†é’¥æ ¼å¼éªŒè¯ - é•¿å¯†é’¥å·²å…¨éƒ¨å¤±æ•ˆ
const e=atob(t),n=decodeURIComponent(escape(e)),o=JSON.parse(n);if(!o.expiry||!o.nonce||!o.deviceFingerprint)return{valid:!1,reason:"å¯†é’¥ç¼ºå°‘å¿…è¦å­—æ®µ"};const c=(new Date).getTime();if(Math.floor(c/1e3)>o.expiry)return{valid:!1,reason:"å¯†é’¥å·²è¿‡æœŸ"};const r=generateDeviceFingerprint();if(o.deviceFingerprint!==r)return{valid:!1,reason:"æ­¤å¯†é’¥ä¸å¯åœ¨å½“å‰è®¾å¤‡ä½¿ç”¨"};console.log('æ£€æµ‹åˆ°é•¿å¯†é’¥ï¼Œå·²å¤±æ•ˆ:',o.nonce);return{valid:!1,reason:"é•¿å¯†é’¥å·²å¤±æ•ˆï¼Œè¯·ä½¿ç”¨æ–°çš„çŸ­å¯†é’¥"}}catch(t){return t instanceof DOMException&&"InvalidCharacterError"===t.name?{valid:!1,reason:"å¯†é’¥Base64è§£ç å¤±è´¥"}:t instanceof SyntaxError?{valid:!1,reason:"å¯†é’¥JSONæ ¼å¼æ— æ•ˆ"}:{valid:!1,reason:"éªŒè¯è¿‡ç¨‹å¼‚å¸¸: "+t.message}}}

// çº¯æœ¬åœ°æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²è¢«ä½¿ç”¨
function checkKeyOnlineUsage(nonce) {
    try {
        console.log('ä½¿ç”¨çº¯æœ¬åœ°éªŒè¯æ£€æŸ¥å¯†é’¥:', nonce);
        const usedNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
        const isUsed = usedNonces.includes(nonce);
        console.log('å¯†é’¥ä½¿ç”¨çŠ¶æ€:', isUsed);
        return { used: isUsed };
    } catch (error) {
        console.error('æ£€æŸ¥å¯†é’¥ä½¿ç”¨çŠ¶æ€æ—¶å‡ºé”™:', error);
        return { used: false };
    }
}

// çº¯æœ¬åœ°æ ‡è®°å¯†é’¥ä¸ºå·²ä½¿ç”¨
function markKeyAsUsedOnline(nonce) {
    console.log('ä½¿ç”¨çº¯æœ¬åœ°æ ‡è®°å¯†é’¥ä¸ºå·²ä½¿ç”¨:', nonce);
    const usedNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
    if (!usedNonces.includes(nonce)) {
        usedNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(usedNonces));
        console.log('æœ¬åœ°æ ‡è®°nonce:', nonce);
    }
    return { success: true };
}

    // çº¯æœ¬åœ°è®°å½•å¯†é’¥ä½¿ç”¨ä¿¡æ¯ï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰
    function recordKeyUsageBackup(keyData) {
      try {
        const localRecord = {
            keyId: keyData.nonce,
            deviceInfo: navigator.userAgent,
            usedAt: new Date().toISOString(),
            expiryTime: new Date(keyData.expiry * 1000).toISOString(),
            createdTime: new Date().toISOString(),
            savedLocally: true
        };
        
        localStorage.setItem(`keyRecordBackup_${keyData.nonce}`, JSON.stringify(localRecord));
        console.log('å¯†é’¥ä½¿ç”¨è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆå¤‡ç”¨ï¼‰:', localRecord);
        return { success: true, data: localRecord, localBackup: true };
      } catch (error) {
        console.error('è®°å½•å¯†é’¥ä½¿ç”¨ä¿¡æ¯å¤±è´¥:', error);
        // ç½‘ç»œå¤±è´¥æ—¶çš„æœ¬åœ°å¤‡ç”¨æ–¹æ¡ˆ
        const localRecord = {
          keyId: keyData.nonce,
          deviceInfo: navigator.userAgent,
          usedAt: new Date().toISOString(),
          savedLocally: true
        };
        localStorage.setItem(`keyRecord_${keyData.nonce}`, JSON.stringify(localRecord));
        return { success: false, error: error.message, localBackup: true };
      }
    }

function F(){const t=document.getElementById("numbersInput").value.trim().split(/\n+/).filter(Boolean);if(!t.length)return void(v.textContent="è¯·è¾“å…¥æ•°æ®");let e=0;for(const n of t){const t=E(n);if(!t)return void(v.textContent="æ ¼å¼é”™è¯¯ï¼šè¯·è¾“å…¥æ­£ç¡®çš„æ•°æ®æ ¼å¼");const{period:o,data:c}=t,i=c.join(",");d.has(o)||r.length&&r[r.length-1].input===i||(r.push({period:o,data:c,input:i}),d.add(o),e++)}document.getElementById("numbersInput").value="",v.textContent=e>0?`æˆåŠŸæ·»åŠ  ${e} æœŸæ•°æ®`:"æ²¡æœ‰æ–°æ•°æ®æ·»åŠ ";console.log(`F()å‡½æ•°: æ·»åŠ  ${e} æœŸæ–°æ•°æ®åï¼Œæ•°æ®æ•°ç»„é•¿åº¦ä¸º ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`F()å‡½æ•°: æœŸæ•°ç»Ÿè®¡å·²æ›´æ–°ä¸º ${r.length}`);r.sort((t,e)=>parseInt(e.period) - parseInt(t.period)); 
    // è°ƒç”¨è¡¨æ ¼æ¸²æŸ“å‡½æ•°æ˜¾ç¤ºæ•°æ®
    L();
    console.log('F()å‡½æ•°: å·²è°ƒç”¨L()å‡½æ•°æ¸²æŸ“è¡¨æ ¼');
}
// äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - Jå‡½æ•°ä¸­çš„APIè°ƒç”¨ä»£ç å·²ç§»é™¤
// æ›¿ä»£å‡½æ•°ï¼šç¦ç”¨äº‘ç«¯æ•°æ®è·å–åŠŸèƒ½
function J(){
    v.textContent="äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ®";
    console.log('äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨');
}
function R(t,e){const n=[];return function o(c,r){if(r.length!==e)for(let e=c;e<t.length;e++)r.push(t[e]),o(e+1,r),r.pop();else n.push(r.slice())}(0,[]),n}

/**
 * é»„é‡‘åˆ‡å‰²ï¼ˆå¿…é¡» 5 ä¸­ 4ï¼‰ï¼šä»»æ„æ³¨æ•° â†’ 5 ç»„
 * æ€è·¯ï¼šä¸ºæ¯æ¡æ³¨å•æŒ‡å®šå”¯ä¸€"ç¼ºå¸­ç»„"omitted = 0..4
 * ç¬¬ g ç»„æ”¶é›†æ‰€æœ‰ omitted !== g çš„æ³¨å•
 * ç»“è®ºï¼šä»»æ„ 4 ç»„åˆå¹¶ = å…¨é›†ï¼ˆä¸¥æ ¼ä¿è¯ï¼‰
 * 
 * assign: 'roundrobin' æ›´å‡åŒ€ï¼›'hash' æ›´ç¨³å®šï¼ˆåŒä¸€æ³¨å•é•¿æœŸè½åŒä¸€ç¼ºå¸­ç»„ï¼‰
 */
function goldenSplit5in4(data, assign = 'roundrobin') {
  const G = 5;
  const groups = Array.from({ length: G }, () => []);

  // ç¼ºå¸­ç»„ç´¢å¼•ï¼ˆæ¯æ³¨å”¯ä¸€ï¼‰
  const omittedIdx = new Array(data.length);

  if (assign === 'hash') {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = hash5(data[i]); // 0..4
    }
  } else {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = i % G; // è½®è½¬
    }
  }

  // æ„å»º 5 ç»„ï¼šæ¯æ³¨å‡ºç°åœ¨ 4 ä¸ªç»„
  for (let i = 0; i < data.length; i++) {
    const omit = omittedIdx[i];
    for (let g = 0; g < G; g++) {
      if (g !== omit) groups[g].push(data[i]);
    }
  }
  return groups;

  function hash5(str) {
    let h = 2166136261 >>> 0;
    for (let j = 0; j < str.length; j++) {
      h ^= str.charCodeAt(j);
      h = Math.imul(h, 16777619);
    }
    return h % 5;
  }
}

/** æ ¡éªŒï¼šä»»æ„å››ç»„åˆå¹¶æ˜¯å¦ç­‰äºå…¨é›†ï¼ˆä¸¥æ ¼ 5 ä¸­ 4ï¼‰ */
function validate5in4(groups, original) {
  const uniq = (arr) => Array.from(new Set(arr));
  const origSet = new Set(uniq(original));
  const G = groups.length;

  for (let miss = 0; miss < G; miss++) {
    const merged = new Set();
    for (let g = 0; g < G; g++) {
      if (g === miss) continue;
      for (const x of groups[g]) merged.add(x);
    }
    if (merged.size !== origSet.size) return false;
    // ä¹Ÿå¯é€æ¡æ ¸å¯¹
    for (const x of origSet) if (!merged.has(x)) return false;
  }
  return true;
}

/** è§£æè¾“å…¥ï¼šæ”¯æŒæ¢è¡Œ/é€—å·åˆ†éš”ï¼›è‡ªåŠ¨å»é‡ï¼›ä¿æŒåŸé¡ºåºçš„å”¯ä¸€åŒ– */
function parseInput(raw) {
  const parts = raw
    .split(/[\n,]+/g)
    .map(s => s.trim())
    .filter(Boolean);
  const seen = new Set();
  const out = [];
  for (const p of parts) {
    if (!seen.has(p)) { seen.add(p); out.push(p); }
  }
  return out;
}

// éªŒè¯ä»»æ„4ç»„ç»„åˆåæ˜¯å¦ä¸ºå…¨é›†
function validate_5in4(groups) {
    if (!groups || groups.length < 4) {
        return {
            valid: false,
            results: {},
            all_valid: false,
            total_data_size: 0
        };
    }
    
    // è·å–æ‰€æœ‰æ•°æ®çš„å¹¶é›†
    const all_set = new Set();
    groups.forEach(group => {
        group.forEach(item => all_set.add(item));
    });
    
    const results = {};
    const total_data_size = all_set.size;
    
    // ç”Ÿæˆæ‰€æœ‰4ç»„çš„ç»„åˆ
    const combinations = [];
    for (let i = 0; i < groups.length; i++) {
        for (let j = i + 1; j < groups.length; j++) {
            for (let k = j + 1; k < groups.length; k++) {
                for (let l = k + 1; l < groups.length; l++) {
                    combinations.push([i, j, k, l]);
                }
            }
        }
    }
    
    // éªŒè¯æ¯ä¸ª4ç»„ç»„åˆ
    combinations.forEach(combo => {
        const merged = new Set();
        combo.forEach(i => {
            groups[i].forEach(item => merged.add(item));
        });
        
        const is_complete = merged.size === total_data_size;
        results[combo.join(',')] = {
            combo: combo,
            size: merged.size,
            is_complete: is_complete,
            coverage: total_data_size > 0 ? (merged.size / total_data_size) : 0
        };
    });
    
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç»„åˆéƒ½å®Œæ•´
    const all_valid = Object.values(results).every(r => r.is_complete);
    
    return {
        valid: all_valid,
        results: results,
        all_valid: all_valid,
        total_data_size: total_data_size,
        combinations_count: combinations.length
    };
}

// æ¸²æŸ“é»„é‡‘åˆ‡å‰²ç»“æœ - 5ä¸ªç´§å‡‘æ¡†å¸ƒå±€
function renderGoldenResults(groups, originalItems = [], isValid = false) {
    const resultsContainer = document.getElementById('goldenResults');
    const resultSummary = document.getElementById('resultSummary');
    const validationResults = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    resultsContainer.innerHTML = '';
    
    if (!groups || groups.length === 0) {
        resultsContainer.innerHTML = '<div class="col-span-5 text-center text-gray-500 py-8">æš‚æ— åˆ†å‰²ç»“æœ</div>';
        resultSummary.textContent = '';
        validationResults.classList.add('hidden');
        return;
    }
    
    // æ›´æ–°æ‘˜è¦ä¿¡æ¯
    const totalItems = groups.reduce((sum, group) => sum + group.length, 0);
    const avgGroupSize = Math.round(totalItems / groups.length);
    resultSummary.innerHTML = `å…±${groups.length}ç»„ï¼Œæ€»è®¡${totalItems}é¡¹ï¼Œå¹³å‡æ¯ç»„${avgGroupSize}é¡¹ | éªŒè¯ç»“æœï¼š${isValid ? '<span class="text-green-600 font-semibold">âœ… é€šè¿‡</span>' : '<span class="text-red-600 font-semibold">âŒ å¤±è´¥</span>'}`;
    
    // æ˜¾ç¤ºéªŒè¯ç»“æœ
    if (originalItems.length > 0) {
        validationContent.innerHTML = `
            <div class="text-sm text-gray-600">
                <p class="mb-2">åŸå§‹æ•°æ®ï¼š${originalItems.length} æ³¨</p>
                <p class="mb-2">åˆ†ç»„ç»“æœï¼š${groups.length} ç»„</p>
                <p class="mb-2">5ä¸­4éªŒè¯ï¼š${isValid ? '<span class="text-green-600 font-semibold">é€šè¿‡ - ä»»æ„4ç»„åˆå¹¶ç­‰äºå…¨é›†</span>' : '<span class="text-red-600 font-semibold">å¤±è´¥ - ä¸æ»¡è¶³5ä¸­4æ¡ä»¶</span>'}</p>
            </div>
        `;
        validationResults.classList.remove('hidden');
    } else {
        validationResults.classList.add('hidden');
    }
    
    // ç¡®ä¿æ˜¾ç¤º5ä¸ªæ¡†ï¼Œä¸è¶³çš„ç”¨ç©ºæ¡†å¡«å……
    const displayGroups = [...groups];
    while (displayGroups.length < 5) {
        displayGroups.push([]);
    }
    
    // ç”Ÿæˆ5ä¸ªç´§å‡‘çš„åˆ†ç»„æ¡†
    displayGroups.slice(0, 5).forEach((group, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'bg-white border border-gray-200 rounded-lg p-3';
        
        if (group.length === 0) {
            // ç©ºæ¡†
            groupDiv.innerHTML = `
                <div class="text-center text-gray-400 py-4">
                    <div class="text-sm font-medium mb-1">ç»„ ${index + 1}</div>
                    <div class="text-xs">æš‚æ— æ•°æ®</div>
                </div>
            `;
        } else {
            // æœ‰æ•°æ®çš„æ¡†
            groupDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-800 text-sm">ç»„ ${index + 1}</h4>
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">${group.length}é¡¹</span>
                        <button 
                            onclick="copyGroupData(${index})" 
                            class="px-1 py-0.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                            title="å¤åˆ¶æœ¬ç»„æ•°æ®"
                        >
                            å¤åˆ¶
                        </button>

                    </div>
                </div>
                <div class="max-h-32 overflow-y-auto">
                    <div class="text-xs space-y-1" id="group-${index}-data" data-full-data="${group.join(',')}">
                        ${group.slice(0, 200).map(item => `<div class="p-1 bg-gray-50 rounded text-center hover:bg-gray-100 transition-colors">${item}</div>`).join('')}
                        ${group.length > 200 ? '<div class="p-1 text-center text-gray-400 text-xs">...è¿˜æœ‰' + (group.length - 200) + 'é¡¹</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        resultsContainer.appendChild(groupDiv);
    });
}

// å¤åˆ¶ç»„æ•°æ®åŠŸèƒ½
function copyGroupData(groupIndex) {
    const groupDataDiv = document.getElementById(`group-${groupIndex}-data`);
    if (!groupDataDiv) {
        alert('æœªæ‰¾åˆ°æ•°æ®');
        return;
    }
    
    // ä»data-full-dataå±æ€§è·å–å®Œæ•´æ•°æ®ï¼Œç¡®ä¿å¤åˆ¶å…¨éƒ¨æ•°æ®è€Œä¸å—æ˜¾ç¤ºé™åˆ¶å½±å“
    const dataText = groupDataDiv.getAttribute('data-full-data') || '';
    
    if (!dataText) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®');
        return;
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(dataText).then(() => {
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            showCopySuccess(groupIndex);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            fallbackCopyTextToClipboard(dataText, groupIndex);
        });
    } else {
        fallbackCopyTextToClipboard(dataText, groupIndex);
    }
}

// å¤‡ç”¨å¤åˆ¶æ–¹æ³•
function fallbackCopyTextToClipboard(text, groupIndex) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    textArea.style.opacity = '0';
    textArea.style.pointerEvents = 'none';
    // é˜²æ­¢ç§»åŠ¨ç«¯å¼¹å‡ºè¾“å…¥æ³•
    textArea.readOnly = true;
    textArea.setAttribute('readonly', 'readonly');
    textArea.setAttribute('inputmode', 'none');
    document.body.appendChild(textArea);
    
    // åœ¨ç§»åŠ¨ç«¯é¿å…ä½¿ç”¨focusï¼Œç›´æ¥é€‰æ‹©æ–‡æœ¬
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobile) {
        textArea.focus();
    }
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(groupIndex);
        } else {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
        }
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
    }
    
    document.body.removeChild(textArea);
}

// é‡ç½®æ‰€æœ‰å¤åˆ¶æŒ‰é’®çŠ¶æ€ï¼ˆä»…åœ¨é‡æ–°åˆ‡å‰²æ—¶è°ƒç”¨ï¼‰
function resetAllCopyButtons() {
    const allCopyButtons = document.querySelectorAll('button[onclick^="copyGroupData("]');
    allCopyButtons.forEach(btn => {
        btn.innerHTML = 'å¤åˆ¶';
        btn.classList.remove('bg-green-500');
        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    });
}

// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
function showCopySuccess(groupIndex) {
    // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºå·²å¤åˆ¶çŠ¶æ€ï¼ˆæŒä¹…æ˜¾ç¤ºï¼‰
    const button = document.querySelector(`button[onclick="copyGroupData(${groupIndex})"]`);
    if (button) {
        button.innerHTML = '<i class="fa fa-check"></i> å·²å¤åˆ¶';
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        button.classList.add('bg-green-500');
    }
}



// æ¸²æŸ“éªŒè¯ç»“æœ
function renderValidationResults(validation) {
    const validationContainer = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    if (!validation || !validation.results) {
        validationContainer.classList.add('hidden');
        return;
    }
    
    validationContainer.classList.remove('hidden');
    
    let html = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                æ€»æ•°æ®é‡: ${validation.total_data_size} æ³¨ | 
                éªŒè¯ç»„åˆæ•°: ${validation.combinations_count} ä¸ª | 
                æ•´ä½“éªŒè¯: ${validation.all_valid ? '<span class="text-green-600 font-semibold">âœ… é€šè¿‡</span>' : '<span class="text-red-600 font-semibold">âŒ å¤±è´¥</span>'}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;
    
    Object.entries(validation.results).forEach(([comboKey, result]) => {
        const comboText = result.combo.map(i => `ç»„${i + 1}`).join(' + ');
        const statusClass = result.is_complete ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const statusIcon = result.is_complete ? 'âœ…' : 'âŒ';
        
        html += `
            <div class="${statusClass} border rounded-lg p-3">
                <div class="font-medium text-sm">${comboText}</div>
                <div class="text-xs text-gray-600 mt-1">
                    ${result.size}æ³¨ (${(result.coverage * 100).toFixed(1)}%) ${statusIcon}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    validationContent.innerHTML = html;
}function H(t,e){const n={};return e.forEach(e=>{let o=0,c=0,r=0,i=0;t.forEach(t=>{t.cells[e].hit?(r++,i=0,r>o&&(o=r)):(i++,r=0,i>c&&(c=i))}),n[e]={maxHit:o,maxMiss:c}}),n}function U(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&t[n].cells[e].hit;n++)o++;n[e]=o}),n}function z(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&!t[n].cells[e].hit;n++)o++;n[e]=o}),n}function L(){
const t=document.querySelector("#resultTable thead"),e=document.querySelector("#resultTable tbody");t.innerHTML="",e.innerHTML="";console.log('ç­›é€‰å‡½æ•°L()å¼€å§‹æ‰§è¡Œï¼Œæ•°æ®é•¿åº¦:', r.length);if(!r.length){const t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=100,n.className="py-4 text-center text-gray-500",n.textContent="æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè¾“å…¥æˆ–è·å–æ•°æ®",t.appendChild(n),e.appendChild(t)}console.log('æ•°æ®å­˜åœ¨ï¼Œå¼€å§‹å¤„ç†è¡¨æ ¼æ¸²æŸ“');// ä»ä¸‹æ‹‰é€‰æ‹©æ¡†è·å–å‰äº”ç æ•°
const numSelect = document.getElementById('numSelect');
const selectedNums = numSelect && numSelect.value ? [parseInt(numSelect.value)] : [];

// ä»æŒ‰é’®è·å–ä½ç½®é€‰æ‹©
const selectedPositions = Array.from(document.querySelectorAll('.position-btn.btn-active')).map(btn => parseInt(btn.dataset.position));

// ä»æŒ‰é’®è·å–å‘½ä¸­æ•°å­—é€‰æ‹©
const selectedHitNumbers = Array.from(document.querySelectorAll('.hit-number-btn.btn-active')).map(btn => parseInt(btn.dataset.number));

const c=Array.from(document.querySelectorAll("#hitButtons .btn-active")).map(t=>+t.dataset.hit),i=[...Array(10)].map((t,e)=>e+1);

// ä½¿ç”¨å®Œæ•´çš„æ•°æ®æ•°ç»„ï¼Œä¸è¿›è¡Œæˆªå–
const n = r.slice(); // ä½¿ç”¨å®Œæ•´æ•°æ®
console.log('L()å‡½æ•°: ä½¿ç”¨å®Œæ•´æ•°æ®æ•°ç»„ï¼Œé•¿åº¦ä¸º', n.length, 'æœŸæ•°é™åˆ¶fä¸º', f);

// ç”Ÿæˆç­›é€‰åçš„ç»„åˆ
let filteredCombos = [];
// è·å–å‰äº”ç æ•°é€‰æ‹©
const numToSelect = selectedNums.length > 0 ? selectedNums[0] : (numSelect && numSelect.value ? parseInt(numSelect.value) : 3);

// æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©æ¡ä»¶ï¼Œå¦‚æœéƒ½æ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨é»˜è®¤é€»è¾‘
if (selectedHitNumbers.length > 0 && c.length > 0) {
  // æ ¹æ®å‰äº”ç æ•°ã€å‘½ä¸­ç æ•°ã€å‘½ä¸­æ•°å­—è¿›è¡Œç­›é€‰
  const allCombos = R(i, numToSelect); // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ç»„åˆ
  
  const validCombos = allCombos.filter(combo => {
    // æ£€æŸ¥ç»„åˆä¸­åŒ…å«çš„å‘½ä¸­æ•°å­—ä¸ªæ•°
    const hitCount = combo.filter(num => selectedHitNumbers.includes(num)).length;
    return c.includes(hitCount); // å‘½ä¸­ä¸ªæ•°å¿…é¡»åœ¨é€‰ä¸­çš„å‘½ä¸­ç æ•°èŒƒå›´å†…
  });
  
  // å¯¹æ¯ä¸ªæœ‰æ•ˆç»„åˆè¿›è¡Œå±•å¼€ï¼šå°†æ¯ä¸ªæ•°å­—è½®æµç½®ä¸ºç¬¬1ä½
  filteredCombos = [];
  validCombos.forEach(combo => {
    combo.forEach(firstNum => {
      const remainingNums = combo.filter(num => num !== firstNum).sort((a, b) => a - b);
      const expandedCombo = [firstNum, ...remainingNums];
      filteredCombos.push(expandedCombo);
    });
  });
} else {
  // å½“æ²¡æœ‰é€‰æ‹©å‘½ä¸­æ•°å­—æˆ–å‘½ä¸­ç æ•°æ—¶çš„é»˜è®¤é€»è¾‘
  if (selectedNums.length > 0) {
    filteredCombos = selectedNums.flatMap(o=>o>0&&o<=10?R(i,o):[]);
  } else {
    // å¦‚æœå‰äº”ç æ•°ä¹Ÿæ²¡æœ‰é€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤çš„3ç ç»„åˆ
    filteredCombos = R(i, numToSelect);
  }
}

// åˆå¹¶ç­›é€‰ç»„åˆå’Œè‡ªå®šä¹‰ç»„åˆ
let allCombos = [...filteredCombos,...document.getElementById("customCombos").value.trim().split(/\s+/).filter(Boolean).map(t=>t.split(",").map(t=>+t).filter(t=>!isNaN(t)))].filter(t=>t.length>0);

// å¯¹ç›¸åŒæ•°å­—ç»„åˆè¿›è¡Œå»é‡å¤„ç†
const uniqueCombos = new Map();
allCombos.forEach(combo => {
    // å°†æ•°å­—ç»„åˆæ’åºåä½œä¸ºå”¯ä¸€æ ‡è¯†
    const sortedKey = combo.slice().sort((a,b)=>a-b).join(',');
    if (!uniqueCombos.has(sortedKey)) {
        uniqueCombos.set(sortedKey, combo.join(','));
    }
});

// è·å–å»é‡åçš„ç»„åˆæ•°ç»„
const a = Array.from(uniqueCombos.values());
// æ ¹æ®æœŸæ•°é™åˆ¶æˆªå–æ•°æ®ç”¨äºæ˜¾ç¤ºï¼Œä½†ç¡®ä¿ä¸è¶…è¿‡å®é™…æ•°æ®é•¿åº¦
const actualLimit = Math.min(n.length, f);
const displayData = n.slice(0, actualLimit);
const s=displayData.map(t=>({rec:t,cells:{}}));
// ä¿®å¤åˆ†é¡µè®¡ç®—ï¼šç¡®ä¿totalPagesåŸºäºå®é™…æ˜¾ç¤ºçš„æ•°æ®è¡Œæ•°
totalPages=Math.max(1, Math.ceil(s.length/pageSize));
console.log('åŸå§‹ç»„åˆæ•°é‡:', allCombos.length);
console.log('å»é‡åç»„åˆæ•°é‡:', a.length);
console.log('å®Œæ•´æ•°æ®é•¿åº¦:', n.length, 'æœŸæ•°é™åˆ¶:', f, 'å®é™…é™åˆ¶:', actualLimit);
console.log('æ˜¾ç¤ºæ•°æ®é•¿åº¦:', displayData.length);
console.log('å¤„ç†çš„æ•°æ®è¡Œæ•°:', s.length);
console.log('æ€»é¡µæ•°è®¡ç®—:', totalPages, '= Math.max(1, Math.ceil(' + s.length + '/' + pageSize + '))');
console.log('å½“å‰é¡µé¢:', currentPage, 'æ˜¯å¦è¶…å‡ºèŒƒå›´:', currentPage > totalPages);
// å¦‚æœå½“å‰é¡µé¢è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é¡µ
if (currentPage > totalPages) {
    currentPage = 1;
    console.log('å½“å‰é¡µé¢è¶…å‡ºèŒƒå›´ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é¡µ');
}a.forEach(t=>{let e=0;for(let n=s.length-1;n>=0;n--){const o=s[n].rec,allPositions=o.data.slice(0,8);let r=0;if(selectedPositions.length>0){selectedPositions.forEach(pos=>{if(pos>=1&&pos<=8&&t.split(",").map(t=>+t).includes(allPositions[pos-1])){r++}});}else{// ä¿®æ”¹ç­›é€‰é€»è¾‘ï¼šæ•°å­—ç›¸åŒä½†é¡ºåºä¸åŒç®—ä½œåŒä¸€ä¸ªç»“æœ
const comboNumbers = t.split(",").map(t=>+t).sort((a,b)=>a-b);
const frontFiveSorted = allPositions.slice(0,5).sort((a,b)=>a-b);
r = comboNumbers.filter(num => frontFiveSorted.includes(num)).length;}// ä¿®å¤ç­›é€‰é€»è¾‘ï¼šå½“æ²¡æœ‰é€‰æ‹©å‘½ä¸­ç æ•°æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç»„åˆ
const shouldHit = c.length === 0 || c.includes(r);
if(shouldHit){
  s[n].cells[t]={txt:t,hit:!0};
  e=0;
}else{
  e++;
  s[n].cells[t]={txt:e,hit:!1};
}
console.log(`ç»„åˆ${t}åœ¨ç¬¬${s[n].rec.period}æœŸ: å‘½ä¸­æ•°=${r}, æ˜¯å¦å‘½ä¸­=${shouldHit}, é€‰æ‹©çš„å‘½ä¸­ç æ•°=${c.join(',')}`);}});console.log('è¡¨æ ¼æ•°æ®å¤„ç†å®Œæˆï¼Œå¼€å§‹æ¸²æŸ“');console.log(`L()å‡½æ•°: å½“å‰æ•°æ®æ•°ç»„é•¿åº¦ ${r.length}ï¼ŒæœŸæ•°ç»Ÿè®¡æ˜¾ç¤º ${document.getElementById('periodCount').textContent}`);if(r.length.toString() !== document.getElementById('periodCount').textContent){console.warn('æ•°æ®ä¸ä¸€è‡´ï¼šæ•°æ®æ•°ç»„é•¿åº¦ä¸æœŸæ•°ç»Ÿè®¡ä¸åŒ¹é…ï¼');}const d=H(s,a),u=U(s,a),l=z(s,a),b=a.slice().sort((t,e)=>{if(hitRateSort){// å‘½ä¸­ç‡æ’åºæ¨¡å¼ï¼šæŒ‰å½“å‰æœŸæ•°å‘½ä¸­ç‡ä»é«˜åˆ°ä½æ’åº
const hitRateT = Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0;
const hitRateE = Math.round((s.filter(row=>row.cells[e]&&row.cells[e].hit).length/s.length)*100)||0;
return hitRateE - hitRateT; // ä»é«˜åˆ°ä½æ’åº
}else if(y){// å½“å‰æ¨¡å¼ï¼šæŒ‰å½“å‰é—æ¼å€¼æˆ–å½“å‰è¿ä¸­å€¼æ’åº
return m?u[e]-u[t]||l[t]-l[e]:l[e]-l[t]||u[t]-u[e]}// å†å²æ¨¡å¼ï¼šæŒ‰å†å²æœ€å¤§å€¼æ’åº
const{maxHit:n,maxMiss:o}=d[t],{maxHit:c,maxMiss:r}=d[e];return m?c-n||o-r:o-r||c-n});

// ä¿å­˜å¤„ç†åçš„æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›updateTablePageå‡½æ•°ä½¿ç”¨
window.lastProcessedData = s;
window.lastSortedCombinations = b;
console.log('å·²ä¿å­˜å¤„ç†åçš„æ•°æ®åˆ°å…¨å±€å˜é‡');

// æ¸…ç©ºé¡µé¢ç¼“å­˜ï¼Œå› ä¸ºæ•°æ®å·²æ›´æ–°
if (window.pageCache) {
    window.pageCache = {};
    console.log('å·²æ¸…ç©ºé¡µé¢ç¼“å­˜');
}

// æ¸…é™¤æ»šåŠ¨ç¼“å­˜ï¼Œç¡®ä¿DOMæŸ¥è¯¢ç»“æœä¸æœ€æ–°è¡¨æ ¼ç»“æ„åŒæ­¥
if (window.clearScrollCache) {
    window.clearScrollCache();
}document.getElementById("sortText").textContent=hitRateSort?"æŒ‰å‘½ä¸­ç‡æ’åº":m?"æŒ‰é—æ¼æ¬¡æ•°æ’åº":"æŒ‰è¿ä¸­æ¬¡æ•°æ’åº";const startIndex=(currentPage-1)*pageSize,endIndex=Math.min(startIndex+pageSize,s.length),pageData=s.slice(startIndex,endIndex);document.getElementById("summary").innerHTML=`\n        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">\n          <div>å…± ${b.length} æ³¨åˆ†æç»„åˆ</div>\n          <div>å½“å‰æ˜¾ç¤º: ${displayData.length} æœŸ / æ€»è®¡: ${r.length} æœŸ</div>\n          <div>ç­›é€‰æ¡ä»¶: ${selectedNums.length>0?selectedNums.join("/"):"å…¨éƒ¨"}ç ç»„åˆï¼Œå‘½ä¸­${c.length>0?c.join("/"):"å…¨éƒ¨"}èƒ†${selectedPositions.length>0?`ï¼Œä½ç½®${selectedPositions.join("/")}å`:""}${selectedHitNumbers.length>0?`ï¼Œå‘½ä¸­æ•°å­—${selectedHitNumbers.join("/")}`:""}</div>\n          <div>ç¬¬ ${currentPage}/${totalPages} é¡µ (${pageData.length}/${s.length} è¡Œ)</div>\n        </div>\n        <div class="flex justify-center items-center mt-4 space-x-2">\n          <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage<=1?'disabled':''}>ä¸Šä¸€é¡µ</button>\n          <span class="text-sm text-gray-600">ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>\n          <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage>=totalPages?'disabled':''}>ä¸‹ä¸€é¡µ</button>\n        </div>`;// æ·»åŠ åºåˆ—å·è¡Œï¼ˆåœ¨è¡¨å¤´ä¹‹å‰ï¼‰
const sequenceRow = document.createElement("tr");
sequenceRow.className = "bg-blue-50 sequence-row";
sequenceRow.style.height = "20px"; // è®¾ç½®ä¸ºæœŸæ•°å’Œæ•°æ®è¡Œé«˜åº¦çš„äºŒåˆ†ä¹‹ä¸€
const periodHeaderClass = 'fixed-width-period';
const dataHeaderLeftPos = 'left-[120px]';
sequenceRow.innerHTML = `<td class="px-1 py-1 text-center sticky-col left-0 border-r border-gray-200 font-medium ${periodHeaderClass} sticky-bg-blue-50" style="font-size: 12px; line-height: 1;">åºå·</td><td class="px-1 py-1 text-center sticky-col ${dataHeaderLeftPos} border-r border-gray-200 fixed-width-data sticky-bg-blue-50" style="font-size: 12px; line-height: 1;">åˆ—å·</td>`;
b.forEach((combo, index) => {
    const sequenceCell = document.createElement("td");
    sequenceCell.className = "px-1 py-1 text-center border-r border-gray-200 bg-blue-50";
    sequenceCell.style.cssText = "font-size: 12px; line-height: 1;";
    sequenceCell.textContent = index + 1; // ä»1å¼€å§‹çš„åºåˆ—å·
    sequenceRow.appendChild(sequenceCell);
});
t.appendChild(sequenceRow);

const h=document.createElement("tr");
h.className="bg-gray-50 table-header-sticky";
h.innerHTML=`<th class="px-3 py-2 text-center sticky-col left-0 border-r border-gray-200 ${periodHeaderClass} sticky-bg-white" style="position: sticky; top: 20px; z-index: 1003;">æœŸæ•°</th><th class="px-3 py-2 text-center sticky-col ${dataHeaderLeftPos} border-r border-gray-200 fixed-width-data sticky-bg-white" style="position: sticky; top: 20px; z-index: 1003;">æ•°æ®</th>`;b.forEach(t=>{const{maxHit:e,maxMiss:n}=d[t],o=document.createElement("th");o.className="px-3 py-2 text-center border-r border-gray-200",o.style.cssText="position: sticky; top: 20px; z-index: 1001;",o.innerHTML=y?m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">è¿:${u[t]} æ¼${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">æ¼:${l[t]} å²:${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">è¿:${u[t]} å²:${e} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">æ¼:${l[t]} å²:${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `,h.appendChild(o)}),t.appendChild(h);



pageData.forEach((t,n)=>{const o=document.createElement("tr");o.className=0===n?"bg-gray-100":1===n?"bg-gray-50":"",o.innerHTML=`\n          <td class="px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium fixed-width-period ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">${t.rec.period}</td>\n          <td class="px-3 py-2 text-left sticky-col left-[120px] border-r border-gray-200 fixed-width-data ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">\n            <div class="number-row">${t.rec.data.slice(0,5).join(",")}</div>\n            <div class="number-row">${t.rec.data.slice(5).join(",")}</div>\n          </td>\n        `,b.forEach(e=>{const n=t.cells[e],c=document.createElement("td");c.className="px-3 py-2 text-center border-r border-gray-200 "+(n.hit?"hit-cell":"miss-cell"),c.textContent=n.txt,o.appendChild(c)}),e.appendChild(o)}),setTimeout(()=>{const t=document.getElementById("prevPage"),e=document.getElementById("nextPage");t&&t.addEventListener("click",(event)=>{event.preventDefault();if(currentPage>1){currentPage--;updateTablePage();}}),e&&e.addEventListener("click",(event)=>{event.preventDefault();if(currentPage<totalPages){currentPage++;updateTablePage();}});},100);
    
    // å°†å¤„ç†åçš„æ•°æ®èµ‹å€¼ç»™window.rï¼Œä¾›éªŒè¯è®¡åˆ’é¡µé¢ä½¿ç”¨
    window.r = r;
    console.log('L()å‡½æ•°: å·²å°†æ•°æ®èµ‹å€¼ç»™window.rï¼Œæ•°ç»„é•¿åº¦:', r.length);
    
    // å»¶è¿ŸåŒæ­¥æ•°æ®åˆ°éªŒè¯è®¡åˆ’é¡µé¢ï¼Œç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
    setTimeout(() => {
        console.log('L()å‡½æ•°: å¼€å§‹å»¶è¿Ÿæ‰§è¡Œæ•°æ®åŒæ­¥ï¼Œå½“å‰æ—¶é—´:', new Date().toISOString());
        if (typeof window.syncDataToVerifyPlan === 'function') {
            console.log('L()å‡½æ•°: å»¶è¿Ÿè°ƒç”¨syncDataToVerifyPlan');
            window.syncDataToVerifyPlan();
            console.log('L()å‡½æ•°: syncDataToVerifyPlanæ‰§è¡Œå®Œæˆ');
        }
        // åŒæ—¶æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼ï¼Œç¡®ä¿ä¸‹ä¸€æœŸæ•°æ®å®æ—¶åŒæ­¥
        if (typeof window.updateSinglePeriodTable === 'function') {
            console.log('L()å‡½æ•°: å»¶è¿Ÿæ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼');
            window.updateSinglePeriodTable();
            console.log('L()å‡½æ•°: updateSinglePeriodTableæ‰§è¡Œå®Œæˆ');
        }
        console.log('L()å‡½æ•°: å»¶è¿Ÿæ‰§è¡Œå®Œæˆï¼Œæ•°æ®åŒæ­¥ç»“æŸ');
        
        // æ·»åŠ æœŸæ•°åˆ—éšè—é€»è¾‘ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ - ä¿æŒçŠ¶æ€ï¼‰
        const tableContainer = document.getElementById("tableContainer");
        if (tableContainer) {
            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®å’ŒæœŸæ•°åˆ—çŠ¶æ€
            const currentScrollLeft = tableContainer.scrollLeft;
            const wasScrolled = currentScrollLeft > 0;
            
            // åªåœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶è®¾ç½®æ»šåŠ¨å¤„ç†é€»è¾‘
            if (!window.periodColumnScrollHandler) {
                console.log('L()å‡½æ•°: é¦–æ¬¡åˆå§‹åŒ–æœŸæ•°åˆ—éšè—é€»è¾‘');
                
                // å…¨å±€çŠ¶æ€æ ‡è®°ï¼Œé¿å…é‡å¤æ“ä½œ
                window.periodColumnHidden = false;
                
                // åˆ›å»ºä¼˜åŒ–çš„æ»šåŠ¨å¤„ç†å‡½æ•°
                window.periodColumnScrollHandler = function() {
                    const currentScrollLeft = tableContainer.scrollLeft;
                    
                    // é‡æ–°è·å–DOMå…ƒç´ ï¼Œç¡®ä¿ä¸æœ€æ–°è¡¨æ ¼ç»“æ„åŒæ­¥
                    const periodCols = document.querySelectorAll(".fixed-width-period");
                    const dataCols = document.querySelectorAll(".fixed-width-data");
                    const dataLeftPosition = '120px';
                    
                    if (currentScrollLeft > 0 && !window.periodColumnHidden) {
                        // éšè—æœŸæ•°åˆ— - ä¿æŒå¯è§ä½†ç§»åŠ¨ä½ç½®
                        periodCols.forEach(col => {
                            col.style.opacity = "1";
                            col.style.left = "-100px";
                        });
                        // è°ƒæ•´æ•°æ®åˆ—ä½ç½®
                        dataCols.forEach(col => {
                            col.style.left = "0px";
                        });
                        window.periodColumnHidden = true;
                        console.log('æœŸæ•°åˆ—å·²éšè—');
                    } else if (currentScrollLeft === 0 && window.periodColumnHidden) {
                        // æ˜¾ç¤ºæœŸæ•°åˆ—
                        periodCols.forEach(col => {
                            col.style.opacity = "1";
                            col.style.left = "0px";
                        });
                        // æ¢å¤æ•°æ®åˆ—ä½ç½®
                        dataCols.forEach(col => {
                            col.style.left = dataLeftPosition;
                        });
                        window.periodColumnHidden = false;
                        console.log('æœŸæ•°åˆ—å·²æ˜¾ç¤º');
                    }
                };
                
                // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨
                tableContainer.addEventListener("scroll", window.periodColumnScrollHandler, { passive: true });
                console.log('L()å‡½æ•°: æœŸæ•°åˆ—æ»šåŠ¨ç›‘å¬å™¨å·²æ·»åŠ ');
            }
            
            // è¡¨æ ¼é‡æ–°æ¸²æŸ“åï¼Œæ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®æ¢å¤æœŸæ•°åˆ—çŠ¶æ€
            setTimeout(() => {
                const periodCols = document.querySelectorAll(".fixed-width-period");
                const dataCols = document.querySelectorAll(".fixed-width-data");
                const dataLeftPosition = '120px';
                
                if (wasScrolled) {
                    // å¦‚æœä¹‹å‰æ˜¯æ»šåŠ¨çŠ¶æ€ï¼Œä¿æŒæœŸæ•°åˆ—éšè— - ä¿æŒå¯è§ä½†ç§»åŠ¨ä½ç½®
                    periodCols.forEach(col => {
                        col.style.opacity = "1";
                        col.style.left = "-100px";
                    });
                    dataCols.forEach(col => {
                        col.style.left = "0px";
                    });
                    window.periodColumnHidden = true;
                    console.log('L()å‡½æ•°: è¡¨æ ¼é‡æ–°æ¸²æŸ“åï¼Œæ¢å¤æœŸæ•°åˆ—éšè—çŠ¶æ€');
                } else {
                    // å¦‚æœä¹‹å‰æ²¡æœ‰æ»šåŠ¨ï¼Œç¡®ä¿æœŸæ•°åˆ—æ˜¾ç¤º
                    periodCols.forEach(col => {
                        col.style.opacity = "1";
                        col.style.left = "0px";
                    });
                    dataCols.forEach(col => {
                        col.style.left = dataLeftPosition;
                    });
                    window.periodColumnHidden = false;
                    console.log('L()å‡½æ•°: è¡¨æ ¼é‡æ–°æ¸²æŸ“åï¼Œæ¢å¤æœŸæ•°åˆ—æ˜¾ç¤ºçŠ¶æ€');
                }
                
                // æ¢å¤æ»šåŠ¨ä½ç½®
                tableContainer.scrollLeft = currentScrollLeft;
            }, 20);
        }
    }, 10);
    


// è·å–ç­›é€‰åçš„æ•°æ®
function getFilteredData() {
    let filteredData = r.slice();
    
    // åº”ç”¨ç­›é€‰æ¡ä»¶
    if (selectedNums.length > 0) {
        filteredData = filteredData.filter(item => {
            const combinations = getCombinations();
            return combinations.some(combo => {
                const nums = combo.split(",").map(n => parseInt(n));
                return selectedNums.every(selectedNum => nums.includes(selectedNum));
            });
        });
    }
    
    if (selectedPositions.length > 0) {
        filteredData = filteredData.filter(item => {
            return selectedPositions.some(pos => {
                const index = parseInt(pos) - 1;
                return index >= 0 && index < item.data.length;
            });
        });
    }
    
    if (selectedHitNumbers.length > 0) {
        // è·å–é€‰ä¸­çš„å‘½ä¸­ç æ•°ï¼ˆèƒ†ç æ•°é‡ï¼‰
        const selectedHitCounts = Array.from(document.querySelectorAll("#hitButtons .btn-active")).map(btn => parseInt(btn.dataset.hit));
        
        if (selectedHitCounts.length > 0) {
            // æ ¹æ®å‘½ä¸­æ•°å­—å’Œå‘½ä¸­ç æ•°è¿›è¡Œç­›é€‰
            filteredData = filteredData.filter(item => {
                const firstFive = item.data.slice(0, 5);
                // è®¡ç®—å‰5ä½å¼€å¥–å·ç ä¸­æœ‰å¤šå°‘ä¸ªåœ¨é€‰ä¸­çš„å‘½ä¸­æ•°å­—ä¸­
                const hitCount = firstFive.filter(num => selectedHitNumbers.includes(num)).length;
                // æ£€æŸ¥å‘½ä¸­æ•°é‡æ˜¯å¦åœ¨é€‰ä¸­çš„å‘½ä¸­ç æ•°èŒƒå›´å†…
                return selectedHitCounts.includes(hitCount);
            });
        }
    }
    
    return filteredData;
}

// è·å–ç»„åˆåˆ—è¡¨
function getCombinations() {
    const combinations = [];
    
    // æ ¹æ®å½“å‰é€‰æ‹©çš„ç æ•°ç”Ÿæˆç»„åˆ
    for (let i = 1; i <= 10; i++) {
        for (let j = i + 1; j <= 10; j++) {
            if (selectedNums.length === 0 || (selectedNums.includes(i) && selectedNums.includes(j))) {
                combinations.push(`${i},${j}`);
            }
        }
    }
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ç‰¹å®šç æ•°ï¼Œç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ç»„åˆ
    if (combinations.length === 0) {
        for (let i = 1; i <= 10; i++) {
            for (let j = i + 1; j <= 10; j++) {
                combinations.push(`${i},${j}`);
            }
        }
    }
    
    return combinations;
}

// ä¼˜åŒ–åçš„å‡½æ•°ï¼šä½¿ç”¨DocumentFragmentå’Œé¿å…é‡å¤DOMæ“ä½œæ¥æå‡ç¿»é¡µæ€§èƒ½
function updateTablePage() {
    const startTime = performance.now();
    console.log('updateTablePageè¢«è°ƒç”¨ï¼Œå½“å‰é¡µé¢:', currentPage);
    
    const tbody = document.querySelector("#resultTable tbody");
    if (!tbody) {
        console.warn('è¡¨æ ¼tbodyæœªæ‰¾åˆ°ï¼Œè°ƒç”¨L()å‡½æ•°é‡æ–°æ¸²æŸ“');
        L();
        return;
    }
    
    // è·å–å½“å‰å·²å¤„ç†çš„æ•°æ®ï¼ˆä»å…¨å±€å˜é‡ä¸­è·å–ï¼‰
    if (!window.lastProcessedData || !window.lastSortedCombinations) {
        console.warn('ç¼ºå°‘å·²å¤„ç†çš„æ•°æ®ï¼Œè°ƒç”¨L()å‡½æ•°é‡æ–°æ¸²æŸ“');
        L();
        return;
    }
    
    const s = window.lastProcessedData;
    const b = window.lastSortedCombinations;
    
    // è®¡ç®—å½“å‰é¡µçš„æ•°æ®
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, s.length);
    const pageData = s.slice(startIndex, endIndex);
    
    console.log('åªæ›´æ–°è¡¨æ ¼å†…å®¹ï¼Œå½“å‰é¡µæ•°æ®è¡Œæ•°:', pageData.length);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„é¡µé¢å†…å®¹
    const cacheKey = `page_${currentPage}_${currentLotteryType}`;
    if (window.pageCache && window.pageCache[cacheKey]) {
        console.log('ä½¿ç”¨ç¼“å­˜çš„é¡µé¢å†…å®¹');
        tbody.innerHTML = window.pageCache[cacheKey];
        const endTime = performance.now();
        console.log(`ç¿»é¡µæ€§èƒ½ (ç¼“å­˜): ${(endTime - startTime).toFixed(2)}ms`);
        return;
    }
    
    // ä½¿ç”¨DocumentFragmentæ‰¹é‡åˆ›å»ºDOMå…ƒç´ ï¼Œå‡å°‘é‡æ’æ¬¡æ•°
    const fragment = document.createDocumentFragment();
    const periodClass = 'fixed-width-period';
    const dataLeftPos = 'left-[120px]';
    
    pageData.forEach((t, n) => {
        const row = document.createElement("tr");
        row.className = 0 === n ? "bg-gray-100" : 1 === n ? "bg-gray-50" : "";
        
        // åˆ›å»ºæœŸå·åˆ—
        const periodCell = document.createElement("td");
        periodCell.className = `px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium ${periodClass} ${0 === n ? "sticky-bg-gray-100" : 1 === n ? "sticky-bg-gray-50" : "sticky-bg-white"}`;
        periodCell.textContent = t.rec.period;
        row.appendChild(periodCell);
        
        // åˆ›å»ºæ•°æ®åˆ—
        const dataCell = document.createElement("td");
        dataCell.className = `px-3 py-2 text-left sticky-col ${dataLeftPos} border-r border-gray-200 fixed-width-data ${0 === n ? "sticky-bg-gray-100" : 1 === n ? "sticky-bg-gray-50" : "sticky-bg-white"}`;
        
        const numberRow1 = document.createElement("div");
        numberRow1.className = "number-row";
        numberRow1.textContent = t.rec.data.slice(0,5).join(",");
        
        const numberRow2 = document.createElement("div");
        numberRow2.className = "number-row";
        numberRow2.textContent = t.rec.data.slice(5).join(",");
        
        dataCell.appendChild(numberRow1);
        dataCell.appendChild(numberRow2);
        row.appendChild(dataCell);
        
        // åˆ›å»ºç»„åˆåˆ—
        b.forEach(e => {
            const cellData = t.cells[e];
            const cell = document.createElement("td");
            cell.className = "px-3 py-2 text-center border-r border-gray-200 " + (cellData.hit ? "hit-cell" : "miss-cell");
            cell.textContent = cellData.txt;
            row.appendChild(cell);
        });
        
        fragment.appendChild(row);
    });
    
    // ä¸€æ¬¡æ€§æ›¿æ¢æ‰€æœ‰å†…å®¹ï¼Œå‡å°‘é‡æ’
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    
    // ç¼“å­˜å½“å‰é¡µé¢å†…å®¹
    if (!window.pageCache) {
        window.pageCache = {};
    }
    window.pageCache[cacheKey] = tbody.innerHTML;
    
    // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé¿å…å†…å­˜æ³„æ¼
    const cacheKeys = Object.keys(window.pageCache);
    if (cacheKeys.length > 10) {
        delete window.pageCache[cacheKeys[0]];
    }
    
    const endTime = performance.now();
    console.log(`ç¿»é¡µæ€§èƒ½ (æ–°æ¸²æŸ“): ${(endTime - startTime).toFixed(2)}ms`);
    
    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    const summaryDiv = document.getElementById("summary");
    if (summaryDiv) {
        const summaryHTML = summaryDiv.innerHTML;
        const updatedSummary = summaryHTML.replace(
            /ç¬¬ \d+\/\d+ é¡µ \(\d+\/\d+ è¡Œ\)/,
            `ç¬¬ ${currentPage}/${totalPages} é¡µ (${pageData.length}/${s.length} è¡Œ)`
        ).replace(
            /<div class="flex justify-center[\s\S]*?<\/div>\s*$/,
            `<div class="flex justify-center items-center mt-4 space-x-2">
                <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                <span class="text-sm text-gray-600">ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>
                <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
            </div>`
        );
        summaryDiv.innerHTML = updatedSummary;
    }
    
    // ä¼˜åŒ–äº‹ä»¶ç»‘å®šï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…é‡å¤ç»‘å®š
    if (!window.paginationEventsInitialized) {
        document.addEventListener('click', function(event) {
            if (event.target.id === 'prevPage') {
                event.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    updateTablePage();
                }
            } else if (event.target.id === 'nextPage') {
                event.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTablePage();
                }
            }
        });
        window.paginationEventsInitialized = true;
        console.log('ç¿»é¡µäº‹ä»¶å§”æ‰˜å·²åˆå§‹åŒ–');
    }
}
// j(); // ç§»é™¤å¯èƒ½å¯¼è‡´æ— é™é€’å½’çš„è°ƒç”¨
}

async function V(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n").filter(Boolean);console.log(`V()å‡½æ•°: ä»æ–‡ä»¶è¯»å–åˆ° ${e.length} è¡Œæ•°æ®`);for(const t of e)q(t);r.sort((t,e)=>parseInt(e.period) - parseInt(t.period));console.log(`V()å‡½æ•°: å¤„ç†åæ•°æ®æ•°ç»„é•¿åº¦ä¸º ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`V()å‡½æ•°: æœŸæ•°ç»Ÿè®¡å·²æ›´æ–°ä¸º ${r.length}`);L(); /* è‡ªåŠ¨æ¸²æŸ“è¡¨æ ¼ */}catch(t){v.textContent=`è¯»å–æ–‡ä»¶é”™è¯¯: ${t.message}`}}async function W(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n")[0],n=e.trim().split(/\t+/);if(2!==n.length)return;const o=n[0].trim();if(o===u)return;u=o,q(e);// é‡æ–°æ’åºæ•°æ®ï¼Œç¡®ä¿æœ€æ–°æœŸå·åœ¨ç¬¬ä¸€è¡Œ
r.sort((t,e)=>parseInt(e.period) - parseInt(t.period));console.log(`W()å‡½æ•°: æ–°å¢æ•°æ®åï¼Œæ•°æ®æ•°ç»„é•¿åº¦ä¸º ${r.length}`);document.getElementById("periodCount").textContent=r.length;console.log(`W()å‡½æ•°: æœŸæ•°ç»Ÿè®¡å·²æ›´æ–°ä¸º ${r.length}`);// è‡ªåŠ¨åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºæœ€æ–°æ•°æ®
L();}catch(t){}}function q(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return;e=t.trim().split(/\s+/)}if(e.length<2)return;const n=e[0].trim();if(d.has(n))return;let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}10!==o.length||o.some(isNaN)||(d.add(n),r.unshift({period:n,data:o,input:o.join(",")}))}// Yå‡½æ•°å®šä¹‰ - ç”Ÿæˆæ–‡ä»¶æ ‡è¯†ç¬¦
function Y(){try{const t=document.documentElement.outerHTML.substring(0,1e3)+window.location.href.split("/").slice(-2).join("/");let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;return"file_"+Math.abs(e).toString(36)}catch(t){return console.error("Failed to generate file identifier:",t),"fallback_"+Date.now()}}

// æ·»åŠ é˜²é‡å¤ç‚¹å‡»å’Œé˜²æŠ–æœºåˆ¶
let isVerifying = false;
let verifyTimeout = null;

// å®‰å…¨è§£ææœåŠ¡ç«¯è¿”å›çš„JSONï¼Œé˜²æ­¢é‡åˆ°HTMLé”™è¯¯é¡µå¯¼è‡´çš„è§£æå¼‚å¸¸
async function parseServerJson(response, context = 'æœåŠ¡å™¨å“åº”') {
    try {
        const cloned = response.clone();
        const contentType = (cloned.headers.get('content-type') || '').toLowerCase();
        if (contentType.includes('application/json')) {
            return await cloned.json();
        }
        const text = await cloned.text();
        const error = new Error(`${context} è¿”å›éJSONå“åº”: ${text.slice(0, 120)}`);
        error.rawResponse = text;
        error.status = cloned.status;
        throw error;
    } catch (err) {
        if (err.name === 'SyntaxError') {
            const text = await response.clone().text();
            const error = new Error(`${context} JSONè§£æå¤±è´¥: ${text.slice(0, 120)}`);
            error.rawResponse = text;
            error.status = response.status;
            throw error;
        }
        throw err;
    }
}

// ç”Ÿæˆè®¾å¤‡ID
function generateDeviceId() {
    // ğŸ”‘ ä¼˜å…ˆä½¿ç”¨ç¼“å­˜çš„è®¾å¤‡IDï¼Œç¡®ä¿åŒä¸€æµè§ˆå™¨å§‹ç»ˆä½¿ç”¨ç›¸åŒçš„è®¾å¤‡ID
    const STORAGE_KEY = 'myyz_device_id';
    
    try {
        // 1. å…ˆå°è¯•ä»localStorageè·å–å·²ç¼“å­˜çš„è®¾å¤‡ID
        const cachedDeviceId = localStorage.getItem(STORAGE_KEY);
        if (cachedDeviceId) {
            console.log('ğŸ”‘ ä½¿ç”¨å·²ç¼“å­˜çš„è®¾å¤‡ID:', cachedDeviceId.substring(0, 8) + '...');
            return cachedDeviceId;
        }
        
        // 2. å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™åŸºäºç¡¬ä»¶ç‰¹å¾ç”Ÿæˆæ–°çš„è®¾å¤‡ID
        console.log('ğŸ”‘ é¦–æ¬¡ç”Ÿæˆè®¾å¤‡IDï¼ŒåŸºäºç¡¬ä»¶ç‰¹å¾...');
        
        // CanvasæŒ‡çº¹
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        const canvasData = canvas.toDataURL();
        
        // WebGLæŒ‡çº¹
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        let webglVendor = '';
        let webglRenderer = '';
        if (gl) {
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (debugInfo) {
                webglVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                webglRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
            }
        }
        
        // æ”¶é›†ç¡¬ä»¶ç‰¹å¾ï¼ˆè¿™äº›ç‰¹å¾åœ¨åŒä¸€è®¾å¤‡ä¸Šæ˜¯ç¨³å®šçš„ï¼‰
        const fingerprint = [
            // æµè§ˆå™¨ä¿¡æ¯
            navigator.userAgent,
            navigator.language,
            navigator.languages ? navigator.languages.join(',') : '',
            navigator.platform,
            
            // å±å¹•ä¿¡æ¯
            screen.width + 'x' + screen.height,
            screen.colorDepth,
            screen.pixelDepth,
            window.devicePixelRatio || 1,
            
            // æ—¶åŒº
            new Date().getTimezoneOffset(),
            Intl.DateTimeFormat().resolvedOptions().timeZone,
            
            // ç¡¬ä»¶ä¿¡æ¯
            navigator.hardwareConcurrency || 0,
            navigator.maxTouchPoints || 0,
            
            // CanvasæŒ‡çº¹
            canvasData,
            
            // WebGLæŒ‡çº¹
            webglVendor,
            webglRenderer,
            
            // å…¶ä»–ç‰¹å¾
            navigator.cookieEnabled,
            navigator.doNotTrack || 'unknown'
        ].join('|');
        
        // ä½¿ç”¨SHA-256é£æ ¼çš„å“ˆå¸Œå‡½æ•°
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
            const char = fingerprint.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        // ç”Ÿæˆå”¯ä¸€IDï¼ˆ36è¿›åˆ¶ï¼Œæ›´çŸ­æ›´æ˜“è¯»ï¼‰
        const deviceId = Math.abs(hash).toString(36);
        
        // 3. å°†ç”Ÿæˆçš„è®¾å¤‡IDä¿å­˜åˆ°localStorageï¼Œç¡®ä¿åç»­ä½¿ç”¨ç›¸åŒçš„ID
        try {
            localStorage.setItem(STORAGE_KEY, deviceId);
            console.log('âœ… è®¾å¤‡IDå·²ç¼“å­˜åˆ°localStorage');
        } catch (storageError) {
            console.warn('âš ï¸ æ— æ³•ç¼“å­˜è®¾å¤‡IDåˆ°localStorage:', storageError);
        }
        
        // ğŸ“ è°ƒè¯•æ—¥å¿—
        console.log('ğŸ”‘ è®¾å¤‡IDç”ŸæˆæˆåŠŸ:', deviceId.substring(0, 8) + '...');
        console.log('ğŸ“Š ç¡¬ä»¶ç‰¹å¾:', {
            ua: navigator.userAgent.substring(0, 50) + '...',
            screen: screen.width + 'x' + screen.height,
            platform: navigator.platform,
            cores: navigator.hardwareConcurrency,
            webgl: webglRenderer || 'ä¸å¯ç”¨'
        });
        
        return deviceId;
        
    } catch (error) {
        // é™çº§æ–¹æ¡ˆï¼šå¦‚æœæŒ‡çº¹ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€ç‰¹å¾
        console.error('æœºå™¨ç ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', error);
        const fallback = [
            navigator.userAgent,
            screen.width + 'x' + screen.height,
            navigator.platform
        ].join('|');
        
        let hash = 0;
        for (let i = 0; i < fallback.length; i++) {
            hash = ((hash << 5) - hash) + fallback.charCodeAt(i);
            hash = hash & hash;
        }
        
        return 'fb_' + Math.abs(hash).toString(36); // fb = fallback
    }
}

P.addEventListener("click",async function(){const t=p.value.trim();if(t){// é˜²é‡å¤ç‚¹å‡»æ£€æŸ¥
if(isVerifying){console.warn("éªŒè¯æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");return;}

// æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
if(verifyTimeout){clearTimeout(verifyTimeout);verifyTimeout=null;}

// è®¾ç½®éªŒè¯çŠ¶æ€
isVerifying=true;
this.disabled=true;
this.textContent="éªŒè¯ä¸­...";
this.style.opacity="0.6";
this.style.cursor="not-allowed";

// æ·»åŠ åŠ è½½åŠ¨ç”»æ•ˆæœ
const originalText=this.textContent;

let dots=0;
const loadingInterval=setInterval(()=>{dots=(dots+1)%4;this.textContent="éªŒè¯ä¸­"+".".repeat(dots);},500);

try{
  // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°æ–‡ä»¶è®¿é—®æ¨¡å¼
  if (window.location.protocol === 'file:') {
    console.log('ğŸ”“ æœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼šè·³è¿‡å¯†é’¥éªŒè¯');
    const n=Y();
    localStorage.setItem(`validKey_${n}`,t);
    // è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„è¿‡æœŸæ—¶é—´ï¼ˆ30å¤©åï¼‰
    const expiryDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
    localStorage.setItem(`keyExpiry_${n}`, expiryDate.toISOString());
    g.classList.add("hidden");
    g.style.display="none";
    b=!0;
    return;
  }
  
  // ğŸ”’ å®Œå…¨ä¾èµ–æœåŠ¡å™¨éªŒè¯ï¼Œç§»é™¤æœ¬åœ°éªŒè¯é€»è¾‘
  console.log('ğŸ”’ å¯†é’¥è¾“å…¥ï¼šå‘æœåŠ¡å™¨éªŒè¯å¯†é’¥');
  // æ ¹æ®ç¯å¢ƒé€‰æ‹©APIåœ°å€
  const serverValidateUrl = '/api/keys/validate-key';
  
  // ç”Ÿæˆè®¾å¤‡ID
  const deviceId = generateDeviceId();
  
  const serverResponse = await fetch(serverValidateUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
      key: t,
      deviceId: deviceId,
      clientTime: Date.now()
    })
  });
  
  const serverResult = await parseServerJson(serverResponse, 'å¯†é’¥éªŒè¯æœåŠ¡');
  console.log('å¯†é’¥è¾“å…¥æ—¶æœåŠ¡å™¨éªŒè¯ç»“æœ:', serverResult);
  console.log('å“åº”çŠ¶æ€:', serverResponse.status, serverResponse.statusText);
  console.log('å®Œæ•´å“åº”:', JSON.stringify(serverResult));
  
  if(serverResult.success && serverResult.valid){
    // æœåŠ¡å™¨éªŒè¯é€šè¿‡
    console.log('âœ… å¯†é’¥è¾“å…¥ï¼šæœåŠ¡å™¨éªŒè¯é€šè¿‡');
    const n=Y();
    localStorage.setItem(`validKey_${n}`,t);
    localStorage.setItem(`keyExpiry_${n}`,serverResult.data.expiresAt);
    g.classList.add("hidden");
    g.style.display="none";
    _0xSetAuth(t);
    b=!0;
    D(new Date(serverResult.data.expiresAt).getTime() / 1000);
    
    // ğŸŒ éªŒè¯æˆåŠŸåç«‹å³å¯åŠ¨åœ¨çº¿å¿ƒè·³
    console.log('ğŸŒ å¯†é’¥éªŒè¯æˆåŠŸï¼Œå¯åŠ¨åœ¨çº¿å¿ƒè·³ç³»ç»Ÿ');
    if (typeof startOnlineHeartbeat === 'function') {
      startOnlineHeartbeat(t);
    }
  }else{
    const errorMsg = serverResult.reason || serverResult.error || serverResult.message || 'unknown';
    console.error('âŒ éªŒè¯å¤±è´¥è¯¦æƒ…:', serverResult);
    alert("å¯†é’¥éªŒè¯å¤±è´¥: "+ errorMsg);
  }
}catch(t){console.error("å¯†é’¥éªŒè¯è¿‡ç¨‹å‡ºé”™:",t);alert("éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: "+t.message)}finally{// é‡ç½®éªŒè¯çŠ¶æ€ï¼ˆæ·»åŠ å»¶è¿Ÿé˜²æŠ–ï¼‰
if(loadingInterval){clearInterval(loadingInterval);}
verifyTimeout=setTimeout(()=>{isVerifying=false;this.disabled=false;this.textContent="éªŒè¯å¯†é’¥";this.style.opacity="1";this.style.cursor="pointer";},1000);}}else alert("è¯·è¾“å…¥å¯†é’¥")});

window.addEventListener("load",async function(){try{
  // æœ¬åœ°å¼€å‘ç¯å¢ƒç›´æ¥è·³è¿‡å¯†é’¥éªŒè¯
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('ğŸ”“ æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šè·³è¿‡å¯†é’¥éªŒè¯');
    const keyModal = document.getElementById('keyModal');
    if (keyModal) {
      keyModal.classList.add('hidden');
      keyModal.style.display = 'none';
    }
    b = true;
    return;
  }
  
  const t=Y(),e=localStorage.getItem(`validKey_${t}`);if(e){
  // ğŸ”’ å®Œå…¨ä¾èµ–æœåŠ¡å™¨éªŒè¯ï¼Œç§»é™¤æ‰€æœ‰æœ¬åœ°éªŒè¯é€»è¾‘
  console.log('ğŸ”’ é¡µé¢åŠ è½½ï¼šå‘æœåŠ¡å™¨éªŒè¯å¯†é’¥çŠ¶æ€');
  
  // æœ¬åœ°å¼€å‘ç¯å¢ƒè·³è¿‡å¯†é’¥éªŒè¯
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('ğŸ”“ æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šè·³è¿‡å¯†é’¥éªŒè¯');
    const keyModal = document.getElementById('keyModal');
    if (keyModal) {
      keyModal.classList.add('hidden');
      keyModal.style.display = 'none';
    }
    b = true;
    return;
  }
  
  try {
    // æ ¹æ®ç¯å¢ƒé€‰æ‹©APIåœ°å€
    const serverCheckUrl = '/api/keys/validate-key';
    
    // ç”Ÿæˆè®¾å¤‡ID
    const deviceId = generateDeviceId();
    
    const serverResponse = await fetch(serverCheckUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        key: e,
        deviceId: deviceId,
        clientTime: Date.now()
      })
    });
    
    const serverResult = await parseServerJson(serverResponse, 'å¯†é’¥çŠ¶æ€éªŒè¯æœåŠ¡');
    console.log('é¡µé¢åŠ è½½æ—¶æœåŠ¡å™¨éªŒè¯ç»“æœ:', serverResult);
    
    // æœåŠ¡å™¨éªŒè¯é€šè¿‡
    if (serverResult.success && serverResult.valid) {
      console.log('âœ… é¡µé¢åŠ è½½ï¼šæœåŠ¡å™¨éªŒè¯é€šè¿‡');
      _0xSetAuth(e);
      b = true;
      D(new Date(serverResult.data.expiresAt).getTime() / 1000);
      g.classList.add("hidden");
      g.style.display = "none";
      
      // ğŸŒ é¡µé¢åŠ è½½æ—¶å·²æœ‰å¯†é’¥ï¼Œå¯åŠ¨åœ¨çº¿å¿ƒè·³
      console.log('ğŸŒ é¡µé¢åŠ è½½åå¯åŠ¨åœ¨çº¿å¿ƒè·³ç³»ç»Ÿ');
      if (typeof startOnlineHeartbeat === 'function') {
        startOnlineHeartbeat(e);
      }
      return;
    }
    
    // æœåŠ¡å™¨éªŒè¯å¤±è´¥
    console.warn('ğŸ”’ é¡µé¢åŠ è½½ï¼šæœåŠ¡å™¨éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨');
    localStorage.removeItem(`validKey_${t}`);
    localStorage.removeItem(`keyExpiry_${t}`);
    b = false;
    
    // æ˜¾ç¤ºå¯†é’¥å¤±æ•ˆæç¤º
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border:2px solid #ef4444;border-radius:8px;padding:20px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);text-align:center;max-width:400px;';
    errorDiv.innerHTML = `
      <div style="color:#ef4444;font-size:18px;margin-bottom:15px;">ğŸ”‘ å¯†é’¥å·²å¤±æ•ˆ</div>
      <div style="color:#666;margin-bottom:20px;">${serverResult.reason || 'æ‚¨çš„å¯†é’¥å·²è¢«ç®¡ç†å‘˜æ’¤é”€æˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–å¯†é’¥'}</div>
      <button onclick="location.reload()" style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">é‡æ–°éªŒè¯</button>
    `;
    document.body.appendChild(errorDiv);
    g.classList.remove("hidden");
    g.style.display = "flex";
    return;
    
  } catch (serverError) {
    console.warn('âš ï¸ é¡µé¢åŠ è½½ï¼šæœåŠ¡å™¨éªŒè¯å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰:', serverError);
    // ç½‘ç»œé”™è¯¯æ—¶ä¸æ¸…é™¤ç¼“å­˜ï¼Œå…è®¸ç¦»çº¿ä½¿ç”¨ï¼ˆæ£€æŸ¥æœ¬åœ°åˆ°æœŸæ—¶é—´ï¼‰
    const expiryTime = localStorage.getItem(`keyExpiry_${t}`);
    if (expiryTime && new Date(expiryTime) > new Date()) {
      console.log('âœ… ç½‘ç»œé”™è¯¯ä½†å¯†é’¥æœªè¿‡æœŸï¼Œå…è®¸ç¦»çº¿ä½¿ç”¨');
      _0xSetAuth(e);
      b = true;
      D(new Date(expiryTime).getTime() / 1000);
      g.classList.add("hidden");
      g.style.display = "none";
      
      // å°è¯•å¯åŠ¨å¿ƒè·³ï¼ˆå¯èƒ½å› ç½‘ç»œé—®é¢˜å¤±è´¥ï¼Œä½†ä¸å½±å“ä½¿ç”¨ï¼‰
      console.log('ğŸŒ å°è¯•å¯åŠ¨å¿ƒè·³ï¼ˆç½‘ç»œæ¢å¤åä¼šè‡ªåŠ¨å·¥ä½œï¼‰');
      if (typeof startOnlineHeartbeat === 'function') {
        startOnlineHeartbeat(e);
      }
    } else {
      console.log('âŒ ç½‘ç»œé”™è¯¯ä¸”å¯†é’¥å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œæ¸…é™¤ç¼“å­˜');
      localStorage.removeItem(`validKey_${t}`);
      localStorage.removeItem(`keyExpiry_${t}`);
      b = false;
      g.classList.remove("hidden");
      g.style.display = "flex";
    }
    return;
  }
}else{b=!1,g.classList.remove("hidden"),g.style.display="flex"}}catch(t){console.error("é¡µé¢åŠ è½½æ—¶å¯†é’¥æ£€æŸ¥å‡ºé”™:",t),b=!1,g.classList.remove("hidden"),g.style.display="flex"}
}),document.getElementById("calcBtn").addEventListener("click",F),document.getElementById("numbersInput").addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),F())});



// è‡ªåŠ¨æŠ“å–ç›¸å…³å˜é‡
let autoScrapeInterval = null;
let countdownInterval = null;
let lastPeriodNumber = null;
let isInActiveTimeRange = false;

// æ£€æŸ¥æ˜¯å¦åœ¨æ´»è·ƒæ—¶é—´æ®µå†… (23:55-07:05)
function isInActiveTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    // 23:55 = 1435åˆ†é’Ÿ, 07:05 = 425åˆ†é’Ÿ
    const startTime = 23 * 60 + 55; // 1435
    const endTime = 7 * 60 + 5;     // 425
    
    // è·¨è¶Šåˆå¤œçš„æ—¶é—´æ®µ
    return currentTime >= startTime || currentTime <= endTime;
}

// äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - è¿œç¨‹APIåŸºç¡€URLå·²ç§»é™¤

// äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - runPythonScraperå‡½æ•°å·²ç§»é™¤

// å¯åŠ¨è‡ªåŠ¨æŠ“å–åŠŸèƒ½ - æ¯2ç§’è·å–ä¸€æ¬¡æ•°æ®ï¼ˆä»…é’ˆå¯¹å¸å®‰ç³»åˆ—å’Œå°æ¹¾PK10ï¼‰
function startAutoScrape(showNotificationFlag = true, customMessage = null, immediatelyFetch = true) {
    if (autoScrapeInterval) {
        clearInterval(autoScrapeInterval);
    }
    
    // æ£€æŸ¥å½“å‰å½©ç§æ˜¯å¦éœ€è¦è‡ªåŠ¨æ›´æ–°ï¼ˆå¸å®‰ç³»åˆ—å’Œå°æ¹¾PK10ï¼‰
    const needAutoUpdate = currentLotteryType.startsWith('bscbh') || 
                          currentLotteryType.startsWith('tronbh') || 
                          currentLotteryType === 'twpk10';
    if (!needAutoUpdate) {
        console.log(`å½“å‰å½©ç§ ${currentLotteryType} ä¸éœ€è¦è‡ªåŠ¨æ›´æ–°ï¼Œè·³è¿‡å¯åŠ¨è‡ªåŠ¨è·å–`);
        return;
    }
    
    const lotteryName = currentLotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                       (currentLotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' :
                       (currentLotteryType === 'tronbh3fpk10' ? 'æ³¢åœº3åˆ†PK10' : 'å°æ¹¾PK10'));
    console.log(`å¯åŠ¨ ${lotteryName} è‡ªåŠ¨è·å–æ•°æ®åŠŸèƒ½ï¼Œæ¯2ç§’è·å–ä¸€æ¬¡`);
    isInActiveTimeRange = true;
    
    // æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦ç«‹å³è·å–æ•°æ®
    if (immediatelyFetch) {
        fetchApiData();
    }
    
    // è®¾ç½®å®šæ—¶å™¨æ¯2ç§’è·å–ä¸€æ¬¡
    autoScrapeInterval = setInterval(async () => {
        try {
            await fetchApiData();
        } catch (error) {
            console.error('è‡ªåŠ¨è·å–æ•°æ®å¤±è´¥:', error);
        }
    }, 2000); // 2ç§’é—´éš”
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const autoFetchBtn = document.getElementById('autoFetchBtn');
    if (autoFetchBtn) {
        autoFetchBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>åœæ­¢è‡ªåŠ¨è·å–';
        autoFetchBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        autoFetchBtn.classList.add('bg-red-500', 'hover:bg-red-600');
    }
    
    // åªæœ‰åœ¨éœ€è¦æ˜¾ç¤ºé€šçŸ¥æ—¶æ‰æ˜¾ç¤º
    if (showNotificationFlag) {
        const message = customMessage || 'å·²å¯åŠ¨è‡ªåŠ¨è·å–æ•°æ®åŠŸèƒ½ï¼Œæ¯2ç§’è·å–ä¸€æ¬¡';
        showNotification(message, 'success');
    }
}

// åœæ­¢è‡ªåŠ¨æŠ“å–åŠŸèƒ½
function stopAutoScrape(showNotificationFlag = true) {
    if (autoScrapeInterval) {
        clearInterval(autoScrapeInterval);
        autoScrapeInterval = null;
    }
    
    console.log('åœæ­¢è‡ªåŠ¨è·å–æ•°æ®åŠŸèƒ½');
    isInActiveTimeRange = false;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const autoFetchBtn = document.getElementById('autoFetchBtn');
    if (autoFetchBtn) {
        autoFetchBtn.innerHTML = '<i class="fa fa-play mr-2"></i>å¼€å§‹è‡ªåŠ¨è·å–';
        autoFetchBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        autoFetchBtn.classList.add('bg-green-500', 'hover:bg-green-600');
    }
    
    // åªæœ‰åœ¨éœ€è¦æ˜¾ç¤ºé€šçŸ¥æ—¶æ‰æ˜¾ç¤º
    if (showNotificationFlag) {
        showNotification('å·²åœæ­¢è‡ªåŠ¨è·å–æ•°æ®åŠŸèƒ½', 'info');
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æ¯5ç§’åˆ·æ–°
window.addEventListener('load', function() {
    // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - ä¸å†è‡ªåŠ¨åŠ è½½æ•°æ®
    // fetchTodayDataFromDatabase(); // å·²ç¦ç”¨
    
    // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - ä¸å†å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    // setTimeout(() => {
    //     console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯åŠ¨æ¯5ç§’è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½');
    //     startAutoRefresh();
    // }, 3000); // å·²ç¦ç”¨
    
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œäº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ•°æ®');
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// æ·»åŠ å‘½ä¸­æ•°å­—æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // å‘½ä¸­æ•°å­—æŒ‰é’®å¤šé€‰åŠŸèƒ½
    const hitNumberButtons = document.querySelectorAll('.hit-number-btn');
    hitNumberButtons.forEach(button => {
        // è®¾ç½®åˆå§‹æ ·å¼
        button.style.backgroundColor = '#e5e7eb'; // gray-200
        button.style.color = '#374151'; // gray-700
        button.style.cursor = 'pointer';
        button.style.transition = 'all 0.2s ease';
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('å‘½ä¸­æ•°å­—æŒ‰é’®ç‚¹å‡»:', this.textContent, this.dataset.number);
            
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            if (this.classList.contains('btn-active')) {
                // å–æ¶ˆé€‰ä¸­
                this.classList.remove('btn-active');
                this.style.backgroundColor = '#e5e7eb'; // gray-200
                this.style.color = '#374151'; // gray-700
                console.log('å–æ¶ˆé€‰ä¸­:', this.textContent);
            } else {
                // é€‰ä¸­
                this.classList.add('btn-active');
                this.style.backgroundColor = '#3b82f6'; // blue-500
                this.style.color = 'white';
                console.log('é€‰ä¸­:', this.textContent);
            }
            
            // è¾“å‡ºå½“å‰é€‰ä¸­çŠ¶æ€
            const selectedNumbers = Array.from(document.querySelectorAll('.hit-number-btn.btn-active'))
                .map(btn => btn.dataset.number);
            console.log('å½“å‰é€‰ä¸­æ•°å­—:', selectedNumbers);
            
            // ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»
            console.log('å‘½ä¸­æ•°å­—é€‰æ‹©å·²æ›´æ”¹ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡»');
        });
    });
    
    // å‘½ä¸­ç æ•°æŒ‰é’®äº‹ä»¶å¤„ç†å·²åœ¨DOMContentLoadedä¸­é€šè¿‡Cå‡½æ•°å¤„ç†ï¼Œæ— éœ€é‡å¤ç»‘å®š
    
    // ç¡®è®¤æŒ‰é’®äº‹ä»¶å¤„ç†
    const confirmFilterBtn = document.getElementById('confirmFilterBtn');
    if (confirmFilterBtn) {
        confirmFilterBtn.addEventListener('click', function() {
            console.log('ç¡®è®¤æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå¼€å§‹æ‰§è¡Œç­›é€‰');
            // æ‰§è¡Œç­›é€‰å‡½æ•°
            L();
        });
    }
    
    // é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨è·å–å†å²æ•°æ®
    setTimeout(async function() {
        if (r && r.length > 0) {
            console.log('é¡µé¢åˆå§‹åŒ–æ£€æµ‹åˆ°æ•°æ®ï¼Œæ•°æ®é•¿åº¦:', r.length, 'ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ç­›é€‰');
            // L(); // ç§»é™¤è‡ªåŠ¨è¡¨æ ¼åˆ·æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ç­›é€‰
        } else {
            console.log('é¡µé¢åˆå§‹åŒ–æ—¶æš‚æ— æ•°æ®ï¼Œå¼€å§‹è‡ªåŠ¨è·å–å†å²æ•°æ®...');
            try {
                // è‡ªåŠ¨è·å–å†å²æ•°æ®
                const result = await fetchHistoryData();
                if (result && result.success && result.added > 0) {
                    console.log(`é¡µé¢åˆå§‹åŒ–ï¼šæˆåŠŸè·å– ${result.added} æ¡æ–°æ•°æ®ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®`);
                    // è‡ªåŠ¨æ˜¾ç¤ºæ•°æ®è¡¨æ ¼
                    L();
                } else {
                    console.log('é¡µé¢åˆå§‹åŒ–ï¼šæœªè·å–åˆ°æ–°æ•°æ®æˆ–è·å–å¤±è´¥');
                }
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–ï¼šè‡ªåŠ¨è·å–å†å²æ•°æ®å¤±è´¥:', error);
            }
        }
    }, 500); // å»¶è¿Ÿ500msç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
});

document.getElementById("autoFetchBtn").addEventListener("click",()=>{if(isInActiveTimeRange){stopAutoScrape()}else{startAutoScrape()}});

// è·å–æœ€æ–°æ•°æ®æŒ‰é’®äº‹ä»¶ç›‘å¬
document.getElementById("fetchApiBtn").addEventListener("click", async ()=>{
    const btn = document.getElementById("fetchApiBtn");
    const originalText = btn.innerHTML;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>è·å–ä¸­...';
    btn.disabled = true;
    
    try {
        await fetchApiData();
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});document.getElementById("sortToggle").addEventListener("click",()=>{m=!m; /* ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡» */});// å½“å‰é—æ¼æŒ‰é’®äº‹ä»¶
document.getElementById("currentMissBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0;m=!1;hitRateSort=!1; // è®¾ç½®ä¸ºå½“å‰æ¨¡å¼å’Œé—æ¼æ¨¡å¼ï¼Œå…³é—­å‘½ä¸­ç‡æ’åº
document.getElementById("currentMissBtn").classList.add("btn-active","bg-blue-600","text-white");document.getElementById("currentMissBtn").classList.remove("bg-gray-200","text-gray-700");document.getElementById("currentHitBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentHitBtn").classList.add("bg-gray-200","text-gray-700");document.getElementById("hitRateSortBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("hitRateSortBtn").classList.add("bg-gray-200","text-gray-700"); console.log('å½“å‰é—æ¼æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç«‹å³æ‰§è¡Œç­›é€‰'); L(); /* ç«‹å³æ‰§è¡Œç­›é€‰ */ if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>{col.style.opacity="1";col.style.left="-100px"});dataCols.forEach(col=>col.style.left="0px");console.log('æŒ‰é’®ç‚¹å‡»åä¿æŒæœŸæ•°åˆ—éšè—çŠ¶æ€')},100)}});

// å½“å‰è¿ä¸­æŒ‰é’®äº‹ä»¶
document.getElementById("currentHitBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0;m=!0;hitRateSort=!1; // è®¾ç½®ä¸ºå½“å‰æ¨¡å¼å’Œè¿ä¸­æ¨¡å¼ï¼Œå…³é—­å‘½ä¸­ç‡æ’åº
document.getElementById("currentHitBtn").classList.add("btn-active","bg-blue-600","text-white");document.getElementById("currentHitBtn").classList.remove("bg-gray-200","text-gray-700");document.getElementById("currentMissBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentMissBtn").classList.add("bg-gray-200","text-gray-700");document.getElementById("hitRateSortBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("hitRateSortBtn").classList.add("bg-gray-200","text-gray-700"); console.log('å½“å‰è¿ä¸­æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç«‹å³æ‰§è¡Œç­›é€‰'); L(); /* ç«‹å³æ‰§è¡Œç­›é€‰ */ if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>{col.style.opacity="1";col.style.left="-100px"});dataCols.forEach(col=>col.style.left="0px");console.log('æŒ‰é’®ç‚¹å‡»åä¿æŒæœŸæ•°åˆ—éšè—çŠ¶æ€')},100)}});

// å‘½ä¸­ç‡æ’åºæŒ‰é’®äº‹ä»¶
document.getElementById("hitRateSortBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0;hitRateSort=!0; // è®¾ç½®ä¸ºå½“å‰æ¨¡å¼å’Œå‘½ä¸­ç‡æ’åºæ¨¡å¼
document.getElementById("hitRateSortBtn").classList.add("btn-active","bg-blue-600","text-white");document.getElementById("hitRateSortBtn").classList.remove("bg-gray-200","text-gray-700");document.getElementById("currentMissBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentMissBtn").classList.add("bg-gray-200","text-gray-700");document.getElementById("currentHitBtn").classList.remove("btn-active","bg-blue-600","text-white");document.getElementById("currentHitBtn").classList.add("bg-gray-200","text-gray-700"); console.log('å‘½ä¸­ç‡æ’åºæŒ‰é’®è¢«ç‚¹å‡»ï¼Œç«‹å³æ‰§è¡Œç­›é€‰'); L(); /* ç«‹å³æ‰§è¡Œç­›é€‰ */ if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>{col.style.opacity="1";col.style.left="-100px"});dataCols.forEach(col=>col.style.left="0px");console.log('æŒ‰é’®ç‚¹å‡»åä¿æŒæœŸæ•°åˆ—éšè—çŠ¶æ€')},100)}}); document.getElementById("statBtn").addEventListener("click",() => { /* ç§»é™¤ç«‹å³ç­›é€‰ï¼Œç­‰å¾…ç¡®è®¤æŒ‰é’®ç‚¹å‡» */ });document.getElementById("clearBtn").addEventListener("click",()=>{if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")){
r=[];
i=1;
d.clear();
document.getElementById("periodCount").textContent="0";
document.getElementById("summary").textContent="";
v.textContent="æ•°æ®å·²æ¸…ç©º";
// é‡ç½®ä¸ºè‡ªåŠ¨è·å–æ¨¡å¼
window.isUsingFileData = false;
// é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ¸…ç©ºæ˜¾ç¤º
L();
// æ¸…ç©ºéªŒè¯è®¡åˆ’è¡¨æ ¼
if (typeof window.updateVerifyPlanTable === 'function') {
    window.updateVerifyPlanTable();
}
if (typeof window.updateSinglePeriodTable === 'function') {
    window.updateSinglePeriodTable();
}
// é‡æ–°å¯åŠ¨APIæ•°æ®è·å–å®šæ—¶å™¨
console.log('é‡æ–°å¯åŠ¨APIæ•°æ®è·å–å®šæ—¶å™¨...');
if (typeof window.startHistoryDataFetch === 'function') {
    window.startHistoryDataFetch();
    console.log('å†å²æ•°æ®è·å–å®šæ—¶å™¨å·²é‡æ–°å¯åŠ¨');
}
if (typeof window.startVerifyPlanDataFetch === 'function') {
    window.startVerifyPlanDataFetch();
    console.log('éªŒè¯è®¡åˆ’æ•°æ®è·å–å®šæ—¶å™¨å·²é‡æ–°å¯åŠ¨');
}
console.log('æ•°æ®å·²æ¸…ç©ºï¼Œå·²åˆ‡æ¢å›è‡ªåŠ¨è·å–æ¨¡å¼ï¼Œæ‰€æœ‰è¡¨æ ¼å·²é‡æ–°æ¸²æŸ“ï¼ŒAPIæ•°æ®è·å–å·²é‡æ–°å¯åŠ¨');
}});document.addEventListener("DOMContentLoaded",()=>{document.getElementById("uploadDataBtn").addEventListener("click",async()=>{try{[s]=await window.showOpenFilePicker();
// åœæ­¢æ‰€æœ‰APIæ•°æ®è·å–å®šæ—¶å™¨
console.log('æ–‡ä»¶å¯¼å…¥å¼€å§‹ï¼Œåœæ­¢æ‰€æœ‰APIæ•°æ®è·å–...');
// åœæ­¢è‡ªåŠ¨æŠ“å–
if (typeof stopAutoScrape === 'function') {
    stopAutoScrape();
    console.log('å·²åœæ­¢è‡ªåŠ¨æŠ“å–åŠŸèƒ½');
}
// åœæ­¢å†å²æ•°æ®è·å–
if (typeof window.stopHistoryDataFetch === 'function') {
    window.stopHistoryDataFetch();
    console.log('å·²åœæ­¢å†å²æ•°æ®è·å–');
}
// åœæ­¢éªŒè¯è®¡åˆ’æ•°æ®è·å–
if (typeof window.stopVerifyPlanDataFetch === 'function') {
    window.stopVerifyPlanDataFetch();
    console.log('å·²åœæ­¢éªŒè¯è®¡åˆ’æ•°æ®è·å–');
}
// åœæ­¢å…¶ä»–å¯èƒ½çš„å®šæ—¶å™¨
if (autoScrapeInterval) {
    clearInterval(autoScrapeInterval);
    autoScrapeInterval = null;
    console.log('å·²æ¸…é™¤è‡ªåŠ¨æŠ“å–å®šæ—¶å™¨');
}
if (historyDataTimer) {
    clearInterval(historyDataTimer);
    historyDataTimer = null;
    console.log('å·²æ¸…é™¤å†å²æ•°æ®å®šæ—¶å™¨');
}
if (verifyPlanDataTimer) {
    clearInterval(verifyPlanDataTimer);
    verifyPlanDataTimer = null;
    console.log('å·²æ¸…é™¤éªŒè¯è®¡åˆ’æ•°æ®å®šæ—¶å™¨');
}
// è®¾ç½®æ•°æ®æºæ ‡è¯†
window.isUsingFileData = true;
console.log('æ•°æ®æºå·²åˆ‡æ¢ä¸ºæ–‡ä»¶è·å–æ¨¡å¼');
// æ•°æ®æºæŒ‡ç¤ºå™¨å·²ç§»é™¤
d.clear();u=null;r=[];i=1;await V();l&&clearInterval(l);l=setInterval(W,2e3);v.textContent=`å·²åŠ è½½æ–‡ä»¶: ${s.name} (æ–‡ä»¶æ•°æ®æ¨¡å¼)`}catch(t){v.textContent=`æ–‡ä»¶é€‰æ‹©é”™è¯¯: ${t.message}`}})});const X=document.querySelectorAll(".period-btn");X.forEach(t=>{t.addEventListener("click",()=>{X.forEach(t=>t.classList.remove("btn-active"));t.classList.add("btn-active");f=parseInt(t.dataset.period);document.getElementById("customPeriod").value=f;currentPage=1;console.log(`æœŸæ•°æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè®¾ç½®æœŸæ•°ä¸º: ${f}ï¼Œç›´æ¥æ‰§è¡Œç­›é€‰`);L();})});document.getElementById("customPeriodBtn").addEventListener("click",()=>{const t=parseInt(document.getElementById("customPeriod").value);!isNaN(t)&&t>=1&&t<=1e4?(f=t,X.forEach(t=>t.classList.remove("btn-active")),currentPage=1,console.log(`è‡ªå®šä¹‰æœŸæ•°è¢«è®¾ç½®ä¸º: ${f}ï¼Œç›´æ¥æ‰§è¡Œç­›é€‰`),L()):alert("è¯·è¾“å…¥1-10000ä¹‹é—´çš„æ•°å­—")});



// å…¨å±€è‡ªåŠ¨åˆ·æ–°å˜é‡
let autoRefreshTimer = null;
let lastUpdateTime = null;

// é¡µé¢åŠ è½½æ—¶ä»æ•°æ®åº“è·å–ä»Šå¤©çš„æ•°æ®
// äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - fetchTodayDataFromDatabaseå‡½æ•°å·²ç§»é™¤

// äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ - autoRefreshLatestDataå‡½æ•°å·²ç§»é™¤

// ç”Ÿæˆæ¨¡æ‹ŸæœŸå·
function generateMockPeriod() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hour = now.getHours().toString().padStart(2, '0');
    const minute = now.getMinutes().toString().padStart(2, '0');
    return `${year}${month}${day}${hour}${minute}`;
}

// ç”Ÿæˆæ¨¡æ‹Ÿå¼€å¥–å·ç 
function generateMockNumbers() {
    const numbers = [];
    for (let i = 0; i < 10; i++) {
        numbers.push(Math.floor(Math.random() * 10));
    }
    return numbers.join(',');
}

// æ•°æ®æºæŒ‡ç¤ºå™¨å·²ç§»é™¤

// APIæ•°æ®è·å–åŠŸèƒ½ - ç›´æ¥ä»åŸå§‹APIè·å–
async function fetchApiData() {
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨æ–‡ä»¶æ•°æ®æ¨¡å¼
    if (window.isUsingFileData) {
        console.log('å½“å‰ä¸ºæ–‡ä»¶æ•°æ®æ¨¡å¼ï¼Œè·³è¿‡APIæ•°æ®è·å–');
        return null;
    }
    
    // ğŸ”’ é‡è¦ï¼šåœ¨å‡½æ•°å¼€å§‹æ—¶ç«‹å³ä¿å­˜å½©ç§ç±»å‹ï¼Œé˜²æ­¢å¼‚æ­¥è¿‡ç¨‹ä¸­è¢«åˆ‡æ¢
    const targetLotteryType = currentLotteryType;
    
    try {
        console.log('æ­¥éª¤1: å¼€å§‹ä»APIè·å–æ•°æ®...');
        console.log('ç›®æ ‡å½©ç§:', targetLotteryType);
        
        let apiUrl, response, data;
        
        // å¸å®‰ç³»åˆ—å’Œæ³¢åœºç³»åˆ—å½©ç§ï¼ˆ3åˆ†PK10ã€5åˆ†PK10ç­‰ï¼‰ç»Ÿä¸€å¤„ç†
        if (targetLotteryType.startsWith('bscbh') || targetLotteryType.startsWith('tronbh')) {
            // å¸å®‰/æ³¢åœºç³»åˆ— API - ç›´æ¥è°ƒç”¨åŸå§‹APIè·å–æœ€æ–°æ•°æ®
            const now = new Date();
            const startTime = new Date(now.getTime() - 10 * 60 * 1000); // å¾€å‰10åˆ†é’Ÿ
            const startTimeStr = startTime.getFullYear() + '-' + 
                               String(startTime.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(startTime.getDate()).padStart(2, '0') + ' ' +
                               String(startTime.getHours()).padStart(2, '0') + ':' +
                               String(startTime.getMinutes()).padStart(2, '0') + ':00';
            const endTimeStr = now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0') + ' ' +
                             String(now.getHours()).padStart(2, '0') + ':' +
                             String(now.getMinutes()).padStart(2, '0') + ':59';
            
            const lotteryName = targetLotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                               (targetLotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
            apiUrl = `https://wkcvip.qqtjw666.com/api/trial/draw-result-by-datetime?code=${targetLotteryType}&rows=10&start_time=${encodeURIComponent(startTimeStr)}&end_time=${encodeURIComponent(endTimeStr)}&page=1`;
            console.log(`${lotteryName} APIè°ƒç”¨:`, apiUrl);
            
            response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            }
            
            const lotteryNameForLog = targetLotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 'å¸å®‰5åˆ†PK10';
            data = await parseServerJson(response, `${lotteryNameForLog}æœ€æ–°æ•°æ®`);
            console.log(`æ­¥éª¤2: ${lotteryNameForLog} APIè¿”å›æ•°æ®:`, data);
            
            // å¤„ç†å¸å®‰ç³»åˆ—æ•°æ®æ ¼å¼
            if (data && data.code === 0 && data.data && data.data.data && Array.isArray(data.data.data) && data.data.data.length > 0) {
                console.log(`æ­¥éª¤3: å¼€å§‹å¤„ç†${lotteryNameForLog}æ•°æ®ï¼Œå…±`, data.data.data.length, 'æ¡');
                
                const currentStorage = getCurrentLotteryData();
                let newDataCount = 0;
                let newDataItems = [];
                
                for (const item of data.data.data) {
                    try {
                        const period = item.issue;
                        const numbersStr = item.drawResult;
                        const drawTime = item.drawTime;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æœŸæ•°æ®ï¼ˆä½¿ç”¨ç›®æ ‡å½©ç§ç±»å‹ï¼‰
                        const dataExists = isPeriodExists(period, targetLotteryType);
                        
                        if (!dataExists) {
                            // è§£æå·ç 
                            const numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
                            
                            if (numbers.length >= 5 && !numbers.some(isNaN)) {
                                // æ·»åŠ åˆ°æœŸå·é›†åˆï¼ˆä½¿ç”¨ç›®æ ‡å½©ç§ç±»å‹ï¼‰
                                addPeriodToSet(period, targetLotteryType);
                                
                                // æ·»åŠ åˆ°ä¸´æ—¶æ•°ç»„
                                newDataItems.push({
                                    period: period,
                                    data: numbers,
                                    input: numbers.join(','),
                                    æœŸå·: period,
                                    å¼€å¥–å·ç : numbers.map(num => num.toString().padStart(2, '0')),
                                    å¼€å¥–æ—¶é—´: drawTime
                                });
                                
                                newDataCount++;
                            }
                        }
                    } catch (error) {
                        console.error('å¤„ç†å¸å®‰3åˆ†PK10æ•°æ®é¡¹æ—¶å‡ºé”™:', error, item);
                    }
                }
                
                // æŒ‰æœŸå·æ’åºæ–°æ•°æ®ï¼Œç¡®ä¿æœ€æ–°æœŸå·åœ¨å‰
                newDataItems.sort((a, b) => {
                    const periodA = parseInt(a.period);
                    const periodB = parseInt(b.period);
                    return periodB - periodA;
                });
                
                // å°†æ–°æ•°æ®æ·»åŠ åˆ°ç›®æ ‡å½©ç¥¨ç±»å‹çš„æ•°æ®å­˜å‚¨ï¼ˆæ˜ç¡®ä¼ é€’å½©ç§ç±»å‹å‚æ•°ï¼‰
                addToCurrentLotteryData(newDataItems, targetLotteryType);
                
                console.log(`æ­¥éª¤4: ${lotteryNameForLog}æ•°æ®å¤„ç†å®Œæˆï¼Œæ–°å¢`, newDataCount, 'æ¡æ•°æ®');
                console.log('æ­¥éª¤5: å·²å°†æ•°æ®åŒæ­¥åˆ°window.rå’Œå…¨å±€rï¼Œæ€»é•¿åº¦:', window.r.length);
                
                // æ›´æ–°æœŸæ•°ç»Ÿè®¡
                document.getElementById('periodCount').textContent = r.length;
                
                // åªæœ‰åœ¨æœ‰æ–°æ•°æ®æ—¶æ‰åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
                if (newDataCount > 0) {
                    console.log('âœ¨ æ­¥éª¤6: æ£€æµ‹åˆ°', newDataCount, 'æ¡æ–°æ•°æ®ï¼Œåˆ·æ–°è¡¨æ ¼æ˜¾ç¤º');
                    console.log('âœ¨ æœ€æ–°æœŸå·:', newDataItems[0]?.period, 'å¼€å¥–æ—¶é—´:', newDataItems[0]?.å¼€å¥–æ—¶é—´);
                    L(); // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºæ–°æ•°æ®
                    
                    // åŒæ­¥åˆ°éªŒè¯è®¡åˆ’å’Œå•æœŸéªŒè¯
                    if (typeof window.syncDataToVerifyPlan === 'function') {
                        window.syncDataToVerifyPlan();
                    }
                    if (typeof window.updateSinglePeriodTable === 'function') {
                        window.updateSinglePeriodTable();
                    }
                } else {
                    const currentLatestPeriod = r.length > 0 ? r[0].period : 'æ— ';
                    const apiLatestPeriod = data.data.data.length > 0 ? data.data.data[0].issue : 'æ— ';
                    console.log('â¸ï¸ æ­¥éª¤6: æ²¡æœ‰æ–°æ•°æ®ï¼Œè·³è¿‡è¡¨æ ¼åˆ·æ–° | å½“å‰æœ€æ–°æœŸå·:', currentLatestPeriod, '| APIè¿”å›æœ€æ–°æœŸå·:', apiLatestPeriod);
                }
                
                console.log(`æ­¥éª¤7: ${lotteryNameForLog}æ•°æ®å¤„ç†å’Œæ˜¾ç¤ºæ›´æ–°å®Œæˆ`);
                
                return { newDataCount, totalCount: r.length };
            } else {
                console.log(`${lotteryNameForLog} APIè¿”å›ç©ºæ•°æ®æˆ–æ ¼å¼é”™è¯¯`);
                return { newDataCount: 0, totalCount: r.length };
            }
            
        } else if (targetLotteryType === 'twpk10') {
            // å°æ¹¾PK10 API - æ ¹æ®ç¯å¢ƒé€‰æ‹©APIç«¯ç‚¹
            const isVercel = window.location.hostname.includes('vercel.app') || 
                           window.location.hostname.includes('netlify.app') || 
                           window.location.protocol === 'https:';
            
            if (isVercel) {
                // Vercelç¯å¢ƒä½¿ç”¨ä»£ç†API
                apiUrl = '/api/taiwan-pk10-latest?limit=200';
                console.log('ä½¿ç”¨Vercelä»£ç†API:', apiUrl);
            } else {
                // æœ¬åœ°ç¯å¢ƒç›´æ¥è°ƒç”¨åŸå§‹API
                apiUrl = 'http://47.242.214.89/api/latest?limit=200';
                console.log('ä½¿ç”¨åŸå§‹å°æ¹¾PK10 API:', apiUrl);
            }
            
            response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            }
            
            data = await parseServerJson(response, 'å°æ¹¾PK10æœ€æ–°æ•°æ®');
            console.log('æ­¥éª¤2: å°æ¹¾PK10 APIè¿”å›æ•°æ®:', data);
            
            // å¤„ç†å°æ¹¾PK10æ•°æ®æ ¼å¼
            if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                console.log('æ­¥éª¤3: å¼€å§‹å¤„ç†å°æ¹¾PK10æ•°æ®ï¼Œå…±', data.data.length, 'æ¡');
                
                // è·å–å½“å‰å½©ç¥¨ç±»å‹çš„æ•°æ®å­˜å‚¨
                const currentStorage = getCurrentLotteryData();
                let newDataCount = 0;
                let newDataItems = []; // ä¸´æ—¶å­˜å‚¨æ–°æ•°æ®
                
                for (const item of data.data) {
                    try {
                        // è§£æopencodeï¼Œå»æ‰æœ€åçš„+æ•°å­—éƒ¨åˆ†
                        const opencode = item.opencode.split('+')[0]; // å»æ‰+33éƒ¨åˆ†
                        const numbers = opencode.split(',').map(num => parseInt(num.trim()));
                        
                        if (numbers.length === 20) {
                            // ä½¿ç”¨calcResultå‡½æ•°è½¬æ¢ä¸º10ä½æ•°å­—
                            const convertedNumbers = calcResult(numbers);
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æœŸæ•°æ®ï¼ˆä½¿ç”¨ç›®æ ‡å½©ç§ç±»å‹ï¼‰
                            const period = item.expect;
                            const dataExists = isPeriodExists(period, targetLotteryType);
                            
                            if (!dataExists) {
                                // æ·»åŠ åˆ°æœŸå·é›†åˆï¼ˆä½¿ç”¨ç›®æ ‡å½©ç§ç±»å‹ï¼‰
                                addPeriodToSet(period, targetLotteryType);
                                
                                // æ·»åŠ åˆ°ä¸´æ—¶æ•°ç»„ï¼Œæ ¼å¼ä¸å¹¸è¿é£è‰‡ä¿æŒä¸€è‡´
                                newDataItems.push({
                                    period: period,
                                    data: convertedNumbers,
                                    input: convertedNumbers.map(num => num.toString().padStart(2, '0')).join(','),
                                    æœŸå·: period,
                                    å¼€å¥–å·ç : convertedNumbers.map(num => num.toString().padStart(2, '0')),
                                    å¼€å¥–æ—¶é—´: item.opentime
                                });
                                
                                newDataCount++;
                            }
                        }
                    } catch (error) {
                        console.error('å¤„ç†å°æ¹¾PK10æ•°æ®é¡¹æ—¶å‡ºé”™:', error, item);
                    }
                }
                
                // æŒ‰æœŸå·æ’åºæ–°æ•°æ®ï¼Œç¡®ä¿æœ€æ–°æœŸå·åœ¨å‰
                newDataItems.sort((a, b) => {
                    const periodA = parseInt(a.period);
                    const periodB = parseInt(b.period);
                    return periodB - periodA; // é™åºæ’åˆ—ï¼Œæœ€æ–°æœŸå·åœ¨å‰
                });
                
                // å°†æ–°æ•°æ®æ·»åŠ åˆ°ç›®æ ‡å½©ç¥¨ç±»å‹çš„æ•°æ®å­˜å‚¨
                addToCurrentLotteryData(newDataItems, targetLotteryType);
                
                console.log('æ­¥éª¤4: å°æ¹¾PK10æ•°æ®å¤„ç†å®Œæˆï¼Œæ–°å¢', newDataCount, 'æ¡æ•°æ®');
                console.log('æ­¥éª¤5: å·²å°†æ•°æ®åŒæ­¥åˆ°window.rå’Œå…¨å±€rï¼Œæ€»é•¿åº¦:', window.r.length);
                
                // æ›´æ–°æœŸæ•°ç»Ÿè®¡
                document.getElementById('periodCount').textContent = r.length;
                
                // åªæœ‰åœ¨æœ‰æ–°æ•°æ®æ—¶æ‰åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
                if (newDataCount > 0) {
                    console.log('âœ¨ æ­¥éª¤6: æ£€æµ‹åˆ°', newDataCount, 'æ¡æ–°æ•°æ®ï¼Œåˆ·æ–°è¡¨æ ¼æ˜¾ç¤º');
                    console.log('âœ¨ æœ€æ–°æœŸå·:', newDataItems[0]?.period, 'å¼€å¥–æ—¶é—´:', newDataItems[0]?.å¼€å¥–æ—¶é—´);
                    L(); // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºæ–°æ•°æ®
                    
                    // åŒæ­¥åˆ°éªŒè¯è®¡åˆ’å’Œå•æœŸéªŒè¯
                    if (typeof window.syncDataToVerifyPlan === 'function') {
                        window.syncDataToVerifyPlan();
                    }
                    if (typeof window.updateSinglePeriodTable === 'function') {
                        window.updateSinglePeriodTable();
                    }
                } else {
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰æœ€æ–°æœŸå·å’ŒAPIè¿”å›çš„æœ€æ–°æœŸå·
                    const currentLatestPeriod = r.length > 0 ? r[0].period : 'æ— ';
                    const apiLatestPeriod = data.data.length > 0 ? data.data[0].expect : 'æ— ';
                    console.log('â¸ï¸ æ­¥éª¤6: æ²¡æœ‰æ–°æ•°æ®ï¼Œè·³è¿‡è¡¨æ ¼åˆ·æ–° | å½“å‰æœ€æ–°æœŸå·:', currentLatestPeriod, '| APIè¿”å›æœ€æ–°æœŸå·:', apiLatestPeriod);
                }
                
                // ä¿å­˜æ•°æ®åˆ°ç¼“å­˜
                try {
                    const currentData = getCurrentLotteryData();
                    localStorage.setItem('twpk10_cached_data', JSON.stringify(currentData.data));
                    localStorage.setItem('twpk10_cache_time', Date.now().toString());
                    console.log('âœ… å°æ¹¾PK10æ•°æ®å·²ä¿å­˜åˆ°ç¼“å­˜');
                } catch (e) {
                    console.warn('âš ï¸ ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
                }
                
                console.log('æ­¥éª¤7: å°æ¹¾PK10æ•°æ®å¤„ç†å’Œæ˜¾ç¤ºæ›´æ–°å®Œæˆ');
                
                return { newDataCount, totalCount: r.length };
            } else {
                throw new Error('å°æ¹¾PK10 APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
            }
            
        } else if (targetLotteryType === 'xyft') {
            // å¹¸è¿é£è‰‡ API (åŸæœ‰é€»è¾‘)
            apiUrl = 'https://api.api68.com/pks/getLotteryPksInfo.do?lotCode=10057';
        } else if (targetLotteryType === 'jsft') {
            // æ€¥é€Ÿé£è‰‡ API
            apiUrl = 'https://jvt.168skfbm.com/api/pks/getLotteryPksInfo.do?lotCode=10037';
            
            try {
                // å°è¯•æ­£å¸¸fetch
                response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
            } catch (corsError) {
                console.log('CORSé”™è¯¯ï¼Œå°è¯•no-corsæ¨¡å¼:', corsError);
                // å¦‚æœCORSå¤±è´¥ï¼Œå°è¯•no-corsæ¨¡å¼
                response = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'no-cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
            }
            
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            }
            
            data = await parseServerJson(response, targetLotteryType === 'jsft' ? 'æé€Ÿé£è‰‡æ•°æ®æ¥å£' : 'å¹¸è¿é£è‰‡æ•°æ®æ¥å£');
            console.log('æ­¥éª¤2: å¹¸è¿é£è‰‡ APIè¿”å›æ•°æ®:', data);
            
            // æ£€æŸ¥APIè¿”å›çš„é”™è¯¯ç 
            if (data.errorCode !== 0) {
                throw new Error(data.message || 'APIè¿”å›é”™è¯¯');
            }
        }
        
        // è§£æAPIæ•°æ® (å¹¸è¿é£è‰‡å’Œæ€¥é€Ÿé£è‰‡)
        if (currentLotteryType === 'xyft' || currentLotteryType === 'jsft') {
            let period, numbersStr, drawTime;
            
            if (data && data.result && data.result.data) {
                const apiData = data.result.data;
                period = apiData.preDrawIssue;
                numbersStr = apiData.preDrawCode;
                drawTime = apiData.preDrawTime;
            } else {
                throw new Error('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }
            
            console.log('æ­¥éª¤3: è§£ææ•°æ®:', { period, numbersStr, drawTime });
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æœŸæ•°æ®
            const dataExists = isPeriodExists(period);
            
            if (dataExists) {
                console.log('æ­¥éª¤4: æ•°æ®å·²å­˜åœ¨ï¼Œæ— éœ€æ·»åŠ ');
                return { period, numbersStr, drawTime, dataExists: true };
            } else {
                console.log('æ­¥éª¤4: æ•°æ®ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ·»åŠ æ–°æ•°æ®');
            }
            
            // å¤„ç†æ•°æ®
            let numbers;
            
            if (currentLotteryType === 'twpk10') {
                // å°æ¹¾PK10ï¼šåŸå§‹20ä¸ªæ•°å­—ï¼Œéœ€è¦è½¬æ¢ä¸º10ä¸ªæ•°å­—
                const cleanStr = numbersStr.split('+')[0]; // å»æ‰+68éƒ¨åˆ†
                const raw20Numbers = cleanStr.split(',').map(n => parseInt(n.trim(), 10));
                
                if (raw20Numbers.length === 20 && !raw20Numbers.some(isNaN)) {
                    // ä½¿ç”¨calcResultè½¬æ¢20ä¸ªæ•°å­—ä¸º10ä¸ªæ’å
                    numbers = calcResult(raw20Numbers);
                    console.log(`æ­¥éª¤4.5: å°æ¹¾PK10è½¬æ¢ - 20ä¸ªæ•°å­—è½¬æ¢ä¸º10ä¸ªæ’å: [${numbers.join(',')}]`);
                } else {
                    throw new Error(`æ•°æ®æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º20ä¸ªæ•°å­—ï¼Œå®é™…ä¸º ${raw20Numbers.length} ä¸ª`);
                }
            } else {
                // å…¶ä»–å½©ç§ï¼šç›´æ¥è§£æ10ä¸ªæ•°å­—
                numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
                if (numbers.length !== 10 || numbers.some(isNaN)) {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
            }
            
                // æ·»åŠ æ–°æ•°æ®åˆ°æ•°ç»„
                addPeriodToSet(period);
                const newData = {
                    period: period,
                    data: numbers,
                input: numbers.join(',') // å­˜å‚¨è½¬æ¢åçš„10ä¸ªæ•°å­—
                };
                addToCurrentLotteryData([newData]);
                console.log('æ­¥éª¤5: æ–°æ•°æ®å·²æ·»åŠ åˆ°æ•°ç»„ï¼Œå½“å‰æ•°ç»„é•¿åº¦:', r.length);
                
                console.log('æ­¥éª¤6: å·²å°†æ•°æ®åŒæ­¥åˆ°window.rï¼Œé•¿åº¦:', window.r.length);
                
                // è§¦å‘è®¡åˆ’è‡ªåŠ¨éªŒè¯
                if (window.PlanDataUpdateListener && typeof window.PlanDataUpdateListener.onHistoryDataUpdate === 'function') {
                    console.log('æ­¥éª¤6.1: è§¦å‘è®¡åˆ’è‡ªåŠ¨éªŒè¯');
                    const newDataItem = {
                        period: period,
                        data: numbers,
                    input: numbers.join(',')
                    };
                    window.PlanDataUpdateListener.onHistoryDataUpdate([newDataItem]);
                }
                
                // æ›´æ–°æœŸæ•°ç»Ÿè®¡
                document.getElementById('periodCount').textContent = r.length;
                
                // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºæ–°æ•°æ®
                console.log('æ­¥éª¤7: æ£€æµ‹åˆ°æ–°æ•°æ®ï¼Œåˆ·æ–°è¡¨æ ¼æ˜¾ç¤º');
                L(); // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºæ–°æ•°æ®
                console.log('æ­¥éª¤8: æ•°æ®å¤„ç†å®Œæˆï¼Œè¡¨æ ¼å·²åˆ·æ–°');
            
                console.log('æ­¥éª¤9: æ•°æ®å¤„ç†å®Œæˆï¼ŒçŠ¶æ€æ›´æ–°å·²è§¦å‘');
            
            return { period, numbersStr, drawTime, dataExists };
        }
    } catch (error) {
        console.error('è·å–APIæ•°æ®å¤±è´¥:', error);
        console.log('è·å–æ•°æ®å¤±è´¥: ' + error.message);
        return null;
    }
}

// å†å²æ•°æ®è·å–åŠŸèƒ½ - è·å–æŒ‡å®šæ—¥æœŸçš„å†å²å¼€å¥–æ•°æ®
window.fetchHistoryData = async function fetchHistoryData() {
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨æ–‡ä»¶æ•°æ®æ¨¡å¼
    if (window.isUsingFileData) {
        console.log('å½“å‰ä¸ºæ–‡ä»¶æ•°æ®æ¨¡å¼ï¼Œè·³è¿‡å†å²æ•°æ®è·å–');
        return null;
    }
    
    // è·å–å½“å‰å½©ç§ç±»å‹
    const lotteryType = currentLotteryType || 'twpk10';
    console.log(`å½“å‰å½©ç§: ${lotteryType}`);
    
    try {
        console.log(`æ­¥éª¤1: å¼€å§‹è·å–${lotteryType}å†å²æ•°æ®ï¼ˆä»Šå¤©å’Œæ˜¨å¤©ï¼‰...`);
        
        // è®¡ç®—ä»Šå¤©å’Œæ˜¨å¤©çš„æ—¥æœŸ
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const todayStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
        
        const yesterdayStr = yesterday.getFullYear() + '-' + 
                            String(yesterday.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(yesterday.getDate()).padStart(2, '0');
        
        // å°æ¹¾PK10å’Œå¸å®‰3åˆ†PK10æ˜¯å¾ªç¯æ•°æ®ï¼Œä¸éœ€è¦æŒ‰æ—¥æœŸè¯·æ±‚
        let dates, allHistoryItems = [];
        
        if (lotteryType === 'twpk10') {
            console.log('æ­¥éª¤2: å°æ¹¾PK10ä½¿ç”¨200æœŸå¾ªç¯æ•°æ®ï¼Œåªè¯·æ±‚ä¸€æ¬¡');
            dates = [null]; // åªè¯·æ±‚ä¸€æ¬¡ï¼Œä¸å¸¦æ—¥æœŸå‚æ•°
        } else if (lotteryType.startsWith('bscbh') || lotteryType.startsWith('tronbh')) {
            const lotteryName = lotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                               (lotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
            console.log(`æ­¥éª¤2: ${lotteryName}ä½¿ç”¨å†å²æ•°æ®ï¼Œè¯·æ±‚ä»Šå¤©å’Œæ˜¨å¤©`);
            dates = [todayStr, yesterdayStr]; // è¯·æ±‚ä»Šå¤©å’Œæ˜¨å¤©çš„æ•°æ®
        } else {
        console.log('æ­¥éª¤2: å‡†å¤‡è·å–ä¸¤å¤©æ•°æ®:', { today: todayStr, yesterday: yesterdayStr });
            dates = [todayStr, yesterdayStr];
        }
        
        for (const dateStr of dates) {
            // æ£€æµ‹æ˜¯å¦åœ¨Vercelç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ç›¸åº”çš„APIç«¯ç‚¹
            const isVercel = window.location.hostname.includes('vercel.app') || window.location.hostname.includes('myyz.vercel.app');
            let historyApiUrl;
            
            // å¸å®‰ç³»åˆ—å’Œæ³¢åœºç³»åˆ—å§‹ç»ˆç›´æ¥è°ƒç”¨åŸå§‹APIï¼Œä¸ä½¿ç”¨Vercelä»£ç†
            if (lotteryType.startsWith('bscbh') || lotteryType.startsWith('tronbh')) {
                // å¸å®‰/æ³¢åœºç³»åˆ—çš„API - ç›´æ¥è°ƒç”¨
                const startTime = `${dateStr} 00:00:00`;
                const endTime = `${dateStr} 23:59:59`;
                const lotteryName = lotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                                   (lotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
                historyApiUrl = `https://wkcvip.qqtjw666.com/api/trial/draw-result-by-datetime?code=${lotteryType}&rows=100&start_time=${encodeURIComponent(startTime)}&end_time=${encodeURIComponent(endTime)}&page=1`;
                console.log(`æ­¥éª¤2.${dates.indexOf(dateStr) + 1}: ${lotteryName}ç›´æ¥è°ƒç”¨API:`, historyApiUrl);
            } else if (isVercel) {
                // Vercelç¯å¢ƒä¸‹ä½¿ç”¨ä»£ç†APIï¼ˆå…¶ä»–å½©ç§ï¼‰
                if (lotteryType === 'jsft') {
                    historyApiUrl = `/api/jsft-data?date=${dateStr}`;
                } else {
                    // å°æ¹¾PK10ä¸å¸¦æ—¥æœŸå‚æ•°
                    historyApiUrl = `/api/taiwan-pk10-data`;
                }
                console.log(`æ­¥éª¤2.${dates.indexOf(dateStr) + 1}: Vercelç¯å¢ƒï¼Œä½¿ç”¨ä»£ç†API:`, historyApiUrl);
            } else {
                // æœ¬åœ°ç¯å¢ƒç›´æ¥è°ƒç”¨å¤–éƒ¨API
                if (lotteryType === 'jsft') {
                    historyApiUrl = `https://jvt.168skfbm.com/api/pks/getPksHistoryList.do?lotCode=10037&date=${dateStr}`;
                } else {
                    // å°æ¹¾PK10ç›´æ¥è·å–æœ€æ–°200æœŸ
                    historyApiUrl = `http://47.242.214.89/api/latest?limit=200`;
                }
                console.log(`æ­¥éª¤2.${dates.indexOf(dateStr) + 1}: æœ¬åœ°ç¯å¢ƒï¼Œç›´æ¥è°ƒç”¨API:`, historyApiUrl);
            }
        
            let response;
            try {
                // å°è¯•æ­£å¸¸fetch
                response = await fetch(historyApiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
            } catch (corsError) {
                console.log(`è¯·æ±‚é”™è¯¯ (${dateStr}):`, corsError);
                if (!isVercel) {
                    // æœ¬åœ°ç¯å¢ƒå°è¯•no-corsæ¨¡å¼
                    console.log(`CORSé”™è¯¯ï¼Œå°è¯•no-corsæ¨¡å¼ (${dateStr}):`, corsError);
                    response = await fetch(historyApiUrl, {
                        method: 'GET',
                        mode: 'no-cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                } else {
                    throw corsError; // Vercelç¯å¢ƒä¸‹ç›´æ¥æŠ›å‡ºé”™è¯¯
                }
            }
            
            if (!response.ok) {
                console.warn(`HTTPé”™è¯¯ (${dateStr})! çŠ¶æ€: ${response.status}`);
                continue; // è·³è¿‡è¿™ä¸ªæ—¥æœŸï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            }
            
            const data = await parseServerJson(response, `${dateStr} å†å²æ•°æ®æ¥å£`);
            console.log(`æ­¥éª¤3.${dates.indexOf(dateStr) + 1}: ${dateStr} å†å²æ•°æ®APIè¿”å›:`, data);
            
            let historyItems = [];
            
            // å¸å®‰ç³»åˆ—å’Œæ³¢åœºç³»åˆ—çš„æ•°æ®å¤„ç†ï¼ˆå§‹ç»ˆä½¿ç”¨åŸå§‹APIæ ¼å¼ï¼‰
            if (lotteryType.startsWith('bscbh') || lotteryType.startsWith('tronbh')) {
                // å¸å®‰/æ³¢åœºç³»åˆ— APIæ ¼å¼: {code: 0, msg: "æˆåŠŸ", data: {data: [...]}}
                const lotteryName = lotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 
                                   (lotteryType === 'bscbh5fpk10' ? 'å¸å®‰5åˆ†PK10' : 'æ³¢åœº3åˆ†PK10');
                if (data.code === 0 && data.data && data.data.data && Array.isArray(data.data.data)) {
                    historyItems = data.data.data.map(item => ({
                        preDrawIssue: item.issue,          // å­—æ®µï¼šissue
                        preDrawCode: item.drawResult,      // å­—æ®µï¼šdrawResult
                        preDrawTime: item.drawTime         // å­—æ®µï¼šdrawTime
                    }));
                    console.log(`æ­¥éª¤4.${dates.indexOf(dateStr) + 1}: ${lotteryName} API ${dateStr} è·å–åˆ° ${historyItems.length} æ¡å†å²æ•°æ®`);
                } else {
                    console.warn(`${lotteryName} APIè¿”å›æ ¼å¼ä¸æ­£ç¡® (${dateStr}):`, data);
                    continue;
                }
            } else if (isVercel) {
                // Vercel APIè¿”å›æ ¼å¼å¤„ç†ï¼ˆå…¶ä»–å½©ç§ï¼‰
                if (data.success && data.data && Array.isArray(data.data)) {
                    // è½¬æ¢Vercel APIæ ¼å¼åˆ°åŸå§‹æ ¼å¼
                    historyItems = data.data.map(item => ({
                        preDrawIssue: item.period,
                        preDrawCode: item.numbers,
                        preDrawTime: item.timestamp || item.time || dateStr
                    }));
                    console.log(`æ­¥éª¤4.${dates.indexOf(dateStr) + 1}: Vercel API ${dateStr} è·å–åˆ° ${historyItems.length} æ¡å†å²æ•°æ®`);
                } else if (!data.success) {
                    console.warn(`Vercel APIè¿”å›é”™è¯¯ (${dateStr}):`, data.error || 'æœªçŸ¥é”™è¯¯');
                    continue; // è·³è¿‡è¿™ä¸ªæ—¥æœŸï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
                } else {
                    console.warn(`${dateStr} Vercel APIè¿”å›æ ¼å¼ä¸æ­£ç¡®`);
                    continue;
                }
            } else {
                // æœ¬åœ°ç¯å¢ƒ - åŸå§‹APIè¿”å›æ ¼å¼å¤„ç†
                if (lotteryType === 'twpk10') {
                    // å°æ¹¾PK10æœ¬åœ°ç¯å¢ƒ - é˜¿é‡Œäº‘APIæ ¼å¼ {success, data: [...]}
                    if (data.success && data.data && Array.isArray(data.data)) {
                        historyItems = data.data.map(item => ({
                            preDrawIssue: item.expect,      // é˜¿é‡Œäº‘å­—æ®µï¼šexpect
                            preDrawCode: item.opencode,     // é˜¿é‡Œäº‘å­—æ®µï¼šopencode
                            preDrawTime: item.opentime      // é˜¿é‡Œäº‘å­—æ®µï¼šopentime
                        }));
                        console.log(`æ­¥éª¤4: æœ¬åœ°API è·å–åˆ° ${historyItems.length} æ¡å†å²æ•°æ®`);
                    } else {
                        console.warn(`æœ¬åœ°APIè¿”å›æ ¼å¼ä¸æ­£ç¡®:`, data);
                        continue;
                    }
                } else {
                    // æ€¥é€Ÿé£è‰‡æœ¬åœ°ç¯å¢ƒ
                if (data.errorCode !== 0) {
                    console.warn(`APIè¿”å›é”™è¯¯ (${dateStr}):`, data.message || 'æœªçŸ¥é”™è¯¯');
                        continue;
                }
                
                if (data && data.result && data.result.data && Array.isArray(data.result.data)) {
                    historyItems = data.result.data;
                    console.log(`æ­¥éª¤4.${dates.indexOf(dateStr) + 1}: åŸå§‹API ${dateStr} è·å–åˆ° ${historyItems.length} æ¡å†å²æ•°æ®`);
                } else {
                    console.warn(`${dateStr} åŸå§‹APIè¿”å›æ ¼å¼ä¸æ­£ç¡®`);
                    continue;
                    }
                }
            }
            
            allHistoryItems.push(...historyItems);
        }
        
        console.log(`æ­¥éª¤3: æ€»å…±è·å–åˆ° ${allHistoryItems.length} æ¡å†å²æ•°æ®`);
        
        if (allHistoryItems.length > 0) {
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—å†å²æ•°æ®ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            allHistoryItems.sort((a, b) => {
                const timeA = new Date(a.preDrawTime);
                const timeB = new Date(b.preDrawTime);
                return timeB.getTime() - timeA.getTime(); // å€’åºæ’åˆ—
            });
            
            // æ¸…ç©ºç°æœ‰æ•°æ®ï¼Œç›´æ¥è®¾ç½®æ–°æ•°æ®
            r = [];
            d = new Set();
            
            // æ·»åŠ æ‰€æœ‰æ•°æ®åˆ°æ•°ç»„
            let addedCount = 0;
            for (const item of allHistoryItems) {
                const period = item.preDrawIssue;
                const numbersStr = item.preDrawCode;
                
                // è§£æå·ç 
                let numbers;
                
                if (lotteryType === 'twpk10') {
                    // å°æ¹¾PK10ï¼šåŸå§‹20ä¸ªæ•°å­—ï¼Œéœ€è¦è½¬æ¢ä¸º10ä¸ªæ•°å­—
                    // æ ¼å¼ï¼š06,33,62,...,68+68 ï¼ˆå»æ‰æœ€åçš„+å·å’Œé‡å¤æ•°å­—ï¼‰
                    const cleanStr = numbersStr.split('+')[0]; // å»æ‰+68éƒ¨åˆ†
                    const raw20Numbers = cleanStr.split(',').map(n => parseInt(n.trim(), 10));
                    
                    if (raw20Numbers.length === 20 && !raw20Numbers.some(isNaN)) {
                        // ä½¿ç”¨calcResultè½¬æ¢20ä¸ªæ•°å­—ä¸º10ä¸ªæ’å
                        numbers = calcResult(raw20Numbers);
                        console.log(`æœŸå· ${period}: 20ä¸ªæ•°å­— [${raw20Numbers.slice(0,5).join(',')}...] è½¬æ¢ä¸º 10ä¸ªæ’å [${numbers.join(',')}]`);
                    } else {
                        console.warn(`æœŸå· ${period}: æ•°æ®æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º20ä¸ªæ•°å­—ï¼Œå®é™…ä¸º ${raw20Numbers.length} ä¸ª`);
                        continue;
                    }
                } else if (lotteryType.startsWith('bscbh')) {
                    // å¸å®‰ç³»åˆ—ï¼šç›´æ¥è§£æå·ç 
                    const lotteryName = lotteryType === 'bscbh3fpk10' ? 'å¸å®‰3åˆ†PK10' : 'å¸å®‰5åˆ†PK10';
                    numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
                    console.log(`æœŸå· ${period}: ${lotteryName}æ•°æ® [${numbers.join(',')}]ï¼Œå…±${numbers.length}ä¸ªå·ç `);
                    
                    // å¸å®‰ç³»åˆ—å¯èƒ½æ˜¯5ä¸ªæˆ–10ä¸ªå·ç ï¼Œéƒ½æ¥å—
                    if (numbers.length < 5 || numbers.some(isNaN)) {
                        console.warn(`æœŸå· ${period}: æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå·ç æ•°é‡: ${numbers.length}`);
                        continue;
                    }
                } else {
                    // å…¶ä»–å½©ç§ï¼šç›´æ¥è§£æ10ä¸ªæ•°å­—
                    numbers = numbersStr.split(',').map(n => parseInt(n.trim(), 10));
                    if (numbers.length !== 10 || numbers.some(isNaN)) {
                        console.warn(`æœŸå· ${period}: æ•°æ®æ ¼å¼é”™è¯¯`);
                        continue;
                    }
                }
                
                    r.push({
                        period: period,
                        data: numbers,
                    input: numbers.join(',') // å­˜å‚¨è½¬æ¢åçš„10ä¸ªæ•°å­—
                    });
                    d.add(period);
                    addedCount++;
            }
            
            // æŒ‰æœŸæ•°å€’åºæ’åˆ—ï¼Œç¡®ä¿æœ€æ–°æœŸæ•°åœ¨æœ€ä¸Šæ–¹
            r.sort((a, b) => parseInt(b.period) - parseInt(a.period));
            
            // åŒæ­¥åˆ°å…¨å±€å˜é‡å’Œå­˜å‚¨
            window.r = r;
            setCurrentLotteryData(r);
            
            // æ›´æ–°æœŸæ•°ç»Ÿè®¡
            document.getElementById('periodCount').textContent = r.length;
            
            console.log(`æ•°æ®è·å–å®Œæˆ: å…±${addedCount}æœŸï¼Œå·²æŒ‰æœŸæ•°å€’åºæ’åˆ—`);
            
            // ç›´æ¥åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
            L();
            
            return { success: true, total: allHistoryItems.length, added: addedCount };
        } else {
            throw new Error('å†å²æ•°æ®APIè¿”å›æ ¼å¼ä¸æ­£ç¡®');
        }
        
    } catch (error) {
        console.error('è·å–å†å²æ•°æ®å¤±è´¥:', error);
        return { success: false, error: error.message };
    }
}

// å†å²æ•°æ®è‡ªåŠ¨è·å–å®šæ—¶å™¨
let historyDataTimer = null;

// å¯åŠ¨å†å²æ•°æ®è‡ªåŠ¨è·å–
window.startHistoryDataFetch = function startHistoryDataFetch() {
    if (historyDataTimer) {
        clearInterval(historyDataTimer);
    }
    
    console.log('å¯åŠ¨å†å²æ•°æ®è‡ªåŠ¨è·å–ï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    fetchHistoryData();
    
    // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡
    historyDataTimer = setInterval(() => {
        fetchHistoryData();
    }, 2000);
}

// åœæ­¢å†å²æ•°æ®è‡ªåŠ¨è·å–
window.stopHistoryDataFetch = function stopHistoryDataFetch() {
    if (historyDataTimer) {
        clearInterval(historyDataTimer);
        historyDataTimer = null;
        console.log('å†å²æ•°æ®è‡ªåŠ¨è·å–å·²åœæ­¢');
    }
}

// éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®è‡ªåŠ¨è·å–å®šæ—¶å™¨
let verifyPlanDataTimer = null;

// å¯åŠ¨éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®è‡ªåŠ¨è·å–
window.startVerifyPlanDataFetch = function startVerifyPlanDataFetch() {
    if (verifyPlanDataTimer) {
        clearInterval(verifyPlanDataTimer);
    }
    
    console.log('å¯åŠ¨éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®è‡ªåŠ¨è·å–ï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    updateVerifyPlanPeriodInfo();
    
    // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡
    verifyPlanDataTimer = setInterval(() => {
        updateVerifyPlanPeriodInfo();
    }, 2000);
}

// åœæ­¢éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®è‡ªåŠ¨è·å–
window.stopVerifyPlanDataFetch = function stopVerifyPlanDataFetch() {
    if (verifyPlanDataTimer) {
        clearInterval(verifyPlanDataTimer);
        verifyPlanDataTimer = null;
        console.log('éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®è‡ªåŠ¨è·å–å·²åœæ­¢');
    }
}

// æ›´æ–°éªŒè¯è®¡åˆ’é¡µé¢æœŸå·ä¿¡æ¯
function updateVerifyPlanPeriodInfo() {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å†å²æ•°æ®ï¼Œé¿å…é‡å¤è·å–
    if (window.historyData && window.historyData.length > 0) {
        // ç›´æ¥ä½¿ç”¨ç°æœ‰æ•°æ®æ›´æ–°æ˜¾ç¤º
        updateVerifyPlanDisplay();
        
        // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼æ•°æ®
        if (typeof window.updateVerifyPlanTable === 'function') {
            window.updateVerifyPlanTable();
        }
    } else {
        // åªæœ‰åœ¨æ²¡æœ‰æ•°æ®æ—¶æ‰è·å–æ–°æ•°æ®
        console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šæ£€æµ‹åˆ°æ— å†å²æ•°æ®ï¼Œå¼€å§‹è·å–...');
        fetchHistoryData().then(result => {
            if (result && result.success) {
                updateVerifyPlanDisplay();
                
                // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼æ•°æ®
                if (typeof window.updateVerifyPlanTable === 'function') {
                    window.updateVerifyPlanTable();
                }
            }
        }).catch(error => {
            console.error('éªŒè¯è®¡åˆ’é¡µé¢æ•°æ®æ›´æ–°å¤±è´¥:', error);
        });
    }
}

// å€’è®¡æ—¶ç›¸å…³å˜é‡
let countdownTimer = null;
let nextDrawTime = null;
let lastApiCallTime = 0;
let isUpdatingDrawTime = false;

// è·å–ä¸‹ä¸€æœŸå¼€å¥–æ—¶é—´
async function getNextDrawTime() {
    try {
        // ä»APIè·å–æœ€æ–°å¼€å¥–æ•°æ®
        const apiUrl = 'https://api.api68.com/pks/getLotteryPksInfo.do?lotCode=10057';
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }
        
        const data = await parseServerJson(response, 'ä¸‹ä¸€æœŸå¼€å¥–æ—¶é—´æ¥å£');
        
        if (data.errorCode !== 0) {
            throw new Error(data.message || 'APIè¿”å›é”™è¯¯');
        }
        
        if (data && data.result && data.result.data) {
            const nextDrawTime = data.result.data.drawTime;
            // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„ä¸‹ä¸€æœŸå¼€å¥–æ—¶é—´
            const nextDraw = new Date(nextDrawTime);
            lastApiCallTime = Date.now();
            return nextDraw;
        }
        
        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
    } catch (error) {
        console.error('è·å–ä¸‹ä¸€æœŸå¼€å¥–æ—¶é—´å¤±è´¥:', error);
        return null;
    }
}

// æ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
function formatCountdown(seconds) {
    if (seconds <= 0) {
        return '00:00';
    }
    
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// å¯åŠ¨å€’è®¡æ—¶
function startCountdown() {
    const verifyLastUpdate = document.getElementById('verifyLastUpdate');
    if (!verifyLastUpdate || !nextDrawTime) return;
    
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    if (countdownTimer) {
        clearInterval(countdownTimer);
    }
    
    countdownTimer = setInterval(async () => {
        const now = new Date();
        const timeDiff = nextDrawTime.getTime() - now.getTime();
        const remainingSeconds = Math.floor(timeDiff / 1000);
        
        if (remainingSeconds <= 0) {
            // å€’è®¡æ—¶ç»“æŸï¼Œæ˜¾ç¤ºå¼€å¥–ä¸­çŠ¶æ€
            clearInterval(countdownTimer);
            verifyLastUpdate.textContent = 'å€’è®¡æ—¶: å¼€å¥–ä¸­...';
            
            // è®¾ç½®ä¸€ä¸ªè¾ƒé•¿çš„ç­‰å¾…æ—¶é—´ï¼Œç­‰å¾…æ•°æ®è‡ªåŠ¨æ›´æ–°
            // æ•°æ®æ›´æ–°ä¼šé€šè¿‡fetchHistoryDataå‡½æ•°è§¦å‘æ–°çš„å€’è®¡æ—¶
            setTimeout(() => {
                // å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ–°æ•°æ®ï¼Œæ‰å°è¯•é‡æ–°è·å–å¼€å¥–æ—¶é—´
                if (verifyLastUpdate.textContent === 'å€’è®¡æ—¶: å¼€å¥–ä¸­...') {
                    if (!isUpdatingDrawTime) {
                        updateVerifyPlanDisplay();
                    }
                }
            }, 300000); // 5åˆ†é’Ÿåæ‰é‡è¯•
        } else {
            verifyLastUpdate.textContent = `å€’è®¡æ—¶: ${formatCountdown(remainingSeconds)}`;
        }
    }, 1000);
}

// æ›´æ–°éªŒè¯è®¡åˆ’é¡µé¢æ˜¾ç¤ºä¿¡æ¯
async function updateVerifyPlanDisplay() {
    const verifyPeriodCount = document.getElementById('verifyPeriodCount');
    const verifyLastUpdate = document.getElementById('verifyLastUpdate');
    
    if (verifyPeriodCount && window.historyData) {
        verifyPeriodCount.textContent = window.historyData.length;
    }
    
    if (verifyLastUpdate) {
        // å¦‚æœæ­£åœ¨æ›´æ–°ä¸­ï¼Œé¿å…é‡å¤è°ƒç”¨
        if (isUpdatingDrawTime) {
            return;
        }
        
        isUpdatingDrawTime = true;
        
        // è·å–ä¸‹ä¸€æœŸå¼€å¥–æ—¶é—´
        nextDrawTime = await getNextDrawTime();
        
        if (nextDrawTime) {
            isUpdatingDrawTime = false;
            // å¯åŠ¨å€’è®¡æ—¶
            startCountdown();
        } else {
            // è·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            verifyLastUpdate.textContent = 'å€’è®¡æ—¶: è·å–å¤±è´¥';
            isUpdatingDrawTime = false;
            
            // 5ç§’åé‡è¯•
            setTimeout(() => {
                if (!isUpdatingDrawTime) {
                    updateVerifyPlanDisplay();
                }
            }, 5000);
        }
    }
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-white font-medium transition-all duration-300 transform translate-x-full`;
    
    // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
    switch(type) {
        case 'success':
            notification.classList.add('bg-green-500');
            break;
        case 'error':
            notification.classList.add('bg-red-500');
            break;
        case 'warning':
            notification.classList.add('bg-yellow-500');
            break;
        default:
            notification.classList.add('bg-blue-500');
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // 3ç§’åéšè—
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// å¯åŠ¨æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–° - å·²ç¦ç”¨äº‘ç«¯æ•°æ®åº“åŠŸèƒ½
function startAutoRefresh() {
    // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œä¸å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    console.log('äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè‡ªåŠ¨åˆ·æ–°åŠŸèƒ½å·²åœç”¨');
}

// åœæ­¢è‡ªåŠ¨åˆ·æ–° - å·²ç¦ç”¨äº‘ç«¯æ•°æ®åº“åŠŸèƒ½
function stopAutoRefresh() {
    // äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ¸…é™¤ä»»ä½•ç°æœ‰å®šæ—¶å™¨
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
    console.log('äº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨ï¼Œè‡ªåŠ¨åˆ·æ–°åŠŸèƒ½å·²åœç”¨');
}

// åŸºäºæœ€æ–°å¼€å¥–æ—¶é—´çš„140ç§’å€’è®¡æ—¶åŠŸèƒ½
function startCountdownFromTime(timeStr) {
    try {
        // è§£ææ—¶é—´å­—ç¬¦ä¸² (æ ¼å¼: "2024-01-15 14:30:25")
        const lastDrawTime = new Date(timeStr);
        if (isNaN(lastDrawTime.getTime())) {
            console.error('æ— æ•ˆçš„æ—¶é—´æ ¼å¼:', timeStr);
            // å¦‚æœæ—¶é—´æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤140ç§’å€’è®¡æ—¶
            startCountdown(140);
            return;
        }
        
        // è®¡ç®—ä¸‹æ¬¡å¼€å¥–æ—¶é—´ (å½“å‰å¼€å¥–æ—¶é—´ + 140ç§’)
        const nextDrawTime = new Date(lastDrawTime.getTime() + 140 * 1000);
        const now = new Date();
        const timeDiff = nextDrawTime.getTime() - now.getTime();
        
        if (timeDiff <= 0) {
            // å¦‚æœè®¡ç®—å‡ºçš„æ—¶é—´å·²ç»è¿‡å»ï¼Œç«‹å³åˆ·æ–°æ•°æ®
            console.log('å¼€å¥–æ—¶é—´å·²è¿‡ï¼Œäº‘ç«¯æ•°æ®åº“åŠŸèƒ½å·²ç¦ç”¨');
            // autoRefreshLatestData(); // å·²ç¦ç”¨äº‘ç«¯æ•°æ®åº“åŠŸèƒ½
            return;
        }
        
        // è®¡ç®—å‰©ä½™ç§’æ•°å¹¶å¯åŠ¨å€’è®¡æ—¶
        const remainingSeconds = Math.floor(timeDiff / 1000);
        console.log(`æ ¹æ®å¼€å¥–æ—¶é—´ ${timeStr}ï¼Œ${remainingSeconds} ç§’åè‡ªåŠ¨åˆ·æ–°æ•°æ®`);
        startCountdown(remainingSeconds);
        
    } catch (error) {
        console.error('å€’è®¡æ—¶å¯åŠ¨å¤±è´¥:', error);
        // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤140ç§’å€’è®¡æ—¶
        startCountdown(140);
    }
}

// é»„é‡‘åˆ‡å‰²é¡µé¢äº‹ä»¶å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    // è¾“å…¥æ•°æ®è®¡æ•°
    const goldenInputData = document.getElementById('goldenInputData');
    const goldenInputCount = document.getElementById('goldenInputCount');
    
    if (goldenInputData && goldenInputCount) {
        goldenInputData.addEventListener('input', function() {
            const data = this.value.trim();
            if (!data) {
                goldenInputCount.classList.add('hidden');
                return;
            }
            
            // è§£æè¾“å…¥æ•°æ®
            const items = data.split(/[\n,;ï¼Œ]+/).map(s => s.trim()).filter(s => s);
            goldenInputCount.textContent = `å…± ${items.length} é¡¹`;
            goldenInputCount.classList.remove('hidden');
        });
    }
    
    // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
    const modeUniformBtn = document.getElementById('modeUniformBtn');
    const modeStableBtn = document.getElementById('modeStableBtn');
    const modeDescription = document.getElementById('modeDescription');
    
    let currentMode = 'uniform'; // é»˜è®¤å‡åŒ€æ¨¡å¼
    
    if (modeUniformBtn && modeStableBtn) {
        modeUniformBtn.addEventListener('click', function() {
            currentMode = 'uniform';
            modeUniformBtn.classList.add('active-mode');
            modeUniformBtn.classList.remove('inactive-mode');
            modeStableBtn.classList.add('inactive-mode');
            modeStableBtn.classList.remove('active-mode');
            modeDescription.textContent = 'å‡åŒ€æ¨¡å¼ï¼šä¸€æ¬¡æ€§åˆ†å®Œå°±ç”¨ï¼Œä¸ä¿æŒå†å²åˆ†ç»„';
        });
        
        modeStableBtn.addEventListener('click', function() {
            currentMode = 'stable';
            modeStableBtn.classList.add('active-mode');
            modeStableBtn.classList.remove('inactive-mode');
            modeUniformBtn.classList.add('inactive-mode');
            modeUniformBtn.classList.remove('active-mode');
            modeDescription.textContent = 'ç¨³å®šæ¨¡å¼ï¼šç»´æŠ¤é•¿æœŸåˆ†ç»„ï¼Œä¸æƒ³æ¯æ¬¡é‡æ–°åˆ‡å‰²';
        });
    }
    
    // åˆ†å‰²æŒ‰é’®
    const goldenSplitBtn = document.getElementById('goldenSplitBtn');
    if (goldenSplitBtn) {
        goldenSplitBtn.addEventListener('click', function() {
            const inputData = document.getElementById('goldenInputData').value.trim();
            
            if (!inputData) {
                alert('è¯·è¾“å…¥è¦åˆ†å‰²çš„æ•°æ®');
                return;
            }
            
            // è§£æè¾“å…¥æ•°æ®
            const items = parseInput(inputData);
            
            if (items.length === 0) {
                alert('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®');
                return;
            }
            
            // æ ¹æ®å½“å‰æ¨¡å¼æ‰§è¡Œé»„é‡‘åˆ‡å‰²
            const assignMode = currentMode === 'uniform' ? 'roundrobin' : 'hash';
            const groups = goldenSplit5in4(items, assignMode);
            
            // éªŒè¯ç»“æœ
            const isValid = validate5in4(groups, items);
            
            // é‡ç½®æ‰€æœ‰å¤åˆ¶æŒ‰é’®çŠ¶æ€ï¼ˆæ–°çš„åˆ‡å‰²å¼€å§‹ï¼‰
            resetAllCopyButtons();
            
            // æ¸²æŸ“ç»“æœ
            renderGoldenResults(groups, items, isValid);
            
            console.log('åˆ†å‰²å®Œæˆ:', groups, 'éªŒè¯ç»“æœ:', isValid);
        });
    }
    
    // ç²˜è´´æ•°æ®æŒ‰é’®
    const goldenPasteBtn = document.getElementById('goldenPasteBtn');
    if (goldenPasteBtn) {
        goldenPasteBtn.addEventListener('click', async function() {
            try {
                // æ£€æŸ¥å‰ªè´´æ¿APIæ˜¯å¦å¯ç”¨
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    const textarea = document.createElement('textarea');
                    document.body.appendChild(textarea);
                    textarea.focus();
                    document.execCommand('paste');
                    const text = textarea.value;
                    document.body.removeChild(textarea);
                    
                    if (text.trim()) {
                        document.getElementById('goldenInputData').value = text.trim();
                        // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ›´æ–°è®¡æ•°
                        const inputEvent = new Event('input', { bubbles: true });
                        document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                    }
                    return;
                }
                
                // å°è¯•ä»å‰ªè´´æ¿è¯»å–æ•°æ®
                const text = await navigator.clipboard.readText();
                if (text.trim()) {
                    document.getElementById('goldenInputData').value = text.trim();
                    
                    // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ›´æ–°è®¡æ•°
                    const inputEvent = new Event('input', { bubbles: true });
                    document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                } else {
                    alert('å‰ªè´´æ¿ä¸ºç©º');
                }
            } catch (err) {
                console.error('æ— æ³•è®¿é—®å‰ªè´´æ¿:', err);
                // æç¤ºç”¨æˆ·ä½¿ç”¨å¿«æ·é”®ç²˜è´´
                alert('è¯·ä½¿ç”¨ Ctrl+V (Windows) æˆ– Cmd+V (Mac) æ‰‹åŠ¨ç²˜è´´æ•°æ®åˆ°è¾“å…¥æ¡†');
            }
        });
    }
    
    // æ¸…ç©ºæŒ‰é’®
    const goldenClearBtn = document.getElementById('goldenClearBtn');
    if (goldenClearBtn) {
        goldenClearBtn.addEventListener('click', function() {
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('goldenInputData').value = '';
            document.getElementById('goldenInputCount').classList.add('hidden');
            
            // æ¸…ç©ºç»“æœ
            document.getElementById('goldenResults').innerHTML = '';
            document.getElementById('validationResults').classList.add('hidden');
            
            console.log('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®');
        });
    }
    
});

// é¡µé¢å®Œå…¨åŠ è½½åå¯åŠ¨å†å²æ•°æ®è·å–
window.addEventListener('load', function() {
    // å†å²æ•°æ®è·å–åŠŸèƒ½å·²ç¦ç”¨ - é˜²æ­¢é¡µé¢å¡æ­»
    console.log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆï¼Œå†å²æ•°æ®è·å–åŠŸèƒ½å·²ç¦ç”¨');
    // setTimeout(() => {
    //     console.log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆï¼Œå¯åŠ¨å†å²æ•°æ®è·å–åŠŸèƒ½...');
    //     startHistoryDataFetch();
    //     
    //     // åŒæ—¶ä¸ºéªŒè¯è®¡åˆ’é¡µé¢å¯åŠ¨æ•°æ®è·å–
    //     console.log('ä¸ºéªŒè¯è®¡åˆ’é¡µé¢å¯åŠ¨ç‹¬ç«‹çš„æ•°æ®è·å–æœºåˆ¶...');
    //     startVerifyPlanDataFetch();
    // }, 1000);
});

// éªŒè¯è®¡åˆ’æ•°æ®å­˜å‚¨ï¼ˆå…¨å±€å˜é‡ï¼‰
window.verifyPlanData = window.verifyPlanData || [];

// éªŒè¯çŠ¶æ€ç®¡ç†å™¨
window.VerificationStateManager = {
    isVerifying: false,
    lastVerificationTime: 0,
    verificationCooldown: 2000, // 2ç§’å†·å´æ—¶é—´
    
    canVerify: function() {
        const now = Date.now();
        return !this.isVerifying && (now - this.lastVerificationTime) > this.verificationCooldown;
    },
    
    startVerification: function() {
        this.isVerifying = true;
        console.log('ğŸ”„ å¼€å§‹éªŒè¯æµç¨‹');
    },
    
    endVerification: function() {
        this.isVerifying = false;
        this.lastVerificationTime = Date.now();
        console.log('âœ… éªŒè¯æµç¨‹ç»“æŸ');
    },
    
    reset: function() {
        this.isVerifying = false;
        this.lastVerificationTime = 0;
        console.log('ğŸ”„ é‡ç½®éªŒè¯çŠ¶æ€');
    }
};

// éªŒè¯è®¡åˆ’é¡µé¢åŠŸèƒ½
// è®¡ç®—ä¸‹ä¸€æœŸæœŸå·çš„å‡½æ•°ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function calculateNextPeriod(currentPeriod) {
    if (!currentPeriod) return null;
    
    const periodStr = currentPeriod.toString();
    
    // å°æ¹¾PK10æœŸå·æ ¼å¼ï¼š11ä½æ•°å­—ï¼Œå¦‚20250922178
    // å‰8ä½æ˜¯æ—¥æœŸç›¸å…³(YYYYMMDD)ï¼Œå3ä½æ˜¯å½“æ—¥æœŸæ•°
    // ä¸‹ä¸€æœŸæœŸå·å°±æ˜¯å½“å‰æœ€æ–°æœŸå·+1
    if (periodStr.length === 11) {
        const prefix = periodStr.substring(0, 8); // YYYYMMDD
        const suffix = periodStr.substring(8); // å3ä½æœŸæ•°
        const suffixNum = parseInt(suffix, 10);
        
        // ç›´æ¥è®¡ç®—ä¸‹ä¸€æœŸæœŸå·ï¼šå3ä½+1
        const nextSuffix = (suffixNum + 1).toString().padStart(3, '0');
        return prefix + nextSuffix;
    }
    
    // å…¼å®¹å…¶ä»–æ ¼å¼ï¼š9ä½æ•°å­—
    if (periodStr.length >= 9) {
        const prefix = periodStr.substring(0, periodStr.length - 3);
        const suffix = periodStr.substring(periodStr.length - 3);
        const suffixNum = parseInt(suffix, 10);
        const nextSuffix = (suffixNum + 1).toString().padStart(3, '0');
        return prefix + nextSuffix;
    }
    
    // ç®€å•æƒ…å†µï¼šç›´æ¥+1
    return (parseInt(periodStr, 10) + 1).toString();
}

// æ£€æŸ¥æŒ‡å®šæœŸå·æ˜¯å¦æœ‰å¼€å¥–æ•°æ®
function hasDrawnData(period) {
    const dataSource = window.r || window.historyData || [];
    return dataSource.some(item => item.period && item.period.toString() === period.toString());
}

// åˆå§‹åŒ–å•æœŸéªŒè¯å†å²è®°å½•å­˜å‚¨
if (!window.singlePeriodHistory) {
    window.singlePeriodHistory = [];
}

// åŠ è½½å•æœŸéªŒè¯å†å²è®°å½•
function loadSinglePeriodHistory() {
    try {
        const saved = localStorage.getItem('singlePeriodHistory');
        if (saved) {
            window.singlePeriodHistory = JSON.parse(saved);
            console.log('å•æœŸéªŒè¯ï¼šåŠ è½½å†å²è®°å½•:', window.singlePeriodHistory.length, 'æ¡');
        } else {
            window.singlePeriodHistory = [];
        }
    } catch (e) {
        console.warn('å•æœŸéªŒè¯ï¼šåŠ è½½å†å²è®°å½•å¤±è´¥:', e);
        window.singlePeriodHistory = [];
    }
}

// ä¿å­˜å•æœŸéªŒè¯è®°å½•
function saveSinglePeriodRecord(period, periodData, validPlans) {
    if (!window.singlePeriodHistory) {
        window.singlePeriodHistory = [];
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æœŸå·çš„è®°å½•
    const existingIndex = window.singlePeriodHistory.findIndex(record => record.period === period);
    
    if (existingIndex >= 0) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œä¸é‡å¤ä¿å­˜
        console.log('å•æœŸéªŒè¯ï¼šæœŸå·', period, 'å·²å­˜åœ¨éªŒè¯è®°å½•ï¼Œè·³è¿‡ä¿å­˜');
        return;
    }
    
    // åˆ›å»ºéªŒè¯è®°å½•
    const drawNumbers = periodData.data.slice(0, 5).map(n => parseInt(n));
    let hasWin = false;
    let winningPlans = [];
    
    // æ£€æŸ¥æ¯ä¸ªéªŒè¯è®¡åˆ’
    for (const plan of validPlans) {
        const planNums = Array.isArray(plan.planNumbers) ? plan.planNumbers : [];
        let planHasWin = false;
        
        for (const numberStr of planNums) {
            let numbers;
            if (Array.isArray(numberStr)) {
                numbers = numberStr.map(n => parseInt(n));
            } else if (typeof numberStr === 'string') {
                const parts = numberStr.split(/[\s,]+/).filter(Boolean);
                numbers = parts.map(n => parseInt(n));
            } else {
                continue;
            }
            
            // æ£€æŸ¥äº”æ˜Ÿå‘½ä¸­ï¼ˆäº”ä¸ªä½ç½®å®Œå…¨åŒ¹é…ï¼‰
            if (numbers.length === 5 && numbers.every((n, idx) => !isNaN(n) && drawNumbers[idx] !== undefined && n === drawNumbers[idx])) {
                planHasWin = true;
                hasWin = true;
                break;
            }
        }
        
        if (planHasWin) {
            winningPlans.push(plan);
        }
    }
    
    const record = {
        period: period,
        drawNumbers: drawNumbers,
        hasWin: hasWin,
        winningPlans: winningPlans,
        totalPlans: validPlans.length,
        totalBets: validPlans.reduce((sum, plan) => sum + (plan.betCount || 0), 0),
        timestamp: new Date().toISOString(),
        validPlans: validPlans.map(plan => ({
            displayName: plan.displayName,
            betCount: plan.betCount,
            planNumbers: plan.planNumbers
        }))
    };
    
    // æ·»åŠ æ–°è®°å½•
    window.singlePeriodHistory.push(record);
    console.log('å•æœŸéªŒè¯ï¼šä¿å­˜æ–°éªŒè¯è®°å½•:', period);
    
    // æŒ‰æœŸå·é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    window.singlePeriodHistory.sort((a, b) => {
        return parseInt(b.period) - parseInt(a.period);
    });
    
    // åªä¿ç•™æœ€è¿‘20æœŸè®°å½•
    if (window.singlePeriodHistory.length > 20) {
        window.singlePeriodHistory = window.singlePeriodHistory.slice(0, 20);
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem('singlePeriodHistory', JSON.stringify(window.singlePeriodHistory));
    } catch (e) {
        console.warn('å•æœŸéªŒè¯ï¼šä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
    }
}

// ä¿å­˜å•ä¸ªè®¡åˆ’çš„éªŒè¯è®°å½•
function saveSinglePeriodPlanRecord(period, periodData, plan) {
    if (!window.singlePeriodHistory) {
        window.singlePeriodHistory = [];
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æœŸå·å’Œè®¡åˆ’çš„è®°å½•
    const existingIndex = window.singlePeriodHistory.findIndex(record => 
        record.period === period && 
        record.validPlans.some(vp => vp.planHash === plan.planHash || vp.displayName === plan.displayName)
    );
    
    if (existingIndex >= 0) {
        console.log('å•æœŸéªŒè¯ï¼šæœŸå·', period, 'è®¡åˆ’', plan.displayName, 'å·²å­˜åœ¨éªŒè¯è®°å½•ï¼Œè·³è¿‡ä¿å­˜');
        return;
    }
    
    // åˆ›å»ºéªŒè¯è®°å½•
    const drawNumbers = periodData.data.slice(0, 5).map(n => parseInt(n));
    let planHasWin = false;
    
    // æ£€æŸ¥è¯¥è®¡åˆ’æ˜¯å¦å‘½ä¸­
    const planNums = Array.isArray(plan.planNumbers) ? plan.planNumbers : [];
    for (const numberStr of planNums) {
        let numbers;
        if (Array.isArray(numberStr)) {
            numbers = numberStr.map(n => parseInt(n));
        } else if (typeof numberStr === 'string') {
            const parts = numberStr.split(/[\s,]+/).filter(Boolean);
            numbers = parts.map(n => parseInt(n));
        } else {
            continue;
        }
        
        // æ£€æŸ¥äº”æ˜Ÿå‘½ä¸­ï¼ˆäº”ä¸ªä½ç½®å®Œå…¨åŒ¹é…ï¼‰
        if (numbers.length === 5 && numbers.every((n, idx) => !isNaN(n) && drawNumbers[idx] !== undefined && n === drawNumbers[idx])) {
            planHasWin = true;
            break;
        }
    }
    
    const record = {
        period: period,
        drawNumbers: drawNumbers,
        hasWin: planHasWin,
        winningPlans: planHasWin ? [plan] : [],
        totalPlans: 1,
        totalBets: plan.betCount || 0,
        timestamp: new Date().toISOString(),
        validPlans: [{
            displayName: plan.displayName,
            betCount: plan.betCount,
            planNumbers: plan.planNumbers,
            planHash: plan.planHash,
            generationConditions: plan.generationConditions
        }]
    };
    
    // æ·»åŠ æ–°è®°å½•
    window.singlePeriodHistory.push(record);
    console.log('å•æœŸéªŒè¯ï¼šä¿å­˜æ–°éªŒè¯è®°å½•:', period, plan.displayName);
    
    // æŒ‰æœŸå·é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    window.singlePeriodHistory.sort((a, b) => {
        return parseInt(b.period) - parseInt(a.period);
    });
    
    // åªä¿ç•™æœ€è¿‘50æœŸè®°å½•
    if (window.singlePeriodHistory.length > 50) {
        window.singlePeriodHistory = window.singlePeriodHistory.slice(0, 50);
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem('singlePeriodHistory', JSON.stringify(window.singlePeriodHistory));
    } catch (e) {
        console.warn('å•æœŸéªŒè¯ï¼šä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
    }
}

// æ˜¾ç¤ºå†å²éªŒè¯è®°å½•ï¼ˆä¸åŒæœŸå·çš„è®°å½•ï¼‰
function displayHistoricalRecords(tableBody, currentPeriod) {
    if (!window.singlePeriodHistory || window.singlePeriodHistory.length === 0) {
        return;
    }
    
    // è¿‡æ»¤æ‰å½“å‰éªŒè¯æœŸå·ï¼Œæ˜¾ç¤ºæœ€è¿‘10æœŸçš„å†å²è®°å½•
    const historyRecords = window.singlePeriodHistory
        .filter(record => record.period !== currentPeriod)
        .slice(0, 10);
    
    for (const record of historyRecords) {
        const row = document.createElement('tr');
        row.className = 'bg-gray-100';
        
        // æœŸå·åˆ—
        const periodCell = document.createElement('td');
        periodCell.className = 'border border-gray-300 px-3 py-2 text-left font-medium text-gray-600';
        periodCell.innerHTML = `${record.period} <span class="text-xs text-gray-500">(å†å²)</span>`;
        row.appendChild(periodCell);
        
        // å¼€å¥–å·ç åˆ—
        const numbersCell = document.createElement('td');
        numbersCell.className = 'border border-gray-300 px-3 py-2 text-left';
        numbersCell.innerHTML = `
            <div class="number-row font-mono text-gray-600">${record.drawNumbers.join(' ')}</div>
        `;
        row.appendChild(numbersCell);
        
        // æ³¨æ•°åˆ—
        const countCell = document.createElement('td');
        countCell.className = 'border border-gray-300 px-3 py-2 text-center text-gray-600';
        countCell.textContent = record.totalBets + 'æ³¨';
        row.appendChild(countCell);
        
        // çŠ¶æ€åˆ—
        const statusCell = document.createElement('td');
        statusCell.className = 'border border-gray-300 px-3 py-2 text-center';
        
        if (record.hasWin) {
            statusCell.innerHTML = `<span class="text-green-600 font-bold">ä¸­</span>`;
        } else {
            statusCell.innerHTML = `<span class="text-red-600 font-bold">æŒ‚</span>`;
        }
        row.appendChild(statusCell);
        
        // è®¡åˆ’è§„åˆ™åˆ—
        const planCell = document.createElement('td');
        planCell.className = 'border border-gray-300 px-3 py-2 text-left text-gray-600';
        
        // æ˜¾ç¤ºè¯¥è®°å½•çš„è®¡åˆ’ä¿¡æ¯
        const plan = record.validPlans[0]; // æ¯ä¸ªè®°å½•åªåŒ…å«ä¸€ä¸ªè®¡åˆ’
        if (plan) {
            const conditions = plan.generationConditions || {};
            const groups = Array.isArray(conditions.groups) ? conditions.groups : [];
            let ruleText = '';
            
            if (groups.length > 0) {
                // æ”¶é›†æ‰€æœ‰é€‰æ‹©çš„æ•°å­—å’Œèƒ†ç 
                const allSelectedNumbers = [];
                const allSelectedDamas = [];
                
                groups.forEach(g => {
                    const numbers = Array.isArray(g.selectedNumbers) ? g.selectedNumbers : [];
                    const damas = Array.isArray(g.selectedDamas) ? g.selectedDamas : [];
                    
                    // æ”¶é›†æ‰€æœ‰é€‰æ‹©çš„æ•°å­—ï¼ˆå»é‡ï¼‰
                    numbers.forEach(num => {
                        if (!allSelectedNumbers.includes(num)) {
                            allSelectedNumbers.push(num);
                        }
                    });
                    
                    // æ”¶é›†æ‰€æœ‰èƒ†ç ï¼ˆå»é‡ï¼‰
                    damas.forEach(dama => {
                        if (!allSelectedDamas.includes(dama)) {
                            allSelectedDamas.push(dama);
                        }
                    });
                });
                
                // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
                const parts = [];
                
                // æ˜¾ç¤ºé€‰æ‹©çš„æ•°å­—
                if (allSelectedNumbers.length > 0) {
                    allSelectedNumbers.sort((a, b) => parseInt(a) - parseInt(b));
                    parts.push(allSelectedNumbers.join(','));
                }
                
                // æ˜¾ç¤ºèƒ†ç 
                if (allSelectedDamas.length > 0) {
                    allSelectedDamas.sort((a, b) => parseInt(a) - parseInt(b));
                    parts.push(`ä¸­${allSelectedDamas.join(',')}èƒ†`);
                }
                
                // æ·»åŠ æ€»å®¹é”™ä¿¡æ¯
                const moduleToleranceMin = conditions.moduleToleranceMin || 0;
                const moduleToleranceMax = conditions.moduleToleranceMax || 0;
                if (moduleToleranceMin !== 0 || moduleToleranceMax !== 0) {
                    if (moduleToleranceMin === moduleToleranceMax) {
                        parts.push(`æ€»å®¹é”™${moduleToleranceMin}`);
                    } else {
                        parts.push(`æ€»å®¹é”™${moduleToleranceMin}-${moduleToleranceMax}`);
                    }
                }
                
                ruleText = parts.join(' ');
            } else {
                // æ²¡æœ‰ç»„ä¿¡æ¯æ—¶ï¼Œå°è¯•ä»å…¶ä»–å­—æ®µè·å–ä¿¡æ¯
                const selectedNumbers = Array.isArray(conditions.selectedNumbers) ? conditions.selectedNumbers : [];
                if (selectedNumbers.length > 0) {
                    ruleText = `é€‰å·:${selectedNumbers.join(',')}`;
                }
            }
            
            // å¦‚æœæ²¡æœ‰è§„åˆ™ä¿¡æ¯ï¼Œæ˜¾ç¤ºè®¡åˆ’åç§°å’Œæ³¨æ•°
            if (!ruleText || ruleText.trim() === '') {
                ruleText = `${plan.displayName || 'è®¡åˆ’'} (${plan.betCount}æ³¨)`;
            }
            
            planCell.innerHTML = `<div class="text-sm">${ruleText}</div>`;
        } else {
            planCell.innerHTML = `<div class="text-sm text-gray-400">æ— è®¡åˆ’ä¿¡æ¯</div>`;
        }
        
        row.appendChild(planCell);
        
        // æ“ä½œåˆ— - æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆå†å²è®°å½•ï¼‰
        const actionCell = document.createElement('td');
        actionCell.className = 'border border-gray-300 px-3 py-2 text-center';
        
        // åˆ›å»ºåˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.title = 'åˆ é™¤æ­¤å†å²è®°å½•';
        
        // ç»‘å®šåˆ é™¤äº‹ä»¶ï¼Œä¼ é€’è®°å½•çš„æœŸå·
        deleteBtn.onclick = function() {
            deleteHistoricalRecord(record.period);
        };
        
        actionCell.appendChild(deleteBtn);
        row.appendChild(actionCell);
        
        tableBody.appendChild(row);
    }
}

// æ—§çš„displayAllSinglePeriodRecordså‡½æ•°å·²ç§»é™¤ï¼Œä½¿ç”¨æ–°çš„å¤šæœŸéªŒè¯é€»è¾‘

// å•æœŸéªŒè¯è¡¨æ ¼æ›´æ–°å‡½æ•°ï¼ˆæŒ‰è®¡åˆ’ç‹¬ç«‹ç›®æ ‡æœŸï¼‰
// å•æœŸéªŒè¯è½®è¯¢å®šæ—¶å™¨
window.singlePeriodPollingTimer = null;
window.singlePeriodTargetPeriod = null;

function updateSinglePeriodTable(pageSize = 20, currentPage = 1) {
    // æ£€æŸ¥éªŒè¯çŠ¶æ€ç®¡ç†å™¨
    if (!window.VerificationStateManager.canVerify()) {
        console.log('â¸ï¸ éªŒè¯æ­£åœ¨è¿›è¡Œä¸­æˆ–åœ¨å†·å´æœŸï¼Œè·³è¿‡æœ¬æ¬¡éªŒè¯');
        return;
    }
    
    // å¼€å§‹éªŒè¯æµç¨‹
    window.VerificationStateManager.startVerification();
    
    const singlePeriodTableBody = document.getElementById('singlePeriodTableBody');
    if (!singlePeriodTableBody) {
        window.VerificationStateManager.endVerification();
        return;
    }

    // è·å–éªŒè¯è®¡åˆ’
    const verifyPlans = window.verifyPlanData || [];
    const validPlans = verifyPlans.filter(plan => plan.betCount && plan.betCount > 0);

    // æ¸…ç©ºè¡¨æ ¼
    singlePeriodTableBody.innerHTML = '';

    // å¦‚æœæ²¡æœ‰éªŒè¯è®¡åˆ’ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
    if (validPlans.length === 0) {
        singlePeriodTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="py-4 text-center text-gray-500">
                    æš‚æ— éªŒè¯è®¡åˆ’ï¼Œè¯·å…ˆåœ¨åšå·æ‹¼æ¥é¡µé¢ç”ŸæˆéªŒè¯è®¡åˆ’
                </td>
            </tr>
        `;
        window.VerificationStateManager.endVerification();
        return;
    }

    // æ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœè®¡åˆ’æ•°é‡å¾ˆå¤šï¼Œå®ç°åˆ†é¡µæ˜¾ç¤º
    const totalPlans = validPlans.length;
    if (totalPlans > pageSize) {
        console.log(`ğŸ“Š æ£€æµ‹åˆ°å¤§é‡éªŒè¯è®¡åˆ’(${totalPlans}æ¡)ï¼Œå¯ç”¨åˆ†é¡µæ˜¾ç¤ºä¼˜åŒ–`);
        
        // åˆå§‹åŒ–åˆ†é¡µçŠ¶æ€
        if (!window.singlePeriodPagination) {
            window.singlePeriodPagination = {
                currentPage: 1,
                pageSize: pageSize,
                totalPages: Math.ceil(totalPlans / pageSize)
            };
        }
        
        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        window.singlePeriodPagination.totalPages = Math.ceil(totalPlans / pageSize);
        window.singlePeriodPagination.currentPage = Math.min(currentPage, window.singlePeriodPagination.totalPages);
        
        // è®¡ç®—å½“å‰é¡µçš„æ•°æ®èŒƒå›´
        const startIndex = (window.singlePeriodPagination.currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalPlans);
        const currentPagePlans = validPlans.slice(startIndex, endIndex);
        
        console.log(`ğŸ“„ æ˜¾ç¤ºç¬¬ ${window.singlePeriodPagination.currentPage}/${window.singlePeriodPagination.totalPages} é¡µï¼Œå…± ${currentPagePlans.length} æ¡è®°å½•`);
        
        // æ˜¾ç¤ºåˆ†é¡µä¿¡æ¯
        this.showPaginationInfo(singlePeriodTableBody, window.singlePeriodPagination, totalPlans);
        
        // å¤„ç†å½“å‰é¡µçš„è®¡åˆ’
        this.processPlansPage(currentPagePlans, singlePeriodTableBody);
        
        // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
        this.showPaginationControls(singlePeriodTableBody, window.singlePeriodPagination);
        
        window.VerificationStateManager.endVerification();
        return;
    }

    // æ£€æŸ¥æ•°æ®æº
    let dataSource = null;
    if (window.r && window.r.length > 0) {
        dataSource = window.r;
    } else if (window.historyData && window.historyData.length > 0) {
        dataSource = window.historyData;
    }

    if (!dataSource || dataSource.length === 0) {
        singlePeriodTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="py-4 text-center text-gray-500">
                    æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®
                </td>
            </tr>
        `;
        window.VerificationStateManager.endVerification();
        return;
    }

    console.log('updateSinglePeriodTable: å¼€å§‹ä½¿ç”¨å¤šæœŸéªŒè¯é€»è¾‘ï¼Œæ¯ä¸ªè®¡åˆ’æ˜¾ç¤ºæœ€è¿‘ä¸€æœŸå·²å¼€å¥–å’Œä¸‹ä¸€æœŸæœªå¼€å¥–');
    
    // æŒ‰æœŸå·æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
    dataSource = dataSource.sort((a, b) => parseInt(b.period) - parseInt(a.period));
    
    // è·å–æœ€æ–°æœŸå·ï¼Œç”¨äºç¼“å­˜éªŒè¯
    const latestPeriod = dataSource.length > 0 ? dataSource[0].period : null;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éªŒè¯ï¼ˆæ•°æ®æºæ›´æ–°æ—¶ï¼‰
    const needsRevalidation = !window.lastValidatedPeriod || window.lastValidatedPeriod !== latestPeriod;
    if (needsRevalidation) {
        console.log('æ£€æµ‹åˆ°æ•°æ®æºæ›´æ–°ï¼ŒæœŸå·ä»', window.lastValidatedPeriod, 'æ›´æ–°åˆ°', latestPeriod);
        window.lastValidatedPeriod = latestPeriod;
    }
    
    // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–DOMæ“ä½œ
    const fragment = document.createDocumentFragment();
    
    // å¯¹æ¯ä¸ªè®¡åˆ’è¿›è¡ŒéªŒè¯ï¼Œæ¯ä¸ªè®¡åˆ’éªŒè¯2æœŸååœæ­¢
    validPlans.forEach(plan => {
        if (!plan.planNumbers || plan.planNumbers.length === 0) return;
        
        // å¦‚æœè®¡åˆ’å·²å®Œæˆå¤šæœŸéªŒè¯ï¼Œè·³è¿‡å•æœŸéªŒè¯é€»è¾‘
        if (plan.isCompleted) {
            console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'å·²å®Œæˆå¤šæœŸéªŒè¯ï¼Œè·³è¿‡å•æœŸéªŒè¯');
            // æ˜¾ç¤ºå·²å®ŒæˆçŠ¶æ€çš„è¡Œ
            const row = createSinglePeriodRowPending(null, plan, { period: plan.period || 'å·²éªŒè¯' });
            if (row) fragment.appendChild(row);
            return;
        }
        
        // åˆå§‹åŒ–éªŒè¯çŠ¶æ€
        if (!plan.singlePeriodVerificationResults) {
            plan.singlePeriodVerificationResults = [];
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„éªŒè¯ç»“æœä¸”æ•°æ®æºæœªæ›´æ–°
        if (!needsRevalidation && plan.singlePeriodVerificationResults.length > 0) {
            console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'ä½¿ç”¨ç¼“å­˜çš„éªŒè¯ç»“æœï¼Œè·³è¿‡é‡å¤éªŒè¯');
            
            // ä½¿ç”¨ç¼“å­˜ç»“æœæ˜¾ç¤º
            if (plan.singlePeriodVerificationResults.length >= 2) {
                // æ˜¾ç¤ºç¬¬äºŒæœŸéªŒè¯ç»“æœ
                const secondResult = plan.singlePeriodVerificationResults[1];
                if (secondResult) {
                    let row;
                    if (secondResult.hasDrawn) {
                        row = createSinglePeriodRow(null, plan, secondResult.periodData, secondResult.periodWin, secondResult.winningNumber, secondResult.drawNumbers);
                    } else {
                        row = createSinglePeriodRowPending(null, plan, secondResult.periodData);
                    }
                    if (row) fragment.appendChild(row);
                }
            } else if (plan.singlePeriodVerificationResults.length === 1) {
                // åªæœ‰ç¬¬ä¸€æœŸç»“æœï¼Œæ˜¾ç¤ºä¸‹ä¸€æœŸå¾…éªŒè¯
                const firstResult = plan.singlePeriodVerificationResults[0];
                const nextPeriodNumber = calculateNextPeriod(firstResult.periodData.period);
                const row = createSinglePeriodRowPending(null, plan, { period: nextPeriodNumber });
                if (row) fragment.appendChild(row);
            }
            return;
        }
        
        // å¦‚æœå·²ç»éªŒè¯äº†2æœŸï¼Œåªæ˜¾ç¤ºç¬¬äºŒæœŸç»“æœï¼Œä¸å†æ›´æ–°
        if (plan.singlePeriodVerificationResults.length >= 2) {
            console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'å·²å®Œæˆ2æœŸéªŒè¯ï¼Œåªæ˜¾ç¤ºç¬¬äºŒæœŸç»“æœ');
            
            // åªæ˜¾ç¤ºç¬¬äºŒæœŸéªŒè¯ç»“æœï¼ˆç¬¬ä¸€æœŸåœ¨åå°è¿è¡Œä¸æ˜¾ç¤ºï¼‰
            const secondResult = plan.singlePeriodVerificationResults[1];
            if (secondResult) {
                let row;
                if (secondResult.hasDrawn) {
                    // ç¬¬äºŒæœŸå·²å¼€å¥–
                    row = createSinglePeriodRow(null, plan, secondResult.periodData, secondResult.periodWin, secondResult.winningNumber, secondResult.drawNumbers);
                } else {
                    // ç¬¬äºŒæœŸæœªå¼€å¥–
                    row = createSinglePeriodRowPending(null, plan, secondResult.periodData);
                }
                if (row) fragment.appendChild(row);
            }
            return;
        }
        
        // æ‰¾åˆ°æœ€è¿‘ä¸€æœŸå·²å¼€å¥–çš„æ•°æ®
        const latestDrawnPeriod = dataSource.find(periodData => 
            periodData && periodData.data && periodData.data.length >= 5
        );
        
        if (latestDrawnPeriod) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»éªŒè¯è¿‡è¿™ä¸€æœŸ
            const alreadyVerified = plan.singlePeriodVerificationResults.find(r => r.periodData.period === latestDrawnPeriod.period);
            
            if (!alreadyVerified) {
                // éªŒè¯æœ€è¿‘ä¸€æœŸå·²å¼€å¥–çš„æ•°æ®
                const drawNumbers = latestDrawnPeriod.data;
                let periodWin = false;
                let winningNumber = null;
                
                // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
                for (const numberStr of plan.planNumbers) {
                    const numbers = numberStr.split(' ').map(n => parseInt(n.trim()));
                    
                    // æ ¹æ®è®¡åˆ’çš„æ˜Ÿçº§ç¡®å®šéœ€è¦åŒ¹é…çš„ä½æ•°
                    const conditions = plan.generationConditions || {};
                    const moduleType = conditions.moduleType || '5æ˜Ÿåšå·';
                    const starLevel = parseInt(moduleType.match(/(\d+)æ˜Ÿ/)?.[1]) || 5;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å·ç 
                    if (numbers.length === starLevel && numbers.every(n => !isNaN(n))) {
                        // ä¸¥æ ¼åˆ¤å®šï¼šå‰å‡ ä½é¡ºåºå®Œå…¨ä¸€è‡´æ‰ç®—ä¸­
                        const frontNumbers = drawNumbers.slice(0, starLevel);
                        const exactMatch = numbers.every((num, idx) => num === frontNumbers[idx]);
                        
                        if (exactMatch) {
                            periodWin = true;
                            winningNumber = numberStr;
                            break;
                        }
                    }
                }
                
                // ä¿å­˜éªŒè¯ç»“æœ
                plan.singlePeriodVerificationResults.push({
                    periodData: latestDrawnPeriod,
                    hasDrawn: true,
                    periodWin: periodWin,
                    winningNumber: winningNumber,
                    drawNumbers: drawNumbers
                });
                
                console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'éªŒè¯ç¬¬', plan.singlePeriodVerificationResults.length, 'æœŸ:', latestDrawnPeriod.period, 'ç»“æœ:', periodWin ? 'ä¸­' : 'æŒ‚');
            }
            
            // ç¬¬ä¸€æœŸéªŒè¯åœ¨åå°è¿è¡Œï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
            console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'ç¬¬ä¸€æœŸéªŒè¯åœ¨åå°å®Œæˆï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢');
        }
        
        // å¦‚æœè¿˜æ²¡éªŒè¯æ»¡2æœŸï¼Œæ˜¾ç¤ºä¸‹ä¸€æœŸæœªå¼€å¥–
        if (plan.singlePeriodVerificationResults.length < 2) {
            // æ‰¾åˆ°ä¸‹ä¸€æœŸæœªå¼€å¥–çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸‹ä¸€æœŸ
            let nextPeriod = dataSource.find(periodData => 
                periodData && (!periodData.data || periodData.data.length < 5)
            );
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœªå¼€å¥–æœŸï¼Œåˆ›å»ºä¸‹ä¸€æœŸ
            if (!nextPeriod && latestDrawnPeriod) {
                const nextPeriodNumber = calculateNextPeriod(latestDrawnPeriod.period);
                nextPeriod = {
                    period: nextPeriodNumber,
                    data: null // æœªå¼€å¥–
                };
            }
            
            if (nextPeriod) {
                // æ£€æŸ¥ä¸‹ä¸€æœŸæ˜¯å¦å·²å¼€å¥–
                const nextPeriodDrawn = nextPeriod.data && nextPeriod.data.length >= 5;
                
                if (nextPeriodDrawn) {
                    // ä¸‹ä¸€æœŸå·²å¼€å¥–ï¼Œè¿›è¡ŒéªŒè¯å¹¶ä¿å­˜ç»“æœ
                    const drawNumbers = nextPeriod.data;
                    let periodWin = false;
                    let winningNumber = null;
                    
                    // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
                    for (const numberStr of plan.planNumbers) {
                        const numbers = numberStr.split(' ').map(n => parseInt(n.trim()));
                        
                        // æ ¹æ®è®¡åˆ’çš„æ˜Ÿçº§ç¡®å®šéœ€è¦åŒ¹é…çš„ä½æ•°
                        const conditions = plan.generationConditions || {};
                        const moduleType = conditions.moduleType || '5æ˜Ÿåšå·';
                        const starLevel = parseInt(moduleType.match(/(\d+)æ˜Ÿ/)?.[1]) || 5;
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å·ç 
                        if (numbers.length === starLevel && numbers.every(n => !isNaN(n))) {
                            // ä¸¥æ ¼åˆ¤å®šï¼šå‰å‡ ä½é¡ºåºå®Œå…¨ä¸€è‡´æ‰ç®—ä¸­
                            const frontNumbers = drawNumbers.slice(0, starLevel);
                            const exactMatch = numbers.every((num, idx) => num === frontNumbers[idx]);
                            
                            if (exactMatch) {
                                periodWin = true;
                                winningNumber = numberStr;
                                break;
                            }
                        }
                    }
                    
                    // ä¿å­˜ç¬¬äºŒæœŸéªŒè¯ç»“æœ
                    plan.singlePeriodVerificationResults.push({
                        periodData: nextPeriod,
                        hasDrawn: true,
                        periodWin: periodWin,
                        winningNumber: winningNumber,
                        drawNumbers: drawNumbers
                    });
                    
                    console.log('è®¡åˆ’', plan.displayName || plan.planHash, 'éªŒè¯ç¬¬2æœŸ:', nextPeriod.period, 'ç»“æœ:', periodWin ? 'ä¸­' : 'æŒ‚', 'éªŒè¯å®Œæˆ');
                    
                    // æ˜¾ç¤ºç¬¬äºŒæœŸå·²å¼€å¥–çš„éªŒè¯ç»“æœ
                    const row = createSinglePeriodRow(null, plan, nextPeriod, periodWin, winningNumber, drawNumbers);
                    if (row) fragment.appendChild(row);
                } else {
                    // ç¬¬äºŒæœŸæœªå¼€å¥–ï¼Œæ˜¾ç¤ºå¾…éªŒè¯çŠ¶æ€
                    const row = createSinglePeriodRowPending(null, plan, nextPeriod);
                    if (row) fragment.appendChild(row);
                }
            }
        }
    });

    // ä¸€æ¬¡æ€§å°†æ‰€æœ‰è¡Œæ·»åŠ åˆ°è¡¨æ ¼ä¸­ï¼Œä¼˜åŒ–DOMæ€§èƒ½
    if (fragment.children.length > 0) {
        singlePeriodTableBody.appendChild(fragment);
    }

    // æ›´æ–°å•æœŸéªŒè¯æ§åˆ¶ä¿¡æ¯
    updateSinglePeriodControls();
    
    // ä¿å­˜éªŒè¯ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
    if (typeof window.PlanStorageManager !== 'undefined' && window.PlanStorageManager.saveToLocalStorage) {
        window.PlanStorageManager.saveToLocalStorage();
        console.log('ğŸ’¾ å•æœŸéªŒè¯ç»“æœå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
    }
    
    console.log('updateSinglePeriodTable: è¡¨æ ¼æ›´æ–°å®Œæˆï¼Œä½¿ç”¨å¤šæœŸéªŒè¯é€»è¾‘ä¸€æœŸä¸€æ’æ˜¾ç¤º');
    
    // ç»“æŸéªŒè¯æµç¨‹
    window.VerificationStateManager.endVerification();
}

// ä¸ºæ¯ä¸€æœŸåˆ›å»ºä¸€è¡Œè®°å½•
function createSinglePeriodRow(tableBody, plan, periodData, periodWin, winningNumber, drawNumbers) {
    const row = document.createElement('tr');
    
    // æ ¹æ®éªŒè¯ç»“æœè®¾ç½®æ ·å¼
    if (periodWin) {
        row.className = 'bg-green-50 border-l-4 border-green-500';
    } else {
        row.className = 'bg-red-50 border-l-4 border-red-500';
    }
    
    // æœŸå·åˆ—
    const periodCell = document.createElement('td');
    periodCell.className = 'border border-gray-300 px-2 py-2 text-center font-medium';
    periodCell.style.width = '130px';
    periodCell.textContent = periodData.period;
    row.appendChild(periodCell);
    
    // å¼€å¥–å·ç åˆ—
    const numbersCell = document.createElement('td');
    numbersCell.className = 'border border-gray-300 px-3 py-2 text-center';
    numbersCell.style.width = '260px';
    numbersCell.innerHTML = `
        <div class="font-mono text-sm">${drawNumbers.join(' ')}</div>
    `;
    row.appendChild(numbersCell);
    
    // æ³¨æ•°åˆ—
    const countCell = document.createElement('td');
    countCell.className = 'border border-gray-300 px-3 py-2 text-center';
    countCell.style.width = '104px';
    countCell.textContent = plan.betCount + 'æ³¨';
    row.appendChild(countCell);
    
    // çŠ¶æ€åˆ—
    const statusCell = document.createElement('td');
    statusCell.className = 'border border-gray-300 px-3 py-2 text-center';
    statusCell.style.width = '80px';
    if (periodWin) {
        statusCell.innerHTML = `<span class="text-green-600 font-bold">ä¸­</span>`;
    } else {
        statusCell.innerHTML = `<span class="text-red-600 font-bold">æŒ‚</span>`;
    }
    row.appendChild(statusCell);
    
    // è®¡åˆ’è§„åˆ™åˆ—
    const planCell = document.createElement('td');
    planCell.className = 'border border-gray-300 px-3 py-2 text-left';
    const conditions = plan.generationConditions || {};
    const groups = Array.isArray(conditions.groups) ? conditions.groups : [];
    let ruleText = '';
    
    if (groups.length > 0) {
        const conditionTexts = [];
        
        // ä¸ºæ¯ä¸ªæ¡ä»¶ç»„ç”Ÿæˆå•ç‹¬çš„æ–‡æœ¬
        groups.forEach((g, index) => {
            const numbers = Array.isArray(g.selectedNumbers) ? g.selectedNumbers : [];
            const damas = Array.isArray(g.selectedDamas) ? g.selectedDamas : [];
            
            if (numbers.length > 0 || damas.length > 0) {
                const sortedNumbers = [...numbers].sort((a, b) => parseInt(a) - parseInt(b));
                const sortedDamas = [...damas].sort((a, b) => parseInt(a) - parseInt(b));
                
                let conditionText = `${sortedNumbers.join(',')}`;
                if (sortedDamas.length > 0) {
                    conditionText += ` ä¸­${sortedDamas.join(',')}èƒ†`;
                }
                
                // æ·»åŠ æ¡ä»¶å®¹é”™
                const toleranceMin = typeof g.toleranceMin === 'number' ? g.toleranceMin : 0;
                const toleranceMax = typeof g.toleranceMax === 'number' ? g.toleranceMax : 0;
                if (toleranceMin !== 0 || toleranceMax !== 0) {
                    if (toleranceMin === toleranceMax) {
                        conditionText += ` (å®¹é”™${toleranceMin})`;
                    } else {
                        conditionText += ` (å®¹é”™${toleranceMin}-${toleranceMax})`;
                    }
                }
                
                conditionTexts.push(conditionText);
            }
        });
        
        ruleText = conditionTexts.join(' ');
        
        // æ·»åŠ æ€»å®¹é”™ä¿¡æ¯
        const moduleToleranceMin = typeof conditions.moduleToleranceMin === 'number' ? conditions.moduleToleranceMin : 0;
        const moduleToleranceMax = typeof conditions.moduleToleranceMax === 'number' ? conditions.moduleToleranceMax : 0;
        if (moduleToleranceMin !== 0 || moduleToleranceMax !== 0) {
            if (moduleToleranceMin === moduleToleranceMax) {
                ruleText += ` <strong>æ€»å®¹é”™: ${moduleToleranceMin}</strong>`;
            } else {
                ruleText += ` <strong>æ€»å®¹é”™: ${moduleToleranceMin}-${moduleToleranceMax}</strong>`;
            }
        }
    } else {
        ruleText = plan.displayName || plan.planHash || 'æœªçŸ¥è®¡åˆ’';
    }
    
    planCell.innerHTML = ruleText;
    row.appendChild(planCell);
    
    // æ“ä½œåˆ—ï¼ˆåˆ é™¤ï¼‰
    const actionCell = document.createElement('td');
    actionCell.className = 'border border-gray-300 px-3 py-2 text-center';
    actionCell.style.width = '104px';
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs';
    deleteBtn.textContent = 'åˆ é™¤';
    deleteBtn.title = 'åˆ é™¤æ­¤éªŒè¯è®¡åˆ’';
    deleteBtn.onclick = function() { deleteSinglePlan(plan.planHash, periodData.period); };
    actionCell.appendChild(deleteBtn);
    row.appendChild(actionCell);
    
    // å¦‚æœæä¾›äº†tableBodyï¼Œç›´æ¥æ·»åŠ ï¼›å¦åˆ™è¿”å›è¡Œå…ƒç´ 
    if (tableBody) {
        tableBody.appendChild(row);
    } else {
        return row;
    }
}

// ä¸ºæœªå¼€å¥–æœŸåˆ›å»ºå¾…éªŒè¯è®°å½•
function createSinglePeriodRowPending(tableBody, plan, periodData) {
    const row = document.createElement('tr');
    
    // è®¾ç½®å¾…éªŒè¯æ ·å¼
    row.className = 'bg-blue-50 border-l-4 border-blue-500';
    
    // æœŸå·åˆ—
    const periodCell = document.createElement('td');
    periodCell.className = 'border border-gray-300 px-2 py-2 text-center font-medium';
    periodCell.style.width = '130px';
    periodCell.textContent = periodData.period;
    row.appendChild(periodCell);
    
    // å¼€å¥–å·ç åˆ—
    const numbersCell = document.createElement('td');
    numbersCell.className = 'border border-gray-300 px-3 py-2 text-center';
    numbersCell.style.width = '260px';
    numbersCell.innerHTML = `
        <div class="text-gray-400">æœªå¼€å¥–</div>
    `;
    row.appendChild(numbersCell);
    
    // æ³¨æ•°åˆ—
    const countCell = document.createElement('td');
    countCell.className = 'border border-gray-300 px-3 py-2 text-center';
    countCell.style.width = '104px';
    countCell.textContent = plan.betCount + 'æ³¨';
    row.appendChild(countCell);
    
    // çŠ¶æ€åˆ—
    const statusCell = document.createElement('td');
    statusCell.className = 'border border-gray-300 px-3 py-2 text-center';
    statusCell.style.width = '80px';
    
    // æ ¹æ®isCompletedå­—æ®µæ˜¾ç¤ºæ­£ç¡®çš„çŠ¶æ€
    if (plan.isCompleted) {
        // å·²å®ŒæˆéªŒè¯ï¼Œæ˜¾ç¤ºéªŒè¯ç»“æœ
        const result = plan.result || 'å·²éªŒè¯';
        if (result.includes('ä¸­')) {
            statusCell.innerHTML = `<span class="text-green-600 font-bold">${result}</span>`;
        } else if (result.includes('æŒ‚')) {
            statusCell.innerHTML = `<span class="text-red-600 font-bold">${result}</span>`;
        } else {
            statusCell.innerHTML = `<span class="text-gray-600 font-bold">${result}</span>`;
        }
    } else {
        // æœªå®ŒæˆéªŒè¯ï¼Œæ˜¾ç¤ºå¾…éªŒè¯çŠ¶æ€
        statusCell.innerHTML = `<span class="text-blue-600 font-bold">å¾…éªŒè¯</span>`;
    }
    row.appendChild(statusCell);
    
    // è®¡åˆ’è§„åˆ™åˆ—
    const planCell = document.createElement('td');
    planCell.className = 'border border-gray-300 px-3 py-2 text-left';
    const conditions = plan.generationConditions || {};
    const groups = Array.isArray(conditions.groups) ? conditions.groups : [];
    let ruleText = '';
    
    if (groups.length > 0) {
        const conditionTexts = [];
        
        // ä¸ºæ¯ä¸ªæ¡ä»¶ç»„ç”Ÿæˆå•ç‹¬çš„æ–‡æœ¬
        groups.forEach((g, index) => {
            const numbers = Array.isArray(g.selectedNumbers) ? g.selectedNumbers : [];
            const damas = Array.isArray(g.selectedDamas) ? g.selectedDamas : [];
            
            if (numbers.length > 0 || damas.length > 0) {
                const sortedNumbers = [...numbers].sort((a, b) => parseInt(a) - parseInt(b));
                const sortedDamas = [...damas].sort((a, b) => parseInt(a) - parseInt(b));
                
                let conditionText = `${sortedNumbers.join(',')}`;
                if (sortedDamas.length > 0) {
                    conditionText += ` ä¸­${sortedDamas.join(',')}èƒ†`;
                }
                
                // æ·»åŠ æ¡ä»¶å®¹é”™
                const toleranceMin = typeof g.toleranceMin === 'number' ? g.toleranceMin : 0;
                const toleranceMax = typeof g.toleranceMax === 'number' ? g.toleranceMax : 0;
                if (toleranceMin !== 0 || toleranceMax !== 0) {
                    if (toleranceMin === toleranceMax) {
                        conditionText += ` (å®¹é”™${toleranceMin})`;
                    } else {
                        conditionText += ` (å®¹é”™${toleranceMin}-${toleranceMax})`;
                    }
                }
                
                conditionTexts.push(conditionText);
            }
        });
        
        ruleText = conditionTexts.join(' ');
        
        // æ·»åŠ æ€»å®¹é”™ä¿¡æ¯
        const moduleToleranceMin = typeof conditions.moduleToleranceMin === 'number' ? conditions.moduleToleranceMin : 0;
        const moduleToleranceMax = typeof conditions.moduleToleranceMax === 'number' ? conditions.moduleToleranceMax : 0;
        if (moduleToleranceMin !== 0 || moduleToleranceMax !== 0) {
            if (moduleToleranceMin === moduleToleranceMax) {
                ruleText += ` <strong>æ€»å®¹é”™: ${moduleToleranceMin}</strong>`;
            } else {
                ruleText += ` <strong>æ€»å®¹é”™: ${moduleToleranceMin}-${moduleToleranceMax}</strong>`;
            }
        }
    } else {
        ruleText = plan.displayName || plan.planHash || 'æœªçŸ¥è®¡åˆ’';
    }
    
    planCell.innerHTML = ruleText;
    row.appendChild(planCell);
    
    // æ“ä½œåˆ—ï¼ˆåˆ é™¤ï¼‰
    const actionCell = document.createElement('td');
    actionCell.className = 'border border-gray-300 px-3 py-2 text-center';
    actionCell.style.width = '104px';
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs';
    deleteBtn.textContent = 'åˆ é™¤';
    deleteBtn.title = 'åˆ é™¤æ­¤éªŒè¯è®¡åˆ’';
    deleteBtn.onclick = function() { deleteSinglePlan(plan.planHash, periodData.period); };
    actionCell.appendChild(deleteBtn);
    row.appendChild(actionCell);
    
    // å¦‚æœæä¾›äº†tableBodyï¼Œç›´æ¥æ·»åŠ ï¼›å¦åˆ™è¿”å›è¡Œå…ƒç´ 
    if (tableBody) {
        tableBody.appendChild(row);
    } else {
        return row;
    }
}

// ç§»é™¤å•æœŸéªŒè¯è½®è¯¢åŠŸèƒ½ - startSinglePeriodPollingå‡½æ•°å·²åˆ é™¤

// ç§»é™¤å•æœŸéªŒè¯ä¸»åŠ¨æ£€æŸ¥åŠŸèƒ½ - checkSinglePeriodVerificationå‡½æ•°å·²åˆ é™¤

// ç§»é™¤å•æœŸéªŒè¯è½®è¯¢åŠŸèƒ½ - stopSinglePeriodPollingå‡½æ•°å·²åˆ é™¤

// é‡ç½®å•æœŸéªŒè¯çŠ¶æ€
function resetSinglePeriodVerification() {
    // ç§»é™¤è½®è¯¢ç›¸å…³è°ƒç”¨
    singlePeriodTargetPeriod = null;
    console.log('ğŸ”„ é‡ç½®å•æœŸéªŒè¯çŠ¶æ€');
}

// ä¿å­˜å•æœŸéªŒè¯ç»“æœï¼ˆåªå¤„ç†åŒ¹é…æœŸå·çš„è®¡åˆ’ï¼‰
// ç§»é™¤å•æœŸéªŒè¯ç»“æœä¿å­˜åŠŸèƒ½ - saveSinglePeriodVerificationResultså‡½æ•°å·²åˆ é™¤

// åˆ é™¤å•ä¸ªéªŒè¯è®¡åˆ’çš„å‡½æ•°
function deleteSinglePlan(planHash, currentPeriod) {
  if (!window.verifyPlanData || !Array.isArray(window.verifyPlanData)) {
    alert('éªŒè¯è®¡åˆ’æ•°æ®ä¸å­˜åœ¨');
    return;
  }
  
  // æŸ¥æ‰¾è¦åˆ é™¤çš„è®¡åˆ’
  const planIndex = window.verifyPlanData.findIndex(plan => plan.planHash === planHash);
  
  if (planIndex === -1) {
    alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®¡åˆ’');
    return;
  }
  
  const plan = window.verifyPlanData[planIndex];
  const planName = plan.displayName || plan.planHash || 'æœªçŸ¥è®¡åˆ’';
  
  // ç§»é™¤ç¡®è®¤å¯¹è¯æ¡†ï¼Œç›´æ¥åˆ é™¤
  // ä»éªŒè¯è®¡åˆ’æ•°ç»„ä¸­åˆ é™¤
  window.verifyPlanData.splice(planIndex, 1);
  
  console.log(`ğŸ—‘ï¸ åˆ é™¤äº†éªŒè¯è®¡åˆ’: ${planName}`);
  
  // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
  if (typeof updateSinglePeriodTable === 'function') {
    updateSinglePeriodTable();
  }
  
  // ç§»é™¤åˆ é™¤æˆåŠŸçš„å¼¹çª—æç¤º
}

// åˆ†é¡µè¾…åŠ©å‡½æ•°
function showPaginationInfo(currentPage, totalPages, totalPlans) {
    console.log(`ğŸ“„ åˆ†é¡µä¿¡æ¯: ç¬¬${currentPage}é¡µ/å…±${totalPages}é¡µï¼Œæ€»è®¡${totalPlans}ä¸ªè®¡åˆ’`);
}

function processPlansPage(plans, fragment) {
    // è·å–æ•°æ®æº
    let dataSource = null;
    if (window.r && Array.isArray(window.r) && window.r.length > 0) {
        dataSource = window.r;
    } else if (window.historyData && Array.isArray(window.historyData) && window.historyData.length > 0) {
        dataSource = window.historyData;
    } else {
        console.warn('âš ï¸ æ²¡æœ‰å¯ç”¨çš„æ•°æ®æº');
        return;
    }

    // æŒ‰æœŸå·æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
    dataSource = dataSource.sort((a, b) => parseInt(b.period) - parseInt(a.period));

    // å¤„ç†æ¯ä¸ªè®¡åˆ’
    plans.forEach(plan => {
        if (!plan.planNumbers || plan.planNumbers.length === 0) return;

        // å¦‚æœè®¡åˆ’å·²å®Œæˆå¤šæœŸéªŒè¯ï¼Œè·³è¿‡å•æœŸéªŒè¯é€»è¾‘
        if (plan.isCompleted) {
            const row = createSinglePeriodRowPending(null, plan, { period: plan.period || 'å·²éªŒè¯' });
            if (row) fragment.appendChild(row);
            return;
        }

        // åˆå§‹åŒ–éªŒè¯çŠ¶æ€
        if (!plan.singlePeriodVerificationResults) {
            plan.singlePeriodVerificationResults = [];
        }

        // æ‰¾åˆ°æœ€è¿‘ä¸€æœŸå·²å¼€å¥–çš„æ•°æ®
        const latestDrawnPeriod = dataSource.find(periodData => 
            periodData && periodData.data && periodData.data.length >= 5
        );

        if (latestDrawnPeriod) {
            // éªŒè¯æœ€è¿‘ä¸€æœŸå·²å¼€å¥–çš„æ•°æ®
            const drawNumbers = latestDrawnPeriod.data;
            let periodWin = false;
            let winningNumber = null;

            // éªŒè¯è®¡åˆ’ä¸­çš„æ¯æ³¨å·ç 
            for (const numberStr of plan.planNumbers) {
                const numbers = numberStr.split(' ').map(n => parseInt(n.trim()));
                
                // æ ¹æ®è®¡åˆ’çš„æ˜Ÿçº§ç¡®å®šéœ€è¦åŒ¹é…çš„ä½æ•°
                const conditions = plan.generationConditions || {};
                const moduleType = conditions.moduleType || '5æ˜Ÿåšå·';
                const starLevel = parseInt(moduleType.match(/(\d+)æ˜Ÿ/)?.[1]) || 5;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å·ç 
                if (numbers.length === starLevel && numbers.every(n => !isNaN(n))) {
                    // ä¸¥æ ¼åˆ¤å®šï¼šå‰å‡ ä½é¡ºåºå®Œå…¨ä¸€è‡´æ‰ç®—ä¸­
                    const frontNumbers = drawNumbers.slice(0, starLevel);
                    const exactMatch = numbers.every((num, idx) => num === frontNumbers[idx]);
                    
                    if (exactMatch) {
                        periodWin = true;
                        winningNumber = numberStr;
                        break;
                    }
                }
            }

            // åˆ›å»ºè¡¨æ ¼è¡Œ
            const row = createSinglePeriodRow(null, plan, latestDrawnPeriod, periodWin, winningNumber, drawNumbers);
            if (row) fragment.appendChild(row);
        }
    });
}

function showPaginationControls(currentPage, totalPages, pageSize) {
    const controlsContainer = document.getElementById('single-period-pagination-controls');
    if (!controlsContainer) {
        // åˆ›å»ºåˆ†é¡µæ§ä»¶å®¹å™¨
        const container = document.createElement('div');
        container.id = 'single-period-pagination-controls';
        container.className = 'flex justify-center items-center space-x-2 mt-4';
        
        const tableContainer = document.querySelector('#single-period-table').parentNode;
        tableContainer.appendChild(container);
    }

    const container = document.getElementById('single-period-pagination-controls');
    container.innerHTML = '';

    if (totalPages <= 1) return;

    // é¦–é¡µæŒ‰é’®
    if (currentPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
        firstBtn.textContent = 'é¦–é¡µ';
        firstBtn.onclick = () => updateSinglePeriodTable(pageSize, 1);
        container.appendChild(firstBtn);
    }

    // ä¸Šä¸€é¡µæŒ‰é’®
    if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
        prevBtn.textContent = 'ä¸Šä¸€é¡µ';
        prevBtn.onclick = () => updateSinglePeriodTable(pageSize, currentPage - 1);
        container.appendChild(prevBtn);
    }

    // é¡µç ä¿¡æ¯
    const pageInfo = document.createElement('span');
    pageInfo.className = 'px-3 py-1 text-gray-700';
    pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
    container.appendChild(pageInfo);

    // ä¸‹ä¸€é¡µæŒ‰é’®
    if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
        nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
        nextBtn.onclick = () => updateSinglePeriodTable(pageSize, currentPage + 1);
        container.appendChild(nextBtn);
    }

    // æœ«é¡µæŒ‰é’®
    if (currentPage < totalPages) {
        const lastBtn = document.createElement('button');
        lastBtn.className = 'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600';
        lastBtn.textContent = 'æœ«é¡µ';
        lastBtn.onclick = () => updateSinglePeriodTable(pageSize, totalPages);
        container.appendChild(lastBtn);
    }
}



// åˆ é™¤å†å²è®°å½•çš„å‡½æ•°
function deleteHistoricalRecord(recordId) {
  // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–å†å²è®°å½•
  const historyKey = 'singlePeriodHistory';
  let history = [];
  try {
    const stored = localStorage.getItem(historyKey);
    if (stored) {
      history = JSON.parse(stored);
    }
  } catch (e) {
    console.error('è¯»å–å†å²è®°å½•å¤±è´¥:', e);
    return;
  }
  
  // æŸ¥æ‰¾è¦åˆ é™¤çš„è®°å½•ï¼ˆä½¿ç”¨periodå­—æ®µåŒ¹é…ï¼‰
  const recordIndex = history.findIndex(record => record.period === recordId);
  
  if (recordIndex === -1) {
    alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„å†å²è®°å½•');
    return;
  }
  
  const record = history[recordIndex];
  const recordName = record.period || record.planName || record.id || 'æœªçŸ¥è®°å½•';
  
  if (confirm(`ç¡®å®šè¦åˆ é™¤å†å²è®°å½•"${recordName}"å—ï¼Ÿ`)) {
    // ä»å†å²è®°å½•æ•°ç»„ä¸­åˆ é™¤
    history.splice(recordIndex, 1);
    
    // æ›´æ–°æœ¬åœ°å­˜å‚¨
    try {
      localStorage.setItem(historyKey, JSON.stringify(history));
      console.log(`ğŸ—‘ï¸ åˆ é™¤äº†å†å²è®°å½•: ${recordName}`);
      
      // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
      if (typeof updateSinglePeriodTable === 'function') {
        updateSinglePeriodTable();
      }
      
      alert(`å·²åˆ é™¤å†å²è®°å½•"${recordName}"`);
    } catch (e) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
      alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
}

// å•æœŸéªŒè¯æ§åˆ¶å‡½æ•°
function updateSinglePeriodControls() {
    // è·å–å½“å‰éªŒè¯ç›®æ ‡æœŸå·
    const targetPeriod = window.singleVerifyTargetPeriod;
    
    // å½“å‰éªŒè¯æœŸå·æ˜¾ç¤ºå·²ç§»é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¶ä»–æ§åˆ¶é€»è¾‘
}





document.addEventListener('DOMContentLoaded', function() {
    
    // è·å–é¡µé¢å…ƒç´ 
    const pasteAndVerifyBtn = document.getElementById('pasteAndVerifyBtn');
    const verifyPlanTableBody = document.getElementById('verifyPlanTableBody');
    const verifyDataCount = document.getElementById('verifyDataCount');
    const totalPeriods = document.getElementById('totalPeriods');
    const successCount = document.getElementById('successCount');
    const failCount = document.getElementById('failCount');
    
    // éªŒè¯æ¨¡å¼åˆ‡æ¢ç›¸å…³å…ƒç´ 
    const multiPeriodModeBtn = document.getElementById('multiPeriodModeBtn');
    const singlePeriodModeBtn = document.getElementById('singlePeriodModeBtn');
    const multiPeriodTable = document.getElementById('multiPeriodTable');
    const singlePeriodTable = document.getElementById('singlePeriodTable');
    
    // å½“å‰éªŒè¯æ¨¡å¼çŠ¶æ€
    let currentVerifyMode = 'single'; // 'multi' æˆ– 'single'
    
    // éªŒè¯æ¨¡å¼åˆ‡æ¢å‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.switchVerifyMode = function(mode, skipTableUpdate = false) {
        // è·å–å¿…è¦çš„å…ƒç´ 
        const multiPeriodModeBtn = document.getElementById('multiPeriodModeBtn');
        const singlePeriodModeBtn = document.getElementById('singlePeriodModeBtn');
        const multiPeriodTable = document.getElementById('multiPeriodTable');
        const singlePeriodTable = document.getElementById('singlePeriodTable');
        const planHistoryControls = document.getElementById('planHistoryControls');
        
        window.currentVerifyMode = mode;
        
        if (mode === 'single') {
            // åˆ‡æ¢åˆ°å•æœŸéªŒè¯æ¨¡å¼
            if (multiPeriodModeBtn) multiPeriodModeBtn.className = 'px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium transition-colors hover:bg-gray-200';
            if (singlePeriodModeBtn) singlePeriodModeBtn.className = 'px-4 py-2 bg-blue-500 text-white text-sm font-medium transition-colors hover:bg-blue-600';
            if (multiPeriodTable) multiPeriodTable.classList.add('hidden');
            if (singlePeriodTable) singlePeriodTable.classList.remove('hidden');
            
            // æ˜¾ç¤ºè®¡åˆ’éªŒè¯å†å²ç®¡ç†æ§ä»¶
            if (planHistoryControls) {
                planHistoryControls.style.display = 'block';
                if (typeof updateHistoryCount === 'function') {
                    updateHistoryCount();
                }
            }
            
            // åªåœ¨æ²¡æœ‰ç›®æ ‡æœŸå·æ—¶æ‰é‡æ–°è®¡ç®—ï¼Œä¿æŒå·²æœ‰çš„éªŒè¯çŠ¶æ€
            if (!window.singleVerifyTargetPeriod) {
                console.log('å•æœŸéªŒè¯ï¼šé¦–æ¬¡åˆ‡æ¢æ¨¡å¼ï¼Œå°†è®¡ç®—ç›®æ ‡æœŸå·');
            } else {
                console.log('å•æœŸéªŒè¯ï¼šä¿æŒç°æœ‰ç›®æ ‡æœŸå·:', window.singleVerifyTargetPeriod);
            }
            
            // æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼ï¼ˆé™¤éè·³è¿‡è¡¨æ ¼æ›´æ–°ï¼‰
            if (!skipTableUpdate && typeof updateSinglePeriodTable === 'function') {
                updateSinglePeriodTable();
            }
        } else {
            // åˆ‡æ¢åˆ°å¤šæœŸéªŒè¯æ¨¡å¼
            if (multiPeriodModeBtn) multiPeriodModeBtn.className = 'px-4 py-2 bg-blue-500 text-white text-sm font-medium transition-colors hover:bg-blue-600';
            if (singlePeriodModeBtn) singlePeriodModeBtn.className = 'px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium transition-colors hover:bg-gray-200';
            if (multiPeriodTable) multiPeriodTable.classList.remove('hidden');
            if (singlePeriodTable) singlePeriodTable.classList.add('hidden');
            
            // éšè—è®¡åˆ’éªŒè¯å†å²ç®¡ç†æ§ä»¶
            if (planHistoryControls) {
                planHistoryControls.style.display = 'none';
            }
            
            // æ›´æ–°å¤šæœŸéªŒè¯è¡¨æ ¼
            if (typeof window.updateVerifyPlanTable === 'function') {
                window.updateVerifyPlanTable();
            }
        }
    };
    

    
    // ç»‘å®šåˆ‡æ¢æŒ‰é’®äº‹ä»¶
    if (multiPeriodModeBtn) {
        multiPeriodModeBtn.addEventListener('click', () => window.switchVerifyMode('multi'));
    }
    
    if (singlePeriodModeBtn) {
        singlePeriodModeBtn.addEventListener('click', () => window.switchVerifyMode('single'));
    }
    
    // åˆ‡æ¢åˆ°éªŒè¯è®¡åˆ’é¡µé¢çš„å‡½æ•°
    window.showVerifyPlanPage = function() {
        // ç¦ç”¨æ»šåŠ¨ç›‘å¬ï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è·³åŠ¨
        if (typeof disableScrollListener === 'function') {
            disableScrollListener();
        }
        
        // è·å–é¡µé¢å…ƒç´ 
        const dataAnalysisPage = document.getElementById('dataAnalysisPage');
        const fiveStarPage = document.getElementById('fiveStarPage');
        const verifyPlanPage = document.getElementById('verifyPlanPage');
        const goldenRatioPage = document.getElementById('goldenRatioPage');
        const dataAnalysisBtn = document.getElementById('dataAnalysisBtn');
        const fiveStarBtn = document.getElementById('fiveStarBtn');
        const verifyPlanBtn = document.getElementById('verifyPlanBtn');
        const goldenRatioBtn = document.getElementById('goldenRatioBtn');
        
        // è·å–å½“å‰æ˜¾ç¤ºçš„é¡µé¢ç±»å‹
        function getCurrentPageType() {
            if (dataAnalysisPage && !dataAnalysisPage.classList.contains('hidden')) return 'dataAnalysis';
            if (fiveStarPage && !fiveStarPage.classList.contains('hidden')) return 'fiveStar';
            if (verifyPlanPage && !verifyPlanPage.classList.contains('hidden')) return 'verifyPlan';
            if (goldenRatioPage && !goldenRatioPage.classList.contains('hidden')) return 'goldenRatio';
            return 'dataAnalysis'; // é»˜è®¤
        }
        
        // ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
        const currentPage = getCurrentPageType();
        if (typeof saveScrollPosition === 'function') {
            saveScrollPosition(currentPage);
        }
        
        // åˆ‡æ¢é¡µé¢
        if (dataAnalysisPage) dataAnalysisPage.classList.add('hidden');
        if (fiveStarPage) fiveStarPage.classList.add('hidden');
        if (verifyPlanPage) verifyPlanPage.classList.remove('hidden');
        if (goldenRatioPage) goldenRatioPage.classList.add('hidden');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (verifyPlanBtn) {
            verifyPlanBtn.classList.add('bg-primary');
            verifyPlanBtn.classList.remove('bg-gray-600');
        }
        if (dataAnalysisBtn) {
            dataAnalysisBtn.classList.add('bg-gray-600');
            dataAnalysisBtn.classList.remove('bg-primary');
        }
        if (fiveStarBtn) {
            fiveStarBtn.classList.add('bg-gray-600');
            fiveStarBtn.classList.remove('bg-primary');
        }
        if (goldenRatioBtn) {
            goldenRatioBtn.classList.add('bg-gray-600');
            goldenRatioBtn.classList.remove('bg-primary');
        }
        
        // æ¢å¤éªŒè¯è®¡åˆ’é¡µé¢çš„æ»šåŠ¨ä½ç½®
        if (typeof restoreScrollPosition === 'function') {
            restoreScrollPosition('verifyPlan');
        }
        
        // åŠ è½½å†å²æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
        if (!r || r.length === 0) {
            console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå¼€å§‹åŠ è½½å†å²æ•°æ®');
            fetchHistoryData();
        }
        
        // åŒæ­¥æ•°æ®åˆ†æé¡µé¢çš„æ•°æ®å¹¶æ›´æ–°è¡¨æ ¼
        console.log('éªŒè¯è®¡åˆ’é¡µé¢: å¼€å§‹åŒæ­¥æ•°æ®');
        if (typeof window.syncDataToVerifyPlan === 'function') {
            window.syncDataToVerifyPlan();
        }
        if (typeof window.updateVerifyPlanTable === 'function') {
            window.updateVerifyPlanTable();
        }
        console.log('éªŒè¯è®¡åˆ’é¡µé¢: æ•°æ®åŒæ­¥å®Œæˆ');
        
        // å¯åŠ¨æ•°æ®è‡ªåŠ¨æ›´æ–°ï¼ˆæ¯2ç§’ï¼‰
        if (window.verifyPlanUpdateInterval) {
            clearInterval(window.verifyPlanUpdateInterval);
        }
        window.verifyPlanUpdateInterval = setInterval(() => {
            if (!verifyPlanPage.classList.contains('hidden')) {
                fetchApiData();
                // åŒæ—¶æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼ï¼Œç¡®ä¿è‡ªåŠ¨éªŒè¯
                if (typeof window.updateSinglePeriodTable === 'function') {
                    window.updateSinglePeriodTable();
                }
            }
        }, 2000);
        
        console.log('éªŒè¯è®¡åˆ’é¡µé¢å·²æ¿€æ´»ï¼Œæ•°æ®æ›´æ–°å·²å¯åŠ¨');
        
        // åˆå§‹åŒ–éªŒè¯æ¨¡å¼ä¸ºå•æœŸéªŒè¯
        if (typeof window.switchVerifyMode === 'function') {
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå…ƒç´ å®Œå…¨åŠ è½½ï¼Œå¹¶æ·»åŠ é‡è¯•æœºåˆ¶
            const initializeVerifyMode = () => {
                const planHistoryControls = document.getElementById('planHistoryControls');
                if (planHistoryControls) {
                    window.switchVerifyMode('single');
                    console.log('âœ… éªŒè¯æ¨¡å¼åˆå§‹åŒ–æˆåŠŸï¼Œå†å²ç®¡ç†æ§ä»¶å·²æ˜¾ç¤º');
                } else {
                    // å¦‚æœå…ƒç´ è¿˜æ²¡æœ‰åŠ è½½ï¼Œå†æ¬¡å»¶è¿Ÿé‡è¯•
                    setTimeout(initializeVerifyMode, 200);
                }
            };
            setTimeout(initializeVerifyMode, 300);
        }
    };
    

    

    

    
    // ç²˜è´´å¹¶éªŒè¯æŒ‰é’®äº‹ä»¶
    if (pasteAndVerifyBtn) {
        pasteAndVerifyBtn.addEventListener('click', async function() {
            try {
                // ä»å‰ªè´´æ¿è¯»å–æ•°æ®
                const clipboardText = await navigator.clipboard.readText();
                if (!clipboardText.trim()) {
                    alert('å‰ªè´´æ¿ä¸ºç©ºï¼Œè¯·å…ˆå¤åˆ¶éœ€è¦éªŒè¯çš„æ•°æ®');
                    return;
                }
                
                console.log('ç²˜è´´çš„æ•°æ®:', clipboardText);
                
                // è§£æç²˜è´´çš„æ•°æ®å¹¶è¿›è¡Œæ‰¹é‡éªŒè¯
                await processPastedData(clipboardText);
                
            } catch (error) {
                console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:', error);
                alert('è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·ç¡®ä¿æµè§ˆå™¨å…è®¸è®¿é—®å‰ªè´´æ¿');
            }
        });
    }
    

    
    // å¤„ç†ç²˜è´´çš„æ•°æ®å¹¶è¿›è¡Œæ‰¹é‡éªŒè¯
    async function processPastedData(clipboardText) {
        try {
            console.log('å¼€å§‹å¤„ç†ç²˜è´´çš„æ•°æ®:', clipboardText);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ•°æ®
            if (!r || r.length === 0) {
                alert('æ²¡æœ‰å†å²æ•°æ®ï¼Œè¯·å…ˆåœ¨æ•°æ®åˆ†æé¡µé¢åŠ è½½æ•°æ®');
                return;
            }
            
            // è§£æç²˜è´´çš„æ•°æ®
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯äº”æ˜Ÿåšå·çš„æ ¼å¼ï¼ˆé€—å·åˆ†éš”çš„å¤šæ³¨ï¼Œæ¯æ³¨å†…éƒ¨ç©ºæ ¼åˆ†éš”ï¼‰
            let validLines = [];
            
            // å¦‚æœåŒ…å«é€—å·ï¼Œå¯èƒ½æ˜¯äº”æ˜Ÿåšå·çš„å¤šæ³¨æ ¼å¼
            if (clipboardText.includes(',')) {
                console.log('æ£€æµ‹åˆ°é€—å·åˆ†éš”æ ¼å¼ï¼Œå°è¯•è§£æäº”æ˜Ÿåšå·æ•°æ®');
                const parts = clipboardText.trim().split(',');
                
                for (let part of parts) {
                    part = part.trim();
                    if (!part) continue;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºæ ¼åˆ†éš”çš„äº”æ˜Ÿå·ç æ ¼å¼ï¼ˆå¦‚"01 02 03 04 05"ï¼‰
                    if (part.includes(' ')) {
                        const numbers = part.split(/\s+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 10);
                        if (numbers.length === 5) { // äº”æ˜Ÿå¿…é¡»æ˜¯5ä¸ªæ•°å­—
                            validLines.push(numbers.join(','));
                        }
                    }
                    // ä¹Ÿæ”¯æŒå•ä¸ªæ•°å­—çš„é€—å·åˆ†éš”æ ¼å¼
                    else {
                        const num = parseInt(part.trim());
                        if (!isNaN(num) && num >= 1 && num <= 10) {
                            // è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ”¶é›†5ä¸ªæ•°å­—ç»„æˆä¸€æ³¨
                            // æš‚æ—¶å…ˆè·³è¿‡ï¼Œå› ä¸ºè¿™ç§æ ¼å¼æ¯”è¾ƒå¤æ‚
                        }
                    }
                }
            }
            
            // å¦‚æœä¸Šé¢æ²¡æœ‰è§£æå‡ºæœ‰æ•ˆæ•°æ®ï¼Œå°è¯•æŒ‰è¡Œè§£æ
            if (validLines.length === 0) {
                console.log('æŒ‰è¡Œè§£ææ•°æ®');
                const lines = clipboardText.trim().split('\n');
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    // å°è¯•è§£æä¸åŒæ ¼å¼çš„æ•°æ®
                    let numbers = [];
                    
                    // æ ¼å¼1: é€—å·åˆ†éš” "1,2,3,4,5"
                    if (line.includes(',')) {
                        numbers = line.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 10);
                    }
                    // æ ¼å¼2: ç©ºæ ¼åˆ†éš” "1 2 3 4 5" æˆ– "01 02 03 04 05"
                    else if (line.includes(' ')) {
                        numbers = line.split(/\s+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 10);
                    }
                    // æ ¼å¼3: åˆ¶è¡¨ç¬¦åˆ†éš”
                    else if (line.includes('\t')) {
                        numbers = line.split('\t').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 10);
                    }
                    // æ ¼å¼4: å•ä¸ªæ•°å­—æˆ–å…¶ä»–åˆ†éš”ç¬¦
                    else {
                        const matches = line.match(/\d+/g);
                        if (matches) {
                            numbers = matches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 10);
                        }
                    }
                    
                    if (numbers.length > 0) {
                        validLines.push(numbers.join(','));
                    }
                }
            }
            
            if (validLines.length === 0) {
                alert('æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„å·ç æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
                return;
            }
            
            console.log('è§£æå‡ºçš„æœ‰æ•ˆå·ç :', validLines);
            
            // ä½¿ç”¨æœ€æ–°ä¸€æœŸæ•°æ®éªŒè¯æ•´ä¸ªè®¡åˆ’
            const latestPeriod = r[0]; // æœ€æ–°ä¸€æœŸ
            const frontFive = latestPeriod.data.slice(0, 5);
            
            // æ£€æŸ¥æ•´ä¸ªè®¡åˆ’æ˜¯å¦æœ‰ä»»ä½•ä¸€æ³¨å‘½ä¸­ï¼ˆæ ¹æ®æ˜Ÿçº§åŠ¨æ€åŒ¹é…ï¼‰
            let isWin = false;
            for (const numberStr of validLines) {
                const numbers = numberStr.split(',').map(n => parseInt(n.trim()));
                // æ ¹æ®å·ç é•¿åº¦ç¡®å®šæ˜Ÿçº§ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„ä½ç½®åŒ¹é…
                const starLevel = numbers.length;
                if (starLevel >= 2 && starLevel <= 5) {
                    const isExactMatch = numbers.every((num, index) => num === frontFive[index]);
                    if (isExactMatch) {
                        isWin = true;
                        console.log(`${starLevel}æ˜Ÿå‘½ä¸­ï¼šå·ç  ${numbers.join(',')} åŒ¹é…å¼€å¥–å‰${starLevel}ä½`);
                        break; // åªè¦æœ‰ä¸€æ³¨å‘½ä¸­å°±åœæ­¢æ£€æŸ¥
                    }
                }
            }
            
            // åˆ›å»ºå•æ¡éªŒè¯è®°å½•
            const verifyRecord = {
                period: latestPeriod.period,
                planNumbers: validLines,
                betCount: validLines.length,
                result: isWin ? 'ä¸­' : 'æŒ‚',
                latestData: latestPeriod.data
            };
            
            // å°†éªŒè¯ç»“æœæ·»åŠ åˆ°éªŒè¯è®¡åˆ’æ•°æ®
            window.verifyPlanData.unshift(verifyRecord);
            
            // æ›´æ–°è¡¨æ ¼å’Œç»Ÿè®¡
            updateVerifyPlanTable();
            updateStatistics();
            
            // åŒæ—¶æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
            if (typeof updateSinglePeriodTable === 'function') {
                updateSinglePeriodTable();
            }
            
        } catch (error) {
            console.error('å¤„ç†ç²˜è´´æ•°æ®æ—¶å‡ºé”™:', error);
            alert('å¤„ç†æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        }
    }
    
    // åŒæ­¥æ•°æ®åˆ†æé¡µé¢çš„æ•°æ®åˆ°éªŒè¯è®¡åˆ’é¡µé¢
    window.syncDataToVerifyPlan = function() {
        console.log('å¼€å§‹åŒæ­¥æ•°æ®åˆ°éªŒè¯è®¡åˆ’é¡µé¢');
        
        // ç¡®ä¿éªŒè¯è®¡åˆ’æ•°æ®å·²åˆå§‹åŒ–
        if (!window.verifyPlanData) {
            window.verifyPlanData = [];
        }
        
        // æ£€æŸ¥æ•°æ®æºï¼šä¼˜å…ˆä½¿ç”¨window.rï¼ˆæ•°æ®åˆ†æé¡µé¢çš„ä¸»æ•°æ®æºï¼‰ï¼Œå…¶æ¬¡ä½¿ç”¨window.historyData
        let dataSource = null;
        if (window.r && window.r.length > 0) {
            dataSource = window.r;
            console.log('æ‰¾åˆ°window.ræ•°æ®ï¼Œå…±', dataSource.length, 'æ¡è®°å½•');
        } else if (window.historyData && window.historyData.length > 0) {
            dataSource = window.historyData;
            console.log('æ‰¾åˆ°historyDataæ•°æ®ï¼Œå…±', dataSource.length, 'æ¡è®°å½•');
        }
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
        if (dataSource && dataSource.length > 0) {
            
            // ä¸å†è‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤çš„0æ³¨è®°å½•ï¼Œåªä¿ç•™çœŸå®çš„éªŒè¯è®¡åˆ’æ•°æ®
            // éªŒè¯è®¡åˆ’æ•°æ®åªæœ‰åœ¨ç”¨æˆ·å®é™…æ·»åŠ éªŒè¯è®¡åˆ’æ—¶æ‰ä¼šåˆ›å»º
            
            // å¦‚æœéªŒè¯è®¡åˆ’æ•°æ®å·²å­˜åœ¨ï¼Œåªæ›´æ–°å·²å­˜åœ¨æœŸæ•°çš„å¼€å¥–æ•°æ®
            if (window.verifyPlanData.length > 0) {
                dataSource.forEach(item => {
                    // æ›´æ–°å·²å­˜åœ¨æœŸæ•°çš„å¼€å¥–æ•°æ®ï¼ˆä¿ç•™ç”¨æˆ·æ·»åŠ çš„éªŒè¯å·ç ï¼‰
                    const existingRecord = window.verifyPlanData.find(record => record.period === item.period);
                    if (existingRecord) {
                        existingRecord.latestData = item.data;
                    }
                });
                
                console.log('å·²åŒæ­¥å¼€å¥–æ•°æ®åˆ°éªŒè¯è®¡åˆ’:', window.verifyPlanData.length, 'æ¡è®°å½•');
            } else {
                console.log('éªŒè¯è®¡åˆ’æ•°æ®ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·æ·»åŠ éªŒè¯è®¡åˆ’');
            }
            
            // åŒæ­¥å®Œæˆåç«‹å³æ›´æ–°è¡¨æ ¼
            updateVerifyPlanTable();
            
            // ç§»é™¤å•æœŸéªŒè¯ä¸»åŠ¨æ£€æŸ¥é€»è¾‘
        } else {
            console.log('æš‚æ— æ•°æ®æºï¼Œå°è¯•è·å–å†å²æ•°æ®');
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°è¯•è·å–å†å²æ•°æ®
            if (typeof fetchHistoryData === 'function') {
                fetchHistoryData().then(result => {
                    if (result && result.success) {
                        console.log('å†å²æ•°æ®è·å–æˆåŠŸï¼Œé‡æ–°åŒæ­¥');
                        window.syncDataToVerifyPlan();
                    }
                }).catch(error => {
                    console.error('è·å–å†å²æ•°æ®å¤±è´¥:', error);
                });
            }
        }
    };

    // å…¨å±€åˆ†é¡µå˜é‡
    let currentPage = 1;
    let periodsPerPage = 15; // é»˜è®¤15æœŸ
    let totalPages = 1;
    
    // æœŸæ•°é€‰æ‹©å‡½æ•°
    window.selectPeriods = function(periods) {
        // æ›´æ–°ä¸»æ•°æ®è¡¨æ ¼çš„æœŸæ•°é™åˆ¶
        f = periods;
        
        // æ›´æ–°è®¡åˆ’éªŒè¯è¡¨æ ¼çš„åˆ†é¡µæœŸæ•°
        periodsPerPage = periods;
        currentPage = 1;
        
        // æ›´æ–°æœŸæ•°æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        updatePeriodButtonsActiveState();
        
        // åˆ·æ–°ä¸»æ•°æ®è¡¨æ ¼
        L();
        
        // åˆ·æ–°è®¡åˆ’éªŒè¯è¡¨æ ¼
        window.updateVerifyPlanTable();
        updatePaginationControls();
        
        console.log(`æœŸæ•°åˆ‡æ¢å®Œæˆï¼Œè®¾ç½®ä¸º: ${periods} æœŸ`);
    }
    
    // è‡ªå®šä¹‰æœŸæ•°å‡½æ•°
    window.setCustomPeriods = function() {
        const input = document.getElementById('customPeriodsInput');
        const value = parseInt(input.value);
        if (value && value > 0 && value <= 1000) {
            // æ›´æ–°ä¸»æ•°æ®è¡¨æ ¼çš„æœŸæ•°é™åˆ¶
            f = value;
            
            // æ›´æ–°è®¡åˆ’éªŒè¯è¡¨æ ¼çš„åˆ†é¡µæœŸæ•°
            periodsPerPage = value;
            currentPage = 1;
            
            // æ›´æ–°æœŸæ•°æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            updatePeriodButtonsActiveState();
            
            // åˆ·æ–°ä¸»æ•°æ®è¡¨æ ¼
            L();
            
            // åˆ·æ–°è®¡åˆ’éªŒè¯è¡¨æ ¼
            window.updateVerifyPlanTable();
            updatePaginationControls();
            
            console.log(`è‡ªå®šä¹‰æœŸæ•°è®¾ç½®å®Œæˆï¼Œè®¾ç½®ä¸º: ${value} æœŸ`);
        } else {
            alert('è¯·è¾“å…¥1-1000ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—');
        }
    }
    
    // åˆ†é¡µæ§åˆ¶å‡½æ•°
    window.goToPage = function(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            window.updateVerifyPlanTable();
            updatePaginationControls();
        }
    }
    
    window.previousPage = function() {
        if (currentPage > 1) {
            currentPage--;
            window.updateVerifyPlanTable();
            updatePaginationControls();
        }
    }
    
    window.nextPage = function() {
        if (currentPage < totalPages) {
            currentPage++;
            window.updateVerifyPlanTable();
            updatePaginationControls();
        }
    }
    
    // æ›´æ–°åˆ†é¡µæ§ä»¶
    function updatePaginationControls() {
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        
        if (paginationInfo) {
            paginationInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = currentPage <= 1;
            prevBtn.className = currentPage <= 1 ? 
                'px-3 py-1 bg-gray-300 text-gray-500 rounded cursor-not-allowed' :
                'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 cursor-pointer';
        }
        
        if (nextBtn) {
            nextBtn.disabled = currentPage >= totalPages;
            nextBtn.className = currentPage >= totalPages ? 
                'px-3 py-1 bg-gray-300 text-gray-500 rounded cursor-not-allowed' :
                'px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 cursor-pointer';
        }
        
        // æ›´æ–°æœŸæ•°é€‰æ‹©æŒ‰é’®çŠ¶æ€
        updatePeriodButtonsActiveState();
    }

    // é«˜äº®å½“å‰é€‰ä¸­çš„æœŸæ•°æŒ‰é’®
    function updatePeriodButtonsActiveState() {
        const buttons = document.querySelectorAll('.periods-btn');
        buttons.forEach(btn => {
            const periods = parseInt(btn.dataset.periods);
            if (periods === periodsPerPage) {
                btn.className = 'periods-btn px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors';
            } else {
                btn.className = 'periods-btn px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400 transition-colors';
            }
        });
    }

    // åˆå§‹æ¸²æŸ“åï¼ŒåŒæ­¥ä¸€æ¬¡æŒ‰é’®é€‰ä¸­çŠ¶æ€
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => updatePeriodButtonsActiveState());
    } else {
        updatePeriodButtonsActiveState();
    }
    
    // æ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼ - å®Œå…¨å¤åˆ¶æ•°æ®åˆ†æé¡µé¢çš„L()å‡½æ•°é€»è¾‘
    window.updateVerifyPlanTable = async function() {
        console.log('=== updateVerifyPlanTable è¢«è°ƒç”¨ ===');
        console.log('å½“å‰å†å²æ•°æ®çŠ¶æ€:', window.historyData ? window.historyData.length : 0, 'æ¡');
        console.log('å½“å‰ræ•°æ®çŠ¶æ€:', window.r ? window.r.length : 0, 'æ¡');
        console.log('å½“å‰éªŒè¯è®°å½•çŠ¶æ€:', window.verifyPlanData ? window.verifyPlanData.length : 0, 'æ¡');
        
        const verifyPlanTable = document.getElementById('verifyPlanTable');
        const verifyPlanTableBody = document.getElementById('verifyPlanTableBody');
        console.log('è¡¨æ ¼å…ƒç´ æ£€æŸ¥ - verifyPlanTable:', !!verifyPlanTable, 'verifyPlanTableBody:', !!verifyPlanTableBody);
        
        if (!verifyPlanTable || !verifyPlanTableBody) {
            console.log('éªŒè¯è®¡åˆ’è¡¨æ ¼å…ƒç´ ä¸å­˜åœ¨');
            return;
        }
        
        // æ£€æŸ¥æ•°æ®æºï¼šä¼˜å…ˆä½¿ç”¨window.rï¼ˆæ•°æ®åˆ†æé¡µé¢çš„ä¸»æ•°æ®æºï¼‰ï¼Œå…¶æ¬¡ä½¿ç”¨window.historyData
        let dataSource = null;
        if (window.r && window.r.length > 0) {
            dataSource = window.r;
            console.log('ä½¿ç”¨window.ræ•°æ®æºï¼Œé•¿åº¦:', dataSource.length);
        } else if (window.historyData && window.historyData.length > 0) {
            dataSource = window.historyData;
            console.log('ä½¿ç”¨window.historyDataæ•°æ®æºï¼Œé•¿åº¦:', dataSource.length);
        }
        
        // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œå°è¯•è·å–å†å²æ•°æ®
        if (!dataSource || dataSource.length === 0) {
            console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šæ²¡æœ‰æ‰¾åˆ°æ•°æ®æºï¼Œå°è¯•è·å–å†å²æ•°æ®');
            const thead = verifyPlanTable.querySelector('thead');
            if (thead) thead.innerHTML = '';
            verifyPlanTableBody.innerHTML = `
                <tr>
                    <td colspan="100" class="py-4 text-center text-gray-500">
                        æ­£åœ¨åŠ è½½æ•°æ®...
                    </td>
                </tr>
            `;
            
            // å¤šé‡æ•°æ®è·å–ç­–ç•¥
            let dataObtained = false;
            
            // ç­–ç•¥1ï¼šå°è¯•è·å–å†å²æ•°æ®
            if (typeof fetchHistoryData === 'function') {
                try {
                    const result = await fetchHistoryData();
                    if (result && result.success && window.historyData && window.historyData.length > 0) {
                        console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå†å²æ•°æ®è·å–æˆåŠŸï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼');
                        dataObtained = true;
                        window.updateVerifyPlanTable();
                        return;
                    }
                } catch (error) {
                    console.error('éªŒè¯è®¡åˆ’é¡µé¢ï¼šè·å–å†å²æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // ç­–ç•¥2ï¼šå°è¯•ä»APIè·å–æ•°æ®
            if (!dataObtained && typeof fetchApiData === 'function') {
                try {
                    console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå°è¯•ä»APIè·å–æ•°æ®');
                    await fetchApiData();
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
                    if ((window.historyData && window.historyData.length > 0) || (window.r && window.r.length > 0)) {
                        console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šAPIæ•°æ®è·å–æˆåŠŸï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼');
                        dataObtained = true;
                        window.updateVerifyPlanTable();
                        return;
                    }
                } catch (error) {
                    console.error('éªŒè¯è®¡åˆ’é¡µé¢ï¼šAPIæ•°æ®è·å–å¤±è´¥:', error);
                }
            }
            
            // ç­–ç•¥3ï¼šå¯åŠ¨æ•°æ®è·å–å®šæ—¶å™¨
            if (!dataObtained) {
                console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå¯åŠ¨æ•°æ®è·å–å®šæ—¶å™¨');
                if (typeof startVerifyPlanDataFetch === 'function') {
                    startVerifyPlanDataFetch();
                }
                
                verifyPlanTableBody.innerHTML = `
                    <tr>
                        <td colspan="100" class="py-4 text-center text-gray-500">
                            æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...<br>
                            <small class="text-xs">å¦‚æœé•¿æ—¶é—´æ— æ•°æ®ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–åœ¨æ•°æ®åˆ†æé¡µé¢æ‰‹åŠ¨è·å–æ•°æ®</small>
                        </td>
                    </tr>
                `;
            }
            return;
        }
        
        console.log('éªŒè¯è®¡åˆ’é¡µé¢å¼€å§‹æ¸²æŸ“è¡¨æ ¼ï¼Œæ•°æ®é•¿åº¦:', dataSource.length);
        
        // å¤åˆ¶L()å‡½æ•°çš„å®Œæ•´é€»è¾‘
        const thead = verifyPlanTable.querySelector('thead');
        const tbody = verifyPlanTableBody;
        
        // æ¸…ç©ºè¡¨æ ¼
        if (thead) thead.innerHTML = '';
        tbody.innerHTML = '';
        
        // è®¡ç®—åˆ†é¡µ
        const totalRecords = dataSource.length;
        totalPages = Math.ceil(totalRecords / periodsPerPage);
        
        // ç¡®ä¿å½“å‰é¡µåœ¨æœ‰æ•ˆèŒƒå›´å†…
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        if (currentPage < 1) {
            currentPage = 1;
        }
        
        // è·å–å½“å‰é¡µæ•°æ®
        const startIndex = (currentPage - 1) * periodsPerPage;
        const endIndex = Math.min(startIndex + periodsPerPage, totalRecords);
        const n = dataSource.slice(startIndex, endIndex);
        
        console.log(`éªŒè¯è®¡åˆ’é¡µé¢: æ˜¾ç¤ºç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µï¼Œå½“å‰é¡µ ${n.length} æ¡è®°å½•`);
        
        // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
        if (!n || n.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="100" class="py-4 text-center text-gray-500">
                        æ•°æ®ä¸ºç©º
                    </td>
                </tr>
            `;
            updatePaginationControls();
            return;
        }
        
        // åˆ›å»ºè¡¨æ ¼æ•°æ®ç»“æ„ï¼ˆå¤åˆ¶L()å‡½æ•°çš„é€»è¾‘ï¼‰
        const s = n.map(t => ({rec: t, cells: {}}));
        
        // ç”Ÿæˆæ–°çš„è¡¨å¤´ç»“æ„
        const headerRow = document.createElement("tr");
        headerRow.className = "bg-gray-50 table-header-sticky";
        
        // ç¬¬ä¸€åˆ—ï¼šæœŸå·
        const periodHeader = document.createElement("th");
        periodHeader.className = "px-3 py-2 text-center sticky-col left-0 border-r border-gray-200 fixed-width-period sticky-bg-white";
        periodHeader.style.cssText = "position: sticky; top: 20px; z-index: 1001;";
        periodHeader.innerHTML = '<div class="font-medium">æœŸå·</div>';
        headerRow.appendChild(periodHeader);
        
        // ç¬¬äºŒåˆ—ï¼šå¼€å¥–å·ç 
        const dataHeader = document.createElement("th");
        dataHeader.className = "px-3 py-2 text-center sticky-col left-[120px] border-r border-gray-200 fixed-width-data sticky-bg-white";
        dataHeader.style.cssText = "position: sticky; top: 20px; z-index: 1001;";
        dataHeader.innerHTML = '<div class="font-medium">å¼€å¥–å·ç </div>';
        headerRow.appendChild(dataHeader);
        
        // è·å–æ‰€æœ‰éªŒè¯è®¡åˆ’å¹¶ä¸ºæ¯ä¸ªè®¡åˆ’åˆ›å»ºä¸€åˆ—
        const allPlans = window.verifyPlanData || [];
        const uniquePlans = [];
        
        // æŒ‰ç…§planHashæ¥åŒºåˆ†ä¸åŒçš„éªŒè¯è®¡åˆ’ï¼Œç¡®ä¿å”¯ä¸€æ€§ï¼Œåªå¤„ç†çœŸå®çš„éªŒè¯è®¡åˆ’ï¼ˆbetCount > 0ï¼‰
        allPlans.forEach(plan => {
            // åªå¤„ç†çœŸå®çš„éªŒè¯è®¡åˆ’ï¼Œè¿‡æ»¤æ‰é»˜è®¤çš„0æ³¨è®°å½•
            if (plan.betCount && plan.betCount > 0) {
                const planHash = plan.planHash || plan.generationConditions?.planHash;
                
                // å¦‚æœæ²¡æœ‰planHashï¼Œä½¿ç”¨è®¡åˆ’å†…å®¹ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆä¸åŒ…å«æ—¶é—´æˆ³ï¼‰
                let planKey;
                if (planHash) {
                    planKey = planHash;
                } else {
                    // ä½¿ç”¨è®¡åˆ’çš„æ ¸å¿ƒå†…å®¹ç”Ÿæˆå”¯ä¸€æ ‡è¯†
                    const conditions = plan.generationConditions || {};
                    const contentKey = `${plan.betCount}æ³¨_${conditions.selectedNumbers?.sort().join(',') || ''}_${conditions.betMultiple || 1}_${conditions.periods || 1}`;
                    planKey = contentKey;
                }
                
                // ä½¿ç”¨planKeyç¡®ä¿è®¡åˆ’çš„å”¯ä¸€æ€§ï¼Œé¿å…é‡å¤åˆ—
                if (!uniquePlans.find(p => p.key === planKey)) {
                    uniquePlans.push({
                        key: planKey,
                        betCount: plan.betCount,
                        timestamp: plan.timestamp || plan.planId,
                        displayName: `${plan.betCount}æ³¨`,
                        planId: plan.planId,
                        planHash: planHash || planKey
                    });
                }
            }
        });
        
        // åˆ›å»ºéªŒè¯è®¡åˆ’åˆ—å¤´
        if (uniquePlans.length > 0) {
            // æœ‰éªŒè¯è®¡åˆ’æ—¶ï¼Œä¸ºæ¯ä¸ªéªŒè¯è®¡åˆ’åˆ›å»ºåˆ—å¤´
            uniquePlans.forEach((plan, index) => {
                const planHeader = document.createElement("th");
                planHeader.className = "px-3 py-2 text-center border-r border-gray-200 plan-column";
                planHeader.dataset.planKey = plan.key;
                // å¤´éƒ¨tooltipï¼šæ ¹æ®è®¡åˆ’æ‰¾åˆ°å¯¹åº”éªŒè¯è®°å½•å¹¶æ„å»ºæ¡ä»¶æ–‡æœ¬
                const headerVerifyRecord = (window.verifyPlanData || []).find(v => {
                    const vPlanHash = v.planHash || (v.generationConditions && v.generationConditions.planHash);
                    if (vPlanHash && plan.planHash && vPlanHash === plan.planHash) {
                        return true;
                    }
                    return v.betCount === plan.betCount && (plan.key.includes(v.timestamp || v.planId || ''));
                });
                const headerTextRaw = headerVerifyRecord ? buildConciseConditionText(headerVerifyRecord) : 'æœªæ‰¾åˆ°è¯¥è®¡åˆ’çš„éªŒè¯è¯¦æƒ…';
                const headerTextEscaped = headerTextRaw.replace(/'/g, "\\'").replace(/\n/g, '\\n');
                const headerTitleEscaped = headerTextRaw.replace(/'/g, "\\'").replace(/\n/g, ' ');
                planHeader.innerHTML = `<div class=\"font-medium cursor-help plan-header-trigger\" style=\"display:inline-block; white-space:nowrap;\" title=\"${headerTitleEscaped}\" onmouseenter=\"cancelHidePlanTooltip();showPlanTooltip(this, '${plan.key}', '${headerTextEscaped}');\" onmouseleave=\"scheduleHidePlanTooltip(100)\">${plan.displayName}</div>`;
                headerRow.appendChild(planHeader);
            });
        } else {
            // æ²¡æœ‰éªŒè¯è®¡åˆ’æ—¶ï¼Œæ·»åŠ ç©ºçŠ¶æ€æç¤ºåˆ—
            const emptyStateHeader = document.createElement("th");
            emptyStateHeader.className = "px-3 py-2 text-center border-r border-gray-200 empty-state-column";
            emptyStateHeader.innerHTML = `<div class="font-medium text-gray-400">éªŒè¯è®¡åˆ’</div>`;
            headerRow.appendChild(emptyStateHeader);
        }
        
        if (thead) thead.appendChild(headerRow);
        
        // æ¸²æŸ“æ•°æ®è¡Œï¼ˆæ–°çš„ç»“æ„ï¼‰
        s.forEach((item, index) => {
            const row = document.createElement("tr");
            row.className = index === 0 ? "bg-gray-100" : index === 1 ? "bg-gray-50" : "";
            
            // æœŸæ•°åˆ—
            const periodCell = document.createElement("td");
            periodCell.className = `px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium fixed-width-period ${index === 0 ? "sticky-bg-gray-100" : index === 1 ? "sticky-bg-gray-50" : "sticky-bg-white"}`;
            periodCell.textContent = item.rec.period;
            row.appendChild(periodCell);
            
            // å¼€å¥–å·ç åˆ—
            const dataCell = document.createElement("td");
            dataCell.className = `px-3 py-2 text-left sticky-col left-[120px] border-r border-gray-200 fixed-width-data ${index === 0 ? "sticky-bg-gray-100" : index === 1 ? "sticky-bg-gray-50" : "sticky-bg-white"}`;
            dataCell.innerHTML = `
                <div class="number-row">${item.rec.data.slice(0, 5).join(",")}</div>
                <div class="number-row">${item.rec.data.slice(5).join(",")}</div>
            `;
            row.appendChild(dataCell);
            
            // åˆ›å»ºéªŒè¯è®¡åˆ’æ•°æ®åˆ—
            if (uniquePlans.length > 0) {
                // æœ‰éªŒè¯è®¡åˆ’æ—¶ï¼Œä¸ºæ¯ä¸ªéªŒè¯è®¡åˆ’åˆ›å»ºæ•°æ®åˆ—
                uniquePlans.forEach(plan => {
                    const planCell = document.createElement("td");
                    planCell.className = "px-3 py-2 text-center border-r border-gray-200 plan-data-cell";
                    planCell.dataset.planKey = plan.key;
                    
                    // æŸ¥æ‰¾è¯¥è®¡åˆ’çš„éªŒè¯è®°å½•ï¼ˆå…¨æœŸéªŒè¯ç»“æœï¼‰
                    const verifyRecord = window.verifyPlanData ? 
                        window.verifyPlanData.find(v => {
                            // ä½¿ç”¨planHashè¿›è¡Œç²¾ç¡®åŒ¹é…
                            const vPlanHash = v.planHash || v.generationConditions?.planHash;
                            if (vPlanHash && plan.planHash && vPlanHash === plan.planHash) {
                                return true;
                            }
                            
                            // å¤‡ç”¨åŒ¹é…ï¼šæ³¨æ•°å’Œæ—¶é—´æˆ³
                            return v.betCount === plan.betCount && 
                                   plan.key.includes(v.timestamp || v.planId || '');
                        }) : null;
                    
                    let cellContent = '';
                    if (verifyRecord) {
                        // åŠ¨æ€åˆ¤å®šå½“å‰è¡Œæ˜¯å¦å‘½ä¸­ï¼ˆåŸºäºå½“å‰æ˜¾ç¤ºæœŸæ•°çš„å¼€å¥–å·ç ï¼‰
                        const drawNumbers = Array.isArray(item.rec.data) ? item.rec.data.slice(0, 5).map(n => parseInt(n)) : [];
                        let isHit = false;
                        const planNums = Array.isArray(verifyRecord.planNumbers) ? verifyRecord.planNumbers : [];
                        for (const numberStr of planNums) {
                            let numbers;
                            if (Array.isArray(numberStr)) {
                                numbers = numberStr.map(n => parseInt(n));
                            } else if (typeof numberStr === 'string') {
                                const parts = numberStr.split(/[\s,]+/).filter(Boolean);
                                numbers = parts.map(n => parseInt(n));
                            } else {
                                continue;
                            }
                            if (numbers.length === 5 && numbers.every((n, idx) => !isNaN(n) && drawNumbers[idx] !== undefined && n === drawNumbers[idx])) {
                                isHit = true;
                                break;
                            }
                        }
                        
                        const cellResult = isHit ? 'ä¸­' : 'æŒ‚';
                        const resultClass = isHit ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                        
                        // ä½¿ç”¨ç®€æ´æ–‡æ¡ˆï¼Œä»…åŒ…å«é€‰å·æ¡ä»¶ä¸å®¹é”™ï¼ˆä¸æ‹¼æ¥ä¸­å¥–å·ç ï¼‰
                        let conditionText = buildConciseConditionText(verifyRecord);
                        
                        cellContent = `
                            <div class="relative plan-cell-container" data-plan-key="${plan.key}">
                                <div class="text-sm ${resultClass} plan-result">
                                    ${cellResult}
                                </div>
                            </div>
                        `;
                    } else {
                        // æ²¡æœ‰éªŒè¯è®°å½•æ—¶ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
                        cellContent = '';
                    }
                    
                    planCell.innerHTML = cellContent;
                    row.appendChild(planCell);
                });
            } else {
                // æ²¡æœ‰éªŒè¯è®¡åˆ’æ—¶ï¼Œæ·»åŠ ç©ºçŠ¶æ€æç¤ºå•å…ƒæ ¼
                const emptyStateCell = document.createElement("td");
                emptyStateCell.className = "px-3 py-2 text-center border-r border-gray-200 empty-state-cell";
                emptyStateCell.innerHTML = `<div class="text-gray-400 text-sm">æœªæ·»åŠ è®¡åˆ’</div>`;
                row.appendChild(emptyStateCell);
            }
            
            tbody.appendChild(row);
        });
        
        console.log('éªŒè¯è®¡åˆ’é¡µé¢è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå…±', s.length, 'è¡Œæ•°æ®');
        updateStatistics();
        updatePaginationControls();
        
        // åŒæ­¥æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼
        if (typeof window.updateSinglePeriodTable === 'function') {
            console.log('å¤šæœŸéªŒè¯æ›´æ–°å®Œæˆï¼ŒåŒæ­¥æ›´æ–°å•æœŸéªŒè¯è¡¨æ ¼');
            window.updateSinglePeriodTable();
        }
    }
    
    // æ„å»ºè®¡åˆ’æ¡ä»¶æ–‡æœ¬ï¼ˆç”¨äºåˆ—å¤´å’Œå•å…ƒæ ¼çš„tooltipï¼‰
    function buildConciseConditionText(verifyRecord) {
        const conditions = (verifyRecord && verifyRecord.generationConditions) ? verifyRecord.generationConditions : {};
        const groups = Array.isArray(conditions.groups) ? conditions.groups : [];

        // ä¼˜å…ˆä½¿ç”¨ç»„ä¿¡æ¯ï¼Œä»…æ˜¾ç¤ºå®é™…è®°å½•çš„å†…å®¹
        if (groups.length > 0) {
            const lines = groups
                .map(g => {
                    const numbers = Array.isArray(g.selectedNumbers) ? g.selectedNumbers : [];
                    const damas = Array.isArray(g.selectedDamas) ? g.selectedDamas : [];
                    const tmin = typeof g.toleranceMin === 'number' ? g.toleranceMin : 0;
                    const tmax = typeof g.toleranceMax === 'number' ? g.toleranceMax : 0;

                    const parts = [];
                    if (numbers.length) parts.push(numbers.join(','));
                    if (damas.length) parts.push(`ä¸­${damas.join(',')}èƒ†`);
                    if ((tmin || tmax) && !(tmin === 0 && tmax === 0)) {
                        const maxVal = (typeof tmax === 'number' && tmax >= tmin) ? tmax : tmin;
                        parts.push(`å®¹é”™${tmin}-${maxVal}`);
                    }
                    const text = parts.join('ï¼Œ');
                    return text;
                })
                .filter(line => line && line.trim().length > 0);
            if (lines.length > 0) return lines.join('\n');
        }

        // æ²¡æœ‰ç»„ä¿¡æ¯æ—¶ï¼Œä»…æ˜¾ç¤ºå·²è®°å½•çš„å·ç /æ¨¡å—å®¹é”™ï¼Œç©ºåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        const selectedNumbers = Array.isArray(conditions.selectedNumbers) ? conditions.selectedNumbers : [];
        const moduleTolMin = (typeof conditions.moduleToleranceMin === 'number') ? conditions.moduleToleranceMin : 0;
        const moduleTolMax = (typeof conditions.moduleToleranceMax === 'number') ? conditions.moduleToleranceMax : 0;

        const parts = [];
        if (selectedNumbers.length) parts.push(selectedNumbers.join(','));
        if ((moduleTolMin || moduleTolMax) && !(moduleTolMin === 0 && moduleTolMax === 0)) {
            const maxVal = (typeof moduleTolMax === 'number' && moduleTolMax >= moduleTolMin) ? moduleTolMax : moduleTolMin;
            parts.push(`å®¹é”™${moduleTolMin}-${maxVal}`);
        }
        return parts.join('ï¼Œ');
    }

    function buildPlanConditionText(verifyRecord) {
        const conditions = (verifyRecord && verifyRecord.generationConditions) ? verifyRecord.generationConditions : {};
        const selectedNumbers = Array.isArray(conditions.selectedNumbers) ? conditions.selectedNumbers : [];
        const betMultiple = (conditions && conditions.betMultiple) ? conditions.betMultiple : 1;
        const periods = (conditions && conditions.periods) ? conditions.periods : 1;
        const moduleType = (conditions && conditions.moduleType) ? conditions.moduleType : 'äº”æ˜Ÿåšå·';
        const generatedTime = conditions.generatedAt ? new Date(conditions.generatedAt).toLocaleString() : 'æœªè®°å½•';
        const moduleTolMin = (conditions && typeof conditions.moduleToleranceMin === 'number') ? conditions.moduleToleranceMin : 0;
        const moduleTolMax = (conditions && typeof conditions.moduleToleranceMax === 'number') ? conditions.moduleToleranceMax : 0;
        const groups = Array.isArray(conditions.groups) ? conditions.groups : [];

        let groupsText = '';
        if (groups.length > 0) {
            groups.forEach((g, idx) => {
                const sn = Array.isArray(g.selectedNumbers) && g.selectedNumbers.length > 0 ? g.selectedNumbers.join(',') : 'æœªé€‰';
                const sd = Array.isArray(g.selectedDamas) && g.selectedDamas.length > 0 ? g.selectedDamas.join(',') : 'æœªé€‰';
                const tmin = (typeof g.toleranceMin === 'number') ? g.toleranceMin : 0;
                const tmax = (typeof g.toleranceMax === 'number') ? g.toleranceMax : 0;
                groupsText += `\nç»„${idx + 1}: æ•°å­—[${sn}] èƒ†ç [${sd}] å®¹é”™${tmin}-${tmax}`;
            });
        } else {
            groupsText = '\næœªè®°å½•ç»„æ¡ä»¶';
        }

        const verificationDetails = verifyRecord && verifyRecord.verificationDetails ? verifyRecord.verificationDetails : {};
        const totalWins = verificationDetails.totalWins || 0;
        const totalPeriods = verificationDetails.totalPeriods || 0;
        const winRate = verificationDetails.winRate || '0%';
        const numbersText = selectedNumbers.length > 0 ? selectedNumbers.join(', ') : 'æœªè®°å½•';

        const text = `ğŸ“Š ${moduleType}\n\nğŸ”§ æ¨¡å—å®¹é”™: ${moduleTolMin}-${moduleTolMax}\nğŸ§© æ¡ä»¶ç»„:${groupsText}\n\nğŸ”¢ é€‰æ‹©å·ç : ${numbersText}\nğŸ“ˆ æŠ•æ³¨å€æ•°: ${betMultiple}å€\nğŸ“… æŠ•æ³¨æœŸæ•°: ${periods}æœŸ\nâ° ç”Ÿæˆæ—¶é—´: ${generatedTime}\n\nğŸ“ˆ å…¨æœŸéªŒè¯ç»“æœ:\nğŸ¯ æ€»ä¸­å¥–: ${totalWins}/${totalPeriods}æœŸ\nğŸ“Š ä¸­å¥–ç‡: ${winRate}`;
        return text;
    }

    // æ˜¾ç¤ºè®¡åˆ’æ‚¬åœæç¤º
    function showPlanTooltip(element, planKey, conditionText) {
        // ç§»é™¤ç°æœ‰çš„æç¤ºæ¡†
        hidePlanTooltip();
        
        const tooltip = document.createElement('div');
        tooltip.id = 'planTooltip';
        tooltip.className = 'absolute bg-gray-800 text-white text-xs rounded-lg z-50 shadow-lg';
        tooltip.style.cssText = `
            position: fixed;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            font-size: 13px;
            border-radius: 10px;
            padding: 10px 12px; /* ç¨å°çš„å†…è¾¹è·ä»¥æ›´è´´åˆæ–‡å­— */
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            max-width: 280px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            line-height: 1.35; /* ç¨ç´§å‡‘çš„è¡Œé«˜ */
            pointer-events: auto;
            cursor: default;
            max-height: 50vh; /* åŠ¨æ€é«˜åº¦ï¼Œè§†å£ä¸€åŠä¸ºä¸Šé™ */
            overflow: auto; /* è¶…å‡ºæ—¶æ»šåŠ¨ */
        `;
        
        // è®¾ç½®æç¤ºå†…å®¹
        const decodedText = conditionText.replace(/\\n/g, '\n').replace(/\\'/g, "'");
        // æ„å»ºå†…å®¹ï¼šæ¡ä»¶ä»…æ˜¾ç¤ºå·²è®°å½•é¡¹ï¼›åˆ é™¤æŒ‰é’®æ— â€œâœ•â€ï¼Œå¹¶ä½¿æŒ‰é’®é«˜åº¦ç•¥å¤§äºæ–‡å­—
        tooltip.innerHTML = `
            <div style="margin-bottom: 8px; pointer-events: none; white-space: pre-line;">${decodedText}</div>
            <div style="text-align: center; margin-top: 8px;">
                <button onclick="deletePlanColumn('${planKey}')"
                        style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;line-height:1.2;min-height:24px;pointer-events:auto;display:inline-flex;align-items:center;justify-content:center;"
                        onmouseover="this.style.background='#dc2626'"
                        onmouseout="this.style.background='#ef4444'">
                    åˆ é™¤æ­¤åˆ—
                </button>
            </div>
        `;
        // æ‚¬åœæ§åˆ¶ï¼šè¿›å…¥å¼¹çª—å–æ¶ˆéšè—ï¼Œç¦»å¼€å¼¹çª—å»¶è¿Ÿéšè—
        tooltip.addEventListener('mouseenter', cancelHidePlanTooltip, { passive: true });
        tooltip.addEventListener('mouseleave', () => scheduleHidePlanTooltip(100), { passive: true });
        
        document.body.appendChild(tooltip);
        
        // è®¡ç®—ä½ç½®
        setTimeout(() => {
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 8;
            
            // è¾¹ç•Œæ£€æŸ¥
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 8;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }, 0);
    }
    
    // éšè—è®¡åˆ’æ‚¬åœæç¤º
    function hidePlanTooltip() {
        const tooltip = document.getElementById('planTooltip');
        if (tooltip) {
            tooltip.remove();
        }
    }

    // å°† tooltip ç›¸å…³å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¿®å¤ ReferenceError
    window.showPlanTooltip = showPlanTooltip;
    window.hidePlanTooltip = hidePlanTooltip;
    window.deletePlanColumn = deletePlanColumn;
    window.scheduleHidePlanTooltip = scheduleHidePlanTooltip;
    window.cancelHidePlanTooltip = cancelHidePlanTooltip;
    
    // Tooltip å»¶è¿Ÿéšè—æ§åˆ¶ï¼Œé¿å…ä»è¡¨å¤´åˆ°å¼¹çª—çš„ç§»åŠ¨è¿‡ç¨‹ä¸­è¢«ç«‹å³å…³é—­
    window._planTooltipHideTimer = null;
    function scheduleHidePlanTooltip(delay = 220) {
        clearTimeout(window._planTooltipHideTimer);
        window._planTooltipHideTimer = setTimeout(() => {
            window._planTooltipHideTimer = null;
            hidePlanTooltip();
        }, delay);
    }
    function cancelHidePlanTooltip() {
        clearTimeout(window._planTooltipHideTimer);
        window._planTooltipHideTimer = null;
    }

    // æ·»åŠ å…¨å±€é¼ æ ‡ç§»åŠ¨ç›‘å¬ï¼šæœªåœ¨è¡¨å¤´ã€å•å…ƒæ ¼æˆ–å¼¹çª—ä¸Šæ—¶ï¼Œå»¶è¿Ÿéšè—ï¼›å¦åˆ™å–æ¶ˆéšè—
    document.addEventListener('mousemove', function(e) {
        const tooltip = document.getElementById('planTooltip');
        if (tooltip) {
            const tooltipRect = tooltip.getBoundingClientRect();
            const isOverTooltip = e.clientX >= tooltipRect.left && e.clientX <= tooltipRect.right &&
                                 e.clientY >= tooltipRect.top && e.clientY <= tooltipRect.bottom;
            
            const planCell = e.target.closest('.plan-cell-container');
            const headerTrigger = e.target.closest('.plan-header-trigger');
            if (!planCell && !headerTrigger && !isOverTooltip) {
                scheduleHidePlanTooltip(100);
            } else {
                cancelHidePlanTooltip();
            }
        }
    });
    
    // åˆ é™¤éªŒè¯è®¡åˆ’åˆ—
    function deletePlanColumn(planKey) {
        // å…ˆéšè—æç¤ºæ¡†
        hidePlanTooltip();
        
        // ç§»é™¤ç¡®è®¤å¯¹è¯æ¡†ï¼Œç›´æ¥åˆ é™¤
        
        console.log('åˆ é™¤éªŒè¯è®¡åˆ’åˆ—:', planKey);
        
        // ä»éªŒè¯è®¡åˆ’æ•°æ®ä¸­åˆ é™¤å¯¹åº”çš„è®°å½•
        if (window.verifyPlanData) {
            const originalLength = window.verifyPlanData.length;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæ—§æ ¼å¼é”®ï¼ˆå½¢å¦‚ "Næ³¨_timestamp"ï¼‰
            const looksLikeLegacyKey = typeof planKey === 'string' && planKey.includes('æ³¨_');
            
            // ç›®æ ‡è®¡åˆ’IDï¼ˆç”¨äºåŒæ­¥åˆ é™¤å­˜å‚¨ï¼‰
            let targetPlanIds = [];
            
            if (!looksLikeLegacyKey) {
                // æ–°é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨ planHash ç²¾ç¡®åŒ¹é…
                const keyHash = planKey;
                const matchByKey = (rec) => {
                    const vHash = rec.planHash || (rec.generationConditions && rec.generationConditions.planHash);
                    if (vHash && keyHash && vHash === keyHash) return true;
                    // å½“æ²¡æœ‰ planHash æ—¶ï¼ŒæŒ‰å†…å®¹é”®åŒ¹é…
                    const conditions = rec.generationConditions || {};
                    const numbers = Array.isArray(conditions.selectedNumbers) ? [...conditions.selectedNumbers].sort().join(',') : '';
                    const betMultiple = conditions.betMultiple || 1;
                    const periods = conditions.periods || 1;
                    const contentKey = `${rec.betCount}æ³¨_${numbers}_${betMultiple}_${periods}`;
                    return keyHash === contentKey;
                };
                
                const toDelete = window.verifyPlanData.filter(matchByKey);
                targetPlanIds = toDelete.map(r => r.planId).filter(Boolean);
                
                // è¿‡æ»¤æ‰åŒ¹é…çš„è®°å½•
                window.verifyPlanData = window.verifyPlanData.filter(rec => !matchByKey(rec));
            } else {
                // å…¼å®¹æ—§é€»è¾‘ï¼šbetCount + æ—¶é—´æˆ³åŒ¹é…
                const planInfo = planKey.split('æ³¨_');
                const betCount = parseInt(planInfo[0], 10);
                const timestampPart = planInfo[1];
                
                window.verifyPlanData = window.verifyPlanData.filter(rec => {
                    const planTimestamp = rec.timestamp || rec.planId || '';
                    const isTarget = rec.betCount === betCount && 
                        (timestampPart === planTimestamp.toString() || 
                         planKey.includes(planTimestamp.toString()));
                    if (isTarget && rec.planId) {
                        targetPlanIds.push(rec.planId);
                    }
                    return !isTarget;
                });
            }
            
            const deletedCount = originalLength - window.verifyPlanData.length;
            
            if (deletedCount > 0) {
                // åŒæ­¥åˆ é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„è®¡åˆ’
                if (window.PlanStorageManager && typeof window.PlanStorageManager.deletePlan === 'function' && targetPlanIds.length > 0) {
                    targetPlanIds.forEach(pid => {
                        try {
                            window.PlanStorageManager.deletePlan(pid);
                        } catch (err) {
                            console.warn('åˆ é™¤æœ¬åœ°å­˜å‚¨è®¡åˆ’å¤±è´¥:', pid, err);
                        }
                    });
                }
                
                console.log(`âœ… åˆ é™¤æˆåŠŸ: ${originalLength} -> ${window.verifyPlanData.length} æ¡è®°å½•`);
                
                // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                notification.textContent = 'è®¡åˆ’åˆ é™¤æˆåŠŸ';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 2000);
            } else {
                console.error('âŒ æœªæ‰¾åˆ°éœ€è¦åˆ é™¤çš„è®¡åˆ’ï¼ŒplanKey:', planKey);
                alert('æœªæ‰¾åˆ°éœ€è¦åˆ é™¤çš„è®¡åˆ’ï¼Œè¯·é‡è¯•');
                return;
            }
        }
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        window.updateVerifyPlanTable();
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStatistics();
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆåŸºäºå½“å‰å¯è§æœŸæ•°ä¸é¡µé¢ä¸Šæ˜¾ç¤ºçš„è®¡åˆ’ç»“æœï¼‰
    function updateStatistics() {
        // é¡¶éƒ¨â€œå…± X æ¡è®°å½•â€ä¿ç•™ä¸ºå½“å‰è®¡åˆ’æ€»æ•°ï¼ˆè®°å½•æ•°ï¼‰
        const totalPlanRecords = Array.isArray(window.verifyPlanData)
            ? window.verifyPlanData.filter(item => item && item.betCount > 0).length
            : 0;
        if (verifyDataCount) verifyDataCount.textContent = `å…± ${totalPlanRecords} æ¡è®°å½•`;

        const tbody = document.getElementById('verifyPlanTableBody');
        if (!tbody) {
            if (totalPeriods) totalPeriods.textContent = 0;
            if (successCount) successCount.textContent = 0;
            if (failCount) failCount.textContent = 0;
            return;
        }

        // å½“å‰å¯è§æœŸæ•°ï¼šè¡¨ä½“ä¸­æœŸå·åˆ—æ•°é‡
        const periodCells = tbody.querySelectorAll('td.fixed-width-period');
        const visiblePeriods = periodCells ? periodCells.length : 0;

        // å‘½ä¸­/æœªä¸­ï¼šç»Ÿè®¡å½“å‰é¡µæ¸²æŸ“å‡ºæ¥çš„ .plan-result æ–‡æœ¬
        let success = 0;
        let fail = 0;
        const resultNodes = tbody.querySelectorAll('.plan-result');
        resultNodes.forEach(node => {
            const txt = (node.textContent || '').trim();
            if (txt === 'ä¸­') success++;
            else if (txt === 'æŒ‚') fail++;
        });

        if (totalPeriods) totalPeriods.textContent = visiblePeriods;
        if (successCount) successCount.textContent = success;
        if (failCount) failCount.textContent = fail;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œåˆå§‹æ•°æ®åŒæ­¥å’Œè¡¨æ ¼åˆå§‹åŒ–
    async function initVerifyPlanPage() {
        console.log('=== åˆå§‹åŒ–éªŒè¯è®¡åˆ’é¡µé¢ ===');
        console.log('åˆå§‹åŒ–å‰æ•°æ®çŠ¶æ€:');
        console.log('- window.historyData:', window.historyData ? window.historyData.length : 0, 'æ¡');
        console.log('- window.r:', window.r ? window.r.length : 0, 'æ¡');
        console.log('- window.verifyPlanData:', window.verifyPlanData ? window.verifyPlanData.length : 0, 'æ¡');
        
        // å…ˆå°è¯•åŒæ­¥æ•°æ®
        if (typeof window.syncDataToVerifyPlan === 'function') {
            console.log('è°ƒç”¨syncDataToVerifyPlanå‡½æ•°');
            window.syncDataToVerifyPlan();
        } else {
            console.log('syncDataToVerifyPlanå‡½æ•°ä¸å­˜åœ¨');
        }
        
        // ç„¶åæ›´æ–°è¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
        await window.updateVerifyPlanTable();
        updateStatistics();
        updatePaginationControls();
        
        // å¦‚æœä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œå¯åŠ¨æ•°æ®è·å–
        if ((!window.historyData || window.historyData.length === 0) && 
            (!window.r || window.r.length === 0)) {
            console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šæ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œå¯åŠ¨å†å²æ•°æ®è·å–');
            
            // å¤šé‡è·å–ç­–ç•¥
            let dataObtained = false;
            
            // ç­–ç•¥1ï¼šè·å–å†å²æ•°æ®
            if (typeof fetchHistoryData === 'function') {
                try {
                    const result = await fetchHistoryData();
                    if (result && result.success) {
                        console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå†å²æ•°æ®è·å–æˆåŠŸï¼Œé‡æ–°åˆå§‹åŒ–é¡µé¢');
                        window.syncDataToVerifyPlan();
                        await updateVerifyPlanTable();
                        updateStatistics();
                        dataObtained = true;
                    }
                } catch (error) {
                    console.error('éªŒè¯è®¡åˆ’é¡µé¢ï¼šè·å–å†å²æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // ç­–ç•¥2ï¼šå¦‚æœå†å²æ•°æ®è·å–å¤±è´¥ï¼Œå°è¯•APIæ•°æ®
            if (!dataObtained && typeof fetchApiData === 'function') {
                try {
                    console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå°è¯•è·å–APIæ•°æ®');
                    await fetchApiData();
                    if ((window.historyData && window.historyData.length > 0) || (window.r && window.r.length > 0)) {
                        console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šAPIæ•°æ®è·å–æˆåŠŸ');
                        window.syncDataToVerifyPlan();
                        await updateVerifyPlanTable();
                        updateStatistics();
                        dataObtained = true;
                    }
                } catch (error) {
                    console.error('éªŒè¯è®¡åˆ’é¡µé¢ï¼šAPIæ•°æ®è·å–å¤±è´¥:', error);
                }
            }
            
            // ç­–ç•¥3ï¼šå¯åŠ¨å®šæ—¶æ•°æ®è·å–
            if (!dataObtained && typeof startVerifyPlanDataFetch === 'function') {
                console.log('éªŒè¯è®¡åˆ’é¡µé¢ï¼šå¯åŠ¨å®šæ—¶æ•°æ®è·å–');
                startVerifyPlanDataFetch();
            }
        }
    }
    
    // æ‰§è¡Œåˆå§‹åŒ–
    initVerifyPlanPage();
    
    // åˆå§‹åŒ–æœŸæ•°é€‰æ‹©æŒ‰é’®çŠ¶æ€
    setTimeout(() => {
        updatePaginationControls();
    }, 500);
    
    // æ·»åŠ å®æ—¶æ›´æ–°æœºåˆ¶
    let verifyPlanUpdateInterval;
    function startVerifyPlanRealTimeUpdate() {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (verifyPlanUpdateInterval) {
            clearInterval(verifyPlanUpdateInterval);
        }
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦æ›´æ–°è¡¨æ ¼
        verifyPlanUpdateInterval = setInterval(() => {
            if (window.verifyPlanData && window.verifyPlanData.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å¼€å¥–æ•°æ®éœ€è¦æ›´æ–°éªŒè¯ç»“æœ
                let needUpdate = false;
                window.verifyPlanData.forEach(plan => {
                    if (!plan.result && window.historyData) {
                        const periodData = window.historyData.find(h => h.period === plan.period);
                        if (periodData && periodData.data && periodData.data.length >= 10) {
                            needUpdate = true;
                        }
                    }
                });
                
                if (needUpdate) {
                    console.log('æ£€æµ‹åˆ°æ–°çš„å¼€å¥–æ•°æ®ï¼Œæ›´æ–°éªŒè¯è®¡åˆ’è¡¨æ ¼');
                    window.updateVerifyPlanTable();
                }
            }
        }, 30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    function stopVerifyPlanRealTimeUpdate() {
        if (verifyPlanUpdateInterval) {
            clearInterval(verifyPlanUpdateInterval);
            verifyPlanUpdateInterval = null;
        }
    }
    
    // å¯åŠ¨å®æ—¶æ›´æ–°
    startVerifyPlanRealTimeUpdate();
    
    // é¡µé¢éšè—æ—¶åœæ­¢æ›´æ–°ï¼Œæ˜¾ç¤ºæ—¶é‡æ–°å¯åŠ¨
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopVerifyPlanRealTimeUpdate();
        } else {
            startVerifyPlanRealTimeUpdate();
        }
    });
    
    // ç›‘å¬é¡µé¢æ˜¾ç¤ºäº‹ä»¶ï¼Œç¡®ä¿åˆ‡æ¢åˆ°éªŒè¯è®¡åˆ’é¡µé¢æ—¶æ•°æ®æ˜¯æœ€æ–°çš„
    const verifyPlanPage = document.getElementById('verifyPlanPage');
    if (verifyPlanPage) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!verifyPlanPage.classList.contains('hidden')) {
                        console.log('éªŒè¯è®¡åˆ’é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®');
                        setTimeout(() => {
                            initVerifyPlanPage();
                        }, 100);
                    }
                }
            });
        });
        observer.observe(verifyPlanPage, { attributes: true });
    }

    // äº¤é›†æ‹¼æ¥åŠŸèƒ½
    function initIntersectionCutPage() {
        // åˆå§‹åŒ–åŠŸèƒ½åˆ‡æ¢
        initFunctionSwitch();
        
        // åˆå§‹åŒ–å®¹é”™æŒ‰é’®
        initToleranceButtons();
        

        
        // ç»‘å®šç²˜è´´æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.paste-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const moduleId = this.getAttribute('data-module');
                const textarea = document.querySelector(`.module-textarea[data-module="${moduleId}"]`);
                
                try {
                    const text = await navigator.clipboard.readText();
                    textarea.value = text;
                    updateModuleCount(moduleId);
                } catch (err) {
                    console.error('ç²˜è´´å¤±è´¥:', err);
                    alert('ç²˜è´´å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
                }
            });
        });

        // ç»‘å®šæ¸…é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.clear-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const moduleId = this.getAttribute('data-module');
                const textarea = document.querySelector(`.module-textarea[data-module="${moduleId}"]`);
                textarea.value = '';
                updateModuleCount(moduleId);
            });
        });

        // ç§»é™¤è¾“å…¥æ¡†å®æ—¶ç›‘å¬ï¼Œæ³¨æ•°åªåœ¨ç‚¹å‡»åšå·æ—¶æ›´æ–°
        // document.querySelectorAll('.module-textarea').forEach(textarea => {
        //     textarea.addEventListener('input', function() {
        //         const moduleId = this.getAttribute('data-module');
        //         updateModuleCount(moduleId);
        //     });
        // });

        // ç»‘å®šåšå·æŒ‰é’®äº‹ä»¶
        const generateBtn = document.getElementById('generateIntersectionBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', generateIntersection);
        }

        // ç»‘å®šå¤åˆ¶ç»“æœæŒ‰é’®äº‹ä»¶
        const copyResultBtn = document.getElementById('copyResultBtn');
        if (copyResultBtn) {
            copyResultBtn.addEventListener('click', copyResult);
        }
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°æ€»è®¡æ•°
        updateTotalCount();
    }

    // åˆå§‹åŒ–åŠŸèƒ½åˆ‡æ¢
    function initFunctionSwitch() {
        const intersectionBtn = document.getElementById('intersectionModeBtn');
        const intersectionContent = document.getElementById('intersectionContent');

        if (intersectionBtn && intersectionContent) {
            intersectionBtn.addEventListener('click', function() {
                // åˆ‡æ¢åˆ°å·ç äº¤é›†
                intersectionBtn.classList.add('active');
                intersectionContent.classList.remove('hidden');
            });
        }
    }

    // åˆå§‹åŒ–å®¹é”™æŒ‰é’®
    function initToleranceButtons() {
        let selectedTolerance = 0;
        
        document.querySelectorAll('.tolerance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tolerance = parseInt(this.getAttribute('data-tolerance'));
                
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                document.querySelectorAll('.tolerance-btn').forEach(b => b.classList.remove('active'));
                
                if (selectedTolerance === tolerance) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„æŒ‰é’®ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                    selectedTolerance = 0;
                } else {
                    // é€‰æ‹©æ–°çš„å®¹é”™å€¼
                    selectedTolerance = tolerance;
                    this.classList.add('active');
                }
            });
        });
    }

    // æ›´æ–°æ¨¡å—æ³¨æ•°ç»Ÿè®¡
    function updateModuleCount(moduleId) {
        const textarea = document.querySelector(`.module-textarea[data-module="${moduleId}"]`);
        const countElement = document.querySelector(`.module-count[data-module="${moduleId}"]`);
        
        if (textarea && countElement) {
            const content = textarea.value.trim();
            if (content) {
                // è®¡ç®—å®é™…çš„å·ç æ•°é‡
                let totalNumbers = 0;
                const lines = content.split('\n').filter(line => line.trim());
                
                lines.forEach(line => {
                    // è§£ææ¯è¡Œçš„å·ç ï¼Œæ”¯æŒé€—å·åˆ†éš”
                    const numbers = line.split(',').map(n => n.trim()).filter(n => n);
                    totalNumbers += numbers.length;
                });
                
                countElement.textContent = `${totalNumbers}æ³¨`;
            } else {
                countElement.textContent = '0æ³¨';
            }
        }
        
        // æ›´æ–°å…¨å±€æ€»è®¡æ•°
        updateTotalCount();
    }

    // æ›´æ–°å…¨å±€æ€»è®¡æ•°
    function updateTotalCount() {
        const resultCount = document.getElementById('resultCount');
        if (!resultCount) return;
        
        let totalNumbers = 0;
        
        // ç»Ÿè®¡æ‰€æœ‰æ¨¡å—çš„å·ç æ•°é‡
        for (let i = 1; i <= 8; i++) {
            const textarea = document.querySelector(`.module-textarea[data-module="${i}"]`);
            if (textarea && textarea.value.trim()) {
                const content = textarea.value.trim();
                const lines = content.split('\n').filter(line => line.trim());
                
                lines.forEach(line => {
                    // è§£ææ¯è¡Œçš„å·ç ï¼Œæ”¯æŒé€—å·åˆ†éš”
                    const numbers = line.split(',').map(n => n.trim()).filter(n => n);
                    totalNumbers += numbers.length;
                });
            }
        }
        
        resultCount.textContent = `å…±${totalNumbers}æ³¨`;
    }

    // ç”Ÿæˆäº¤é›†
    function generateIntersection() {
        // åœ¨åšå·æ—¶æ›´æ–°æ‰€æœ‰æ¨¡å—çš„æ³¨æ•°
        for (let i = 1; i <= 8; i++) {
            updateModuleCount(i);
        }
        
        const modules = [];
        
        // æ”¶é›†æ‰€æœ‰æ¨¡å—çš„æ•°æ®
        for (let i = 1; i <= 8; i++) {
            const textarea = document.querySelector(`.module-textarea[data-module="${i}"]`);
            if (textarea && textarea.value.trim()) {
                const lines = textarea.value.trim().split('\n').filter(line => line.trim());
                const moduleNumbers = [];
                
                lines.forEach(line => {
                    // è§£ææ¯è¡Œçš„å·ç ï¼Œæ”¯æŒé€—å·åˆ†éš”
                    const numbers = line.split(',').map(n => n.trim()).filter(n => n);
                    moduleNumbers.push(...numbers);
                });
                
                if (moduleNumbers.length > 0) {
                    // å»é‡
                    const uniqueNumbers = [...new Set(moduleNumbers)];
                    modules.push(uniqueNumbers);
                }
            }
        }

        if (modules.length === 0) {
            alert('è¯·è‡³å°‘åœ¨ä¸€ä¸ªæ¨¡å—ä¸­è¾“å…¥æ•°æ®');
            return;
        }

        if (modules.length === 1) {
            // åªæœ‰ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºè¯¥æ¨¡å—çš„æ•°æ®
            displayResult(modules[0]);
            return;
        }

        // è·å–é€‰ä¸­çš„å®¹é”™å€¼
        const selectedToleranceBtn = document.querySelector('.tolerance-btn.active');
        const toleranceValue = selectedToleranceBtn ? parseInt(selectedToleranceBtn.getAttribute('data-tolerance')) : 0;

        let result = [];

        if (toleranceValue === 0) {
            // ä¸¥æ ¼äº¤é›†ï¼šå¿…é¡»åœ¨æ‰€æœ‰æ¨¡å—ä¸­éƒ½å‡ºç°
            result = modules[0];
            for (let i = 1; i < modules.length; i++) {
                result = result.filter(num => modules[i].includes(num));
            }
        } else {
            // å®¹é”™äº¤é›†ï¼šå…è®¸åœ¨æŒ‡å®šæ•°é‡çš„æ¨¡å—ä¸­ç¼ºå¤±
            const allNumbers = [...new Set(modules.flat())];
            
            allNumbers.forEach(num => {
                let appearCount = 0;
                modules.forEach(module => {
                    if (module.includes(num)) {
                        appearCount++;
                    }
                });
                
                // å¦‚æœç¼ºå¤±çš„æ¨¡å—æ•°é‡ä¸è¶…è¿‡å®¹é”™å€¼ï¼Œåˆ™åŒ…å«è¯¥å·ç 
                const missingCount = modules.length - appearCount;
                if (missingCount <= toleranceValue) {
                    result.push(num);
                }
            });
        }

        displayResult(result);
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResult(numbers) {
        // æ’åºç»“æœ
        numbers.sort((a, b) => {
            const numA = parseInt(a);
            const numB = parseInt(b);
            return numA - numB;
        });

        // æ˜¾ç¤ºç»“æœ
        const resultDisplay = document.getElementById('resultDisplay');
        const resultCount = document.getElementById('resultCount');
        
        if (resultDisplay && resultCount) {
            // ä¿å­˜å®Œæ•´æ•°æ®åˆ°dataå±æ€§ï¼Œç”¨äºå¤åˆ¶
            resultDisplay.setAttribute('data-full-result', numbers.join(','));
            
            // åªæ˜¾ç¤ºå‰500æ³¨
            const displayNumbers = numbers.slice(0, 500);
            const displayText = displayNumbers.join(',');
            
            // å¦‚æœè¶…è¿‡500æ³¨ï¼Œæ·»åŠ çœç•¥æç¤º
            if (numbers.length > 500) {
                resultDisplay.value = displayText + '...ï¼ˆæ˜¾ç¤ºå‰500æ³¨ï¼Œç‚¹å‡»å¤åˆ¶å¯å¤åˆ¶å…¨éƒ¨ï¼‰';
            } else {
                resultDisplay.value = displayText;
            }
            
            resultCount.textContent = `å…±${numbers.length}æ³¨`;
        }
    }

    // å¤åˆ¶ç»“æœ
    async function copyResult() {
        const resultDisplay = document.getElementById('resultDisplay');
        if (resultDisplay && resultDisplay.value) {
            try {
                // ä¼˜å…ˆä»data-full-resultå±æ€§è·å–å®Œæ•´æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ˜¾ç¤ºçš„å†…å®¹
                const fullResult = resultDisplay.getAttribute('data-full-result');
                const textToCopy = fullResult || resultDisplay.value;
                
                await navigator.clipboard.writeText(textToCopy);
                
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåé¦ˆ
                const copyBtn = document.getElementById('copyResultBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                copyBtn.classList.add('bg-gray-500');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('bg-gray-500');
                    copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }, 1000);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        } else {
            alert('æ²¡æœ‰ç»“æœå¯å¤åˆ¶');
        }
    }


    
    // ç”Ÿæˆæ‹¼æ¥ç»“æœ - å·²ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
    
// ç¬¬ä¸€ç»„é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤
// generateIntersectionCombinationså‡½æ•°å·²ç§»è‡³æ–‡ä»¶åé¢


    
// å…¶ä»–é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬

// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬

// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
    
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
    
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
            
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
        
        // é€‰æ‹©å‰ starLevel ä¸ªâ€œéç©ºä½ç½®â€ç”¨äºç”Ÿæˆæ’åˆ—ï¼Œé¿å…ç©ºä½ç½®è¢«æˆªå–å¯¼è‡´å°‘æ³¨
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
        // é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
        
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬
// é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ï¼Œä¿ç•™åœ¨æ–‡ä»¶åé¢çš„ç‰ˆæœ¬

// ä½¿ç”¨åšå·æ¨¡å—ç»“æœè¿›è¡Œç­›é€‰ï¼š
// è¦æ±‚ï¼šå¯¹æ¯ä¸ªå·²äº§å‡ºç»“æœçš„æ¨¡å—ï¼Œå­˜åœ¨è‡³å°‘ä¸€æ¡ç»“æœï¼Œä½¿å¾—å…¶é€‰ä¸­ä½ç½®ä¸Šçš„æ•°å­—ä¸æ‹¼æ¥ç»„åˆå¯¹åº”ä½ç½®ç›¸åŒ
function filterByFiveStarModules(combos, starLevel) {
        if (!Array.isArray(combos) || combos.length === 0) return combos;
        if (!window.moduleStates || Object.keys(window.moduleStates).length === 0) return combos;
        
        // æ”¶é›†æ¯ä¸ªæ¨¡å—çš„çº¦æŸé›†åˆï¼ˆæ•°ç»„ï¼‰ï¼Œæ¯ä¸ªçº¦æŸæ˜¯ Map<position(1-based), numberString>
        const modulesConstraints = [];
        Object.keys(window.moduleStates).forEach(key => {
            const ms = window.moduleStates[key];
            if (!ms || !Array.isArray(ms.results) || ms.results.length === 0) return;
            
            // é€‰ä¸­ä½ç½®ï¼ˆè‹¥æœªé€‰ï¼Œåˆ™é»˜è®¤1..ms.starLevelï¼‰
            let positions = Array.isArray(ms.selectedPositions) && ms.selectedPositions.length > 0
                ? ms.selectedPositions.slice()
                : Array.from({ length: ms.starLevel || 0 }, (_, i) => i + 1);
            
            // ä»…ä¿ç•™ä¸è¶…è¿‡å½“å‰æ‹¼æ¥æ˜Ÿçº§çš„æœ‰æ•ˆä½ç½®
            positions = positions.filter(p => p >= 1 && p <= starLevel);
            if (positions.length === 0) return;
            
            const constraintList = [];
            for (const line of ms.results) {
                if (typeof line !== 'string') continue;
                const parts = line.split(/\s+/).map(s => s.trim()).filter(Boolean);
                // åªå¤„ç†ä¸ä½ç½®æ•°ç›¸åŒçš„è¡Œ
                if (parts.length < positions.length) continue;
                const map = new Map();
                for (let idx = 0; idx < positions.length; idx++) {
                    const pos = positions[idx];
                    const num = (parts[idx] || '').padStart(2, '0');
                    if (!/^\d+$/.test(num)) { map.clear(); break; }
                    map.set(pos, num);
                }
                if (map.size === positions.length) constraintList.push(map);
            }
            if (constraintList.length > 0) modulesConstraints.push(constraintList);
        });
        
        if (modulesConstraints.length === 0) return combos;
        
        // è¿‡æ»¤ï¼šæ¯ä¸ªæ¨¡å—éœ€è‡³å°‘åŒ¹é…ä¸€æ¡çº¦æŸ
        return combos.filter(str => {
            const arr = str.split(',').map(s => s.trim());
            if (arr.length !== starLevel) return false;
            
            // æ£€æŸ¥æ‰€æœ‰æ¨¡å—
            for (const constraintList of modulesConstraints) {
                let moduleMatched = false;
                for (const m of constraintList) {
                    let ok = true;
                    for (const [pos, num] of m.entries()) {
                        const idx = pos - 1;
                        if (idx < 0 || idx >= arr.length || arr[idx] !== num) { ok = false; break; }
                    }
                    if (ok) { moduleMatched = true; break; }
                }
                if (!moduleMatched) return false;
            }
            return true;
        });
    }


    // åˆå§‹åŒ–äº¤é›†æ‹¼æ¥é¡µé¢
    initIntersectionCutPage();
    
    // å†å²è®°å½•æ•°é‡æ›´æ–°å‡½æ•°
    function updateHistoryCount() {
        const historyCount = document.getElementById('historyCount');
        if (historyCount && window.verifyPlanData) {
            historyCount.textContent = `å·²ä¿å­˜ ${window.verifyPlanData.length} æ¡è®°å½•`;
        }
    }
    
    // å†å²ç®¡ç†æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    const exportHistoryBtn = document.getElementById('exportHistoryBtn');
    const importHistoryBtn = document.getElementById('importHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const importFileInput = document.getElementById('importFileInput');
    
    if (exportHistoryBtn) {
        exportHistoryBtn.addEventListener('click', function() {
            if (window.PlanStorageManager && typeof window.PlanStorageManager.exportToFile === 'function') {
                window.PlanStorageManager.exportToFile();
            } else {
                alert('å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨');
            }
        });
    }
    
    if (importHistoryBtn) {
        importHistoryBtn.addEventListener('click', function() {
            if (importFileInput) {
                importFileInput.click();
            }
        });
    }
    
    if (importFileInput) {
        importFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && window.PlanStorageManager && typeof window.PlanStorageManager.importFromFile === 'function') {
                window.PlanStorageManager.importFromFile(file);
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                event.target.value = '';
            }
        });
    }
    
    if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®¡åˆ’éªŒè¯å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                if (window.PlanStorageManager && typeof window.PlanStorageManager.clearAllPlans === 'function') {
                    window.PlanStorageManager.clearAllPlans();
                    updateHistoryCount();
                    alert('è®¡åˆ’éªŒè¯å†å²å·²æ¸…ç©º');
                } else {
                    alert('æ¸…ç©ºåŠŸèƒ½ä¸å¯ç”¨');
                }
            }
        });
    }
    
    // é¡µé¢åŠ è½½æ—¶æ›´æ–°å†å²è®°å½•æ•°é‡
    updateHistoryCount();
    
    // æ·»åŠ æµ‹è¯•æ•°æ®åŠŸèƒ½ï¼ˆä»…ç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
    window.addTestData = function() {
        const currentDate = new Date();
        const dateStr = currentDate.getFullYear().toString() + 
                       (currentDate.getMonth() + 1).toString().padStart(2, '0') + 
                       currentDate.getDate().toString().padStart(2, '0');
        
        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        const testData = [];
        for (let i = 178; i >= 170; i--) {
            const period = dateStr + i.toString().padStart(3, '0');
            const numbers = [];
            for (let j = 0; j < 10; j++) {
                numbers.push(Math.floor(Math.random() * 10) + 1);
            }
            testData.push({
                period: period,
                data: numbers,
                input: numbers.join(',')
            });
            d.add(period);
        }
        
        // æ·»åŠ åˆ°ræ•°ç»„
        r.unshift(...testData);
        window.r = r;
        
        console.log('æµ‹è¯•æ•°æ®å·²æ·»åŠ ï¼Œå½“å‰æ•°æ®é•¿åº¦:', r.length);
        console.log('æœ€æ–°æœŸå·:', r[0].period);
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('periodCount').textContent = r.length;
        L();
        
        // å¦‚æœåœ¨å•æœŸéªŒè¯æ¨¡å¼ï¼Œæ›´æ–°è¡¨æ ¼
        const singlePeriodTable = document.getElementById('singlePeriodTable');
        if (singlePeriodTable && !singlePeriodTable.classList.contains('hidden')) {
            updateSinglePeriodTable();
        }
        
        alert('æµ‹è¯•æ•°æ®å·²æ·»åŠ ï¼æœ€æ–°æœŸå·: ' + r[0].period);
    };
});



// ç”Ÿæˆäº¤é›†æ‹¼æ¥ç»„åˆ
function generateIntersectionCombinations(modules, targetStarLevel) {
    if (modules.length < 1) {
        alert('æ‹¼æ¥éœ€è¦è‡³å°‘1ä¸ªåšå·æ¨¡å—');
        return [];
    }
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªæ¨¡å—ï¼Œå¤„ç†è¯¥æ¨¡å—çš„ç»“æœ
    if (modules.length === 1) {
        const singleModule = modules[0];
        const results = [];
        const allNumbers = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10'];
        
        for (const result of singleModule.results) {
            // result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä½ç½®åˆ°æ•°å­—çš„æ˜ å°„
            const baseCombination = { ...result };
            
            // æ‰¾å‡ºå·²ä½¿ç”¨çš„æ•°å­—
            const usedNumbers = new Set(Object.values(baseCombination));
            
            // æ‰¾å‡ºç©ºä½ç½®ï¼ˆéœ€è¦è¡¥å……çš„ä½ç½®ï¼‰
            const emptyPositions = [];
            for (let i = 1; i <= targetStarLevel; i++) {
                if (!baseCombination[i]) {
                    emptyPositions.push(i);
                }
            }
            
            if (emptyPositions.length === 0) {
                // æ²¡æœ‰ç©ºä½ç½®ï¼Œç›´æ¥è¾“å‡º
                const finalResult = [];
                for (let i = 1; i <= targetStarLevel; i++) {
                    finalResult.push(baseCombination[i] || '00');
                }
                if (finalResult.length === targetStarLevel) {
                    results.push(finalResult.join(' '));
                }
            } else {
                // æœ‰ç©ºä½ç½®ï¼Œç”¨å‰©ä½™æ•°å­—è¡¥å……
                const availableNumbers = allNumbers.filter(num => !usedNumbers.has(num));
                
                // ä¸ºç©ºä½ç½®ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ’åˆ—
                const emptyPermutations = generatePermutationsWithLength(availableNumbers, emptyPositions.length);
                
                for (const perm of emptyPermutations) {
                    const finalResult = [];
                    for (let i = 1; i <= targetStarLevel; i++) {
                        if (baseCombination[i]) {
                            finalResult.push(baseCombination[i]);
                        } else {
                            const emptyIndex = emptyPositions.indexOf(i);
                            finalResult.push(perm[emptyIndex] || '00');
                        }
                    }
                    if (finalResult.length === targetStarLevel) {
                        results.push(finalResult.join(' '));
                    }
                }
            }
        }
        
        // å»é‡å¹¶æ’åº
        const uniqueResults = [...new Set(results)];
        return uniqueResults.sort();
    }
    
    const finalCombinations = [];
    const allNumbers = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10'];
    
    // æŒ‰æ˜Ÿçº§æ’åºæ¨¡å—ï¼Œä»å°åˆ°å¤§
    modules.sort((a, b) => a.starLevel - b.starLevel);
    
    const firstModule = modules[0];  // æ˜Ÿçº§è¾ƒå°çš„æ¨¡å—
    const secondModule = modules[1]; // æ˜Ÿçº§è¾ƒå¤§çš„æ¨¡å—
    
    // æ‰¾å‡ºé‡å ä½ç½®ï¼ˆäº¤é›†ä½ç½®ï¼‰
    const overlapPositions = firstModule.positions.filter(pos => 
        secondModule.positions.includes(pos)
    );
    
    if (overlapPositions.length === 0) {
        alert('ä¸¤ä¸ªæ¨¡å—æ²¡æœ‰é‡å ä½ç½®ï¼Œæ— æ³•è¿›è¡Œäº¤é›†æ‹¼æ¥');
        return [];
    }
    
    // éå†ç¬¬ä¸€ä¸ªæ¨¡å—çš„æ¯ä¸€æ³¨
    for (const firstResult of firstModule.results) {
        // åœ¨ç¬¬äºŒä¸ªæ¨¡å—ä¸­æ‰¾åˆ°é‡å ä½ç½®åŒ¹é…çš„æ³¨
        for (const secondResult of secondModule.results) {
            // æ£€æŸ¥é‡å ä½ç½®æ˜¯å¦åŒ¹é…
            let isMatch = true;
            for (const pos of overlapPositions) {
                if (firstResult[pos] !== secondResult[pos]) {
                    isMatch = false;
                    break;
                }
            }
            
            if (isMatch) {
                // æ„å»ºåŸºç¡€ç»„åˆï¼ˆåˆå¹¶ä¸¤ä¸ªæ¨¡å—çš„ç»“æœï¼‰
                const baseCombination = {};
                
                // æ·»åŠ ç¬¬ä¸€ä¸ªæ¨¡å—çš„ä½ç½®
                for (const pos of firstModule.positions) {
                    baseCombination[pos] = firstResult[pos];
                }
                
                // æ·»åŠ ç¬¬äºŒä¸ªæ¨¡å—çš„ä½ç½®ï¼ˆéé‡å éƒ¨åˆ†ï¼‰
                for (const pos of secondModule.positions) {
                    if (!overlapPositions.includes(pos)) {
                        baseCombination[pos] = secondResult[pos];
                    }
                }
                
                // æ‰¾å‡ºå·²ä½¿ç”¨çš„æ•°å­—
                const usedNumbers = new Set(Object.values(baseCombination));
                
                // æ‰¾å‡ºç©ºä½ç½®ï¼ˆéœ€è¦è¡¥å……çš„ä½ç½®ï¼‰
                const emptyPositions = [];
                for (let i = 1; i <= targetStarLevel; i++) {
                    if (!baseCombination[i]) {
                        emptyPositions.push(i);
                    }
                }
                
                if (emptyPositions.length === 0) {
                    // æ²¡æœ‰ç©ºä½ç½®ï¼Œç›´æ¥è¾“å‡º
                    const result = [];
                    for (let i = 1; i <= targetStarLevel; i++) {
                        result.push(baseCombination[i] || '00');
                    }
                    // ç¡®ä¿è¾“å‡ºçš„æ˜¯5ä¸ªæ•°å­—çš„å·ç 
                    if (result.length === targetStarLevel) {
                        finalCombinations.push(result.join(' '));
                    }
                } else {
                    // æœ‰ç©ºä½ç½®ï¼Œç”¨å‰©ä½™æ•°å­—è¡¥å……
                    const availableNumbers = allNumbers.filter(num => !usedNumbers.has(num));
                    
                    // ä¸ºç©ºä½ç½®ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ’åˆ—
                    const emptyPermutations = generatePermutationsWithLength(availableNumbers, emptyPositions.length);
                    
                    for (const perm of emptyPermutations) {
                        const result = [];
                        for (let i = 1; i <= targetStarLevel; i++) {
                            if (baseCombination[i]) {
                                result.push(baseCombination[i]);
                            } else {
                                const emptyIndex = emptyPositions.indexOf(i);
                                result.push(perm[emptyIndex] || '00');
                            }
                        }
                        // ç¡®ä¿è¾“å‡ºçš„æ˜¯5ä¸ªæ•°å­—çš„å·ç 
                        if (result.length === targetStarLevel) {
                            finalCombinations.push(result.join(' '));
                        }
                    }
                }
            }
        }
    }
    
    // å»é‡å¹¶æ’åº
    return [...new Set(finalCombinations)].sort();
}

// ========== ç®€åŒ–çš„åœ¨çº¿çŠ¶æ€å¿ƒè·³ç³»ç»Ÿ ==========
// å…¨å±€å˜é‡
window.heartbeatTimer = null;
window.currentOnlineKey = null;
window.heartbeatActive = false;

// å‘é€å¿ƒè·³ - æ™ºèƒ½è·¯ç”±ï¼ˆHTTPSç”¨ä»£ç†ï¼ŒHTTPç›´è¿ï¼‰
async function sendOnlineHeartbeat(key) {
    if (!key) return;
    
    try {
        // ğŸ”¥ æ™ºèƒ½é€‰æ‹©å¿ƒè·³è·¯å¾„
        let apiUrl, method;
        
        if (window.location.protocol === 'https:') {
            // HTTPSç¯å¢ƒï¼ˆVercelï¼‰ï¼šä½¿ç”¨ä»£ç†é¿å…æ··åˆå†…å®¹é”™è¯¯
            apiUrl = '/api/keys/heartbeat';
            method = 'Vercelä»£ç†';
        } else {
            // HTTPç¯å¢ƒï¼ˆé˜¿é‡Œäº‘æˆ–æœ¬åœ°ï¼‰ï¼šç›´æ¥è¿æ¥é˜¿é‡Œäº‘æœåŠ¡å™¨
            apiUrl = 'http://47.242.214.89/api/keys/heartbeat';
            method = 'ç›´è¿é˜¿é‡Œäº‘';
        }
        
        console.log(`ğŸ’“ å‘é€å¿ƒè·³[${method}]:`, new Date().toLocaleTimeString());
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: key })
        });
        
        const result = await parseServerJson(response, 'å¿ƒè·³æœåŠ¡');
        
        if (result.success) {
            console.log(`âœ… å¿ƒè·³æˆåŠŸ[${method}]`);
        } else {
            console.warn(`âš ï¸ å¿ƒè·³å¤±è´¥[${method}]:`, result.error || 'æœªçŸ¥é”™è¯¯');
        }
        
    } catch (error) {
        console.error('âŒ å¿ƒè·³é”™è¯¯:', error.message);
    }
}

// å¯åŠ¨å¿ƒè·³ - è¶…çº§ç®€å•ç‰ˆæœ¬
function startOnlineHeartbeat(key) {
    if (!key) {
        console.log('âš ï¸ å¯†é’¥ä¸ºç©ºï¼Œæ— æ³•å¯åŠ¨å¿ƒè·³');
        return;
    }
    
    // å¦‚æœå·²ç»æœ‰å¿ƒè·³åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
    if (window.heartbeatTimer) {
        clearInterval(window.heartbeatTimer);
        window.heartbeatTimer = null;
    }
    
    window.currentOnlineKey = key;
    window.heartbeatActive = true;
    
    console.log('ğŸš€ å¯åŠ¨åœ¨çº¿å¿ƒè·³ç³»ç»Ÿ - Key:', key.substring(0, 8) + '...');
    
    // ç«‹å³å‘é€ç¬¬ä¸€æ¬¡å¿ƒè·³
    sendOnlineHeartbeat(key);
    
    // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    window.heartbeatTimer = setInterval(() => {
        if (window.heartbeatActive && window.currentOnlineKey) {
            sendOnlineHeartbeat(window.currentOnlineKey);
        }
    }, 30000); // 30ç§’
    
    console.log('âœ… å¿ƒè·³ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ¯30ç§’å‘é€ä¸€æ¬¡');
}

// åœæ­¢å¿ƒè·³
function stopOnlineHeartbeat() {
    console.log('â¹ï¸ åœæ­¢å¿ƒè·³ç³»ç»Ÿ');
    window.heartbeatActive = false;
    if (window.heartbeatTimer) {
        clearInterval(window.heartbeatTimer);
        window.heartbeatTimer = null;
    }
    window.currentOnlineKey = null;
}

// é¡µé¢å…³é—­/éšè—æ—¶åœæ­¢å¿ƒè·³
window.addEventListener('beforeunload', stopOnlineHeartbeat);
window.addEventListener('pagehide', stopOnlineHeartbeat);

// é¡µé¢å¯è§æ€§å˜åŒ–
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('ğŸ“± é¡µé¢éšè—ï¼Œåœæ­¢å¿ƒè·³');
        stopOnlineHeartbeat();
    } else if (window.currentOnlineKey) {
        console.log('ğŸ“± é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤å¿ƒè·³');
        startOnlineHeartbeat(window.currentOnlineKey);
    }
});




</script>
</body>
</html>
