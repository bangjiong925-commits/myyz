<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密钥生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#8b5cf6',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-active {
                @apply bg-primary text-white;
            }
            .btn-hover {
                @apply transition-all duration-200 hover:shadow-md hover:-translate-y-0.5;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md overflow-hidden">
        <div class="bg-gradient-to-r from-primary to-accent p-6 text-white text-center">
            <h1 class="text-2xl font-bold mb-2">密钥生成器</h1>
            <p class="opacity-90">生成用于五星做号模块的访问密钥</p>
        </div>
        
        <div class="p-6">
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">选择密钥有效期</label>
                <div class="grid grid-cols-2 gap-3" id="durationButtons">
                    <button data-minutes="1" class="px-4 py-3 border rounded-lg btn-hover btn-active">1分钟</button>
                    <button data-days="3" class="px-4 py-3 border rounded-lg btn-hover">3天</button>
                    <button data-days="7" class="px-4 py-3 border rounded-lg btn-hover">7天</button>
                    <button data-days="30" class="px-4 py-3 border rounded-lg btn-hover">30天</button>
                    <button data-days="90" class="px-4 py-3 border rounded-lg btn-hover">90天</button>
                    <button data-days="365" class="px-4 py-3 border rounded-lg btn-hover">365天</button>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">生成的密钥</label>
                <div class="relative">
                    <input type="text" id="keyOutput" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" readonly>
                    <button id="copyBtn" class="absolute right-2 top-2 bg-gray-200 hover:bg-gray-300 p-2 rounded-lg transition-colors">
                        <i class="fa fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <button id="generateBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 btn-hover">
                <i class="fa fa-key"></i>
                <span>生成新密钥</span>
            </button>
        </div>
        
        <div class="bg-gray-50 p-4 text-center text-sm text-gray-500">
            <p>密钥生成后，请复制到五星做号模块进行验证</p>
        </div>
    </div>

    <script>
        // 全局变量
        let selectedDays = 1/(24*60); // 默认1分钟
        
        // DOM元素
        const durationButtons = document.querySelectorAll('#durationButtons button');
        const generateBtn = document.getElementById('generateBtn');
        const keyOutput = document.getElementById('keyOutput');
        const copyBtn = document.getElementById('copyBtn');
        
        // 单选按钮组
        durationButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                durationButtons.forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');
                if (btn.dataset.minutes) {
                    selectedDays = parseInt(btn.dataset.minutes) / (24 * 60); // 转换分钟为天数
                } else {
                    selectedDays = parseInt(btn.dataset.days);
                }
            });
        });
        
        // 生成密钥
        generateBtn.addEventListener('click', () => {
            const key = generateSecureKey(selectedDays);
            keyOutput.value = key;
            showNotification('密钥已生成');
        });
        
        // 复制到剪贴板
        copyBtn.addEventListener('click', () => {
            if (keyOutput.value) {
                keyOutput.select();
                document.execCommand('copy');
                showNotification('密钥已复制到剪贴板');
            }
        });
        
        // 显示通知
        function showNotification(message) {
            // 检查是否已有通知
            let notification = document.querySelector('.notification');
            if (notification) {
                notification.remove();
            }
            
            // 创建新通知
            notification = document.createElement('div');
            notification.className = 'notification fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
        
        // 生成安全密钥
        // 添加设备指纹生成函数（使用通用指纹支持跨设备使用）
        function generateDeviceFingerprint() {
            // 使用固定的通用指纹，允许密钥在任何设备上使用
            // 这样可以确保密钥的跨设备兼容性
            return 'universal_device_2024';
        }
        
        // 修改密钥生成函数，嵌入设备指纹
        function generateSecureKey(days) {
            // 添加缺失的变量定义
            const expirationDate = new Date();
            if (days < 1) {
                // 如果是分钟级别，使用分钟计算
                expirationDate.setMinutes(expirationDate.getMinutes() + Math.round(days * 24 * 60));
            } else {
                expirationDate.setDate(expirationDate.getDate() + days);
            }
            
            // 生成更强的24字节随机nonce
            const nonceArray = new Uint8Array(24);
            window.crypto.getRandomValues(nonceArray);
            
            const randomArray = new Uint8Array(16);
            window.crypto.getRandomValues(randomArray);
            
            const keyData = {
                expiry: Math.floor(expirationDate.getTime() / 1000),
                identifier: generateIdentifier(days),
                // 使用base64编码增强nonce唯一性
                nonce: btoa(String.fromCharCode.apply(null, nonceArray)),
                deviceFingerprint: generateDeviceFingerprint(),
                random: Array.from(randomArray).map(b => b.toString(16).padStart(2, '0')).join('')
            };
            
            // 修复JSON序列化和编码流程
            try {
                const jsonStr = JSON.stringify(keyData);
                if (!jsonStr) throw new Error('JSON序列化失败');
                
                // 标准UTF-8到Base64编码流程
                const encodedKey = btoa(unescape(encodeURIComponent(jsonStr)));
                return encodedKey;
            } catch (e) {
                console.error('密钥生成失败:', e);
                alert('密钥生成错误: ' + e.message);
                return null;
            }
        }
        
        // 生成基于有效期的唯一标识符
        function generateIdentifier(days) {
            // 使用不同的盐值确保不同有效期的密钥不会有重复片段
            const salts = {
                [1/(24*60)]: 'z9y8', // 1分钟
                3: 'a1b2',
                7: 'k2l3',
                30: 'c3d4',
                90: 'g7h8',
                365: 'i9j0'
            };
            
            // 生成8字节随机数
            const array = new Uint8Array(8);
            window.crypto.getRandomValues(array);
            
            // 结合盐值生成唯一标识符
            return Array.from(array)
                .map(b => (b ^ parseInt(salts[days].charCodeAt(b % 4).toString(16), 16)).toString(16).padStart(2, '0'))
                .join('');
        }
    </script>
</body>
</html>