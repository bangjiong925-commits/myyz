<!DOCTYPE html>
<html>
<head>
    <title>密钥调试工具</title>
</head>
<body>
    <h1>密钥调试工具</h1>
    <p>测试密钥: 1z9nt2czlsossgemphk1ca</p>
    <div id="result"></div>

    <script>
        // 复制TWPK.html中的确定性校验和函数
        function generateEnhancedChecksum(input) {
            // 使用多重哈希算法但保持确定性
            let hash1 = 0;
            let hash2 = 0;
            
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                // 第一个哈希
                hash1 = ((hash1 << 5) - hash1) + char;
                hash1 = hash1 & hash1;
                
                // 第二个哈希（不同的算法）
                hash2 = ((hash2 << 3) + hash2) ^ char;
                hash2 = hash2 & hash2;
            }
            
            // 组合两个哈希值（移除时间戳微扰动以保持确定性）
            const combinedHash = Math.abs(hash1) + Math.abs(hash2);
            
            // 生成6位校验和
            let checksum = combinedHash.toString(36).substring(0, 6);
            if (checksum.length < 6) {
                // 如果不足6位，用确定性字符补充
                const padding = '0123456789abcdefghijklmnopqrstuvwxyz';
                for (let i = checksum.length; i < 6; i++) {
                    checksum += padding[(combinedHash + i) % padding.length];
                }
            }
            
            return checksum.substring(0, 6);
        }

        function generateChecksum(data) {
            return generateEnhancedChecksum(data);
        }

        function debugKey() {
            const key = '1z9nt2czlsossgemphk1ca';
            const result = document.getElementById('result');
            
            result.innerHTML = '<h2>调试结果:</h2>';
            result.innerHTML += '<p>原始密钥: ' + key + '</p>';
            result.innerHTML += '<p>密钥长度: ' + key.length + '</p>';
            
            if (key.length === 22) {
                // 解析短密钥格式: 4位标识符 + 6位时间戳 + 6位随机 + 6位校验
                const identifier = key.slice(0, 4);
                const timestamp = key.slice(4, 10);
                const randomPart = key.slice(10, 16);
                const checksum = key.slice(16, 22);
                
                result.innerHTML += '<h3>密钥解析:</h3>';
                result.innerHTML += '<p>标识符 (0-4): ' + identifier + '</p>';
                result.innerHTML += '<p>时间戳 (4-10): ' + timestamp + '</p>';
                result.innerHTML += '<p>随机部分 (10-16): ' + randomPart + '</p>';
                result.innerHTML += '<p>校验和 (16-22): ' + checksum + '</p>';
                
                // 重新计算校验和
                const dataForChecksum = identifier + timestamp + randomPart;
                const calculatedChecksum = generateChecksum(dataForChecksum);
                
                result.innerHTML += '<h3>校验和验证:</h3>';
                result.innerHTML += '<p>用于计算的数据: ' + dataForChecksum + '</p>';
                result.innerHTML += '<p>原始校验和: ' + checksum + '</p>';
                result.innerHTML += '<p>计算校验和: ' + calculatedChecksum + '</p>';
                result.innerHTML += '<p>校验结果: ' + (checksum === calculatedChecksum ? '✅ 匹配' : '❌ 不匹配') + '</p>';
                
                // 时间戳解析
                try {
                    const timestampValue = parseInt(timestamp, 36);
                    const currentTime = Math.floor(Date.now() / 1000);
                    const timeDiff = Math.abs(currentTime - timestampValue);
                    
                    result.innerHTML += '<h3>时间戳分析:</h3>';
                    result.innerHTML += '<p>时间戳字符串: ' + timestamp + '</p>';
                    result.innerHTML += '<p>时间戳数值: ' + timestampValue + '</p>';
                    result.innerHTML += '<p>当前时间: ' + currentTime + '</p>';
                    result.innerHTML += '<p>时间差: ' + timeDiff + ' 秒</p>';
                    result.innerHTML += '<p>时间有效性: ' + (timeDiff <= 3600 ? '✅ 有效' : '❌ 过期') + '</p>';
                } catch (e) {
                    result.innerHTML += '<p>时间戳解析错误: ' + e.message + '</p>';
                }
            } else {
                result.innerHTML += '<p>❌ 密钥长度不正确，应为22位</p>';
            }
        }

        // 页面加载后自动执行调试
        window.onload = debugKey;
    </script>