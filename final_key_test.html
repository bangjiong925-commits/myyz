<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密钥验证测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>密钥验证测试</h1>
        <p>测试用户提供的密钥：<strong>1z9nt2czlsossgemphk1ca</strong></p>
        
        <input type="text" id="keyInput" value="1z9nt2czlsossgemphk1ca" placeholder="输入要测试的密钥">
        <button onclick="testKey()">测试密钥</button>
        
        <div id="results"></div>
    </div>

    <script>
        // 确定性校验和函数（与修正后的算法一致）
        function generateEnhancedChecksum(input) {
            let hash1 = 0;
            let hash2 = 0;
            
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash1 = ((hash1 << 5) - hash1) + char;
                hash1 = hash1 & hash1;
                
                hash2 = ((hash2 << 3) + hash2) ^ char;
                hash2 = hash2 & hash2;
            }
            
            const combinedHash = Math.abs(hash1) + Math.abs(hash2);
            
            let checksum = combinedHash.toString(36).substring(0, 6);
            if (checksum.length < 6) {
                const padding = '0123456789abcdefghijklmnopqrstuvwxyz';
                for (let i = checksum.length; i < 6; i++) {
                    checksum += padding[(combinedHash + i) % padding.length];
                }
            }
            
            return checksum.substring(0, 6);
        }

        function generateChecksum(dataForChecksum) {
            return generateEnhancedChecksum(dataForChecksum);
        }

        function testKey() {
            const key = document.getElementById('keyInput').value.trim();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (!key) {
                resultsDiv.innerHTML = '<div class="result error">请输入密钥</div>';
                return;
            }
            
            // 解析密钥
            if (key.length !== 22) {
                resultsDiv.innerHTML += '<div class="result error">密钥长度错误：' + key.length + '，应为22位</div>';
                return;
            }
            
            const identifier = key.substring(0, 4);
            const timestampPart = key.substring(4, 10);
            const randomPart = key.substring(10, 16);
            const checksum = key.substring(16, 22);
            
            resultsDiv.innerHTML += '<div class="result info">密钥解析：</div>';
            resultsDiv.innerHTML += '<div class="result info">标识符：' + identifier + '</div>';
            resultsDiv.innerHTML += '<div class="result info">时间戳部分：' + timestampPart + '</div>';
            resultsDiv.innerHTML += '<div class="result info">随机部分：' + randomPart + '</div>';
            resultsDiv.innerHTML += '<div class="result info">校验和：' + checksum + '</div>';
            
            // 重新计算校验和
            const dataForChecksum = identifier + timestampPart + randomPart;
            const calculatedChecksum = generateChecksum(dataForChecksum);
            
            resultsDiv.innerHTML += '<div class="result info">重新计算的校验和：' + calculatedChecksum + '</div>';
            
            // 验证校验和
            if (checksum === calculatedChecksum) {
                resultsDiv.innerHTML += '<div class="result success">✓ 校验和验证通过！</div>';
            } else {
                resultsDiv.innerHTML += '<div class="result error">✗ 校验和验证失败</div>';
            }
            
            // 解析时间戳
            try {
                const timestamp = parseInt(timestampPart, 36);
                const currentTime = Math.floor(Date.now() / 1000);
                const timeLeft = timestamp - currentTime;
                
                resultsDiv.innerHTML += '<div class="result info">时间戳解析：' + timestamp + ' (当前：' + currentTime + ')</div>';
                
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (24 * 60 * 60));
                    const hours = Math.floor((timeLeft % (24 * 60 * 60)) / (60 * 60));
                    const minutes = Math.floor((timeLeft % (60 * 60)) / 60);
                    resultsDiv.innerHTML += '<div class="result success">✓ 密钥仍然有效，剩余时间：' + days + '天 ' + hours + '小时 ' + minutes + '分钟</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="result error">✗ 密钥已过期</div>';
                }
            } catch (e) {
                resultsDiv.innerHTML += '<div class="result error">时间戳解析失败：' + e.message + '</div>';
            }
        }
        
        // 页面加载时自动测试
        window.onload = function() {
            testKey();
        };
    </script>
</body>
</html>