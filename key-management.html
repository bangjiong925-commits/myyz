<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密钥管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-active { @apply bg-green-100 text-green-800; }
        .status-used { @apply bg-red-100 text-red-800; }
        .status-expired { @apply bg-gray-100 text-gray-800; }
        .refresh-btn:hover { transform: rotate(180deg); }
        .refresh-btn { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-key text-blue-600 text-xl mr-3"></i>
                    <h1 class="text-xl font-semibold text-gray-900">密钥管理系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="refresh-btn p-2 text-gray-500 hover:text-blue-600 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="clearAllBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>清空所有
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">总密钥数</p>
                        <p id="totalKeys" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">正在使用</p>
                        <p id="usedKeys" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-gray-100 text-gray-600">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">已过期</p>
                        <p id="expiredKeys" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 密钥列表 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">密钥记录</h2>
                <p class="text-sm text-gray-500 mt-1">查看所有密钥的使用状态和剩余时间</p>
            </div>
            
            <!-- 加载状态 -->
            <div id="loadingState" class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">加载中...</span>
            </div>

            <!-- 空状态 -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-key text-gray-300 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">暂无密钥记录</h3>
                <p class="text-gray-500">当用户验证密钥后，记录将显示在这里</p>
            </div>

            <!-- 密钥表格 -->
            <div id="keyTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">密钥ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">剩余时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">设备信息</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="keyTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 动态内容 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-4">确认删除</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">确定要删除这个密钥记录吗？此操作不可恢复。</p>
                </div>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        取消
                    </button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置
        // 智能API地址检测 - 支持多环境
        const API_URLS = [
            'https://myyz.vercel.app',         // 生产环境（Vercel部署）
            'https://myyz-api.vercel.app',     // 备用生产环境
            'http://localhost:3000',           // 本地开发环境
            'http://192.168.31.161:3000'       // 局域网环境
        ];
        let API_BASE_URL = 'https://myyz.vercel.app'; // 默认值
        
        // 检测可用的API地址
        async function detectAvailableAPI() {
            for (const url of API_URLS) {
                try {
                    const response = await fetch(`${url}/health`, { 
                        method: 'GET',
                        timeout: 3000 
                    });
                    if (response.ok) {
                        API_BASE_URL = url;
                        console.log(`使用API地址: ${API_BASE_URL}`);
                        return url;
                    }
                } catch (error) {
                    console.warn(`API ${url} 不可用:`, error);
                    continue;
                }
            }
            console.warn('所有API地址都不可用，使用默认地址');
            return API_URLS[0];
        } // 修改为实际的后端服务地址
        
        let currentDeleteKeyId = null;
        let refreshInterval = null;

        // DOM 元素
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const keyTable = document.getElementById('keyTable');
        const keyTableBody = document.getElementById('keyTableBody');
        const deleteModal = document.getElementById('deleteModal');
        
        // 统计元素
        const totalKeysEl = document.getElementById('totalKeys');
        const usedKeysEl = document.getElementById('usedKeys');
        const expiredKeysEl = document.getElementById('expiredKeys');

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString('zh-CN');
        }

        // 获取状态标签
        function getStatusBadge(record) {
            const now = new Date();
            const expiryDate = new Date(record.expiresAt || record.expiryTime);
            
            // 检查剩余时间是否为0或已过期
            if (record.remainingTimeFormatted === '0秒' || expiryDate < now) {
                return '<span class="status-expired px-2 py-1 text-xs font-medium rounded-full">已过期</span>';
            } else {
                return '<span class="status-active px-2 py-1 text-xs font-medium rounded-full">正在使用</span>';
            }
        }

        // 获取密钥记录
        async function fetchKeyRecords() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/key-records`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('获取密钥记录失败:', error);
                throw error;
            }
        }

        // 删除密钥记录
        async function deleteKeyRecord(keyId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/key-records/${keyId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('删除密钥记录失败:', error);
                throw error;
            }
        }

        // 清空所有记录
        async function clearAllRecords() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/key-records`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('清空记录失败:', error);
                throw error;
            }
        }

        // 更新统计信息
        function updateStats(records) {
            const now = new Date();
            let total = records.length;
            let active = 0;
            let expired = 0;

            records.forEach(record => {
                const expiryDate = new Date(record.expiresAt || record.expiryTime);
                // 检查剩余时间是否为0或已过期
                if (record.remainingTimeFormatted === '0秒' || expiryDate < now) {
                    expired++;
                } else {
                    active++;
                }
            });

            totalKeysEl.textContent = total;
            usedKeysEl.textContent = active; // usedKeys现在显示正在使用的数量
            expiredKeysEl.textContent = expired;
        }

        // 渲染密钥表格
        function renderKeyTable(records) {
            if (!records || records.length === 0) {
                loadingState.classList.add('hidden');
                keyTable.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            loadingState.classList.add('hidden');
            emptyState.classList.add('hidden');
            keyTable.classList.remove('hidden');

            keyTableBody.innerHTML = records.map(record => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${record.keyId || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(record)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.remainingTimeFormatted || '计算中...'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatTime(record.usedAt)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="max-w-xs truncate" title="${record.userAgent || 'N/A'}">
                            ${record.deviceId || 'N/A'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showDeleteModal('${record.keyId}')" 
                                class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 加载数据
        async function loadData() {
            try {
                // 先检测可用的API地址
                await detectAvailableAPI();
                
                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');
                keyTable.classList.add('hidden');

                const records = await fetchKeyRecords();
                updateStats(records);
                renderKeyTable(records);
            } catch (error) {
                console.error('加载数据失败:', error);
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
                keyTable.classList.add('hidden');
                
                // 显示错误信息
                emptyState.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-red-300 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">加载失败</h3>
                    <p class="text-gray-500 mb-4">无法连接到服务器，请检查后端服务是否正常运行</p>
                    <button onclick="loadData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        重试
                    </button>
                `;
            }
        }

        // 显示删除确认模态框
        function showDeleteModal(keyId) {
            currentDeleteKeyId = keyId;
            deleteModal.classList.remove('hidden');
        }

        // 隐藏删除确认模态框
        function hideDeleteModal() {
            currentDeleteKeyId = null;
            deleteModal.classList.add('hidden');
        }

        // 确认删除
        async function confirmDelete() {
            if (!currentDeleteKeyId) return;
            
            try {
                await deleteKeyRecord(currentDeleteKeyId);
                hideDeleteModal();
                loadData(); // 重新加载数据
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 清空所有记录
        async function confirmClearAll() {
            if (!confirm('确定要清空所有密钥记录吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                await clearAllRecords();
                loadData(); // 重新加载数据
            } catch (error) {
                alert('清空失败: ' + error.message);
            }
        }

        // 事件监听器
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        document.getElementById('clearAllBtn').addEventListener('click', confirmClearAll);
        document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        
        // 点击模态框背景关闭
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // 设置自动刷新（每30秒）
            refreshInterval = setInterval(loadData, 30000);
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // 全局函数（供HTML调用）
        window.showDeleteModal = showDeleteModal;
    </script>
</body>
</html>