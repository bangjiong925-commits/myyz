<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密钥验证测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>密钥验证测试</h1>
        <p>测试新的原子性密钥验证API</p>
        
        <div class="form-group">
            <label for="nonceInput">测试密钥 (nonce):</label>
            <input type="text" id="nonceInput" placeholder="输入测试密钥，如: test_123" value="test_demo_key">
        </div>
        
        <button onclick="testVerifyAPI()">验证密钥</button>
        <button onclick="generateRandomKey()">生成随机密钥</button>
        <button onclick="clearResults()">清除结果</button>
        
        <div id="result"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            const logDiv = document.getElementById('log');
            logDiv.textContent = logContent;
            logDiv.style.display = 'block';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }
        
        async function testVerifyAPI() {
            const nonce = document.getElementById('nonceInput').value.trim();
            
            if (!nonce) {
                showResult('请输入密钥', 'error');
                return;
            }
            
            log(`开始验证密钥: ${nonce}`);
            showResult('正在验证密钥...', 'info');
            
            try {
                // 尝试调用远程API
                log('尝试调用远程API...');
                const response = await fetch('https://myyz.vercel.app/api/nonce/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'TWPK-KeyValidator/1.0'
                    },
                    body: JSON.stringify({ nonce })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`远程API响应: ${JSON.stringify(data)}`);
                    
                    if (data.success) {
                        showResult('✅ 密钥验证成功！', 'success');
                    } else {
                        showResult(`❌ ${data.message}`, 'error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                log(`远程API调用失败: ${error.message}`);
                
                // 降级到本地模拟验证
                log('降级到本地模拟验证...');
                const localResult = await simulateLocalVerification(nonce);
                
                if (localResult.success) {
                    showResult(`✅ 本地验证成功: ${localResult.message}`, 'success');
                } else {
                    showResult(`❌ 本地验证失败: ${localResult.message}`, 'error');
                }
            }
        }
        
        // 模拟本地验证逻辑
        const usedKeys = new Set();
        
        async function simulateLocalVerification(nonce) {
            log(`执行本地验证: ${nonce}`);
            
            // 模拟网络延迟
            await new Promise(resolve => setTimeout(resolve, 100));
            
            if (usedKeys.has(nonce)) {
                log(`本地检查: 密钥已被使用`);
                return { success: false, message: '密钥已被使用（本地验证）' };
            }
            
            // 标记为已使用
            usedKeys.add(nonce);
            log(`本地标记: 密钥已保存到本地存储`);
            
            return { success: true, message: '密钥验证成功（本地验证）' };
        }
        
        function generateRandomKey() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            const randomKey = `test_${timestamp}_${random}`;
            document.getElementById('nonceInput').value = randomKey;
            log(`生成随机密钥: ${randomKey}`);
        }
        
        function clearResults() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('log').style.display = 'none';
            logContent = '';
        }
        
        // 页面加载时的初始化
        window.onload = function() {
            log('密钥验证测试页面已加载');
            log('API端点: https://myyz.vercel.app/api/nonce/verify');
            log('支持本地降级验证');
        };
    </script>